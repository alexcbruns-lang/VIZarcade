<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Synthwave</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Share Tech Mono',monospace;color:#fff;cursor:none}
#cur{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;z-index:9999;mix-blend-mode:screen;transition:background 2s}
canvas{position:fixed;top:0;left:0;width:100%;height:100%}
#c0{z-index:1}#c1{z-index:2}#c2{z-index:3}#c3{z-index:4;pointer-events:none}
#login{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000}
#login::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 70% 50% at 30% 50%,rgba(6,255,216,0.07) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 75% 50%,rgba(255,0,110,0.06) 0%,transparent 60%)}
.logo{position:relative;z-index:1;font-family:'Bebas Neue',sans-serif;font-size:clamp(3rem,8vw,7rem);letter-spacing:0.15em;background:linear-gradient(135deg,#06ffd8 0%,#8338ec 50%,#ff006e 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.tagline{position:relative;z-index:1;font-size:0.7rem;letter-spacing:0.4em;color:rgba(255,255,255,0.3);margin:0.8rem 0 4rem;text-transform:uppercase}
.btn{position:relative;z-index:1;padding:1rem 3rem;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:0.3em;color:#000;background:#06ffd8;border:none;cursor:pointer;clip-path:polygon(10px 0%,100% 0%,calc(100% - 10px) 100%,0% 100%);transition:all 0.2s}
.btn:hover{background:#fff;box-shadow:0 0 50px rgba(6,255,216,0.5);transform:scale(1.04)}
#loginErr{position:relative;z-index:1;color:#ff006e;font-size:0.62rem;letter-spacing:0.15em;margin-top:1.2rem;max-width:420px;text-align:center;display:none}
.scanlines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px);pointer-events:none;z-index:100}
#ui{position:fixed;z-index:80;inset:0;pointer-events:none;display:none}
#trackName{position:absolute;bottom:2.5rem;left:2.5rem;max-width:50vw;font-family:'Bebas Neue',sans-serif;font-size:clamp(1.2rem,3vw,2.2rem);letter-spacing:0.08em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 40px currentColor;transition:color 3s}
#artistName{position:absolute;bottom:calc(2.5rem + 2.5rem);left:2.5rem;font-size:0.68rem;letter-spacing:0.3em;color:rgba(255,255,255,0.38);text-transform:uppercase}
#sceneTag{position:absolute;top:2rem;left:2.5rem;font-size:0.62rem;letter-spacing:0.3em;color:rgba(255,255,255,0.28);text-transform:uppercase}
#albumArt{position:absolute;bottom:2.5rem;right:2.5rem;width:72px;height:72px;object-fit:cover;opacity:0.55;border:1px solid rgba(255,255,255,0.07)}
#pgWrap{position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,0.04)}
#pgBar{height:100%;width:0%;transition:width 1s linear}
#splash{position:fixed;inset:0;z-index:90;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 0.8s}
#splash.show{opacity:1}
#splashScene{font-family:'Bebas Neue',sans-serif;font-size:clamp(0.7rem,1.4vw,1rem);letter-spacing:0.6em;color:rgba(255,255,255,0.35);margin-bottom:0.8rem}
#splashTrack{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.5rem,7vw,6.5rem);letter-spacing:0.06em;text-align:center;max-width:90vw;text-shadow:0 0 60px currentColor}
#splashArtist{font-size:clamp(0.8rem,1.8vw,1.1rem);letter-spacing:0.45em;color:rgba(255,255,255,0.4);margin-top:0.8rem;text-transform:uppercase}
#splashDesc{font-size:clamp(0.65rem,1.2vw,0.85rem);font-style:italic;color:rgba(255,255,255,0.22);margin-top:1.5rem;text-align:center;max-width:55vw;line-height:1.8;letter-spacing:0.05em}
#wash{position:fixed;inset:0;z-index:85;opacity:0;pointer-events:none;transition:opacity 1.2s ease}
#surpriseOverlay{position:fixed;inset:0;z-index:75;pointer-events:none;opacity:0}
#comicPanel{position:fixed;inset:0;z-index:76;pointer-events:none;display:none;font-family:'Bebas Neue',sans-serif}
#gameOverScreen{position:fixed;inset:0;z-index:76;pointer-events:none;display:none;align-items:center;justify-content:center;background:#000;font-family:'Bebas Neue',sans-serif;font-size:clamp(4rem,12vw,10rem);letter-spacing:0.2em;color:#f00;text-shadow:0 0 40px #f00}
#fsBtn{position:fixed;bottom:2.5rem;right:calc(72px + 3rem);z-index:85;background:none;border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.28);font-family:'Share Tech Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;padding:0.4rem 0.7rem;cursor:pointer;transition:all 0.2s;display:none;pointer-events:all}
#fsBtn:hover{border-color:#06ffd8;color:#06ffd8}
</style>
</head>
<body>
<div id="cur"></div>
<div class="scanlines"></div>
<canvas id="c0"></canvas><canvas id="c1"></canvas><canvas id="c2"></canvas><canvas id="c3"></canvas>
<div id="login">
  <div class="logo">SYNTHWAVE</div>
  <div class="tagline">AI Festival Visual Engine</div>
  <button id="loginBtn" class="btn">CONNECT SPOTIFY</button>
  <div id="loginErr"></div>
</div>
<div id="wash"></div>
<div id="surpriseOverlay"></div>
<div id="comicPanel"></div>
<div id="gameOverScreen">GAME OVER</div>
<div id="splash">
  <div id="splashScene"></div>
  <div id="splashTrack"></div>
  <div id="splashArtist"></div>
  <div id="splashDesc"></div>
</div>
<div id="ui">
  <div id="sceneTag">SCENE ENGINE</div>
  <div id="artistName">—</div>
  <div id="trackName">—</div>
  <img id="albumArt" src="" alt=""/>
  <div id="pgWrap"><div id="pgBar"></div></div>
</div>
<button id="fsBtn">⛶ FS</button>
<script>
// ═══ AUTH ═══
const CLIENT_ID='c4a8270f8bc6453490fc8bf4b9de5c42';
const REDIR=location.origin+'/callback';
const SCOPE='user-read-currently-playing user-read-playback-state';
function rnd(n){const a=new Uint8Array(n);crypto.getRandomValues(a);return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'').slice(0,n)}
async function sha256b64(s){const d=new TextEncoder().encode(s),h=await crypto.subtle.digest('SHA-256',d);return btoa(String.fromCharCode(...new Uint8Array(h))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'')}
const ls=(k,v)=>localStorage.setItem(k,v),lg=k=>localStorage.getItem(k);
async function doLogin(){
  const v=rnd(64),c=await sha256b64(v);
  ls('pv',v);
  console.log('[auth] login — redirect_uri='+REDIR);
  location.href='https://accounts.spotify.com/authorize?'+new URLSearchParams({client_id:CLIENT_ID,response_type:'code',redirect_uri:REDIR,scope:SCOPE,code_challenge_method:'S256',code_challenge:c,show_dialog:'true'});
}
async function exchToken(code){
  const v=lg('pv');
  console.log('[auth] exchToken code='+code.slice(0,8)+' verifier='+(v?'ok':'MISSING'));
  if(!v){showErr('Auth error: session data lost. Try again.');return null;}
  const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:'authorization_code',code,redirect_uri:REDIR,code_verifier:v})});
  const d=await r.json();
  console.log('[auth] token response:',r.status,Object.keys(d).join(','));
  if(d.access_token){ls('at',d.access_token);ls('ats',Date.now());if(d.refresh_token)ls('rt',d.refresh_token);localStorage.removeItem('pv');return d.access_token;}
  showErr('Spotify error: '+(d.error_description||d.error||'unknown'));
  return null;
}
async function refreshAT(){const rt=lg('rt');if(!rt)return null;const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:'refresh_token',refresh_token:rt})});const d=await r.json();if(d.access_token){ls('at',d.access_token);ls('ats',Date.now());return d.access_token}return null}
function getAT(){const t=lg('at'),s=parseInt(lg('ats')||0);return t&&Date.now()-s<3500000?t:null}
function showErr(msg){const el=document.getElementById('loginErr');el.textContent=msg;el.style.display='block';document.getElementById('loginBtn').textContent='TRY AGAIN';}
function logout(){ls('at','');document.getElementById('login').style.display='flex';document.getElementById('ui').style.display='none';document.getElementById('fsBtn').style.display='none';}

// ═══ CANVAS ═══
const c0=document.getElementById('c0'),x0=c0.getContext('2d');
const c1=document.getElementById('c1'),x1=c1.getContext('2d');
const c2=document.getElementById('c2'),x2=c2.getContext('2d');
const c3=document.getElementById('c3'),x3=c3.getContext('2d');
const W=()=>c0.width,H=()=>c0.height;
function resize(){[c0,c1,c2,c3].forEach(c=>{c.width=innerWidth;c.height=innerHeight})}
resize();addEventListener('resize',()=>{resize();if(token)initScene()});
const cur=document.getElementById('cur');
document.addEventListener('mousemove',e=>{cur.style.left=(e.clientX-4)+'px';cur.style.top=(e.clientY-4)+'px'});

// ═══ HELPERS ═══
function lerp(a,b,t){return a+(b-a)*t}
function rndEl(arr){return arr[Math.floor(Math.random()*arr.length)]}
function h2r(h){try{const x=parseInt(h.replace('#','').slice(0,6),16);return{r:(x>>16)&255,g:(x>>8)&255,b:x&255}}catch{return{r:6,g:255,b:216}}}
function rgba(h,a=1){const{r,g,b}=h2r(h);return`rgba(${r},${g},${b},${+a.toFixed(3)})`}
const pc=i=>THEME.palette[((i%4)+4)%4];
const delay=ms=>new Promise(r=>setTimeout(r,ms));

// ═══ VARIETY HISTORY — 25-song no-repeat window ═══
const ALL_SCENES=['WARP_SPEED','LAVA_WORLD','CYBER_GRID','DEEP_SEA','STORM_CHASER','JUNGLE_RAVE','DISCO_DIMENSION','ACID_TRIP','SPACE_STATION','NEON_CATHEDRAL','CLASSIC_ARCADE','ELECTRIC_FOREST','OMNIA_NIGHTCLUB','PIRATE_SHIP','JUNKYARD','SUPERHERO','DAY_OF_DEAD','CHINESE_DRAGON','MOUNT_OLYMPUS','SUPER_MARIO','ATLANTIS','CARNIVAL','EGYPTIAN_TOMB'];
const ALL_CPS=['skull','flaming_skull','skull_crossbones','smiley','demon_face','alien_head','robot_head','dragon','wolf_head','eagle','peace_sign','lightning_bolt','yin_yang','star','ankh','trident','flame','diamond','coffin','astronaut','rocket','ufo','vinyl_record','disco_ball','turntable','hourglass','crown','clock_face','chandelier','sun','moon','planet','comet','black_hole','wormhole','mandala','dna_helix','tesseract','eye','lotus'];
const CP_NO_REPEAT=25;
const SCENE_NO_REPEAT=15;
function loadJ(k,def){try{return JSON.parse(lg(k)||'null')||def}catch{return def}}
let sceneHist=loadJ('sw_sh',[]),cpHist=loadJ('sw_ch',[]),sceneLastSeen=loadJ('sw_ls',{});
let songCount=parseInt(lg('sw_n')||0),sessionStreak=parseInt(lg('sw_ss')||0);
if(Date.now()-parseInt(lg('sw_st')||0)>3600000){sessionStreak=0;ls('sw_ss','0');}
function getSceneShortlist(){
  const recent=new Set(sceneHist.slice(-SCENE_NO_REPEAT));
  const eligible=ALL_SCENES.filter(s=>!recent.has(s));
  if(eligible.length<4)return ALL_SCENES.slice().sort((a,b)=>(sceneLastSeen[a]||0)-(sceneLastSeen[b]||0)).slice(0,8);
  return eligible.sort((a,b)=>(sceneLastSeen[a]||0)-(sceneLastSeen[b]||0));
}
function getForbidCPs(){return cpHist.slice(-CP_NO_REPEAT);}
function recordScene(s){
  sceneHist.push(s);if(sceneHist.length>40)sceneHist.shift();
  sceneLastSeen[s]=songCount;
  ls('sw_sh',JSON.stringify(sceneHist));ls('sw_ls',JSON.stringify(sceneLastSeen));
  songCount++;ls('sw_n',songCount);
  sessionStreak++;ls('sw_ss',sessionStreak);ls('sw_st',Date.now());
}
function recordCP(c){if(!c)return;cpHist.push(c);if(cpHist.length>50)cpHist.shift();ls('sw_ch',JSON.stringify(cpHist));}
function enforceScene(s,shortlist){if(shortlist.includes(s))return s;return shortlist[0]||s;}
function enforceCP(c){
  if(!c)return null;
  const forbidden=getForbidCPs();
  if(!ALL_CPS.includes(c)||forbidden.includes(c)){
    const available=ALL_CPS.filter(x=>!forbidden.includes(x));
    return available.length>0?rndEl(available):c;
  }
  return c;
}

// ═══ INTEGRATED SCENES SET ═══
const CP_INTEGRATED_SCENES=new Set(['WARP_SPEED','DEEP_SEA','STORM_CHASER','OMNIA_NIGHTCLUB','CARNIVAL','JUNKYARD','EGYPTIAN_TOMB','ELECTRIC_FOREST','PIRATE_SHIP','ACID_TRIP','NEON_CATHEDRAL','SPACE_STATION','LAVA_WORLD','DISCO_DIMENSION','CLASSIC_ARCADE','SUPERHERO','DAY_OF_DEAD','CHINESE_DRAGON','MOUNT_OLYMPUS','SUPER_MARIO','ATLANTIS','JUNGLE_RAVE','CYBER_GRID']);

// ═══ SURPRISE SYSTEM — 12–15 second multi-wave events ═══
function flash(color,ms){const o=document.getElementById('surpriseOverlay');o.style.background=color;o.style.transition='opacity 0.08s';o.style.opacity='1';setTimeout(()=>{o.style.transition=`opacity ${ms}ms ease`;o.style.opacity='0';},100);}

// Schedule a series of timed events
function sequence(events){events.forEach(([delay,fn])=>setTimeout(fn,delay));}

function fireSurprise(){
  if(!midShifted&&Math.random()<0.15&&songProg>0.3&&songProg<0.75){
    midShifted=true;
    const f=getForbidCPs(),pool=ALL_SCENES.filter(s=>s!==THEME.scene);
    const newScene=rndEl(pool);
    const savedScene=THEME.scene,savedCP=THEME.centerpiece;
    setTimeout(()=>{THEME.scene=newScene;initScene();
      setTimeout(()=>{THEME.scene=savedScene;initScene();THEME.centerpiece=savedCP;},11000);},400);
    return;
  }
  const sc=THEME.scene;
  const variant=Math.floor(Math.random()*3); // up to 3 variants per scene

  if(sc==='WARP_SPEED'){
    if(variant===0){
      // Hyperspeed — centerpiece rushes to fill screen
      sequence([[0,()=>{beatFX.speedBoost=6;flash('rgba(255,255,255,0.3)',300);}],[500,()=>{beatFX.speedBoost=10;flash(rgba(pc(0),0.4),200);}],[1500,()=>{flash('rgba(255,255,255,0.8)',150);}],[2000,()=>{beatFX.speedBoost=4;}],[5000,()=>{beatFX.speedBoost=0;}]]);
    } else if(variant===1){
      // Asteroid field
      sequence([[0,()=>{flash(rgba(pc(1),0.5),400);for(let i=0;i<15;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.7;},i*200);}],[3000,()=>{beatFX.speedBoost=3;}],[7000,()=>{beatFX.speedBoost=0;}]]);
    } else {
      sequence([[0,()=>{beatFX.speedBoost=8;flash('rgba(0,0,0,0.95)',50);}],[100,()=>{flash(rgba(pc(0),0.9),100);}],[200,()=>{flash(rgba(pc(1),0.8),200);}],[500,()=>{beatFX.speedBoost=12;}],[2000,()=>{beatFX.speedBoost=3;}],[8000,()=>{beatFX.speedBoost=0;}]]);
    }
  }
  else if(sc==='LAVA_WORLD'){
    if(variant===0){
      // Mega eruption — lava balls swarm the sky
      sequence([[0,()=>{flash(rgba(pc(0),0.7),400);fireLavaBalls();fireLavaBalls();}],[600,()=>{fireLavaBalls();flash(rgba(pc(1),0.5),300);}],[1200,()=>{fireLavaBalls();fireLavaBalls();}],[2000,()=>{flash('rgba(255,100,0,0.4)',800);if(SD.embers)SD.embers.forEach(e=>e.vy*=5);}],[3500,()=>{fireLavaBalls();}],[5000,()=>{fireLavaBalls();fireLavaBalls();}],[8000,()=>{if(SD.embers)SD.embers.forEach(e=>e.vy/=5);}]]);
    } else if(variant===1){
      // Lava floor rises — screen floods orange then recedes
      sequence([[0,()=>{flash('rgba(255,80,0,0.5)',500);}],[500,()=>{flash('rgba(255,120,0,0.6)',800);}],[1000,()=>{flash('rgba(255,60,0,0.8)',400);fireLavaBalls();fireLavaBalls();fireLavaBalls();}],[2500,()=>{flash('rgba(200,40,0,0.5)',1500);}],[5000,()=>{fireLavaBalls();fireLavaBalls();}],[9000,()=>{}]]);
    } else {
      // Double volcano eruption
      sequence([[0,()=>{fireLavaBalls();flash(rgba(pc(0),0.6),300);}],[300,()=>{fireLavaBalls();}],[700,()=>{fireLavaBalls();fireLavaBalls();}],[1500,()=>{flash('rgba(255,80,0,0.7)',200);}],[2000,()=>{fireLavaBalls();fireLavaBalls();fireLavaBalls();}],[4000,()=>{fireLavaBalls();fireLavaBalls();}],[7000,()=>{fireLavaBalls();}]]);
    }
  }
  else if(sc==='DEEP_SEA'){
    if(variant===0){
      // Creature swarm — multiple giants fill screen
      sequence([[0,()=>{flash(rgba(pc(0),0.4),600);if(SD.creatures)SD.creatures.push({...mkDeepCreature(W(),H()),sz:Math.min(W(),H())*0.5,vx:1.8,y:H()*0.3});}],[800,()=>{if(SD.creatures)SD.creatures.push({...mkDeepCreature(W(),H()),sz:Math.min(W(),H())*0.6,vx:2,y:H()*0.5});}],[1600,()=>{flash(rgba(pc(1),0.5),400);if(SD.creatures)for(let i=0;i<3;i++)SD.creatures.push({...mkDeepCreature(W(),H()),sz:160+i*40,vx:1+i*0.3});}],[4000,()=>{if(SD.plankton)SD.plankton.forEach(p=>p.vy*=8);}],[6000,()=>{if(SD.plankton)SD.plankton.forEach(p=>p.vy/=8);}]]);
    } else if(variant===1){
      // Bioluminescent explosion
      sequence([[0,()=>{flash(rgba(pc(0),0.8),200);}],[200,()=>{flash('rgba(255,255,255,0.9)',100);}],[400,()=>{flash(rgba(pc(1),0.7),400);if(SD.plankton)SD.plankton.forEach(p=>{p.vy*=10;p.r*=2;});}],[1000,()=>{flash(rgba(pc(2),0.5),600);}],[3000,()=>{if(SD.plankton)SD.plankton.forEach(p=>{p.vy/=10;p.r/=2;});}],[5000,()=>{if(SD.creatures)SD.creatures.push({...mkDeepCreature(W(),H()),sz:Math.min(W(),H())*0.7,vx:2.5,y:H()*0.4});}]]);
    } else {
      sequence([[0,()=>{flash('rgba(0,200,150,0.4)',300);}],[400,()=>{for(let i=0;i<4;i++)setTimeout(()=>SD.creatures&&SD.creatures.push({...mkDeepCreature(W(),H()),sz:200,vx:1.5+i*0.3,y:H()*(0.2+i*0.15)}),i*300);}],[3000,()=>{flash(rgba(pc(0),0.6),500);}],[7000,()=>{if(SD.plankton)SD.plankton.forEach(p=>p.vy*=6);}],[9000,()=>{if(SD.plankton)SD.plankton.forEach(p=>p.vy/=6);}]]);
    }
  }
  else if(sc==='CYBER_GRID'){
    if(variant===0){
      // Matrix meltdown
      sequence([[0,()=>{gridGlitch=true;if(SD.dataStreams)SD.dataStreams.forEach(ds=>ds.speed*=8);flash(rgba(pc(0),0.7),150);}],[200,()=>{flash(rgba(pc(1),0.6),150);}],[500,()=>{beatFX.invertA=0.5;if(SD.buildings)SD.buildings.forEach(b=>{b.h*=1.6;b.ci=(b.ci+2)%4;});}],[2000,()=>{flash(rgba(pc(0),0.8),200);}],[3000,()=>{beatFX.invertA=0;gridGlitch=false;if(SD.dataStreams)SD.dataStreams.forEach(ds=>ds.speed/=8);if(SD.buildings)SD.buildings.forEach(b=>b.h/=1.6);}],[6000,()=>{}]]);
    } else if(variant===1){
      // City collapse and rebuild
      sequence([[0,()=>{flash(rgba(pc(0),0.9),200);beatFX.invertA=0.8;}],[300,()=>{if(SD.buildings)SD.buildings.forEach(b=>b.h*=0.3);flash('rgba(0,0,0,0.95)',300);}],[700,()=>{beatFX.invertA=0;}],[2000,()=>{if(SD.buildings)SD.buildings.forEach(b=>b.h/=0.3);gridGlitch=true;flash(rgba(pc(1),0.6),400);}],[4000,()=>{gridGlitch=false;}],[8000,()=>{}]]);
    } else {
      sequence([[0,()=>{for(let i=0;i<5;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.5),100);},i*200);}],[1500,()=>{gridGlitch=true;beatFX.speedBoost=2;if(SD.dataStreams)SD.dataStreams.forEach(ds=>ds.speed*=5);}],[4000,()=>{gridGlitch=false;beatFX.speedBoost=0;if(SD.dataStreams)SD.dataStreams.forEach(ds=>ds.speed/=5);}]]);
    }
  }
  else if(sc==='STORM_CHASER'){
    if(variant===0){
      // Lightning wall
      sequence([[0,()=>{for(let i=0;i<6;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.8)',80);},i*120);}],[1000,()=>{for(let i=0;i<8;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*100);}],[3000,()=>{flash(rgba(pc(0),0.6),400);}],[5000,()=>{for(let i=0;i<5;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*150);}]]);
    } else if(variant===1){
      // Tornado splits into 3
      sequence([[0,()=>{beatFX.speedBoost=3;flash('rgba(200,220,255,0.5)',400);}],[500,()=>{flash('rgba(255,255,255,0.7)',200);}],[1000,()=>{for(let i=0;i<10;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*80);}],[3000,()=>{beatFX.speedBoost=1;}],[7000,()=>{beatFX.speedBoost=0;}]]);
    } else {
      sequence([[0,()=>{flash('rgba(255,255,255,0.95)',100);}],[200,()=>{for(let i=0;i<12;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*60);}],[1500,()=>{flash(rgba(pc(0),0.7),300);beatFX.speedBoost=2;}],[4000,()=>{for(let i=0;i<6;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.5)',80);},i*200);}],[8000,()=>{beatFX.speedBoost=0;}]]);
    }
  }
  else if(sc==='JUNGLE_RAVE'){
    if(variant===0){
      // Stampede — creatures charge through, canopy explodes
      sequence([[0,()=>{flash(rgba(pc(2),0.5),400);for(let i=0;i<6;i++)setTimeout(()=>SD.creatures&&SD.creatures.push({...mkJungleCreature(W(),H()),sz:180+i*25,vx:-(2+i*0.4),y:H()*(0.25+i*0.08)}),i*200);}],[2000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=4);if(SD.spores)SD.spores.forEach(s=>s.vy*=8);}],[4000,()=>{flash(rgba(pc(0),0.6),500);}],[5000,()=>{if(SD.spores)SD.spores.forEach(s=>s.vy/=8);}],[8000,()=>{}]]);
    } else if(variant===1){
      // Canopy explosion — vines and leaves fill screen
      sequence([[0,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=6);flash(rgba(pc(2),0.7),300);}],[500,()=>{if(SD.vines)SD.vines.forEach(v=>v.swingSpeed*=5);flash(rgba(pc(0),0.5),400);}],[1500,()=>{if(SD.spores)SD.spores.forEach(s=>{s.vy*=6;s.vx=(Math.random()-0.5)*4;});}],[4000,()=>{if(SD.vines)SD.vines.forEach(v=>v.swingSpeed/=5);if(SD.spores)SD.spores.forEach(s=>{s.vy/=6;s.vx=(Math.random()-0.5)*0.3;});}],[8000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(2),0.8),200);}],[300,()=>{for(let i=0;i<4;i++)setTimeout(()=>{SD.creatures&&SD.creatures.push({...mkJungleCreature(W(),H()),sz:220});if(SD.trees)SD.trees[i%SD.trees.length].glowMult=5;},i*400);}],[3000,()=>{flash(rgba(pc(0),0.6),400);if(SD.spores)SD.spores.forEach(s=>s.vy*=10);}],[5000,()=>{if(SD.spores)SD.spores.forEach(s=>s.vy/=10);}],[9000,()=>{}]]);
    }
  }
  else if(sc==='DISCO_DIMENSION'){
    if(variant===0){
      // Strobe overload — all tiles flash simultaneously
      sequence([[0,()=>{for(let i=0;i<8;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.6),60);if(SD.discoFloor)SD.discoFloor.forEach(t=>t.ci=Math.floor(Math.random()*4));},i*100);}],[1000,()=>{beatFX.invertA=0.6;flash('rgba(255,255,255,0.9)',150);}],[1500,()=>{beatFX.invertA=0;}],[2000,()=>{for(let i=0;i<6;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.5),80);},i*130);}],[5000,()=>{if(SD.beams)SD.beams.forEach(b=>b.speed*=4);}],[8000,()=>{if(SD.beams)SD.beams.forEach(b=>b.speed/=4);}]]);
    } else if(variant===1){
      // Floor cracks, light erupts from below
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);}],[400,()=>{if(SD.discoFloor)SD.discoFloor.forEach(t=>{t.bright=1;t.ph+=Math.PI;});}],[600,()=>{flash('rgba(255,255,255,0.95)',200);}],[1000,()=>{for(let i=0;i<5;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.8;},i*250);}],[3000,()=>{if(SD.discoFloor)SD.discoFloor.forEach(t=>t.ci=Math.floor(Math.random()*4));}],[7000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(1),0.8),150);}],[200,()=>{flash('rgba(255,255,255,0.7)',100);}],[400,()=>{if(SD.crowd)SD.crowd.forEach(p=>p.h*=2);flash(rgba(pc(0),0.6),200);}],[1500,()=>{beatFX.invertA=0.5;}],[2000,()=>{beatFX.invertA=0;if(SD.crowd)SD.crowd.forEach(p=>p.h/=2);}],[4000,()=>{if(SD.discoFloor)SD.discoFloor.forEach(t=>t.bright=1);}],[8000,()=>{}]]);
    }
  }
  else if(sc==='ACID_TRIP'){
    if(variant===0){
      sequence([[0,()=>{beatFX.invertA=0.9;flash(rgba(pc(0),0.8),200);}],[300,()=>{flash(rgba(pc(1),0.7),200);}],[600,()=>{flash(rgba(pc(2),0.8),200);}],[1000,()=>{beatFX.invertA=0.6;flash(rgba(pc(3),0.7),300);}],[2500,()=>{beatFX.invertA=0.8;}],[4000,()=>{beatFX.invertA=0.4;}],[7000,()=>{beatFX.invertA=0;}]]);
    } else if(variant===1){
      sequence([[0,()=>{flash('rgba(0,0,0,0.95)',100);}],[200,()=>{if(SD.warpGrid)SD.warpGrid.forEach(p=>p.ph+=Math.PI*(Math.random()-0.5)*4);flash(rgba(pc(0),0.9),100);}],[600,()=>{beatFX.invertA=0.7;flash(rgba(pc(1),0.8),200);}],[2000,()=>{if(SD.warpGrid)SD.warpGrid.forEach(p=>p.ph=Math.random()*Math.PI*2);}],[3000,()=>{beatFX.invertA=0.4;}],[6000,()=>{beatFX.invertA=0;}]]);
    } else {
      sequence([[0,()=>{for(let i=0;i<6;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.7),100);beatFX.invertA=i%2===0?0.6:0;},i*150);}],[1200,()=>{beatFX.invertA=0.5;if(SD.warpGrid)SD.warpGrid.forEach(p=>p.ph+=Math.PI);}],[4000,()=>{beatFX.invertA=0.3;}],[7000,()=>{beatFX.invertA=0;}]]);
    }
  }
  else if(sc==='SPACE_STATION'){
    if(variant===0){
      // Hull breach — red alert, debris, cracks
      sequence([[0,()=>{SD.hullBreachActive=true;flash('rgba(255,0,0,0.6)',300);beatFX.speedBoost=2;}],[400,()=>{flash('rgba(255,0,0,0.5)',300);if(SD.debris)for(let i=0;i<10;i++)SD.debris.push({...mkDebris(),vx:(Math.random()-0.5)*14,vy:(Math.random()-0.5)*14});}],[800,()=>{flash('rgba(255,50,0,0.4)',400);}],[1500,()=>{for(let i=0;i<5;i++)setTimeout(()=>{document.getElementById('surpriseOverlay').style.background='rgba(200,0,0,0.1)';document.getElementById('surpriseOverlay').style.opacity='1';setTimeout(()=>document.getElementById('surpriseOverlay').style.opacity='0',80);},i*250);}],[4000,()=>{beatFX.speedBoost=0;}],[8000,()=>{SD.hullBreachActive=false;}]]);
    } else if(variant===1){
      // Warp jump — scene stretches and snaps
      sequence([[0,()=>{beatFX.speedBoost=4;flash('rgba(255,255,255,0.4)',200);}],[500,()=>{beatFX.speedBoost=8;flash('rgba(255,255,255,0.8)',150);}],[700,()=>{beatFX.speedBoost=14;flash('rgba(255,255,255,0.95)',100);}],[900,()=>{beatFX.speedBoost=2;flash('rgba(0,0,0,0.8)',300);}],[2000,()=>{beatFX.speedBoost=0.5;}],[6000,()=>{beatFX.speedBoost=0;}]]);
    } else {
      sequence([[0,()=>{flash('rgba(255,0,0,0.7)',200);SD.hullBreachActive=true;}],[400,()=>{beatFX.speedBoost=3;if(SD.debris)for(let i=0;i<8;i++)SD.debris.push({...mkDebris(),vx:(Math.random()-0.5)*16,vy:(Math.random()-0.5)*16});}],[2000,()=>{flash('rgba(255,100,0,0.5)',400);}],[5000,()=>{beatFX.speedBoost=0;}],[9000,()=>{SD.hullBreachActive=false;}]]);
    }
  }
  else if(sc==='NEON_CATHEDRAL'){
    if(variant===0){
      // All rays converge — blinding white
      sequence([[0,()=>{if(SD.rays)SD.rays.forEach(lr=>{lr.x=W()/2+(lr.x-W()/2)*0.05;});flash(rgba(pc(0),0.7),200);}],[300,()=>{flash('rgba(255,255,255,0.95)',150);}],[600,()=>{beatFX.invertA=0.5;if(SD.motes)SD.motes.forEach(p=>{p.vy*=8;p.vx=(Math.random()-0.5)*5;});}],[2000,()=>{if(SD.rays)SD.rays.forEach((lr,i)=>lr.x=W()*(0.05+i*(0.9/(SD.rays.length-1))));}],[3000,()=>{beatFX.invertA=0;}],[6000,()=>{if(SD.motes)SD.motes.forEach(p=>p.vy/=8);}]]);
    } else if(variant===1){
      // Stained glass shatters
      sequence([[0,()=>{for(let i=0;i<4;i++)setTimeout(()=>{flash(rgba(pc(i),0.6),100);},i*80);}],[500,()=>{flash('rgba(255,255,255,0.9)',200);}],[800,()=>{beatFX.invertA=0.7;if(SD.motes)SD.motes.forEach(p=>{p.vy*=10;p.vx*=5;});}],[2500,()=>{beatFX.invertA=0;}],[4000,()=>{flash(rgba(pc(0),0.5),600);}],[7000,()=>{if(SD.motes)SD.motes.forEach(p=>{p.vy=-(0.5+Math.random()*1.5);p.vx=(Math.random()-0.5)*0.8;});}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(1),0.8),100);}],[200,()=>{flash(rgba(pc(0),0.7),100);}],[400,()=>{flash('rgba(255,255,255,0.85)',200);beatFX.invertA=0.6;}],[1200,()=>{beatFX.invertA=0;if(SD.rays)SD.rays.forEach(lr=>{lr.x=W()/2+(lr.x-W()/2)*0.1;});}],[3000,()=>{if(SD.rays)SD.rays.forEach((lr,i)=>lr.x=W()*(0.1+i*(0.8/Math.max(1,SD.rays.length-1))));}],[6000,()=>{}]]);
    }
  }
  else if(sc==='CLASSIC_ARCADE'){
    if(variant===0){
      // Boss appears!
      sequence([[0,()=>{SD.bossActive=true;SD.bossX=W()*0.72;SD.bossY=H()*0.3;SD.bossShots=[];flash(rgba(pc(0),0.7),300);}],[500,()=>{flash('rgba(255,0,0,0.4)',400);}],[3000,()=>{flash(rgba(pc(1),0.5),300);}],[9000,()=>{SD.bossActive=false;}],[10000,()=>{showGameOver();}]]);
    } else if(variant===1){
      // Game over screen
      sequence([[0,()=>{showGameOver();flash('rgba(255,0,0,0.5)',300);}],[2500,()=>{flash(rgba(pc(0),0.4),400);}],[3000,()=>{if(SD.galaShips)SD.galaShips.forEach(gs=>gs.ph=0);}]]);
    } else {
      sequence([[0,()=>{SD.bossActive=true;SD.bossX=W()*0.6;SD.bossY=H()*0.25;SD.bossShots=[];flash(rgba(pc(0),0.8),200);}],[400,()=>{flash('rgba(255,0,0,0.6)',200);}],[1000,()=>{flash('rgba(255,255,0,0.4)',300);}],[6000,()=>{flash(rgba(pc(1),0.5),400);}],[8000,()=>{SD.bossActive=false;showGameOver();}]]);
    }
  }
  else if(sc==='ELECTRIC_FOREST'){
    if(variant===0){
      // Trees catch fire, burn, regrow
      sequence([[0,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=5);flash(rgba(pc(0),0.7),400);}],[1000,()=>{flash(rgba(pc(1),0.5),300);}],[2000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=3);flash(rgba(pc(2),0.4),400);}],[4000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=1);}],[5000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=4);}],[8000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=1);}]]);
    } else if(variant===1){
      // Lightning storm through canopy
      sequence([[0,()=>{for(let i=0;i<8;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.6)',60);},i*120);}],[1500,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=4);}],[3000,()=>{for(let i=0;i<6;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*150);}],[6000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=1);}]]);
    } else {
      sequence([[0,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=6);flash(rgba(pc(0),0.8),300);}],[500,()=>{flash('rgba(255,255,255,0.7)',150);}],[1000,()=>{beatFX.speedBoost=2;if(SD.trees)SD.trees.forEach(t=>t.glowMult=3);}],[3000,()=>{beatFX.speedBoost=0;}],[5000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=5);}],[8000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=1);}]]);
    }
  }
  else if(sc==='OMNIA_NIGHTCLUB'){
    if(variant===0){
      // Chandelier drops and shatters
      sequence([[0,()=>{if(SD.chandelierY!=null)SD.chandelierY=H()*0.55;flash(rgba(pc(0),0.6),300);}],[400,()=>{flash('rgba(255,255,255,0.8)',200);}],[1000,()=>{beatFX.invertA=0.4;if(SD.chandelierY!=null)SD.chandelierY=H()*0.45;}],[2000,()=>{beatFX.invertA=0;}],[5000,()=>{if(SD.chandelierY!=null)SD.chandelierY=H()*0.22;}]]);
    } else if(variant===1){
      // Blackout then UV reveal
      sequence([[0,()=>{flash('rgba(0,0,0,0.97)',100);}],[200,()=>{flash(rgba(pc(0),0.8),300);}],[600,()=>{beatFX.invertA=0.7;}],[1000,()=>{beatFX.invertA=0;flash(rgba(pc(1),0.6),400);}],[3000,()=>{if(SD.chandelierY!=null)SD.chandelierY=H()*0.15;flash('rgba(255,255,255,0.3)',500);}],[6000,()=>{if(SD.chandelierY!=null)SD.chandelierY=H()*0.22;}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.7),200);}],[300,()=>{flash(rgba(pc(1),0.6),200);}],[600,()=>{flash(rgba(pc(2),0.7),200);}],[900,()=>{beatFX.invertA=0.5;if(SD.chandelierY!=null)SD.chandelierY=H()*0.5;}],[2000,()=>{beatFX.invertA=0;}],[4000,()=>{if(SD.chandelierY!=null)SD.chandelierY=H()*0.2;}]]);
    }
  }
  else if(sc==='PIRATE_SHIP'){
    if(variant===0){
      // Kraken attack — tentacles from water
      sequence([[0,()=>{flash(rgba(pc(0),0.6),400);if(SD.creatures)for(let i=0;i<4;i++)setTimeout(()=>{SD.creatures&&SD.creatures.push({...mkDeepCreature(W(),H()),sz:150+i*30,vx:1.2+i*0.3,y:H()*(0.55+i*0.08)});},i*300);}],[2000,()=>{flash(rgba(pc(1),0.5),500);}],[4000,()=>{for(let i=0;i<5;i++)setTimeout(()=>SD.cannonballs&&SD.cannonballs.push(mkCannonball()),i*120);}],[7000,()=>{}]]);
    } else if(variant===1){
      // Cannonball broadside
      sequence([[0,()=>{for(let i=0;i<8;i++)setTimeout(()=>{SD.cannonballs&&SD.cannonballs.push(mkCannonball());flash('rgba(255,150,0,0.4)',150);},i*180);}],[2000,()=>{flash(rgba(pc(0),0.6),300);}],[3000,()=>{for(let i=0;i<6;i++)setTimeout(()=>{SD.cannonballs&&SD.cannonballs.push(mkCannonball());},i*200);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);}],[500,()=>{for(let i=0;i<5;i++)setTimeout(()=>SD.cannonballs&&SD.cannonballs.push(mkCannonball()),i*150);}],[2000,()=>{if(SD.creatures)for(let i=0;i<3;i++)SD.creatures.push({...mkDeepCreature(W(),H()),sz:180,vx:1.5,y:H()*(0.6+i*0.08)});}],[4000,()=>{flash(rgba(pc(1),0.5),400);}],[7000,()=>{}]]);
    }
  }
  else if(sc==='JUNKYARD'){
    if(variant===0){
      // Wrecking ball berserk + spark explosion
      sequence([[0,()=>{beatFX.speedBoost=2;for(let i=0;i<50;i++)SD.sparks&&SD.sparks.push(mkSpark(false));flash(rgba(pc(1),0.7),200);}],[400,()=>{flash(rgba(pc(0),0.6),200);for(let i=0;i<40;i++)SD.sparks&&SD.sparks.push(mkSpark(false));}],[1000,()=>{beatFX.gravityWave=2;for(let i=0;i<5;i++)setTimeout(()=>{for(let j=0;j<20;j++)SD.sparks&&SD.sparks.push(mkSpark(false));},i*400);}],[4000,()=>{beatFX.gravityWave=0;}],[7000,()=>{beatFX.speedBoost=0;}]]);
    } else if(variant===1){
      // Junk pile avalanche
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);for(let i=0;i<60;i++)SD.sparks&&SD.sparks.push(mkSpark(false));}],[500,()=>{flash(rgba(pc(1),0.5),400);}],[1000,()=>{beatFX.slamS=1.5;for(let i=0;i<4;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.8;},i*400);}],[4000,()=>{beatFX.slamS=1;}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{beatFX.speedBoost=3;flash(rgba(pc(0),0.8),200);}],[400,()=>{flash(rgba(pc(1),0.6),200);for(let i=0;i<80;i++)SD.sparks&&SD.sparks.push(mkSpark(false));}],[1200,()=>{beatFX.gravityWave=1.5;}],[3000,()=>{beatFX.gravityWave=0;beatFX.speedBoost=1;}],[6000,()=>{beatFX.speedBoost=0;}]]);
    }
  }
  else if(sc==='SUPERHERO'){
    if(variant===0){
      // Villain attack — city under siege
      sequence([[0,()=>{doComicBurst();flash(rgba(pc(0),0.6),300);}],[800,()=>{doComicBurst();}],[2000,()=>{flash('rgba(255,0,0,0.3)',400);doComicBurst();}],[4000,()=>{flash(rgba(pc(1),0.5),400);}],[6000,()=>{doComicBurst();}]]);
    } else if(variant===1){
      // Hero power-up — light radiates from signal
      sequence([[0,()=>{flash('rgba(255,255,200,0.7)',300);beatFX.speedBoost=2;}],[400,()=>{flash('rgba(255,255,255,0.9)',200);}],[800,()=>{flash(rgba(pc(0),0.6),400);}],[2000,()=>{doComicBurst();}],[4000,()=>{beatFX.speedBoost=0;}]]);
    } else {
      sequence([[0,()=>{doComicBurst();flash(rgba(pc(0),0.7),200);}],[500,()=>{doComicBurst();}],[1200,()=>{flash('rgba(255,255,0,0.5)',300);}],[2500,()=>{doComicBurst();flash(rgba(pc(1),0.5),400);}],[5000,()=>{flash('rgba(255,255,255,0.4)',300);}]]);
    }
  }
  else if(sc==='DAY_OF_DEAD'){
    if(variant===0){
      // Spirit rises from altar — centerpiece surges upward
      sequence([[0,()=>{flash(rgba(pc(0),0.6),500);}],[500,()=>{if(SD.skulls)SD.skulls.forEach(s=>{s.sz*=1.6;s.ph+=Math.PI;});}],[1000,()=>{flash(rgba(pc(1),0.5),400);}],[2000,()=>{if(SD.candles)SD.candles.forEach(c=>c.sz*=1.8);}],[4000,()=>{if(SD.skulls)SD.skulls.forEach(s=>s.sz/=1.6);if(SD.candles)SD.candles.forEach(c=>c.sz/=1.8);}],[7000,()=>{}]]);
    } else if(variant===1){
      // Parade of skulls charges across
      sequence([[0,()=>{for(let i=0;i<8;i++)setTimeout(()=>{SD.skulls&&SD.skulls.push({x:-50+i*5,y:H()*(0.3+i*0.06),sz:45,ph:Math.random()*Math.PI*2,ci:i%4});},i*150);}],[1000,()=>{flash(rgba(pc(0),0.6),400);}],[2000,()=>{if(SD.candles)SD.candles.forEach(c=>c.sz*=2);}],[3000,()=>{flash(rgba(pc(1),0.5),500);}],[6000,()=>{if(SD.candles)SD.candles.forEach(c=>c.sz/=2);}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.8),300);}],[400,()=>{if(SD.petals)SD.petals.forEach(p=>{p.vy*=6;p.vx=(Math.random()-0.5)*4;});}],[1500,()=>{if(SD.skulls)SD.skulls.forEach(s=>s.sz*=1.5);flash(rgba(pc(1),0.6),400);}],[4000,()=>{if(SD.petals)SD.petals.forEach(p=>{p.vy/=6;});if(SD.skulls)SD.skulls.forEach(s=>s.sz/=1.5);}]]);
    }
  }
  else if(sc==='CHINESE_DRAGON'){
    if(variant===0){
      // Dragon breathes fire — giant flash + centerpiece pearl surges
      sequence([[0,()=>{flash(rgba(pc(0),0.8),300);}],[400,()=>{flash('rgba(255,150,0,0.7)',200);}],[800,()=>{if(SD.dragonPath)SD.dragonPath.forEach(p=>{p.vx=p.vx*3||6;});flash('rgba(255,200,50,0.5)',400);}],[2000,()=>{flash(rgba(pc(0),0.5),500);}],[5000,()=>{}]]);
    } else if(variant===1){
      // Second dragon appears — pearl whips wildly
      sequence([[0,()=>{if(SD.pearl){SD.pearl.ph+=Math.PI;};flash(rgba(pc(1),0.6),400);}],[1000,()=>{flash(rgba(pc(0),0.7),300);}],[2000,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed*=5);}],[4000,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed/=5);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.9),200);}],[300,()=>{if(SD.pearl)SD.pearl.ph+=Math.PI*0.5;}],[500,()=>{flash('rgba(255,180,0,0.6)',300);}],[1500,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed*=3);flash(rgba(pc(1),0.5),400);}],[4000,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed/=3);}]]);
    }
  }
  else if(sc==='MOUNT_OLYMPUS'){
    if(variant===0){
      // Zeus rage — rapid bolt barrage at centerpiece, debris everywhere
      sequence([[0,()=>{flash('rgba(255,255,100,0.8)',200);if(SD.zeus)SD.zeus.throwing=true;}],[300,()=>{if(SD.boltsComing&&SD.cpTarget){const t=SD.cpTarget;for(let i=0;i<3;i++)setTimeout(()=>{const dx=t.x-W()/2,dy=t.y-H()*0.3,dist=Math.hypot(dx,dy)||1;SD.boltsComing.push({x:W()/2+90,y:H()*0.18-80,vx:dx/dist*16,vy:dy/dist*16,size:25,life:1.2,ci:1,target:t});},i*300);};}],[2000,()=>{flash('rgba(200,255,100,0.5)',400);}],[4000,()=>{flash('rgba(255,255,200,0.4)',500);}],[7000,()=>{}]]);
    } else if(variant===1){
      // Lightning storm covers entire sky
      sequence([[0,()=>{for(let i=0;i<10;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.7)',60);},i*100);}],[1500,()=>{flash('rgba(255,255,100,0.6)',300);}],[2500,()=>{for(let i=0;i<8;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*120);}],[5000,()=>{flash('rgba(255,255,200,0.4)',500);}]]);
    } else {
      sequence([[0,()=>{flash('rgba(255,255,100,0.9)',150);SD.zeus&&(SD.zeus.throwing=true);}],[300,()=>{flash('rgba(200,180,50,0.6)',200);}],[700,()=>{for(let i=0;i<6;i++)setTimeout(()=>SD.lightnings&&SD.lightnings.push(mkLightning()),i*100);}],[2000,()=>{flash('rgba(255,255,100,0.5)',400);}],[5000,()=>{for(let i=0;i<5;i++)setTimeout(()=>SD.lightnings&&SD.lightnings.push(mkLightning()),i*150);}]]);
    }
  }
  else if(sc==='SUPER_MARIO'){
    if(variant===0){
      // Star power — rainbow flash, everything glows
      sequence([[0,()=>{for(let i=0;i<6;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.6),100);},i*100);}],[700,()=>{beatFX.speedBoost=2;}],[1000,()=>{if(SD.goombas)SD.goombas.forEach(g=>g.vx*=3);}],[3000,()=>{if(SD.goombas)SD.goombas.forEach(g=>g.vx/=3);beatFX.speedBoost=0;}],[5000,()=>{for(let i=0;i<4;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.5),100);},i*100);}]]);
    } else if(variant===1){
      // Bowser stomps in from right side
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);}],[400,()=>{for(let i=0;i<4;i++)setTimeout(()=>{beatFX.slamS=1.3;setTimeout(()=>beatFX.slamS=1,200);flash(rgba(pc(2),0.5),100);},i*600);}],[3000,()=>{flash('rgba(255,100,0,0.5)',400);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{for(let i=0;i<5;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.5),80);},i*80);}],[500,()=>{beatFX.speedBoost=3;if(SD.coins)SD.coins.forEach(c=>c.ph+=Math.PI);}],[2000,()=>{beatFX.speedBoost=1;}],[4000,()=>{beatFX.speedBoost=0;flash(rgba(pc(1),0.5),400);}]]);
    }
  }
  else if(sc==='ATLANTIS'){
    if(variant===0){
      // Earthquake — columns crumble, power source surges
      sequence([[0,()=>{flash(rgba(pc(2),0.7),400);beatFX.shockwaveR=0;beatFX.shockwaveA=1;}],[500,()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.8;flash(rgba(pc(0),0.5),300);}],[1000,()=>{if(SD.ruins)SD.ruins.filter(r=>r.type==='column').forEach(r=>r.tilt+=(Math.random()-0.5)*0.4);}],[2000,()=>{flash(rgba(pc(1),0.5),500);beatFX.shockwaveR=0;beatFX.shockwaveA=0.6;}],[4000,()=>{if(SD.jellies)SD.jellies.forEach(j=>j.ph+=Math.PI);}],[7000,()=>{}]]);
    } else if(variant===1){
      // Whirlpool forms — fish scatter, bubbles surge
      sequence([[0,()=>{flash(rgba(pc(2),0.6),400);}],[500,()=>{if(SD.bubbles)SD.bubbles.forEach(b=>b.vy*=10);if(SD.fish)SD.fish.forEach(f=>{f.vx=(Math.random()-0.5)*8;f.vy=(Math.random()-0.5)*4;});}],[1500,()=>{flash(rgba(pc(0),0.5),500);}],[3000,()=>{if(SD.bubbles)SD.bubbles.forEach(b=>b.vy/=10);}],[5000,()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.8;flash(rgba(pc(1),0.4),400);}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.8),300);}],[400,()=>{if(SD.lightShafts)SD.lightShafts.forEach(ls=>ls.ph+=Math.PI);flash(rgba(pc(2),0.6),300);}],[1000,()=>{if(SD.ruins)SD.ruins.filter(r=>r.type==='column').forEach(r=>r.tilt+=(Math.random()-0.5)*0.5);}],[3000,()=>{if(SD.bubbles)SD.bubbles.forEach(b=>b.vy*=6);}],[5000,()=>{if(SD.bubbles)SD.bubbles.forEach(b=>b.vy/=6);}],[7000,()=>{}]]);
    }
  }
  else if(sc==='CARNIVAL'){
    if(variant===0){
      // Ferris wheel spins out of control
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);}],[400,()=>{if(SD.ferrisRot!=null)SD.ferrisRot+=0.5;flash(rgba(pc(1),0.5),300);}],[1000,()=>{beatFX.speedBoost=3;}],[3000,()=>{flash(rgba(pc(0),0.5),400);}],[5000,()=>{beatFX.speedBoost=0;}],[7000,()=>{}]]);
    } else if(variant===1){
      // Fireworks explosion
      sequence([[0,()=>{for(let i=0;i<5;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.9;flash(rgba(pc(i%4),0.6),100);},i*250);}],[1500,()=>{if(SD.confetti)SD.confetti.forEach(c=>{c.vy*=5;c.vx=(Math.random()-0.5)*6;});}],[3000,()=>{if(SD.confetti)SD.confetti.forEach(c=>{c.vy/=5;c.vx=(Math.random()-0.5)*0.8;});}],[5000,()=>{for(let i=0;i<3;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.7;},i*300);}]]);
    } else {
      sequence([[0,()=>{beatFX.speedBoost=2;flash(rgba(pc(0),0.7),200);}],[500,()=>{if(SD.confetti)SD.confetti.forEach(c=>{c.vy*=4;});flash(rgba(pc(1),0.5),300);}],[2000,()=>{for(let i=0;i<4;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.8;},i*350);}],[5000,()=>{beatFX.speedBoost=0;if(SD.confetti)SD.confetti.forEach(c=>c.vy/=4);}]]);
    }
  }
  else if(sc==='EGYPTIAN_TOMB'){
    if(variant===0){
      // Mummy awakens — wrappings fly
      sequence([[0,()=>{flash(rgba(pc(1),0.6),400);}],[500,()=>{if(SD.hieroglyphs)SD.hieroglyphs.forEach(h=>{h.alpha=1;h.vy=-(1+Math.random()*3);});}],[1000,()=>{flash(rgba(pc(0),0.5),400);}],[2000,()=>{if(SD.traps)for(let i=0;i<6;i++)SD.traps.push({x:Math.random()*W(),y:0,vy:Math.random()*8+4,life:1,ci:Math.floor(Math.random()*4)});}],[4000,()=>{flash(rgba(pc(2),0.5),500);}],[7000,()=>{}]]);
    } else if(variant===1){
      // Trap triggers — spikes, boulders, poison
      sequence([[0,()=>{flash(rgba(pc(1),0.7),300);for(let i=0;i<8;i++)setTimeout(()=>{SD.traps&&SD.traps.push({x:Math.random()*W(),y:0,vy:Math.random()*10+6,life:1,ci:Math.floor(Math.random()*4)});},i*150);}],[1500,()=>{flash(rgba(pc(0),0.6),300);}],[3000,()=>{for(let i=0;i<6;i++)setTimeout(()=>{SD.traps&&SD.traps.push({x:Math.random()*W(),y:0,vy:8,life:1,ci:Math.floor(Math.random()*4)});},i*200);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.8),200);}],[300,()=>{if(SD.hieroglyphs)SD.hieroglyphs.forEach(h=>h.alpha=1);flash(rgba(pc(1),0.6),300);}],[1000,()=>{for(let i=0;i<5;i++)setTimeout(()=>{SD.traps&&SD.traps.push({x:Math.random()*W(),y:0,vy:6+i*1.5,life:1,ci:i%4});beatFX.shockwaveR=0;beatFX.shockwaveA=0.5;},i*300);}],[4000,()=>{flash(rgba(pc(2),0.5),500);}]]);
    }
  }
  else{flash(rgba(pc(0),0.7),600);}
}

function showGameOver(){const g=document.getElementById('gameOverScreen');g.style.display='flex';setTimeout(()=>g.style.display='none',2500);}
function doComicBurst(){const panel=document.getElementById('comicPanel');panel.style.display='block';const words=['POW!','ZAP!','BOOM!','WHAM!','KA-BAM!','CRASH!','SLAM!'];const cols=['#ff0','#f0f','#0ff','#f60','#0f0'];panel.innerHTML='';for(let i=0;i<3;i++){const d=document.createElement('div');d.style.cssText=`position:absolute;font-size:${Math.random()*5+4}rem;color:${cols[i%5]};text-shadow:3px 3px 0 #000;left:${Math.random()*70+5}%;top:${Math.random()*70+5}%;transform:rotate(${(Math.random()-0.5)*30}deg);font-family:monospace;font-weight:bold;`;d.textContent=words[Math.floor(Math.random()*words.length)];panel.appendChild(d);}setTimeout(()=>panel.style.display='none',2800);}


// ═══ STATE ═══
let token=null,lastTid=null,inTrans=false;
let THEME={scene:'WARP_SPEED',label:'',splashDesc:'',palette:['#06ffd8','#8338ec','#ff006e','#ffbe0b'],bgColor:'#000010',centerpiece:null,centerpieceScale:0.5,centerpieceBehavior:'rotate',beatReactions:['shockwave'],sceneSpeed:1,sceneIntensity:0.7,energy:0.5,chaos:0.3};
let aiCache={};
let MS={beatInterval:500,lastBeat:0,duration:180000,analysisStart:0,energy:0.5};
let SM={energy:0.5,beatPulse:0};
let SD={};
let songProg=0,progMult=0.6;
let cpRot=0,cpPh=0,cpOrbit=0;
let beatFX={shockwaveR:0,shockwaveA:0,crackLines:[],invertA:0,slamS:1,speedBoost:0,gravityWave:0};
let beatReactionIdx=0,beatCount=0;
let energyHist=[],surpriseFired=false,surpriseArmed=false,midShifted=false;
let gridGlitch=false;

// ═══ ENERGY SPIKE DETECTION ═══
function pushEnergy(e){energyHist.push(e);if(energyHist.length>60)energyHist.shift();}
function spikeDetected(){
  if(energyHist.length<12)return false;
  const recent=energyHist.slice(-3).reduce((a,b)=>a+b,0)/3;
  const base=energyHist.slice(-15,-5).reduce((a,b)=>a+b,0)/10;
  return recent>base+0.25&&recent>0.62;
}

// ═══ BEAT TRIGGER ═══
function triggerBeat(){
  SM.beatPulse=1;beatCount++;
  const reactions=THEME.beatReactions||['shockwave'];
  const reaction=reactions[beatReactionIdx%reactions.length];
  beatReactionIdx++;
  const intensity=0.5+progMult*0.7;
  switch(reaction){
    case 'speed_burst':beatFX.speedBoost=1.5*intensity;break;
    case 'shockwave':beatFX.shockwaveR=0;beatFX.shockwaveA=0.8*intensity;break;
    case 'color_invert':beatFX.invertA=0.45*intensity;break;
    case 'world_crack':spawnCracks();break;
    case 'bass_slam':beatFX.slamS=1+0.12*intensity;break;
    case 'strobe_cut':beatFX.invertA=THEME.energy>0.6?0.8*intensity:0.3;break;
    case 'creature_surge':if(SD.creatures)SD.creatures.push(mkDeepCreature(W(),H()));break;
    case 'cannon_fire':if(SD.cannonballs)SD.cannonballs.push(mkCannonball());break;
    case 'lightning_strike':if(SD.lightnings!=null)SD.lightnings.push(mkLightning());break;
    case 'gravity_wave':beatFX.gravityWave=1;break;
    case 'petal_burst':if(SD.petals)SD.petals.forEach(p=>{p.vx=(Math.random()-0.5)*5;p.vy=-(Math.random()*4+2);});break;
  }
  // Scene-specific beat actions
  const sc=THEME.scene;
  if(sc==='LAVA_WORLD'&&Math.random()<0.4&&SD.eruptions)SD.eruptions.push(mkEruption());
  if(sc==='STORM_CHASER'&&SD.lightnings!=null)SD.lightnings.push(mkLightning());
  if((sc==='MOUNT_OLYMPUS')&&SD.boltsComing&&Math.random()<0.5)SD.boltsComing.push(mkBolt());
  if(sc==='PIRATE_SHIP'&&SD.cannonballs&&Math.random()<0.3)SD.cannonballs.push(mkCannonball());
  if(sc==='JUNKYARD'&&SD.sparks)for(let i=0;i<8;i++)SD.sparks.push(mkSpark(false));
  if(sc==='CARNIVAL'&&SD.ferrisRot!=null)SD.ferrisRot+=0.15;
  if(sc==='OMNIA_NIGHTCLUB'&&SD.chandelierY!=null)SD.chandelierY=Math.max(H()*0.05,SD.chandelierY-20*(1+progMult));
  // Surprise detection
  pushEnergy(SM.energy);
  if(!surpriseFired&&songProg>0.2){
    surpriseArmed=true;
    if(spikeDetected()){setTimeout(fireSurprise,300);surpriseFired=true;}
  }
  if(!surpriseFired&&songProg>0.85){fireSurprise();surpriseFired=true;}
}
function spawnCracks(){const cx=W()/2,cy=H()/2;beatFX.crackLines=Array.from({length:8},()=>{const a=Math.random()*Math.PI*2,len=Math.random()*Math.max(W(),H())*0.7+100;const segs=[];let x2=cx,y2=cy;for(let i=0;i<6;i++){x2+=Math.cos(a+(Math.random()-0.5)*0.8)*len/6;y2+=Math.sin(a+(Math.random()-0.5)*0.8)*len/6;segs.push({x:x2,y:y2});}return{segs,life:1,ci:Math.floor(Math.random()*4)};});}

// ═══ SURPRISE SYSTEM ═══
function flash(color,ms){const o=document.getElementById('surpriseOverlay');o.style.background=color;o.style.transition='opacity 0.08s';o.style.opacity='1';setTimeout(()=>{o.style.transition=`opacity ${ms}ms ease`;o.style.opacity='0';},100);}
// fireSurprise defined above
function showGameOver(){const g=document.getElementById('gameOverScreen');g.style.display='flex';setTimeout(()=>g.style.display='none',2500);}
function doComicBurst(){const panel=document.getElementById('comicPanel');panel.style.display='block';const words=['POW!','ZAP!','BOOM!','WHAM!','KA-BAM!'];const cols=['#ff0','#f0f','#0ff','#f60'];panel.innerHTML='';for(let i=0;i<3;i++){const d=document.createElement('div');d.style.cssText=`position:absolute;font-size:${Math.random()*5+4}rem;color:${cols[i%4]};text-shadow:3px 3px 0 #000;left:${Math.random()*70+5}%;top:${Math.random()*70+5}%;transform:rotate(${(Math.random()-0.5)*30}deg)`;d.textContent=words[Math.floor(Math.random()*words.length)];panel.appendChild(d);}setTimeout(()=>panel.style.display='none',2200);}


// ═══ PARTICLE FACTORIES ═══
function mkEmber(init){return{x:Math.random()*W(),y:init?Math.random()*H():H()+10,vx:(Math.random()-0.5)*2,vy:-(Math.random()*3+1),r:Math.random()*4+1,life:Math.random()*0.6+0.4,ci:Math.floor(Math.random()*2)}}
function mkEruption(){return{x:Math.random()*W(),particles:Array.from({length:35},()=>({vx:(Math.random()-0.5)*10,vy:-(Math.random()*14+6),life:1,ci:Math.floor(Math.random()*2)})),life:1}}
function mkDeepCreature(w,h){return{x:-200,y:Math.random()*(h||H())*0.8+((h||H())*0.05),vx:Math.random()*0.8+0.2,sz:Math.random()*180+60,type:Math.floor(Math.random()*4),ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,tentacles:Array.from({length:8},()=>({ph:Math.random()*Math.PI*2,len:Math.random()*0.8+0.4}))}}
function mkJungleCreature(w,h){return{x:(w||W())+100,y:((h||H())*0.3)+Math.random()*(h||H())*0.4,vx:-(Math.random()*1+0.3),sz:Math.random()*120+60,type:Math.floor(Math.random()*3),ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}}
function mkSpark(init){return{x:Math.random()*W(),y:init?Math.random()*H():(H()*0.4+Math.random()*H()*0.3),vx:(Math.random()-0.5)*6,vy:-(Math.random()*8+2),life:Math.random()*0.6+0.2,ci:Math.floor(Math.random()*2)}}
function mkCannonball(){return{x:W()*0.15+Math.random()*W()*0.1,y:H()*0.55,vx:Math.random()*8+4,vy:-(Math.random()*4+2),r:8,life:1}}
function mkLightning(){const w=W(),h=H();let x2=Math.random()*w,y2=0;const segs=[];while(y2<h){const dy=Math.random()*50+20,dx=(Math.random()-0.5)*80;segs.push({x1:x2,y1:y2,x2:x2+dx,y2:y2+dy});x2+=dx;y2+=dy;}return{segs,life:1,ci:Math.floor(Math.random()*4)}}
function mkBolt(){const w=W(),h=H(),cx=w/2+(Math.random()-0.5)*w*0.4;return{x:cx,y:-50,vx:(Math.random()-0.5)*3,vy:Math.random()*8+5,size:Math.random()*30+15,ci:Math.floor(Math.random()*4),life:1}}
function mkDebris(){const a=Math.random()*Math.PI*2,spd=Math.random()*5+2;return{x:Math.random()*W(),y:Math.random()*H(),vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.2,sz:Math.random()*30+5,ci:Math.floor(Math.random()*4),type:Math.floor(Math.random()*3)}}

// ═══ SCENE INIT ═══
function initScene(){
  SD={};
  const w=W(),h=H(),sc=THEME.scene;
  if(sc==='WARP_SPEED'||sc==='SPACE_STATION')SD.stars=Array.from({length:500},()=>({x:(Math.random()-0.5)*2,y:(Math.random()-0.5)*2,z:Math.random(),ci:Math.floor(Math.random()*4),trail:[]}));
  if(sc==='LAVA_WORLD'){SD.embers=Array.from({length:200},()=>mkEmber(true));SD.eruptions=[];}
  if(sc==='CYBER_GRID'){SD.gridZ=0;SD.buildings=Array.from({length:30},(_,i)=>({x:(i%6-2.5)*w*0.18,h:Math.random()*h*0.6+h*0.15,w:Math.random()*80+30,z:i/30,ci:i%4}));SD.dataStreams=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,speed:Math.random()*4+2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='DEEP_SEA'){SD.creatures=Array.from({length:5},()=>mkDeepCreature(w,h));SD.plankton=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*3+0.5,vy:-(Math.random()*0.4+0.1),vx:(Math.random()-0.5)*0.3,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}));}
  if(sc==='STORM_CHASER'){SD.debris=Array.from({length:80},()=>mkDebris());SD.lightnings=[];SD.ltTimer=0;SD.tornadoA=0;}
  if(sc==='JUNGLE_RAVE'){SD.plants=Array.from({length:25},(_,i)=>({x:w*(i/24),sz:Math.random()*150+60,ph:Math.random()*Math.PI*2,ci:i%4,type:i%3,glowMult:1}));SD.creatures=Array.from({length:3},()=>mkJungleCreature(w,h));SD.spores=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.8,vy:-(Math.random()*0.5+0.1),r:Math.random()*4+1,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='DISCO_DIMENSION'){SD.tileZ=0;SD.chandeliers=Array.from({length:3},(_,i)=>({x:w*(0.2+i*0.3),y:h*0.05,rot:Math.random()*Math.PI*2,rotS:0.006+Math.random()*0.01,size:Math.random()*80+60,drop:false}));SD.beams=Array.from({length:20},()=>({x:Math.random()*w,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='ACID_TRIP'){SD.fracPh=0;SD.colorCyc=0;SD.warpGrid=[];for(let gx=0;gx<=20;gx++)for(let gy=0;gy<=14;gy++)SD.warpGrid.push({gx,gy,ph:Math.random()*Math.PI*2});}
  if(sc==='SPACE_STATION'){SD.debris=Array.from({length:12},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.3,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.01,sz:Math.random()*40+10,ci:Math.floor(Math.random()*4)}));}
  if(sc==='NEON_CATHEDRAL'){SD.arches=Array.from({length:6},(_,i)=>({depth:i/5,width:1-i*0.12,ci:i%4}));SD.rays=Array.from({length:12},()=>({x:Math.random()*w,width:Math.random()*60+20,alpha:Math.random()*0.3+0.05,ph:Math.random()*Math.PI*2}));SD.motes=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,vy:-(Math.random()*0.8+0.2),r:Math.random()*2+0.5,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}));}
  if(sc==='CLASSIC_ARCADE'){SD.pixels=Array.from({length:200},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:(Math.random()-0.5)*2,size:Math.floor(Math.random()*3+1)*8,ci:Math.floor(Math.random()*4),type:Math.floor(Math.random()*4)}));SD.scanLine=0;SD.mazeLines=Array.from({length:20},()=>{const mx=Math.random()*w,my=Math.random()*h;return{x1:mx,y1:my,x2:mx+(Math.random()-0.5)*200,y2:my+(Math.random()-0.5)*200,ci:Math.floor(Math.random()*4)};});}
  if(sc==='ELECTRIC_FOREST'){SD.trees=Array.from({length:20},(_,i)=>({x:w*(i/19),sz:Math.random()*120+60,ph:Math.random()*Math.PI*2,ci:i%4,glowMult:1}));SD.fairies=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*0.8,r:Math.random()*4+2,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));SD.mushrooms=Array.from({length:12},(_,i)=>({x:w*(i/11),sz:Math.random()*60+30,ci:i%4,ph:Math.random()*Math.PI*2}));}
  if(sc==='OMNIA_NIGHTCLUB'){SD.crowdPeople=Array.from({length:60},()=>({x:Math.random()*w,y:h*0.55+Math.random()*h*0.35,ph:Math.random()*Math.PI*2,sz:Math.random()*25+15,ci:Math.floor(Math.random()*4)}));SD.chandelierY=h*0.05;SD.chandelierRot=0;SD.beams=Array.from({length:24},(_,i)=>({angle:i/24*Math.PI*2,ci:i%4,ph:Math.random()*Math.PI*2,len:Math.random()*h*0.5+h*0.3}));}
  if(sc==='PIRATE_SHIP'){SD.waves=Array.from({length:5},(_,i)=>({ph:Math.random()*Math.PI*2,speed:0.002+i*0.001,amp:30+i*15}));SD.cannonballs=[];SD.stars=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h*0.45,br:Math.random()}));SD.seagulls=Array.from({length:6},()=>({x:Math.random()*w,y:Math.random()*h*0.3,vx:Math.random()*1.5+0.5,ph:0}));}
  if(sc==='JUNKYARD'){SD.sparks=Array.from({length:60},()=>mkSpark(true));SD.arms=Array.from({length:4},(_,i)=>({x:w*(0.15+i*0.23),baseY:h*0.6,angle:-Math.PI*0.6,targetAngle:-Math.PI*0.4,speed:0.02+i*0.005,sz:Math.random()*80+60,ci:i%4}));SD.carStacks=Array.from({length:8},(_,i)=>({x:i/7,cars:Math.floor(Math.random()*3+2),ci:i%4}));}
  if(sc==='SUPERHERO'){SD.cityBuildings=Array.from({length:20},(_,i)=>({x:i*w/19,h:Math.random()*h*0.55+h*0.1,w:Math.random()*60+25,ci:i%4,windows:[]}));SD.cityBuildings.forEach(b=>{for(let wy=5;wy<b.h;wy+=18)for(let wx=4;wx<b.w-4;wx+=14)if(Math.random()<0.6)b.windows.push({x:wx,y:wy,on:Math.random()<0.8});});SD.spotlightA=0;}
  if(sc==='DAY_OF_DEAD'){SD.petals=Array.from({length:120},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.5,vy:Math.random()*1.5+0.3,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.05,sz:Math.random()*10+4,ci:Math.floor(Math.random()*4)}));SD.candles=Array.from({length:12},(_,i)=>({x:w*(i/11),flicker:Math.random()*Math.PI*2,sz:Math.random()*15+10}));SD.skulls=Array.from({length:6},(_,i)=>({x:w*(0.1+i*0.16),y:h*0.4+Math.random()*h*0.2,ph:Math.random()*Math.PI*2,sz:Math.random()*40+25,ci:i%4}));}
  if(sc==='CHINESE_DRAGON'){SD.dragonEmerge=0;SD.fog=Array.from({length:8},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*150+80,ph:Math.random()*Math.PI*2,speed:0.001+Math.random()*0.002}));}
  if(sc==='MOUNT_OLYMPUS'){SD.lightnings=[];SD.ltTimer=0;SD.clouds=Array.from({length:8},()=>({x:Math.random()*w,y:Math.random()*h*0.6,r:Math.random()*120+60,vx:(Math.random()-0.5)*0.3,ci:Math.floor(Math.random()*2)}));SD.boltsComing=[];SD.zeusFace={alpha:0,scale:0.3};}
  if(sc==='SUPER_MARIO'){SD.platforms=Array.from({length:12},(_,i)=>({x:i*w/11,y:h*0.4+Math.sin(i)*h*0.2,w:Math.random()*120+60}));SD.coins=Array.from({length:20},()=>({x:Math.random()*w,y:Math.random()*h*0.7,ph:0}));SD.goombas=Array.from({length:5},()=>({x:Math.random()*w,y:h*0.75,vx:(Math.random()-0.5)*2}));SD.scrollX=0;SD.pipes=Array.from({length:4},(_,i)=>({x:w*(0.15+i*0.23),h:Math.random()*h*0.25+h*0.1}));}
  if(sc==='ATLANTIS'){SD.fish=Array.from({length:30},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.5,vy:(Math.random()-0.5)*0.5,sz:Math.random()*20+8,ci:Math.floor(Math.random()*4)}));SD.bubbles=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*8+2,vy:-(Math.random()*0.8+0.2),ph:Math.random()*Math.PI*2}));SD.ruins=Array.from({length:10},(_,i)=>({x:i/9,h:Math.random()*h*0.4+h*0.1,w:Math.random()*80+30,ci:i%4}));SD.lightShafts=Array.from({length:6},(_,i)=>({x:w*(0.05+i*0.18),ph:Math.random()*Math.PI*2}));}
  if(sc==='CARNIVAL'){SD.ferrisSegs=Array.from({length:12},(_,i)=>({angle:i/12*Math.PI*2,ci:i%4}));SD.ferrisRot=0;SD.confetti=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:Math.random()*2+0.5,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.1,sz:Math.random()*8+3,ci:Math.floor(Math.random()*4)}));SD.tentLights=Array.from({length:16},(_,i)=>({angle:i/16*Math.PI*2,ph:Math.random()*Math.PI*2,ci:i%4}));}
  if(sc==='EGYPTIAN_TOMB'){SD.hieroglyphs=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,char:Math.floor(Math.random()*12),ci:Math.floor(Math.random()*4),alpha:Math.random()*0.5+0.2}));SD.torches=Array.from({length:6},(_,i)=>({x:(i/5)*0.9+0.05,ph:Math.random()*Math.PI*2}));SD.tunnelZ=0;SD.traps=[];}
  beatFX={shockwaveR:0,shockwaveA:0,crackLines:[],invertA:0,slamS:1,speedBoost:0,gravityWave:0};
  energyHist=[];surpriseFired=false;surpriseArmed=false;midShifted=false;beatReactionIdx=0;beatCount=0;cpRot=0;cpPh=0;cpOrbit=0;cpBounceX=0;cpBounceY=0;cpBounceVX=0.7+(Math.random()-0.5)*0.4;cpBounceVY=0.5+(Math.random()-0.5)*0.3;cpDriftX=0;cpDriftY=0;
}

// ═══ SCENE RENDERERS ═══
function drawWarpSpeed(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(!SD.stars)return;
  const spd=THEME.sceneSpeed*(0.6+progMult*0.5)*(1+SM.energy)*(1+beatFX.speedBoost*1.5);
  for(const s of SD.stars){
    s.z-=0.0018*spd;if(s.z<0.01){s.z=1;s.x=(Math.random()-0.5)*2;s.y=(Math.random()-0.5)*2;s.trail=[];}
    const px=cx+(s.x/s.z)*cx,py=cy+(s.y/s.z)*cy;
    if(px<-30||px>w+30||py<-30||py>h+30)continue;
    const sz=(1-s.z)*6+0.3;
    if(s.trail.length>1){x0.beginPath();x0.moveTo(s.trail[0].x,s.trail[0].y);for(let i=1;i<s.trail.length;i++)x0.lineTo(s.trail[i].x,s.trail[i].y);x0.lineTo(px,py);x0.strokeStyle=rgba(pc(s.ci),(1-s.z)*0.6);x0.lineWidth=sz*0.5;x0.stroke();}
    s.trail.push({x:px,y:py});if(s.trail.length>8)s.trail.shift();
    x0.beginPath();x0.arc(px,py,sz,0,Math.PI*2);x0.fillStyle=rgba(pc(s.ci),(1-s.z)*0.95);x0.shadowBlur=sz*3;x0.shadowColor=pc(s.ci);x0.fill();x0.shadowBlur=0;
  }
  // INTEGRATED: centerpiece grows from vanishing point — you're flying toward it
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.007*(1+SM.energy*0.2);
    const appr=Math.min(0.9,0.04+songProg*0.6+SM.beatPulse*0.1);
    const targetSz=Math.min(w,h)*appr*0.85;
    const ag=x0.createRadialGradient(cx,cy,0,cx,cy,targetSz*1.8);
    ag.addColorStop(0,rgba(pc(0),0.1*(1+SM.beatPulse)));ag.addColorStop(1,'transparent');
    x0.fillStyle=ag;x0.beginPath();x0.arc(cx,cy,targetSz*1.8,0,Math.PI*2);x0.fill();
    x0.globalAlpha=Math.min(1,appr*2.2);
    drawCPMini(x0,THEME.centerpiece,cx,cy,targetSz,cpRot);
    x0.globalAlpha=1;
  }
}
function drawLavaWorld(t){
  const w=W(),h=H(),cx=w/2;
  // Sky — deep red/orange gradient, darkens at top
  const sky=x0.createLinearGradient(0,0,0,h);
  sky.addColorStop(0,'rgba(10,0,0,1)');
  sky.addColorStop(0.4,rgba(pc(0),0.5));
  sky.addColorStop(0.7,rgba(pc(1),0.6));
  sky.addColorStop(1,'rgba(255,40,0,0.0)');
  x0.fillStyle=sky;x0.fillRect(0,0,w,h);
  // Ash particles drifting
  if(!SD.ashParts){SD.ashParts=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.4,vy:-(Math.random()*0.5+0.1),r:Math.random()*2.5+0.5,ph:Math.random()*Math.PI*2}));}
  for(const a of SD.ashParts){a.x+=a.vx;a.y+=a.vy;a.ph+=0.02;if(a.y<-5){a.y=h+5;a.x=Math.random()*w;}x0.fillStyle=`rgba(80,60,50,${0.25+Math.sin(a.ph)*0.15})`;x0.beginPath();x0.arc(a.x+Math.sin(a.ph)*2,a.y,a.r,0,Math.PI*2);x0.fill();}
  // Volcano silhouette — black mountain on left/right
  x0.fillStyle='rgba(5,2,2,0.97)';
  x0.beginPath();x0.moveTo(0,h);x0.lineTo(w*0.28,h*0.36);x0.lineTo(w*0.35,h*0.38);x0.lineTo(w*0.42,h*0.36);x0.lineTo(w*0.55,h);x0.closePath();x0.fill();
  x0.beginPath();x0.moveTo(w*0.5,h);x0.lineTo(w*0.65,h*0.45);x0.lineTo(w*0.72,h*0.42);x0.lineTo(w*0.79,h*0.44);x0.lineTo(w,h);x0.closePath();x0.fill();
  // Volcano crater glow
  const cg=x0.createRadialGradient(w*0.35,h*0.36,0,w*0.35,h*0.36,w*0.08*(1+SM.beatPulse*0.4));
  cg.addColorStop(0,rgba(pc(0),0.9*(1+SM.beatPulse*0.3)));cg.addColorStop(0.5,rgba(pc(1),0.4));cg.addColorStop(1,'transparent');
  x0.fillStyle=cg;x0.fillRect(0,0,w,h);
  // Lava rivers — flowing lava layers
  for(let lv=0;lv<4;lv++){
    x0.beginPath();
    for(let px=0;px<=w;px+=4){const py=h*(0.62+lv*0.07)+Math.sin(px*0.008+t*0.0015+lv*1.2)*18+Math.sin(px*0.025+t*0.002)*8;px===0?x0.moveTo(px,py):x0.lineTo(px,py);}
    x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();
    const lg=x0.createLinearGradient(0,h*0.62,0,h);
    const c0h=h2r(pc(0)),c1h=h2r(pc(1));
    lg.addColorStop(0,`rgba(${c0h.r},${c0h.g},${c0h.b},${0.8*(1+SM.beatPulse*0.15)})`);
    lg.addColorStop(0.4,`rgba(255,${80+lv*20},0,0.75)`);
    lg.addColorStop(1,'rgba(80,0,0,0.9)');
    x0.fillStyle=lg;x0.fill();
    // Lava surface shimmer
    x0.strokeStyle=`rgba(255,${150-lv*20},0,0.3)`;x0.lineWidth=1.5;
  }
  // Embers
  if(!SD.embers)SD.embers=Array.from({length:50},()=>mkEmber(true));
  for(let i=SD.embers.length-1;i>=0;i--){const e=SD.embers[i];e.x+=e.vx;e.y+=e.vy*(1+SM.energy*0.4);e.life-=0.004;if(e.life<=0||e.y<-20){SD.embers[i]=mkEmber(false);continue;}x0.beginPath();x0.arc(e.x,e.y,e.r*e.life,0,Math.PI*2);x0.fillStyle=rgba(pc(e.ci),e.life*0.9);x0.shadowBlur=8;x0.shadowColor=pc(e.ci);x0.fill();x0.shadowBlur=0;}
  // Eruptions — centerpiece-shaped lava balls arc through sky
  if(!SD.eruptions)SD.eruptions=[];
  if(!SD.lavaBalls)SD.lavaBalls=[];
  // Periodic auto-eruption
  SD.eruptTimer=(SD.eruptTimer||0)+16;
  if(SD.eruptTimer>3000+Math.random()*2000){SD.eruptTimer=0;fireLavaBalls();}
  // Lava balls in flight
  for(let i=SD.lavaBalls.length-1;i>=0;i--){
    const lb=SD.lavaBalls[i];
    lb.vx*=0.99;lb.vy+=0.18; // gravity
    lb.x+=lb.vx;lb.y+=lb.vy;
    lb.rot+=lb.rotS;lb.life-=0.008;
    if(lb.life<=0||lb.y>h+50){SD.lavaBalls.splice(i,1);continue;}
    // Draw as mini centerpiece with lava glow
    x0.shadowBlur=lb.sz*0.8;x0.shadowColor=rgba(pc(0),0.9);
    x0.globalAlpha=lb.life*0.9;
    drawCPMini(x0,THEME.centerpiece||'flame',lb.x,lb.y,lb.sz,lb.rot);
    x0.globalAlpha=1;x0.shadowBlur=0;
    // Drip trail
    x0.fillStyle=rgba(pc(1),lb.life*0.4);x0.beginPath();x0.arc(lb.x,lb.y+lb.sz*0.6,lb.sz*0.2,0,Math.PI*2);x0.fill();
  }
  // Old eruption particles
  for(let i=SD.eruptions.length-1;i>=0;i--){const er=SD.eruptions[i];er.life-=0.015;for(const p of er.particles){p.vx*=0.98;p.vy+=0.25;p.life-=0.018;if(p.life>0){x0.beginPath();x0.arc(er.x+p.vx*(1-p.life)*20,er.y-p.vy*(1-p.life)*20,p.life*5,0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),p.life*0.85);x0.shadowBlur=6;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}}if(er.life<=0)SD.eruptions.splice(i,1);}
}

function fireLavaBalls(){
  if(!SD.lavaBalls)SD.lavaBalls=[];
  const w=W(),h=H();
  const fromLeft=Math.random()<0.5;
  const startX=fromLeft?w*0.35:w*0.72;
  const startY=h*0.36;
  const count=2+Math.floor(Math.random()*3);
  for(let i=0;i<count;i++){
    const angle=-Math.PI*0.6+Math.random()*Math.PI*0.35;
    const speed=4+Math.random()*5;
    SD.lavaBalls.push({x:startX,y:startY,vx:Math.cos(angle)*speed*(fromLeft?1:-1),vy:Math.sin(angle)*speed,sz:18+Math.random()*22,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.15,life:1,ci:Math.floor(Math.random()*2)});
  }
}

function drawCyberGrid(t){
  const w=W(),h=H(),vpy=h*0.45,vpx=w/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Grid corruption grows over song
  const corruption=songProg*0.4;
  if(gridGlitch||corruption>0.15){
    const glitchAmt=gridGlitch?0.3:corruption*0.15;
    x0.fillStyle=rgba(pc(0),glitchAmt);
    for(let i=0;i<(gridGlitch?12:3);i++)x0.fillRect(0,Math.random()*h,w,Math.random()*(gridGlitch?40:8)+2);
    if(gridGlitch)for(let i=0;i<5;i++){x0.fillStyle=rgba(pc(i%4),0.1);x0.fillRect(Math.random()*w,0,Math.random()*80+10,h);}
  }
  SD.gridZ=(SD.gridZ||0)+THEME.sceneSpeed*(1+beatFX.speedBoost)*0.012*(1+SM.energy*0.5)*progMult;
  const GRID=12,COLS=24;
  for(let row=0;row<GRID;row++){const z=((row/GRID+SD.gridZ)%1),py=lerp(vpy,h,z),px1=lerp(vpx,0,z),px2=lerp(vpx,w,z),alpha=(0.05+z*0.5)*THEME.sceneIntensity*(1+SM.beatPulse*0.3);
    // Grid color shifts as song progresses
    const ci=Math.floor(row/3+corruption*8)%4;
    x0.strokeStyle=rgba(pc(ci),alpha);x0.lineWidth=1+z*2;x0.shadowBlur=z>0.7?10+corruption*20:0;x0.shadowColor=pc(ci);x0.beginPath();x0.moveTo(px1,py);x0.lineTo(px2,py);x0.stroke();}
  x0.shadowBlur=0;
  for(let col=0;col<=COLS;col++){const nx=(col/COLS-0.5)*2;x0.beginPath();x0.moveTo(vpx+nx*vpx*0.01,vpy);x0.lineTo(vpx+nx*w*0.5,h);x0.strokeStyle=rgba(pc(1),(Math.abs(nx)<0.2?0.4:0.15)*THEME.sceneIntensity);x0.lineWidth=1;x0.stroke();}
  if(SD.buildings)for(const b of SD.buildings){const depth=((b.z+SD.gridZ*0.5)%1),scale=0.1+depth*0.9;const bx=vpx+b.x*(1-depth)*w*0.4,by=vpy+(h-vpy)*depth,bw=b.w*scale,bh=b.h*scale;x0.fillStyle=rgba(pc(b.ci),0.08+depth*0.12+corruption*0.1);x0.fillRect(bx-bw/2,by-bh,bw,bh);x0.strokeStyle=rgba(pc(b.ci),0.4*depth);x0.lineWidth=1;x0.shadowBlur=8*depth+corruption*15;x0.shadowColor=pc(b.ci);x0.strokeRect(bx-bw/2,by-bh,bw,2);x0.shadowBlur=0;}
  if(SD.dataStreams)for(const ds of SD.dataStreams){ds.y=(ds.y+ds.speed*(1+SM.energy*0.5+corruption*0.5))%h;x0.fillStyle=rgba(pc(ds.ci),0.5+corruption*0.3);x0.font='12px Share Tech Mono';x0.fillText(String.fromCharCode(0x30A0+Math.floor(Math.random()*96)),ds.x,ds.y);}
  // Centerpiece as watermark/texture on the grid floor
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece watermark on grid floor horizon
    const gs=Math.min(w,h)*(0.16+SM.beatPulse*0.04)*(1+corruption*0.5);
    cpRot+=0.005; cpPh+=0.013;
    x0.globalAlpha=(0.07+SM.beatPulse*0.08)*(1+corruption*0.6);
    drawCPMini(x0,THEME.centerpiece,vpx,h*0.78,gs,cpRot+SD.gridZ*0.5);
    x0.globalAlpha=1;
  }
}
function drawDeepSea(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Depth glow evolves over song — gets brighter/more bioluminescent
  const depthGlow=0.3+songProg*0.7;
  for(let i=0;i<3;i++){const gx=w*(0.2+i*0.3)+Math.sin(t*0.0003+i)*w*0.1,gy=h*(0.3+i*0.2)+Math.cos(t*0.0002+i)*h*0.08;const gr=x0.createRadialGradient(gx,gy,0,gx,gy,w*0.25);const gc=h2r(pc(i%4));gr.addColorStop(0,`rgba(${gc.r},${gc.g},${gc.b},${0.06*THEME.sceneIntensity*(1+SM.beatPulse*0.2)*depthGlow})`);gr.addColorStop(1,'transparent');x0.fillStyle=gr;x0.fillRect(0,0,w,h);}
  // Light shafts from above grow as song progresses
  if(songProg>0.2){for(let ls=0;ls<4;ls++){const lx=w*(0.1+ls*0.25)+Math.sin(t*0.0002+ls)*30;x0.save();x0.globalAlpha=(songProg-0.2)*0.06*(1+SM.beatPulse*0.3);const lg=x0.createLinearGradient(lx,0,lx+40,h*0.6);const lc=h2r(pc(ls%4));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx,0);x0.lineTo(lx+80,0);x0.lineTo(lx+160,h*0.6);x0.lineTo(lx-80,h*0.6);x0.closePath();x0.fill();x0.restore();}}
  if(SD.plankton)for(const p of SD.plankton){p.x+=p.vx;p.y+=p.vy;p.ph+=0.04;if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}const br=Math.sin(p.ph)*0.4+0.6;x0.beginPath();x0.arc(p.x,p.y,p.r*(0.7+br*0.3),0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),br*0.7*depthGlow);x0.shadowBlur=8*depthGlow;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}
  if(SD.creatures)for(let i=SD.creatures.length-1;i>=0;i--){const cr=SD.creatures[i];cr.x+=cr.vx*(1+SM.energy*0.3);cr.ph+=0.02;if(cr.x>w+cr.sz*2){SD.creatures[i]=mkDeepCreature(w,h);continue;}x0.save();x0.translate(cr.x,cr.y+Math.sin(cr.ph)*15);const scale=Math.max(0.1,cr.x/w);x0.scale(scale,scale);x0.shadowBlur=30*scale*depthGlow;x0.shadowColor=pc(cr.ci);const alpha=Math.min(1,cr.x/(w*0.3))*THEME.sceneIntensity;x0.strokeStyle=rgba(pc(cr.ci),alpha*0.8);x0.lineWidth=2;x0.beginPath();x0.ellipse(0,0,cr.sz*0.7,cr.sz*0.5*(0.8+Math.sin(cr.ph)*0.2),0,Math.PI,0);x0.stroke();if(cr.tentacles)for(const ten of cr.tentacles){ten.ph+=0.03;x0.beginPath();x0.moveTo(Math.cos(ten.ph)*cr.sz*0.5,0);x0.bezierCurveTo(Math.cos(ten.ph)*cr.sz*0.5+Math.sin(cr.ph+ten.ph)*20,cr.sz,Math.cos(ten.ph)*cr.sz*0.5,cr.sz*1.5*ten.len,Math.cos(ten.ph)*cr.sz*0.5+Math.sin(cr.ph)*10,cr.sz*2*ten.len);x0.strokeStyle=rgba(pc(cr.ci),alpha*0.4);x0.lineWidth=1.5;x0.stroke();}x0.shadowBlur=0;x0.restore();}
  // Centerpiece as the giant creature silhouette emerging from deep
  if(THEME.centerpiece){
    const emerge=0.1+songProg*0.6;
    const creatureSz=Math.min(w,h)*(0.3+emerge*0.4);
    // INTEGRATED: draw centerpiece AS the creature emerging from the deep
    cpPh+=0.013; cpRot+=0.003;
    x0.globalAlpha=emerge*0.82;
    drawCPMini(x0,THEME.centerpiece,w*0.5,h*(0.28+Math.sin(t*0.0004)*0.04),creatureSz,cpRot);
    x0.globalAlpha=1;
  }
}
function drawStormChaser(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  const sg=x0.createRadialGradient(cx,cy*0.3,0,cx,h*0.5,h*0.8);const sc=h2r(pc(2));sg.addColorStop(0,`rgba(${sc.r},${sc.g},${sc.b},${0.15*progMult})`);sg.addColorStop(0.5,THEME.bgColor);sg.addColorStop(1,'rgba(0,0,0,0.9)');x0.fillStyle=sg;x0.fillRect(0,0,w,h);
  SD.tornadoA=(SD.tornadoA||0)+0.015*(1+SM.energy);
  for(let ring=0;ring<30;ring++){const z=ring/30,r=z*Math.min(w,h)*0.4*(1+SM.beatPulse*0.1),y2=cy*0.2+z*(h-cy*0.2);x0.beginPath();x0.ellipse(cx,y2,r*0.3,r*0.08,SD.tornadoA+ring*0.15,0,Math.PI*2);x0.strokeStyle=rgba(pc(ring%4),(1-z)*0.15*THEME.sceneIntensity);x0.lineWidth=1.5+z*2;x0.stroke();}
  if(SD.debris)for(const d of SD.debris){d.x+=d.vx*(1+SM.energy*0.5);d.y+=d.vy*(1+SM.energy*0.5);const dx=d.x-cx,dy=d.y-cy,dist=Math.sqrt(dx*dx+dy*dy);if(dist>0){d.x-=dy/dist*1.5;d.y+=dx/dist*1.5;}d.rot+=d.rotS;if(d.x<-60||d.x>w+60||d.y<-60||d.y>h+60)Object.assign(d,mkDebris());x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);x0.fillStyle=rgba(pc(d.ci),0.5);if(d.type===0)x0.fillRect(-d.sz/2,-d.sz*0.1,d.sz,d.sz*0.2);else{x0.beginPath();x0.arc(0,0,d.sz*0.3,0,Math.PI*2);x0.fill();}x0.restore();}
  // Storm worsens over song - more lightning, faster tornado, heavier rain
  const stormIntensity=0.2+songProg*0.8;
  SD.ltTimer=(SD.ltTimer||0)-16;
  const ltInterval=Math.max(100,600-songProg*400);
  if(SD.ltTimer<0&&SD.lightnings){SD.lightnings.push(mkLightning());if(stormIntensity>0.5)SD.lightnings.push(mkLightning());SD.ltTimer=ltInterval+Math.random()*300;}
  if(SD.lightnings)for(let i=SD.lightnings.length-1;i>=0;i--){const lt=SD.lightnings[i];lt.life-=0.08;if(lt.life<=0){SD.lightnings.splice(i,1);continue;}x0.shadowBlur=20*stormIntensity;x0.shadowColor=pc(lt.ci);for(const seg of lt.segs){x0.beginPath();x0.moveTo(seg.x1,seg.y1);x0.lineTo(seg.x2,seg.y2);x0.strokeStyle=rgba(pc(lt.ci),lt.life*stormIntensity);x0.lineWidth=lt.life*2;x0.stroke();}x0.shadowBlur=0;}
  const rainAlpha=0.1+stormIntensity*0.25;x0.strokeStyle=rgba(pc(2),rainAlpha);x0.lineWidth=0.8;
  for(let i=0;i<Math.floor(100+stormIntensity*200);i++){const rx=Math.random()*w,ry=Math.random()*h;x0.beginPath();x0.moveTo(rx,ry);x0.lineTo(rx-3*stormIntensity,ry+18);x0.stroke();}
  // Centerpiece orbiting the tornado at increasing speed
  if(THEME.centerpiece){
    cpOrbit+=0.015*(1+stormIntensity+SM.beatPulse*0.5);
    const tornadoX=cx,tornadoY=cy*1.2;
    const orbitR=Math.min(w,h)*(0.15+stormIntensity*0.1);
    const orbX=tornadoX+Math.cos(cpOrbit)*orbitR;
    const orbY=tornadoY+Math.sin(cpOrbit)*orbitR*0.4;
    // INTEGRATED: draw centerpiece orbiting tornado
    const osz=Math.min(w,h)*(0.055+SM.beatPulse*0.025);
    cpRot+=0.05; cpPh+=0.013;
    x0.globalAlpha=0.65+stormIntensity*0.35;
    drawCPMini(x0,THEME.centerpiece,orbX,orbY,osz,cpRot);
    x0.globalAlpha=1;
  }
}
function drawJungleRave(t){
  const w=W(),h=H(),cx=w/2;
  // Ground level — standing IN the jungle looking up
  // Floor
  const fl=x0.createLinearGradient(0,h*0.75,0,h);
  fl.addColorStop(0,rgba(pc(2),0.3));fl.addColorStop(1,'rgba(0,10,0,0.95)');
  x0.fillStyle=fl;x0.fillRect(0,h*0.75,w,h*0.25);
  // Root network on floor
  if(!SD.roots){SD.roots=Array.from({length:15},(_,i)=>({x:i/14*w,angle:Math.PI/2+((i%2===0?1:-1)*0.6+Math.random()*0.4),ci:i%4}));}
  x0.shadowBlur=8;
  for(const r of SD.roots){
    x0.strokeStyle=rgba(pc(r.ci),0.25+SM.beatPulse*0.1);x0.lineWidth=3+Math.random();x0.shadowColor=pc(r.ci);
    x0.beginPath();x0.moveTo(r.x,h);
    let rx=r.x,ry=h,ra=r.angle-Math.PI/2;
    for(let seg=0;seg<5;seg++){rx+=Math.cos(ra)*60;ry+=Math.sin(ra)*40;ra+=(Math.random()-0.5)*0.8;x0.lineTo(rx,ry);}
    x0.stroke();
  }
  x0.shadowBlur=0;
  // Massive jungle trees surrounding viewer — tall trunks from bottom, canopy at top
  if(!SD.trees){
    SD.trees=[];
    const positions=[-0.45,-0.3,-0.15,0.15,0.3,0.45,-0.55,0.55];
    for(let i=0;i<positions.length;i++){
      const px=cx+positions[i]*w;
      const scale=1.2-Math.abs(positions[i])*0.6;
      SD.trees.push({x:px,scale,ci:i%4,ph:Math.random()*Math.PI*2,glowMult:1});
    }
  }
  // Draw tree trunks (back to front)
  const sortedTrees=[...SD.trees].sort((a,b)=>b.scale-a.scale);
  for(const tr of sortedTrees){
    tr.ph+=0.006;const glm=tr.glowMult||1;
    const trunkW=30*tr.scale,trunkH=h*0.85*tr.scale;
    // Trunk
    const tg=x0.createLinearGradient(tr.x-trunkW,0,tr.x+trunkW,0);
    tg.addColorStop(0,'rgba(5,15,3,0.95)');tg.addColorStop(0.5,rgba(pc(tr.ci),0.08));tg.addColorStop(1,'rgba(5,15,3,0.95)');
    x0.fillStyle=tg;x0.fillRect(tr.x-trunkW/2,h*0.15,trunkW,h*0.85);
    // Bark detail lines
    x0.strokeStyle=rgba(pc(tr.ci),0.06*glm);x0.lineWidth=1;
    for(let b=0;b<5;b++){x0.beginPath();x0.moveTo(tr.x-trunkW/3+b*(trunkW/5),h*0.2);x0.lineTo(tr.x-trunkW/3+b*(trunkW/5)+Math.sin(b)*5,h*0.9);x0.stroke();}
    // Canopy spread at top
    x0.shadowBlur=25*glm;x0.shadowColor=pc(tr.ci);
    x0.fillStyle=rgba(pc(tr.ci),0.35*glm*(1+SM.beatPulse*0.15));
    x0.beginPath();x0.ellipse(tr.x,h*0.08,trunkW*3.5+Math.sin(tr.ph)*8,h*0.16,0,0,Math.PI*2);x0.fill();
    x0.fillStyle=rgba(pc(tr.ci),0.25*glm);
    x0.beginPath();x0.ellipse(tr.x+Math.sin(tr.ph)*20,h*0.12,trunkW*2.5,h*0.11,Math.sin(tr.ph)*0.1,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;if(tr.glowMult>1)tr.glowMult*=0.97;
  }
  // Vines hanging from canopy
  if(!SD.vines){SD.vines=Array.from({length:12},(_,i)=>({x:Math.random()*w,len:h*(0.3+Math.random()*0.4),swing:Math.random()*Math.PI*2,swingSpeed:0.01+Math.random()*0.01,ci:i%4}));}
  for(const v of SD.vines){v.swing+=v.swingSpeed;const offset=Math.sin(v.swing)*15;x0.strokeStyle=rgba(pc(v.ci),0.2);x0.lineWidth=2;x0.beginPath();x0.moveTo(v.x,0);for(let s=0;s<8;s++){const sy=s/7*v.len;x0.lineTo(v.x+Math.sin(v.swing+s*0.5)*offset,sy);}x0.stroke();// Leaf nodes
  for(let l=0;l<3;l++){const ly=v.len*(0.3+l*0.3);x0.fillStyle=rgba(pc(v.ci),0.25);x0.beginPath();x0.ellipse(v.x+Math.sin(v.swing+(l+2)*0.5)*offset,ly,8,5,v.swing*0.5,0,Math.PI*2);x0.fill();}}
  // Jungle creatures — birds, insects
  if(!SD.creatures){SD.creatures=Array.from({length:6},()=>mkJungleCreature(w,h));}
  for(let i=SD.creatures.length-1;i>=0;i--){const cr=SD.creatures[i];cr.x+=cr.vx*(1+SM.energy*0.3);cr.ph+=0.02;if(cr.x<-cr.sz*2){SD.creatures[i]=mkJungleCreature(w,h);continue;}x0.save();x0.translate(cr.x,cr.y+Math.sin(cr.ph)*cr.sz*0.08);x0.shadowBlur=20;x0.shadowColor=pc(cr.ci);x0.fillStyle=rgba(pc(cr.ci),0.5*THEME.sceneIntensity*(1+SM.beatPulse*0.15));x0.beginPath();x0.ellipse(0,0,cr.sz*0.5,cr.sz*0.3,0,0,Math.PI*2);x0.fill();x0.shadowBlur=0;x0.restore();}
  // Bioluminescent spores rising
  if(!SD.spores){SD.spores=Array.from({length:50},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.3,vy:-(0.2+Math.random()*0.6),r:1.5+Math.random()*3,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  for(const sp of SD.spores){sp.x+=sp.vx+Math.sin(sp.ph*0.5)*0.3;sp.y+=sp.vy*(1+SM.energy*0.2);sp.ph+=0.04;if(sp.y<-5){sp.y=h+5;sp.x=Math.random()*w;}const br=Math.sin(sp.ph)*0.4+0.6;x0.beginPath();x0.arc(sp.x,sp.y,sp.r*br,0,Math.PI*2);x0.fillStyle=rgba(pc(sp.ci),br*0.65*(0.4+songProg*0.7));x0.shadowBlur=8*(0.5+songProg);x0.shadowColor=pc(sp.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece — bioluminescent fruit hanging at center
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.015;
    const fruitX=cx+Math.sin(t*0.0006)*w*0.05;
    const fruitY=h*0.32+Math.sin(t*0.0008)*h*0.03;
    const fruitSz=Math.min(w,h)*(0.1+SM.beatPulse*0.04)*(0.4+songProg*0.7);
    // Stem from canopy
    x0.strokeStyle=rgba(pc(2),0.4);x0.lineWidth=3;
    x0.beginPath();x0.moveTo(fruitX,0);x0.bezierCurveTo(fruitX+20,fruitY*0.3,fruitX-15,fruitY*0.6,fruitX,fruitY-fruitSz);x0.stroke();
    // Bio glow halo
    const fg=x0.createRadialGradient(fruitX,fruitY,0,fruitX,fruitY,fruitSz*2.5);
    fg.addColorStop(0,rgba(pc(2),0.18*(1+SM.beatPulse*0.5)));fg.addColorStop(0.5,rgba(pc(0),0.06));fg.addColorStop(1,'transparent');
    x0.fillStyle=fg;x0.fillRect(0,0,w,h);
    x0.shadowBlur=fruitSz*0.9;x0.shadowColor=rgba(pc(2),0.8);
    drawCPMini(x0,THEME.centerpiece,fruitX,fruitY,fruitSz,cpRot);
    x0.shadowBlur=0;
    // Bioluminescent drips
    for(let d=0;d<3;d++){x0.fillStyle=rgba(pc(2),0.3*(1-d*0.3));x0.beginPath();x0.arc(fruitX+(d-1)*fruitSz*0.3,fruitY+fruitSz*(0.6+d*0.25),fruitSz*0.06*(1-d*0.25),0,Math.PI*2);x0.fill();}
  }
}
function drawDiscoDimension(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle='rgba(5,0,15,1)';x0.fillRect(0,0,w,h);
  // Saturday Night Fever floor — bright illuminated grid squares
  if(!SD.discoFloor){
    const cols=14,rows=10;
    SD.discoFloor=[];
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      SD.discoFloor.push({r,c,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,bright:Math.random()});
    }
    SD.discoFloorCols=cols;SD.discoFloorRows=rows;
  }
  // Draw floor in perspective — vanishing point at cy*0.7
  const vp=cy*0.55;
  const cols=SD.discoFloorCols,rows=SD.discoFloorRows;
  const tileW=w/cols;
  // Animate tile colors
  SD.tileZ=(SD.tileZ||0)+0.006*(1+SM.energy*0.3);
  for(const tile of SD.discoFloor){
    tile.ph+=0.025+SM.beatPulse*0.05;
    // Random flash on beat
    if(SM.beatPulse>0.5&&Math.random()<0.08)tile.ci=Math.floor(Math.random()*4);
    const z=((tile.r/rows+SD.tileZ)%1);
    const y1=lerp(vp,h,z);
    const y2=lerp(vp,h,((tile.r+1)/rows+SD.tileZ)%1);
    if(y1>=y2||y1>h||y2<vp)continue;
    const x1=lerp(cx,tile.c*tileW,z);
    const x2=lerp(cx,(tile.c+1)*tileW,z);
    const bright=0.3+Math.abs(Math.sin(tile.ph))*0.7*(1+SM.beatPulse*0.5);
    const c=h2r(pc(tile.ci));
    x0.fillStyle=`rgba(${c.r},${c.g},${c.b},${bright*0.85})`;
    x0.strokeStyle=`rgba(0,0,0,0.6)`;x0.lineWidth=1;
    x0.beginPath();x0.moveTo(x1,y1);x0.lineTo(x2,y1);x0.lineTo(x2,y2);x0.lineTo(x1,y2);x0.closePath();
    x0.fill();x0.stroke();
    // Inner glow on bright tiles
    if(bright>0.7){x0.shadowBlur=12;x0.shadowColor=pc(tile.ci);x0.fillStyle=`rgba(${c.r},${c.g},${c.b},${(bright-0.6)*0.5})`;x0.fill();x0.shadowBlur=0;}
  }
  // Wall mirrors on sides
  for(let side=0;side<2;side++){
    const mx=side===0?0:w*0.85;
    const mg=x0.createLinearGradient(mx,0,mx+(side===0?w*0.15:-w*0.15),0);
    mg.addColorStop(0,rgba(pc(side%4),0.08*(1+SM.beatPulse*0.3)));
    mg.addColorStop(1,'transparent');
    x0.fillStyle=mg;x0.fillRect(mx,0,side===0?w*0.15:-w*0.15,h);
  }
  // Light beams sweeping from disco ball
  if(!SD.beams)SD.beams=Array.from({length:8},(_,i)=>({angle:i/8*Math.PI*2,speed:(Math.random()-0.5)*0.015,ci:i%4}));
  for(const lb of SD.beams){
    lb.angle+=lb.speed*(1+SM.beatPulse*0.5);
    const bx=cx+Math.cos(lb.angle)*w*0.6;
    const by=h*0.12+Math.sin(lb.angle)*h*0.1;
    x0.save();x0.globalAlpha=0.04*(1+SM.beatPulse*0.6);
    const lg=x0.createLinearGradient(cx,h*0.12,bx,by);
    const lc=h2r(pc(lb.ci));
    lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');
    x0.fillStyle=lg;x0.beginPath();x0.moveTo(cx-8,h*0.12);x0.lineTo(cx+8,h*0.12);x0.lineTo(bx+30,by);x0.lineTo(bx-30,by);x0.closePath();x0.fill();x0.restore();
  }
  // Central disco ball IS the centerpiece
  if(THEME.centerpiece){
    cpRot+=0.04*(1+SM.energy*0.3);cpPh+=0.013;
    const ballSz=Math.min(w,h)*(0.12+SM.beatPulse*0.03);
    x0.shadowBlur=ballSz*0.8;x0.shadowColor=pc(1);
    // Mounting wire
    x0.strokeStyle='rgba(180,180,180,0.6)';x0.lineWidth=2;
    x0.beginPath();x0.moveTo(cx,0);x0.lineTo(cx,h*0.12-ballSz);x0.stroke();
    // The disco ball AS the centerpiece, hanging from ceiling
    drawCPMini(x0,THEME.centerpiece,cx,h*0.12,ballSz,cpRot);
    x0.shadowBlur=0;
    // Cast colored reflections onto floor
    for(let ref=0;ref<12;ref++){
      const ra=ref/12*Math.PI*2+cpRot*2;
      const rd=Math.min(w,h)*(0.2+Math.random()*0.3);
      const rx=cx+Math.cos(ra)*rd,ry=h*0.5+Math.sin(ra)*h*0.2;
      x0.fillStyle=rgba(pc(ref%4),0.08*(1+SM.beatPulse*0.5));
      x0.shadowBlur=20;x0.shadowColor=pc(ref%4);
      x0.beginPath();x0.arc(rx,ry,8+SM.beatPulse*6,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
    }
  }
  // Crowd silhouettes at bottom
  if(!SD.crowd)SD.crowd=Array.from({length:20},(_,i)=>({x:i/20*w+Math.random()*50-25,h:h*0.08+Math.random()*h*0.06,ph:Math.random()*Math.PI*2}));
  for(const p of SD.crowd){p.ph+=0.04*(1+SM.beatPulse*0.5);const bounce=Math.abs(Math.sin(p.ph))*p.h*0.3;x0.fillStyle='rgba(0,0,0,0.8)';x0.fillRect(p.x-8,h-p.h+bounce,16,p.h);x0.beginPath();x0.arc(p.x,h-p.h+bounce-8,9,0,Math.PI*2);x0.fill();}
}
function drawAcidTrip(t){
  const w=W(),h=H();
  SD.fracPh=(SD.fracPh||0)+0.015*(1+SM.energy*0.3);SD.colorCyc=(SD.colorCyc||0)+0.008;
  const ci1=Math.floor(SD.colorCyc)%4,ci2=(Math.floor(SD.colorCyc)+1)%4,frac=SD.colorCyc%1;
  const ac=h2r(pc(ci1)),bc=h2r(pc(ci2));
  x0.fillStyle=`rgb(${Math.round(lerp(ac.r,bc.r,frac)*0.07)},${Math.round(lerp(ac.g,bc.g,frac)*0.07)},${Math.round(lerp(ac.b,bc.b,frac)*0.07)})`;x0.fillRect(0,0,w,h);
  if(!SD.warpGrid)return;
  const gw=w/20,gh=h/14;
  for(const gp of SD.warpGrid){gp.ph+=0.02*(1+SM.energy*0.2);const wx=gp.gx*gw+Math.sin(gp.ph+gp.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy=gp.gy*gh+Math.cos(gp.ph+gp.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const gc=Math.floor((gp.gx+gp.gy+SD.colorCyc)%4);x0.fillStyle=rgba(pc(gc),0.5*THEME.sceneIntensity);x0.fillRect(wx-2,wy-2,4,4);}
  for(let gx=0;gx<19;gx++)for(let gy=0;gy<13;gy++){const p1=SD.warpGrid[gy*20+gx],p2=SD.warpGrid[gy*20+gx+1],p3=SD.warpGrid[(gy+1)*20+gx];if(!p1||!p2||!p3)continue;const wx1=p1.gx*gw+Math.sin(p1.ph+p1.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy1=p1.gy*gh+Math.cos(p1.ph+p1.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const wx2=p2.gx*gw+Math.sin(p2.ph+p2.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy2=p2.gy*gh+Math.cos(p2.ph+p2.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const wx3=p3.gx*gw+Math.sin(p3.ph+p3.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy3=p3.gy*gh+Math.cos(p3.ph+p3.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const gc=Math.floor((gx+gy+SD.colorCyc)%4);x0.strokeStyle=rgba(pc(gc),0.2*THEME.sceneIntensity);x0.lineWidth=1;x0.beginPath();x0.moveTo(wx1,wy1);x0.lineTo(wx2,wy2);x0.stroke();x0.beginPath();x0.moveTo(wx1,wy1);x0.lineTo(wx3,wy3);x0.stroke();}
  x0.save();x0.translate(w/2,h/2);for(let seg=0;seg<8;seg++){const r=SD.fracPh+seg/8*Math.PI*2;for(let ri=0;ri<5;ri++){x0.beginPath();x0.arc(0,0,ri*60+SM.beatPulse*20,r,r+Math.PI*2*0.9/8);x0.strokeStyle=rgba(pc((ri+seg)%4),(0.3-ri*0.04)*THEME.sceneIntensity*(1+SM.beatPulse*0.3));x0.lineWidth=3-ri*0.4;x0.stroke();}}x0.restore();
  // Centerpiece melts and warps into grid — appears as distorted ghost in the geometry
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece melts into the warp grid
    const melt=Math.min(1,songProg*1.4);
    const meltX=w/2+Math.sin(SD.fracPh*1.3)*w*0.15*melt;
    const meltY=h/2+Math.cos(SD.fracPh)*h*0.1*melt;
    const ms=Math.min(w,h)*(0.12+SM.beatPulse*0.04);
    cpRot+=0.02*(1+melt);cpPh+=0.013;
    x0.save();
    x0.translate(meltX,meltY);
    x0.scale(1+Math.sin(SD.fracPh*2)*0.25*melt,1+Math.cos(SD.fracPh*1.5)*0.25*melt);
    x0.globalAlpha=(0.2+SM.beatPulse*0.12)*(1+melt*0.4);
    drawCP(x0,THEME.centerpiece,ms,cpPh*100);
    x0.globalAlpha=1;x0.restore();
  }
}
function drawSpaceStation(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const earthR=Math.min(w,h)*0.38;const eg=x0.createRadialGradient(w*0.12,h*0.88,0,w*0.12,h*0.88,earthR);const ec=h2r(pc(2));eg.addColorStop(0,`rgba(${ec.r},${ec.g},${ec.b},0.7)`);eg.addColorStop(0.7,'transparent');x0.fillStyle=eg;x0.fillRect(0,h*0.4,earthR*2,h);
  // Station hull panels - appear and glow as song progresses
  const hullAlpha=songProg*0.2+SM.beatPulse*0.05;
  x0.strokeStyle=rgba(pc(0),hullAlpha);x0.lineWidth=1;
  for(let px2=0;px2<w;px2+=80)for(let py2=0;py2<h;py2+=60){x0.strokeRect(px2,py2,80,60);}
  // Alert flicker as song peaks
  if(songProg>0.6&&SM.beatPulse>0.4){x0.fillStyle=rgba(pc(2),0.04*SM.beatPulse);x0.fillRect(0,0,w,h);}
  if(!SD.stars)return;
  for(const s of SD.stars){s.z-=0.0006*THEME.sceneSpeed*(1+beatFX.speedBoost*0.5);if(s.z<0.01){s.z=1;s.x=(Math.random()-0.5)*2;s.y=(Math.random()-0.5)*2;s.trail=[];}const px=cx+(s.x/s.z)*cx,py=cy+(s.y/s.z)*cy;if(px<-20||px>w+20||py<-20||py>h+20)continue;const sz=(1-s.z)*3+0.3;x0.beginPath();x0.arc(px,py,sz,0,Math.PI*2);x0.fillStyle=rgba(pc(s.ci),(1-s.z)*0.8);x0.fill();}
  if(SD.debris)for(const d of SD.debris){d.x+=d.vx*(1+songProg*0.3);d.y+=d.vy;d.rot+=d.rotS;if(d.x<-60)d.x=w+60;if(d.x>w+60)d.x=-60;if(d.y<-60)d.y=h+60;if(d.y>h+60)d.y=-60;x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);x0.fillStyle=rgba(pc(d.ci),0.4+songProg*0.2);x0.shadowBlur=songProg>0.5?8:0;x0.shadowColor=pc(d.ci);x0.fillRect(-d.sz/2,-d.sz*0.2,d.sz,d.sz*0.4);x0.shadowBlur=0;x0.restore();}
  // Hull breach effect - centerpiece as debris field symbol
  if(THEME.centerpiece&&SD.hullBreachActive){
    // INTEGRATED: centerpiece IS the station — visible through viewport
    const bs=Math.min(w,h)*(0.2+SM.beatPulse*0.04);
    cpRot+=0.01; cpPh+=0.013;
    x0.globalAlpha=0.2+SM.beatPulse*0.12+songProg*0.15;
    drawCPMini(x0,THEME.centerpiece,cx,cy*0.7,bs,cpRot);
    x0.globalAlpha=1;
  }
}
// Track hull breach state
if(typeof SD.hullBreachActive==='undefined'){}
function drawNeonCathedral(t){
  const w=W(),h=H(),cx=w/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Ray intensity grows over song like sunlight through stained glass increasing
  const holyLight=0.4+songProg*0.8;
  if(SD.rays)for(const lr of SD.rays){lr.ph+=0.003;const lx=lr.x+Math.sin(lr.ph)*30;x0.save();x0.globalAlpha=lr.alpha*(0.6+Math.sin(lr.ph)*0.4)*THEME.sceneIntensity*(1+SM.beatPulse*0.4)*holyLight;const lg=x0.createLinearGradient(lx,0,lx,h*0.7);const lc=h2r(pc(Math.floor(lr.ph*0.5)%4));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx-lr.width*0.3,0);x0.lineTo(lx+lr.width*0.7,0);x0.lineTo(lx+lr.width*2,h*0.7);x0.lineTo(lx-lr.width*1.5,h*0.7);x0.closePath();x0.fill();x0.restore();}
  if(SD.arches)for(const arch of SD.arches){const depth=1-arch.depth,archW=w*(arch.width),archH=h*(0.5+arch.depth*0.4);x0.strokeStyle=rgba(pc(arch.ci),(0.1+depth*0.5)*THEME.sceneIntensity*(1+SM.beatPulse*0.2)*holyLight);x0.lineWidth=1+depth*3;x0.shadowBlur=15*depth*holyLight;x0.shadowColor=pc(arch.ci);x0.beginPath();x0.moveTo(cx-archW*0.5,h);x0.lineTo(cx-archW*0.5,h-archH*0.4);x0.bezierCurveTo(cx-archW*0.5,h-archH,cx-archW*0.05,h-archH,cx,h-archH);x0.stroke();x0.beginPath();x0.moveTo(cx+archW*0.5,h);x0.lineTo(cx+archW*0.5,h-archH*0.4);x0.bezierCurveTo(cx+archW*0.5,h-archH,cx+archW*0.05,h-archH,cx,h-archH);x0.stroke();x0.shadowBlur=0;}
  if(SD.motes)for(const p of SD.motes){p.y+=p.vy*(0.5+holyLight*0.5);p.ph+=0.05;if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}const br=Math.sin(p.ph)*0.4+0.6;x0.beginPath();x0.arc(p.x,p.y,p.r,0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),br*0.6*THEME.sceneIntensity*holyLight);x0.shadowBlur=6;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece as rose window at top center — mandala-like radiating symbol
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece as rose window at apex
    const rw=Math.min(w,h)*(0.1+SM.beatPulse*0.035)*(0.5+holyLight*0.7);
    cpRot+=0.004;cpPh+=0.013;
    x0.globalAlpha=0.25+holyLight*0.45+SM.beatPulse*0.15;
    drawCPMini(x0,THEME.centerpiece,cx,h*0.1,rw,cpRot);
    x0.globalAlpha=1;
  }
}
function mkTetPiece(w,h){
  const shapes=[[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[2,0],[1,1]],[[0,0],[1,0],[2,0],[2,1]],[[0,1],[1,1],[1,0],[2,0]]];
  const s=shapes[Math.floor(Math.random()*shapes.length)];
  return{x:Math.random()*w*0.8+w*0.1,y:-50,vy:0.5+Math.random()*0.8,rot:0,rotS:(Math.random()-0.5)*0.01,blocks:s,ci:Math.floor(Math.random()*4)};
}

function drawGalaShip(ctx,x,y,ci){
  ctx.save();ctx.translate(x,y);
  ctx.fillStyle=rgba(pc(ci),0.85);ctx.shadowBlur=10;ctx.shadowColor=pc(ci);
  ctx.beginPath();ctx.moveTo(0,-14);ctx.lineTo(10,8);ctx.lineTo(5,5);ctx.lineTo(0,10);ctx.lineTo(-5,5);ctx.lineTo(-10,8);ctx.closePath();ctx.fill();
  ctx.fillStyle=rgba(pc((ci+1)%4),0.7);ctx.beginPath();ctx.arc(0,-2,5,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;ctx.restore();
}

function drawClassicArcade(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  // CRT background — dark with scanlines
  x0.fillStyle='rgba(0,4,12,1)';x0.fillRect(0,0,w,h);
  // CRT scanlines
  x0.fillStyle='rgba(0,0,0,0.25)';
  for(let y2=0;y2<h;y2+=3)x0.fillRect(0,y2,w,1);
  // Score bar
  x0.fillStyle=rgba(pc(0),0.9);x0.font='bold 18px monospace';x0.textAlign='left';
  x0.fillText(`SCORE: ${Math.floor(songProg*99999).toString().padStart(6,'0')}`,20,30);
  x0.textAlign='right';x0.fillText(`LIVES: ♥♥♥`,w-20,30);x0.textAlign='left';
  x0.fillStyle=rgba(pc(1),0.5);x0.fillRect(0,38,w,2);
  // Maze walls (Pac-Man style blue neon walls)
  if(!SD.mazeLines){
    SD.mazeLines=[];
    const segs=[[0.1,0.15,0.4,0.15],[0.6,0.15,0.9,0.15],[0.1,0.45,0.35,0.45],[0.65,0.45,0.9,0.45],[0.1,0.7,0.45,0.7],[0.55,0.7,0.9,0.7],[0.1,0.15,0.1,0.45],[0.9,0.15,0.9,0.45],[0.4,0.55,0.6,0.55]];
    for(const[x1,y1,x2,y2]of segs)SD.mazeLines.push({x1:x1*w,y1:y1*h+50,x2:x2*w,y2:y2*h+50,ci:2});
  }
  for(const ml of SD.mazeLines){x0.beginPath();x0.moveTo(ml.x1,ml.y1);x0.lineTo(ml.x2,ml.y2);x0.strokeStyle=rgba(pc(2),0.5);x0.lineWidth=3;x0.shadowBlur=8;x0.shadowColor=pc(2);x0.stroke();x0.shadowBlur=0;}
  // Pac-Man — chomps across screen
  if(!SD.pacman)SD.pacman={x:w*0.15,y:h*0.35,dir:1,mouthA:0,mouthS:0.08};
  const pm=SD.pacman;
  pm.x+=1.2*(1+SM.energy*0.4)*pm.dir*(1+beatFX.speedBoost*0.3);
  pm.mouthA+=pm.mouthS*(1+SM.energy*0.3);
  if(pm.mouthA>0.35||pm.mouthA<0)pm.mouthS*=-1;
  if(pm.x>w+40){pm.x=-40;pm.dir=1;pm.y=h*(0.3+Math.random()*0.35);}
  if(pm.x<-40){pm.x=w+40;pm.dir=-1;}
  const mouth=Math.abs(Math.sin(pm.mouthA))*0.45;
  x0.fillStyle='rgba(255,220,0,0.95)';x0.shadowBlur=15;x0.shadowColor='rgba(255,200,0,0.8)';
  x0.beginPath();x0.moveTo(pm.x,pm.y);x0.arc(pm.x,pm.y,22,mouth*(pm.dir>0?1:-1),(Math.PI*2-mouth)*(pm.dir>0?1:-1));x0.closePath();x0.fill();x0.shadowBlur=0;
  // Dots for Pac-Man to eat
  if(!SD.dots){SD.dots=Array.from({length:20},()=>({x:Math.random()*w*0.8+w*0.1,y:h*(0.15+Math.random()*0.6)+50,eaten:false,ph:Math.random()*Math.PI*2}));}
  for(const d of SD.dots){if(d.eaten)continue;d.ph+=0.04;const dist=Math.hypot(pm.x-d.x,pm.y-d.y);if(dist<26){d.eaten=true;continue;}x0.fillStyle=rgba(pc(3),0.9);x0.beginPath();x0.arc(d.x,d.y,5,0,Math.PI*2);x0.fill();}
  if(SD.dots.every(d=>d.eaten))SD.dots.forEach(d=>{d.eaten=false;});
  // Tetris pieces falling
  if(!SD.tetPieces){SD.tetPieces=Array.from({length:5},()=>mkTetPiece(w,h));}
  for(const tp of SD.tetPieces){
    tp.y+=tp.vy*(1+SM.energy*0.3);tp.rot+=tp.rotS;
    if(tp.y>h+100)Object.assign(tp,mkTetPiece(w,h));
    x0.save();x0.translate(tp.x,tp.y);x0.rotate(tp.rot);x0.fillStyle=rgba(pc(tp.ci),0.7);x0.strokeStyle=rgba(pc(tp.ci),0.9);x0.lineWidth=2;
    for(const[bx,by]of tp.blocks){x0.fillRect(bx*20-2,by*20-2,18,18);x0.strokeRect(bx*20-2,by*20-2,18,18);}
    x0.restore();
  }
  // Galaga ships flying in formation
  if(!SD.galaShips){SD.galaShips=Array.from({length:8},(_,i)=>({x:w*0.1+i%4*(w*0.2),y:h*(0.1+Math.floor(i/4)*0.1),ph:i*0.5,ci:i%4}));}
  for(const gs of SD.galaShips){
    gs.ph+=0.015*(1+SM.beatPulse*0.3);
    const sx=gs.x+Math.sin(gs.ph)*30,sy=gs.y+Math.sin(gs.ph*0.5)*10;
    drawGalaShip(x0,sx,sy,gs.ci);
  }
  // Boss in surprise mode
  if(SD.bossActive){
    SD.bossX=(SD.bossX||w*0.7);SD.bossY=(SD.bossY||h*0.3);
    SD.bossX+=Math.sin(t*0.002)*1.5;SD.bossY+=Math.cos(t*0.0015)*1;
    x0.shadowBlur=30;x0.shadowColor=pc(0);
    x0.fillStyle=rgba(pc(0),0.9);
    x0.beginPath();x0.ellipse(SD.bossX,SD.bossY,80,55,0,0,Math.PI*2);x0.fill();
    // Boss eyes
    x0.fillStyle='rgba(255,0,0,0.95)';x0.shadowBlur=15;x0.shadowColor='red';
    for(const[ex,ey]of[[-30,-15],[30,-15]]){x0.beginPath();x0.arc(SD.bossX+ex,SD.bossY+ey,12*(1+SM.beatPulse*0.3),0,Math.PI*2);x0.fill();}
    x0.shadowBlur=0;
    // Shoot at player
    if(!SD.bossShots)SD.bossShots=[];
    if(Math.random()<0.03*(1+SM.energy)){SD.bossShots.push({x:SD.bossX,y:SD.bossY+55,vy:3+SM.energy*2,ci:0});}
    for(let i=SD.bossShots.length-1;i>=0;i--){const bs=SD.bossShots[i];bs.y+=bs.vy;if(bs.y>h){SD.bossShots.splice(i,1);continue;}x0.fillStyle=rgba(pc(bs.ci),0.9);x0.fillRect(bs.x-3,bs.y,6,12);}
  }
  // Centerpiece IS the player ship at bottom
  if(THEME.centerpiece){
    cpPh+=0.013;
    // Ship moves side to side
    const shipX=cx+Math.sin(t*0.0008)*w*0.25;
    const shipY=h*0.82;
    const shipSz=Math.min(w,h)*0.06*(1+SM.beatPulse*0.15);
    // Player ship exhaust
    x0.fillStyle=rgba(pc(1),0.6+Math.sin(t*0.01)*0.3);
    x0.shadowBlur=15;x0.shadowColor=pc(1);
    x0.beginPath();x0.ellipse(shipX,shipY+shipSz*0.8,shipSz*0.15,shipSz*0.4*(0.5+Math.random()*0.5),0,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;
    drawCPMini(x0,THEME.centerpiece,shipX,shipY,shipSz,0);
    // Player bullets
    if(!SD.playerBullets)SD.playerBullets=[];
    if(Math.random()<0.06*(1+SM.energy)){SD.playerBullets.push({x:shipX,y:shipY-shipSz,vy:-8,ci:1});}
    for(let i=SD.playerBullets.length-1;i>=0;i--){const pb=SD.playerBullets[i];pb.y+=pb.vy;if(pb.y<0){SD.playerBullets.splice(i,1);continue;}x0.fillStyle=rgba(pc(pb.ci),0.9);x0.shadowBlur=8;x0.shadowColor=pc(pb.ci);x0.fillRect(pb.x-2,pb.y,4,12);x0.shadowBlur=0;}
  }
  // CRT vignette
  const cvg=x0.createRadialGradient(cx,cy,h*0.2,cx,cy,h*0.75);cvg.addColorStop(0,'transparent');cvg.addColorStop(1,'rgba(0,0,0,0.65)');x0.fillStyle=cvg;x0.fillRect(0,0,w,h);
  // Scanline sweep
  SD.scanLine=(SD.scanLine||0)+3;SD.scanLine%=h;
  x0.fillStyle='rgba(255,255,255,0.012)';x0.fillRect(0,SD.scanLine,w,2);
}
function drawElectricForest(t){
  const w=W(),h=H();
  const fantasy=Math.min(1,songProg*1.5);
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const gg=x0.createLinearGradient(0,h*0.75,0,h);gg.addColorStop(0,rgba(pc(2),0.2*(1+SM.beatPulse*0.3)));gg.addColorStop(1,'transparent');x0.fillStyle=gg;x0.fillRect(0,h*0.75,w,h*0.25);
  if(SD.trees)for(const tr of SD.trees){tr.ph+=0.008;const glm=tr.glowMult||1;x0.save();x0.translate(tr.x,h*0.78);x0.shadowBlur=20*(fantasy+0.3)*glm;x0.shadowColor=pc(tr.ci);x0.strokeStyle=rgba(pc(tr.ci),0.6+fantasy*0.3);function drawTree(x2,y2,len,angle,depth){if(depth<1||len<8)return;const nx=x2+Math.cos(angle)*len,ny=y2-len;x0.beginPath();x0.moveTo(x2,y2);x0.lineTo(nx,ny);x0.lineWidth=depth*1.5;x0.stroke();drawTree(nx,ny,len*0.65,angle-0.45+Math.sin(tr.ph)*0.1,depth-1);drawTree(nx,ny,len*0.65,angle+0.45+Math.sin(tr.ph+1)*0.1,depth-1);}drawTree(0,0,tr.sz*0.4,0,5);x0.restore();if(tr.glowMult>1)tr.glowMult*=0.99;}
  for(let i=0;SD.trees&&i<SD.trees.length-1;i++){const t1=SD.trees[i],t2=SD.trees[i+1];for(let j=0;j<8;j++){const jx=lerp(t1.x,t2.x,j/7),jy=h*0.5+Math.sin(j/7*Math.PI)*40;x0.beginPath();x0.arc(jx,jy,2+SM.beatPulse*2,0,Math.PI*2);x0.fillStyle=rgba(pc((i+j)%4),0.7+SM.beatPulse*0.3);x0.shadowBlur=8;x0.shadowColor=pc((i+j)%4);x0.fill();x0.shadowBlur=0;}}
  if(fantasy>0.3&&SD.mushrooms)for(const m of SD.mushrooms){m.ph+=0.01;x0.save();x0.translate(m.x,h*0.78);x0.shadowBlur=20*fantasy;x0.shadowColor=pc(m.ci);x0.fillStyle=rgba(pc(m.ci),fantasy*0.8);x0.beginPath();x0.ellipse(0,-m.sz*0.6,m.sz*0.5,m.sz*0.35,0,0,Math.PI*2);x0.fill();x0.fillStyle=rgba(pc((m.ci+1)%4),fantasy*0.6);x0.fillRect(-m.sz*0.1,-m.sz*0.25,m.sz*0.2,m.sz*0.3);x0.restore();}
  if(SD.fairies)for(const f of SD.fairies){f.x+=f.vx+Math.sin(t*0.001+f.ph)*0.5;f.y+=f.vy+Math.cos(t*0.0008+f.ph)*0.5;f.ph+=0.06;if(f.x<0||f.x>w)f.vx*=-1;if(f.y<0||f.y>h)f.vy*=-1;const br=Math.sin(f.ph)*0.4+0.6;x0.beginPath();x0.arc(f.x,f.y,f.r*(0.6+br*0.6),0,Math.PI*2);x0.fillStyle=rgba(pc(f.ci),br*(0.4+fantasy*0.5));x0.shadowBlur=12*fantasy;x0.shadowColor=pc(f.ci);x0.fill();x0.shadowBlur=0;}
}
function drawOmniaNightclub(t){
  const w=W(),h=H(),cx=w/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  for(let tier=0;tier<3;tier++){x0.fillStyle=rgba(pc(tier),0.05);x0.fillRect(0,h*0.5+tier*h*0.12,w,h*0.12);x0.strokeStyle=rgba(pc(tier),0.12);x0.lineWidth=1;x0.beginPath();x0.moveTo(0,h*0.5+tier*h*0.12);x0.lineTo(w,h*0.5+tier*h*0.12);x0.stroke();}
  if(SD.chandelierY==null)SD.chandelierY=h*0.02;
  // Chandelier slowly descends over the song — massive, fills top 40%
  const targetChanY=h*(0.05+songProg*0.32);
  SD.chandelierY+=(targetChanY-SD.chandelierY)*0.002;
  const chanSize=Math.min(w,h)*(0.22+SM.beatPulse*0.04); // MASSIVE
  SD.chandelierRot=(SD.chandelierRot||0)+0.008*(1+SM.beatPulse*0.5);
  // Chain from ceiling
  x0.beginPath();x0.moveTo(cx,0);x0.lineTo(cx,SD.chandelierY-chanSize*0.5);x0.strokeStyle='rgba(255,255,255,0.3)';x0.lineWidth=3;x0.stroke();
  // Wide light beams from chandelier
  if(SD.beams)for(const b of SD.beams){b.ph+=0.006*(1+SM.beatPulse*0.4);const bx=cx+Math.cos(b.angle+b.ph*0.3)*chanSize*0.4;const endX=cx+Math.cos(b.angle+b.ph)*b.len*1.3;const endY=SD.chandelierY+b.len*1.1;const bg=x0.createLinearGradient(bx,SD.chandelierY,endX,endY);const bc=h2r(pc(b.ci));bg.addColorStop(0,`rgba(${bc.r},${bc.g},${bc.b},${0.1*(1+SM.beatPulse*0.5)})`);bg.addColorStop(1,'transparent');x0.strokeStyle=bg;x0.lineWidth=6;x0.beginPath();x0.moveTo(bx,SD.chandelierY);x0.lineTo(endX,endY);x0.stroke();}
  // Chandelier sphere - BIG
  x0.save();x0.translate(cx,SD.chandelierY);x0.rotate(SD.chandelierRot);x0.shadowBlur=60*(1+SM.beatPulse*0.5);x0.shadowColor=pc(0);
  for(let r=0;r<12;r++)for(let c=0;c<20;c++){const lat=(r/12-0.5)*Math.PI,lon=c/20*Math.PI*2;const tx=Math.cos(lat)*Math.cos(lon)*chanSize,ty=Math.sin(lat)*chanSize,tz=Math.cos(lat)*Math.sin(lon);if(tz<0.1)continue;const tsz=(8+tz*6)*(1+SM.beatPulse*0.15);x0.fillStyle=rgba(pc((r+c)%4),(0.4+tz*0.6)*0.9*(0.5+tz*0.5)*(1+SM.beatPulse*0.2));x0.fillRect(tx-tsz/2,ty-tsz/2,tsz,tsz);}x0.shadowBlur=0;x0.restore();
  // INTEGRATED: centerpiece symbols as 8 chandelier ornaments on x0
  if(THEME.centerpiece){
    cpRot+=0.02; cpPh+=0.013;
    const os=Math.min(w,h)*(0.028+SM.beatPulse*0.01);
    for(let orn=0;orn<8;orn++){
      const oa=orn/8*Math.PI*2+SD.chandelierRot*2;
      const orR=chanSize*(0.75+Math.sin(oa*2)*0.1);
      const ox=cx+Math.cos(oa)*orR;
      const oy=SD.chandelierY+chanSize*0.38+Math.sin(oa*1.3)*chanSize*0.18;
      x0.globalAlpha=0.75+SM.beatPulse*0.2;
      drawCPMini(x0,THEME.centerpiece,ox,oy,os,cpRot+orn*0.8);
    }
    x0.globalAlpha=1;
  }
  if(SD.crowdPeople)for(const p of SD.crowdPeople){p.ph+=0.04*(1+SM.beatPulse*0.3);const swing=Math.sin(p.ph)*p.sz*0.3*(1+SM.beatPulse*0.4);x0.fillStyle=rgba(pc(p.ci),0.35*(1+SM.beatPulse*0.1));x0.fillRect(p.x-p.sz*0.15,p.y-p.sz*0.8+swing,p.sz*0.3,p.sz*0.8);x0.beginPath();x0.arc(p.x,p.y-p.sz*0.88+swing,p.sz*0.18,0,Math.PI*2);x0.fill();}
}
function drawPirateShip(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(SD.stars)for(const s of SD.stars){x0.fillStyle=`rgba(255,255,255,${s.br*0.8})`;x0.fillRect(s.x,s.y,1.5,1.5);}
  const hor=h*0.6;
  if(SD.waves)for(let wv=0;wv<5;wv++){const wave=SD.waves[wv];wave.ph+=wave.speed*(1+SM.energy*0.3);x0.beginPath();for(let px=0;px<=w;px+=4){const py=hor+wv*25+Math.sin(px*0.01+wave.ph)*wave.amp*(1+SM.beatPulse*0.2);px===0?x0.moveTo(px,py):x0.lineTo(px,py);}x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();const wg=x0.createLinearGradient(0,hor,0,h);const wc=h2r(pc(wv%4));wg.addColorStop(0,`rgba(${wc.r},${wc.g},${wc.b},${0.3*(1+SM.beatPulse*0.2)})`);wg.addColorStop(1,'rgba(0,20,60,0.9)');x0.fillStyle=wg;x0.fill();}
  x0.fillStyle='rgba(20,10,5,0.95)';x0.beginPath();x0.moveTo(w*0.1,hor*0.98);x0.lineTo(w*0.9,hor*0.98);x0.lineTo(w*0.85,h*0.55);x0.lineTo(w*0.15,h*0.55);x0.closePath();x0.fill();
  x0.strokeStyle='rgba(40,20,5,0.9)';x0.lineWidth=8;x0.beginPath();x0.moveTo(w*0.35,h*0.55);x0.lineTo(w*0.35,h*0.05);x0.stroke();x0.beginPath();x0.moveTo(w*0.65,h*0.55);x0.lineTo(w*0.65,h*0.12);x0.stroke();
  x0.fillStyle=rgba(pc(1),0.3+SM.beatPulse*0.1);x0.beginPath();x0.moveTo(w*0.35,h*0.08);x0.lineTo(w*0.52,h*0.18+Math.sin(t*0.001)*10);x0.lineTo(w*0.35,h*0.38);x0.closePath();x0.fill();x0.beginPath();x0.moveTo(w*0.65,h*0.15);x0.lineTo(w*0.82,h*0.25+Math.sin(t*0.001)*10);x0.lineTo(w*0.65,h*0.45);x0.closePath();x0.fill();
  // Centerpiece emblem on main sail
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece emblem on main sail
    const sailCX=w*0.43,sailCY=h*0.23+Math.sin(t*0.001)*5;
    const emblemSz=Math.min(w,h)*(0.07+SM.beatPulse*0.012);
    cpRot+=0.004;cpPh+=0.013;
    x0.globalAlpha=0.65+SM.beatPulse*0.2;
    drawCPMini(x0,THEME.centerpiece,sailCX,sailCY,emblemSz,cpRot);
    x0.globalAlpha=1;
  }
  if(SD.seagulls)for(const sg of SD.seagulls){sg.x+=sg.vx;sg.ph+=0.08;if(sg.x>w+20)sg.x=-20;x0.beginPath();x0.moveTo(sg.x-10,sg.y+Math.sin(sg.ph)*3);x0.quadraticCurveTo(sg.x,sg.y-5,sg.x+10,sg.y+Math.sin(sg.ph)*3);x0.strokeStyle='rgba(255,255,255,0.5)';x0.lineWidth=1.5;x0.stroke();}
  if(SD.cannonballs)for(let i=SD.cannonballs.length-1;i>=0;i--){const cb=SD.cannonballs[i];cb.x+=cb.vx;cb.y+=cb.vy;cb.vy+=0.3;cb.life-=0.02;if(cb.life<=0||cb.y>h){SD.cannonballs.splice(i,1);continue;}x0.beginPath();x0.arc(cb.x,cb.y,cb.r,0,Math.PI*2);x0.fillStyle=rgba(pc(0),cb.life*0.9);x0.shadowBlur=15;x0.shadowColor=pc(0);x0.fill();x0.shadowBlur=0;}
}
function drawJunkyard(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const ig=x0.createLinearGradient(0,0,0,h*0.5);ig.addColorStop(0,rgba(pc(1),0.1));ig.addColorStop(1,'transparent');x0.fillStyle=ig;x0.fillRect(0,0,w,h*0.5);
  x0.fillStyle='rgba(20,15,10,0.9)';x0.fillRect(0,h*0.7,w,h*0.3);
  if(SD.carStacks)for(const cs of SD.carStacks){const cx2=cs.x*w;for(let c=0;c<cs.cars;c++){const cy2=h*0.7-(c+1)*h*0.08;const cw=w*0.08,ch2=h*0.07;x0.fillStyle=rgba(pc(cs.ci),0.3+c*0.05);x0.fillRect(cx2-cw/2,cy2,cw,ch2);x0.strokeStyle=rgba(pc(cs.ci),0.5);x0.lineWidth=1;x0.strokeRect(cx2-cw/2,cy2,cw,ch2);}}
  if(SD.arms)for(const arm of SD.arms){arm.angle+=(arm.targetAngle-arm.angle)*arm.speed;if(Math.abs(arm.angle-arm.targetAngle)<0.05)arm.targetAngle=-Math.PI*0.3-Math.random()*0.5;x0.save();x0.translate(arm.x,arm.baseY);x0.strokeStyle=rgba(pc(arm.ci),0.7);x0.lineWidth=8;x0.lineCap='round';const ax=Math.cos(arm.angle)*arm.sz,ay=Math.sin(arm.angle)*arm.sz;x0.beginPath();x0.moveTo(0,0);x0.lineTo(ax,ay);x0.stroke();x0.lineCap='butt';x0.shadowBlur=15;x0.shadowColor=pc(arm.ci);x0.fillStyle=rgba(pc(arm.ci),0.8);x0.beginPath();x0.arc(ax,ay,8,0,Math.PI*2);x0.fill();x0.shadowBlur=0;x0.restore();}
  if(SD.sparks)for(let i=SD.sparks.length-1;i>=0;i--){const sp=SD.sparks[i];sp.x+=sp.vx;sp.y+=sp.vy;sp.vy+=0.4;sp.life-=0.025;if(sp.life<=0){SD.sparks.splice(i,1);continue;}x0.beginPath();x0.arc(sp.x,sp.y,2*sp.life,0,Math.PI*2);x0.fillStyle=rgba(pc(sp.ci),sp.life*0.9);x0.shadowBlur=6;x0.shadowColor=pc(sp.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece as wrecking ball on crane arm - swings and smashes
  if(THEME.centerpiece){
    const armX=W()*0.6,armY=H()*0.1;
    const swingAng=Math.sin(t*0.0012*(1+songProg))*0.9*(1+SM.beatPulse*0.3);
    const chainLen=H()*(0.25+songProg*0.15);
    const ballX=armX+Math.sin(swingAng)*chainLen;
    const ballY=armY+Math.cos(swingAng)*chainLen;
    const ballR=Math.min(W(),H())*(0.06+SM.beatPulse*0.025);
    // INTEGRATED: chain from crane arm
    x0.strokeStyle='rgba(180,160,100,0.7)';x0.lineWidth=5;
    x0.setLineDash([8,5]);x0.beginPath();x0.moveTo(armX,armY);x0.lineTo(ballX,ballY);x0.stroke();x0.setLineDash([]);
    // Wrecking ball IS the centerpiece
    cpRot+=0.03; cpPh+=0.013;
    x0.globalAlpha=0.92+SM.beatPulse*0.08;
    drawCPMini(x0,THEME.centerpiece,ballX,ballY,ballR,cpRot);
    x0.globalAlpha=1;
    // Smash effect - when ball swings to extreme, shoot sparks
    if(Math.abs(swingAng)>0.75&&SD.sparks&&Math.random()<0.3){SD.sparks.push({x:ballX,y:ballY,vx:(Math.random()-0.5)*12,vy:-(Math.random()*6+2),life:0.8,ci:Math.floor(Math.random()*4)});}
  }
}
function drawSuperhero(t){
  const w=W(),h=H(),cx=w/2;
  // Neon Gotham — dark rainy city night
  x0.fillStyle='rgba(2,4,18,1)';x0.fillRect(0,0,w,h);
  // Rain
  if(!SD.rainDrops){SD.rainDrops=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,vy:8+Math.random()*6,len:8+Math.random()*15,alpha:0.1+Math.random()*0.2}));}
  x0.strokeStyle='rgba(100,140,200,0.2)';x0.lineWidth=0.8;
  for(const rd of SD.rainDrops){rd.y+=rd.vy*(1+SM.energy*0.3);if(rd.y>h){rd.y=-20;rd.x=Math.random()*w;}x0.beginPath();x0.moveTo(rd.x,rd.y);x0.lineTo(rd.x-rd.vy*0.15,rd.y+rd.len);x0.stroke();}
  // City buildings — neon-lit Gotham
  if(!SD.cityBuildings){
    SD.cityBuildings=Array.from({length:18},(_,i)=>{
      const bw=30+Math.random()*60;
      return{x:i*(w/18),w:bw,h:h*(0.35+Math.random()*0.45),ci:i%4,windows:Array.from({length:Math.floor(Math.random()*20+10)},()=>({x:Math.random()*bw*0.7+bw*0.1,y:Math.random()*h*0.4+20,on:Math.random()>0.35})),neon:Math.random()>0.5};
    });
  }
  for(const b of SD.cityBuildings){
    const bh=h-b.h;
    x0.fillStyle='rgba(5,8,25,0.97)';x0.fillRect(b.x,bh,b.w,b.h);
    // Neon signs on buildings
    if(b.neon){x0.strokeStyle=rgba(pc(b.ci),0.6+SM.beatPulse*0.2);x0.lineWidth=2;x0.shadowBlur=8;x0.shadowColor=pc(b.ci);x0.strokeRect(b.x+2,bh+5,b.w-4,15);x0.shadowBlur=0;}
    // Windows
    for(const wn of b.windows){if(!wn.on)continue;if(SM.beatPulse>0.4&&Math.random()<0.02)wn.on=!wn.on;x0.fillStyle=rgba(pc(b.ci),0.45+SM.beatPulse*0.15);x0.fillRect(b.x+wn.x,bh+wn.y,7,10);}
    // Building outline
    x0.strokeStyle=rgba(pc(b.ci),0.1);x0.lineWidth=1;x0.strokeRect(b.x,bh,b.w,b.h);
  }
  // Street reflections
  x0.fillStyle='rgba(0,0,0,0.6)';x0.fillRect(0,h*0.88,w,h*0.12);
  for(const b of SD.cityBuildings){
    for(const wn of b.windows){if(!wn.on)continue;const c=h2r(pc(b.ci));x0.fillStyle=`rgba(${c.r},${c.g},${c.b},0.1)`;x0.fillRect(b.x+wn.x,h*0.88,7,h*0.12);}
  }
  // Bat signal — sweeps across sky, projects centerpiece silhouette
  if(!SD.batSignal){SD.batSignal={angle:Math.PI*0.4,rotDir:1,speed:0.004,x:w*0.15,y:h*0.92};}
  const bs=SD.batSignal;
  bs.angle+=bs.rotDir*bs.speed*(1+SM.beatPulse*0.5);
  if(bs.angle>Math.PI*0.85||bs.angle<Math.PI*0.15)bs.rotDir*=-1;
  // Beam
  const beamX=bs.x+Math.cos(bs.angle)*w*1.2;
  const beamY=bs.y+Math.sin(bs.angle-Math.PI)*h*0.8;
  x0.save();x0.globalAlpha=0.06+SM.beatPulse*0.04;
  const bg=x0.createLinearGradient(bs.x,bs.y,beamX,beamY);bg.addColorStop(0,'rgba(220,220,255,0.8)');bg.addColorStop(1,'transparent');
  x0.fillStyle=bg;x0.beginPath();x0.moveTo(bs.x-10,bs.y);x0.lineTo(bs.x+10,bs.y);x0.lineTo(beamX+40,beamY);x0.lineTo(beamX-40,beamY);x0.closePath();x0.fill();x0.restore();
  // Cloud at beam end — centerpiece silhouette projected IN the cloud
  const cloudX=beamX,cloudY=Math.max(h*0.05,Math.min(h*0.45,beamY));
  // Cloud puff
  x0.fillStyle='rgba(180,190,220,0.12)';x0.shadowBlur=30;x0.shadowColor='rgba(200,210,255,0.3)';
  for(let cl=0;cl<5;cl++){x0.beginPath();x0.arc(cloudX+Math.cos(cl/5*Math.PI*2)*35,cloudY+Math.sin(cl/5*Math.PI*2)*15,25,0,Math.PI*2);x0.fill();}
  x0.shadowBlur=0;
  // Centerpiece silhouette in the signal
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.008;
    const sigSz=Math.min(w,h)*0.1*(1+SM.beatPulse*0.15);
    x0.globalAlpha=0.55+SM.beatPulse*0.25;
    x0.shadowBlur=sigSz*0.8;x0.shadowColor='rgba(200,220,255,0.8)';
    // Draw in white/blue tint to look like signal projection
    x0.filter='brightness(3) saturate(0) sepia(0.2) hue-rotate(200deg)';
    drawCPMini(x0,THEME.centerpiece,cloudX,cloudY,sigSz,cpRot);
    x0.filter='none';x0.shadowBlur=0;x0.globalAlpha=1;
  }
  // Projector light source on rooftop
  x0.fillStyle='rgba(220,230,255,0.8)';x0.shadowBlur=20;x0.shadowColor='rgba(200,220,255,1)';
  x0.beginPath();x0.arc(bs.x,bs.y,8,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
}
function drawDayOfDead(t){
  const w=W(),h=H(),cx=w/2;
  // Rich dark purple/indigo background — more intense
  const bg=x0.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,'rgba(8,2,18,1)');bg.addColorStop(0.5,rgba(pc(0),0.15));bg.addColorStop(1,'rgba(40,0,20,0.8)');
  x0.fillStyle=bg;x0.fillRect(0,0,w,h);
  // Marigold petals raining down
  if(!SD.petals){SD.petals=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.2,vy:0.5+Math.random()*1.5,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.05,sz:4+Math.random()*8,ci:Math.floor(Math.random()*2)}));}
  for(const p of SD.petals){p.x+=p.vx;p.y+=p.vy*(1+SM.energy*0.2);p.rot+=p.rotS;if(p.y>h+10){p.y=-10;p.x=Math.random()*w;}x0.save();x0.translate(p.x,p.y);x0.rotate(p.rot);x0.fillStyle=rgba(pc(p.ci),0.75);x0.beginPath();x0.ellipse(0,0,p.sz,p.sz*0.35,0,0,Math.PI*2);x0.fill();x0.restore();}
  // Altar platform
  x0.fillStyle='rgba(35,15,8,0.95)';x0.fillRect(cx-w*0.28,h*0.65,w*0.56,h*0.08);
  x0.fillStyle='rgba(50,25,12,0.9)';x0.fillRect(cx-w*0.22,h*0.73,w*0.44,h*0.15);
  // Altar cloth
  x0.fillStyle=rgba(pc(0),0.25);x0.fillRect(cx-w*0.28,h*0.64,w*0.56,h*0.03);
  // Marigold garlands
  for(let g=0;g<12;g++){
    const gx=cx-w*0.26+g*(w*0.52/11);
    const gy=h*0.66+Math.sin(g*0.8)*h*0.02;
    x0.fillStyle=rgba(pc(g%2===0?0:1),0.8);x0.shadowBlur=6;x0.shadowColor=pc(g%2===0?0:1);
    x0.beginPath();x0.arc(gx,gy,5,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
  }
  // Candles — more dramatic
  if(!SD.candles){SD.candles=Array.from({length:8},(_,i)=>({x:cx-w*0.24+(i/(8-1))*w*0.48,sz:14+Math.random()*8,flicker:Math.random()*Math.PI*2,ci:i%4}));}
  for(const c of SD.candles){
    c.flicker+=0.08+SM.beatPulse*0.05;const fx=Math.sin(c.flicker)*2.5;
    const tx=c.x,ty=h*0.65;
    // Wax
    x0.fillStyle='rgba(230,210,180,0.9)';x0.fillRect(tx-c.sz*0.08,ty,c.sz*0.18,c.sz*0.9);
    // Flame
    x0.shadowBlur=15+SM.beatPulse*10;x0.shadowColor='rgba(255,200,80,0.9)';
    const fh=c.sz*(0.7+Math.sin(c.flicker*1.3)*0.15+SM.beatPulse*0.2);
    const fg=x0.createRadialGradient(tx+fx,ty-fh*0.5,0,tx+fx,ty,fh);
    fg.addColorStop(0,'rgba(255,240,100,1)');fg.addColorStop(0.4,rgba(pc(c.ci),0.8));fg.addColorStop(1,'transparent');
    x0.fillStyle=fg;x0.beginPath();x0.arc(tx+fx,ty-fh*0.4,fh*0.35,0,Math.PI*2);x0.fill();
    // Candle glow on altar
    const cg=x0.createRadialGradient(tx,ty,0,tx,ty,c.sz*2.5*(1+SM.beatPulse*0.3));
    const cc=h2r(pc(c.ci));cg.addColorStop(0,`rgba(${cc.r},${cc.g},${cc.b},0.08)`);cg.addColorStop(1,'transparent');
    x0.fillStyle=cg;x0.fillRect(0,0,w,h);x0.shadowBlur=0;
  }
  // Spirit skulls floating
  if(!SD.skulls){SD.skulls=Array.from({length:6},(_,i)=>({x:w*(0.1+i*0.15),y:h*(0.2+Math.random()*0.35),sz:30+Math.random()*25,ph:Math.random()*Math.PI*2,ci:i%4}));}
  for(const sk of SD.skulls){
    sk.ph+=0.007;
    x0.save();x0.translate(sk.x,sk.y+Math.sin(sk.ph)*12);
    x0.shadowBlur=20+SM.beatPulse*15;x0.shadowColor=pc(sk.ci);
    x0.globalAlpha=0.55+SM.beatPulse*0.15;
    drawCPMini(x0,'sugar_skull',sk.x,sk.y+Math.sin(sk.ph)*12,sk.sz,sk.ph*0.1);
    x0.globalAlpha=1;x0.shadowBlur=0;x0.restore();
  }
  // Centerpiece as altar offering — glowing at center of altar
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.012*(1+SM.beatPulse*0.5);
    const altarSz=Math.min(w,h)*(0.14+SM.beatPulse*0.04)*(0.7+songProg*0.5);
    // Offering glow
    const og=x0.createRadialGradient(cx,h*0.64,0,cx,h*0.64,altarSz*1.8);
    og.addColorStop(0,rgba(pc(0),0.25*(1+SM.beatPulse*0.4)));og.addColorStop(1,'transparent');
    x0.fillStyle=og;x0.fillRect(0,0,w,h);
    x0.shadowBlur=altarSz*0.7;x0.shadowColor=pc(0);
    drawCPMini(x0,THEME.centerpiece,cx,h*0.58,altarSz,cpRot);
    x0.shadowBlur=0;
  }
}
function drawChineseDragon(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Fog banks
  if(!SD.fog){SD.fog=Array.from({length:8},(_,i)=>({x:Math.random()*w,y:h*(0.3+Math.random()*0.5),r:150+Math.random()*200,ph:Math.random()*Math.PI*2,speed:0.003+Math.random()*0.003}));}
  for(const fg of SD.fog){fg.ph+=fg.speed;const fx=fg.x+Math.sin(fg.ph)*60,fy=fg.y+Math.cos(fg.ph*0.7)*30;const gr=x0.createRadialGradient(fx,fy,0,fx,fy,fg.r);const gc=h2r(pc(1));gr.addColorStop(0,`rgba(${gc.r},${gc.g},${gc.b},0.07)`);gr.addColorStop(1,'transparent');x0.fillStyle=gr;x0.fillRect(0,0,w,h);}
  // Pearl — the centerpiece glowing orb the dragon chases
  if(!SD.pearl){SD.pearl={x:w*0.3,y:h*0.4,vx:1.5,vy:0.5,ph:0};}
  const pearl=SD.pearl;
  // Pearl moves in figure-8 pattern
  pearl.ph+=0.012*(1+SM.energy*0.2);
  pearl.x=cx+Math.sin(pearl.ph)*w*0.3;
  pearl.y=cy+Math.sin(pearl.ph*2)*h*0.2;
  // Draw pearl as centerpiece
  const pearlSz=Math.min(w,h)*(0.09+SM.beatPulse*0.04);
  const pg=x0.createRadialGradient(pearl.x,pearl.y,0,pearl.x,pearl.y,pearlSz*1.5);
  pg.addColorStop(0,rgba(pc(0),0.3*(1+SM.beatPulse*0.3)));pg.addColorStop(1,'transparent');
  x0.fillStyle=pg;x0.fillRect(0,0,w,h);
  cpPh+=0.013;cpRot+=0.04*(1+SM.energy*0.2);
  x0.shadowBlur=pearlSz*0.9;x0.shadowColor=rgba(pc(0),0.9);
  drawCPMini(x0,THEME.centerpiece,pearl.x,pearl.y,pearlSz,cpRot);
  x0.shadowBlur=0;
  // Dragon body — sinuous segments chasing the pearl
  SD.dragonEmerge=Math.min(1,(SD.dragonEmerge||0)+0.004*(1+SM.energy*0.2));
  const emerge=SD.dragonEmerge;
  if(!SD.dragonPath){SD.dragonPath=Array.from({length:30},()=>({x:cx,y:cy}));}
  // Head moves toward pearl
  const head=SD.dragonPath[0];
  const dx=pearl.x-head.x,dy=pearl.y-head.y;
  const dist=Math.hypot(dx,dy)||1;
  head.x+=dx/dist*2.5*(1+SM.energy*0.4);
  head.y+=dy/dist*2.5*(1+SM.energy*0.4);
  // Body follows head
  for(let s=1;s<SD.dragonPath.length;s++){
    const prev=SD.dragonPath[s-1],curr=SD.dragonPath[s];
    const ddx=curr.x-prev.x,ddy=curr.y-prev.y;
    const dd=Math.hypot(ddx,ddy)||1;
    if(dd>22){curr.x=prev.x+ddx/dd*22;curr.y=prev.y+ddy/dd*22;}
  }
  // Draw body
  x0.save();x0.globalAlpha=emerge;
  for(let s=SD.dragonPath.length-1;s>=0;s--){
    const seg=SD.dragonPath[s];
    const segR=(28-s*0.7)*(1-s/(SD.dragonPath.length*1.5))*emerge;
    if(segR<1)continue;
    x0.beginPath();x0.arc(seg.x,seg.y,segR,0,Math.PI*2);
    x0.fillStyle=rgba(pc(s%4),(0.65-s*0.015)*Math.min(1,emerge*2));
    x0.shadowBlur=8;x0.shadowColor=pc(s%4);
    x0.fill();x0.shadowBlur=0;
    // Scales glint
    if(s%3===0){x0.fillStyle=rgba(pc((s+2)%4),0.25);x0.beginPath();x0.arc(seg.x,seg.y,segR*0.6,0,Math.PI*2);x0.fill();}
  }
  // Dragon head
  const dh=SD.dragonPath[0];
  const headDir=Math.atan2(SD.dragonPath[0].y-SD.dragonPath[1].y,SD.dragonPath[0].x-SD.dragonPath[1].x);
  x0.save();x0.translate(dh.x,dh.y);x0.rotate(headDir);
  x0.fillStyle=rgba(pc(0),0.92);x0.shadowBlur=30;x0.shadowColor=pc(0);
  x0.beginPath();x0.ellipse(0,0,38,26,0,0,Math.PI*2);x0.fill();
  // Jaw/snout
  x0.beginPath();x0.moveTo(20,8*(1+SM.beatPulse*0.3));x0.lineTo(55,5*(1+SM.beatPulse*0.3));x0.lineTo(55,14*(1+SM.beatPulse*0.3));x0.lineTo(20,16*(1+SM.beatPulse*0.3));x0.fill();
  // Eye
  x0.fillStyle=rgba(pc(1),0.95);x0.shadowBlur=15;x0.shadowColor=pc(1);
  x0.beginPath();x0.arc(20,-10,8,0,Math.PI*2);x0.fill();x0.fillStyle='rgba(0,0,0,0.9)';x0.beginPath();x0.arc(22,-10,4,0,Math.PI*2);x0.fill();
  // Horn
  x0.fillStyle=rgba(pc(2),0.85);x0.beginPath();x0.moveTo(5,-26);x0.lineTo(18,-50);x0.lineTo(22,-26);x0.closePath();x0.fill();
  x0.restore();x0.restore();
}
function drawMountOlympus(t){
  const w=W(),h=H(),cx=w/2;
  // Mountain dusk sky — deep purples and golds
  const sky=x0.createLinearGradient(0,0,0,h);
  sky.addColorStop(0,'rgba(5,2,25,1)');
  sky.addColorStop(0.35,rgba(pc(2),0.3));
  sky.addColorStop(0.65,rgba(pc(1),0.25));
  sky.addColorStop(1,'rgba(20,5,0,0.8)');
  x0.fillStyle=sky;x0.fillRect(0,0,w,h);
  // Mountain ranges — layered peaks
  const drawMountainRange=(peaks,yBase,alpha,ci)=>{
    x0.fillStyle=rgba(pc(ci),alpha);
    x0.beginPath();x0.moveTo(0,h);
    for(let i=0;i<peaks.length;i++){x0.lineTo(peaks[i][0]*w,peaks[i][1]*h+yBase*h);}
    x0.lineTo(w,h);x0.closePath();x0.fill();
  };
  // Far mountains (lighter)
  drawMountainRange([[0,0.7],[0.1,0.2],[0.18,0.35],[0.3,0.1],[0.42,0.3],[0.5,0.05],[0.58,0.28],[0.7,0.12],[0.82,0.32],[0.92,0.18],[1,0.4]],0,0.55,3);
  // Mid mountains (darker)
  drawMountainRange([[0,0.9],[0.08,0.45],[0.2,0.6],[0.32,0.3],[0.45,0.55],[0.55,0.25],[0.67,0.5],[0.78,0.35],[0.9,0.55],[1,0.45]],0,0.75,0);
  // Close mountains (near black)
  drawMountainRange([[0,1],[0.12,0.55],[0.25,0.7],[0.38,0.5],[0.5,0.65],[0.62,0.48],[0.75,0.62],[0.88,0.52],[1,0.7]],0,0.92,'rgba(5,3,10,0.95)'.replace('rgba(','').replace(',0.95)',''));
  x0.fillStyle='rgba(5,3,10,0.95)';
  x0.beginPath();x0.moveTo(0,h);
  [[0,1],[0.12,0.55],[0.25,0.7],[0.38,0.5],[0.5,0.65],[0.62,0.48],[0.75,0.62],[0.88,0.52],[1,0.7]].forEach(([px,py])=>x0.lineTo(px*w,py*h));
  x0.lineTo(w,h);x0.closePath();x0.fill();
  // Olympus peak glow
  const peak=x0.createRadialGradient(cx,h*0.22,0,cx,h*0.22,w*0.3);
  peak.addColorStop(0,rgba(pc(1),0.35*(1+SM.beatPulse*0.4)));peak.addColorStop(0.5,rgba(pc(2),0.12));peak.addColorStop(1,'transparent');
  x0.fillStyle=peak;x0.fillRect(0,0,w,h);
  // Clouds
  if(!SD.clouds){SD.clouds=Array.from({length:6},(_,i)=>({x:Math.random()*w,y:h*(0.08+i*0.06),r:80+Math.random()*140,vx:(Math.random()-0.5)*0.25,ci:i%4}));}
  for(const cl of SD.clouds){cl.x+=cl.vx;if(cl.x<-cl.r)cl.x=w+cl.r;if(cl.x>w+cl.r)cl.x=-cl.r;const cg=x0.createRadialGradient(cl.x,cl.y,0,cl.x,cl.y,cl.r);cg.addColorStop(0,rgba(pc(cl.ci),0.18*(1+SM.beatPulse*0.25)));cg.addColorStop(1,'transparent');x0.fillStyle=cg;x0.fillRect(0,0,w,h);}
  // Zeus figure (massive, imposing)
  if(!SD.zeus){SD.zeus={x:cx,y:h*0.18,scale:0,targetScale:1,throwTimer:0,throwing:false};}
  SD.zeus.scale=Math.min(1,SD.zeus.scale+0.008);
  x0.save();x0.translate(SD.zeus.x,SD.zeus.y);x0.scale(SD.zeus.scale,SD.zeus.scale);x0.globalAlpha=0.75;
  x0.shadowBlur=50;x0.shadowColor=rgba(pc(1),0.7);
  // Robes
  x0.fillStyle=rgba(pc(2),0.55);
  x0.beginPath();x0.moveTo(-60,220);x0.bezierCurveTo(-90,100,-70,-20,-20,-60);x0.lineTo(20,-60);x0.bezierCurveTo(70,-20,90,100,60,220);x0.closePath();x0.fill();
  // Torso
  x0.fillStyle=rgba(pc(3),0.45);x0.beginPath();x0.ellipse(0,50,45,70,0,0,Math.PI*2);x0.fill();
  // Arms
  SD.zeus.throwTimer+=16;
  const throwAnim=SD.zeus.throwing?Math.min(1,SD.zeus.throwTimer/500):0;
  x0.strokeStyle=rgba(pc(3),0.6);x0.lineWidth=18;x0.lineCap='round';
  // Right arm raised to throw
  x0.beginPath();x0.moveTo(40,20);x0.lineTo(90+throwAnim*30,-80-throwAnim*40);x0.stroke();
  // Left arm down
  x0.beginPath();x0.moveTo(-40,20);x0.lineTo(-75,80);x0.stroke();
  x0.lineCap='butt';
  // Head
  x0.fillStyle=rgba(pc(3),0.65);x0.beginPath();x0.ellipse(0,-100,35,42,0,0,Math.PI*2);x0.fill();
  // Beard
  x0.strokeStyle=rgba(pc(2),0.7);x0.lineWidth=6;
  for(let b=0;b<7;b++){x0.beginPath();x0.moveTo(-20+b*6,-75);x0.bezierCurveTo(-18+b*6+Math.sin(b)*8,-50,-15+b*5,-30,-12+b*6+Math.sin(b*2)*5,-10);x0.stroke();}
  // Eyes
  x0.fillStyle=rgba(pc(1),0.95);x0.shadowBlur=20;x0.shadowColor=pc(1);
  x0.beginPath();x0.arc(-14,-108,7,0,Math.PI*2);x0.fill();x0.beginPath();x0.arc(14,-108,7,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
  x0.restore();
  // Centerpiece target — it gets thrown to, then destroyed by lightning
  if(!SD.cpTarget){SD.cpTarget={x:cx*0.5+Math.random()*cx,y:h*0.55,alive:true,destroyTimer:0,debris:[],spawnTimer:0};}
  const cpt=SD.cpTarget;
  cpt.spawnTimer+=16;
  // Auto throw toward centerpiece every 5-8 seconds
  if(!SD.zeus.throwing&&cpt.spawnTimer>5000+Math.random()*3000&&cpt.alive){
    SD.zeus.throwing=true;SD.zeus.throwTimer=0;
    if(!SD.boltsComing)SD.boltsComing=[];
    // Aim bolt at centerpiece
    setTimeout(()=>{
      const dx=cpt.x-SD.zeus.x,dy=cpt.y-SD.zeus.y,dist=Math.hypot(dx,dy)||1;
      SD.boltsComing.push({x:SD.zeus.x+90,y:SD.zeus.y-80,vx:dx/dist*14,vy:dy/dist*14,size:20,life:1,ci:1,target:cpt});
      setTimeout(()=>{SD.zeus.throwing=false;cpt.spawnTimer=0;},600);
    },400);
  }
  // Draw living centerpiece target
  if(cpt.alive){
    const cpSz=Math.min(w,h)*(0.1+SM.beatPulse*0.02);
    cpPh+=0.013;cpRot+=0.02;
    x0.shadowBlur=cpSz*0.5;x0.shadowColor=pc(0);
    drawCPMini(x0,THEME.centerpiece,cpt.x,cpt.y,cpSz,cpRot);
    x0.shadowBlur=0;
  }
  // Debris from destroyed centerpiece
  for(let i=cpt.debris.length-1;i>=0;i--){
    const d=cpt.debris[i];d.x+=d.vx;d.y+=d.vy;d.vy+=0.15;d.life-=0.012;d.rot+=d.rotS;
    if(d.life<=0){cpt.debris.splice(i,1);continue;}
    x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);x0.globalAlpha=d.life;
    x0.fillStyle=rgba(pc(d.ci),0.8);x0.fillRect(-d.sz/2,-d.sz/2,d.sz,d.sz);
    x0.restore();
  }
  // Respawn centerpiece after it's been debris'd long enough
  if(!cpt.alive&&cpt.debris.length===0){
    cpt.x=w*0.2+Math.random()*w*0.6;cpt.y=h*0.4+Math.random()*h*0.25;
    cpt.alive=true;cpt.spawnTimer=0;
  }
  // Incoming bolts
  if(!SD.boltsComing)SD.boltsComing=[];
  for(let i=SD.boltsComing.length-1;i>=0;i--){
    const b=SD.boltsComing[i];b.x+=b.vx;b.y+=b.vy;b.size*=1.05;b.life-=0.025;
    // Hit detection
    if(b.target&&b.target.alive){
      const hitDist=Math.hypot(b.x-b.target.x,b.y-b.target.y);
      if(hitDist<60){
        // DESTROY the centerpiece!
        flash('rgba(255,255,100,0.9)',150);
        b.target.alive=false;
        // Spawn debris chunks
        for(let d=0;d<20;d++){b.target.debris.push({x:b.target.x,y:b.target.y,vx:(Math.random()-0.5)*12,vy:-(Math.random()*8+2),vy0:0,life:1,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.2,sz:8+Math.random()*20,ci:Math.floor(Math.random()*4)});}
        SD.boltsComing.splice(i,1);continue;
      }
    }
    if(b.life<=0||b.y>h){SD.boltsComing.splice(i,1);continue;}
    x0.save();x0.translate(b.x,b.y);x0.shadowBlur=25;x0.shadowColor=rgba(pc(b.ci),1);
    x0.fillStyle=rgba(pc(b.ci),b.life*1.2);
    x0.beginPath();x0.moveTo(0,-b.size);x0.lineTo(b.size*0.35,-b.size*0.1);x0.lineTo(b.size*0.12,-b.size*0.1);x0.lineTo(b.size*0.5,b.size);x0.lineTo(-b.size*0.12,b.size*0.1);x0.lineTo(0,b.size*0.1);x0.closePath();x0.fill();x0.shadowBlur=0;x0.restore();
  }
  // Background lightning strikes
  if(!SD.lightnings)SD.lightnings=[];
  SD.ltTimer=(SD.ltTimer||0)-16;if(SD.ltTimer<0){SD.lightnings.push(mkLightning());SD.ltTimer=2000+Math.random()*3000;}
  for(let i=SD.lightnings.length-1;i>=0;i--){const lt=SD.lightnings[i];lt.life-=0.05;if(lt.life<=0){SD.lightnings.splice(i,1);continue;}x0.shadowBlur=20;x0.shadowColor=pc(lt.ci);for(const seg of lt.segs){x0.beginPath();x0.moveTo(seg.x1,seg.y1);x0.lineTo(seg.x2,seg.y2);x0.strokeStyle=rgba(pc(lt.ci),lt.life);x0.lineWidth=lt.life*2.5;x0.stroke();}x0.shadowBlur=0;}
}
function drawSuperMario(t){
  const w=W(),h=H();
  // Sky
  x0.fillStyle='#1a1a2e';x0.fillRect(0,0,w,h);
  // Stars
  if(!SD.marioStars){SD.marioStars=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h*0.5,b:Math.random()}));}
  for(const s of SD.marioStars){x0.fillStyle=`rgba(255,255,255,${0.3+Math.abs(Math.sin(t*0.001+s.b*10))*0.5})`;x0.fillRect(s.x,s.y,s.b>0.8?2:1,s.b>0.8?2:1);}
  // Scrolling background
  SD.scrollX=(SD.scrollX||0)+THEME.sceneSpeed*(1+SM.energy*0.3)*(1+beatFX.speedBoost*0.5);
  // Neon ground
  x0.fillStyle=rgba(pc(2),0.85);x0.fillRect(0,h*0.78,w,h*0.06);
  x0.fillStyle=rgba(pc(0),0.6);x0.fillRect(0,h*0.84,w,h*0.16);
  // Ground pattern
  x0.strokeStyle=rgba(pc(2),0.15);x0.lineWidth=1;
  for(let gx=0;gx<w;gx+=40){x0.beginPath();x0.moveTo((gx-SD.scrollX*0.3)%w,h*0.78);x0.lineTo((gx-SD.scrollX*0.3)%w,h);x0.stroke();}
  // Clouds
  for(let c=0;c<4;c++){const cx2=((c*w/3+t*0.018)%w+w)%w,cy2=h*0.12+c*h*0.05;x0.fillStyle='rgba(30,25,60,0.9)';x0.shadowBlur=8;x0.shadowColor=rgba(pc(2),0.3);x0.beginPath();x0.arc(cx2,cy2,35,0,Math.PI*2);x0.arc(cx2+28,cy2-8,25,0,Math.PI*2);x0.arc(cx2+55,cy2,35,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  // Pipes
  if(!SD.pipes){SD.pipes=Array.from({length:4},(_,i)=>({x:i*(w/3)+w*0.2,h:h*0.12+Math.random()*h*0.1}));}
  for(const pipe of SD.pipes){const px=((pipe.x-SD.scrollX%w+w*2)%w);x0.fillStyle=rgba(pc(2),0.8);x0.fillRect(px-18,h*0.78-pipe.h,36,pipe.h);x0.fillRect(px-23,h*0.78-pipe.h,46,18);x0.strokeStyle=rgba(pc(2),0.4);x0.lineWidth=1;x0.strokeRect(px-23,h*0.78-pipe.h,46,18);}
  // Platforms
  if(!SD.platforms){SD.platforms=Array.from({length:5},(_,i)=>({x:i*(w/4)+Math.random()*w*0.1,y:h*(0.42+Math.random()*0.2),w:60+Math.random()*80}));}
  for(const p of SD.platforms){const px=((p.x-SD.scrollX*0.5+w*2)%w);x0.fillStyle=rgba(pc(0),0.85);x0.shadowBlur=8;x0.shadowColor=pc(0);x0.fillRect(px,p.y,p.w,14);x0.shadowBlur=0;}
  // Question blocks — centerpiece IS the spinning collectible block
  const cpBlockX=((w*0.5-SD.scrollX*0.7+w*2)%w);
  const cpBlockY=h*0.45+Math.sin(t*0.002)*8;
  const blkSz=36*(1+SM.beatPulse*0.12);
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.025;
    // Block frame
    x0.fillStyle=rgba(pc(1),0.9);x0.shadowBlur=20;x0.shadowColor=pc(1);
    x0.fillRect(cpBlockX-blkSz/2,cpBlockY-blkSz/2,blkSz,blkSz);
    x0.strokeStyle='rgba(0,0,0,0.5)';x0.lineWidth=2;x0.strokeRect(cpBlockX-blkSz/2,cpBlockY-blkSz/2,blkSz,blkSz);
    x0.shadowBlur=0;
    // Centerpiece inside the block (spinning)
    x0.save();x0.beginPath();x0.rect(cpBlockX-blkSz/2,cpBlockY-blkSz/2,blkSz,blkSz);x0.clip();
    drawCPMini(x0,THEME.centerpiece,cpBlockX,cpBlockY,blkSz*0.45,cpRot);
    x0.restore();
    // "?" label when not hit
    x0.fillStyle='rgba(0,0,0,0.6)';x0.font=`bold ${blkSz*0.5}px monospace`;x0.textAlign='center';
    x0.fillText('?',cpBlockX,cpBlockY+blkSz*0.18);x0.textAlign='left';
  }
  // Goombas
  if(!SD.goombas){SD.goombas=Array.from({length:4},(_,i)=>({x:w*0.2+i*w*0.22,y:h*0.745,vx:0.6+Math.random()*0.4,ph:Math.random()*Math.PI*2}));}
  for(const g of SD.goombas){g.x+=g.vx*(1+SM.energy*0.2);if(g.x<-30||g.x>w+30)g.vx*=-1;g.ph+=0.05;const walkanim=Math.sin(g.ph)*g.vx*0.3;x0.fillStyle=rgba(pc(2),0.9);x0.shadowBlur=6;x0.shadowColor=pc(2);x0.beginPath();x0.arc(g.x,g.y,16,Math.PI,0);x0.fill();x0.beginPath();x0.ellipse(g.x,g.y+4,18,10,0,0,Math.PI*2);x0.fill();x0.fillStyle='rgba(0,0,0,0.8)';x0.beginPath();x0.arc(g.x-6,g.y-2,4,0,Math.PI*2);x0.arc(g.x+6,g.y-2,4,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  // Mario character
  const my=h*0.705;const mx=w*0.25;
  x0.fillStyle=rgba(pc(0),0.95);x0.shadowBlur=10;x0.shadowColor=pc(0);
  x0.fillRect(mx-10,my-38,22,38);x0.beginPath();x0.arc(mx,my-40,13,0,Math.PI*2);x0.fill();
  x0.fillRect(mx-14,my-54,30,12);x0.fillRect(mx-8,my-68,18,15);
  x0.fillStyle='rgba(200,160,120,0.9)';x0.beginPath();x0.arc(mx,my-40,9,0,Math.PI*2);x0.fill();
  x0.shadowBlur=0;
}
function drawAtlantis(t){
  const w=W(),h=H(),cx=w/2;
  // Deep ocean water gradient
  const wg=x0.createLinearGradient(0,0,0,h);
  wg.addColorStop(0,'rgba(0,20,60,0.95)');
  wg.addColorStop(0.3,rgba(pc(2),0.25));
  wg.addColorStop(0.7,THEME.bgColor);
  wg.addColorStop(1,'rgba(0,0,0,0.98)');
  x0.fillStyle=wg;x0.fillRect(0,0,w,h);
  // Caustic light patterns on surfaces
  if(!SD.caustics){SD.caustics=Array.from({length:12},(_,i)=>({x:Math.random()*w,y:Math.random()*h,r:40+Math.random()*80,ph:Math.random()*Math.PI*2,speed:0.008+Math.random()*0.008,ci:i%4}));}
  for(const ca of SD.caustics){ca.ph+=ca.speed;const cx2=ca.x+Math.sin(ca.ph)*25,cy2=ca.y+Math.cos(ca.ph*0.7)*15;const cg=x0.createRadialGradient(cx2,cy2,0,cx2,cy2,ca.r*(1+SM.beatPulse*0.2));const cc=h2r(pc(ca.ci));cg.addColorStop(0,`rgba(${cc.r},${cc.g},${cc.b},0.06)`);cg.addColorStop(0.5,`rgba(${cc.r},${cc.g},${cc.b},0.02)`);cg.addColorStop(1,'transparent');x0.fillStyle=cg;x0.fillRect(0,0,w,h);}
  // Light shafts from above
  if(!SD.lightShafts){SD.lightShafts=Array.from({length:5},(_,i)=>({x:w*(0.1+i*0.2),ph:i*0.8,ci:i%4}));}
  for(const ls of SD.lightShafts){ls.ph+=0.003;const lx=ls.x+Math.sin(ls.ph)*30;x0.save();x0.globalAlpha=0.055*(1+SM.beatPulse*0.3);const lg=x0.createLinearGradient(lx,0,lx+25,h*0.7);const lc=h2r(pc(ls.ci));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx,0);x0.lineTo(lx+50,0);x0.lineTo(lx+100,h*0.7);x0.lineTo(lx-50,h*0.7);x0.closePath();x0.fill();x0.restore();}
  // Sunken Greek/Roman ruins — columns, arches, fallen walls
  if(!SD.ruins){
    SD.ruins=[];
    // Columns
    for(let c=0;c<6;c++){SD.ruins.push({type:'column',x:0.1+c*0.15,h:h*(0.3+Math.random()*0.25),w:22,ci:c%4,tilt:(Math.random()-0.5)*0.15});}
    // Fallen columns
    for(let c=0;c<4;c++){SD.ruins.push({type:'fallen',x:0.12+c*0.22,y:h*0.85,len:h*0.15+Math.random()*h*0.1,ci:c%4,angle:Math.PI*0.15+Math.random()*0.3});}
    // Arch
    SD.ruins.push({type:'arch',x:0.4,h:h*0.42,w:w*0.22,ci:2});
    // Mosaic floor fragments
    for(let m=0;m<8;m++){SD.ruins.push({type:'mosaic',x:Math.random(),y:h*0.78+Math.random()*h*0.1,w:30+Math.random()*60,ci:m%4});}
  }
  for(const r of SD.ruins){
    if(r.type==='column'){
      const rx=r.x*w,ry=h-r.h;
      x0.save();x0.translate(rx,h);x0.rotate(r.tilt);
      // Base
      x0.fillStyle=rgba(pc(r.ci),0.18);x0.fillRect(-r.w*0.7,0,r.w*1.4,-20);
      // Shaft
      x0.fillStyle=rgba(pc(r.ci),0.14);x0.fillRect(-r.w/2,-r.h,r.w,r.h);
      // Capital
      x0.fillRect(-r.w*0.7,-r.h,r.w*1.4,18);
      x0.strokeStyle=rgba(pc(r.ci),0.25);x0.lineWidth=1;x0.strokeRect(-r.w/2,-r.h,r.w,r.h);
      // Fluting lines
      for(let f=1;f<4;f++){x0.beginPath();x0.moveTo(-r.w/2+f*(r.w/4),-20);x0.lineTo(-r.w/2+f*(r.w/4),-r.h+20);x0.strokeStyle=rgba(pc(r.ci),0.08);x0.stroke();}
      x0.restore();
    } else if(r.type==='fallen'){
      x0.save();x0.translate(r.x*w,r.y);x0.rotate(r.angle);
      x0.fillStyle=rgba(pc(r.ci),0.15);x0.fillRect(0,-12,r.len,24);
      x0.strokeStyle=rgba(pc(r.ci),0.2);x0.lineWidth=1;x0.strokeRect(0,-12,r.len,24);
      x0.restore();
    } else if(r.type==='arch'){
      const rx=r.x*w;
      x0.strokeStyle=rgba(pc(r.ci),0.2);x0.lineWidth=18;x0.shadowBlur=6;x0.shadowColor=pc(r.ci);
      x0.beginPath();x0.moveTo(rx-r.w/2,h);x0.lineTo(rx-r.w/2,h-r.h);x0.arcTo(rx,h-r.h-r.w/4,rx+r.w/2,h-r.h,r.w/2);x0.lineTo(rx+r.w/2,h);x0.stroke();x0.shadowBlur=0;
    } else if(r.type==='mosaic'){
      x0.fillStyle=rgba(pc(r.ci),0.2);x0.fillRect(r.x*w,r.y,r.w,8);
    }
  }
  // Fish schools
  if(!SD.fish){SD.fish=Array.from({length:18},()=>({x:Math.random()*w,y:h*(0.15+Math.random()*0.6),vx:(Math.random()-0.5)*1.5+0.5,vy:(Math.random()-0.5)*0.3,sz:6+Math.random()*12,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}));}
  for(const f of SD.fish){f.x+=f.vx*(1+SM.energy*0.15);f.y+=f.vy;f.ph+=0.04;f.y+=Math.sin(f.ph)*0.3;if(f.x<-30)f.x=w+30;if(f.x>w+30)f.x=-30;if(f.y<20||f.y>h*0.85)f.vy*=-1;x0.save();x0.translate(f.x,f.y);x0.rotate(Math.atan2(f.vy,f.vx));x0.fillStyle=rgba(pc(f.ci),0.6);x0.shadowBlur=4;x0.shadowColor=pc(f.ci);x0.beginPath();x0.moveTo(f.sz,0);x0.lineTo(-f.sz,f.sz*0.4);x0.lineTo(-f.sz,-f.sz*0.4);x0.closePath();x0.fill();x0.shadowBlur=0;x0.restore();}
  // Jellyfish
  if(!SD.jellies){SD.jellies=Array.from({length:6},()=>({x:Math.random()*w,y:Math.random()*h*0.6,ph:Math.random()*Math.PI*2,r:20+Math.random()*35,ci:Math.floor(Math.random()*4)}));}
  for(const j of SD.jellies){j.ph+=0.02;j.y+=Math.sin(j.ph)*0.3;j.x+=Math.sin(j.ph*0.5)*0.2;x0.save();x0.translate(j.x,j.y);x0.fillStyle=rgba(pc(j.ci),0.15*(1+SM.beatPulse*0.2));x0.shadowBlur=15;x0.shadowColor=pc(j.ci);x0.beginPath();x0.arc(0,0,j.r,Math.PI,0);x0.fill();// Tentacles
  for(let tn=0;tn<5;tn++){x0.beginPath();x0.moveTo(-j.r*0.7+tn*(j.r*1.4/4),0);x0.bezierCurveTo(-j.r*0.5+tn*j.r*0.35,j.r*0.5,(-j.r*0.4+tn*j.r*0.3)+Math.sin(j.ph+tn)*10,j.r*1.2,(-j.r*0.3+tn*j.r*0.25)+Math.sin(j.ph*1.5+tn)*15,j.r*1.8);x0.strokeStyle=rgba(pc(j.ci),0.12);x0.lineWidth=2;x0.stroke();}x0.shadowBlur=0;x0.restore();}
  // Bubbles rising
  if(!SD.bubbles){SD.bubbles=Array.from({length:30},()=>({x:Math.random()*w,y:Math.random()*h,vy:-(0.3+Math.random()*0.8),r:2+Math.random()*6,ph:Math.random()*Math.PI*2}));}
  for(const b of SD.bubbles){b.y+=b.vy;b.ph+=0.04;if(b.y<-10){b.y=h+10;b.x=Math.random()*w;}x0.beginPath();x0.arc(b.x+Math.sin(b.ph)*2,b.y,b.r,0,Math.PI*2);x0.strokeStyle=rgba(pc(1),0.2+SM.beatPulse*0.1);x0.lineWidth=1;x0.stroke();}
  // Centerpiece — glowing power source in central ruin
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.018*(1+SM.beatPulse*0.3);
    const powerX=cx,powerY=h*0.62;
    const powerSz=Math.min(w,h)*(0.12+SM.beatPulse*0.04)*(0.5+songProg*0.6);
    // Power glow illuminates ruins
    const pg=x0.createRadialGradient(powerX,powerY,0,powerX,powerY,powerSz*2.5);
    pg.addColorStop(0,rgba(pc(0),0.2*(1+SM.beatPulse*0.4)));pg.addColorStop(0.5,rgba(pc(1),0.06));pg.addColorStop(1,'transparent');
    x0.fillStyle=pg;x0.fillRect(0,0,w,h);
    x0.shadowBlur=powerSz*0.8;x0.shadowColor=rgba(pc(0),0.9);
    drawCPMini(x0,THEME.centerpiece,powerX,powerY,powerSz,cpRot);
    x0.shadowBlur=0;
    // Power rays extending outward
    for(let ray=0;ray<6;ray++){
      const ra=ray/6*Math.PI*2+cpRot*0.3;
      const rlen=powerSz*(1.5+SM.beatPulse*0.8);
      x0.beginPath();x0.moveTo(powerX+Math.cos(ra)*powerSz*0.5,powerY+Math.sin(ra)*powerSz*0.5);x0.lineTo(powerX+Math.cos(ra)*rlen,powerY+Math.sin(ra)*rlen);x0.strokeStyle=rgba(pc(ray%4),0.15+SM.beatPulse*0.15);x0.lineWidth=2;x0.stroke();
    }
  }
}
function drawCarnival(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  x0.fillStyle=rgba(pc(0),0.12);x0.beginPath();x0.moveTo(cx,h*0.05);x0.lineTo(w*0.05,h*0.5);x0.lineTo(w*0.95,h*0.5);x0.closePath();x0.fill();
  if(SD.tentLights)for(const tl of SD.tentLights){tl.ph+=0.04;const lx=cx+Math.cos(tl.angle)*w*0.4,ly=cy*0.8+Math.sin(tl.angle)*h*0.25,br=Math.sin(tl.ph)*0.5+0.5;x0.beginPath();x0.arc(lx,ly,4*(1+SM.beatPulse*0.5),0,Math.PI*2);x0.fillStyle=rgba(pc(tl.ci),0.6+br*0.4);x0.shadowBlur=10;x0.shadowColor=pc(tl.ci);x0.fill();x0.shadowBlur=0;}
  SD.ferrisRot=(SD.ferrisRot||0)+0.008+SM.energy*0.005+SM.beatPulse*0.02;
  const ferrisR=Math.min(w,h)*(0.28+SM.beatPulse*0.01); // BIGGER wheel
  const ferrisCX=cx,ferrisCY=h*0.42;
  x0.save();x0.translate(ferrisCX,ferrisCY);x0.rotate(SD.ferrisRot);x0.strokeStyle=rgba(pc(0),0.5);x0.lineWidth=4;x0.shadowBlur=10;x0.shadowColor=pc(0);x0.beginPath();x0.arc(0,0,ferrisR,0,Math.PI*2);x0.stroke();
  // Inner ring
  x0.beginPath();x0.arc(0,0,ferrisR*0.3,0,Math.PI*2);x0.strokeStyle=rgba(pc(1),0.4);x0.lineWidth=3;x0.stroke();
  for(let s=0;s<12;s++){const a=s/12*Math.PI*2;x0.beginPath();x0.moveTo(0,0);x0.lineTo(Math.cos(a)*ferrisR,Math.sin(a)*ferrisR);x0.strokeStyle=rgba(pc(s%4),0.3);x0.lineWidth=2;x0.stroke();}
  x0.shadowBlur=0;x0.restore();
  // Gondolas as centerpiece symbols — mini versions at each spoke tip
  if(THEME.centerpiece){
    // INTEGRATED: 12 mini centerpieces as ferris gondolas on x0
    cpRot+=0.015; cpPh+=0.013;
    const gs=Math.min(w,h)*(0.025+SM.beatPulse*0.007);
    for(let s=0;s<12;s++){
      const a=s/12*Math.PI*2+SD.ferrisRot;
      const gx=ferrisCX+Math.cos(a)*ferrisR, gy=ferrisCY+Math.sin(a)*ferrisR;
      x0.globalAlpha=0.8+SM.beatPulse*0.15;
      drawCPMini(x0,THEME.centerpiece,gx,gy,gs,-SD.ferrisRot+cpRot);
    }
    x0.globalAlpha=1;
  }
  if(SD.confetti)for(const c of SD.confetti){c.x+=c.vx;c.y+=c.vy*(1+SM.energy*0.2);c.rot+=c.rotS;if(c.y>h+10){c.y=-10;c.x=Math.random()*w;}x0.save();x0.translate(c.x,c.y);x0.rotate(c.rot);x0.fillStyle=rgba(pc(c.ci),0.7);x0.fillRect(-c.sz/2,-c.sz*0.3,c.sz,c.sz*0.6);x0.restore();}
}
function drawEgyptianTomb(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  SD.tunnelZ=(SD.tunnelZ||0)+THEME.sceneSpeed*0.01*(1+SM.energy*0.4)*progMult;
  for(let d=8;d>0;d--){const z=((d/8+SD.tunnelZ)%1),cw=lerp(w*0.5,0,z),ch2=lerp(h*0.5,0,z),alpha=(0.1+z*0.5)*THEME.sceneIntensity;x0.strokeStyle=rgba(pc(d%4),alpha);x0.lineWidth=1+z*2;x0.shadowBlur=z>0.6?10:0;x0.shadowColor=pc(d%4);x0.strokeRect(cx-cw,cy-ch2,cw*2,ch2*2);x0.shadowBlur=0;}
  const hChars=['𓀀','𓂀','𓃭','𓄿','𓇋','𓈖','𓊖','𓌃','𓎛','𓏏','𓐍','𓇼'];
  if(SD.hieroglyphs)for(const hg of SD.hieroglyphs){x0.font='18px serif';x0.fillStyle=rgba(pc(hg.ci),hg.alpha*(0.8+SM.beatPulse*0.2));x0.fillText(hChars[hg.char%hChars.length],hg.x,hg.y);}
  if(SD.torches)for(const tr of SD.torches){tr.ph+=0.08;const fx=Math.sin(tr.ph)*4,tx=tr.x*w;x0.fillStyle='rgba(100,60,20,0.8)';x0.fillRect(tx-4,h*0.55,8,40);const fg=x0.createRadialGradient(tx+fx,h*0.53,0,tx+fx,h*0.53,28);fg.addColorStop(0,'rgba(255,200,50,0.9)');fg.addColorStop(0.4,rgba(pc(0),0.6));fg.addColorStop(1,'transparent');x0.fillStyle=fg;x0.beginPath();x0.arc(tx+fx,h*0.53,24,0,Math.PI*2);x0.fill();}
  if(SD.traps)for(let i=SD.traps.length-1;i>=0;i--){const tr=SD.traps[i];tr.y+=tr.vy;tr.life-=0.02;if(tr.y>h||tr.life<=0){SD.traps.splice(i,1);continue;}x0.fillStyle=rgba(pc(tr.ci),tr.life*0.8);x0.beginPath();x0.moveTo(tr.x,tr.y);x0.lineTo(tr.x-10,tr.y-30);x0.lineTo(tr.x+10,tr.y-30);x0.closePath();x0.fill();}
  // Centerpiece stamped as repeating symbol on corridor walls
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece stamped on corridor walls at each depth
    cpRot+=0.003; cpPh+=0.013;
    const stampAlpha=(0.08+songProg*0.12+SM.beatPulse*0.06);
    for(let row=0;row<4;row++){
      const depth=row/4, xOff=w*depth*0.38;
      const stampSz=Math.min(w,h)*0.07*(1-depth*0.45)*(0.7+SM.beatPulse*0.2);
      for(let side=0;side<2;side++){
        const sx=side===0?xOff+w*0.05:w-xOff-w*0.05;
        const sy=h*0.5+Math.sin(row+SD.tunnelZ*3)*h*0.04;
        x0.globalAlpha=stampAlpha*(1-depth*0.4);
        drawCPMini(x0,THEME.centerpiece,sx,sy,stampSz,cpRot+(row+side)*0.6);
      }
    }
    x0.globalAlpha=1;
  }
}

// ═══════════════════════════════════════════════════════
// CENTERPIECE SYSTEM v2 — COMPLETE REBUILD
// ═══════════════════════════════════════════════════════
// Architecture:
//   1. drawCP(ctx, name, sz, t) — draws any centerpiece at (0,0), size sz
//   2. Each scene renderer calls drawCPInScene(x0, t) to integrate
//   3. Render loop calls drawCPInScene — NO separate x1 layer for integrated scenes
//   4. x1 layer ONLY used for scenes that don't integrate (floating mode)
// ═══════════════════════════════════════════════════════

// CP_INTEGRATED_SCENES defined above in variety system

// ── Core draw function ──────────────────────────────────
function drawCP(ctx, name, sz, t) {
  const e = SM.energy, bp = SM.beatPulse, ph = cpPh;
  ctx.save();
  ctx.shadowBlur = 0;

  switch(name) {

    // ── SKULL ──────────────────────────────────────────
    case 'skull': {
      const jawDrop = bp * sz * 0.18;
      ctx.shadowBlur = sz * 0.4; ctx.shadowColor = pc(0);
      // Cranium
      ctx.fillStyle = rgba(pc(0), 0.92);
      ctx.beginPath();
      ctx.arc(0, -sz*0.1, sz*0.52, Math.PI, 0);
      ctx.bezierCurveTo(sz*0.52, sz*0.25, sz*0.38, sz*0.38, sz*0.28, sz*0.38);
      ctx.lineTo(-sz*0.28, sz*0.38);
      ctx.bezierCurveTo(-sz*0.38, sz*0.38, -sz*0.52, sz*0.25, -sz*0.52, -sz*0.1);
      ctx.fill();
      // Eye sockets
      ctx.fillStyle = 'rgba(0,0,0,0.92)';
      ctx.beginPath(); ctx.ellipse(-sz*0.2, -sz*0.1, sz*0.155, sz*0.17, -0.15, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.2, -sz*0.1, sz*0.155, sz*0.17, 0.15, 0, Math.PI*2); ctx.fill();
      // Eye glow on beat
      if (bp > 0.3) {
        ctx.fillStyle = rgba(pc(1), bp * 0.8);
        ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
        ctx.beginPath(); ctx.ellipse(-sz*0.2, -sz*0.1, sz*0.08, sz*0.09, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(sz*0.2, -sz*0.1, sz*0.08, sz*0.09, 0, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      }
      // Nose cavity
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.beginPath(); ctx.moveTo(0, sz*0.08); ctx.lineTo(-sz*0.08, sz*0.22); ctx.lineTo(sz*0.08, sz*0.22); ctx.closePath(); ctx.fill();
      // Upper jaw
      ctx.fillStyle = rgba(pc(0), 0.85);
      ctx.fillRect(-sz*0.28, sz*0.28, sz*0.56, sz*0.12);
      // Lower jaw — drops on beat
      ctx.fillStyle = rgba(pc(0), 0.8);
      ctx.fillRect(-sz*0.24, sz*0.38 + jawDrop, sz*0.48, sz*0.1);
      // Teeth
      ctx.fillStyle = 'rgba(230,230,220,0.9)';
      for (let i=0; i<6; i++) {
        ctx.fillRect(-sz*0.24 + i*sz*0.08, sz*0.28, sz*0.06, sz*0.12);
        ctx.fillRect(-sz*0.21 + i*sz*0.08, sz*0.38 + jawDrop, sz*0.06, sz*0.1);
      }
      break;
    }

    // ── FLAMING_SKULL ──────────────────────────────────
    case 'flaming_skull': {
      // Flames first (behind skull)
      ctx.shadowBlur = sz * 0.5; ctx.shadowColor = pc(0);
      for (let f=0; f<10; f++) {
        const fa = (f/10 - 0.5) * Math.PI * 0.9;
        const fh = sz * (0.6 + Math.sin(ph*4 + f*0.7) * 0.25 + bp*0.3);
        const fx = Math.sin(fa) * sz * 0.35;
        const fy = -sz * 0.38;
        ctx.beginPath();
        ctx.moveTo(fx - sz*0.06, fy);
        ctx.bezierCurveTo(fx - sz*0.04, fy - fh*0.4, fx + sz*0.08, fy - fh*0.6, fx, fy - fh);
        ctx.bezierCurveTo(fx - sz*0.1, fy - fh*0.6, fx + sz*0.04, fy - fh*0.3, fx + sz*0.06, fy);
        ctx.closePath();
        const fg = ctx.createLinearGradient(fx, fy, fx, fy - fh);
        fg.addColorStop(0, 'rgba(255,180,0,0.85)');
        fg.addColorStop(0.4, rgba(pc(0), 0.7));
        fg.addColorStop(1, 'rgba(255,50,0,0)');
        ctx.fillStyle = fg;
        ctx.fill();
      }
      ctx.shadowBlur = 0;
      // Draw skull on top
      drawCP(ctx, 'skull', sz, t);
      break;
    }

    // ── FLAME ──────────────────────────────────────────
    case 'flame': {
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = rgba(pc(0), 0.8);
      for (let layer=0; layer<5; layer++) {
        const li = 1 - layer/5;
        const lsz = sz * (0.3 + layer * 0.16);
        const flicker = Math.sin(ph*5 + layer*1.3) * lsz * 0.12 + bp*lsz*0.15;
        ctx.beginPath();
        ctx.moveTo(0, sz*0.5);
        ctx.bezierCurveTo(-lsz*0.7, sz*0.1, -lsz*0.5 + flicker, -sz*0.2, 0, -sz*0.5 - flicker*0.5);
        ctx.bezierCurveTo(lsz*0.5 - flicker, -sz*0.2, lsz*0.7, sz*0.1, 0, sz*0.5);
        ctx.closePath();
        const colors = ['rgba(255,240,180,0.95)','rgba(255,180,0,0.85)','rgba(255,80,0,0.75)',rgba(pc(0),0.65),'rgba(180,0,80,0.4)'];
        ctx.fillStyle = colors[layer] || rgba(pc(layer%4), 0.5);
        ctx.fill();
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ── DRAGON ──────────────────────────────────────────
    case 'dragon': case 'dragon_head': {
      ctx.shadowBlur = sz*0.35; ctx.shadowColor = pc(0);
      // Body / neck
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath();
      ctx.moveTo(-sz*0.8, sz*0.2);
      ctx.bezierCurveTo(-sz*0.4, sz*0.1, sz*0.1, sz*0.25, sz*0.4, sz*0.05);
      ctx.bezierCurveTo(sz*0.6, -sz*0.05, sz*0.55, -sz*0.2, sz*0.3, -sz*0.15);
      ctx.bezierCurveTo(sz*0.1, sz*0.05, -sz*0.3, sz*0.0, -sz*0.5, sz*0.18);
      ctx.closePath(); ctx.fill();
      // Wing
      ctx.beginPath();
      ctx.moveTo(-sz*0.15, -sz*0.05);
      ctx.bezierCurveTo(-sz*0.35, -sz*0.55, -sz*0.7, -sz*0.8, -sz*0.85, -sz*0.55);
      ctx.bezierCurveTo(-sz*0.95, -sz*0.3, -sz*0.7, -sz*0.1, -sz*0.5, sz*0.0);
      ctx.closePath();
      ctx.fillStyle = rgba(pc(1), 0.65); ctx.fill();
      ctx.strokeStyle = rgba(pc(0), 0.8); ctx.lineWidth = sz*0.02; ctx.stroke();
      // Head
      ctx.fillStyle = rgba(pc(0), 0.92);
      ctx.beginPath();
      ctx.ellipse(sz*0.55, -sz*0.1, sz*0.38, sz*0.22, -0.2, 0, Math.PI*2);
      ctx.fill();
      // Snout/jaw
      ctx.beginPath();
      ctx.moveTo(sz*0.3, sz*0.04);
      ctx.lineTo(sz*0.95, sz*0.0 + bp*sz*0.1);
      ctx.lineTo(sz*0.95, sz*0.12 + bp*sz*0.1);
      ctx.lineTo(sz*0.3, sz*0.12);
      ctx.closePath(); ctx.fill();
      // Horn
      ctx.beginPath();
      ctx.moveTo(sz*0.45, -sz*0.28); ctx.lineTo(sz*0.55, -sz*0.55); ctx.lineTo(sz*0.62, -sz*0.28);
      ctx.closePath(); ctx.fillStyle = rgba(pc(2), 0.85); ctx.fill();
      // Eye
      ctx.fillStyle = rgba(pc(1), 0.95);
      ctx.shadowBlur = 10; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(sz*0.62, -sz*0.12, sz*0.07, sz*0.06, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,0.9)';
      ctx.beginPath(); ctx.arc(sz*0.64, -sz*0.12, sz*0.035, 0, Math.PI*2); ctx.fill();
      // Fire breath on beat
      if (bp > 0.5) {
        for (let f=0; f<5; f++) {
          const fl = sz*(0.4 + f*0.2 + bp*0.3);
          const ffy = (Math.random()-0.5) * sz * 0.12;
          const ffg = ctx.createLinearGradient(sz*0.95, 0, sz*0.95 + fl, 0);
          ffg.addColorStop(0,'rgba(255,240,0,0.9)');
          ffg.addColorStop(0.4,'rgba(255,100,0,0.7)');
          ffg.addColorStop(1,'transparent');
          ctx.fillStyle = ffg; ctx.shadowBlur = 15; ctx.shadowColor = 'rgba(255,150,0,1)';
          ctx.beginPath();
          ctx.ellipse(sz*0.95 + fl*0.5, ffy, fl*0.5, sz*(0.04 + f*0.015), 0, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.shadowBlur = 0;
      }
      break;
    }

    // ── WOLF_HEAD ──────────────────────────────────────
    case 'wolf_head': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      const howl = bp * sz * 0.15; // stretches up on beat
      // Ears
      ctx.fillStyle = rgba(pc(0), 0.85);
      ctx.beginPath(); ctx.moveTo(-sz*0.35, -sz*0.3 - howl); ctx.lineTo(-sz*0.55, -sz*0.75 - howl); ctx.lineTo(-sz*0.1, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.35, -sz*0.3 - howl); ctx.lineTo(sz*0.55, -sz*0.75 - howl); ctx.lineTo(sz*0.1, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      // Inner ear
      ctx.fillStyle = rgba(pc(2), 0.5);
      ctx.beginPath(); ctx.moveTo(-sz*0.32, -sz*0.32 - howl); ctx.lineTo(-sz*0.48, -sz*0.65 - howl); ctx.lineTo(-sz*0.16, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.32, -sz*0.32 - howl); ctx.lineTo(sz*0.48, -sz*0.65 - howl); ctx.lineTo(sz*0.16, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      // Head
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.05 - howl*0.3, sz*0.42, sz*0.45, 0, 0, Math.PI*2); ctx.fill();
      // Snout
      ctx.beginPath(); ctx.ellipse(0, sz*0.22, sz*0.28, sz*0.2, 0, 0, Math.PI*2); ctx.fill();
      // Eyes
      ctx.fillStyle = rgba(pc(1), 0.9); ctx.shadowBlur = 12; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(-sz*0.18, -sz*0.08 - howl*0.2, sz*0.09, sz*0.07, -0.2, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.18, -sz*0.08 - howl*0.2, sz*0.09, sz*0.07, 0.2, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,0.9)'; ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.arc(-sz*0.17, -sz*0.08 - howl*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(sz*0.17, -sz*0.08 - howl*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      // Nose
      ctx.fillStyle = 'rgba(20,20,20,0.9)';
      ctx.beginPath(); ctx.ellipse(0, sz*0.14, sz*0.1, sz*0.07, 0, 0, Math.PI*2); ctx.fill();
      // Teeth
      ctx.fillStyle = 'rgba(240,235,220,0.9)';
      for (let t2=0; t2<4; t2++) {
        ctx.beginPath(); ctx.moveTo(-sz*0.18 + t2*sz*0.12, sz*0.28); ctx.lineTo(-sz*0.14 + t2*sz*0.12, sz*0.42); ctx.lineTo(-sz*0.1 + t2*sz*0.12, sz*0.28); ctx.closePath(); ctx.fill();
      }
      break;
    }

    // ── EAGLE ──────────────────────────────────────────
    case 'eagle': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      const wingFlap = Math.sin(ph*3) * sz * 0.08 * (1 + bp*0.5);
      // Wings
      for (let side=0; side<2; side++) {
        const sx2 = side===0 ? -1 : 1;
        ctx.save(); ctx.scale(sx2, 1);
        ctx.fillStyle = rgba(pc(0), 0.85);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.bezierCurveTo(sz*0.3, -sz*0.1 - wingFlap, sz*0.8, -sz*0.3 - wingFlap, sz*1.1, -sz*0.15 - wingFlap);
        ctx.bezierCurveTo(sz*0.9, sz*0.0, sz*0.5, sz*0.1, sz*0.15, sz*0.1);
        ctx.closePath(); ctx.fill();
        // Wing feather tips
        ctx.strokeStyle = rgba(pc(1), 0.4); ctx.lineWidth = sz*0.015;
        for (let f=0; f<5; f++) {
          const fx = sz*(0.7 + f*0.08);
          const fy = -sz*(0.2 + f*0.02) - wingFlap;
          ctx.beginPath(); ctx.moveTo(fx, fy); ctx.lineTo(fx + sz*0.15, fy - sz*0.1); ctx.stroke();
        }
        ctx.restore();
      }
      // Body
      ctx.fillStyle = rgba(pc(0), 0.9);
      ctx.beginPath(); ctx.ellipse(0, sz*0.05, sz*0.18, sz*0.38, 0, 0, Math.PI*2); ctx.fill();
      // White head
      ctx.fillStyle = 'rgba(240,240,240,0.95)';
      ctx.beginPath(); ctx.arc(0, -sz*0.28, sz*0.2, 0, Math.PI*2); ctx.fill();
      // Beak
      ctx.fillStyle = 'rgba(255,200,0,0.95)';
      ctx.beginPath(); ctx.moveTo(sz*0.08, -sz*0.25); ctx.lineTo(sz*0.35, -sz*0.28); ctx.lineTo(sz*0.08, -sz*0.32); ctx.closePath(); ctx.fill();
      // Eye
      ctx.fillStyle = 'rgba(0,0,0,0.9)';
      ctx.beginPath(); ctx.arc(sz*0.08, -sz*0.3, sz*0.04, 0, Math.PI*2); ctx.fill();
      break;
    }

    // ── SMILEY ──────────────────────────────────────────
    case 'smiley': {
      // Expression changes with energy: smile → grin → shock
      const expr = e; // 0=calm smile, 1=manic shock
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      // Face
      ctx.fillStyle = rgba(pc(1), 0.9);
      ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = rgba(pc(0), 0.8); ctx.lineWidth = sz*0.05; ctx.stroke();
      ctx.shadowBlur = 0;
      // Eyes
      const eyeOpenness = 0.5 + expr*0.5 + bp*0.3;
      ctx.fillStyle = 'rgba(0,0,0,0.9)';
      ctx.beginPath(); ctx.ellipse(-sz*0.3, -sz*0.15, sz*0.12, sz*0.12*eyeOpenness, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.3, -sz*0.15, sz*0.12, sz*0.12*eyeOpenness, 0, 0, Math.PI*2); ctx.fill();
      // Shine dots
      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.beginPath(); ctx.arc(-sz*0.24, -sz*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(sz*0.36, -sz*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      // Mouth — morphs from smile to O-shock
      ctx.strokeStyle = 'rgba(0,0,0,0.9)'; ctx.lineWidth = sz*0.07; ctx.lineCap = 'round';
      if (expr < 0.5) {
        // Smile
        ctx.beginPath(); ctx.arc(0, sz*0.05, sz*0.45, 0.2, Math.PI-0.2); ctx.stroke();
      } else {
        // Shock O
        const mw = sz*(0.2 + expr*0.25);
        const mh = sz*(0.15 + expr*0.3 + bp*0.15);
        ctx.beginPath(); ctx.ellipse(0, sz*0.3, mw, mh, 0, 0, Math.PI*2); ctx.stroke();
      }
      ctx.lineCap = 'butt';
      break;
    }

    // ── DEMON_FACE ──────────────────────────────────────
    case 'demon_face': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = pc(0);
      // Face
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath(); ctx.ellipse(0, 0, sz*0.65, sz*0.75, 0, 0, Math.PI*2); ctx.fill();
      // Horns
      ctx.fillStyle = rgba(pc(0), 0.92);
      ctx.beginPath(); ctx.moveTo(-sz*0.3, -sz*0.55); ctx.lineTo(-sz*0.55, -sz*1.05); ctx.lineTo(-sz*0.15, -sz*0.6); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.3, -sz*0.55); ctx.lineTo(sz*0.55, -sz*1.05); ctx.lineTo(sz*0.15, -sz*0.6); ctx.closePath(); ctx.fill();
      // Angry brows
      ctx.strokeStyle = 'rgba(0,0,0,0.9)'; ctx.lineWidth = sz*0.09; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(-sz*0.55, -sz*0.15); ctx.lineTo(-sz*0.1, sz*0.0); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sz*0.55, -sz*0.15); ctx.lineTo(sz*0.1, sz*0.0); ctx.stroke();
      // Eyes — glowing
      ctx.fillStyle = rgba(pc(1), 0.95); ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(-sz*0.28, -sz*0.02, sz*0.14, sz*0.12 + bp*sz*0.04, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.28, -sz*0.02, sz*0.14, sz*0.12 + bp*sz*0.04, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,0.9)'; ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.arc(-sz*0.28, -sz*0.02, sz*0.07, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(sz*0.28, -sz*0.02, sz*0.07, 0, Math.PI*2); ctx.fill();
      // Fangs
      ctx.fillStyle = 'rgba(240,235,220,0.95)';
      ctx.beginPath(); ctx.moveTo(-sz*0.2, sz*0.35); ctx.lineTo(-sz*0.25, sz*0.65); ctx.lineTo(-sz*0.1, sz*0.35); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.2, sz*0.35); ctx.lineTo(sz*0.25, sz*0.65); ctx.lineTo(sz*0.1, sz*0.35); ctx.closePath(); ctx.fill();
      // Mouth
      ctx.strokeStyle = 'rgba(0,0,0,0.7)'; ctx.lineWidth = sz*0.06;
      ctx.beginPath(); ctx.arc(0, sz*0.2, sz*0.4, 0.1, Math.PI-0.1); ctx.stroke();
      break;
    }

    // ── ALIEN_HEAD ──────────────────────────────────────
    case 'alien_head': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(2);
      // Large cranium
      ctx.fillStyle = rgba(pc(2), 0.82);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.15, sz*0.55, sz*0.65, 0, 0, Math.PI*2); ctx.fill();
      // Narrow chin
      ctx.beginPath(); ctx.ellipse(0, sz*0.45, sz*0.22, sz*0.28, 0, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Huge almond eyes
      ctx.fillStyle = 'rgba(0,0,0,0.95)';
      ctx.beginPath(); ctx.ellipse(-sz*0.22, -sz*0.08, sz*0.24, sz*0.14, -0.4, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.22, -sz*0.08, sz*0.24, sz*0.14, 0.4, 0, Math.PI*2); ctx.fill();
      // Inner eye glow
      ctx.fillStyle = rgba(pc(1), 0.7 + bp*0.3); ctx.shadowBlur = 15; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(-sz*0.22, -sz*0.08, sz*0.1, sz*0.06, -0.4, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.22, -sz*0.08, sz*0.1, sz*0.06, 0.4, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Tiny nostril slits
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.fillRect(-sz*0.06, sz*0.2, sz*0.04, sz*0.08);
      ctx.fillRect(sz*0.02, sz*0.2, sz*0.04, sz*0.08);
      // Thin line mouth
      ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.lineWidth = sz*0.04;
      ctx.beginPath(); ctx.moveTo(-sz*0.15, sz*0.42); ctx.quadraticCurveTo(0, sz*0.38, sz*0.15, sz*0.42); ctx.stroke();
      break;
    }

    // ── ROBOT_HEAD ──────────────────────────────────────
    case 'robot_head': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      // Main box head
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.strokeStyle = rgba(pc(1), 0.6); ctx.lineWidth = sz*0.03;
      const rx=-sz*0.55, ry=-sz*0.62, rw=sz*1.1, rh=sz*1.1;
      ctx.beginPath(); ctx.roundRect(rx, ry, rw, rh, sz*0.08); ctx.fill(); ctx.stroke();
      // Antenna
      ctx.strokeStyle = rgba(pc(1), 0.8); ctx.lineWidth = sz*0.04;
      ctx.beginPath(); ctx.moveTo(0, ry); ctx.lineTo(0, ry-sz*0.3); ctx.stroke();
      ctx.fillStyle = rgba(pc(1), 0.9); ctx.shadowBlur = 10; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.arc(0, ry-sz*0.35, sz*0.07, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Visor screen
      const visorColor = `hsl(${(ph*60)%360},90%,${50+bp*30}%)`;
      ctx.fillStyle = visorColor;
      ctx.shadowBlur = 15+bp*20; ctx.shadowColor = visorColor;
      ctx.beginPath(); ctx.roundRect(-sz*0.42, -sz*0.45, sz*0.84, sz*0.38, sz*0.05); ctx.fill();
      ctx.shadowBlur = 0;
      // Scanline on visor
      ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = sz*0.02;
      for (let sl=0; sl<4; sl++) {
        const sy = -sz*0.42 + sl*sz*0.11;
        ctx.beginPath(); ctx.moveTo(-sz*0.42, sy); ctx.lineTo(sz*0.42, sy); ctx.stroke();
      }
      // Ear bolts
      ctx.fillStyle = rgba(pc(0), 0.7); ctx.strokeStyle = rgba(pc(1), 0.5); ctx.lineWidth = sz*0.02;
      ctx.beginPath(); ctx.rect(rx-sz*0.12, -sz*0.2, sz*0.12, sz*0.25); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.rect(sz*0.55, -sz*0.2, sz*0.12, sz*0.25); ctx.fill(); ctx.stroke();
      // Mouth grille
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.beginPath(); ctx.roundRect(-sz*0.35, sz*0.12, sz*0.7, sz*0.22, sz*0.03); ctx.fill();
      ctx.strokeStyle = rgba(pc(1), 0.4); ctx.lineWidth = sz*0.02;
      for (let g=0; g<5; g++) {
        ctx.beginPath(); ctx.moveTo(-sz*0.28+g*sz*0.14, sz*0.14); ctx.lineTo(-sz*0.28+g*sz*0.14, sz*0.32); ctx.stroke();
      }
      break;
    }

    // ── PEACE_SIGN ──────────────────────────────────────
    case 'peace_sign': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.9); ctx.lineWidth = sz*0.1; ctx.lineCap = 'round';
      // Shatter on big beat
      if (bp > 0.7) {
        // Shattered pieces flying
        ctx.globalAlpha = 1 - (bp-0.7)*2;
        for (let seg=0; seg<6; seg++) {
          const angle = seg/6*Math.PI*2;
          const drift = (bp-0.7)*sz*2;
          ctx.save();
          ctx.translate(Math.cos(angle)*drift, Math.sin(angle)*drift);
          ctx.rotate(angle*(bp-0.7)*3);
          ctx.beginPath(); ctx.arc(0, 0, sz*0.5, angle, angle+Math.PI/3); ctx.stroke();
          ctx.restore();
        }
        ctx.globalAlpha = 1;
      } else {
        // Intact peace sign
        ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(0, sz); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-sz*0.87, sz*0.5); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(sz*0.87, sz*0.5); ctx.stroke();
      }
      ctx.lineCap = 'butt';
      break;
    }

    // ── LIGHTNING_BOLT ──────────────────────────────────
    case 'lightning_bolt': {
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = rgba(pc(1), 0.9);
      // Main bolt shape
      ctx.fillStyle = rgba(pc(1), 0.95);
      ctx.beginPath();
      ctx.moveTo(sz*0.2, -sz);
      ctx.lineTo(-sz*0.12, -sz*0.05);
      ctx.lineTo(sz*0.08, -sz*0.05);
      ctx.lineTo(-sz*0.2, sz);
      ctx.lineTo(sz*0.12, sz*0.05);
      ctx.lineTo(-sz*0.08, sz*0.05);
      ctx.lineTo(sz*0.2, -sz);
      ctx.closePath(); ctx.fill();
      // Branch arcs on beat
      if (bp > 0.3) {
        ctx.strokeStyle = rgba(pc(1), bp*0.7); ctx.lineWidth = sz*0.03;
        for (let b2=0; b2<3; b2++) {
          const bx = (Math.random()-0.5)*sz*0.3;
          const by = -sz*0.5 + b2*sz*0.3;
          ctx.beginPath();
          ctx.moveTo(bx, by);
          ctx.lineTo(bx + (Math.random()-0.5)*sz*0.6, by + sz*0.2);
          ctx.stroke();
        }
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ── YIN_YANG ──────────────────────────────────────
    case 'yin_yang': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      // White half
      ctx.fillStyle = 'rgba(240,240,240,0.95)';
      ctx.beginPath(); ctx.arc(0, 0, sz, -Math.PI/2, Math.PI/2); ctx.fill();
      // Black half
      ctx.fillStyle = 'rgba(10,10,10,0.95)';
      ctx.beginPath(); ctx.arc(0, 0, sz, Math.PI/2, -Math.PI/2); ctx.fill();
      // Small white circle in black half
      ctx.fillStyle = 'rgba(240,240,240,0.95)';
      ctx.beginPath(); ctx.arc(0, sz*0.5, sz*0.25, 0, Math.PI*2); ctx.fill();
      // Small black circle in white half
      ctx.fillStyle = 'rgba(10,10,10,0.95)';
      ctx.beginPath(); ctx.arc(0, -sz*0.5, sz*0.25, 0, Math.PI*2); ctx.fill();
      // Outer ring
      ctx.strokeStyle = 'rgba(100,100,100,0.5)'; ctx.lineWidth = sz*0.04;
      ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.stroke();
      ctx.shadowBlur = 0;
      break;
    }

    // ── STAR ──────────────────────────────────────────
    case 'star': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = pc(1);
      ctx.fillStyle = rgba(pc(1), 0.92);
      const spikes = 5;
      ctx.beginPath();
      for (let i=0; i<spikes*2; i++) {
        const a = i/spikes*Math.PI - Math.PI/2;
        const r = i%2===0 ? sz*(1 + bp*0.25) : sz*0.4;
        i===0 ? ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r) : ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      ctx.closePath(); ctx.fill();
      // Inner glow
      ctx.fillStyle = rgba(pc(0), 0.6);
      ctx.beginPath();
      for (let i=0; i<spikes*2; i++) {
        const a = i/spikes*Math.PI - Math.PI/2;
        const r = i%2===0 ? sz*0.5 : sz*0.2;
        i===0 ? ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r) : ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      ctx.closePath(); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ── DIAMOND ──────────────────────────────────────────
    case 'diamond': case 'crystal': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = rgba(pc(2), 0.8);
      // Main gem facets
      const facetColors = [rgba(pc(0),0.9), rgba(pc(1),0.85), rgba(pc(2),0.9), rgba(pc(3),0.8)];
      // Top crown
      ctx.fillStyle = facetColors[0];
      ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(-sz*0.4, -sz*0.2); ctx.lineTo(sz*0.4, -sz*0.2); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[1];
      ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(-sz*0.7, -sz*0.2); ctx.lineTo(-sz*0.4, -sz*0.2); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[2];
      ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(sz*0.7, -sz*0.2); ctx.lineTo(sz*0.4, -sz*0.2); ctx.closePath(); ctx.fill();
      // Girdle
      ctx.fillStyle = facetColors[3];
      ctx.beginPath(); ctx.moveTo(-sz*0.7, -sz*0.2); ctx.lineTo(-sz*0.4, -sz*0.2); ctx.lineTo(-sz*0.1, sz*0.1); ctx.lineTo(-sz*0.5, sz*0.1); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[0];
      ctx.beginPath(); ctx.moveTo(-sz*0.4, -sz*0.2); ctx.lineTo(sz*0.4, -sz*0.2); ctx.lineTo(sz*0.1, sz*0.1); ctx.lineTo(-sz*0.1, sz*0.1); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[1];
      ctx.beginPath(); ctx.moveTo(sz*0.4, -sz*0.2); ctx.lineTo(sz*0.7, -sz*0.2); ctx.lineTo(sz*0.5, sz*0.1); ctx.lineTo(sz*0.1, sz*0.1); ctx.closePath(); ctx.fill();
      // Pavilion (bottom)
      ctx.fillStyle = facetColors[2];
      ctx.beginPath(); ctx.moveTo(-sz*0.5, sz*0.1); ctx.lineTo(-sz*0.1, sz*0.1); ctx.lineTo(0, sz); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[3];
      ctx.beginPath(); ctx.moveTo(-sz*0.1, sz*0.1); ctx.lineTo(sz*0.1, sz*0.1); ctx.lineTo(0, sz); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[0];
      ctx.beginPath(); ctx.moveTo(sz*0.1, sz*0.1); ctx.lineTo(sz*0.5, sz*0.1); ctx.lineTo(0, sz); ctx.closePath(); ctx.fill();
      // Shine
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.beginPath(); ctx.moveTo(-sz*0.1, -sz*0.7); ctx.lineTo(-sz*0.3, -sz*0.3); ctx.lineTo(sz*0.0, -sz*0.5); ctx.closePath(); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ── COFFIN ──────────────────────────────────────────
    case 'coffin': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      const lidOpen = bp * sz * 0.2;
      // Body
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.strokeStyle = rgba(pc(1), 0.5); ctx.lineWidth = sz*0.04;
      ctx.beginPath();
      ctx.moveTo(-sz*0.35, -sz*0.9);
      ctx.lineTo(-sz*0.5, -sz*0.5);
      ctx.lineTo(-sz*0.5, sz*0.5);
      ctx.lineTo(-sz*0.35, sz*0.9);
      ctx.lineTo(sz*0.35, sz*0.9);
      ctx.lineTo(sz*0.5, sz*0.5);
      ctx.lineTo(sz*0.5, -sz*0.5);
      ctx.lineTo(sz*0.35, -sz*0.9);
      ctx.closePath(); ctx.fill(); ctx.stroke();
      // Cross on front
      ctx.fillStyle = rgba(pc(1), 0.7);
      ctx.fillRect(-sz*0.06, -sz*0.5, sz*0.12, sz*0.5);
      ctx.fillRect(-sz*0.22, -sz*0.28, sz*0.44, sz*0.12);
      // Lid crack / open on beat
      if (lidOpen > 0.05) {
        ctx.strokeStyle = rgba(pc(1), 0.8); ctx.lineWidth = sz*0.05;
        ctx.beginPath();
        ctx.moveTo(-sz*0.5, -sz*0.5 - lidOpen);
        ctx.lineTo(-sz*0.35, -sz*0.9 - lidOpen);
        ctx.lineTo(sz*0.35, -sz*0.9 - lidOpen);
        ctx.lineTo(sz*0.5, -sz*0.5 - lidOpen);
        ctx.stroke();
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ── ASTRONAUT ──────────────────────────────────────
    case 'astronaut': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      // Suit body
      ctx.fillStyle = 'rgba(220,220,230,0.92)';
      ctx.beginPath(); ctx.ellipse(0, sz*0.2, sz*0.52, sz*0.62, 0, 0, Math.PI*2); ctx.fill();
      // Arms
      ctx.beginPath(); ctx.ellipse(-sz*0.58, sz*0.12, sz*0.18, sz*0.38, -0.3, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.58, sz*0.12, sz*0.18, sz*0.38, 0.3, 0, Math.PI*2); ctx.fill();
      // Helmet
      ctx.fillStyle = 'rgba(200,210,230,0.9)';
      ctx.beginPath(); ctx.arc(0, -sz*0.28, sz*0.42, 0, Math.PI*2); ctx.fill();
      // Visor
      ctx.fillStyle = rgba(pc(1), 0.7);
      ctx.shadowBlur = 10; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.28, sz*0.28, sz*0.22, 0, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Visor reflection
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.beginPath(); ctx.ellipse(-sz*0.1, -sz*0.35, sz*0.1, sz*0.06, -0.4, 0, Math.PI*2); ctx.fill();
      // Backpack
      ctx.fillStyle = 'rgba(180,185,200,0.8)';
      ctx.fillRect(-sz*0.25, sz*0.0, sz*0.5, sz*0.28);
      // Flag / patch
      ctx.fillStyle = rgba(pc(0), 0.8);
      ctx.fillRect(-sz*0.42, -sz*0.08, sz*0.16, sz*0.1);
      break;
    }

    // ── ROCKET ──────────────────────────────────────────
    case 'rocket': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      // Body
      ctx.fillStyle = rgba(pc(0), 0.9);
      ctx.beginPath(); ctx.roundRect(-sz*0.22, -sz*0.5, sz*0.44, sz*1.1, sz*0.1); ctx.fill();
      // Nose cone
      ctx.fillStyle = rgba(pc(1), 0.9);
      ctx.beginPath(); ctx.moveTo(-sz*0.22, -sz*0.5); ctx.lineTo(0, -sz*1.0); ctx.lineTo(sz*0.22, -sz*0.5); ctx.closePath(); ctx.fill();
      // Window
      ctx.fillStyle = rgba(pc(2), 0.85); ctx.shadowBlur = 10; ctx.shadowColor = pc(2);
      ctx.beginPath(); ctx.arc(0, -sz*0.15, sz*0.16, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Fins
      ctx.fillStyle = rgba(pc(1), 0.8);
      ctx.beginPath(); ctx.moveTo(-sz*0.22, sz*0.4); ctx.lineTo(-sz*0.55, sz*0.75); ctx.lineTo(-sz*0.22, sz*0.6); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.22, sz*0.4); ctx.lineTo(sz*0.55, sz*0.75); ctx.lineTo(sz*0.22, sz*0.6); ctx.closePath(); ctx.fill();
      // Exhaust flame
      const flameH = sz*(0.3 + Math.sin(ph*8)*0.1 + bp*0.25);
      for (let fl=0; fl<3; fl++) {
        const ffg = ctx.createLinearGradient(0, sz*0.6, 0, sz*0.6+flameH*(1+fl*0.3));
        ffg.addColorStop(0, fl===0?'rgba(255,200,0,0.9)':fl===1?'rgba(255,100,0,0.7)':'rgba(100,50,255,0.5)');
        ffg.addColorStop(1, 'transparent');
        ctx.fillStyle = ffg;
        ctx.beginPath(); ctx.ellipse(0, sz*0.6+flameH*(0.3+fl*0.1), sz*(0.12-fl*0.03), flameH*(0.4+fl*0.2), 0, 0, Math.PI*2); ctx.fill();
      }
      break;
    }

    // ── UFO ──────────────────────────────────────────────
    case 'ufo': {
      ctx.shadowBlur = sz*0.35; ctx.shadowColor = pc(2);
      // Tractor beam on beat
      if (bp > 0.2) {
        const beamGrad = ctx.createLinearGradient(0, sz*0.1, 0, sz*1.2);
        beamGrad.addColorStop(0, rgba(pc(2), bp*0.4));
        beamGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = beamGrad;
        ctx.beginPath();
        ctx.moveTo(-sz*0.3, sz*0.1);
        ctx.lineTo(-sz*0.7, sz*1.2);
        ctx.lineTo(sz*0.7, sz*1.2);
        ctx.lineTo(sz*0.3, sz*0.1);
        ctx.closePath(); ctx.fill();
      }
      // Saucer body
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath(); ctx.ellipse(0, 0, sz*0.9, sz*0.22, 0, 0, Math.PI*2); ctx.fill();
      // Dome
      ctx.fillStyle = rgba(pc(2), 0.8);
      ctx.shadowBlur = 15; ctx.shadowColor = pc(2);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.1, sz*0.42, sz*0.32, 0, Math.PI, 0); ctx.fill();
      ctx.shadowBlur = 0;
      // Lights around rim
      for (let l=0; l<8; l++) {
        const la = l/8*Math.PI*2 + ph*2;
        const lit = l%2===0;
        ctx.fillStyle = lit ? rgba(pc(l%4), 0.9) : rgba(pc(l%4), 0.3);
        if (lit) { ctx.shadowBlur = 8; ctx.shadowColor = pc(l%4); }
        ctx.beginPath(); ctx.arc(Math.cos(la)*sz*0.75, Math.sin(la)*sz*0.1, sz*0.06, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      }
      break;
    }

    // ── BLACK_HOLE ──────────────────────────────────────
    case 'black_hole': {
      // Actual accretion disk + funnel, NOT a circle
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      // Accretion disk rings
      for (let ring=8; ring>0; ring--) {
        const ri = ring/8;
        ctx.save(); ctx.scale(1, 0.3); // flatten to ellipse
        ctx.beginPath(); ctx.arc(0, 0, sz*(0.5+ri*0.7), 0, Math.PI*2);
        const dg = ctx.createRadialGradient(0,0,sz*(0.4+ri*0.6), 0,0,sz*(0.5+ri*0.7));
        dg.addColorStop(0, rgba(pc(ring%4), 0.5*(1-ri)*THEME.sceneIntensity));
        dg.addColorStop(1, 'transparent');
        ctx.fillStyle = dg; ctx.fill();
        ctx.restore();
      }
      // Spiral arms
      for (let arm=0; arm<3; arm++) {
        const aoff = arm/3*Math.PI*2 + cpRot*0.5;
        ctx.beginPath();
        for (let i=0; i<50; i++) {
          const r = sz*(0.3 + i/50 * 1.4);
          const a = aoff + i/50 * Math.PI*3;
          const x2 = Math.cos(a)*r, y2 = Math.sin(a)*r*0.3;
          i===0 ? ctx.moveTo(x2,y2) : ctx.lineTo(x2,y2);
        }
        ctx.strokeStyle = rgba(pc(arm%4), 0.4);
        ctx.lineWidth = sz*0.04; ctx.stroke();
      }
      // Event horizon (actual black)
      ctx.fillStyle = 'rgba(0,0,0,0.98)';
      ctx.beginPath(); ctx.arc(0, 0, sz*0.32, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.8); ctx.lineWidth = sz*0.06;
      ctx.beginPath(); ctx.arc(0, 0, sz*0.32, 0, Math.PI*2); ctx.stroke();
      ctx.shadowBlur = 0;
      break;
    }

    // ── VINYL_RECORD ──────────────────────────────────────
    case 'vinyl_record': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = 'rgba(0,0,0,0.5)';
      // Vinyl
      ctx.fillStyle = 'rgba(15,12,20,0.97)';
      ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.fill();
      // Grooves
      ctx.strokeStyle = 'rgba(40,35,50,0.8)';
      for (let g=3; g<10; g++) {
        ctx.lineWidth = sz*0.025;
        ctx.beginPath(); ctx.arc(0, 0, sz*(g/10), 0, Math.PI*2); ctx.stroke();
      }
      // Label
      const lg = ctx.createRadialGradient(-sz*0.1, -sz*0.1, 0, 0, 0, sz*0.35);
      lg.addColorStop(0, rgba(pc(1), 0.95));
      lg.addColorStop(1, rgba(pc(0), 0.85));
      ctx.fillStyle = lg;
      ctx.beginPath(); ctx.arc(0, 0, sz*0.35, 0, Math.PI*2); ctx.fill();
      // Center hole
      ctx.fillStyle = 'rgba(0,0,0,0.95)';
      ctx.beginPath(); ctx.arc(0, 0, sz*0.06, 0, Math.PI*2); ctx.fill();
      // Scratch effect on beat
      if (bp > 0.5) {
        ctx.strokeStyle = rgba(pc(0), (bp-0.5)*1.5);
        ctx.lineWidth = sz*0.03;
        ctx.beginPath(); ctx.arc(0, 0, sz*0.7, -0.3, 0.3); ctx.stroke();
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ── DISCO_BALL ──────────────────────────────────────
    case 'disco_ball': {
      // Draw the ball AND cast beams across the scene
      const rows=14, cols=18;
      ctx.shadowBlur = 5;
      for (let r=0; r<rows; r++) for (let c=0; c<cols; c++) {
        const lat=(r/rows-0.5)*Math.PI, lon=c/cols*Math.PI*2+cpRot*3;
        const tx=Math.cos(lat)*Math.cos(lon)*sz, ty=Math.sin(lat)*sz, tz=Math.cos(lat)*Math.sin(lon);
        if(tz<0.05) continue;
        const tsz=(5+tz*5)*(1+bp*0.2);
        const bright = 0.3+Math.abs(Math.sin(lon+cpRot*2+lat))*0.7;
        ctx.fillStyle = rgba(pc((r+c)%4), bright*(0.5+tz*0.5));
        ctx.shadowColor = pc((r+c)%4);
        ctx.fillRect(tx-tsz/2, ty-tsz/2, tsz, tsz);
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ── SUN ──────────────────────────────────────────────
    case 'sun': {
      // Actual rays radiating out
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = rgba(pc(1),0.8);
      for (let r=0; r<18; r++) {
        const a = r/18*Math.PI*2;
        const rLen = sz*(1.1+Math.sin(ph*2+r*0.7)*0.18+bp*0.22);
        const rW = sz*(0.04+Math.sin(ph+r)*0.02);
        ctx.save(); ctx.rotate(a);
        const rayG = ctx.createLinearGradient(0, sz*0.8, 0, rLen);
        rayG.addColorStop(0, rgba(pc(1),0.7)); rayG.addColorStop(1,'transparent');
        ctx.fillStyle = rayG;
        ctx.fillRect(-rW, sz*0.8, rW*2, rLen - sz*0.8);
        ctx.restore();
      }
      // Corona glow
      const cg = ctx.createRadialGradient(0,0,sz*0.7,0,0,sz*1.5);
      cg.addColorStop(0, rgba(pc(1),0.15)); cg.addColorStop(1,'transparent');
      ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(0,0,sz*1.5,0,Math.PI*2); ctx.fill();
      // Disc
      const sg = ctx.createRadialGradient(-sz*0.25,-sz*0.25,0,0,0,sz);
      sg.addColorStop(0,'rgba(255,255,220,1)');
      sg.addColorStop(0.4,rgba(pc(1),0.9));
      sg.addColorStop(1,rgba(pc(0),0.6));
      ctx.fillStyle = sg; ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ── MOON ──────────────────────────────────────────────
    case 'moon': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = rgba(pc(2),0.7);
      // Moon disc
      ctx.fillStyle = 'rgba(220,218,240,0.95)';
      ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      // Craters
      const craters = [{x:-sz*0.3,y:-sz*0.2,r:sz*0.14},{x:sz*0.25,y:sz*0.1,r:sz*0.2},{x:-sz*0.05,y:sz*0.35,r:sz*0.1},{x:sz*0.1,y:-sz*0.42,r:sz*0.09}];
      for (const cr of craters) {
        ctx.fillStyle = 'rgba(170,165,195,0.6)';
        ctx.beginPath(); ctx.arc(cr.x,cr.y,cr.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(195,192,215,0.4)';
        ctx.beginPath(); ctx.arc(cr.x-cr.r*0.2,cr.y-cr.r*0.2,cr.r*0.6,0,Math.PI*2); ctx.fill();
      }
      // Shadow cutout — makes it crescent
      ctx.fillStyle = rgba(THEME.bgColor, 0.9);
      ctx.beginPath(); ctx.arc(sz*0.32, 0, sz*0.82, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ── COMET ──────────────────────────────────────────────
    case 'comet': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = rgba(pc(1),0.8);
      // Tail — tapers behind
      for (let tail=0; tail<12; tail++) {
        const tFrac = tail/12;
        const tailG = ctx.createLinearGradient(-sz*0.3-tFrac*sz*2.5,0,0,0);
        tailG.addColorStop(0,'transparent');
        tailG.addColorStop(1, rgba(pc(tail%4), 0.35*(1-tFrac)));
        ctx.fillStyle = tailG;
        ctx.beginPath();
        ctx.ellipse(-sz*0.3-tFrac*sz*1.5, (Math.sin(tail*0.8+ph)*sz*0.04), sz*(0.8+tFrac*1.2), sz*(0.06+tFrac*0.22+bp*0.05), 0, 0, Math.PI*2);
        ctx.fill();
      }
      // Debris particles in tail
      for (let d=0; d<8; d++) {
        ctx.fillStyle = rgba(pc(d%4), 0.5);
        ctx.beginPath();
        ctx.arc(-sz*(0.5+d*0.3)+Math.sin(ph+d)*sz*0.08, (Math.sin(d*1.7+ph)*sz*0.12), sz*0.04, 0, Math.PI*2);
        ctx.fill();
      }
      // Head — bright nucleus
      const hg = ctx.createRadialGradient(-sz*0.05,-sz*0.05,0,0,0,sz*0.38);
      hg.addColorStop(0,'rgba(255,255,230,1)');
      hg.addColorStop(0.5,rgba(pc(1),0.9));
      hg.addColorStop(1,rgba(pc(0),0.4));
      ctx.fillStyle = hg;
      ctx.beginPath(); ctx.arc(0,0,sz*0.38,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ── SKULL_CROSSBONES ──────────────────────────────────
    case 'skull_crossbones': {
      // Two crossed bones behind skull
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.75); ctx.lineWidth = sz*0.14; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(-sz*0.65, sz*0.8); ctx.lineTo(sz*0.65, sz*0.1); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sz*0.65, sz*0.8); ctx.lineTo(-sz*0.65, sz*0.1); ctx.stroke();
      ctx.lineCap = 'butt';
      // Skull on top
      ctx.save(); ctx.translate(0, -sz*0.1); ctx.scale(0.8,0.8); drawCP(ctx,'skull',sz,t); ctx.restore();
      ctx.shadowBlur = 0;
      break;
    }

    // ── TRIDENT ──────────────────────────────────────────
    case 'trident': {
      ctx.shadowBlur = sz*0.35; ctx.shadowColor = pc(0);
      ctx.fillStyle = rgba(pc(0), 0.9);
      ctx.strokeStyle = rgba(pc(0), 0.9);
      // Shaft
      ctx.lineWidth = sz*0.1; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(0, sz); ctx.lineTo(0, -sz*0.3); ctx.stroke();
      // Center prong
      ctx.beginPath(); ctx.moveTo(0, -sz*0.3); ctx.lineTo(0, -sz); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(-sz*0.08, -sz*0.7); ctx.lineTo(sz*0.08, -sz*0.7); ctx.lineTo(sz*0.08, -sz*0.8); ctx.lineTo(0, -sz); ctx.lineTo(-sz*0.08, -sz*0.8); ctx.lineTo(-sz*0.08, -sz*0.7); ctx.closePath(); ctx.fill();
      // Side prongs
      ctx.lineWidth = sz*0.07;
      for (const sx3 of [-1, 1]) {
        ctx.beginPath(); ctx.moveTo(sz*0.3*sx3, -sz*0.3); ctx.lineTo(sz*0.42*sx3, -sz*0.85); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(sz*(0.36+0.05*sx3), -sz*0.6);
        ctx.lineTo(sz*(0.45+0.05*sx3), -sz*0.85);
        ctx.lineTo(sz*(0.3*sx3), -sz*0.78);
        ctx.closePath(); ctx.fill();
      }
      // Cross guard
      ctx.lineWidth = sz*0.09;
      ctx.beginPath(); ctx.moveTo(-sz*0.45, -sz*0.22); ctx.lineTo(sz*0.45, -sz*0.22); ctx.stroke();
      ctx.lineCap = 'butt'; ctx.shadowBlur = 0;
      break;
    }

    // ── LOTUS ──────────────────────────────────────────────
    case 'lotus': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      // Outer petals
      for (let layer=0; layer<3; layer++) {
        const petals = 8 - layer*2;
        const openAngle = (0.3 + songProg*0.4 + bp*0.15) * (1 - layer*0.2);
        for (let p=0; p<petals; p++) {
          const a = p/petals*Math.PI*2;
          ctx.save(); ctx.rotate(a + cpRot*0.1*layer);
          ctx.fillStyle = rgba(pc((layer+p)%4), 0.7 - layer*0.1);
          ctx.beginPath();
          ctx.moveTo(0, 0);
          const pr = sz*(0.5+layer*0.15);
          ctx.bezierCurveTo(-sz*0.12, -pr*0.3, -sz*0.08+Math.sin(ph)*sz*0.02, -pr, 0, -pr*(1+openAngle));
          ctx.bezierCurveTo(sz*0.08+Math.sin(ph)*sz*0.02, -pr, sz*0.12, -pr*0.3, 0, 0);
          ctx.closePath(); ctx.fill();
          ctx.restore();
        }
      }
      // Center
      const cgg = ctx.createRadialGradient(0,0,0,0,0,sz*0.2);
      cgg.addColorStop(0, rgba(pc(1),0.95)); cgg.addColorStop(1, rgba(pc(0),0.7));
      ctx.fillStyle = cgg; ctx.beginPath(); ctx.arc(0,0,sz*0.2,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ── EYE ──────────────────────────────────────────────
    case 'eye': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      // Whites
      ctx.fillStyle = 'rgba(240,238,235,0.97)';
      ctx.beginPath();
      ctx.moveTo(-sz, 0);
      ctx.bezierCurveTo(-sz*0.5, -sz*0.55, sz*0.5, -sz*0.55, sz, 0);
      ctx.bezierCurveTo(sz*0.5, sz*0.55, -sz*0.5, sz*0.55, -sz, 0);
      ctx.closePath(); ctx.fill();
      // Iris
      const irisR = sz*(0.36 + bp*0.06);
      const irisg = ctx.createRadialGradient(0,0,0,0,0,irisR);
      irisg.addColorStop(0, rgba(pc(1),1)); irisg.addColorStop(0.7, rgba(pc(0),0.9)); irisg.addColorStop(1, rgba(pc(0),0.6));
      ctx.fillStyle = irisg;
      ctx.beginPath(); ctx.arc(0,0,irisR,0,Math.PI*2); ctx.fill();
      // Pupil — dilates with energy
      const pupilR = sz*(0.16 + e*0.12);
      ctx.fillStyle = 'rgba(0,0,0,0.97)';
      ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.arc(0,0,pupilR,0,Math.PI*2); ctx.fill();
      // Reflection
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.beginPath(); ctx.arc(-pupilR*0.4,-pupilR*0.5,pupilR*0.35,0,Math.PI*2); ctx.fill();
      // Eyelid outline
      ctx.strokeStyle = 'rgba(80,60,50,0.5)'; ctx.lineWidth = sz*0.04;
      ctx.beginPath();
      ctx.moveTo(-sz, 0);
      ctx.bezierCurveTo(-sz*0.5, -sz*0.55, sz*0.5, -sz*0.55, sz, 0);
      ctx.stroke();
      ctx.shadowBlur = 0;
      break;
    }

    // ── ANKH ──────────────────────────────────────────────
    case 'ankh': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.92); ctx.lineWidth = sz*0.13; ctx.lineCap = 'round';
      // Vertical
      ctx.beginPath(); ctx.moveTo(0, -sz*0.1); ctx.lineTo(0, sz); ctx.stroke();
      // Horizontal
      ctx.beginPath(); ctx.moveTo(-sz*0.55, sz*0.18); ctx.lineTo(sz*0.55, sz*0.18); ctx.stroke();
      // Loop
      ctx.lineWidth = sz*0.1;
      ctx.beginPath(); ctx.ellipse(0, -sz*0.48, sz*0.38, sz*0.44, 0, 0, Math.PI*2); ctx.stroke();
      ctx.lineCap = 'butt'; ctx.shadowBlur = 0;
      break;
    }

    // ── MANDALA ──────────────────────────────────────────
    case 'mandala': {
      for (let layer=0; layer<7; layer++) {
        const r = sz*(0.12+layer*0.13);
        const petals = 6+layer*2;
        for (let p=0; p<petals; p++) {
          const a = p/petals*Math.PI*2 + cpRot*(1-layer*0.08);
          ctx.save(); ctx.rotate(a);
          ctx.fillStyle = rgba(pc((layer+p)%4), (0.45-layer*0.04)*THEME.sceneIntensity*(1+bp*0.2));
          ctx.beginPath(); ctx.ellipse(r,0,r*0.38,r*0.11,0,0,Math.PI*2); ctx.fill();
          ctx.restore();
        }
      }
      ctx.fillStyle = rgba(pc(0),0.9); ctx.shadowBlur=15; ctx.shadowColor=pc(0);
      ctx.beginPath(); ctx.arc(0,0,sz*0.1,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
      break;
    }

    // ── DNA_HELIX ──────────────────────────────────────────
    case 'dna_helix': {
      const segs=24;
      for (let strand=0; strand<2; strand++) for (let i=0; i<segs-1; i++) {
        const y1=i/segs*sz*2-sz, y2=(i+1)/segs*sz*2-sz;
        const x1=Math.cos(i/segs*Math.PI*4+cpRot+(strand/2)*Math.PI)*sz*0.42;
        const x2=Math.cos((i+1)/segs*Math.PI*4+cpRot+(strand/2)*Math.PI)*sz*0.42;
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
        ctx.strokeStyle=rgba(pc((strand*2+i)%4),0.85);
        ctx.lineWidth=sz*0.05; ctx.shadowBlur=6; ctx.shadowColor=pc(strand%4); ctx.stroke(); ctx.shadowBlur=0;
      }
      for (let i=0; i<segs; i++) {
        const y=i/segs*sz*2-sz;
        const x1=Math.cos(i/segs*Math.PI*4+cpRot)*sz*0.42;
        const x2=Math.cos(i/segs*Math.PI*4+cpRot+Math.PI)*sz*0.42;
        ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y);
        ctx.strokeStyle=rgba(pc(i%4),0.35); ctx.lineWidth=sz*0.025; ctx.stroke();
        // Nucleotide dots
        if (i%3===0) {
          ctx.fillStyle = rgba(pc(i%4),0.7);
          ctx.beginPath(); ctx.arc(x1,y,sz*0.04,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(x2,y,sz*0.04,0,Math.PI*2); ctx.fill();
        }
      }
      break;
    }

    // ── TESSERACT ──────────────────────────────────────────
    case 'tesseract': {
      const draw3DBox=(scale,al,ci)=>{
        const pts=[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]].map(([px,py,pz])=>{
          const rx=px*Math.cos(cpRot)-pz*Math.sin(cpRot),rz2=px*Math.sin(cpRot)+pz*Math.cos(cpRot);
          const ry=py*Math.cos(cpRot*0.7)-rz2*Math.sin(cpRot*0.7),rz3=py*Math.sin(cpRot*0.7)+rz2*Math.cos(cpRot*0.7);
          return{x:rx*sz*scale/(rz3+3)*3,y:ry*sz*scale/(rz3+3)*3};
        });
        [[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]].forEach(([a,b])=>{
          ctx.beginPath(); ctx.moveTo(pts[a].x,pts[a].y); ctx.lineTo(pts[b].x,pts[b].y);
          ctx.strokeStyle=rgba(pc(ci),al); ctx.lineWidth=sz*0.03; ctx.stroke();
        });
      };
      ctx.shadowBlur=12; ctx.shadowColor=pc(0);
      draw3DBox(0.4,0.95,0); draw3DBox(0.8,0.55,1); draw3DBox(1.2,0.28,2);
      ctx.shadowBlur=0;
      break;
    }

    // ── HOURGLASS ──────────────────────────────────────────
    case 'hourglass': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      ctx.fillStyle = rgba(pc(0), 0.35); ctx.strokeStyle = rgba(pc(0), 0.85); ctx.lineWidth = sz*0.04;
      // Top half
      ctx.beginPath(); ctx.moveTo(-sz*0.5,-sz); ctx.lineTo(sz*0.5,-sz); ctx.lineTo(0,0); ctx.closePath(); ctx.fill(); ctx.stroke();
      // Bottom half
      ctx.beginPath(); ctx.moveTo(-sz*0.5,sz); ctx.lineTo(sz*0.5,sz); ctx.lineTo(0,0); ctx.closePath(); ctx.fill(); ctx.stroke();
      // Sand
      ctx.fillStyle = rgba(pc(1), 0.85);
      ctx.fillRect(-sz*0.38*(1-songProg), -sz*(0.95-songProg*0.05), sz*0.76*(1-songProg), sz*(0.9-songProg*0.85));
      ctx.fillStyle = rgba(pc(2), 0.75);
      ctx.fillRect(-sz*0.38*songProg, sz*0.05, sz*0.76*songProg, sz*0.88*songProg);
      // Falling grain
      if (songProg < 0.98) {
        ctx.fillStyle = rgba(pc(1), 0.7);
        for (let g=0; g<3; g++) ctx.fillRect(Math.sin(ph*7+g)*sz*0.04 - sz*0.01, sz*(0.0+g*0.05), sz*0.025, sz*0.06);
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ── CROWN ──────────────────────────────────────────────
    case 'crown': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      ctx.fillStyle = rgba(pc(1), 0.9);
      // Base band
      ctx.fillRect(-sz*0.75, sz*0.05, sz*1.5, sz*0.4);
      // 5 points
      const heights = [0.55, 0.38, 0.7, 0.38, 0.55];
      for (let p=0; p<5; p++) {
        const px2 = -sz*0.75 + p*sz*0.375;
        ctx.beginPath();
        ctx.moveTo(px2, sz*0.05);
        ctx.lineTo(px2 + sz*0.1875, -sz*heights[p]*(1+bp*0.08));
        ctx.lineTo(px2 + sz*0.375, sz*0.05);
        ctx.closePath(); ctx.fill();
      }
      ctx.shadowBlur = 0;
      // Jewels
      for (let j=0; j<5; j++) {
        ctx.fillStyle = rgba(pc(j%4), 0.95);
        ctx.shadowBlur = 8; ctx.shadowColor = pc(j%4);
        ctx.beginPath(); ctx.arc(-sz*0.56+j*sz*0.28, sz*0.24, sz*(0.07+bp*0.03), 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      }
      break;
    }

    // ── CLOCK_FACE ──────────────────────────────────────────
    case 'clock_face': {
      ctx.shadowBlur = sz*0.15; ctx.shadowColor = pc(0);
      ctx.fillStyle = 'rgba(240,235,220,0.93)';
      ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = rgba(pc(0),0.75); ctx.lineWidth = sz*0.045; ctx.stroke();
      ctx.shadowBlur = 0;
      for (let hr=0; hr<12; hr++) {
        const ha = hr/12*Math.PI*2-Math.PI/2;
        ctx.beginPath(); ctx.moveTo(Math.cos(ha)*sz*0.8, Math.sin(ha)*sz*0.8); ctx.lineTo(Math.cos(ha)*sz*0.92, Math.sin(ha)*sz*0.92);
        ctx.strokeStyle = rgba(pc(0),0.8); ctx.lineWidth = hr%3===0?sz*0.06:sz*0.03; ctx.stroke();
      }
      const ha2 = cpPh*0.1-Math.PI/2, ma = cpPh-Math.PI/2, sa = cpPh*10-Math.PI/2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = rgba(pc(0),0.9); ctx.lineWidth=sz*0.07;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ha2)*sz*0.55, Math.sin(ha2)*sz*0.55); ctx.stroke();
      ctx.lineWidth = sz*0.05;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ma)*sz*0.75, Math.sin(ma)*sz*0.75); ctx.stroke();
      ctx.strokeStyle = rgba(pc(2),0.9); ctx.lineWidth = sz*0.025;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(sa)*sz*0.85, Math.sin(sa)*sz*0.85); ctx.stroke();
      ctx.lineCap = 'butt';
      ctx.fillStyle = rgba(pc(0),1); ctx.beginPath(); ctx.arc(0,0,sz*0.05,0,Math.PI*2); ctx.fill();
      break;
    }

    // ── TURNTABLE ──────────────────────────────────────────
    case 'turntable': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = 'rgba(0,0,0,0.5)';
      // Deck body
      ctx.fillStyle = 'rgba(25,22,30,0.95)';
      ctx.beginPath(); ctx.roundRect(-sz,-sz*0.65,sz*2,sz*1.3,sz*0.08); ctx.fill();
      ctx.strokeStyle = rgba(pc(0),0.5); ctx.lineWidth = sz*0.03; ctx.stroke();
      // Platter
      ctx.fillStyle = 'rgba(40,35,50,0.95)';
      ctx.beginPath(); ctx.arc(sz*0.05,sz*0.05,sz*0.7,0,Math.PI*2); ctx.fill();
      // Record on platter
      ctx.save(); ctx.translate(sz*0.05,sz*0.05);
      drawCP(ctx, 'vinyl_record', sz*0.65, t);
      ctx.restore();
      // Tonearm
      ctx.save();
      ctx.translate(sz*0.7, -sz*0.45);
      ctx.rotate(cpPh*0.05 - 0.5);
      ctx.strokeStyle = 'rgba(180,170,150,0.9)'; ctx.lineWidth = sz*0.04; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-sz*1.2, sz*0.9); ctx.stroke();
      ctx.fillStyle = 'rgba(200,190,160,0.9)';
      ctx.beginPath(); ctx.arc(0,0,sz*0.08,0,Math.PI*2); ctx.fill();
      ctx.lineCap = 'butt'; ctx.restore();
      ctx.shadowBlur = 0;
      break;
    }

    // ── PLANET ──────────────────────────────────────────────
    case 'planet': {
      // Planet with rings AND surface features — clearly different from sun
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      const pg = ctx.createRadialGradient(-sz*0.3,-sz*0.3,0,0,0,sz);
      pg.addColorStop(0,rgba(pc(2),1)); pg.addColorStop(0.5,rgba(pc(0),0.85)); pg.addColorStop(1,rgba(pc(1),0.5));
      ctx.fillStyle = pg; ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      // Surface bands
      for (let band=0; band<5; band++) {
        const by = -sz*0.7 + band*sz*0.35;
        ctx.fillStyle = rgba(pc((band+1)%4), 0.15);
        ctx.beginPath(); ctx.ellipse(0, by, sz*Math.sqrt(1-(by/sz)*(by/sz))*0.98, sz*0.06, 0, 0, Math.PI*2); ctx.fill();
      }
      // Storm spot
      ctx.fillStyle = rgba(pc(3), 0.35);
      ctx.beginPath(); ctx.ellipse(sz*0.25, sz*0.1, sz*0.2, sz*0.14, 0.3, 0, Math.PI*2); ctx.fill();
      // Rings
      ctx.save(); ctx.scale(1,0.25);
      for (let ri=0; ri<4; ri++) {
        ctx.beginPath(); ctx.arc(0,0,sz*(1.3+ri*0.2),0,Math.PI*2);
        ctx.strokeStyle = rgba(pc((ri+2)%4),0.3-ri*0.06); ctx.lineWidth = 8+ri*3; ctx.stroke();
      }
      ctx.restore(); ctx.shadowBlur=0;
      break;
    }

    // ── WORMHOLE ──────────────────────────────────────────
    case 'wormhole': {
      // Funnel + spiral, NOT just concentric circles
      for (let ring=12; ring>0; ring--) {
        ctx.save(); ctx.scale(1, 0.5+ring*0.04);
        ctx.beginPath(); ctx.arc(0,0,sz*(ring/12)*(1+bp*0.05),0,Math.PI*2);
        ctx.strokeStyle = rgba(pc(ring%4),0.5*(ring/12)+bp*0.1);
        ctx.lineWidth = sz*0.04; ctx.stroke(); ctx.restore();
      }
      // Spiral
      ctx.beginPath();
      for (let i=0; i<100; i++) {
        const r=sz*(1-i/100)*0.9, a=i/100*Math.PI*8+cpRot;
        i===0?ctx.moveTo(Math.cos(a)*r,Math.sin(a)*r*0.5):ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r*0.5);
      }
      ctx.strokeStyle=rgba(pc(0),0.4); ctx.lineWidth=sz*0.025; ctx.stroke();
      // Black void center
      const pvg=ctx.createRadialGradient(0,0,0,0,0,sz*0.35);
      pvg.addColorStop(0,'rgba(0,0,0,1)'); pvg.addColorStop(0.7,rgba(pc(0),0.4)); pvg.addColorStop(1,'transparent');
      ctx.fillStyle=pvg; ctx.beginPath(); ctx.arc(0,0,sz*0.45,0,Math.PI*2); ctx.fill();
      break;
    }

    // ── CHANDELIER ──────────────────────────────────────────
    case 'chandelier': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0),0.85); ctx.lineWidth = sz*0.04;
      // Central stem
      ctx.beginPath(); ctx.moveTo(0,-sz*0.9); ctx.lineTo(0,sz*0.3); ctx.stroke();
      // Arms radiating out
      for (let arm=0; arm<6; arm++) {
        const a = arm/6*Math.PI*2 + cpRot*0.3;
        const ax = Math.cos(a)*sz*0.7, ay = Math.sin(a)*sz*0.2 - sz*0.1;
        ctx.beginPath(); ctx.moveTo(0,sz*0.05); ctx.quadraticCurveTo(Math.cos(a)*sz*0.35,ay*0.5,ax,ay); ctx.stroke();
        // Hanging crystal drops
        ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(ax,ay+sz*0.2); ctx.strokeStyle = rgba(pc(arm%4),0.5); ctx.lineWidth=sz*0.015; ctx.stroke();
        ctx.fillStyle = rgba(pc(arm%4),0.88); ctx.shadowBlur=10; ctx.shadowColor=pc(arm%4);
        ctx.beginPath(); ctx.moveTo(ax,ay+sz*0.2); ctx.lineTo(ax-sz*0.04,ay+sz*0.25); ctx.lineTo(ax,ay+sz*0.35); ctx.lineTo(ax+sz*0.04,ay+sz*0.25); ctx.closePath(); ctx.fill();
        ctx.shadowBlur=0; ctx.strokeStyle=rgba(pc(0),0.85); ctx.lineWidth=sz*0.04;
      }
      // Central cluster
      ctx.fillStyle=rgba(pc(1),0.85); ctx.shadowBlur=15; ctx.shadowColor=pc(1);
      ctx.beginPath(); ctx.arc(0,sz*0.3,sz*0.12,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
      break;
    }

    // Fallback for unknown names — crystal/gem shape
    default: {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.fillStyle = rgba(pc(0), 0.85);
      ctx.beginPath();
      for (let i=0; i<6; i++) {
        const a = i/6*Math.PI*2;
        const r = i%2===0 ? sz : sz*0.55;
        i===0 ? ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r) : ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      ctx.closePath(); ctx.fill(); ctx.shadowBlur=0;
    }
  }
  ctx.restore();
}

// ── Position/behavior wrapper ───────────────────────────
function drawCPWithBehavior(ctx, t) {
  if (!THEME.centerpiece || THEME.centerpieceScale === 0) return;
  const w=W(), h=H();
  const baseCX = w*(THEME.centerpieceX||0.5);
  const baseCY = h*(THEME.centerpieceY||0.5);
  const sz = Math.min(w,h) * THEME.centerpieceScale * 0.38;
  cpPh += 0.013;

  let posX=baseCX, posY=baseCY, alpha=1;
  switch(THEME.centerpieceBehavior) {
    case 'spin_fast': cpRot+=0.09*(1+SM.energy); break;
    case 'pulse_beat': cpRot+=0.005; break;
    case 'orbit_slow': cpOrbit+=0.007; break;
    case 'strobe':  cpRot+=0.04; if(SM.beatPulse<0.3) return; break;
    case 'bounce':
      cpRot+=0.02;
      cpBounceX+=cpBounceVX*(1+SM.energy*0.3);
      cpBounceY+=cpBounceVY*(1+SM.energy*0.3);
      if(Math.abs(cpBounceX)>w*0.38){cpBounceVX*=-1;}
      if(Math.abs(cpBounceY)>h*0.32){cpBounceVY*=-1;}
      posX=baseCX+cpBounceX; posY=baseCY+cpBounceY; break;
    case 'drift':
      cpRot+=0.007;
      posX=baseCX+Math.sin(t*0.0004)*w*0.18;
      posY=baseCY+Math.cos(t*0.0003)*h*0.13; break;
    case 'watermark':
      cpRot+=0.002;
      alpha=0.06+Math.sin(cpPh*0.25)*0.025; break;
    case 'rise_set':
      cpRot+=0.01;
      posY=baseCY+Math.sin(t*0.00008)*h*0.15; break;
    case 'breathe':
      cpRot+=0.008; break;
    default: cpRot+=0.012*(1+SM.energy*0.15);
  }

  const pulseSz = THEME.centerpieceBehavior==='pulse_beat' ? sz*(1+SM.beatPulse*0.35) :
                  THEME.centerpieceBehavior==='breathe' ? sz*(1+Math.sin(cpPh*0.4)*0.1) : sz;
  const orbX = THEME.centerpieceBehavior==='orbit_slow' ? Math.cos(cpOrbit)*w*0.14 : 0;
  const orbY = THEME.centerpieceBehavior==='orbit_slow' ? Math.sin(cpOrbit)*h*0.08 : 0;

  if (pulseSz < 2) return;
  ctx.save();
  ctx.globalAlpha = alpha;
  if (beatFX.slamS > 1.002) {
    ctx.translate(w/2,h/2); ctx.scale(beatFX.slamS,beatFX.slamS); ctx.translate(-w/2,-h/2);
  }
  ctx.translate(posX+orbX, posY+orbY);
  ctx.rotate(cpRot);
  drawCP(ctx, THEME.centerpiece, pulseSz, t);
  ctx.restore();
}

// ── Mini version for scene integrations ────────────────
function drawCPMini(ctx, name, x, y, sz, rotation) {
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(rotation || 0);
  drawCP(ctx, name, sz, cpPh*100);
  ctx.restore();
}


// ═══ BEAT FX RENDER ═══
function drawBeatFX(){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  if(beatFX.shockwaveA>0.01){beatFX.shockwaveR+=12*(1+SM.energy);beatFX.shockwaveA*=0.88;x2.beginPath();x2.arc(cx,cy,beatFX.shockwaveR,0,Math.PI*2);x2.strokeStyle=rgba(pc(0),beatFX.shockwaveA);x2.lineWidth=3+beatFX.shockwaveA*5;x2.stroke();if(beatFX.shockwaveR>Math.sqrt(cx*cx+cy*cy)+100)beatFX.shockwaveA=0;}
  if(beatFX.crackLines.length>0){for(let i=beatFX.crackLines.length-1;i>=0;i--){const cl=beatFX.crackLines[i];cl.life-=0.05;if(cl.life<=0){beatFX.crackLines.splice(i,1);continue;}x2.shadowBlur=15;x2.shadowColor=pc(cl.ci);let prev={x:cx,y:cy};for(const seg of cl.segs){x2.beginPath();x2.moveTo(prev.x,prev.y);x2.lineTo(seg.x,seg.y);x2.strokeStyle=rgba(pc(cl.ci),cl.life*0.9);x2.lineWidth=cl.life*3;x2.stroke();prev=seg;}x2.shadowBlur=0;}}
  if(beatFX.invertA>0.01){x2.fillStyle=rgba(pc(0),beatFX.invertA*0.4);x2.fillRect(0,0,w,h);beatFX.invertA*=0.82;}
  if(beatFX.slamS>1.001){beatFX.slamS+=(1-beatFX.slamS)*0.15;}
  if(beatFX.gravityWave>0.01){x2.fillStyle=rgba(pc(2),beatFX.gravityWave*0.08);x2.fillRect(0,0,w,h);beatFX.gravityWave*=0.9;}
  beatFX.speedBoost*=0.88;
}

// ═══ RENDER LOOP ═══
function render(t){
  requestAnimationFrame(render);
  if(!token)return;
  const w=W(),h=H();
  SM.energy+=(MS.energy-SM.energy)*0.05;
  SM.beatPulse*=0.87;
  if(t-MS.lastBeat>MS.beatInterval){MS.lastBeat=t;triggerBeat();}
  if(MS.duration>0){songProg=Math.min(1,(Date.now()-MS.analysisStart)/MS.duration);progMult=0.55+songProg*0.7;}
  // Progress bar
  document.getElementById('pgBar').style.width=(songProg*100)+'%';
  // Cursor
  const tc=h2r(pc(Math.floor(t/3000)%4));document.getElementById('cur').style.background=`rgb(${tc.r},${tc.g},${tc.b})`;
  // Scene layer
  switch(THEME.scene){
    case 'WARP_SPEED':drawWarpSpeed(t);break;case 'LAVA_WORLD':drawLavaWorld(t);break;
    case 'CYBER_GRID':drawCyberGrid(t);break;case 'DEEP_SEA':drawDeepSea(t);break;
    case 'STORM_CHASER':drawStormChaser(t);break;case 'JUNGLE_RAVE':drawJungleRave(t);break;
    case 'DISCO_DIMENSION':drawDiscoDimension(t);break;case 'ACID_TRIP':drawAcidTrip(t);break;
    case 'SPACE_STATION':drawSpaceStation(t);break;case 'NEON_CATHEDRAL':drawNeonCathedral(t);break;
    case 'CLASSIC_ARCADE':drawClassicArcade(t);break;case 'ELECTRIC_FOREST':drawElectricForest(t);break;
    case 'OMNIA_NIGHTCLUB':drawOmniaNightclub(t);break;case 'PIRATE_SHIP':drawPirateShip(t);break;
    case 'JUNKYARD':drawJunkyard(t);break;case 'SUPERHERO':drawSuperhero(t);break;
    case 'DAY_OF_DEAD':drawDayOfDead(t);break;case 'CHINESE_DRAGON':drawChineseDragon(t);break;
    case 'MOUNT_OLYMPUS':drawMountOlympus(t);break;case 'SUPER_MARIO':drawSuperMario(t);break;
    case 'ATLANTIS':drawAtlantis(t);break;case 'CARNIVAL':drawCarnival(t);break;
    case 'EGYPTIAN_TOMB':drawEgyptianTomb(t);break;default:drawWarpSpeed(t);
  }
  // Centerpiece layer — only for non-integrated scenes
  x1.clearRect(0,0,w,h);
  if(THEME.centerpiece&&THEME.centerpieceScale>0&&!CP_INTEGRATED_SCENES.has(THEME.scene)){
    drawCPWithBehavior(x1,t);
  }
  // Beat FX layer
  x2.clearRect(0,0,w,h);
  drawBeatFX();
  // Vignette
  x3.clearRect(0,0,w,h);
  const vg=x3.createRadialGradient(w/2,h/2,h*0.2,w/2,h/2,h*0.85);
  vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,0.55)');
  x3.fillStyle=vg;x3.fillRect(0,0,w,h);
}
requestAnimationFrame(render);

// ═══ TRANSITION ═══
async function transition(name,artist,theme){
  if(inTrans)return;inTrans=true;
  const wash=document.getElementById('wash'),splash=document.getElementById('splash');
  const c=h2r(theme.palette[0]);
  wash.style.background=`radial-gradient(ellipse at 50% 40%,rgba(${c.r},${c.g},${c.b},0.92) 0%,rgba(0,0,0,0.97) 70%)`;
  wash.style.transition='opacity 1.1s ease';wash.style.opacity='1';
  await delay(1200);
  Object.assign(THEME,theme);
  MS.energy=theme.energy||0.5;songProg=0;progMult=0.55;
  initScene();
  document.getElementById('cur').style.background=theme.palette[0];
  document.getElementById('trackName').style.color=theme.palette[0];
  document.getElementById('sceneTag').style.color=theme.palette[2]||theme.palette[0];
  document.getElementById('pgBar').style.background=`linear-gradient(90deg,${theme.palette[1]||theme.palette[0]},${theme.palette[0]})`;
  document.getElementById('pgBar').style.boxShadow=`0 0 8px ${theme.palette[0]}`;
  document.getElementById('sceneTag').textContent=(theme.scene||'SCENE').replace(/_/g,' ')+' — '+(theme.label||'');
  document.getElementById('splashScene').textContent='— '+(theme.scene||'').replace(/_/g,' ')+' —';
  document.getElementById('splashTrack').textContent=name;
  document.getElementById('splashTrack').style.color=theme.palette[0];
  document.getElementById('splashArtist').textContent=artist;
  document.getElementById('splashDesc').textContent=theme.splashDesc||'';
  splash.classList.add('show');
  wash.style.transition='opacity 1.0s ease';wash.style.opacity='0';
  await delay(2200);
  splash.style.transition='opacity 0.7s ease';splash.style.opacity='0';
  await delay(800);
  splash.classList.remove('show');splash.style.opacity='';splash.style.transition='';
  inTrans=false;
}

// ═══ AI THEME LOADER ═══
const ARTIST_CTX={'marshmello':'Marshmello white marshmallow helmet X eyes. EDM festival.','daft punk':'Daft Punk robot helmets. French house. Disco. Tron neon.','deadmau5':'Mouse head helmet. Progressive house. Dark neon.','pink floyd':'Prism rainbow. Flying pigs. Psychedelic prog rock.','the weeknd':'Neon 80s. Red black. Blinding Lights city highways.','david bowie':'Ziggy Stardust lightning bolt. Glam. Cosmic.','queen':'Stadium rock. Operatic grandeur. Freddie Mercury.','nirvana':'Grunge. Dark raw distorted energy.','eminem':'Detroit. 8 Mile. Raw urban intense.','kendrick lamar':'Compton. DNA. DAMN imagery.','taylor swift':'Sparkles. Eras. Stadium spectacle.','billie eilish':'Dark green black. Spider webs. Haunted.','coldplay':'Colorful confetti. Neon wristbands. Cosmos.','radiohead':'Dystopian glitch. OK Computer robot anxiety.','metallica':'Thrash metal. Lightning bolt. Fire skulls.','skrillex':'Heavy dubstep. Glitch alien.','flume':'Organic futurism. Bioluminescent crystals.'};
function getArtistCtx(name){const k=name.toLowerCase();for(const[n,v]of Object.entries(ARTIST_CTX))if(k.includes(n))return v;return null;}
function extractKW(title){const stop=new Set(['a','an','the','in','of','to','and','or','i','my','me','you','is','it','by','on','for','with','as','be','was']);return title.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stop.has(w)).slice(0,6);}

async function loadTheme(tid,name,artist,artistIds,isExplicit,durationMs){
  if(aiCache[tid]){applyTheme(name,artist,aiCache[tid]);return;}
  let genres=[];
  try{const a=await spGet(`artists?ids=${artistIds.slice(0,3).join(',')}`);if(a?.artists)genres=a.artists.flatMap(x=>x.genres||[]).slice(0,8);}catch{}
  const streakDesc=sessionStreak<3?'early session':sessionStreak<6?'warmed up — go wilder':sessionStreak<10?'deep session — darker and more extreme':sessionStreak<15?'long session — full maximalist chaos':'marathon — most extreme worlds, nothing held back';
  const shortlist=getSceneShortlist();
  try{
    const r=await fetch('/api/theme',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({trackName:name,artistName:artist,genres,titleKeywords:extractKW(name),artistContext:getArtistCtx(artist)||`Genres: ${genres.join(', ')}`,sceneShortlist:shortlist,forbiddenCenterpieces:getForbidCPs(),availableCenterpieces:ALL_CPS.filter(x=>!getForbidCPs().includes(x)).join(', '),sessionStreak,streakDesc,isExplicit:!!isExplicit,songDurationSecs:Math.round((durationMs||180000)/1000)})});
    if(!r.ok)throw new Error('HTTP '+r.status);
    const raw=await r.json();if(raw.error)throw new Error(raw.error);
    const VALID_BEH=['rotate','spin_fast','pulse_beat','breathe','orbit_slow','rise_set','fixed','strobe','bounce','drift','watermark'];
    const VALID_BEATS=['speed_burst','shockwave','color_invert','world_crack','bass_slam','strobe_cut','creature_surge','cannon_fire','lightning_strike','gravity_wave','petal_burst','pixel_explode','skull_surge','coin_shower','tentacle_surge'];
    const scene=enforceScene((raw.scene||shortlist[0]||'WARP_SPEED').toUpperCase().replace(/ /g,'_'),shortlist);
    const cp=enforceCP(raw.centerpiece);
    const reactions=(raw.beatReactions||['shockwave']).filter(r2=>VALID_BEATS.includes(r2)).slice(0,4);
    const cpX=Math.min(0.9,Math.max(0.1,parseFloat(raw.centerpieceX)||0.5));
    const cpY=Math.min(0.9,Math.max(0.1,parseFloat(raw.centerpieceY)||0.5));
    const theme={scene,label:raw.label||'',splashDesc:raw.splashDesc||'',palette:Array.isArray(raw.palette)&&raw.palette.length===4?raw.palette:['#ff006e','#8338ec','#06ffd8','#ffbe0b'],bgColor:raw.bgColor||'#000010',centerpiece:cp,centerpieceScale:Math.min(1.5,Math.max(0,parseFloat(raw.centerpieceScale)||0.5)),centerpieceX:cpX,centerpieceY:cpY,centerpieceBehavior:VALID_BEH.includes(raw.centerpieceBehavior)?raw.centerpieceBehavior:'rotate',beatReactions:reactions.length?reactions:['shockwave'],sceneSpeed:Math.min(3,Math.max(0.3,parseFloat(raw.sceneSpeed)||1)),sceneIntensity:Math.min(1,Math.max(0,parseFloat(raw.sceneIntensity)||0.7)),energy:Math.min(1,Math.max(0,parseFloat(raw.energy)||0.5)),chaos:Math.min(1,Math.max(0,parseFloat(raw.chaos)||0.4))};
    recordScene(scene);recordCP(cp);
    aiCache[tid]=theme;applyTheme(name,artist,theme);
  }catch(e){console.error('[AI]',e);}
}
function applyTheme(name,artist,theme){
  document.getElementById('sceneTag').textContent=(theme.scene||'—').replace(/_/g,' ')+' — '+(theme.label||'');
  transition(name,artist,theme);
}

// ═══ SPOTIFY API ═══
async function spGet(ep){
  const r=await fetch('https://api.spotify.com/v1/'+ep,{headers:{Authorization:'Bearer '+token}});
  if(r.status===401){const nt=await refreshAT();if(nt)token=nt;else{logout();return null;}}
  if(!r.ok||r.status===204)return null;
  try{return await r.json()}catch{return null}
}
async function poll(){
  const d=await spGet('me/player/currently-playing');
  if(!d?.item)return;
  const tr=d.item,tid=tr.id;
  MS.progress=d.progress_ms||0;MS.duration=tr.duration_ms||180000;MS.analysisStart=Date.now()-MS.progress;
  MS.beatInterval=500;MS.energy=d.is_playing?0.6:0.3;
  if(tid!==lastTid){
    lastTid=tid;
    document.getElementById('trackName').textContent=tr.name;
    document.getElementById('artistName').textContent=tr.artists.map(a=>a.name).join(', ');
    const art=tr.album?.images?.[0]?.url;if(art)document.getElementById('albumArt').src=art;
    loadTheme(tid,tr.name,tr.artists.map(a=>a.name).join(', '),tr.artists.map(a=>a.id),tr.explicit,tr.duration_ms);
  }
}

// ═══ INIT ═══
document.getElementById('loginBtn').addEventListener('click',doLogin);
document.getElementById('fsBtn').addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen();document.getElementById('fsBtn').textContent='✕ EXIT';}else{document.exitFullscreen();document.getElementById('fsBtn').textContent='⛶ FS';}});

async function init(){
  const p=new URLSearchParams(location.search),code=p.get('code');
  console.log('[auth] init — code='+(code?'present':'none'));
  if(p.get('error')){showErr('Spotify error: '+p.get('error'));return;}
  if(code){
    history.replaceState({},document.title,'/');
    token=await exchToken(code);
    if(!token)return;
  }else{
    token=getAT();
    if(!token)token=await refreshAT();
    console.log('[auth] stored token: '+(token?'found':'none'));
  }
  if(token){
    document.getElementById('login').style.display='none';
    document.getElementById('ui').style.display='block';
    document.getElementById('fsBtn').style.display='block';
    initScene();
    poll();
    setInterval(poll,5000);
  }
}
init();
</script>
</body>
</html>
