<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#00ff41">
<link rel="apple-touch-icon" href="/icon-180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
<link rel="manifest" href="/manifest.json">
<meta name="apple-music-developer-token" content="">
<title>VIZarcade</title>
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" async></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Share Tech Mono',monospace;color:#fff;cursor:none}
#cur{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;z-index:9999;mix-blend-mode:screen;transition:background 2s}
canvas{position:fixed;top:0;left:0;width:100%;height:100%}
#c0{z-index:1}#c1{z-index:2}#c2{z-index:3}#c3{z-index:4;pointer-events:none}
#login{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;overflow:hidden}
#login::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,0,0.018) 2px,rgba(0,255,0,0.018) 4px),radial-gradient(ellipse 80% 60% at 50% 50%,rgba(6,255,216,0.04) 0%,transparent 70%);pointer-events:none}
#login::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 50%,transparent 60%,rgba(0,0,0,0.85) 100%);pointer-events:none;z-index:0}
.logo{position:relative;z-index:1;font-family:'Bebas Neue',sans-serif;font-size:clamp(3.5rem,9vw,8rem);letter-spacing:0.12em;color:#00ff41;text-shadow:0 0 30px #00ff41,0 0 60px rgba(0,255,65,0.4),0 0 100px rgba(0,255,65,0.2),4px 4px 0 #006600,8px 8px 0 #003300;image-rendering:pixelated;filter:contrast(1.1)}
.tagline{position:relative;z-index:1;font-size:0.65rem;letter-spacing:0.5em;color:#00cc33;margin:0.5rem 0 0.4rem;text-transform:uppercase;text-shadow:0 0 8px #00ff41}
.btn{position:relative;z-index:1;padding:1.1rem 3.5rem;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:0.35em;color:#000;background:#00ff41;border:none;cursor:pointer;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100% - 12px));box-shadow:0 0 20px rgba(0,255,65,0.7),0 0 40px rgba(0,255,65,0.3),inset 0 1px 0 rgba(255,255,255,0.3);text-shadow:none;transition:all 0.12s;font-weight:900}
.btn:hover{background:#00ff99;box-shadow:0 0 30px rgba(0,255,153,0.9),0 0 60px rgba(0,255,65,0.5),inset 0 1px 0 rgba(255,255,255,0.4);transform:translateY(-2px)}
#appleMusicBtn:hover{background:#ff5e66!important;box-shadow:0 0 30px rgba(252,60,68,0.9),0 0 60px rgba(252,60,68,0.5)!important}
#localAudioBtn:hover{background:#33ffdf!important;box-shadow:0 0 30px rgba(6,255,216,0.9),0 0 60px rgba(6,255,216,0.5)!important}
#loginErr{position:relative;z-index:1;color:#ff006e;font-size:0.62rem;letter-spacing:0.15em;margin-top:1.2rem;max-width:420px;text-align:center;display:none}#coinDisplay{position:relative;z-index:1;font-family:'Bebas Neue',sans-serif;font-size:0.72rem;letter-spacing:0.4em;color:#ff0;text-shadow:0 0 10px #ff0,0 0 20px rgba(255,200,0,0.5);margin:0 0 2rem;animation:coinBlink 1s step-end infinite}
@keyframes coinBlink{0%,100%{opacity:1}50%{opacity:0.2}}#arcadeScore{position:absolute;top:1.5rem;left:0;right:0;display:flex;justify-content:space-between;padding:0 2rem;z-index:1;font-family:'Bebas Neue',sans-serif;font-size:0.72rem;letter-spacing:0.35em;color:#ff0;text-shadow:0 0 8px #ff0}
.scanlines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px);pointer-events:none;z-index:100}
#ui{position:fixed;z-index:80;inset:0;pointer-events:none;display:none}
#trackName{position:absolute;bottom:2.5rem;left:2.5rem;max-width:50vw;font-family:'Bebas Neue',sans-serif;font-size:clamp(1.2rem,2.8vw,2.2rem);letter-spacing:0.08em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 40px currentColor;transition:color 3s}
#artistName{position:absolute;bottom:calc(2.5rem - 1.8rem);left:2.5rem;font-size:0.82rem;letter-spacing:0.25em;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.9);text-transform:uppercase}
#sceneTag{position:absolute;top:2rem;left:2.5rem;font-size:0.88rem;letter-spacing:0.3em;color:#06ffd8;text-transform:uppercase;text-shadow:0 0 12px rgba(6,255,216,0.7),0 1px 3px rgba(0,0,0,0.9)}
#albumArt{position:absolute;bottom:2.5rem;right:2.5rem;width:72px;height:72px;object-fit:cover;opacity:0.55;border:1px solid rgba(255,255,255,0.07)}
#pgWrap{position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,0.04)}
#pgBar{height:100%;width:0%;transition:width 1s linear}
#splash{position:fixed;inset:0;z-index:90;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 0.8s}
#splash.show{opacity:1}
#splashScene{font-family:'Bebas Neue',sans-serif;font-size:clamp(0.7rem,1.4vw,1rem);letter-spacing:0.6em;color:rgba(255,255,255,0.35);margin-bottom:0.8rem}
#splashTrack{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.5rem,7vw,6.5rem);letter-spacing:0.06em;text-align:center;max-width:90vw;text-shadow:0 0 60px currentColor}
#splashArtist{font-size:clamp(0.8rem,1.8vw,1.1rem);letter-spacing:0.45em;color:rgba(255,255,255,0.4);margin-top:0.8rem;text-transform:uppercase}
#splashDesc{font-size:clamp(0.65rem,1.2vw,0.85rem);font-style:italic;color:rgba(255,255,255,0.22);margin-top:1.5rem;text-align:center;max-width:55vw;line-height:1.8;letter-spacing:0.05em}
#wash{position:fixed;inset:0;z-index:85;opacity:0;pointer-events:none;transition:opacity 1.2s ease}
#surpriseOverlay{position:fixed;inset:0;z-index:75;pointer-events:none;opacity:0}
#comicPanel{position:fixed;inset:0;z-index:76;pointer-events:none;display:none;font-family:'Bebas Neue',sans-serif}
#gameOverScreen{position:fixed;inset:0;z-index:76;pointer-events:none;display:none;align-items:center;justify-content:center;background:#000;font-family:'Bebas Neue',sans-serif;font-size:clamp(4rem,12vw,10rem);letter-spacing:0.2em;color:#f00;text-shadow:0 0 40px #f00}
#fsBtn{position:fixed;bottom:2.5rem;right:calc(72px + 3rem);z-index:85;background:none;border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.28);font-family:'Share Tech Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;padding:0.4rem 0.7rem;cursor:pointer;transition:all 0.2s;display:none;pointer-events:all}
#fsBtn:hover{border-color:#06ffd8;color:#06ffd8}
#backBtn{position:fixed;bottom:calc(2.5rem - 1.8rem);right:calc(72px + 3rem);z-index:85;background:none;border:1px solid rgba(255,255,255,0.07);color:rgba(255,255,255,0.2);font-family:'Share Tech Mono',monospace;font-size:0.55rem;letter-spacing:0.12em;padding:0.3rem 0.6rem;cursor:pointer;transition:all 0.2s;display:none;pointer-events:all}
#backBtn:hover{border-color:#ff006e;color:#ff006e}
#nextSceneBtn{position:fixed;top:2rem;right:2.5rem;z-index:85;background:none;border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.28);font-family:'Share Tech Mono',monospace;font-size:0.85rem;padding:0.2rem 0.65rem;cursor:pointer;transition:all 0.2s;display:none;pointer-events:all}
#nextSceneBtn:hover{border-color:#06ffd8;color:#06ffd8;text-shadow:0 0 8px #06ffd8}

/* ‚ïê‚ïê‚ïê DEV PANEL ‚ïê‚ïê‚ïê */
#devPanel{position:fixed;top:0;right:0;width:320px;max-height:100vh;z-index:300;background:rgba(8,8,16,0.94);border-left:1px solid rgba(0,255,65,0.2);font-family:'Share Tech Mono',monospace;font-size:0.68rem;color:#b0ffb0;overflow-y:auto;display:none;backdrop-filter:blur(8px);scrollbar-width:thin;scrollbar-color:rgba(0,255,65,0.3) transparent;pointer-events:all;cursor:default}
#devPanel.open{display:flex;flex-direction:column}
#devPanel::-webkit-scrollbar{width:4px}#devPanel::-webkit-scrollbar-thumb{background:rgba(0,255,65,0.3);border-radius:2px}
.dp-header{padding:10px 14px 8px;border-bottom:1px solid rgba(0,255,65,0.15);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.dp-header h2{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:#00ff41;letter-spacing:0.3em;margin:0;text-shadow:0 0 12px rgba(0,255,65,0.5)}
.dp-close{background:none;border:1px solid rgba(255,0,110,0.3);color:#ff006e;cursor:pointer;font-size:0.7rem;padding:2px 8px;font-family:'Share Tech Mono',monospace;letter-spacing:0.1em}
.dp-close:hover{background:rgba(255,0,110,0.15);border-color:#ff006e}
.dp-section{padding:10px 14px;border-bottom:1px solid rgba(0,255,65,0.08)}
.dp-section h3{font-size:0.6rem;letter-spacing:0.35em;color:#06ffd8;margin:0 0 8px;text-transform:uppercase;text-shadow:0 0 6px rgba(6,255,216,0.4)}
.dp-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.dp-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}
.dp-btn{background:rgba(0,255,65,0.06);border:1px solid rgba(0,255,65,0.15);color:#b0ffb0;font-family:'Share Tech Mono',monospace;font-size:0.58rem;padding:5px 4px;cursor:pointer;letter-spacing:0.05em;text-align:center;transition:all 0.12s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dp-btn:hover{background:rgba(0,255,65,0.15);border-color:rgba(0,255,65,0.4);color:#00ff41}
.dp-btn.active{background:rgba(0,255,65,0.2);border-color:#00ff41;color:#00ff41;box-shadow:0 0 8px rgba(0,255,65,0.3)}
.dp-btn.fire{background:rgba(255,0,110,0.08);border-color:rgba(255,0,110,0.25);color:#ff80b0}
.dp-btn.fire:hover{background:rgba(255,0,110,0.2);border-color:#ff006e;color:#ff006e}
.dp-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.dp-row label{flex-shrink:0;width:65px;font-size:0.58rem;letter-spacing:0.1em;color:#7acc7a}
.dp-row input[type=range]{flex:1;accent-color:#00ff41;height:3px}
.dp-row .dp-val{flex-shrink:0;width:35px;text-align:right;font-size:0.58rem;color:#00ff41}
.dp-info{padding:8px 14px;font-size:0.55rem;color:rgba(0,255,65,0.35);text-align:center;letter-spacing:0.15em;border-bottom:1px solid rgba(0,255,65,0.08)}
.dp-scene-scroll{max-height:190px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(0,255,65,0.2) transparent}
.dp-badge{display:inline-block;padding:1px 5px;font-size:0.5rem;letter-spacing:0.08em;border-radius:2px;margin-left:4px}
.dp-badge.live{background:rgba(255,0,110,0.2);color:#ff006e;border:1px solid rgba(255,0,110,0.3)}
.dp-monitor{padding:6px 14px;font-size:0.55rem;color:#7acc7a;letter-spacing:0.06em;line-height:1.7;border-bottom:1px solid rgba(0,255,65,0.08);flex-shrink:0}
.dp-monitor span{color:#00ff41}
</style>
</head>
<body>
<div id="cur"></div>
<div class="scanlines"></div>
<canvas id="c0"></canvas><canvas id="c1"></canvas><canvas id="c2"></canvas><canvas id="c3"></canvas>
<div id="login">
  <div id="arcadeScore"><span>1UP &nbsp; 000000</span><span>HI-SCORE &nbsp; ‚àû</span><span>2UP &nbsp; 000000</span></div>
  <canvas id="loginCanvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.35"></canvas>
  <div class="logo">VIZarcade</div>
  <div class="tagline">AI Festival Visual Engine</div>
  <div id="coinDisplay">‚Äî INSERT COIN ‚Äî</div>
  <button id="loginBtn" class="btn">‚ñ∂ &nbsp;CONNECT SPOTIFY</button>
  <button id="appleMusicBtn" class="btn" style="margin-top:10px;background:#fc3c44;box-shadow:0 0 20px rgba(252,60,68,0.7),0 0 40px rgba(252,60,68,0.3);font-size:1.1rem">‚ô´ &nbsp;APPLE MUSIC</button>
  <button id="localAudioBtn" class="btn" style="margin-top:10px;background:#06ffd8;box-shadow:0 0 20px rgba(6,255,216,0.7),0 0 40px rgba(6,255,216,0.3);font-size:1.1rem">üé§ &nbsp;LOCAL AUDIO</button>
  <div id="loginErr"></div>
</div>
<div id="wash"></div>
<div id="surpriseOverlay"></div>
<div id="comicPanel"></div>
<div id="gameOverScreen">GAME OVER</div>
<div id="splash">
  <div id="splashScene"></div>
  <div id="splashTrack"></div>
  <div id="splashArtist"></div>
  <div id="splashDesc"></div>
</div>
<div id="ui">
  <div id="sceneTag">SCENE ENGINE</div>
  <div id="artistName">‚Äî</div>
  <div id="trackName">‚Äî</div>
  <img id="albumArt" src="" alt=""/>
  <div id="pgWrap"><div id="pgBar"></div></div>
</div>
<button id="fsBtn">‚õ∂ FS</button>
<button id="backBtn">‚Üê BACK</button>
<button id="nextSceneBtn">‚ñ∂</button>

<!-- ‚ïê‚ïê‚ïê DEV PANEL ‚ïê‚ïê‚ïê -->
<div id="devPanel">
  <div class="dp-header">
    <h2>‚öô DEV PANEL</h2>
    <button class="dp-close" id="dpClose">‚úï ESC</button>
  </div>
  <div class="dp-monitor" id="dpMonitor">
    Scene: <span id="dpCurScene">‚Äî</span> &nbsp;‚îÇ&nbsp; CP: <span id="dpCurCP">‚Äî</span><br>
    Energy: <span id="dpEnergy">0</span> &nbsp;‚îÇ&nbsp; BPM: <span id="dpBPM">0</span> &nbsp;‚îÇ&nbsp; Beat: <span id="dpBeatCt">0</span><br>
    Prog: <span id="dpProg">0%</span> &nbsp;‚îÇ&nbsp; Surprise: <span id="dpSurprise">‚Äî</span>
  </div>
  <div class="dp-section">
    <h3>‚ñ∏ Jump to Scene</h3>
    <div class="dp-scene-scroll">
      <div class="dp-grid" id="dpSceneGrid"></div>
    </div>
  </div>
  <div class="dp-section">
    <h3>‚ñ∏ Fire Surprise</h3>
    <div class="dp-grid-3" id="dpSurpriseGrid">
      <button class="dp-btn fire" data-var="0">Variant 0</button>
      <button class="dp-btn fire" data-var="1">Variant 1</button>
      <button class="dp-btn fire" data-var="2">Variant 2</button>
    </div>
    <div style="margin-top:6px">
      <button class="dp-btn fire" id="dpFireRandom" style="width:100%">üé≤ Random Surprise</button>
    </div>
  </div>
  <div class="dp-section">
    <h3>‚ñ∏ Centerpiece</h3>
    <div class="dp-scene-scroll" style="max-height:140px">
      <div class="dp-grid-3" id="dpCPGrid"></div>
    </div>
  </div>
  <div class="dp-section">
    <h3>‚ñ∏ Simulated Audio</h3>
    <div class="dp-row"><label>Energy</label><input type="range" id="dpSimEnergy" min="0" max="100" value="60"><span class="dp-val" id="dpSimEnergyVal">0.60</span></div>
    <div class="dp-row"><label>BPM</label><input type="range" id="dpSimBPM" min="60" max="200" value="120"><span class="dp-val" id="dpSimBPMVal">120</span></div>
    <div class="dp-row"><label>Progress</label><input type="range" id="dpSimProg" min="0" max="100" value="0"><span class="dp-val" id="dpSimProgVal">0%</span></div>
    <div style="margin-top:6px;display:flex;gap:4px">
      <button class="dp-btn" id="dpSimToggle" style="flex:1">‚ñ∂ Enable Sim</button>
      <button class="dp-btn" id="dpSimBeat" style="flex:1">‚ö° Manual Beat</button>
    </div>
  </div>
  <div class="dp-section">
    <h3>‚ñ∏ Quick Actions</h3>
    <div class="dp-grid">
      <button class="dp-btn" id="dpFlash">Flash</button>
      <button class="dp-btn" id="dpComicBurst">Comic Burst</button>
      <button class="dp-btn" id="dpShockwave">Shockwave</button>
      <button class="dp-btn" id="dpInvert">Invert</button>
      <button class="dp-btn" id="dpSlam">Bass Slam</button>
      <button class="dp-btn" id="dpGameOver">Game Over</button>
      <button class="dp-btn" id="dpResetHist">Reset History</button>
      <button class="dp-btn" id="dpCycleInfo">Cycle Info</button>
    </div>
  </div>
  <div class="dp-info">Press <span style="color:#ff006e">D D D</span> or <span style="color:#ff006e">?dev=1</span> to toggle</div>
</div>

<script>
// ‚ïê‚ïê‚ïê VIZARCADE ‚Äî Bundled Build ‚ïê‚ïê‚ïê
// Generated by build.py ‚Äî do not edit directly
// Edit source files in src/ and rebuild

// ‚ïê‚ïê MODULE: globals.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê GLOBALS ‚Äî shared state, canvas, helpers ‚ïê‚ïê‚ïê
// Everything imports from here. Mutable state is on the G object.

// ‚îÄ‚îÄ Canvas refs ‚îÄ‚îÄ
const c0 = document.getElementById('c0'), x0 = c0.getContext('2d');
const c1 = document.getElementById('c1'), x1 = c1.getContext('2d');
const c2 = document.getElementById('c2'), x2 = c2.getContext('2d');
const c3 = document.getElementById('c3'), x3 = c3.getContext('2d');
const W = () => c0.width, H = () => c0.height;

function resize() {
  [c0, c1, c2, c3].forEach(c => { c.width = innerWidth; c.height = innerHeight; });
}
resize();

// ‚îÄ‚îÄ Cursor ‚îÄ‚îÄ
const cur = document.getElementById('cur');
document.addEventListener('mousemove', e => {
  cur.style.left = (e.clientX - 4) + 'px';
  cur.style.top = (e.clientY - 4) + 'px';
});

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function lerp(a, b, t) { return a + (b - a) * t; }
function rndEl(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function h2r(h) {
  try { const x = parseInt(h.replace('#', '').slice(0, 6), 16); return { r: (x >> 16) & 255, g: (x >> 8) & 255, b: x & 255 }; }
  catch { return { r: 6, g: 255, b: 216 }; }
}
function rgba(h, a = 1) { const { r, g, b } = h2r(h); return `rgba(${r},${g},${b},${+a.toFixed(3)})`; }
const delay = ms => new Promise(r => setTimeout(r, ms));

// ‚îÄ‚îÄ LocalStorage shortcuts ‚îÄ‚îÄ
const ls = (k, v) => localStorage.setItem(k, v);
const lg = k => localStorage.getItem(k);

// ‚îÄ‚îÄ Mutable shared state (G = globals) ‚îÄ‚îÄ
const THEME = {
  scene: 'WARP_SPEED', label: '', splashDesc: '',
  palette: ['#06ffd8', '#8338ec', '#ff006e', '#ffbe0b'],
  bgColor: '#000010', centerpiece: null, centerpieceScale: 0.5,
  centerpieceBehavior: 'rotate', beatReactions: ['shockwave'],
  sceneSpeed: 1, sceneIntensity: 0.7, energy: 0.5, chaos: 0.3
};
const pc = i => THEME.palette[((i % 4) + 4) % 4];

let aiCache = {};

const MS = { beatInterval: 500, lastBeat: 0, duration: 180000, analysisStart: 0, energy: 0.5 };
const SM = { energy: 0.5, beatPulse: 0 };
let SD = {};
function resetSD() { SD = {}; return SD; }
// Allow external assignment
function setSD(val) { SD = val; }

// These need to be settable from multiple modules
// In module mode: accessed via xxx
// In bundled mode: these become bare let declarations
let token = null, lastTid = null, inTrans = false;
let songProg = 0, progMult = 0.6;
let cpRot = 0, cpPh = 0, cpOrbit = 0;
let cpBounceX = 0, cpBounceY = 0;
let cpBounceVX = 0.7 + (Math.random() - 0.5) * 0.4;
let cpBounceVY = 0.5 + (Math.random() - 0.5) * 0.3;
let cpDriftX = 0, cpDriftY = 0;
let beatReactionIdx = 0, beatCount = 0;
let energyHist = [], surpriseFired = false, surpriseArmed = false, midShifted = false;
let energyPeak = 0, climaxArmed = false;
let gridGlitch = false;
let devSurpriseLock = false;

// state object is an alias layer for module access
// Modules that need to read/write these vars import state and use xxx
// The build script maps xxx back to bare xxx in the bundle
// (state proxy removed ‚Äî bare globals used)

let beatFX = {
  shockwaveR: 0, shockwaveA: 0, crackLines: [],
  invertA: 0, slamS: 1, speedBoost: 0, gravityWave: 0
};

// ‚îÄ‚îÄ Scene & centerpiece lists ‚îÄ‚îÄ
const ALL_SCENES = ['WARP_SPEED', 'LAVA_WORLD', 'CYBER_GRID', 'DEEP_SEA', 'STORM_CHASER', 'JUNGLE_RAVE', 'DISCO_DIMENSION', 'ACID_TRIP', 'SPACE_STATION', 'NEON_CATHEDRAL', 'CLASSIC_ARCADE', 'ELECTRIC_FOREST', 'OMNIA_NIGHTCLUB', 'PIRATE_SHIP', 'JUNKYARD', 'GOTHAM', 'DAY_OF_DEAD', 'CHINESE_DRAGON', 'MOUNT_OLYMPUS', 'SUPER_MARIO', 'ATLANTIS', 'CARNIVAL', 'EGYPTIAN_TOMB'];

const ALL_CPS = ['skull', 'flaming_skull', 'skull_crossbones', 'smiley', 'demon_face', 'alien_head', 'robot_head', 'dragon', 'wolf_head', 'eagle', 'peace_sign', 'lightning_bolt', 'yin_yang', 'star', 'ankh', 'trident', 'flame', 'diamond', 'coffin', 'astronaut', 'rocket', 'ufo', 'vinyl_record', 'disco_ball', 'turntable', 'hourglass', 'crown', 'clock_face', 'chandelier', 'sun', 'moon', 'planet', 'comet', 'black_hole', 'wormhole', 'mandala', 'dna_helix', 'tesseract', 'eye', 'lotus'];

const CP_INTEGRATED_SCENES = new Set(['WARP_SPEED', 'DEEP_SEA', 'STORM_CHASER', 'CARNIVAL', 'JUNKYARD', 'EGYPTIAN_TOMB', 'ELECTRIC_FOREST', 'PIRATE_SHIP', 'ACID_TRIP', 'NEON_CATHEDRAL', 'SPACE_STATION', 'LAVA_WORLD', 'DISCO_DIMENSION', 'CLASSIC_ARCADE', 'GOTHAM', 'DAY_OF_DEAD', 'CHINESE_DRAGON', 'MOUNT_OLYMPUS', 'SUPER_MARIO', 'ATLANTIS', 'JUNGLE_RAVE', 'CYBER_GRID', 'OMNIA_NIGHTCLUB']);




// ‚ïê‚ïê MODULE: auth.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê AUTH ‚Äî Spotify OAuth PKCE ‚ïê‚ïê‚ïê

const CLIENT_ID = 'c4a8270f8bc6453490fc8bf4b9de5c42';
// Redirect URI must match exactly what's in the Spotify Developer Dashboard
const REDIR = location.origin + '/callback';
const SCOPE = 'user-read-currently-playing user-read-playback-state';

function rnd(n) {
  const a = new Uint8Array(n);
  crypto.getRandomValues(a);
  return btoa(String.fromCharCode(...a)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '').slice(0, n);
}

async function sha256b64(s) {
  const d = new TextEncoder().encode(s);
  const h = await crypto.subtle.digest('SHA-256', d);
  return btoa(String.fromCharCode(...new Uint8Array(h))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function showErr(msg) {
  const el = document.getElementById('loginErr');
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('loginBtn').textContent = '‚ñ∂  TRY AGAIN';
}

async function doLogin() {
  try {
    showErr('Connecting to Spotify‚Ä¶');
    const v = rnd(64);
    const c = await sha256b64(v);
    ls('pv', v);
    const url = 'https://accounts.spotify.com/authorize?' + new URLSearchParams({
      client_id: CLIENT_ID, response_type: 'code', redirect_uri: REDIR,
      scope: SCOPE, code_challenge_method: 'S256', code_challenge: c, show_dialog: 'true'
    });
    console.log('[auth] login ‚Äî redirect_uri=' + REDIR);
    // Use window.location.assign for better iOS compatibility
    window.location.assign(url);
  } catch (e) {
    showErr('Login error: ' + (e.message || e));
    console.error('[auth] doLogin failed:', e);
  }
}

async function exchToken(code) {
  const v = lg('pv');
  console.log('[auth] exchToken code=' + code.slice(0, 8) + ' verifier=' + (v ? 'ok' : 'MISSING'));
  if (!v) { showErr('Auth error: session data lost. Try again.'); return null; }
  try {
    const r = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code, redirect_uri: REDIR, code_verifier: v })
    });
    const d = await r.json();
    console.log('[auth] token response:', r.status, Object.keys(d).join(','));
    if (d.access_token) {
      ls('at', d.access_token); ls('ats', Date.now());
      if (d.refresh_token) ls('rt', d.refresh_token);
      localStorage.removeItem('pv');
      return d.access_token;
    }
    showErr('Spotify error: ' + (d.error_description || d.error || 'unknown'));
    return null;
  } catch (e) {
    showErr('Token exchange failed: ' + (e.message || e));
    return null;
  }
}

async function refreshAT() {
  const rt = lg('rt'); if (!rt) return null;
  try {
    const r = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'refresh_token', refresh_token: rt })
    });
    const d = await r.json();
    if (d.access_token) { ls('at', d.access_token); ls('ats', Date.now()); return d.access_token; }
  } catch (e) { console.warn('[auth] refresh failed:', e); }
  return null;
}

function getAT() {
  const t = lg('at'), s = parseInt(lg('ats') || 0);
  return t && Date.now() - s < 3500000 ? t : null;
}

function logout() {
  ls('at', '');
  document.getElementById('login').style.display = 'flex';
  document.getElementById('ui').style.display = 'none';
  document.getElementById('fsBtn').style.display = 'none';
}


// ‚ïê‚ïê MODULE: particles.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê PARTICLE FACTORIES ‚ïê‚ïê‚ïê


function mkEmber(init) { return { x: Math.random() * W(), y: init ? Math.random() * H() : H() + 10, vx: (Math.random() - 0.5) * 2, vy: -(Math.random() * 3 + 1), r: Math.random() * 4 + 1, life: Math.random() * 0.6 + 0.4, ci: Math.floor(Math.random() * 2) }; }
function mkEruption() { return { x: Math.random() * W(), particles: Array.from({ length: 35 }, () => ({ vx: (Math.random() - 0.5) * 10, vy: -(Math.random() * 14 + 6), life: 1, ci: Math.floor(Math.random() * 2) })), life: 1 }; }
function mkDeepCreature(w, h) { return { x: -200, y: Math.random() * (h || H()) * 0.8 + ((h || H()) * 0.05), vx: Math.random() * 0.8 + 0.2, sz: Math.random() * 180 + 60, type: Math.floor(Math.random() * 4), ci: Math.floor(Math.random() * 4), ph: Math.random() * Math.PI * 2, tentacles: Array.from({ length: 8 }, () => ({ ph: Math.random() * Math.PI * 2, len: Math.random() * 0.8 + 0.4 })) }; }
function mkJungleCreature(w, h) { return { x: (w || W()) + 100, y: ((h || H()) * 0.3) + Math.random() * (h || H()) * 0.4, vx: -(Math.random() * 1 + 0.3), sz: Math.random() * 120 + 60, type: Math.floor(Math.random() * 3), ci: Math.floor(Math.random() * 4), ph: Math.random() * Math.PI * 2 }; }
function mkSpark(init) { return { x: Math.random() * W(), y: init ? Math.random() * H() : (H() * 0.4 + Math.random() * H() * 0.3), vx: (Math.random() - 0.5) * 6, vy: -(Math.random() * 8 + 2), life: Math.random() * 0.6 + 0.2, ci: Math.floor(Math.random() * 2) }; }
function mkCannonball() { return { x: W() * 0.15 + Math.random() * W() * 0.1, y: H() * 0.55, vx: Math.random() * 8 + 4, vy: -(Math.random() * 4 + 2), r: 8, life: 1 }; }
function mkLightning() { const w = W(), h = H(); let x2 = Math.random() * w, y2 = 0; const segs = []; while (y2 < h) { const dy = Math.random() * 50 + 20, dx = (Math.random() - 0.5) * 80; segs.push({ x1: x2, y1: y2, x2: x2 + dx, y2: y2 + dy }); x2 += dx; y2 += dy; } return { segs, life: 1, ci: Math.floor(Math.random() * 4) }; }
function mkBolt() { const w = W(), h = H(), cx = w / 2 + (Math.random() - 0.5) * w * 0.4; return { x: cx, y: -50, vx: (Math.random() - 0.5) * 3, vy: Math.random() * 8 + 5, size: Math.random() * 30 + 15, ci: Math.floor(Math.random() * 4), life: 1 }; }
function mkDebris() { const a = Math.random() * Math.PI * 2, spd = Math.random() * 5 + 2; return { x: Math.random() * W(), y: Math.random() * H(), vx: Math.cos(a) * spd, vy: Math.sin(a) * spd, rot: Math.random() * Math.PI * 2, rotS: (Math.random() - 0.5) * 0.2, sz: Math.random() * 30 + 5, ci: Math.floor(Math.random() * 4), type: Math.floor(Math.random() * 3) }; }




// ‚ïê‚ïê MODULE: variety.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê VARIETY ‚Äî scene/CP rotation, weights, history ‚ïê‚ïê‚ïê


const CP_NO_REPEAT = 25;
const SCENE_NO_REPEAT = 15;

function loadJ(k, def) { try { return JSON.parse(lg(k) || 'null') || def; } catch { return def; } }

let sceneHist = loadJ('sw_sh', []);
let cpHist = loadJ('sw_ch', []);
let sceneLastSeen = loadJ('sw_ls', {});
let songCount = parseInt(lg('sw_n') || 0);
let sessionStreak = parseInt(lg('sw_ss') || 0);
if (Date.now() - parseInt(lg('sw_st') || 0) > 3600000) { sessionStreak = 0; ls('sw_ss', '0'); }
let sceneWeights = loadJ('sw_wt', {});
let sceneCycle = loadJ('sw_cyc', []);

function getSceneShortlist() {
  let eligible = ALL_SCENES.filter(s => !sceneCycle.includes(s));
  if (eligible.length === 0) { sceneCycle = []; ls('sw_cyc', '[]'); eligible = ALL_SCENES.slice(); }
  const weighted = [];
  for (const s of eligible) {
    const w = Math.max(1, sceneWeights[s] || 1);
    for (let i = 0; i < w; i++) weighted.push(s);
  }
  const seen = new Set(); const shortlist = [];
  const arr = weighted.slice();
  for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
  for (const s of arr) { if (!seen.has(s)) { seen.add(s); shortlist.push(s); } }
  return shortlist;
}

function updateSceneWeights(chosen) {
  for (const s of ALL_SCENES) { sceneWeights[s] = (sceneWeights[s] || 1) + (s === chosen ? 0 : 1); }
  sceneWeights[chosen] = 1;
  ls('sw_wt', JSON.stringify(sceneWeights));
}

function getForbidCPs() { return cpHist.slice(-CP_NO_REPEAT); }

function recordScene(s) {
  updateSceneWeights(s);
  sceneHist.push(s); if (sceneHist.length > 40) sceneHist.shift();
  sceneLastSeen[s] = songCount;
  ls('sw_sh', JSON.stringify(sceneHist)); ls('sw_ls', JSON.stringify(sceneLastSeen));
  if (!sceneCycle.includes(s)) sceneCycle.push(s);
  ls('sw_cyc', JSON.stringify(sceneCycle));
  songCount++; ls('sw_n', songCount);
  sessionStreak++; ls('sw_ss', sessionStreak); ls('sw_st', Date.now());
}

function recordCP(c) {
  if (!c) return;
  cpHist.push(c); if (cpHist.length > 50) cpHist.shift();
  ls('sw_ch', JSON.stringify(cpHist));
}

function enforceScene(s, shortlist) {
  if (shortlist.includes(s)) return s;
  return shortlist[0] || s;
}

function enforceCP(c) {
  if (!c) return null;
  const forbidden = getForbidCPs();
  if (!ALL_CPS.includes(c) || forbidden.includes(c)) {
    const available = ALL_CPS.filter(x => !forbidden.includes(x));
    return available.length > 0 ? rndEl(available) : c;
  }
  return c;
}

function resetHistory() {
  sceneHist = []; cpHist = []; sceneLastSeen = {}; sceneCycle = []; sceneWeights = {};
  ls('sw_sh', '[]'); ls('sw_ch', '[]'); ls('sw_ls', '{}'); ls('sw_cyc', '[]'); ls('sw_wt', '{}');
  songCount = 0; ls('sw_n', '0');
}




// ‚ïê‚ïê MODULE: initScene.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê SCENE INIT ‚ïê‚ïê‚ïê



// SD is a mutable object ‚Äî we clear its keys rather than reassigning
// This allows all modules that import SD to see the same object


function initScene(){
  Object.keys(SD).forEach(k => delete SD[k]);
  const w=W(),h=H(),sc=THEME.scene;
  if(sc==='WARP_SPEED'||sc==='SPACE_STATION')SD.stars=Array.from({length:500},()=>({x:(Math.random()-0.5)*2,y:(Math.random()-0.5)*2,z:Math.random(),ci:Math.floor(Math.random()*4),trail:[]}));
  if(sc==='LAVA_WORLD'){SD.embers=Array.from({length:200},()=>mkEmber(true));SD.eruptions=[];}
  if(sc==='CYBER_GRID'){SD.gridZ=0;SD.buildings=Array.from({length:30},(_,i)=>({x:(i%6-2.5)*w*0.18,h:Math.random()*h*0.6+h*0.15,w:Math.random()*80+30,z:i/30,ci:i%4}));SD.dataStreams=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,speed:Math.random()*4+2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='DEEP_SEA'){SD.creatures=Array.from({length:5},()=>mkDeepCreature(w,h));SD.plankton=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*3+0.5,vy:-(Math.random()*0.4+0.1),vx:(Math.random()-0.5)*0.3,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}));}
  if(sc==='STORM_CHASER'){SD.debris=Array.from({length:80},()=>mkDebris());SD.lightnings=[];SD.ltTimer=0;SD.tornadoA=0;}
  if(sc==='JUNGLE_RAVE'){SD.plants=Array.from({length:25},(_,i)=>({x:w*(i/24),sz:Math.random()*150+60,ph:Math.random()*Math.PI*2,ci:i%4,type:i%3,glowMult:1}));SD.creatures=Array.from({length:3},()=>mkJungleCreature(w,h));SD.spores=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.8,vy:-(Math.random()*0.5+0.1),r:Math.random()*4+1,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='DISCO_DIMENSION'){SD.tileZ=0;SD.chandeliers=Array.from({length:3},(_,i)=>({x:w*(0.2+i*0.3),y:h*0.05,rot:Math.random()*Math.PI*2,rotS:0.006+Math.random()*0.01,size:Math.random()*80+60,drop:false}));SD.beams=Array.from({length:20},()=>({x:Math.random()*w,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='ACID_TRIP'){SD.fracPh=0;SD.colorCyc=0;SD.warpGrid=[];for(let gx=0;gx<=20;gx++)for(let gy=0;gy<=14;gy++)SD.warpGrid.push({gx,gy,ph:Math.random()*Math.PI*2});}
  if(sc==='SPACE_STATION'){SD.debris=Array.from({length:12},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.3,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.01,sz:Math.random()*40+10,ci:Math.floor(Math.random()*4)}));}
  // NEON_CATHEDRAL self-initializes via SD.cath in drawNeonCathedral
  if(sc==='CLASSIC_ARCADE'){SD.pixels=Array.from({length:200},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:(Math.random()-0.5)*2,size:Math.floor(Math.random()*3+1)*8,ci:Math.floor(Math.random()*4),type:Math.floor(Math.random()*4)}));SD.scanLine=0;SD.mazeLines=Array.from({length:20},()=>{const mx=Math.random()*w,my=Math.random()*h;return{x1:mx,y1:my,x2:mx+(Math.random()-0.5)*200,y2:my+(Math.random()-0.5)*200,ci:Math.floor(Math.random()*4)};});}
  if(sc==='ELECTRIC_FOREST'){SD.ef={trees:[],lasers:[],fairies:Array.from({length:30},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.8,vy:(Math.random()-0.5)*0.5,r:Math.random()*3+1.5,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)})),laserOverload:false,laserOverloadTimer:0,monkeySwarm:false,monkeySwarmTimer:0,monkeys:[],windstorm:false,windstormTimer:0};
  // Build solid trees flanking each side (4-6 per side)
  const treeSide=(side,count)=>{for(let i=0;i<count;i++){const spread=0.05+i*0.08;SD.ef.trees.push({x:side<0?w*spread:w*(1-spread),side,trunkW:18+Math.random()*12,trunkH:h*(0.55+Math.random()*0.15),ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,glowMult:1,swayOffset:0});}};
  treeSide(-1,5);treeSide(1,5);
  // Lasers from above centerpiece
  for(let i=0;i<14;i++)SD.ef.lasers.push({angle:Math.random()*Math.PI*2,speed:0.008+Math.random()*0.015,ci:i%4,width:1+Math.random()*1.5});}
  if(sc==='OMNIA_NIGHTCLUB'){SD.crowdPeople=Array.from({length:60},()=>({x:Math.random()*w,y:h*0.55+Math.random()*h*0.35,ph:Math.random()*Math.PI*2,sz:Math.random()*25+15,ci:Math.floor(Math.random()*4)}));SD.chandelierY=h*0.05;SD.chandelierRot=0;SD.beams=Array.from({length:24},(_,i)=>({angle:i/24*Math.PI*2,ci:i%4,ph:Math.random()*Math.PI*2,len:Math.random()*h*0.5+h*0.3}));}
  if(sc==='PIRATE_SHIP'){SD.waves=Array.from({length:5},(_,i)=>({ph:Math.random()*Math.PI*2,speed:0.002+i*0.001,amp:30+i*15}));SD.cannonballs=[];SD.stars=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h*0.45,br:Math.random()}));SD.seagulls=Array.from({length:6},()=>({x:Math.random()*w,y:Math.random()*h*0.3,vx:Math.random()*1.5+0.5,ph:0}));}
  if(sc==='JUNKYARD'){SD.sparks=Array.from({length:60},()=>mkSpark(true));SD.arms=Array.from({length:4},(_,i)=>({x:w*(0.15+i*0.23),baseY:h*0.6,angle:-Math.PI*0.6,targetAngle:-Math.PI*0.4,speed:0.02+i*0.005,sz:Math.random()*80+60,ci:i%4}));SD.carStacks=Array.from({length:8},(_,i)=>({x:i/7,cars:Math.floor(Math.random()*3+2),ci:i%4}));}
  if(sc==='GOTHAM'){SD.cityBuildings=Array.from({length:20},(_,i)=>({x:i*w/19,h:Math.random()*h*0.55+h*0.1,w:Math.random()*60+25,ci:i%4,windows:[]}));SD.cityBuildings.forEach(b=>{for(let wy=5;wy<b.h;wy+=18)for(let wx=4;wx<b.w-4;wx+=14)if(Math.random()<0.6)b.windows.push({x:wx,y:wy,on:Math.random()<0.8});});SD.spotlightA=0;}
  if(sc==='DAY_OF_DEAD'){SD.petals=Array.from({length:120},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.5,vy:Math.random()*1.5+0.3,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.05,sz:Math.random()*10+4,ci:Math.floor(Math.random()*4)}));SD.candles=Array.from({length:12},(_,i)=>({x:w*(i/11),flicker:Math.random()*Math.PI*2,sz:Math.random()*15+10}));SD.skulls=Array.from({length:6},(_,i)=>({x:w*(0.1+i*0.16),y:h*0.4+Math.random()*h*0.2,ph:Math.random()*Math.PI*2,sz:Math.random()*40+25,ci:i%4}));}
  if(sc==='CHINESE_DRAGON'){SD.dragonEmerge=0;SD.fog=Array.from({length:8},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*150+80,ph:Math.random()*Math.PI*2,speed:0.001+Math.random()*0.002}));}
  if(sc==='MOUNT_OLYMPUS'){SD.lightnings=[];SD.ltTimer=0;SD.clouds=Array.from({length:8},()=>({x:Math.random()*w,y:Math.random()*h*0.6,r:Math.random()*120+60,vx:(Math.random()-0.5)*0.3,ci:Math.floor(Math.random()*2)}));SD.boltsComing=[];SD.zeusFace={alpha:0,scale:0.3};}
  if(sc==='SUPER_MARIO'){SD.platforms=Array.from({length:12},(_,i)=>({x:i*w/11,y:h*0.4+Math.sin(i)*h*0.2,w:Math.random()*120+60}));SD.coins=Array.from({length:20},()=>({x:Math.random()*w,y:Math.random()*h*0.7,ph:0}));SD.goombas=Array.from({length:5},()=>({x:Math.random()*w,y:h*0.75,vx:(Math.random()-0.5)*2}));SD.scrollX=0;SD.pipes=Array.from({length:4},(_,i)=>({x:w*(0.15+i*0.23),h:Math.random()*h*0.25+h*0.1}));}
  if(sc==='ATLANTIS'){SD.fish=Array.from({length:30},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.5,vy:(Math.random()-0.5)*0.5,sz:Math.random()*20+8,ci:Math.floor(Math.random()*4)}));SD.bubbles=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*8+2,vy:-(Math.random()*0.8+0.2),ph:Math.random()*Math.PI*2}));SD.ruins=Array.from({length:10},(_,i)=>({x:i/9,h:Math.random()*h*0.4+h*0.1,w:Math.random()*80+30,ci:i%4}));SD.lightShafts=Array.from({length:6},(_,i)=>({x:w*(0.05+i*0.18),ph:Math.random()*Math.PI*2}));}
  if(sc==='CARNIVAL'){SD.ferrisSegs=Array.from({length:12},(_,i)=>({angle:i/12*Math.PI*2,ci:i%4}));SD.ferrisRot=0;SD.confetti=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:Math.random()*2+0.5,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.1,sz:Math.random()*8+3,ci:Math.floor(Math.random()*4)}));}
  if(sc==='EGYPTIAN_TOMB'){SD.hieroglyphs=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,char:Math.floor(Math.random()*12),ci:Math.floor(Math.random()*4),alpha:Math.random()*0.5+0.2}));SD.torches=Array.from({length:6},(_,i)=>({x:(i/5)*0.9+0.05,ph:Math.random()*Math.PI*2}));SD.tunnelZ=0;SD.traps=[];}
  beatFX={shockwaveR:0,shockwaveA:0,crackLines:[],invertA:0,slamS:1,speedBoost:0,gravityWave:0};
  energyHist=[];surpriseFired=false;surpriseArmed=false;midShifted=false;energyPeak=0;climaxArmed=false;beatReactionIdx=0;beatCount=0;cpRot=0;cpPh=0;cpOrbit=0;cpBounceX=0;cpBounceY=0;cpBounceVX=0.7+(Math.random()-0.5)*0.4;cpBounceVY=0.5+(Math.random()-0.5)*0.3;cpDriftX=0;cpDriftY=0;
}




// ‚ïê‚ïê MODULE: scenes (individual files) ‚ïê‚ïê
// ‚ïê‚ïê‚ïê SCENE RENDERERS ‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê SCENE: warpSpeed ‚ïê‚ïê‚ïê

function drawWarpSpeed(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(!SD.stars)return;
  const spd=THEME.sceneSpeed*(0.6+progMult*0.5)*(1+SM.energy)*(1+beatFX.speedBoost*1.5);
  for(const s of SD.stars){
    s.z-=0.0018*spd;if(s.z<0.01){s.z=1;s.x=(Math.random()-0.5)*2;s.y=(Math.random()-0.5)*2;s.trail=[];}
    const px=cx+(s.x/s.z)*cx,py=cy+(s.y/s.z)*cy;
    if(px<-30||px>w+30||py<-30||py>h+30)continue;
    const sz=(1-s.z)*6+0.3;
    if(s.trail.length>1){x0.beginPath();x0.moveTo(s.trail[0].x,s.trail[0].y);for(let i=1;i<s.trail.length;i++)x0.lineTo(s.trail[i].x,s.trail[i].y);x0.lineTo(px,py);x0.strokeStyle=rgba(pc(s.ci),(1-s.z)*0.6);x0.lineWidth=sz*0.5;x0.stroke();}
    s.trail.push({x:px,y:py});if(s.trail.length>8)s.trail.shift();
    x0.beginPath();x0.arc(px,py,sz,0,Math.PI*2);x0.fillStyle=rgba(pc(s.ci),(1-s.z)*0.95);x0.shadowBlur=sz*3;x0.shadowColor=pc(s.ci);x0.fill();x0.shadowBlur=0;
  }
  // INTEGRATED: centerpiece grows from vanishing point ‚Äî you're flying toward it
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.007*(1+SM.energy*0.2);
    const appr=Math.min(0.9,0.04+songProg*0.6+SM.beatPulse*0.1);
    const targetSz=Math.min(w,h)*appr*0.85;
    const ag=x0.createRadialGradient(cx,cy,0,cx,cy,targetSz*1.8);
    ag.addColorStop(0,rgba(pc(0),0.1*(1+SM.beatPulse)));ag.addColorStop(1,'transparent');
    x0.fillStyle=ag;x0.beginPath();x0.arc(cx,cy,targetSz*1.8,0,Math.PI*2);x0.fill();
    x0.globalAlpha=Math.min(1,appr*2.2);
    drawCPMini(x0,THEME.centerpiece,cx,cy,targetSz,cpRot);
    x0.globalAlpha=1;
  }
}


// ‚ïê‚ïê‚ïê SCENE: lavaWorld ‚ïê‚ïê‚ïê

function fireLavaBalls(){
  if(!SD.lavaBalls)SD.lavaBalls=[];
  const w=W(),h=H();
  const fromLeft=Math.random()<0.5;
  const startX=fromLeft?w*0.35:w*0.72;
  const startY=h*0.36;
  const count=2+Math.floor(Math.random()*3);
  for(let i=0;i<count;i++){
    const angle=-Math.PI*0.6+Math.random()*Math.PI*0.35;
    const speed=4+Math.random()*5;
    SD.lavaBalls.push({x:startX,y:startY,vx:Math.cos(angle)*speed*(fromLeft?1:-1),vy:Math.sin(angle)*speed,sz:18+Math.random()*22,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.15,life:1,ci:Math.floor(Math.random()*2)});
  }
}

function drawLavaWorld(t){
  const w=W(),h=H(),cx=w/2;
  // Sky ‚Äî deep red/orange gradient, darkens at top
  const sky=x0.createLinearGradient(0,0,0,h);
  sky.addColorStop(0,'rgba(10,0,0,1)');
  sky.addColorStop(0.4,rgba(pc(0),0.5));
  sky.addColorStop(0.7,rgba(pc(1),0.6));
  sky.addColorStop(1,'rgba(255,40,0,0.0)');
  x0.fillStyle=sky;x0.fillRect(0,0,w,h);
  // Ash particles drifting
  if(!SD.ashParts){SD.ashParts=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.4,vy:-(Math.random()*0.5+0.1),r:Math.random()*2.5+0.5,ph:Math.random()*Math.PI*2}));}
  for(const a of SD.ashParts){a.x+=a.vx;a.y+=a.vy;a.ph+=0.02;if(a.y<-5){a.y=h+5;a.x=Math.random()*w;}x0.fillStyle=`rgba(80,60,50,${0.25+Math.sin(a.ph)*0.15})`;x0.beginPath();x0.arc(a.x+Math.sin(a.ph)*2,a.y,a.r,0,Math.PI*2);x0.fill();}
  // Volcano silhouette ‚Äî black mountain on left/right
  x0.fillStyle='rgba(5,2,2,0.97)';
  x0.beginPath();x0.moveTo(0,h);x0.lineTo(w*0.28,h*0.36);x0.lineTo(w*0.35,h*0.38);x0.lineTo(w*0.42,h*0.36);x0.lineTo(w*0.55,h);x0.closePath();x0.fill();
  x0.beginPath();x0.moveTo(w*0.5,h);x0.lineTo(w*0.65,h*0.45);x0.lineTo(w*0.72,h*0.42);x0.lineTo(w*0.79,h*0.44);x0.lineTo(w,h);x0.closePath();x0.fill();
  // Volcano crater glow
  const cg=x0.createRadialGradient(w*0.35,h*0.36,0,w*0.35,h*0.36,w*0.08*(1+SM.beatPulse*0.4));
  cg.addColorStop(0,rgba(pc(0),0.9*(1+SM.beatPulse*0.3)));cg.addColorStop(0.5,rgba(pc(1),0.4));cg.addColorStop(1,'transparent');
  x0.fillStyle=cg;x0.fillRect(0,0,w,h);
  // Lava rivers ‚Äî flowing lava layers
  for(let lv=0;lv<4;lv++){
    x0.beginPath();
    for(let px=0;px<=w;px+=4){const py=h*(0.62+lv*0.07)+Math.sin(px*0.008+t*0.0015+lv*1.2)*18+Math.sin(px*0.025+t*0.002)*8;px===0?x0.moveTo(px,py):x0.lineTo(px,py);}
    x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();
    const lg=x0.createLinearGradient(0,h*0.62,0,h);
    const c0h=h2r(pc(0)),c1h=h2r(pc(1));
    lg.addColorStop(0,`rgba(${c0h.r},${c0h.g},${c0h.b},${0.8*(1+SM.beatPulse*0.15)})`);
    lg.addColorStop(0.4,`rgba(255,${80+lv*20},0,0.75)`);
    lg.addColorStop(1,'rgba(80,0,0,0.9)');
    x0.fillStyle=lg;x0.fill();
    // Lava surface shimmer
    x0.strokeStyle=`rgba(255,${150-lv*20},0,0.3)`;x0.lineWidth=1.5;
  }
  // Embers
  if(!SD.embers)SD.embers=Array.from({length:50},()=>mkEmber(true));
  for(let i=SD.embers.length-1;i>=0;i--){const e=SD.embers[i];e.x+=e.vx;e.y+=e.vy*(1+SM.energy*0.4);e.life-=0.004;if(e.life<=0||e.y<-20){SD.embers[i]=mkEmber(false);continue;}x0.beginPath();x0.arc(e.x,e.y,e.r*e.life,0,Math.PI*2);x0.fillStyle=rgba(pc(e.ci),e.life*0.9);x0.shadowBlur=8;x0.shadowColor=pc(e.ci);x0.fill();x0.shadowBlur=0;}
  // Eruptions ‚Äî centerpiece-shaped lava balls arc through sky
  if(!SD.eruptions)SD.eruptions=[];
  if(!SD.lavaBalls)SD.lavaBalls=[];
  // Periodic auto-eruption
  SD.eruptTimer=(SD.eruptTimer||0)+16;
  if(SD.eruptTimer>3000+Math.random()*2000){SD.eruptTimer=0;fireLavaBalls();}
  // Lava balls in flight
  for(let i=SD.lavaBalls.length-1;i>=0;i--){
    const lb=SD.lavaBalls[i];
    lb.vx*=0.99;lb.vy+=0.18; // gravity
    lb.x+=lb.vx;lb.y+=lb.vy;
    lb.rot+=lb.rotS;lb.life-=0.008;
    if(lb.life<=0||lb.y>h+50){SD.lavaBalls.splice(i,1);continue;}
    // Draw as mini centerpiece with lava glow
    x0.shadowBlur=lb.sz*0.8;x0.shadowColor=rgba(pc(0),0.9);
    x0.globalAlpha=lb.life*0.9;
    drawCPMini(x0,THEME.centerpiece||'flame',lb.x,lb.y,lb.sz,lb.rot);
    x0.globalAlpha=1;x0.shadowBlur=0;
    // Drip trail
    x0.fillStyle=rgba(pc(1),lb.life*0.4);x0.beginPath();x0.arc(lb.x,lb.y+lb.sz*0.6,lb.sz*0.2,0,Math.PI*2);x0.fill();
  }
  // Old eruption particles
  for(let i=SD.eruptions.length-1;i>=0;i--){const er=SD.eruptions[i];er.life-=0.015;for(const p of er.particles){p.vx*=0.98;p.vy+=0.25;p.life-=0.018;if(p.life>0){x0.beginPath();x0.arc(er.x+p.vx*(1-p.life)*20,er.y-p.vy*(1-p.life)*20,p.life*5,0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),p.life*0.85);x0.shadowBlur=6;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}}if(er.life<=0)SD.eruptions.splice(i,1);}
}


// ‚ïê‚ïê‚ïê SCENE: cyberGrid ‚ïê‚ïê‚ïê

function drawCyberGrid(t){
  var w=W(),h=H(),beat=SM.beatPulse,energy=SM.energy;
  var HZ=h*0.66;
  var roadH=h-HZ;

  if(!SD.cyberGrid){
    SD.cyberGrid={
      gp:0,
      glitching:false,glitchTimer:0,speedBoost:1,speedTimer:0,
      spiral:false,spiralTimer:0,spiralAngle:0,
      spawnTimer:0,
      objs:[],
      tronStreaks:Array.from({length:9},function(_,i){return {x:Math.random()*w,y:Math.random()*HZ,dirX:Math.random()<0.5?1:-1,dirY:0,speed:2+Math.random()*3,ci:i%4,alpha:0.5+Math.random()*0.4,width:4+Math.random()*5,trail:[],maxTrail:30+Math.floor(Math.random()*30),turnTimer:80+Math.floor(Math.random()*120)};})
    };
    SD.cyberGrid.objs.push({side:Math.random()<0.5?1:-1,d:-0.05-Math.random()*0.1,dodged:false,dead:false,driftX:0,driftSpeed:0,type:Math.floor(Math.random()*3),ci:Math.floor(Math.random()*4)});
  }
  var CG=SD.cyberGrid;

  // Surprise timers
  if(CG.glitchTimer>0){CG.glitchTimer-=16;if(CG.glitchTimer<=0)CG.glitching=false;}
  if(CG.speedTimer>0){CG.speedTimer-=16;if(CG.speedTimer<=0)CG.speedBoost=1;}
  if(CG.spiralTimer>0){CG.spiralTimer-=16;CG.spiralAngle+=0.04+energy*0.02;if(CG.spiralTimer<=0)CG.spiral=false;}
  var corruption=songProg*0.3;
  var spd=CG.speedBoost*(1+energy*0.3)*progMult*THEME.sceneSpeed;

  // Spawn timer ‚Äî evenly spaced objects
  CG.spawnTimer+=spd*0.012;
  if(CG.spawnTimer>0.5){
    CG.spawnTimer=0;
    var hasApproaching=false;
    for(var si=0;si<CG.objs.length;si++){if(!CG.objs[si].dead&&!CG.objs[si].dodged){hasApproaching=true;break;}}
    if(!hasApproaching){
      CG.objs.push({side:Math.random()<0.5?1:-1,d:-0.05-Math.random()*0.1,dodged:false,dead:false,driftX:0,driftSpeed:0,type:Math.floor(Math.random()*3),ci:Math.floor(Math.random()*4)});
    }
  }

  // ‚îÄ‚îÄ BG ‚îÄ‚îÄ
  x0.fillStyle='rgba(0,2,12,1)';x0.fillRect(0,0,w,h);
  var skyG=x0.createLinearGradient(0,0,0,HZ);
  skyG.addColorStop(0,'rgba(0,0,20,1)');skyG.addColorStop(1,'rgba(0,10,40,0.8)');
  x0.fillStyle=skyG;x0.fillRect(0,0,w,HZ);

  // ‚îÄ‚îÄ Tron streaks (sky) ‚îÄ‚îÄ
  for(var tsi=0;tsi<CG.tronStreaks.length;tsi++){
    var ts=CG.tronStreaks[tsi];
    ts.turnTimer--;if(ts.turnTimer<=0){if(ts.dirX!==0){ts.dirY=Math.random()<0.5?1:-1;ts.dirX=0;}else{ts.dirX=Math.random()<0.5?1:-1;ts.dirY=0;}ts.turnTimer=40+Math.floor(Math.random()*100);}
    var sp2=ts.speed*(CG.speedBoost*0.5)*(1+beat*0.2);ts.x+=ts.dirX*sp2;ts.y+=ts.dirY*sp2;
    if(ts.x<-20)ts.x=w+20;if(ts.x>w+20)ts.x=-20;if(ts.y<-20)ts.y=HZ;if(ts.y>HZ)ts.y=-20;
    ts.trail.push({x:ts.x,y:ts.y});if(ts.trail.length>ts.maxTrail)ts.trail.shift();if(ts.trail.length<2)continue;
    x0.shadowBlur=12+beat*8;x0.shadowColor=pc(ts.ci);x0.strokeStyle=rgba(pc(ts.ci),(ts.alpha+beat*0.25)*(CG.glitching?1.5:1));
    x0.lineWidth=ts.width*(1+beat*0.4);x0.lineCap='square';x0.lineJoin='miter';
    x0.beginPath();for(var ti=0;ti<ts.trail.length;ti++){if(ti===0)x0.moveTo(ts.trail[ti].x,ts.trail[ti].y);else x0.lineTo(ts.trail[ti].x,ts.trail[ti].y);}x0.stroke();
    x0.shadowBlur=16+beat*10;x0.fillStyle=rgba(pc(ts.ci),0.95+beat*0.05);x0.beginPath();x0.arc(ts.x,ts.y,ts.width*0.8,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
  }
  x0.lineCap='butt';x0.lineJoin='miter';x0.shadowBlur=0;

  // ‚îÄ‚îÄ Glitch surprise ‚îÄ‚îÄ
  if(CG.glitching){var gA2=0.3+Math.random()*0.2;x0.fillStyle=rgba(pc(0),gA2);for(var gi=0;gi<20;gi++)x0.fillRect(0,Math.random()*h,w,Math.random()*35+2);for(var gi2=0;gi2<6;gi2++){x0.fillStyle=rgba(pc(gi2%4),0.08);x0.fillRect(Math.random()*w,0,Math.random()*80+10,h);}}

  // ‚îÄ‚îÄ Horizon line ‚îÄ‚îÄ
  x0.shadowBlur=20+beat*15;x0.shadowColor=pc(0);
  x0.strokeStyle=rgba(pc(0),0.9+beat*0.1);x0.lineWidth=1.5;
  x0.beginPath();x0.moveTo(0,HZ);x0.lineTo(w,HZ);x0.stroke();
  x0.shadowBlur=40+beat*20;x0.shadowColor=pc(1);
  x0.strokeStyle=rgba(pc(1),0.3+beat*0.15);x0.lineWidth=0.8;
  x0.beginPath();x0.moveTo(0,HZ-1);x0.lineTo(w,HZ-1);x0.stroke();
  x0.shadowBlur=0;

  // ‚îÄ‚îÄ Vibrant Grid ‚îÄ‚îÄ
  var ROWS=10,COLS=12;
  CG.gp=(CG.gp+spd*0.012)%1;

  // Horizontal ‚Äî full width
  for(var r=0;r<ROWS;r++){
    var d2=((r/ROWS)+CG.gp)%1;
    var sy=HZ+d2*roadH;
    if(sy<HZ-2)continue;
    var a2=(0.2+d2*0.6)*THEME.sceneIntensity*(1+beat*0.5);
    var ci2=Math.floor(r/2+corruption*8)%4;
    x0.strokeStyle=rgba(pc(ci2),a2);x0.lineWidth=1.5+d2*4;
    x0.shadowBlur=8+d2*20+corruption*12+beat*12;x0.shadowColor=pc(ci2);
    x0.beginPath();x0.moveTo(0,sy);x0.lineTo(w,sy);x0.stroke();
  }
  x0.shadowBlur=0;

  // Vertical ‚Äî perspective convergence
  for(var c=-2;c<=COLS+2;c++){
    var baseX2=(c/COLS)*w;
    var sm2=CG.spiral?Math.sin(CG.spiralAngle+c*0.3)*w*0.02:0;
    var topX2=baseX2*0.6+w*0.2+sm2;
    var botX2=baseX2+sm2;
    if(topX2<-60&&botX2<-60)continue;
    if(topX2>w+60&&botX2>w+60)continue;
    var nx2=Math.abs(c/COLS-0.5)*2;
    x0.beginPath();x0.moveTo(topX2,HZ);x0.lineTo(botX2,h);
    x0.strokeStyle=rgba(pc(1),(nx2<0.15?0.5:0.25)*THEME.sceneIntensity*(1+beat*0.3));
    x0.lineWidth=1;x0.shadowBlur=4+beat*5;x0.shadowColor=pc(1);x0.stroke();
  }
  x0.shadowBlur=0;

  // ‚îÄ‚îÄ Draw obstacle helper ‚îÄ‚îÄ
  function drawObs(sx,sy2,ow,oh,od,oType,oCi){
    var oA=Math.min(1,0.9+beat*0.1);
    var oy=sy2-oh;
    if(oType===0){
      var wG=x0.createLinearGradient(sx-ow/2,oy,sx-ow/2,sy2);
      wG.addColorStop(0,rgba(pc(oCi),oA*0.95));wG.addColorStop(0.5,rgba(pc(oCi),oA*0.85));wG.addColorStop(1,rgba(pc(oCi),oA*0.7));
      x0.fillStyle=wG;x0.fillRect(sx-ow/2,oy,ow,oh);
      x0.strokeStyle=rgba(pc(oCi),oA*0.95);x0.lineWidth=2+od*4;
      x0.shadowBlur=18+od*30+beat*15;x0.shadowColor=pc(oCi);
      x0.strokeRect(sx-ow/2,oy,ow,oh);
      x0.lineWidth=1;x0.strokeStyle=rgba(pc(oCi),oA*0.3);
      var scN=Math.max(1,Math.floor(oh/14));
      for(var s3=0;s3<scN;s3++){var sy3=oy+s3*(oh/scN);x0.beginPath();x0.moveTo(sx-ow/2,sy3);x0.lineTo(sx+ow/2,sy3);x0.stroke();}
      x0.shadowBlur=0;
    }else if(oType===1){
      var pW2=ow*0.08;
      x0.fillStyle=rgba(pc(oCi),oA*0.95);
      x0.shadowBlur=12+od*18+beat*10;x0.shadowColor=pc(oCi);
      x0.fillRect(sx-ow/2,sy2-oh*0.75,pW2,oh*0.75);
      x0.fillRect(sx+ow/2-pW2,sy2-oh*0.75,pW2,oh*0.75);
      var bP2=0.6+Math.sin(t*0.008)*0.3+beat*0.4;
      var bH2=oh*0.18*(1+beat*0.3);
      for(var bl2=0;bl2<3;bl2++){
        x0.fillStyle=rgba(pc((oCi+bl2)%4),oA*0.9*bP2);
        x0.shadowBlur=22+beat*18;x0.shadowColor=pc((oCi+bl2)%4);
        x0.fillRect(sx-ow/2+pW2,sy2-oh*0.6+bl2*bH2*0.4,ow-pW2*2,bH2);
      }
      x0.strokeStyle=rgba(pc(oCi),oA*0.8);x0.lineWidth=1.5+od*2;
      x0.strokeRect(sx-ow/2,sy2-oh*0.75,pW2,oh*0.75);
      x0.strokeRect(sx+ow/2-pW2,sy2-oh*0.75,pW2,oh*0.75);
      x0.shadowBlur=0;
    }else{
      var plW=ow*0.5,plH=oh*1.2;
      var auG=x0.createRadialGradient(sx,sy2-plH*0.5,0,sx,sy2-plH*0.5,plW*1.8);
      auG.addColorStop(0,rgba(pc(oCi),oA*0.3+beat*0.15));auG.addColorStop(1,'transparent');
      x0.fillStyle=auG;x0.fillRect(sx-plW*1.8,sy2-plH-plW,plW*3.6,plH+plW*2);
      var piG=x0.createLinearGradient(sx-plW/2,sy2-plH,sx+plW/2,sy2-plH);
      piG.addColorStop(0,rgba(pc(oCi),oA*0.7));piG.addColorStop(0.3,rgba(pc(oCi),oA*0.95));
      piG.addColorStop(0.7,rgba(pc(oCi),oA*0.95));piG.addColorStop(1,rgba(pc(oCi),oA*0.7));
      x0.fillStyle=piG;x0.fillRect(sx-plW/2,sy2-plH,plW,plH);
      var cw2=plW*0.2,cP=0.5+Math.sin(t*0.01)*0.4+beat*0.5;
      x0.fillStyle=rgba(pc((oCi+1)%4),oA*cP*0.9);
      x0.shadowBlur=20+od*25+beat*15;x0.shadowColor=pc((oCi+1)%4);
      x0.fillRect(sx-cw2/2,sy2-plH*0.9,cw2,plH*0.8);
      x0.strokeStyle=rgba(pc(oCi),oA*0.85);x0.lineWidth=1.5+od*2;
      x0.strokeRect(sx-plW/2,sy2-plH,plW,plH);
      x0.shadowBlur=0;
    }
  }

  // ‚îÄ‚îÄ Objects ‚Äî per-object drift, no shared camera ‚îÄ‚îÄ
  for(var oi=CG.objs.length-1;oi>=0;oi--){
    var ob=CG.objs[oi];
    if(ob.dead){CG.objs.splice(oi,1);continue;}

    ob.d+=spd*0.012;

    // Per-object drift after dodge
    if(ob.dodged){
      ob.driftX+=ob.driftSpeed*spd;
      ob.driftSpeed*=1.02;
    }

    var oY=HZ+ob.d*roadH;
    var oW=w*0.35*Math.max(0,ob.d);
    var oH=h*0.55*Math.max(0,ob.d);
    var oX=w/2+ob.side*w*0.08+ob.driftX;

    var offSide=(oX+oW/2<-40)||(oX-oW/2>w+40);

    if(offSide||ob.d>0.95){
      ob.dead=true;
      continue;
    }

    // Dodge at d=0.3
    if(!ob.dodged&&ob.d>0.3&&ob.d<0.4){
      ob.dodged=true;
      ob.driftSpeed=ob.side*8;
    }

    if(ob.d>0&&oY>=HZ){
      drawObs(oX,oY,oW,oH,ob.d,ob.type,ob.ci);
    }
  }

  // ‚îÄ‚îÄ Centerpiece ‚îÄ‚îÄ
  if(THEME.centerpiece){
    cpRot+=0.012*(1+energy*0.2);cpPh+=0.013;
    var gs2=Math.min(w,h)*(0.09+beat*0.02)*(1+corruption*0.15);
    var cpX2=w/2;
    var cpY2=HZ-h*0.12;
    x0.globalAlpha=0.75+beat*0.15;x0.shadowBlur=12+beat*12;x0.shadowColor=pc(0);
    drawCPMini(x0,THEME.centerpiece,cpX2,cpY2,gs2,cpRot);x0.globalAlpha=1;x0.shadowBlur=0;
  }
}


// ‚ïê‚ïê‚ïê SCENE: deepSea ‚ïê‚ïê‚ïê

function drawDeepSea(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;

  if(!SD.deepSea){
    const types=['jellyfish','whale','octopus','manta','anglerfish','eel','nautilus'];
    const mkCreature=(forceActive)=>{
      const tp=types[Math.floor(Math.random()*types.length)];
      const baseSize=tp==='whale'?0.14+Math.random()*0.12:tp==='manta'?0.1+Math.random()*0.1:tp==='nautilus'?0.05+Math.random()*0.06:0.06+Math.random()*0.1;
      const sz=Math.min(w,h)*baseSize;
      const fromLeft=Math.random()<0.5;
      return{
        x:fromLeft?-sz*2:w+sz*2,
        y:h*(0.08+Math.random()*0.78),
        vx:(0.15+Math.random()*0.35)*(fromLeft?1:-1),
        vy:(Math.random()-0.5)*0.12,
        sz,tp,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,
        alpha:0,targetAlpha:1,
        active:forceActive||false,
        depth:0.3+Math.random()*0.7,
      };
    };
    SD.deepSea={
      creatures:Array.from({length:30},(_,i)=>mkCreature(i<7)),
      mkCreature,
      plankton:Array.from({length:160},()=>({
        x:Math.random()*w,y:Math.random()*h,
        vx:(Math.random()-0.5)*0.25,vy:-(Math.random()*0.3+0.08),
        r:1+Math.random()*3.5,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,
      })),
      bubbles:Array.from({length:50},()=>({
        x:Math.random()*w,y:h+Math.random()*h,
        vy:-(Math.random()*1.2+0.3),r:2+Math.random()*8,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,vx:(Math.random()-0.5)*0.3,
      })),
      causticsPhase:0,
      lightShafts:Array.from({length:7},(_,i)=>({x:w*(0.05+i*0.15),tilt:(Math.random()-0.5)*0.3})),
      superVibrant:false,
      superVibrantTimer:0,
      populationTimer:0,
      bloomPulses:[],
    };
  }
  const DS=SD.deepSea;
  if(DS.superVibrantTimer>0){DS.superVibrantTimer-=16;if(DS.superVibrantTimer<=0)DS.superVibrant=false;}
  const super_=DS.superVibrant;
  const intensityMult=super_?2.5:1;
  const stromboMult=super_?(0.5+Math.sin(t*0.035)*0.5+beat*0.5):1;

  // ‚îÄ‚îÄ Gradually populate as song progresses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  DS.populationTimer+=16;
  if(DS.populationTimer>1500){
    DS.populationTimer=0;
    const targetActive=Math.floor(DS.creatures.length*Math.min(1,(0.22+songProg*0.78)));
    let activeCount=DS.creatures.filter(c=>c.active).length;
    if(activeCount<targetActive){
      const inactive=DS.creatures.filter(c=>!c.active);
      if(inactive.length>0){inactive[0].active=true;inactive[0].alpha=0;}
    }
  }

  // ‚îÄ‚îÄ BG ‚Äî deep ocean gradient ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const bgG=x0.createLinearGradient(0,0,0,h);
  const bc=h2r(pc(2));
  bgG.addColorStop(0,`rgba(${Math.round(bc.r*0.12)},${Math.round(bc.g*0.08)},${Math.round(bc.b*0.3)},1)`);
  bgG.addColorStop(0.5,`rgba(${Math.round(bc.r*0.04)},${Math.round(bc.g*0.03)},${Math.round(bc.b*0.15)},1)`);
  bgG.addColorStop(1,'rgba(0,1,8,1)');
  x0.fillStyle=bgG;x0.fillRect(0,0,w,h);

  // ‚îÄ‚îÄ Caustics ‚Äî shifting light patterns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  DS.causticsPhase+=0.008;
  for(let ca=0;ca<6;ca++){
    const cax=w*(0.08+ca*0.17)+Math.sin(DS.causticsPhase+ca)*w*0.08;
    const cay=h*(0.55+Math.sin(DS.causticsPhase*0.7+ca)*0.18);
    const caG=x0.createRadialGradient(cax,cay,0,cax,cay,w*0.2);
    caG.addColorStop(0,rgba(pc(ca%4),(0.05+beat*0.04)*intensityMult*stromboMult));
    caG.addColorStop(1,'transparent');
    x0.fillStyle=caG;x0.fillRect(0,0,w,h);
  }

  // ‚îÄ‚îÄ Light shafts from surface ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const shaftAlpha=(0.05+songProg*0.06)*intensityMult*stromboMult;
  for(const ls of DS.lightShafts){
    x0.save();x0.globalAlpha=shaftAlpha*(0.7+beat*0.4);
    const shG=x0.createLinearGradient(ls.x,0,ls.x+40,h*0.7);
    const lc=h2r(pc(1));
    shG.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},0.7)`);shG.addColorStop(1,'transparent');
    x0.fillStyle=shG;
    x0.beginPath();x0.moveTo(ls.x,0);x0.lineTo(ls.x+90,0);x0.lineTo(ls.x+180+ls.tilt*220,h*0.7);x0.lineTo(ls.x-90+ls.tilt*220,h*0.7);x0.closePath();x0.fill();x0.restore();
  }

  // ‚îÄ‚îÄ Bloom pulses (during bioluminescent bloom surprise) ‚îÄ
  for(let bi=DS.bloomPulses.length-1;bi>=0;bi--){
    const bp=DS.bloomPulses[bi];
    bp.r+=bp.speed;bp.alpha-=0.004;
    if(bp.alpha<=0){DS.bloomPulses.splice(bi,1);continue;}
    x0.strokeStyle=rgba(pc(bp.ci),bp.alpha*intensityMult);
    x0.lineWidth=2;x0.shadowBlur=15;x0.shadowColor=pc(bp.ci);
    x0.beginPath();x0.arc(bp.x,bp.y,bp.r,0,Math.PI*2);x0.stroke();x0.shadowBlur=0;
  }
  // During bloom, spawn new pulses
  if(super_&&Math.random()<0.15){
    DS.bloomPulses.push({x:Math.random()*w,y:Math.random()*h,r:5,speed:1.5+Math.random()*2,alpha:0.4+Math.random()*0.3,ci:Math.floor(Math.random()*4)});
  }

  // ‚îÄ‚îÄ PLANKTON ‚Äî bioluminescent specks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const p of DS.plankton){
    p.x+=p.vx;p.y+=p.vy*(1+energy*0.2);p.ph+=0.03;
    if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}
    if(p.x<-5||p.x>w+5){p.x=Math.random()*w;}
    const br=(Math.sin(p.ph)*0.4+0.6)*(1+beat*0.3)*stromboMult;
    x0.fillStyle=rgba(pc(p.ci),br*0.6*intensityMult);
    x0.shadowBlur=super_?14:6;x0.shadowColor=pc(p.ci);
    x0.beginPath();x0.arc(p.x,p.y,p.r*(0.7+br*0.4),0,Math.PI*2);x0.fill();x0.shadowBlur=0;
  }

  // ‚îÄ‚îÄ BUBBLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const b of DS.bubbles){
    b.y+=b.vy*(1+energy*0.15);b.x+=b.vx+Math.sin(t*0.0015+b.ph)*0.4;b.ph+=0.02;
    if(b.y<-20){b.y=h+20;b.x=Math.random()*w;}
    x0.strokeStyle=rgba(pc(b.ci),(0.15+beat*0.1)*intensityMult);
    x0.lineWidth=1;x0.shadowBlur=super_?8:3;x0.shadowColor=pc(b.ci);
    x0.beginPath();x0.arc(b.x,b.y,b.r*(super_?1.5:1),0,Math.PI*2);x0.stroke();
    // Bubble highlight
    x0.fillStyle=rgba(pc(b.ci),0.15);
    x0.beginPath();x0.arc(b.x-b.r*0.25,b.y-b.r*0.25,b.r*0.25,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;
  }

  // ‚îÄ‚îÄ CREATURES ‚Äî majestic, detailed, gliding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Sort by depth so farther creatures draw first
  const sortedCreatures=DS.creatures.filter(c=>c.active).sort((a,b)=>a.depth-b.depth);
  for(const cr of sortedCreatures){
    // Slow, graceful movement
    cr.x+=cr.vx*(0.6+energy*0.15);
    cr.y+=cr.vy+Math.sin(t*0.0006+cr.ph)*0.15;
    cr.ph+=0.012;
    // Gentle fade in
    cr.alpha=Math.min(cr.targetAlpha,cr.alpha+0.005);
    // Wrap around
    if(cr.x>w+cr.sz*3){cr.x=-cr.sz*2.5;cr.y=h*(0.08+Math.random()*0.78);}
    if(cr.x<-cr.sz*3){cr.x=w+cr.sz*2.5;cr.y=h*(0.08+Math.random()*0.78);}
    if(cr.y<h*0.02)cr.vy=Math.abs(cr.vy)*0.5+0.02;
    if(cr.y>h*0.95)cr.vy=-Math.abs(cr.vy)*0.5-0.02;

    const depthScale=0.5+cr.depth*0.5;
    const alpha=Math.min(1,cr.alpha*(0.5+beat*0.2)*THEME.sceneIntensity*intensityMult*stromboMult*depthScale);
    if(alpha<0.01)continue;
    const dir=cr.vx>0?1:-1;
    const s=cr.sz;
    const glow=super_?(22+beat*18):(10+beat*8);

    x0.save();x0.translate(cr.x,cr.y);x0.scale(dir*depthScale,depthScale);
    x0.strokeStyle=rgba(pc(cr.ci),alpha);
    x0.shadowBlur=glow;x0.shadowColor=pc(cr.ci);

    if(cr.tp==='jellyfish'){
      // ‚îÄ‚îÄ JELLYFISH ‚Äî translucent bell with flowing tentacles ‚îÄ‚îÄ
      const bellR=s;
      const pulse=1+Math.sin(cr.ph*1.5)*0.08+beat*0.05;
      // Bell dome ‚Äî double-layered with inner membrane
      x0.lineWidth=2.5;
      x0.beginPath();x0.arc(0,0,bellR*pulse,Math.PI+0.15,2*Math.PI-0.15);x0.stroke();
      // Inner bell membrane
      x0.strokeStyle=rgba(pc((cr.ci+1)%4),alpha*0.35);x0.lineWidth=1.5;
      x0.beginPath();x0.arc(0,0,bellR*0.75*pulse,Math.PI+0.3,2*Math.PI-0.3);x0.stroke();
      // Bell fill ‚Äî translucent gradient
      const bellG=x0.createRadialGradient(0,-bellR*0.3,0,0,0,bellR);
      bellG.addColorStop(0,rgba(pc(cr.ci),alpha*0.2*stromboMult));
      bellG.addColorStop(0.6,rgba(pc((cr.ci+1)%4),alpha*0.08));
      bellG.addColorStop(1,'transparent');
      x0.fillStyle=bellG;x0.beginPath();x0.arc(0,0,bellR*pulse,Math.PI,0);x0.fill();
      // Oral arms ‚Äî thick flowing tendrils from center
      x0.strokeStyle=rgba(pc((cr.ci+2)%4),alpha*0.5);x0.lineWidth=2;
      for(let oa=0;oa<4;oa++){
        const oaX=(oa/3-0.5)*bellR*0.8;
        x0.beginPath();x0.moveTo(oaX,0);
        const sway1=Math.sin(cr.ph+oa*1.2)*s*0.15;
        const sway2=Math.sin(cr.ph*0.7+oa*0.9)*s*0.2;
        x0.bezierCurveTo(oaX+sway1,s*0.5,oaX+sway2,s*1.0,oaX+Math.sin(cr.ph+oa)*s*0.12,s*1.3);
        x0.stroke();
      }
      // Long trailing tentacles ‚Äî thin, undulating, different lengths
      for(let tk=0;tk<8;tk++){
        const tx=(tk/7-0.5)*bellR*1.5;
        const tLen=s*(1.6+tk%3*0.6);
        x0.beginPath();x0.moveTo(tx,0);
        const segs=8;
        for(let seg=1;seg<=segs;seg++){
          const frac=seg/segs;
          const sx=tx+Math.sin(cr.ph*0.9+tk*0.8+frac*3)*s*0.18*(1+frac);
          const sy=frac*tLen;
          if(seg===1)x0.lineTo(sx,sy);else x0.lineTo(sx,sy);
        }
        x0.strokeStyle=rgba(pc((cr.ci+tk%3)%4),alpha*(0.35-tk*0.02));
        x0.lineWidth=1.5-tk*0.1;x0.stroke();
      }
      // Bioluminescent spots on bell
      for(let sp=0;sp<5;sp++){
        const spA=-Math.PI+Math.PI*(sp+0.5)/5;
        const spX=Math.cos(spA)*bellR*0.6;
        const spY=Math.sin(spA)*bellR*0.6;
        const spBr=0.3+Math.sin(cr.ph+sp*1.5)*0.3;
        x0.fillStyle=rgba(pc((cr.ci+2)%4),alpha*spBr*stromboMult);
        x0.beginPath();x0.arc(spX,spY,s*0.05,0,Math.PI*2);x0.fill();
      }

    } else if(cr.tp==='whale'){
      // ‚îÄ‚îÄ WHALE ‚Äî massive, majestic, anatomically flowing ‚îÄ‚îÄ
      const bodyW=s*1.5,bodyH=s*0.55;
      // Body ‚Äî organic flowing shape, not ellipse
      x0.lineWidth=3;
      x0.beginPath();
      // Top contour: head rounded, gentle hump, tapers to tail
      x0.moveTo(s*1.3,0);
      x0.bezierCurveTo(s*1.3,-bodyH*0.8,s*0.5,-bodyH*1.0,-s*0.1,-bodyH*0.7);
      x0.bezierCurveTo(-s*0.6,-bodyH*0.5,-s*1.0,-bodyH*0.2,-s*1.3,0);
      // Bottom contour: belly, throat grooves
      x0.bezierCurveTo(-s*1.0,bodyH*0.25,-s*0.5,bodyH*0.5,s*0.2,bodyH*0.4);
      x0.bezierCurveTo(s*0.7,bodyH*0.3,s*1.1,bodyH*0.15,s*1.3,0);
      x0.closePath();
      x0.strokeStyle=rgba(pc(cr.ci),alpha);x0.stroke();
      // Subtle body fill
      const wfill=x0.createLinearGradient(-s*1.3,-bodyH,s*1.3,bodyH);
      wfill.addColorStop(0,rgba(pc(cr.ci),alpha*0.08));
      wfill.addColorStop(0.5,rgba(pc((cr.ci+1)%4),alpha*0.04));
      wfill.addColorStop(1,'transparent');
      x0.fillStyle=wfill;x0.fill();
      // Throat grooves
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.25);x0.lineWidth=1;
      for(let gr=0;gr<5;gr++){
        const gx=s*(0.3+gr*0.15);
        x0.beginPath();x0.moveTo(gx,bodyH*0.1);x0.lineTo(gx+s*0.08,bodyH*0.35);x0.stroke();
      }
      // Pectoral fin
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.7);x0.lineWidth=2;
      x0.beginPath();x0.moveTo(s*0.3,bodyH*0.2);
      x0.bezierCurveTo(s*0.1,bodyH*0.7,-s*0.15,bodyH*0.9,-s*0.1,bodyH*0.55);
      x0.stroke();
      // Tail flukes ‚Äî graceful sweep
      const tailSway=Math.sin(cr.ph)*s*0.12;
      x0.lineWidth=2.5;x0.strokeStyle=rgba(pc(cr.ci),alpha*0.85);
      x0.beginPath();x0.moveTo(-s*1.3,0);
      x0.bezierCurveTo(-s*1.6+tailSway,-s*0.3,-s*1.9+tailSway,-s*0.6,-s*1.7+tailSway,-s*0.4);x0.stroke();
      x0.beginPath();x0.moveTo(-s*1.3,0);
      x0.bezierCurveTo(-s*1.6+tailSway,s*0.3,-s*1.9+tailSway,s*0.6,-s*1.7+tailSway,s*0.4);x0.stroke();
      // Dorsal ridge ‚Äî subtle bump
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.4);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(-s*0.3,-bodyH*0.7);x0.bezierCurveTo(-s*0.4,-bodyH*0.9,-s*0.55,-bodyH*0.75,-s*0.6,-bodyH*0.5);x0.stroke();
      // Eye ‚Äî gentle, wise
      x0.fillStyle=rgba(pc((cr.ci+2)%4),0.9);x0.shadowBlur=8;x0.shadowColor=pc((cr.ci+2)%4);
      x0.beginPath();x0.ellipse(s*0.9,-bodyH*0.25,s*0.06,s*0.04,0.2,0,Math.PI*2);x0.fill();
      // Inner eye highlight
      x0.fillStyle='rgba(255,255,255,0.7)';
      x0.beginPath();x0.arc(s*0.92,-bodyH*0.27,s*0.015,0,Math.PI*2);x0.fill();

    } else if(cr.tp==='octopus'){
      // ‚îÄ‚îÄ OCTOPUS ‚Äî bulbous mantle, flowing arms with suckers ‚îÄ‚îÄ
      const mR=s*0.55;
      // Mantle ‚Äî slightly elongated dome
      x0.lineWidth=2;
      x0.beginPath();x0.ellipse(0,-s*0.15,mR,mR*1.2,0,0,Math.PI*2);x0.stroke();
      const ofill=x0.createRadialGradient(0,-s*0.3,0,0,-s*0.15,mR*1.2);
      ofill.addColorStop(0,rgba(pc(cr.ci),alpha*0.15));
      ofill.addColorStop(1,rgba(pc((cr.ci+1)%4),alpha*0.03));
      x0.fillStyle=ofill;x0.fill();
      // Eyes ‚Äî large, intelligent
      for(const eSide of [-1,1]){
        x0.fillStyle=rgba(pc((cr.ci+2)%4),alpha*0.9);
        x0.shadowBlur=6;x0.shadowColor=pc((cr.ci+2)%4);
        x0.beginPath();x0.ellipse(eSide*mR*0.4,-s*0.25,s*0.07,s*0.05,0,0,Math.PI*2);x0.fill();
        x0.fillStyle='rgba(0,0,0,0.8)';
        x0.beginPath();x0.ellipse(eSide*mR*0.42,-s*0.26,s*0.03,s*0.04,0,0,Math.PI*2);x0.fill();
      }
      // 8 flowing arms with suckers
      for(let tk=0;tk<8;tk++){
        const baseA=(tk/8)*Math.PI*1.6-Math.PI*0.3;
        const bx=Math.cos(baseA)*mR*0.5;
        const by=Math.sin(baseA)*mR*0.5+s*0.15;
        const armLen=s*(0.9+tk%3*0.3);
        x0.beginPath();x0.moveTo(bx,by);
        const segs=10;
        const pts=[];pts.push({x:bx,y:by});
        for(let seg=1;seg<=segs;seg++){
          const frac=seg/segs;
          const sway=Math.sin(cr.ph*0.8+tk*0.9+frac*2.5)*s*0.2*(0.5+frac);
          const px=bx+Math.cos(baseA+0.5)*armLen*frac+sway;
          const py=by+armLen*frac*0.6+Math.sin(cr.ph+tk+frac*2)*s*0.1;
          x0.lineTo(px,py);pts.push({x:px,y:py});
        }
        x0.strokeStyle=rgba(pc((cr.ci+tk%2)%4),alpha*(0.6-tk*0.03));
        x0.lineWidth=3-tk*0.2;x0.stroke();
        // Suckers along arm
        x0.fillStyle=rgba(pc((cr.ci+1)%4),alpha*0.3);
        for(let su=2;su<pts.length;su+=2){
          x0.beginPath();x0.arc(pts[su].x+3,pts[su].y,2,0,Math.PI*2);x0.fill();
        }
      }

    } else if(cr.tp==='manta'){
      // ‚îÄ‚îÄ MANTA RAY ‚Äî wide wings, graceful undulation ‚îÄ‚îÄ
      const wingW=s*1.9;
      const wingFlap=Math.sin(cr.ph*0.8)*s*0.2;
      // Wings ‚Äî smooth curved shape
      x0.lineWidth=2.5;
      // Top surface
      x0.beginPath();
      x0.moveTo(s*1.0,0);
      x0.bezierCurveTo(s*0.6,-s*0.15,0,-s*0.12,-wingW,wingFlap*0.7);
      x0.stroke();
      x0.beginPath();
      x0.moveTo(s*1.0,0);
      x0.bezierCurveTo(s*0.6,s*0.15,0,s*0.12,-wingW,-wingFlap*0.7);
      x0.stroke();
      // Wing tips curve
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.7);x0.lineWidth=2;
      x0.beginPath();x0.moveTo(-wingW,wingFlap*0.7);
      x0.bezierCurveTo(-wingW-s*0.15,wingFlap+s*0.1,-wingW-s*0.1,-wingFlap+s*0.15,-wingW,-wingFlap*0.7);
      x0.stroke();
      // Central body ridge
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.5);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(s*1.0,0);x0.lineTo(-s*0.6,0);x0.stroke();
      // Body fill ‚Äî translucent
      x0.beginPath();
      x0.moveTo(s*1.0,0);
      x0.bezierCurveTo(s*0.6,-s*0.15,-s*0.2,-s*0.1,-wingW*0.3,0);
      x0.bezierCurveTo(-s*0.2,s*0.1,s*0.6,s*0.15,s*1.0,0);
      x0.fillStyle=rgba(pc(cr.ci),alpha*0.06);x0.fill();
      // Cephalic fins ‚Äî horn-like protrusions
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.8);x0.lineWidth=2;
      for(const side of [-1,1]){
        x0.beginPath();x0.moveTo(s*0.85,side*s*0.05);
        x0.bezierCurveTo(s*1.1,side*s*0.15,s*1.2,side*s*0.2,s*1.15,side*s*0.3);
        x0.stroke();
      }
      // Gill slits on underside
      x0.strokeStyle=rgba(pc((cr.ci+1)%4),alpha*0.2);x0.lineWidth=1;
      for(let gi=0;gi<5;gi++){
        const gx=s*(0.2+gi*0.12);
        x0.beginPath();x0.moveTo(gx,s*0.06);x0.lineTo(gx+s*0.04,s*0.12);x0.stroke();
      }
      // Whip tail
      const tailPhase=Math.sin(cr.ph*0.6);
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.6);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(-s*0.6,0);
      x0.bezierCurveTo(-s*0.9,tailPhase*s*0.15,-s*1.2,tailPhase*s*0.1,-s*1.5,tailPhase*s*0.2);
      x0.stroke();
      // Eye spots
      x0.fillStyle=rgba(pc((cr.ci+2)%4),0.8);x0.shadowBlur=5;x0.shadowColor=pc((cr.ci+2)%4);
      for(const side of [-1,1]){
        x0.beginPath();x0.arc(s*0.7,side*s*0.08,s*0.035,0,Math.PI*2);x0.fill();
      }

    } else if(cr.tp==='anglerfish'){
      // ‚îÄ‚îÄ ANGLERFISH ‚Äî menacing, bulbous, terrifying beauty ‚îÄ‚îÄ
      // Large bulbous body
      x0.lineWidth=2.5;
      x0.beginPath();
      x0.moveTo(s*0.9,0);
      x0.bezierCurveTo(s*0.9,-s*0.55,s*0.2,-s*0.7,-s*0.3,-s*0.5);
      x0.bezierCurveTo(-s*0.7,-s*0.3,-s*0.8,0,-s*0.7,s*0.3);
      x0.bezierCurveTo(-s*0.5,s*0.55,s*0.3,s*0.6,s*0.9,0);
      x0.closePath();
      x0.stroke();
      x0.fillStyle=rgba(pc(cr.ci),alpha*0.07);x0.fill();
      // Illicium (lure rod) with bioluminescent esca
      const lurePh=cr.ph*0.7;
      const lureBaseX=s*0.1,lureBaseY=-s*0.55;
      const cp1X=s*0.3,cp1Y=-s*1.0;
      const lureTipX=s*(0.5+Math.sin(lurePh)*0.2),lureTipY=-s*(1.0+Math.cos(lurePh)*0.15);
      x0.strokeStyle=rgba(pc((cr.ci+1)%4),alpha*0.7);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(lureBaseX,lureBaseY);
      x0.bezierCurveTo(cp1X,cp1Y,lureTipX*0.8,lureTipY*0.9,lureTipX,lureTipY);x0.stroke();
      // Lure glow orb ‚Äî pulsing
      const lureGlow=0.7+Math.sin(cr.ph*2)*0.3+beat*0.3;
      x0.fillStyle=rgba(pc((cr.ci+2)%4),lureGlow*stromboMult);
      x0.shadowBlur=super_?30:18;x0.shadowColor=pc((cr.ci+2)%4);
      x0.beginPath();x0.arc(lureTipX,lureTipY,s*0.1*(1+beat*0.2),0,Math.PI*2);x0.fill();
      // Lure halo rings
      x0.strokeStyle=rgba(pc((cr.ci+2)%4),lureGlow*0.3);x0.lineWidth=1;
      x0.beginPath();x0.arc(lureTipX,lureTipY,s*0.18*(1+beat*0.15),0,Math.PI*2);x0.stroke();
      // Gaping mouth with jagged teeth
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.9);x0.lineWidth=2;
      x0.beginPath();x0.moveTo(s*0.9,0);
      x0.bezierCurveTo(s*0.95,-s*0.15,s*0.9,-s*0.25,s*0.7,-s*0.2);x0.stroke();
      x0.beginPath();x0.moveTo(s*0.9,0);
      x0.bezierCurveTo(s*0.95,s*0.12,s*0.9,s*0.2,s*0.75,s*0.15);x0.stroke();
      // Teeth ‚Äî long, needle-like, irregular
      x0.strokeStyle=rgba(pc(3),alpha*0.9);x0.lineWidth=1.5;
      for(let tk=0;tk<7;tk++){
        const frac=tk/6;
        // Upper teeth
        const utx=s*(0.72+frac*0.2);
        const uty=-s*(0.2-frac*0.18);
        const tLen=s*(0.08+Math.random()*0.06);
        x0.beginPath();x0.moveTo(utx,uty);x0.lineTo(utx+tLen*0.3,uty+tLen);x0.stroke();
        // Lower teeth
        const lty=s*(0.15-frac*0.12);
        x0.beginPath();x0.moveTo(utx,lty);x0.lineTo(utx+tLen*0.2,lty-tLen);x0.stroke();
      }
      // Eye ‚Äî large, menacing
      x0.fillStyle=rgba(pc((cr.ci+3)%4),0.9);x0.shadowBlur=10;x0.shadowColor=pc((cr.ci+3)%4);
      x0.beginPath();x0.arc(s*0.4,-s*0.2,s*0.09,0,Math.PI*2);x0.fill();
      x0.fillStyle='rgba(0,0,0,0.9)';
      x0.beginPath();x0.arc(s*0.42,-s*0.21,s*0.04,0,Math.PI*2);x0.fill();
      // Small fins
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.5);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(-s*0.5,-s*0.2);x0.bezierCurveTo(-s*0.7,-s*0.35,-s*0.65,-s*0.4,-s*0.55,-s*0.25);x0.stroke();
      x0.beginPath();x0.moveTo(-s*0.6,s*0.2);x0.bezierCurveTo(-s*0.75,s*0.35,-s*0.7,s*0.38,-s*0.58,s*0.22);x0.stroke();

    } else if(cr.tp==='eel'){
      // ‚îÄ‚îÄ EEL ‚Äî long sinuous body, undulating gracefully ‚îÄ‚îÄ
      const bodyLen=s*2.0;
      const segs=18;
      x0.lineCap='round';
      const pts=[];
      for(let seg=0;seg<=segs;seg++){
        const frac=seg/segs;
        const sx=-s*0.8+frac*bodyLen;
        const sy=Math.sin(cr.ph+frac*4)*s*0.2*(0.5+frac*0.5);
        pts.push({x:sx,y:sy});
      }
      // Body stroke ‚Äî thick gradient tapering to tail
      for(let seg=0;seg<pts.length-1;seg++){
        const frac=seg/segs;
        const thickness=s*(0.12-frac*0.08);
        x0.beginPath();x0.moveTo(pts[seg].x,pts[seg].y);x0.lineTo(pts[seg+1].x,pts[seg+1].y);
        x0.strokeStyle=rgba(pc(cr.ci),alpha*(0.7-frac*0.2));
        x0.lineWidth=thickness;x0.stroke();
      }
      // Dorsal fin ‚Äî continuous along top
      x0.strokeStyle=rgba(pc((cr.ci+1)%4),alpha*0.3);x0.lineWidth=1;
      x0.beginPath();
      for(let seg=2;seg<pts.length-2;seg++){
        const fin=pts[seg];
        const finH=s*0.06*(1-seg/segs*0.5);
        if(seg===2)x0.moveTo(fin.x,fin.y-finH);
        else x0.lineTo(fin.x,fin.y-finH);
      }
      x0.stroke();
      // Head detail
      const headX=pts[pts.length-1].x,headY=pts[pts.length-1].y;
      // Eye
      x0.fillStyle=rgba(pc((cr.ci+2)%4),0.9);x0.shadowBlur=6;x0.shadowColor=pc((cr.ci+2)%4);
      x0.beginPath();x0.arc(headX-s*0.05,headY-s*0.04,s*0.04,0,Math.PI*2);x0.fill();
      // Bioluminescent stripe along body
      x0.strokeStyle=rgba(pc((cr.ci+2)%4),alpha*0.2*stromboMult);x0.lineWidth=1;
      x0.beginPath();
      for(let seg=1;seg<pts.length;seg++){
        if(seg===1)x0.moveTo(pts[seg].x,pts[seg].y+s*0.02);
        else x0.lineTo(pts[seg].x,pts[seg].y+s*0.02);
      }
      x0.stroke();
      x0.lineCap='butt';

    } else if(cr.tp==='nautilus'){
      // ‚îÄ‚îÄ NAUTILUS ‚Äî spiral shell with trailing tentacles ‚îÄ‚îÄ
      const shellR=s*0.7;
      // Shell spiral ‚Äî golden ratio inspired
      x0.lineWidth=2;
      x0.beginPath();
      for(let a=0;a<Math.PI*3.5;a+=0.08){
        const r=shellR*(1-a/(Math.PI*4));
        if(r<2)break;
        const sx=Math.cos(a+cr.ph*0.2)*r;
        const sy=Math.sin(a+cr.ph*0.2)*r;
        if(a===0)x0.moveTo(sx,sy);else x0.lineTo(sx,sy);
      }
      x0.strokeStyle=rgba(pc(cr.ci),alpha*0.8);x0.stroke();
      // Shell chambers ‚Äî radial lines
      x0.strokeStyle=rgba(pc((cr.ci+1)%4),alpha*0.3);x0.lineWidth=1;
      for(let ch=0;ch<6;ch++){
        const chA=ch*Math.PI*0.55+cr.ph*0.2;
        const r1=shellR*(1-ch*0.12);
        const r2=shellR*(1-(ch+0.5)*0.12);
        x0.beginPath();
        x0.moveTo(Math.cos(chA)*r1,Math.sin(chA)*r1);
        x0.lineTo(Math.cos(chA)*r2*0.5,Math.sin(chA)*r2*0.5);
        x0.stroke();
      }
      // Shell fill
      x0.fillStyle=rgba(pc(cr.ci),alpha*0.06);
      x0.beginPath();x0.arc(0,0,shellR*0.9,0,Math.PI*2);x0.fill();
      // Eye peeping from opening
      x0.fillStyle=rgba(pc((cr.ci+2)%4),0.8);
      x0.beginPath();x0.arc(shellR*0.4,0,s*0.05,0,Math.PI*2);x0.fill();
      // Tentacles ‚Äî many thin ones streaming out
      for(let tk=0;tk<12;tk++){
        const ta=(tk/11-0.5)*1.2;
        const tLen=s*(0.4+Math.random()*0.4);
        x0.beginPath();x0.moveTo(shellR*0.5,ta*s*0.3);
        x0.bezierCurveTo(shellR*0.7+Math.sin(cr.ph+tk)*5,ta*s*0.4+tLen*0.3,
          shellR*0.6+Math.sin(cr.ph*0.7+tk)*8,ta*s*0.3+tLen*0.7,
          shellR*0.5+Math.sin(cr.ph+tk*0.5)*10,ta*s*0.3+tLen);
        x0.strokeStyle=rgba(pc((cr.ci+tk%3)%4),alpha*0.3);x0.lineWidth=1;x0.stroke();
      }
    }

    x0.shadowBlur=0;x0.restore();
  }

  // ‚îÄ‚îÄ Centerpiece integration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(THEME.centerpiece){
    cpRot+=0.015;cpPh+=0.01;
    const cpSz=Math.min(w,h)*(0.12+beat*0.02+songProg*0.02);
    const cpY=h*0.4+Math.sin(cpPh)*h*0.03;
    x0.save();
    x0.shadowBlur=cpSz*0.6;x0.shadowColor=rgba(pc(0),0.8);
    drawCPMini(x0,THEME.centerpiece,cx,cpY,cpSz,cpRot);
    x0.shadowBlur=0;x0.restore();
  }

  // ‚îÄ‚îÄ LEVIATHAN ‚Äî massive creature gliding across 30s ‚îÄ‚îÄ‚îÄ‚îÄ
  if(DS.leviathan){
    const lev=DS.leviathan;
    lev.timer-=16;lev.x+=lev.vx;lev.alpha=Math.min(0.85,lev.alpha+0.006);
    if(lev.timer<=5000&&lev.timer>0)lev.alpha=Math.max(0,lev.alpha-0.005);
    if(lev.timer<=0)lev.alpha=Math.max(0,lev.alpha-0.012);
    if(lev.alpha<=0&&lev.timer<=0){DS.leviathan=null;}
    if(lev.alpha>0){
      x0.save();x0.globalAlpha=lev.alpha;x0.translate(lev.x,lev.y);
      const ls=lev.sz;
      // Massive dark silhouette body ‚Äî organic whale/serpent shape
      x0.fillStyle='rgba(2,3,10,0.85)';
      x0.beginPath();
      x0.moveTo(ls*0.65,0);
      x0.bezierCurveTo(ls*0.65,-ls*0.18,ls*0.2,-ls*0.22,-ls*0.1,-ls*0.15);
      x0.bezierCurveTo(-ls*0.45,-ls*0.1,-ls*0.65,0,-ls*0.6,ls*0.08);
      x0.bezierCurveTo(-ls*0.45,ls*0.15,ls*0.2,ls*0.2,ls*0.65,0);
      x0.closePath();x0.fill();
      // Neon edge glow ‚Äî double contour
      x0.strokeStyle=rgba(pc(2),0.5+beat*0.3);x0.lineWidth=3;
      x0.shadowBlur=35+beat*20;x0.shadowColor=pc(2);
      x0.stroke();
      x0.strokeStyle=rgba(pc(0),0.2);x0.lineWidth=1.5;
      x0.shadowBlur=20;x0.shadowColor=pc(0);x0.stroke();
      // Tail ‚Äî massive flowing flukes
      const tSway=Math.sin(t*0.001)*ls*0.06;
      x0.strokeStyle=rgba(pc(2),0.4+beat*0.2);x0.lineWidth=3;x0.shadowBlur=20;
      x0.beginPath();x0.moveTo(-ls*0.6,0);
      x0.bezierCurveTo(-ls*0.8+tSway,-ls*0.12,-ls*0.95+tSway,-ls*0.2,-ls*0.88+tSway,-ls*0.1);x0.stroke();
      x0.beginPath();x0.moveTo(-ls*0.6,0);
      x0.bezierCurveTo(-ls*0.8+tSway,ls*0.12,-ls*0.95+tSway,ls*0.2,-ls*0.88+tSway,ls*0.1);x0.stroke();
      // Glowing eye ‚Äî large and wise
      x0.fillStyle=rgba(pc(0),0.95);x0.shadowBlur=25;x0.shadowColor=pc(0);
      x0.beginPath();x0.ellipse(ls*0.45,-ls*0.05,ls*0.035,ls*0.025,0,0,Math.PI*2);x0.fill();
      // Bioluminescent markings along body
      x0.strokeStyle=rgba(pc(1),0.2+beat*0.15);x0.lineWidth=1;x0.shadowBlur=10;x0.shadowColor=pc(1);
      for(let mk=0;mk<8;mk++){
        const mx=ls*(0.3-mk*0.1);
        x0.beginPath();x0.moveTo(mx,-ls*0.08);x0.lineTo(mx-ls*0.03,-ls*0.13);x0.stroke();
      }
      x0.shadowBlur=0;x0.restore();
    }
  }

  // ‚îÄ‚îÄ ABYSSAL VORTEX ‚Äî glowing whirlpool 30s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(DS.vortex){
    const V=DS.vortex;
    V.timer-=16;V.rot+=0.025*(1+beat*0.5);V.alpha=Math.min(0.85,V.alpha+0.01);
    V.r=Math.min(V.maxR,V.r+1.2);
    if(V.timer<=5000&&V.timer>0)V.alpha=Math.max(0.1,V.alpha-0.003);
    if(V.timer<=0)V.alpha=Math.max(0,V.alpha-0.012);
    if(V.alpha<=0&&V.timer<=0){DS.vortex=null;}
    if(V.alpha>0){
      // Dark vortex center
      const vg=x0.createRadialGradient(V.x,V.y,0,V.x,V.y,V.r*0.4);
      vg.addColorStop(0,'rgba(0,0,0,'+V.alpha*0.7+')');vg.addColorStop(1,'transparent');
      x0.fillStyle=vg;x0.fillRect(0,0,w,h);
      // Spiral rings
      for(let ring=0;ring<10;ring++){
        const rFrac=ring/9;const rR=V.r*(1-rFrac*0.85);
        x0.strokeStyle=rgba(pc(ring%4),V.alpha*(1-rFrac*0.5));x0.lineWidth=2.5-rFrac*1.5;
        x0.shadowBlur=12+beat*8;x0.shadowColor=pc(ring%4);
        x0.beginPath();x0.arc(V.x,V.y,Math.max(2,rR),V.rot+ring*0.65,V.rot+ring*0.65+Math.PI*1.6);x0.stroke();
      }
      // Light streams radiating outward
      for(let ray=0;ray<6;ray++){
        const ra=V.rot*0.5+ray*Math.PI/3;
        x0.strokeStyle=rgba(pc(ray%4),V.alpha*0.2*(0.5+beat*0.5));x0.lineWidth=1.5;x0.shadowBlur=8;
        x0.beginPath();x0.moveTo(V.x+Math.cos(ra)*V.r*0.3,V.y+Math.sin(ra)*V.r*0.3);
        x0.lineTo(V.x+Math.cos(ra)*V.r*1.2,V.y+Math.sin(ra)*V.r*1.2);x0.stroke();
      }
      // Pull creatures and plankton toward vortex
      for(const cr of DS.creatures){
        if(!cr.active)continue;
        const dx=V.x-cr.x,dy=V.y-cr.y,dist=Math.hypot(dx,dy)||1;
        if(dist<V.r*2){cr.x+=dx/dist*0.8*V.alpha;cr.y+=dy/dist*0.8*V.alpha;}
      }
      for(const p of DS.plankton){
        const dx=V.x-p.x,dy=V.y-p.y,dist=Math.hypot(dx,dy)||1;
        if(dist<V.r*2.5){p.x+=dx/dist*0.5*V.alpha;p.y+=dy/dist*0.5*V.alpha;}
      }
      x0.shadowBlur=0;
    }
  }
}


// ‚ïê‚ïê‚ïê SCENE: stormChaser ‚ïê‚ïê‚ïê

function drawStormChaser(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  const beat=SM.beatPulse,energy=SM.energy;

  if(!SD.storm){
    SD.storm={
      tornadoA:0,
      stormIntensity:0.2,
      lightnings:[],
      ltTimer:0,
      debris:Array.from({length:25},()=>mkDebris()),
      dorothyHouse:null,
      dorothyTimer:0,
      colorLightning:false,
      colorLightningTimer:0,
      heavyRain:false,
      heavyRainTimer:0,
      transformerExplosion:false,
      transformerTimer:0,
      transformerSparks:[],
      cpOrbits:Array.from({length:8},(_,i)=>({angle:i/8*Math.PI*2,orbitSpeed:0.008+Math.random()*0.008,orbitR:0.14+Math.random()*0.06,phase:i/8*Math.PI*2})),
      towers:[
        {x:w*0.12,baseY:h*0.92,topY:h*0.48,ci:0},
        {x:w*0.88,baseY:h*0.92,topY:h*0.48,ci:1},
      ],
      // Tornado dots ‚Äî persistent array of spinning particles
      tornadoDots:Array.from({length:1200},(_,i)=>{
        const z=Math.random(); // 0=top(wide), 1=bottom(narrow)
        return{z,angle:Math.random()*Math.PI*2,speed:0.03+Math.random()*0.025,ci:i%4,r:1+Math.random()*2,drift:Math.random()*0.3-0.15};
      }),
    };
  }
  const ST=SD.storm;
  ST.stormIntensity=0.2+songProg*0.8;

  if(ST.dorothyTimer>0){ST.dorothyTimer-=16;if(ST.dorothyTimer<=0)ST.dorothyHouse=null;}
  if(ST.colorLightningTimer>0){ST.colorLightningTimer-=16;if(ST.colorLightningTimer<=0)ST.colorLightning=false;}
  if(ST.heavyRainTimer>0){ST.heavyRainTimer-=16;if(ST.heavyRainTimer<=0)ST.heavyRain=false;}
  if(ST.transformerTimer>0){ST.transformerTimer-=16;if(ST.transformerTimer<=0){ST.transformerExplosion=false;ST.transformerSparks=[];}}

  const stormI=ST.stormIntensity;
  const superRain=ST.heavyRain;
  const colorLt=ST.colorLightning;
  const texpl=ST.transformerExplosion;

  // BG ‚Äî stormy sky
  const sg=x0.createRadialGradient(cx,cy*0.3,0,cx,h*0.5,h*0.8);
  const sc=h2r(pc(2));
  sg.addColorStop(0,`rgba(${Math.round(sc.r*0.18)},${Math.round(sc.g*0.12)},${Math.round(sc.b*0.35)},${0.2*stormI})`);
  sg.addColorStop(0.5,THEME.bgColor);sg.addColorStop(1,'rgba(0,0,0,0.95)');
  x0.fillStyle=sg;x0.fillRect(0,0,w,h);

  // Rain ‚Äî normal or heavy
  const numDrops=superRain?500:Math.floor(100+stormI*200);
  const dropLen=superRain?30:18;
  const dropAlpha=(superRain?0.35:0.12)+stormI*0.2;
  const dropSpeed=superRain?3:1;
  x0.lineWidth=superRain?1.5:0.8;
  for(let i=0;i<numDrops;i++){
    const rx=Math.random()*w,ry=Math.random()*h;
    const ciIdx=superRain?Math.floor(Math.random()*4):2;
    x0.strokeStyle=rgba(pc(ciIdx),(dropAlpha+Math.random()*0.1)*(superRain?1.5:1));
    x0.beginPath();x0.moveTo(rx,ry);x0.lineTo(rx-4*stormI*dropSpeed,ry+dropLen*dropSpeed);x0.stroke();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TORNADO ‚Äî thousands of tiny neon dots spinning in funnel
  // Wide at top, skinny at bottom, pulses with beat
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ST.tornadoA+=0.018*(1+energy*0.4+beat*0.3);
  const tornadoX=cx+Math.sin(t*0.0003)*w*0.04;
  const tornadoTopY=h*0.02;
  const tornadoBottomY=h*0.9;
  const tornadoH=tornadoBottomY-tornadoTopY;
  const topWidth=Math.min(w,h)*(0.4+beat*0.06);
  const bottomWidth=Math.min(w,h)*0.02;

  // Translucent funnel fill behind dots
  const funnelG=x0.createLinearGradient(tornadoX,tornadoTopY,tornadoX,tornadoBottomY);
  funnelG.addColorStop(0,rgba(pc(2),0.07+beat*0.03));
  funnelG.addColorStop(0.5,rgba(pc(3),0.04));funnelG.addColorStop(1,'transparent');
  x0.fillStyle=funnelG;
  x0.beginPath();
  x0.moveTo(tornadoX-topWidth*0.5,tornadoTopY);
  x0.lineTo(tornadoX+topWidth*0.5,tornadoTopY);
  x0.lineTo(tornadoX+bottomWidth*0.5,tornadoBottomY);
  x0.lineTo(tornadoX-bottomWidth*0.5,tornadoBottomY);
  x0.closePath();x0.fill();

  // Draw thousands of spinning dots
  for(const dot of ST.tornadoDots){
    // Spin faster with beat and energy
    dot.angle+=dot.speed*(1+energy*0.5+beat*0.4);
    // Slight vertical drift
    dot.z+=dot.drift*0.001;
    if(dot.z<0)dot.z+=1;if(dot.z>1)dot.z-=1;

    // Width at this Z position ‚Äî lerp from topWidth to bottomWidth
    const ringR=(topWidth*(1-dot.z)+bottomWidth*dot.z)*0.5;
    const dotY=tornadoTopY+dot.z*tornadoH;
    // Wobble the center slightly per ring
    const wobble=Math.sin(ST.tornadoA+dot.z*5)*ringR*0.06;
    const dotX=tornadoX+wobble+Math.cos(dot.angle)*ringR*(0.5+Math.sin(dot.angle*0.5)*0.08);
    const dotYoff=dotY+Math.sin(dot.angle*2)*ringR*0.04;

    // Alpha varies ‚Äî denser at edges, beat reactive
    const alpha=(0.25+dot.z*0.15)*(1+beat*0.4)*stormI;
    x0.fillStyle=rgba(pc(dot.ci),Math.min(0.9,alpha));
    x0.beginPath();x0.arc(dotX,dotYoff,dot.r*(1+beat*0.3),0,Math.PI*2);x0.fill();
  }

  // Glow core along center of funnel
  x0.shadowBlur=40+beat*20;x0.shadowColor=rgba(pc(0),0.6);
  x0.strokeStyle=rgba(pc(0),0.06+beat*0.04);x0.lineWidth=3;
  x0.beginPath();x0.moveTo(tornadoX,tornadoTopY+tornadoH*0.1);x0.lineTo(tornadoX,tornadoBottomY);x0.stroke();
  x0.shadowBlur=0;

  // ‚îÄ‚îÄ 8 CENTERPIECES orbiting the tornado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(THEME.centerpiece){
    const baseOrbitR=Math.min(w,h)*(0.2+stormI*0.08);
    cpPh+=0.013;
    for(const orb of ST.cpOrbits){
      orb.angle+=orb.orbitSpeed*(1+stormI+beat*0.5);
      const orbitY=tornadoTopY+tornadoH*(0.3+Math.sin(orb.phase+t*0.0005)*0.35);
      const orbitR=baseOrbitR*(0.6+Math.sin(orb.phase)*0.4);
      const orbitX=tornadoX+Math.cos(orb.angle)*orbitR;
      const wobbleY=orbitY+Math.sin(orb.angle*2+ST.tornadoA)*orbitR*0.25;
      const osz=Math.min(w,h)*(0.038+Math.sin(orb.phase)*0.012+beat*0.015);
      cpRot+=0.04*(1+beat*0.5);
      x0.globalAlpha=0.7+stormI*0.25+beat*0.05;
      x0.shadowBlur=10+beat*8;x0.shadowColor=pc(0);
      drawCPMini(x0,THEME.centerpiece,orbitX,wobbleY,osz,cpRot+orb.angle);
      x0.globalAlpha=1;x0.shadowBlur=0;
    }
  }

  // ‚îÄ‚îÄ DEBRIS around tornado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const d of ST.debris){
    d.x+=d.vx*(1+energy*0.5+beat*0.2);
    d.y+=d.vy*(1+energy*0.4);
    const dx=d.x-tornadoX,dy=d.y-cy;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>0&&dist<Math.min(w,h)*0.45){d.x-=dy/dist*2.2;d.y+=dx/dist*2.2;}
    d.rot+=d.rotS;
    if(d.x<-60||d.x>w+60||d.y<-60||d.y>h+60)Object.assign(d,mkDebris());
    x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);
    x0.fillStyle=rgba(pc(d.ci),0.5+stormI*0.3+beat*0.1);
    if(d.type===0)x0.fillRect(-d.sz/2,-d.sz*0.1,d.sz,d.sz*0.2);
    else{x0.beginPath();x0.arc(0,0,d.sz*0.3,0,Math.PI*2);x0.fill();}
    x0.restore();
  }

  // ‚îÄ‚îÄ LIGHTNING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ST.ltTimer-=16;
  const ltInterval=Math.max(80,600-songProg*400);
  if(ST.ltTimer<0){
    const ltCount=colorLt?4:(stormI>0.5?2:1);
    for(let i=0;i<ltCount;i++){
      const lt=mkLightning();
      if(colorLt)lt.ci=Math.floor(Math.random()*4);
      ST.lightnings.push(lt);
    }
    ST.ltTimer=ltInterval+Math.random()*300;
  }
  for(let i=ST.lightnings.length-1;i>=0;i--){
    const lt=ST.lightnings[i];lt.life-=0.06;
    if(lt.life<=0){ST.lightnings.splice(i,1);continue;}
    x0.shadowBlur=colorLt?30:20;x0.shadowColor=colorLt?pc(lt.ci):'rgba(200,220,255,0.9)';
    for(const seg of lt.segs){
      x0.beginPath();x0.moveTo(seg.x1,seg.y1);x0.lineTo(seg.x2,seg.y2);
      x0.strokeStyle=colorLt?rgba(pc(lt.ci),lt.life*stormI):`rgba(220,235,255,${lt.life*stormI})`;
      x0.lineWidth=lt.life*(colorLt?3:2);x0.stroke();
    }
    x0.shadowBlur=0;
    if(colorLt&&lt.life>0.8)flash(rgba(pc(lt.ci),0.15),200);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // POWER TOWERS ‚Äî wider, more solid, vibrant glow
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(ST.towers)for(const tow of ST.towers){
    const tx=tow.x,by=tow.baseY,ty=tow.topY;
    const towW=40; // wider tower base
    const towTopW=20; // narrower at top

    x0.shadowBlur=14+beat*8;x0.shadowColor=pc(tow.ci);

    // Main legs ‚Äî thick, solid
    x0.strokeStyle=rgba(pc(tow.ci),0.6+beat*0.2);x0.lineWidth=5;
    x0.beginPath();x0.moveTo(tx-towW,by);x0.lineTo(tx-towTopW,ty);x0.stroke();
    x0.beginPath();x0.moveTo(tx+towW,by);x0.lineTo(tx+towTopW,ty);x0.stroke();

    // Cross braces ‚Äî more, wider
    for(let cb=0;cb<7;cb++){
      const cbFrac=cb/7;
      const cbY=by-(by-ty)*cbFrac;
      const cbW=towW-(towW-towTopW)*cbFrac;
      x0.strokeStyle=rgba(pc(tow.ci),(0.5+beat*0.15));x0.lineWidth=3;
      x0.beginPath();x0.moveTo(tx-cbW,cbY);x0.lineTo(tx+cbW,cbY);x0.stroke();
      // X-braces between horizontals
      if(cb<6){
        const nextY=by-(by-ty)*((cb+1)/7);
        const nextW=towW-(towW-towTopW)*((cb+1)/7);
        x0.strokeStyle=rgba(pc(tow.ci),(0.35+beat*0.1));x0.lineWidth=2;
        x0.beginPath();x0.moveTo(tx-cbW,cbY);x0.lineTo(tx+nextW,nextY);x0.stroke();
        x0.beginPath();x0.moveTo(tx+cbW,cbY);x0.lineTo(tx-nextW,nextY);x0.stroke();
      }
    }

    // Top crossbar ‚Äî wide, prominent
    x0.strokeStyle=rgba(pc(tow.ci),0.7+beat*0.2);x0.lineWidth=4;
    x0.beginPath();x0.moveTo(tx-towW*1.2,ty);x0.lineTo(tx+towW*1.2,ty);x0.stroke();
    // Insulators hanging from crossbar
    for(let ins=-2;ins<=2;ins++){
      const ix=tx+ins*towW*0.5;
      x0.strokeStyle=rgba(pc((tow.ci+1)%4),(0.5+beat*0.2));x0.lineWidth=2;
      x0.beginPath();x0.moveTo(ix,ty);x0.lineTo(ix,ty+12);x0.stroke();
      x0.fillStyle=rgba(pc((tow.ci+1)%4),(0.6+beat*0.2));
      x0.beginPath();x0.arc(ix,ty+14,4,0,Math.PI*2);x0.fill();
    }

    // ‚îÄ‚îÄ TRANSFORMER BOX ‚Äî larger, more detailed ‚îÄ‚îÄ
    const tfW=30,tfH=22;
    const tfY=ty+(by-ty)*0.15;
    // Box body
    x0.fillStyle=rgba(pc(tow.ci),(0.35+beat*0.15));
    x0.fillRect(tx-tfW/2,tfY,tfW,tfH);
    x0.strokeStyle=rgba(pc(tow.ci),(0.7+beat*0.2));x0.lineWidth=2;
    x0.strokeRect(tx-tfW/2,tfY,tfW,tfH);
    // Internal detail lines
    x0.strokeStyle=rgba(pc((tow.ci+2)%4),(0.3+beat*0.1));x0.lineWidth=1;
    x0.beginPath();x0.moveTo(tx-tfW*0.3,tfY+tfH*0.3);x0.lineTo(tx+tfW*0.3,tfY+tfH*0.3);x0.stroke();
    x0.beginPath();x0.moveTo(tx-tfW*0.3,tfY+tfH*0.65);x0.lineTo(tx+tfW*0.3,tfY+tfH*0.65);x0.stroke();
    // Warning glow
    x0.shadowBlur=20+beat*15;x0.shadowColor=rgba(pc(tow.ci),0.8);
    x0.fillStyle=rgba(pc(tow.ci),(0.4+beat*0.3));
    x0.beginPath();x0.arc(tx,tfY+tfH/2,6+beat*3,0,Math.PI*2);x0.fill();

    // ‚îÄ‚îÄ SPARKS from transformer ‚Äî much more apparent ‚îÄ‚îÄ
    // Always emit some sparks, way more on beat
    const sparkActive=beat>0.2||texpl;
    if(sparkActive){
      const sparkCount=texpl?25:(beat>0.5?12:5);
      const sparkScale=texpl?10:1;
      for(let sp=0;sp<sparkCount;sp++){
        const sx=tx+(Math.random()-0.5)*tfW*1.5;
        const sy=tfY+tfH*0.5;
        const sLen=(15+Math.random()*25)*sparkScale;
        const sAngle=-(Math.random()*Math.PI*0.7+Math.PI*0.15); // mostly upward
        const ex=sx+Math.cos(sAngle)*sLen;
        const ey=sy+Math.sin(sAngle)*sLen;
        x0.strokeStyle=rgba(pc(Math.floor(Math.random()*4)),(0.8+beat*0.2));
        x0.lineWidth=texpl?(2+Math.random()*2):(1+Math.random());
        x0.shadowBlur=texpl?25:14;x0.shadowColor=pc(sp%4);
        x0.beginPath();x0.moveTo(sx,sy);x0.lineTo(ex,ey);x0.stroke();
        // Spark tip glow
        x0.fillStyle=rgba(pc(sp%4),(0.9+beat*0.1));
        x0.beginPath();x0.arc(ex,ey,texpl?(3+Math.random()*3):(2+Math.random()),0,Math.PI*2);x0.fill();
      }
    }
    x0.shadowBlur=0;
  }

  // Power lines ‚Äî sagging catenary between towers
  if(ST.towers&&ST.towers.length>=2){
    const t1=ST.towers[0],t2=ST.towers[1];
    for(let ln=0;ln<3;ln++){
      const ly=t1.topY-5+ln*8;
      const sag=45+Math.sin(t*0.002+ln)*12;
      x0.strokeStyle=rgba(pc(ln%4),(0.3+beat*0.12));x0.lineWidth=1.5;
      x0.shadowBlur=6+beat*4;x0.shadowColor=pc(ln%4);
      x0.beginPath();x0.moveTo(t1.x+45,ly);
      x0.quadraticCurveTo(cx,ly+sag,t2.x-45,ly);x0.stroke();
    }
    x0.shadowBlur=0;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TRANSFORMER EXPLOSION ‚Äî 10x scale spark fountain
  // Continuous massive sparks flying out of tower tops
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(texpl){
    // Spawn LOTS of sparks per frame ‚Äî 10x the normal rate
    for(let burst=0;burst<3;burst++){
      for(const tow of ST.towers){
        const tfY=tow.topY+(tow.baseY-tow.topY)*0.15;
        for(let sp=0;sp<6;sp++){
          ST.transformerSparks.push({
            x:tow.x+(Math.random()-0.5)*60,
            y:tfY+10,
            vx:(Math.random()-0.5)*18,
            vy:-(Math.random()*16+6),
            life:1,
            ci:Math.floor(Math.random()*4),
            r:3+Math.random()*6,
          });
        }
      }
    }
    // Cap array to prevent lag
    if(ST.transformerSparks.length>800)ST.transformerSparks.length=800;

    // Render all sparks
    for(let i=ST.transformerSparks.length-1;i>=0;i--){
      const sp=ST.transformerSparks[i];
      sp.x+=sp.vx;sp.y+=sp.vy;sp.vy+=0.2;sp.life-=0.008;
      if(sp.life<=0){ST.transformerSparks.splice(i,1);continue;}
      x0.fillStyle=rgba(pc(sp.ci),sp.life*0.95);
      x0.shadowBlur=16+beat*10;x0.shadowColor=pc(sp.ci);
      x0.beginPath();x0.arc(sp.x,sp.y,sp.r*sp.life,0,Math.PI*2);x0.fill();
    }
    x0.shadowBlur=0;

    // Explosion glow halos on both towers
    for(const tow of ST.towers){
      const tfY=tow.topY+(tow.baseY-tow.topY)*0.15;
      const explGlow=x0.createRadialGradient(tow.x,tfY,0,tow.x,tfY,Math.min(w,h)*0.25);
      explGlow.addColorStop(0,rgba(pc(tow.ci),(0.3+beat*0.3)));
      explGlow.addColorStop(0.5,rgba(pc((tow.ci+1)%4),(0.1+beat*0.1)));
      explGlow.addColorStop(1,'transparent');
      x0.fillStyle=explGlow;x0.fillRect(0,0,w,h);
    }
  }
}


// ‚ïê‚ïê‚ïê SCENE: jungleRave ‚ïê‚ïê‚ïê

function drawJungleRave(t){
  const w=W(),h=H(),cx=w/2;
  // Ground level ‚Äî standing IN the jungle looking up
  // Floor
  const fl=x0.createLinearGradient(0,h*0.75,0,h);
  fl.addColorStop(0,rgba(pc(2),0.3));fl.addColorStop(1,'rgba(0,10,0,0.95)');
  x0.fillStyle=fl;x0.fillRect(0,h*0.75,w,h*0.25);
  // Root network on floor
  if(!SD.roots){SD.roots=Array.from({length:15},(_,i)=>({x:i/14*w,angle:Math.PI/2+((i%2===0?1:-1)*0.6+Math.random()*0.4),ci:i%4}));}
  x0.shadowBlur=8;
  for(const r of SD.roots){
    x0.strokeStyle=rgba(pc(r.ci),0.25+SM.beatPulse*0.1);x0.lineWidth=3+Math.random();x0.shadowColor=pc(r.ci);
    x0.beginPath();x0.moveTo(r.x,h);
    let rx=r.x,ry=h,ra=r.angle-Math.PI/2;
    for(let seg=0;seg<5;seg++){rx+=Math.cos(ra)*60;ry+=Math.sin(ra)*40;ra+=(Math.random()-0.5)*0.8;x0.lineTo(rx,ry);}
    x0.stroke();
  }
  x0.shadowBlur=0;
  // Massive jungle trees surrounding viewer ‚Äî tall trunks from bottom, canopy at top
  if(!SD.trees){
    SD.trees=[];
    const positions=[-0.45,-0.3,-0.15,0.15,0.3,0.45,-0.55,0.55];
    for(let i=0;i<positions.length;i++){
      const px=cx+positions[i]*w;
      const scale=1.2-Math.abs(positions[i])*0.6;
      SD.trees.push({x:px,scale,ci:i%4,ph:Math.random()*Math.PI*2,glowMult:1});
    }
  }
  // Draw tree trunks (back to front)
  const sortedTrees=[...SD.trees].sort((a,b)=>b.scale-a.scale);
  for(const tr of sortedTrees){
    tr.ph+=0.006;const glm=tr.glowMult||1;
    const trunkW=30*tr.scale,trunkH=h*0.85*tr.scale;
    // Trunk
    const tg=x0.createLinearGradient(tr.x-trunkW,0,tr.x+trunkW,0);
    tg.addColorStop(0,'rgba(5,15,3,0.95)');tg.addColorStop(0.5,rgba(pc(tr.ci),0.08));tg.addColorStop(1,'rgba(5,15,3,0.95)');
    x0.fillStyle=tg;x0.fillRect(tr.x-trunkW/2,h*0.15,trunkW,h*0.85);
    // Bark detail lines
    x0.strokeStyle=rgba(pc(tr.ci),0.06*glm);x0.lineWidth=1;
    for(let b=0;b<5;b++){x0.beginPath();x0.moveTo(tr.x-trunkW/3+b*(trunkW/5),h*0.2);x0.lineTo(tr.x-trunkW/3+b*(trunkW/5)+Math.sin(b)*5,h*0.9);x0.stroke();}
    // Canopy spread at top
    x0.shadowBlur=25*glm;x0.shadowColor=pc(tr.ci);
    x0.fillStyle=rgba(pc(tr.ci),0.35*glm*(1+SM.beatPulse*0.15));
    x0.beginPath();x0.ellipse(tr.x,h*0.08,trunkW*3.5+Math.sin(tr.ph)*8,h*0.16,0,0,Math.PI*2);x0.fill();
    x0.fillStyle=rgba(pc(tr.ci),0.25*glm);
    x0.beginPath();x0.ellipse(tr.x+Math.sin(tr.ph)*20,h*0.12,trunkW*2.5,h*0.11,Math.sin(tr.ph)*0.1,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;if(tr.glowMult>1)tr.glowMult*=0.97;
  }
  // Vines hanging from canopy
  if(!SD.vines){SD.vines=Array.from({length:12},(_,i)=>({x:Math.random()*w,len:h*(0.3+Math.random()*0.4),swing:Math.random()*Math.PI*2,swingSpeed:0.01+Math.random()*0.01,ci:i%4}));}
  for(const v of SD.vines){v.swing+=v.swingSpeed;const offset=Math.sin(v.swing)*15;x0.strokeStyle=rgba(pc(v.ci),0.2);x0.lineWidth=2;x0.beginPath();x0.moveTo(v.x,0);for(let s=0;s<8;s++){const sy=s/7*v.len;x0.lineTo(v.x+Math.sin(v.swing+s*0.5)*offset,sy);}x0.stroke();// Leaf nodes
  for(let l=0;l<3;l++){const ly=v.len*(0.3+l*0.3);x0.fillStyle=rgba(pc(v.ci),0.25);x0.beginPath();x0.ellipse(v.x+Math.sin(v.swing+(l+2)*0.5)*offset,ly,8,5,v.swing*0.5,0,Math.PI*2);x0.fill();}}
  // Jungle creatures ‚Äî birds, insects
  if(!SD.creatures){SD.creatures=Array.from({length:6},()=>mkJungleCreature(w,h));}
  for(let i=SD.creatures.length-1;i>=0;i--){const cr=SD.creatures[i];cr.x+=cr.vx*(1+SM.energy*0.3);cr.ph+=0.02;if(cr.x<-cr.sz*2){SD.creatures[i]=mkJungleCreature(w,h);continue;}x0.save();x0.translate(cr.x,cr.y+Math.sin(cr.ph)*cr.sz*0.08);x0.shadowBlur=20;x0.shadowColor=pc(cr.ci);x0.fillStyle=rgba(pc(cr.ci),0.5*THEME.sceneIntensity*(1+SM.beatPulse*0.15));x0.beginPath();x0.ellipse(0,0,cr.sz*0.5,cr.sz*0.3,0,0,Math.PI*2);x0.fill();x0.shadowBlur=0;x0.restore();}
  // Bioluminescent spores rising
  if(!SD.spores){SD.spores=Array.from({length:50},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.3,vy:-(0.2+Math.random()*0.6),r:1.5+Math.random()*3,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  for(const sp of SD.spores){sp.x+=sp.vx+Math.sin(sp.ph*0.5)*0.3;sp.y+=sp.vy*(1+SM.energy*0.2);sp.ph+=0.04;if(sp.y<-5){sp.y=h+5;sp.x=Math.random()*w;}const br=Math.sin(sp.ph)*0.4+0.6;x0.beginPath();x0.arc(sp.x,sp.y,sp.r*br,0,Math.PI*2);x0.fillStyle=rgba(pc(sp.ci),br*0.65*(0.4+songProg*0.7));x0.shadowBlur=8*(0.5+songProg);x0.shadowColor=pc(sp.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece ‚Äî bioluminescent fruit hanging at center
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.015;
    const fruitX=cx+Math.sin(t*0.0006)*w*0.05;
    const fruitY=h*0.32+Math.sin(t*0.0008)*h*0.03;
    const fruitSz=Math.min(w,h)*(0.1+SM.beatPulse*0.04)*(0.4+songProg*0.7);
    // Stem from canopy
    x0.strokeStyle=rgba(pc(2),0.4);x0.lineWidth=3;
    x0.beginPath();x0.moveTo(fruitX,0);x0.bezierCurveTo(fruitX+20,fruitY*0.3,fruitX-15,fruitY*0.6,fruitX,fruitY-fruitSz);x0.stroke();
    // Bio glow halo
    const fg=x0.createRadialGradient(fruitX,fruitY,0,fruitX,fruitY,fruitSz*2.5);
    fg.addColorStop(0,rgba(pc(2),0.18*(1+SM.beatPulse*0.5)));fg.addColorStop(0.5,rgba(pc(0),0.06));fg.addColorStop(1,'transparent');
    x0.fillStyle=fg;x0.fillRect(0,0,w,h);
    x0.shadowBlur=fruitSz*0.9;x0.shadowColor=rgba(pc(2),0.8);
    drawCPMini(x0,THEME.centerpiece,fruitX,fruitY,fruitSz,cpRot);
    x0.shadowBlur=0;
    // Bioluminescent drips
    for(let d=0;d<3;d++){x0.fillStyle=rgba(pc(2),0.3*(1-d*0.3));x0.beginPath();x0.arc(fruitX+(d-1)*fruitSz*0.3,fruitY+fruitSz*(0.6+d*0.25),fruitSz*0.06*(1-d*0.25),0,Math.PI*2);x0.fill();}
  }
}


// ‚ïê‚ïê‚ïê SCENE: discoDimension ‚ïê‚ïê‚ïê

function drawDiscoDimension(t){
  const w=W(),h=H(),cx=w/2;const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.disco){
    const cols=8,rows=6,tiles=[];for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)tiles.push({r,c,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,bright:Math.random(),strobe:Math.random()<0.3});
    SD.disco={tiles,cols,rows,
      balls:[{x:cx-w*0.25,y:h*0.12,rot:0,rotS:0.018,size:Math.min(w,h)*0.10,laserPh:0,laserSpeed:0.012,ci:0},{x:cx,y:h*0.09,rot:0,rotS:0.022,size:Math.min(w,h)*0.13,laserPh:Math.PI/3,laserSpeed:-0.009,ci:1},{x:cx+w*0.25,y:h*0.12,rot:0,rotS:0.016,size:Math.min(w,h)*0.10,laserPh:Math.PI,laserSpeed:0.015,ci:2}],
      floorBright:1,superFloor:false,superFloorTimer:0,superLaser:false,superLaserTimer:0,patternType:0,patternTimer:0,ripplePhase:0,wavePhase:0};
  }
  const D=SD.disco;if(D.superFloorTimer>0){D.superFloorTimer-=16;if(D.superFloorTimer<=0)D.superFloor=false;}if(D.superLaserTimer>0){D.superLaserTimer-=16;if(D.superLaserTimer<=0)D.superLaser=false;}
  const superFloor=D.superFloor,superLaser=D.superLaser,floorBrightMult=superFloor?(2+Math.sin(t*0.04)*0.5):1,laserMult=superLaser?3:1,ballSpeedMult=superLaser?4:1;
  D.patternTimer+=16;if(D.patternTimer>8000){D.patternTimer=0;D.patternType=(D.patternType+1)%5;}
  D.ripplePhase+=0.05+beat*0.1;D.wavePhase+=0.03+beat*0.06;
  // BG
  x0.fillStyle='rgba(4,0,12,1)';x0.fillRect(0,0,w,h);const ceilG=x0.createLinearGradient(0,0,0,h*0.1);ceilG.addColorStop(0,'rgba(12,8,25,1)');ceilG.addColorStop(1,'rgba(4,0,12,1)');x0.fillStyle=ceilG;x0.fillRect(0,0,w,h*0.1);
  // Floor ‚Äî framed, Saturday Night Fever
  const floorY=h*0.52,floorH=h*0.42,floorMargin=w*0.12,floorW=w-floorMargin*2,cols=D.cols,rows=D.rows,tw=floorW/cols,th2=floorH/rows;
  x0.strokeStyle=rgba(pc(0),0.6+beat*0.3);x0.lineWidth=4;x0.shadowBlur=20+beat*12;x0.shadowColor=pc(0);x0.strokeRect(floorMargin-2,floorY-2,floorW+4,floorH+4);x0.shadowBlur=0;
  x0.fillStyle='rgba(2,0,6,0.98)';x0.fillRect(0,floorY,floorMargin,floorH);x0.fillRect(w-floorMargin,floorY,floorMargin,floorH);
  for(const tile of D.tiles){tile.ph+=0.02+beat*0.04*(superFloor?3:1);
    const tx=floorMargin+tile.c*tw,ty=floorY+tile.r*th2,isLight=(tile.r+tile.c)%2===0;
    let pB=0,pCi=tile.ci;const tcx=tile.c-cols/2+0.5,tcy=tile.r-rows/2+0.5,dfc=Math.sqrt(tcx*tcx+tcy*tcy);
    switch(D.patternType){
      case 0:pB=Math.abs(Math.sin(D.ripplePhase-dfc*1.2))*0.9;pCi=Math.floor(dfc+D.ripplePhase*0.3)%4;break;
      case 1:{const onC=Math.abs(tcx)<1.2||Math.abs(tcy)<1.2,onD=Math.abs(Math.abs(tcx)-Math.abs(tcy))<1;pB=onC?(0.7+Math.sin(D.wavePhase*2)*0.3):(onD?(0.5+Math.sin(D.wavePhase*3)*0.3):0.15);pCi=onC?(Math.floor(D.wavePhase)%4):(onD?((Math.floor(D.wavePhase)+2)%4):tile.ci);break;}
      case 2:pB=Math.max(0,Math.sin(D.wavePhase*1.5+tile.r*0.8))*0.85;pCi=(tile.r+Math.floor(D.wavePhase))%4;break;
      case 3:pB=Math.max(0,Math.sin(D.wavePhase*1.5+tile.c*0.8))*0.85;pCi=(tile.c+Math.floor(D.wavePhase))%4;break;
      case 4:pB=Math.abs(Math.sin(D.ripplePhase-(Math.abs(tcx)+Math.abs(tcy))*0.7))*0.85;pCi=Math.floor((Math.abs(tcx)+Math.abs(tcy))+D.ripplePhase*0.5)%4;break;
    }
    if(beat>0.4){pB=Math.min(1,pB+beat*0.4);if(superFloor&&Math.random()<0.15)pCi=Math.floor(Math.random()*4);}
    const bright=pB*(0.7+beat*0.5),strobeMult=superFloor?(0.5+Math.sin(t*0.05+tile.ph)*0.5):1;
    const alpha=Math.min(1,(0.15+bright*0.85)*THEME.sceneIntensity*floorBrightMult*strobeMult);
    const c=h2r(pc(pCi));x0.fillStyle=`rgba(${c.r},${c.g},${c.b},${alpha*(isLight?1:0.5)})`;x0.shadowBlur=alpha>0.5?(12+beat*10+(superFloor?12:0)):0;x0.shadowColor=pc(pCi);x0.fillRect(tx,ty,tw,th2);x0.shadowBlur=0;
    x0.strokeStyle=`rgba(0,0,0,${0.6+alpha*0.2})`;x0.lineWidth=1.5;x0.strokeRect(tx,ty,tw,th2);
    if(alpha>0.5||superFloor){x0.fillStyle=`rgba(${c.r},${c.g},${c.b},${(alpha-0.3)*0.35})`;x0.shadowBlur=20;x0.shadowColor=pc(pCi);x0.fillRect(tx+2,ty+2,tw-4,th2-4);x0.shadowBlur=0;}
    if(alpha>0.6){const sG=x0.createLinearGradient(tx,ty,tx+tw,ty+th2);sG.addColorStop(0,'transparent');sG.addColorStop(0.4,`rgba(255,255,255,${alpha*0.08})`);sG.addColorStop(1,'transparent');x0.fillStyle=sG;x0.fillRect(tx,ty,tw,th2);}
  }
  x0.strokeStyle=rgba(pc(0),0.5+beat*0.4);x0.lineWidth=3;x0.shadowBlur=15;x0.shadowColor=pc(0);x0.beginPath();x0.moveTo(floorMargin,floorY);x0.lineTo(floorMargin+floorW,floorY);x0.stroke();x0.shadowBlur=0;
  // Disco balls ‚Äî faceted mirrors with centerpiece
  for(const ball of D.balls){ball.rot+=ball.rotS*ballSpeedMult*(1+energy*0.4);ball.laserPh+=ball.laserSpeed*ballSpeedMult*(1+beat*0.3);
    x0.strokeStyle='rgba(180,180,180,0.6)';x0.lineWidth=2;x0.beginPath();x0.moveTo(ball.x,0);x0.lineTo(ball.x,ball.y-ball.size);x0.stroke();
    const bSz=ball.size*(1+beat*0.06*ballSpeedMult);x0.save();
    const sG=x0.createRadialGradient(ball.x-bSz*0.2,ball.y-bSz*0.2,0,ball.x,ball.y,bSz);sG.addColorStop(0,'rgba(200,200,210,0.4)');sG.addColorStop(0.5,'rgba(100,100,120,0.3)');sG.addColorStop(1,'rgba(40,40,50,0.2)');x0.fillStyle=sG;x0.beginPath();x0.arc(ball.x,ball.y,bSz,0,Math.PI*2);x0.fill();
    for(let lat=0;lat<8;lat++)for(let lon=0;lon<14;lon++){const la=(lat/8-0.5)*Math.PI,lo=lon/14*Math.PI*2+ball.rot;const fx=Math.cos(la)*Math.cos(lo)*bSz*0.95,fy=Math.sin(la)*bSz*0.95,fz=Math.cos(la)*Math.sin(lo);if(fz<-0.1)continue;const vis=0.3+fz*0.7,fSz=(bSz*0.14)*(0.6+fz*0.4),sparkle=Math.abs(Math.sin(lo*3+ball.rot*2+lat))*vis;
      x0.fillStyle=`rgba(${200+Math.floor(sparkle*55)},${200+Math.floor(sparkle*55)},${210+Math.floor(sparkle*45)},${vis*0.35+sparkle*0.3+beat*0.15})`;x0.fillRect(ball.x+fx-fSz/2,ball.y+fy-fSz/2,fSz,fSz);
      if(sparkle>0.7){x0.fillStyle=rgba(pc((lat+lon)%4),(sparkle-0.5)*0.8+beat*0.3);x0.shadowBlur=6+beat*4;x0.shadowColor=pc((lat+lon)%4);x0.fillRect(ball.x+fx-fSz*0.3,ball.y+fy-fSz*0.3,fSz*0.6,fSz*0.6);x0.shadowBlur=0;}}
    x0.shadowBlur=bSz*0.5*(superLaser?1.8:1);x0.shadowColor=pc(ball.ci);x0.globalAlpha=0.7+beat*0.15;drawCPMini(x0,THEME.centerpiece,ball.x,ball.y,bSz*0.65,ball.rot);x0.globalAlpha=1;x0.shadowBlur=0;x0.restore();
    // Lasers
    const nL=superLaser?8:4;for(let lb=0;lb<nL;lb++){const la=ball.laserPh+lb/nL*Math.PI*2,lLen=Math.max(w,h)*1.5,lbx=ball.x+Math.cos(la)*lLen,lby=ball.y+Math.sin(la)*lLen,lci=(ball.ci+lb)%4,lA=(0.04+beat*0.08)*(superLaser?2:1)*laserMult;
      x0.save();x0.globalAlpha=lA;const lg=x0.createLinearGradient(ball.x,ball.y,lbx,lby);const lc=h2r(pc(lci));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;const pa=la+Math.PI/2,bW=superLaser?10:5;x0.beginPath();x0.moveTo(ball.x+Math.cos(pa)*bW,ball.y+Math.sin(pa)*bW);x0.lineTo(ball.x-Math.cos(pa)*bW,ball.y-Math.sin(pa)*bW);x0.lineTo(lbx-Math.cos(pa)*bW*8,lby-Math.sin(pa)*bW*8);x0.lineTo(lbx+Math.cos(pa)*bW*8,lby+Math.sin(pa)*bW*8);x0.closePath();x0.fill();x0.restore();
      x0.strokeStyle=rgba(pc(lci),(0.2+beat*0.4)*(superLaser?2:1));x0.lineWidth=superLaser?2.5:1.5;x0.shadowBlur=superLaser?20:10;x0.shadowColor=pc(lci);x0.beginPath();x0.moveTo(ball.x,ball.y);x0.lineTo(lbx,lby);x0.stroke();x0.shadowBlur=0;
      if(lby>floorY&&lby<h){x0.fillStyle=rgba(pc(lci),(0.4+beat*0.4)*(superLaser?2:1));x0.shadowBlur=superLaser?20:12;x0.shadowColor=pc(lci);x0.beginPath();x0.arc(lbx,Math.min(lby,h-5),(superLaser?12:8)+beat*(superLaser?10:5),0,Math.PI*2);x0.fill();x0.shadowBlur=0;}}
  }
  // Floor glow pools
  for(const ball of D.balls){const pG=x0.createRadialGradient(ball.x,floorY,0,ball.x,floorY,w*0.2);pG.addColorStop(0,rgba(pc(ball.ci),0.08*(1+beat*0.4)));pG.addColorStop(1,'transparent');x0.fillStyle=pG;x0.fillRect(0,floorY,w,floorH);}
}


// ‚ïê‚ïê‚ïê SCENE: acidTrip ‚ïê‚ïê‚ïê

function drawAcidTrip(t){
  const w=W(),h=H();
  SD.fracPh=(SD.fracPh||0)+0.015*(1+SM.energy*0.3);SD.colorCyc=(SD.colorCyc||0)+0.008;
  const ci1=Math.floor(SD.colorCyc)%4,ci2=(Math.floor(SD.colorCyc)+1)%4,frac=SD.colorCyc%1;
  const ac=h2r(pc(ci1)),bc=h2r(pc(ci2));
  x0.fillStyle=`rgb(${Math.round(lerp(ac.r,bc.r,frac)*0.07)},${Math.round(lerp(ac.g,bc.g,frac)*0.07)},${Math.round(lerp(ac.b,bc.b,frac)*0.07)})`;x0.fillRect(0,0,w,h);
  if(!SD.warpGrid)return;
  const gw=w/20,gh=h/14;
  for(const gp of SD.warpGrid){gp.ph+=0.02*(1+SM.energy*0.2);const wx=gp.gx*gw+Math.sin(gp.ph+gp.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy=gp.gy*gh+Math.cos(gp.ph+gp.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const gc=Math.floor((gp.gx+gp.gy+SD.colorCyc)%4);x0.fillStyle=rgba(pc(gc),0.5*THEME.sceneIntensity);x0.fillRect(wx-2,wy-2,4,4);}
  for(let gx=0;gx<19;gx++)for(let gy=0;gy<13;gy++){const p1=SD.warpGrid[gy*20+gx],p2=SD.warpGrid[gy*20+gx+1],p3=SD.warpGrid[(gy+1)*20+gx];if(!p1||!p2||!p3)continue;const wx1=p1.gx*gw+Math.sin(p1.ph+p1.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy1=p1.gy*gh+Math.cos(p1.ph+p1.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const wx2=p2.gx*gw+Math.sin(p2.ph+p2.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy2=p2.gy*gh+Math.cos(p2.ph+p2.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const wx3=p3.gx*gw+Math.sin(p3.ph+p3.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy3=p3.gy*gh+Math.cos(p3.ph+p3.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const gc=Math.floor((gx+gy+SD.colorCyc)%4);x0.strokeStyle=rgba(pc(gc),0.2*THEME.sceneIntensity);x0.lineWidth=1;x0.beginPath();x0.moveTo(wx1,wy1);x0.lineTo(wx2,wy2);x0.stroke();x0.beginPath();x0.moveTo(wx1,wy1);x0.lineTo(wx3,wy3);x0.stroke();}
  x0.save();x0.translate(w/2,h/2);for(let seg=0;seg<8;seg++){const r=SD.fracPh+seg/8*Math.PI*2;for(let ri=0;ri<5;ri++){x0.beginPath();x0.arc(0,0,ri*60+SM.beatPulse*20,r,r+Math.PI*2*0.9/8);x0.strokeStyle=rgba(pc((ri+seg)%4),(0.3-ri*0.04)*THEME.sceneIntensity*(1+SM.beatPulse*0.3));x0.lineWidth=3-ri*0.4;x0.stroke();}}x0.restore();
  // Centerpiece melts and warps into grid ‚Äî appears as distorted ghost in the geometry
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece melts into the warp grid
    const melt=Math.min(1,songProg*1.4);
    const meltX=w/2+Math.sin(SD.fracPh*1.3)*w*0.15*melt;
    const meltY=h/2+Math.cos(SD.fracPh)*h*0.1*melt;
    const ms=Math.min(w,h)*(0.12+SM.beatPulse*0.04);
    cpRot+=0.02*(1+melt);cpPh+=0.013;
    x0.save();
    x0.translate(meltX,meltY);
    x0.scale(1+Math.sin(SD.fracPh*2)*0.25*melt,1+Math.cos(SD.fracPh*1.5)*0.25*melt);
    x0.globalAlpha=(0.2+SM.beatPulse*0.12)*(1+melt*0.4);
    drawCP(x0,THEME.centerpiece,ms,cpPh*100);
    x0.globalAlpha=1;x0.restore();
  }
}


// ‚ïê‚ïê‚ïê SCENE: spaceStation ‚ïê‚ïê‚ïê

function drawSpaceStation(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.space){
    SD.space={stars:Array.from({length:200},()=>({x:(Math.random()-0.5)*2,y:(Math.random()-0.5)*2,z:Math.random(),ci:Math.floor(Math.random()*4),trail:[]})),
      comets:Array.from({length:8},(_,i)=>({x:Math.random()*w*1.5-w*0.25,y:Math.random()*h*0.6,vx:-(4+Math.random()*8),vy:2+Math.random()*4,trailLen:120+Math.random()*180,ci:i%4,active:Math.random()>0.5,resetTimer:Math.random()*5000})),
      shootingStars:Array.from({length:5},()=>({x:-100,y:-100,active:false,timer:Math.random()*8000})),
      nebulae:Array.from({length:4},(_,i)=>({x:w*(0.1+i*0.25),y:h*(0.1+Math.random()*0.5),r:80+Math.random()*120,ci:i%4,ph:Math.random()*Math.PI*2})),
      ufos:[],superUFO:false,superUFOTimer:0,
      starExplosion:false,starExpTimer:0,starExpX:cx*0.35,starExpY:cy*0.45,starExpR:0,starExpParticles:[],
      starExpPhase:'dormant',starExpBuildUp:0,starExpStrobeTimer:0,
      asteroidShower:false,asteroidTimer:0,asteroids:[],
      issX:w*0.3,issY:h*0.25,issRot:0,issVx:0.08,issRotSpeed:0.0003};
  }
  const SP=SD.space;
  if(SP.superUFOTimer>0){SP.superUFOTimer-=16;if(SP.superUFOTimer<=0){SP.superUFO=false;SP.ufos=[];}}
  if(SP.starExpTimer>0){SP.starExpTimer-=16;if(SP.starExpTimer<=0){SP.starExplosion=false;SP.starExpParticles=[];SP.starExpPhase='dormant';SP.starExpBuildUp=0;SP.starExpStrobeTimer=0;}}
  if(SP.asteroidTimer>0){SP.asteroidTimer-=16;if(SP.asteroidTimer<=0){SP.asteroidShower=false;SP.asteroids=[];}}
  // BG
  x0.fillStyle='rgba(0,0,4,1)';x0.fillRect(0,0,w,h);
  for(const nb of SP.nebulae){nb.ph+=0.005;const ng=x0.createRadialGradient(nb.x+Math.sin(nb.ph)*20,nb.y+Math.cos(nb.ph*0.7)*15,0,nb.x,nb.y,nb.r*(1+beat*0.1));ng.addColorStop(0,rgba(pc(nb.ci),0.07+beat*0.03));ng.addColorStop(0.5,rgba(pc((nb.ci+1)%4),0.04));ng.addColorStop(1,'transparent');x0.fillStyle=ng;x0.fillRect(0,0,w,h);}
  // ISS ‚Äî faint neon-line
  SP.issX+=SP.issVx;SP.issRot+=SP.issRotSpeed;if(SP.issX>w+200)SP.issX=-200;
  x0.save();x0.translate(SP.issX,SP.issY);x0.rotate(SP.issRot);const iS=0.35,iA=0.18+beat*0.06;
  x0.strokeStyle=rgba(pc(2),iA);x0.lineWidth=1.5;x0.shadowBlur=6;x0.shadowColor=pc(2);
  x0.beginPath();x0.moveTo(-120*iS,0);x0.lineTo(120*iS,0);x0.stroke();
  x0.strokeStyle=rgba(pc(1),iA*1.2);x0.lineWidth=2;x0.strokeRect(-20*iS,-8*iS,40*iS,16*iS);x0.strokeRect(-35*iS,-6*iS,15*iS,12*iS);x0.strokeRect(20*iS,-6*iS,15*iS,12*iS);
  x0.strokeStyle=rgba(pc(0),iA);x0.lineWidth=1;
  for(const px of[-100,-70,70,100]){x0.strokeRect((px-14)*iS,-28*iS,28*iS,20*iS);x0.strokeRect((px-14)*iS,8*iS,28*iS,20*iS);for(let pl=0;pl<3;pl++){x0.beginPath();x0.moveTo((px-14+pl*9.3)*iS,-28*iS);x0.lineTo((px-14+pl*9.3)*iS,-8*iS);x0.stroke();x0.beginPath();x0.moveTo((px-14+pl*9.3)*iS,8*iS);x0.lineTo((px-14+pl*9.3)*iS,28*iS);x0.stroke();}}
  x0.shadowBlur=0;x0.restore();
  // Stars ‚Äî bigger
  for(const s of SP.stars){s.z-=0.0006*THEME.sceneSpeed*(1+beatFX.speedBoost*0.3)*(1+energy*0.3);if(s.z<0.01){s.z=1;s.x=(Math.random()-0.5)*2;s.y=(Math.random()-0.5)*2;s.trail=[];}
    const px=cx+(s.x/s.z)*cx,py=cy+(s.y/s.z)*cy;if(px<-10||px>w+10||py<-10||py>h+10)continue;
    const sz=(1-s.z)*5+0.5,alpha=(1-s.z)*0.95;x0.fillStyle=rgba(pc(s.ci),alpha);x0.shadowBlur=(1-s.z)>0.6?10+beat*4:3;x0.shadowColor=pc(s.ci);x0.beginPath();x0.arc(px,py,sz,0,Math.PI*2);x0.fill();
    if((1-s.z)>0.5){s.trail.push({x:px,y:py});if(s.trail.length>5)s.trail.shift();if(s.trail.length>1){x0.strokeStyle=rgba(pc(s.ci),alpha*0.5);x0.lineWidth=sz*0.6;x0.beginPath();for(let i=0;i<s.trail.length;i++){if(i===0)x0.moveTo(s.trail[i].x,s.trail[i].y);else x0.lineTo(s.trail[i].x,s.trail[i].y);}x0.stroke();}}x0.shadowBlur=0;}
  // Comets ‚Äî bigger
  for(const cm of SP.comets){if(!cm.active){cm.resetTimer-=16;if(cm.resetTimer<=0){cm.x=w+50+Math.random()*w*0.5;cm.y=Math.random()*h*0.7;cm.active=true;cm.resetTimer=3000+Math.random()*5000;}continue;}
    cm.x+=cm.vx*(1+energy*0.3+beat*0.1);cm.y+=cm.vy*(0.5+energy*0.2);if(cm.x<-cm.trailLen||cm.y>h+50)cm.active=false;
    x0.fillStyle=rgba(pc(cm.ci),0.95);x0.shadowBlur=18+beat*10;x0.shadowColor=pc(cm.ci);x0.beginPath();x0.arc(cm.x,cm.y,7+beat*3,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
    const tdx=-cm.vx/Math.hypot(cm.vx,cm.vy),tdy=-cm.vy/Math.hypot(cm.vx,cm.vy);const tG=x0.createLinearGradient(cm.x,cm.y,cm.x+tdx*cm.trailLen,cm.y+tdy*cm.trailLen);const tc=h2r(pc(cm.ci));tG.addColorStop(0,`rgba(${tc.r},${tc.g},${tc.b},0.8)`);tG.addColorStop(1,'transparent');x0.strokeStyle=tG;x0.lineWidth=5+beat*3;x0.beginPath();x0.moveTo(cm.x,cm.y);x0.lineTo(cm.x+tdx*cm.trailLen,cm.y+tdy*cm.trailLen);x0.stroke();
    x0.strokeStyle=rgba(pc(cm.ci),0.2);x0.lineWidth=12+beat*6;x0.beginPath();x0.moveTo(cm.x,cm.y);x0.lineTo(cm.x+tdx*cm.trailLen*0.6,cm.y+tdy*cm.trailLen*0.6);x0.stroke();}
  // Shooting stars
  for(const ss of SP.shootingStars){if(!ss.active){ss.timer-=16;if(ss.timer<=0){ss.x=Math.random()*w*0.7;ss.y=Math.random()*h*0.4;ss.vx=4+Math.random()*8;ss.vy=2+Math.random()*4;ss.len=80+Math.random()*140;ss.life=1;ss.ci=Math.floor(Math.random()*4);ss.active=true;}}
    else{ss.x+=ss.vx;ss.y+=ss.vy;ss.life-=0.02;if(ss.life<=0){ss.active=false;ss.timer=4000+Math.random()*8000;continue;}x0.fillStyle=rgba(pc(ss.ci),ss.life*0.95);x0.shadowBlur=14;x0.shadowColor=pc(ss.ci);x0.beginPath();x0.arc(ss.x,ss.y,4,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
      const sG=x0.createLinearGradient(ss.x,ss.y,ss.x-ss.vx*(ss.len/ss.vx),ss.y-ss.vy*(ss.len/ss.vx));sG.addColorStop(0,rgba(pc(ss.ci),ss.life*0.85));sG.addColorStop(1,'transparent');x0.strokeStyle=sG;x0.lineWidth=2.5;x0.beginPath();x0.moveTo(ss.x,ss.y);x0.lineTo(ss.x-ss.vx*ss.len/Math.hypot(ss.vx,ss.vy),ss.y-ss.vy*ss.len/Math.hypot(ss.vx,ss.vy));x0.stroke();}}
  // Centerpiece
  if(THEME.centerpiece){cpRot+=0.015*(1+energy*0.2+beat*0.1);cpPh+=0.013;const gs=Math.min(w,h)*(0.22+beat*0.06+songProg*0.05);x0.shadowBlur=20+beat*20+songProg*10;x0.shadowColor=pc(0);x0.globalAlpha=0.9+beat*0.1;drawCPMini(x0,THEME.centerpiece,cx,cy*0.82,gs,cpRot);x0.globalAlpha=1;x0.shadowBlur=0;
    for(let or2=0;or2<3;or2++){const orR=gs*(1.4+or2*0.55);x0.strokeStyle=rgba(pc(or2%4),(0.12+beat*0.12));x0.lineWidth=1;x0.shadowBlur=6;x0.shadowColor=pc(or2%4);x0.beginPath();x0.ellipse(cx,cy*0.82,orR,orR*0.3,or2*0.3+t*0.0003,0,Math.PI*2);x0.stroke();x0.shadowBlur=0;}}
  // UFO Swarm
  if(SP.superUFO){while(SP.ufos.length<20)SP.ufos.push({x:Math.random()*w,y:h*(0.05+Math.random()*0.6),phase:Math.random()*Math.PI*2,speed:(Math.random()-0.5)*2,orbitR:30+Math.random()*80,orbitA:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4),beamOn:Math.random()>0.5});
    for(const u of SP.ufos){u.orbitA+=u.speed*0.015*(1+beat*0.5);u.x+=Math.cos(u.orbitA)*u.orbitR*0.005;u.y+=Math.sin(u.orbitA)*u.orbitR*0.003;if(u.x<-60)u.x=w+60;if(u.x>w+60)u.x=-60;if(u.y<0)u.y=h*0.1;if(u.y>h*0.7)u.y=h*0.6;const strobe=0.5+Math.sin(t*0.04+u.phase)*0.5+beat*0.4;
      x0.fillStyle=rgba(pc(u.ci),(0.4+strobe*0.4)*0.85);x0.shadowBlur=15+beat*10;x0.shadowColor=pc(u.ci);x0.beginPath();x0.ellipse(u.x,u.y,28,10,0,0,Math.PI*2);x0.fill();x0.fillStyle=rgba(pc((u.ci+1)%4),(0.6+strobe*0.4));x0.beginPath();x0.ellipse(u.x,u.y-8,14,10,0,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
      for(let w2=0;w2<5;w2++){const wa=w2/5*Math.PI*2+u.orbitA;x0.fillStyle=rgba(pc((u.ci+w2)%4),strobe*0.9);x0.beginPath();x0.arc(u.x+Math.cos(wa)*18,u.y+Math.sin(wa)*4,3,0,Math.PI*2);x0.fill();}
      if(u.beamOn&&beat>0.3){const bG=x0.createLinearGradient(u.x,u.y+10,u.x,h*0.95);const bc=h2r(pc(u.ci));bG.addColorStop(0,`rgba(${bc.r},${bc.g},${bc.b},${0.25*strobe})`);bG.addColorStop(1,'transparent');x0.fillStyle=bG;x0.beginPath();x0.moveTo(u.x-15,u.y+10);x0.lineTo(u.x+15,u.y+10);x0.lineTo(u.x+40,h*0.95);x0.lineTo(u.x-40,h*0.95);x0.closePath();x0.fill();}}}
  // STAR EXPLOSION ‚Äî massive, offset, slow buildup, 15s strobe
  if(SP.starExplosion){
    const totalTime=35000;const buildTime=8000;const blastTime=2000;const strobeTime=15000;const fadeTime=totalTime-buildTime-blastTime-strobeTime;
    const elapsed=totalTime-SP.starExpTimer;const ex=SP.starExpX,ey=SP.starExpY;
    if(elapsed<buildTime){
      // Slow buildup ‚Äî star grows brighter, pulses
      SP.starExpBuildUp=elapsed/buildTime;const prog=SP.starExpBuildUp;const pulse=1+Math.sin(t*0.02*(1+prog*3))*0.3*prog;const starR=Math.min(w,h)*(0.03+prog*0.12)*pulse;
      const sg=x0.createRadialGradient(ex,ey,0,ex,ey,starR);sg.addColorStop(0,`rgba(255,255,${Math.floor(200+prog*55)},${0.3+prog*0.7})`);sg.addColorStop(0.3,rgba(pc(0),0.5*prog));sg.addColorStop(1,'transparent');x0.fillStyle=sg;x0.fillRect(0,0,w,h);
      // Core dot
      x0.fillStyle=`rgba(255,255,255,${0.5+prog*0.5})`;x0.shadowBlur=30*prog+beat*20;x0.shadowColor=`rgba(255,255,200,${prog})`;x0.beginPath();x0.arc(ex,ey,4+prog*12,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
      // Rays
      for(let r=0;r<8;r++){const ra=r/8*Math.PI*2+t*0.003;const rl=starR*(0.8+Math.sin(ra*3+t*0.01)*0.3);x0.strokeStyle=rgba(pc(r%4),0.2*prog+beat*0.1);x0.lineWidth=2;x0.beginPath();x0.moveTo(ex,ey);x0.lineTo(ex+Math.cos(ra)*rl,ey+Math.sin(ra)*rl);x0.stroke();}
    } else if(elapsed<buildTime+blastTime){
      // MASSIVE EXPLOSION ‚Äî fills screen
      const blastProg=(elapsed-buildTime)/blastTime;const blastR=Math.max(w,h)*1.5*blastProg;
      x0.fillStyle=`rgba(255,255,255,${(1-blastProg)*0.9})`;x0.fillRect(0,0,w,h);
      const bg=x0.createRadialGradient(ex,ey,0,ex,ey,blastR);bg.addColorStop(0,rgba(pc(Math.floor(t*0.02)%4),0.9*(1-blastProg*0.3)));bg.addColorStop(0.5,rgba(pc((Math.floor(t*0.02)+2)%4),0.5));bg.addColorStop(1,'transparent');x0.fillStyle=bg;x0.fillRect(0,0,w,h);
      // Spawn debris
      if(SP.starExpParticles.length<300){for(let i=0;i<15;i++){const a=Math.random()*Math.PI*2,spd=5+Math.random()*20;SP.starExpParticles.push({x:ex,y:ey,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:1,r:3+Math.random()*8,ci:Math.floor(Math.random()*4)});}}
    } else if(elapsed<buildTime+blastTime+strobeTime){
      // 15-SECOND COLORFUL STROBE
      SP.starExpStrobeTimer+=16;const sProg=(elapsed-buildTime-blastTime)/strobeTime;
      const strobeSpeed=0.06+beat*0.08+sProg*0.04;const strobeVal=Math.sin(SP.starExpStrobeTimer*strobeSpeed);const sCi=Math.floor(SP.starExpStrobeTimer*0.008+strobeVal*2)%4;
      const sAlpha=(1-sProg*0.5)*(0.3+Math.abs(strobeVal)*0.5+beat*0.3);
      x0.fillStyle=rgba(pc(sCi),sAlpha*0.7);x0.fillRect(0,0,w,h);
      // Radial burst waves
      const waveR=(SP.starExpStrobeTimer*0.5)%(Math.max(w,h));x0.strokeStyle=rgba(pc((sCi+1)%4),sAlpha*0.5);x0.lineWidth=4+beat*6;x0.shadowBlur=20+beat*15;x0.shadowColor=pc((sCi+1)%4);x0.beginPath();x0.arc(ex,ey,waveR,0,Math.PI*2);x0.stroke();x0.shadowBlur=0;
      // Cross beams
      for(let cb=0;cb<4;cb++){const cba=cb/4*Math.PI*2+t*0.002;x0.strokeStyle=rgba(pc(cb),sAlpha*0.4);x0.lineWidth=8+beat*10;x0.shadowBlur=15;x0.shadowColor=pc(cb);x0.beginPath();x0.moveTo(ex,ey);x0.lineTo(ex+Math.cos(cba)*w,ey+Math.sin(cba)*h);x0.stroke();x0.shadowBlur=0;}
    } else {
      // Fade out
      const fProg=(elapsed-buildTime-blastTime-strobeTime)/fadeTime;const fAlpha=(1-fProg)*0.3;
      const fg=x0.createRadialGradient(ex,ey,0,ex,ey,Math.max(w,h)*0.5*(1-fProg));fg.addColorStop(0,rgba(pc(0),fAlpha));fg.addColorStop(1,'transparent');x0.fillStyle=fg;x0.fillRect(0,0,w,h);
    }
    // Particles throughout
    for(let i=SP.starExpParticles.length-1;i>=0;i--){const p=SP.starExpParticles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;p.vx*=0.995;p.life-=0.005;if(p.life<=0){SP.starExpParticles.splice(i,1);continue;}
      x0.fillStyle=rgba(pc(p.ci),p.life*0.9);x0.shadowBlur=12;x0.shadowColor=pc(p.ci);x0.beginPath();x0.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  }
  // Asteroid shower
  if(SP.asteroidShower){while(SP.asteroids.length<35)SP.asteroids.push({x:Math.random()*w*1.5,y:-50-Math.random()*200,vx:-(2+Math.random()*5),vy:3+Math.random()*6,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.08,sz:8+Math.random()*30,ci:Math.floor(Math.random()*4),points:5+Math.floor(Math.random()*4)});
    for(let i=SP.asteroids.length-1;i>=0;i--){const a=SP.asteroids[i];a.x+=a.vx*(1+beat*0.3);a.y+=a.vy*(1+beat*0.2);a.rot+=a.rotS;if(a.y>h+80){SP.asteroids.splice(i,1);continue;}
      x0.save();x0.translate(a.x,a.y);x0.rotate(a.rot);x0.fillStyle=rgba(pc(a.ci),0.6+beat*0.2);x0.strokeStyle=rgba(pc((a.ci+1)%4),0.8);x0.lineWidth=2;x0.shadowBlur=8+beat*6;x0.shadowColor=pc(a.ci);
      x0.beginPath();for(let pt=0;pt<a.points;pt++){const pa=pt/a.points*Math.PI*2,pr=a.sz*(0.7+Math.sin(pa*a.points*0.5)*0.3);if(pt===0)x0.moveTo(Math.cos(pa)*pr,Math.sin(pa)*pr);else x0.lineTo(Math.cos(pa)*pr,Math.sin(pa)*pr);}x0.closePath();x0.fill();x0.stroke();x0.shadowBlur=0;x0.restore();}}
}

// Track hull breach state
if(typeof SD.hullBreachActive==='undefined'){}


// ‚ïê‚ïê‚ïê SCENE: neonCathedral ‚ïê‚ïê‚ïê

function mkTetPiece(w,h){
  const shapes=[[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[2,0],[1,1]],[[0,0],[1,0],[2,0],[2,1]],[[0,1],[1,1],[1,0],[2,0]]];
  const s=shapes[Math.floor(Math.random()*shapes.length)];
  return{x:Math.random()*w*0.8+w*0.1,y:-50,vy:0.5+Math.random()*0.8,rot:0,rotS:(Math.random()-0.5)*0.01,blocks:s,ci:Math.floor(Math.random()*4)};
}

function drawGalaShip(ctx,x,y,ci){
  ctx.save();ctx.translate(x,y);
  ctx.fillStyle=rgba(pc(ci),0.85);ctx.shadowBlur=10;ctx.shadowColor=pc(ci);
  ctx.beginPath();ctx.moveTo(0,-14);ctx.lineTo(10,8);ctx.lineTo(5,5);ctx.lineTo(0,10);ctx.lineTo(-5,5);ctx.lineTo(-10,8);ctx.closePath();ctx.fill();
  ctx.fillStyle=rgba(pc((ci+1)%4),0.7);ctx.beginPath();ctx.arc(0,-2,5,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;ctx.restore();
}

function drawNeonCathedral(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;

  // ‚îÄ‚îÄ Init scene data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!SD.cath){
    const groundY=h*0.92;
    // 4 gargoyles on pedestals ‚Äî wider gap between middle two for centerpiece/doors
    SD.cath={
      groundY,
      gargoyles:[
        {x:cx-w*0.38, y:groundY, side:-1, ci:0, headAngle:0, wingFlare:0, lunge:0, flyMode:false, flyVx:0, flyVy:0, origX:cx-w*0.38, origY:groundY},
        {x:cx-w*0.14, y:groundY, side:-1, ci:1, headAngle:Math.PI*0.5, wingFlare:0, lunge:0, flyMode:false, flyVx:0, flyVy:0, origX:cx-w*0.14, origY:groundY},
        {x:cx+w*0.14, y:groundY, side:1,  ci:2, headAngle:Math.PI, wingFlare:0, lunge:0, flyMode:false, flyVx:0, flyVy:0, origX:cx+w*0.14, origY:groundY},
        {x:cx+w*0.38, y:groundY, side:1,  ci:3, headAngle:Math.PI*1.5, wingFlare:0, lunge:0, flyMode:false, flyVx:0, flyVy:0, origX:cx+w*0.38, origY:groundY},
      ],
      motes:Array.from({length:35},()=>({x:Math.random()*w,y:Math.random()*h,vy:-(0.2+Math.random()*0.4),r:1+Math.random()*2,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)})),
      gargoyleAlive:false, gargoyleAliveTimer:0,
      doorsOpen:false, doorsOpenTimer:0,
      gargoyleFireBreath:false, gargoyleFireTimer:0,
    };
  }
  const C=SD.cath;
  const groundY=C.groundY;

  // ‚îÄ‚îÄ Surprise timer updates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(C.gargoyleAlive){
    C.gargoyleAliveTimer-=16;
    if(C.gargoyleAliveTimer<=0){
      C.gargoyleAlive=false;
      C.gargoyles.forEach(g=>{g.flyMode=false;g.x=g.origX;g.y=g.origY;});
    } else {
      for(const g of C.gargoyles){
        if(g.flyMode){
          g.x+=g.flyVx*(1+beat*0.5);g.y+=g.flyVy*(1+beat*0.3);
          g.flyVy+=0.03;
          if(g.x<w*0.05||g.x>w*0.95)g.flyVx*=-0.85;
          if(g.y<h*0.05||g.y>h*0.88){g.flyVy*=-0.9;g.y=Math.max(h*0.05,Math.min(h*0.88,g.y));}
        }
      }
    }
  }
  if(C.doorsOpen){C.doorsOpenTimer-=16;if(C.doorsOpenTimer<=0)C.doorsOpen=false;}
  if(C.gargoyleFireBreath){C.gargoyleFireTimer-=16;if(C.gargoyleFireTimer<=0)C.gargoyleFireBreath=false;}

  // ‚îÄ‚îÄ Helper: neon stroke ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const neon=(ci,alpha=0.7,blur=12)=>{
    x0.strokeStyle=rgba(pc(ci),Math.min(1,alpha*(1+beat*0.2)));
    x0.shadowBlur=blur*(1+beat*0.3);x0.shadowColor=pc(ci);
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BACKGROUND ‚Äî dark sky with subtle gradient
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const sky=x0.createLinearGradient(0,0,0,h);
  const c0=h2r(pc(0));
  sky.addColorStop(0,`rgba(${Math.round(c0.r*0.04)},${Math.round(c0.g*0.03)},${Math.round(c0.b*0.07)},1)`);
  sky.addColorStop(0.6,'rgba(3,3,12,1)');
  sky.addColorStop(1,'rgba(0,0,0,1)');
  x0.fillStyle=sky;x0.fillRect(0,0,w,h);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // GOTHIC CHURCH FA√áADE ‚Äî neon outline silhouette behind gargoyles
  // Perspective: walking up to the front entrance
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const facadeW=w*0.7;
  const facadeL=cx-facadeW/2;
  const facadeR2=cx+facadeW/2;
  const roofY=h*0.08;
  const doorTopY=h*0.48;
  const doorW=w*0.16;
  const doorH=groundY-doorTopY;
  const towW=w*0.09;
  const towH=h*0.85;

  x0.lineWidth=2;x0.lineCap='round';

  // Left tower
  neon(0,0.45,10);
  x0.beginPath();
  x0.moveTo(facadeL,groundY);x0.lineTo(facadeL,groundY-towH);
  x0.lineTo(facadeL+towW*0.5,groundY-towH-h*0.06); // spire point
  x0.lineTo(facadeL+towW,groundY-towH);
  x0.lineTo(facadeL+towW,groundY);
  x0.stroke();
  // Tower window (pointed arch)
  x0.beginPath();
  const ltcx=facadeL+towW/2, ltwy=groundY-towH+h*0.12;
  x0.moveTo(ltcx-towW*0.25,ltwy+h*0.08);
  x0.lineTo(ltcx-towW*0.25,ltwy);
  x0.quadraticCurveTo(ltcx,ltwy-h*0.04,ltcx+towW*0.25,ltwy);
  x0.lineTo(ltcx+towW*0.25,ltwy+h*0.08);
  x0.stroke();

  // Right tower (mirror)
  neon(1,0.45,10);
  x0.beginPath();
  x0.moveTo(facadeR2,groundY);x0.lineTo(facadeR2,groundY-towH);
  x0.lineTo(facadeR2-towW*0.5,groundY-towH-h*0.06);
  x0.lineTo(facadeR2-towW,groundY-towH);
  x0.lineTo(facadeR2-towW,groundY);
  x0.stroke();
  const rtcx=facadeR2-towW/2, rtwy=groundY-towH+h*0.12;
  x0.beginPath();
  x0.moveTo(rtcx-towW*0.25,rtwy+h*0.08);
  x0.lineTo(rtcx-towW*0.25,rtwy);
  x0.quadraticCurveTo(rtcx,rtwy-h*0.04,rtcx+towW*0.25,rtwy);
  x0.lineTo(rtcx+towW*0.25,rtwy+h*0.08);
  x0.stroke();

  // Main nave wall between towers
  neon(2,0.35,8);x0.lineWidth=1.5;
  x0.beginPath();
  x0.moveTo(facadeL+towW,groundY);x0.lineTo(facadeL+towW,roofY+h*0.12);
  // Peaked roof
  x0.lineTo(cx,roofY);
  x0.lineTo(facadeR2-towW,roofY+h*0.12);
  x0.lineTo(facadeR2-towW,groundY);
  x0.stroke();

  // Flying buttresses (2 per side)
  neon(3,0.25,6);x0.lineWidth=1.2;
  for(let side=-1;side<=1;side+=2){
    const tBase=side<0?facadeL+towW:facadeR2-towW;
    for(let b=0;b<2;b++){
      const by=groundY-h*0.25-b*h*0.2;
      const bx=tBase+side*(towW*0.8+b*w*0.04);
      x0.beginPath();
      x0.moveTo(tBase,by);
      x0.quadraticCurveTo(tBase+side*towW*0.4,by-h*0.05,bx,by+h*0.08);
      x0.stroke();
      // Buttress pillar
      x0.beginPath();x0.moveTo(bx,by+h*0.08);x0.lineTo(bx,groundY);x0.stroke();
    }
  }

  // Rose window ‚Äî large circle with radial spokes
  neon(0,0.5+beat*0.2,15);x0.lineWidth=2;
  const roseY=roofY+h*0.16;
  const roseR=Math.min(w,h)*0.09;
  x0.beginPath();x0.arc(cx,roseY,roseR,0,Math.PI*2);x0.stroke();
  // Inner ring
  neon(1,0.4,10);x0.lineWidth=1.5;
  x0.beginPath();x0.arc(cx,roseY,roseR*0.6,0,Math.PI*2);x0.stroke();
  // Radial spokes
  for(let sp=0;sp<12;sp++){
    const a=sp/12*Math.PI*2+t*0.0005;
    neon(sp%4,0.3+beat*0.15,8);x0.lineWidth=1;
    x0.beginPath();
    x0.moveTo(cx+Math.cos(a)*roseR*0.2,roseY+Math.sin(a)*roseR*0.2);
    x0.lineTo(cx+Math.cos(a)*roseR*0.95,roseY+Math.sin(a)*roseR*0.95);
    x0.stroke();
  }

  // Pointed arch windows flanking rose window
  neon(2,0.3,8);x0.lineWidth=1.2;
  for(let side=-1;side<=1;side+=2){
    const awx=cx+side*w*0.17,awy=roseY+h*0.08;
    const aww=w*0.04,awh=h*0.12;
    x0.beginPath();
    x0.moveTo(awx-aww,awy+awh);
    x0.lineTo(awx-aww,awy);
    x0.quadraticCurveTo(awx,awy-awh*0.3,awx+aww,awy);
    x0.lineTo(awx+aww,awy+awh);
    x0.stroke();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MAIN DOORS ‚Äî large pointed arch, centerpiece visible inside
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const dlx=cx-doorW/2, drx=cx+doorW/2;

  // Door opening ‚Äî dark interior
  x0.fillStyle='rgba(0,0,0,0.85)';
  x0.beginPath();
  x0.moveTo(dlx,groundY);x0.lineTo(dlx,doorTopY+doorH*0.15);
  x0.quadraticCurveTo(cx,doorTopY-doorH*0.08,drx,doorTopY+doorH*0.15);
  x0.lineTo(drx,groundY);x0.closePath();x0.fill();

  // Door arch outline
  neon(3,0.6+beat*0.2,16);x0.lineWidth=2.5;
  x0.beginPath();
  x0.moveTo(dlx,groundY);x0.lineTo(dlx,doorTopY+doorH*0.15);
  x0.quadraticCurveTo(cx,doorTopY-doorH*0.08,drx,doorTopY+doorH*0.15);
  x0.lineTo(drx,groundY);
  x0.stroke();

  // Door detail ‚Äî center split line
  neon(3,0.3,6);x0.lineWidth=1;
  x0.beginPath();x0.moveTo(cx,groundY);x0.lineTo(cx,doorTopY+doorH*0.2);x0.stroke();

  // Door iron bands
  for(let db=0;db<3;db++){
    const dby=groundY-doorH*0.2-db*doorH*0.22;
    x0.beginPath();x0.moveTo(dlx+3,dby);x0.lineTo(drx-3,dby);x0.stroke();
  }

  // Church doors open surprise ‚Äî light flooding out
  if(C.doorsOpen){
    const dAlpha=Math.min(1,(30000-C.doorsOpenTimer)/800)*0.7;
    // Bright light from inside
    const doorGrad=x0.createRadialGradient(cx,groundY-doorH*0.4,0,cx,groundY-doorH*0.4,h*0.6);
    doorGrad.addColorStop(0,rgba(pc(Math.floor(t*0.008)%4),dAlpha*0.5));
    doorGrad.addColorStop(0.3,rgba(pc((Math.floor(t*0.008)+1)%4),dAlpha*0.25));
    doorGrad.addColorStop(1,'transparent');
    x0.fillStyle=doorGrad;x0.fillRect(0,0,w,h);
    // Stained glass color beams radiating from doors
    x0.save();x0.translate(cx,groundY-doorH*0.4);
    x0.globalCompositeOperation='screen';
    for(let b=0;b<14;b++){
      const ba=b/14*Math.PI*2+t*0.001;
      const bLen=h*0.45*(0.5+beat*0.5);
      x0.strokeStyle=rgba(pc(b%4),dAlpha*(0.25+beat*0.3));
      x0.lineWidth=6+beat*5;x0.shadowBlur=12+beat*8;x0.shadowColor=pc(b%4);
      x0.beginPath();x0.moveTo(0,0);
      x0.lineTo(Math.cos(ba)*bLen,Math.sin(ba)*bLen);x0.stroke();
    }
    x0.globalCompositeOperation='source-over';x0.restore();
  }

  // ‚îÄ‚îÄ Centerpiece inside the doors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(THEME.centerpiece){
    const cpX=cx, cpY=groundY-doorH*0.45;
    const cpSz=Math.min(w,h)*(0.07+beat*0.02+(C.doorsOpen?0.03:0));
    cpRot+=0.012;cpPh+=0.013;
    // Glow behind centerpiece
    const cpGlow=x0.createRadialGradient(cpX,cpY,0,cpX,cpY,cpSz*3.5);
    cpGlow.addColorStop(0,rgba(pc(0),0.15*(1+beat*0.5)));
    cpGlow.addColorStop(0.5,rgba(pc(1),0.05));
    cpGlow.addColorStop(1,'transparent');
    x0.fillStyle=cpGlow;x0.fillRect(0,0,w,h);
    x0.shadowBlur=cpSz*0.7;x0.shadowColor=rgba(pc(0),0.9);
    drawCPMini(x0,THEME.centerpiece,cpX,cpY,cpSz,cpRot);
    x0.shadowBlur=0;
  }

  // Ground line
  neon(3,0.3,6);x0.lineWidth=1.5;
  x0.beginPath();x0.moveTo(0,groundY);x0.lineTo(w,groundY);x0.stroke();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // GARGOYLES ‚Äî 4 detailed crouching figures in foreground
  // Crouched pose: wings spread, horns, clawed feet, menacing face
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  for(let gi=0;gi<C.gargoyles.length;gi++){
    const g=C.gargoyles[gi];
    // Head spin ‚Äî continuous slow 360¬∞
    g.headAngle+=0.008*(1+beat*0.15);
    // Beat reactivity
    if(beat>0.5)g.lunge=Math.min(1,g.lunge+0.12);
    else g.lunge*=0.92;
    g.wingFlare+=(beat*0.6-g.wingFlare)*0.1;

    const gSz=Math.min(w,h)*0.13; // large gargoyles
    const gx=g.x, gy=g.y;

    x0.save();x0.translate(gx,gy);

    // ‚îÄ‚îÄ Pedestal / perch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    neon(g.ci,0.5,10);x0.lineWidth=2;
    const pedW=gSz*0.7,pedH=gSz*0.18;
    x0.beginPath();
    x0.moveTo(-pedW/2,0);x0.lineTo(-pedW/2,-pedH);
    x0.lineTo(-pedW*0.35,-pedH-4);x0.lineTo(pedW*0.35,-pedH-4);
    x0.lineTo(pedW/2,-pedH);x0.lineTo(pedW/2,0);
    x0.stroke();
    // Pedestal decorative line
    neon(g.ci,0.3,5);x0.lineWidth=1;
    x0.beginPath();x0.moveTo(-pedW*0.4,-pedH*0.5);x0.lineTo(pedW*0.4,-pedH*0.5);x0.stroke();

    const baseY=-pedH-4; // top of pedestal

    // ‚îÄ‚îÄ Clawed feet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    neon(g.ci,0.6,8);x0.lineWidth=1.5;
    for(let foot=-1;foot<=1;foot+=2){
      const fx=foot*gSz*0.18;
      // 3 clawed toes
      for(let c=0;c<3;c++){
        const ca=(c-1)*0.2+foot*0.1;
        x0.beginPath();
        x0.moveTo(fx,baseY);
        x0.lineTo(fx+Math.cos(ca-Math.PI/2)*gSz*0.08,baseY+gSz*0.02);
        x0.lineTo(fx+Math.cos(ca-Math.PI/2)*gSz*0.12,baseY-gSz*0.02);
        x0.stroke();
      }
    }

    // ‚îÄ‚îÄ Legs (crouched, bent at knees) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    neon(g.ci,0.55,10);x0.lineWidth=2.5;
    for(let leg=-1;leg<=1;leg+=2){
      const lx=leg*gSz*0.15;
      // Thigh (angled back)
      x0.beginPath();x0.moveTo(lx,baseY);
      x0.lineTo(lx+leg*gSz*0.05,baseY-gSz*0.22);x0.stroke();
      // Shin (angled forward ‚Äî crouched)
      x0.beginPath();x0.moveTo(lx+leg*gSz*0.05,baseY-gSz*0.22);
      x0.lineTo(lx-leg*gSz*0.02,baseY-gSz*0.38);x0.stroke();
    }

    // ‚îÄ‚îÄ Torso (hunched, muscular outline) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const torsoY=baseY-gSz*0.38;
    neon(g.ci,0.6,12);x0.lineWidth=2.5;
    x0.beginPath();
    x0.moveTo(-gSz*0.2,torsoY+gSz*0.08);
    x0.bezierCurveTo(-gSz*0.25,torsoY-gSz*0.05,-gSz*0.2,torsoY-gSz*0.2,-gSz*0.1,torsoY-gSz*0.28);
    x0.lineTo(gSz*0.1,torsoY-gSz*0.28);
    x0.bezierCurveTo(gSz*0.2,torsoY-gSz*0.2,gSz*0.25,torsoY-gSz*0.05,gSz*0.2,torsoY+gSz*0.08);
    x0.stroke();
    // Spine ridge
    neon(g.ci,0.3,5);x0.lineWidth=1;
    x0.beginPath();x0.moveTo(0,torsoY+gSz*0.06);x0.lineTo(0,torsoY-gSz*0.25);x0.stroke();

    // ‚îÄ‚îÄ Arms (clinging to pedestal edge) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    neon(g.ci,0.55,8);x0.lineWidth=2;
    for(let arm=-1;arm<=1;arm+=2){
      const ax=arm*gSz*0.22;
      // Upper arm
      x0.beginPath();x0.moveTo(ax,torsoY-gSz*0.1);
      x0.lineTo(ax+arm*gSz*0.12,torsoY+gSz*0.08);x0.stroke();
      // Forearm down to pedestal
      x0.beginPath();x0.moveTo(ax+arm*gSz*0.12,torsoY+gSz*0.08);
      x0.lineTo(ax+arm*gSz*0.08,baseY+gSz*0.02);x0.stroke();
      // Clawed hand (3 fingers gripping)
      for(let f=0;f<3;f++){
        const fa=(f-1)*0.15;
        x0.beginPath();
        x0.moveTo(ax+arm*gSz*0.08,baseY+gSz*0.02);
        x0.lineTo(ax+arm*gSz*(0.06+f*0.02),baseY-gSz*0.03);
        x0.stroke();
      }
    }

    // ‚îÄ‚îÄ Wings (spread wide, beat-reactive flare) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const wFlare=0.15+g.wingFlare*0.35;
    neon(g.ci,0.55+beat*0.2,14);x0.lineWidth=2;
    for(let wing=-1;wing<=1;wing+=2){
      const wx=wing*gSz*0.2;
      const wingSpan=gSz*0.65*(1+wFlare);
      const wingTipY=torsoY-gSz*0.35-wFlare*gSz*0.15;
      // Main wing bone
      x0.beginPath();
      x0.moveTo(wx,torsoY-gSz*0.15);
      x0.bezierCurveTo(wx+wing*wingSpan*0.4,wingTipY-gSz*0.1,
                        wx+wing*wingSpan*0.7,wingTipY,
                        wx+wing*wingSpan,wingTipY+gSz*0.1);
      x0.stroke();
      // Wing membrane (3 ribs with connecting curves)
      neon(g.ci,0.3+beat*0.15,8);x0.lineWidth=1.2;
      for(let r=0;r<3;r++){
        const rt=(r+1)/4;
        const ribX=wx+wing*wingSpan*rt;
        const ribY=lerp(torsoY-gSz*0.15,wingTipY+gSz*0.1,rt);
        // Rib from shoulder
        x0.beginPath();x0.moveTo(wx,torsoY-gSz*0.1);
        x0.lineTo(ribX,ribY+gSz*0.05*r);x0.stroke();
      }
      // Trailing edge of wing
      neon(g.ci,0.25,6);x0.lineWidth=1;
      x0.beginPath();
      x0.moveTo(wx,torsoY+gSz*0.05);
      x0.bezierCurveTo(wx+wing*wingSpan*0.3,torsoY+gSz*0.02,
                        wx+wing*wingSpan*0.6,wingTipY+gSz*0.2,
                        wx+wing*wingSpan,wingTipY+gSz*0.1);
      x0.stroke();
    }

    // ‚îÄ‚îÄ Tail (curling down behind) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    neon(g.ci,0.4,8);x0.lineWidth=1.8;
    x0.beginPath();
    x0.moveTo(0,torsoY+gSz*0.06);
    x0.bezierCurveTo(g.side*gSz*0.15,torsoY+gSz*0.15,
                      g.side*gSz*0.25,baseY-gSz*0.05,
                      g.side*gSz*0.18,baseY+gSz*0.02);
    x0.stroke();
    // Tail tip (pointed)
    x0.beginPath();
    x0.moveTo(g.side*gSz*0.18,baseY+gSz*0.02);
    x0.lineTo(g.side*gSz*0.22,baseY-gSz*0.02);
    x0.lineTo(g.side*gSz*0.15,baseY+gSz*0.05);
    x0.stroke();

    // ‚îÄ‚îÄ Head (with continuous 360¬∞ spin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const headY=torsoY-gSz*0.38;
    const headSz=gSz*0.18;
    const hAngle=g.headAngle;
    // Head turns ‚Äî offset position slightly based on angle
    const hOffX=Math.cos(hAngle)*headSz*0.08;
    const hOffY=Math.sin(hAngle)*headSz*0.04;

    x0.save();x0.translate(hOffX,headY+hOffY);

    // Skull shape
    neon(g.ci,0.65,14);x0.lineWidth=2;
    x0.beginPath();
    x0.ellipse(0,0,headSz*0.8,headSz,0,0,Math.PI*2);
    x0.stroke();

    // Horns (two curved horns)
    neon(g.ci,0.6,10);x0.lineWidth=2;
    for(let horn=-1;horn<=1;horn+=2){
      x0.beginPath();
      x0.moveTo(horn*headSz*0.5,-headSz*0.6);
      x0.bezierCurveTo(horn*headSz*0.8,-headSz*1.2,
                        horn*headSz*1.1,-headSz*1.0,
                        horn*headSz*0.9,-headSz*0.5);
      x0.stroke();
    }

    // Menacing brow ridge
    neon(g.ci,0.5,8);x0.lineWidth=2;
    x0.beginPath();
    x0.moveTo(-headSz*0.55,-headSz*0.2);
    x0.bezierCurveTo(-headSz*0.3,-headSz*0.45,headSz*0.3,-headSz*0.45,headSz*0.55,-headSz*0.2);
    x0.stroke();

    // Eyes ‚Äî CONTRASTING PALETTE COLOR, pulse on beat
    const eyeCI=(g.ci+2)%4; // contrasting color
    const eyePulse=1+beat*0.6;
    const eyeR=headSz*0.16*eyePulse;
    x0.fillStyle=rgba(pc(eyeCI),0.7+beat*0.3);
    x0.shadowBlur=12+beat*15;x0.shadowColor=pc(eyeCI);
    x0.beginPath();x0.arc(-headSz*0.3,-headSz*0.15,eyeR,0,Math.PI*2);x0.fill();
    x0.beginPath();x0.arc(headSz*0.3,-headSz*0.15,eyeR,0,Math.PI*2);x0.fill();
    // Inner eye glow
    x0.fillStyle=rgba(pc(eyeCI),0.95);
    x0.beginPath();x0.arc(-headSz*0.3,-headSz*0.15,eyeR*0.4,0,Math.PI*2);x0.fill();
    x0.beginPath();x0.arc(headSz*0.3,-headSz*0.15,eyeR*0.4,0,Math.PI*2);x0.fill();

    // Snout / nose
    neon(g.ci,0.5,8);x0.lineWidth=1.5;
    x0.beginPath();
    x0.moveTo(-headSz*0.15,headSz*0.1);
    x0.lineTo(0,headSz*0.35);
    x0.lineTo(headSz*0.15,headSz*0.1);
    x0.stroke();
    // Nostrils
    x0.beginPath();x0.arc(-headSz*0.08,headSz*0.25,headSz*0.06,0,Math.PI*2);x0.stroke();
    x0.beginPath();x0.arc(headSz*0.08,headSz*0.25,headSz*0.06,0,Math.PI*2);x0.stroke();

    // Snarling mouth ‚Äî open when beat hits
    const mouthOpen=beat*headSz*0.12;
    neon(g.ci,0.6,10);x0.lineWidth=1.5;
    x0.beginPath();
    x0.moveTo(-headSz*0.4,headSz*0.45);
    x0.bezierCurveTo(-headSz*0.2,headSz*(0.55+mouthOpen*0.02),
                      headSz*0.2,headSz*(0.55+mouthOpen*0.02),
                      headSz*0.4,headSz*0.45);
    x0.stroke();
    // Fangs
    if(mouthOpen>2){
      x0.lineWidth=1.2;
      x0.beginPath();x0.moveTo(-headSz*0.2,headSz*0.45);x0.lineTo(-headSz*0.18,headSz*0.55);x0.stroke();
      x0.beginPath();x0.moveTo(headSz*0.2,headSz*0.45);x0.lineTo(headSz*0.18,headSz*0.55);x0.stroke();
      // Bottom fangs
      x0.beginPath();x0.moveTo(-headSz*0.12,headSz*0.52);x0.lineTo(-headSz*0.14,headSz*0.42);x0.stroke();
      x0.beginPath();x0.moveTo(headSz*0.12,headSz*0.52);x0.lineTo(headSz*0.14,headSz*0.42);x0.stroke();
    }

    // Ears (pointed)
    neon(g.ci,0.4,6);x0.lineWidth=1.5;
    for(let ear=-1;ear<=1;ear+=2){
      x0.beginPath();
      x0.moveTo(ear*headSz*0.6,-headSz*0.5);
      x0.lineTo(ear*headSz*0.75,-headSz*0.85);
      x0.lineTo(ear*headSz*0.5,-headSz*0.6);
      x0.stroke();
    }

    x0.restore(); // end head transform

    // ‚îÄ‚îÄ Blazing eyes overlay when alive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(C.gargoyleAlive&&g.flyMode){
      const blazeR=headSz*0.25*(1+beat);
      x0.fillStyle=pc(Math.floor(t*0.02)%4);
      x0.shadowBlur=20+beat*15;x0.shadowColor=pc(Math.floor(t*0.015)%4);
      x0.beginPath();x0.arc(hOffX-headSz*0.3,headY+hOffY-headSz*0.15,blazeR,0,Math.PI*2);x0.fill();
      x0.beginPath();x0.arc(hOffX+headSz*0.3,headY+hOffY-headSz*0.15,blazeR,0,Math.PI*2);x0.fill();
      x0.shadowBlur=0;
    }

    // ‚îÄ‚îÄ Fire breath surprise ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(C.gargoyleFireBreath){
      const fireLen=w*0.25*(0.5+beat*0.5+Math.sin(t*0.003+gi)*0.3);
      const fireDir=g.side; // breathe toward center
      const fx=hOffX,fy=headY+hOffY+headSz*0.4;
      for(let fl=0;fl<3;fl++){
        const flw=10-fl*2+beat*6;
        const fAlpha=0.45-fl*0.1+beat*0.25;
        x0.strokeStyle=rgba(pc((fl+Math.floor(t*0.01))%4),fAlpha);
        x0.lineWidth=flw;x0.shadowBlur=18+beat*12;x0.shadowColor=pc(fl%4);
        x0.beginPath();x0.moveTo(fx,fy);
        x0.bezierCurveTo(fx-fireDir*fireLen*0.3,fy-fireLen*0.15,
                          fx-fireDir*fireLen*0.6,fy+Math.sin(t*0.005+gi)*15,
                          fx-fireDir*fireLen,fy+Math.sin(t*0.003+gi*2)*20);
        x0.stroke();
      }
      // Ember particles
      for(let e=0;e<4;e++){
        const ex=fx-fireDir*fireLen*(0.5+Math.random()*0.5);
        const ey=fy+(Math.random()-0.5)*30;
        x0.fillStyle=rgba(pc(e%4),0.5+beat*0.3);x0.shadowBlur=6;
        x0.beginPath();x0.arc(ex,ey,2+Math.random()*2,0,Math.PI*2);x0.fill();
      }
      x0.shadowBlur=0;
    }

    x0.restore(); // end gargoyle transform
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FLOATING MOTES ‚Äî subtle atmospheric particles
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  for(const m of C.motes){
    m.y+=m.vy*(0.5+energy*0.3);m.ph+=0.03;
    if(m.y<-10){m.y=h+10;m.x=Math.random()*w;}
    const br=0.4+Math.sin(m.ph)*0.3;
    x0.beginPath();x0.arc(m.x,m.y,m.r*br,0,Math.PI*2);
    x0.fillStyle=rgba(pc(m.ci),br*0.3);
    x0.shadowBlur=4;x0.shadowColor=pc(m.ci);x0.fill();x0.shadowBlur=0;
  }
}


// ‚ïê‚ïê‚ïê SCENE: classicArcade ‚ïê‚ïê‚ïê

function drawClassicArcade(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.arcade){
    SD.arcade={score:0,
      pacman:{x:w*0.15,y:h*0.38,dir:1,mouthA:0,mouthS:0.08,ci:3},
      dots:Array.from({length:25},()=>({x:Math.random()*w*0.8+w*0.1,y:h*(0.18+Math.random()*0.6),eaten:false,ph:Math.random()*Math.PI*2,big:Math.random()>0.8})),
      mazeLines:null,tetPieces:null,galaShips:null,
      shipX:cx,shipDir:1,shipBullets:[],shipFireTimer:0,explosions:[],
      boss:null,bossAlpha:0,bossLasers:[],bossHP:100,bossShipBullets:[],
      superPac:null,superPacAlpha:0,
      powerUp:false,powerUpTimer:0,powerUpParticles:[],
      gameOverActive:false,gameOverTimer:0,winnerActive:false,winnerTimer:0,
      bezel:{color:'rgba(20,15,8,1)',scanlines:true}};
  }
  const A=SD.arcade;
  if(A.boss&&A.boss.timer>0)A.boss.timer-=16;
  else if(A.boss&&A.boss.timer<=0&&A.bossAlpha>0){A.bossAlpha=Math.max(0,A.bossAlpha-0.012);if(A.bossAlpha===0)A.boss=null;}
  if(A.superPac&&A.superPac.timer>0)A.superPac.timer-=16;
  else if(A.superPac&&A.superPac.timer<=0&&A.superPacAlpha>0){A.superPacAlpha=Math.max(0,A.superPacAlpha-0.015);if(A.superPacAlpha===0)A.superPac=null;}
  if(A.powerUpTimer>0){A.powerUpTimer-=16;if(A.powerUpTimer<=0)A.powerUp=false;}
  if(A.gameOverTimer>0)A.gameOverTimer-=16;if(A.winnerTimer>0)A.winnerTimer-=16;
  // Bezel
  x0.fillStyle='rgba(12,8,4,1)';x0.fillRect(0,0,w,h);
  const bW=w*0.04,bT=h*0.07,bB=h*0.04,scrX=bW,scrY=bT,scrW=w-bW*2,scrH=h-bT-bB;
  x0.fillStyle='rgba(0,4,12,1)';x0.fillRect(scrX,scrY,scrW,scrH);
  x0.strokeStyle=rgba(pc(0),0.7+beat*0.2);x0.lineWidth=4;x0.shadowBlur=12;x0.shadowColor=pc(0);x0.strokeRect(scrX,scrY,scrW,scrH);x0.shadowBlur=0;
  const bkLen=20;for(const[bx,by,dx,dy]of[[scrX,scrY,1,1],[scrX+scrW,scrY,-1,1],[scrX,scrY+scrH,1,-1],[scrX+scrW,scrY+scrH,-1,-1]]){x0.strokeStyle=rgba(pc(1),0.9);x0.lineWidth=3;x0.shadowBlur=6;x0.shadowColor=pc(1);x0.beginPath();x0.moveTo(bx+dx*bkLen,by);x0.lineTo(bx,by);x0.lineTo(bx,by+dy*bkLen);x0.stroke();x0.shadowBlur=0;}
  x0.fillStyle='rgba(0,4,12,1)';x0.fillRect(scrX,scrY,scrW,bT*0.7);x0.strokeStyle=rgba(pc(2),0.5);x0.lineWidth=1;x0.beginPath();x0.moveTo(scrX,scrY+bT*0.7);x0.lineTo(scrX+scrW,scrY+bT*0.7);x0.stroke();
  A.score=Math.floor(songProg*99999+beat*200);x0.fillStyle=rgba(pc(0),0.9+beat*0.1);x0.font='bold 16px monospace';x0.textAlign='left';x0.shadowBlur=6;x0.shadowColor=pc(0);x0.fillText('SCORE: '+A.score.toString().padStart(8,'0'),scrX+12,scrY+22);x0.shadowBlur=0;
  x0.fillStyle=rgba(pc(3),0.8);x0.textAlign='center';x0.fillText('GOTHAM ARCADE',cx,scrY+22);x0.fillStyle=rgba(pc(1),0.8);x0.textAlign='right';x0.fillText('\u2665\u2665\u2665  HI: '+Math.floor(A.score*1.33).toString().padStart(8,'0'),scrX+scrW-12,scrY+22);x0.textAlign='left';
  x0.save();x0.beginPath();x0.rect(scrX,scrY+bT*0.7,scrW,scrH-bT*0.7);x0.clip();
  x0.fillStyle='rgba(0,0,0,0.18)';for(let sy2=scrY;sy2<scrY+scrH;sy2+=3)x0.fillRect(scrX,sy2,scrW,1);
  // Maze
  if(!A.mazeLines){A.mazeLines=[];const segs=[[0.08,0.17,0.38,0.17],[0.62,0.17,0.92,0.17],[0.08,0.45,0.32,0.45],[0.68,0.45,0.92,0.45],[0.08,0.72,0.45,0.72],[0.55,0.72,0.92,0.72],[0.08,0.17,0.08,0.45],[0.92,0.17,0.92,0.45],[0.42,0.55,0.58,0.55],[0.08,0.82,0.92,0.82]];for(const[x1,y1,x2,y2]of segs)A.mazeLines.push({x1:scrX+x1*scrW,y1:scrY+y1*scrH,x2:scrX+x2*scrW,y2:scrY+y2*scrH,ci:2});}
  for(const ml of A.mazeLines){x0.beginPath();x0.moveTo(ml.x1,ml.y1);x0.lineTo(ml.x2,ml.y2);x0.strokeStyle=rgba(pc(2),(0.5+beat*0.2));x0.lineWidth=3;x0.shadowBlur=8;x0.shadowColor=pc(2);x0.stroke();x0.shadowBlur=0;}
  // Dots
  for(const d of A.dots){if(d.eaten)continue;d.ph+=0.04;const dR=d.big?12:7;x0.fillStyle=rgba(pc(3),(0.7+Math.abs(Math.sin(d.ph))*0.3));if(d.big){x0.shadowBlur=14+beat*10;x0.shadowColor=pc(3);}x0.beginPath();x0.arc(d.x,d.y,dR*(1+beat*0.2*(d.big?1:0.3)),0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  if(A.dots.every(d=>d.eaten))A.dots.forEach(d=>{d.eaten=false;});
  // Pac-Man patrolling
  if(!A.superPac||A.superPacAlpha<0.5){const pm=A.pacman;pm.x+=1.4*(1+energy*0.4)*pm.dir;pm.mouthA+=pm.mouthS*(1+energy*0.3);if(pm.mouthA>0.38||pm.mouthA<0)pm.mouthS*=-1;if(pm.x>scrX+scrW+40){pm.x=scrX-40;pm.y=scrY+h*0.3+Math.random()*h*0.35;}if(pm.x<scrX-40)pm.x=scrX+scrW+40;
    const mouth=Math.abs(Math.sin(pm.mouthA))*0.45,pmR=26;x0.fillStyle=rgba(pc(pm.ci),0.9);x0.shadowBlur=15;x0.shadowColor=pc(pm.ci);x0.beginPath();x0.moveTo(pm.x,pm.y);x0.arc(pm.x,pm.y,pmR,mouth*(pm.dir>0?1:-1),(Math.PI*2-mouth)*(pm.dir>0?1:-1));x0.closePath();x0.fill();x0.shadowBlur=0;
    for(const d of A.dots){if(!d.eaten&&Math.hypot(pm.x-d.x,pm.y-d.y)<pmR+5)d.eaten=true;}}
  // Tetris ‚Äî bigger blocks
  if(!A.tetPieces)A.tetPieces=Array.from({length:6},()=>mkTetPiece(w,h));
  for(const tp of A.tetPieces){tp.y+=tp.vy*(1+energy*0.3);tp.rot+=tp.rotS;if(tp.y>scrY+scrH+100)Object.assign(tp,mkTetPiece(w,h));
    x0.save();x0.translate(tp.x,tp.y);x0.rotate(tp.rot);x0.fillStyle=rgba(pc(tp.ci),0.8);x0.strokeStyle=rgba(pc(tp.ci),0.95);x0.lineWidth=2.5;x0.shadowBlur=8+beat*6;x0.shadowColor=pc(tp.ci);
    for(const[bx2,by2]of tp.blocks){x0.fillRect(bx2*24-2,by2*24-2,22,22);x0.strokeRect(bx2*24-2,by2*24-2,22,22);}x0.shadowBlur=0;x0.restore();}
  // Galaga ships ‚Äî bigger
  if(!A.galaShips)A.galaShips=Array.from({length:8},(_,i)=>({x:scrX+w*0.1+(i%4)*(w*0.2),y:scrY+h*(0.1+Math.floor(i/4)*0.07),ph:i*0.4,ci:i%4,alive:true}));
  for(const gs of A.galaShips){if(!gs.alive)continue;gs.ph+=0.02*(1+beat*0.3);gs.x+=Math.cos(gs.ph)*0.5;
    x0.fillStyle=rgba(pc(gs.ci),(0.8+beat*0.2));x0.shadowBlur=10+beat*6;x0.shadowColor=pc(gs.ci);x0.beginPath();x0.moveTo(gs.x,gs.y-16);x0.lineTo(gs.x-14,gs.y+10);x0.lineTo(gs.x,gs.y+5);x0.lineTo(gs.x+14,gs.y+10);x0.closePath();x0.fill();x0.shadowBlur=0;}
  // SHIP ‚Äî centerpiece as Galaga player
  const shipY=scrY+scrH-h*0.08;
  if(THEME.centerpiece&&!A.boss&&!A.superPac){
    A.shipX+=A.shipDir*(1.5+energy*0.8+beat*0.5);if(A.shipX>scrX+scrW-30)A.shipDir=-1;if(A.shipX<scrX+30)A.shipDir=1;
    const shipSz=Math.min(w,h)*0.065;cpPh+=0.013;
    x0.globalAlpha=0.9+beat*0.1;x0.shadowBlur=12+beat*8;x0.shadowColor=pc(0);drawCPMini(x0,THEME.centerpiece,A.shipX,shipY,shipSz,0);x0.globalAlpha=1;x0.shadowBlur=0;
    const flameH=15+beat*10+Math.random()*8,flameW=8+beat*4;const fG=x0.createLinearGradient(A.shipX,shipY+shipSz*0.5,A.shipX,shipY+shipSz*0.5+flameH);fG.addColorStop(0,'rgba(255,200,50,0.95)');fG.addColorStop(0.4,rgba(pc(0),0.7));fG.addColorStop(1,'transparent');x0.fillStyle=fG;x0.shadowBlur=12;x0.shadowColor='rgba(255,150,0,0.8)';x0.beginPath();x0.moveTo(A.shipX-flameW,shipY+shipSz*0.4);x0.lineTo(A.shipX,shipY+shipSz*0.4+flameH);x0.lineTo(A.shipX+flameW,shipY+shipSz*0.4);x0.closePath();x0.fill();x0.shadowBlur=0;
    A.shipFireTimer+=16;if(A.shipFireTimer>300+Math.random()*200){A.shipFireTimer=0;A.shipBullets.push({x:A.shipX,y:shipY-shipSz*0.5,ci:Math.floor(Math.random()*4)});}}
  // Ship bullets + collision
  for(let i=A.shipBullets.length-1;i>=0;i--){const b=A.shipBullets[i];b.y-=6;if(b.y<scrY){A.shipBullets.splice(i,1);continue;}
    x0.fillStyle=rgba(pc(b.ci),0.95);x0.shadowBlur=8;x0.shadowColor=pc(b.ci);x0.fillRect(b.x-2,b.y-6,4,12);x0.shadowBlur=0;
    let hit=false;for(const gs of A.galaShips){if(gs.alive&&Math.hypot(b.x-gs.x,b.y-gs.y)<18){gs.alive=false;hit=true;
      A.explosions.push({x:gs.x,y:gs.y,particles:Array.from({length:18},()=>({x:gs.x,y:gs.y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1,ci:Math.floor(Math.random()*4),r:2+Math.random()*4})),timer:40});
      setTimeout(()=>{gs.alive=true;gs.x=scrX+w*0.1+Math.random()*w*0.6;gs.y=scrY+h*0.1+Math.random()*h*0.08;},4000);break;}}
    if(!hit&&A.tetPieces)for(const tp of A.tetPieces){if(Math.hypot(b.x-tp.x,b.y-tp.y)<25){hit=true;
      A.explosions.push({x:tp.x,y:tp.y,particles:Array.from({length:14},()=>({x:tp.x,y:tp.y,vx:(Math.random()-0.5)*12,vy:(Math.random()-0.5)*12,life:1,ci:Math.floor(Math.random()*4),r:2+Math.random()*3})),timer:35});
      Object.assign(tp,mkTetPiece(w,h));break;}}
    if(hit)A.shipBullets.splice(i,1);}
  // Boss bullets hit ship
  if(A.boss&&THEME.centerpiece){for(let i=A.bossLasers.length-1;i>=0;i--){const ls=A.bossLasers[i];if(Math.hypot(ls.x-A.shipX,ls.y-shipY)<25&&A.boss.variant!==2){
    A.explosions.push({x:A.shipX,y:shipY,particles:Array.from({length:25},()=>({x:A.shipX,y:shipY,vx:(Math.random()-0.5)*14,vy:(Math.random()-0.5)*14,life:1,ci:Math.floor(Math.random()*4),r:3+Math.random()*5})),timer:50});
    A.bossLasers.splice(i,1);}}}
  // Ship bullets hit boss
  if(A.boss&&A.boss.variant===2){for(let i=A.shipBullets.length-1;i>=0;i--){const b=A.shipBullets[i];const bossX=cx+Math.sin(t*0.003)*w*0.2,bossY2=h*0.22;
    if(Math.hypot(b.x-bossX,b.y-bossY2)<w*0.12){A.shipBullets.splice(i,1);A.bossHP-=2;
      A.explosions.push({x:bossX+(Math.random()-0.5)*40,y:bossY2+(Math.random()-0.5)*20,particles:Array.from({length:6},()=>({x:bossX,y:bossY2,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:0.6,ci:Math.floor(Math.random()*4),r:2+Math.random()*3})),timer:20});}}}
  // Explosions
  for(let i=A.explosions.length-1;i>=0;i--){const ex=A.explosions[i];ex.timer--;if(ex.timer<=0){A.explosions.splice(i,1);continue;}
    for(const p of ex.particles){p.x+=p.vx;p.y+=p.vy;p.vy+=0.2;p.life-=0.03;if(p.life>0){x0.fillStyle=rgba(pc(p.ci),p.life*0.95);x0.shadowBlur=10;x0.shadowColor=pc(p.ci);x0.beginPath();x0.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}}}
  x0.restore();
  // BOSS SURPRISE ‚Äî Galaga mothership
  if(A.boss&&A.bossAlpha>0){if(A.boss.timer>0)A.bossAlpha=Math.min(1,A.bossAlpha+0.015);
    const alpha=A.bossAlpha;const bossX=cx+Math.sin(t*0.003)*w*0.2,bossY2=h*0.22,bW2=w*0.18,bH2=h*0.1;
    x0.save();x0.globalAlpha=alpha;
    x0.fillStyle=rgba(pc(0),0.8);x0.shadowBlur=20+beat*15;x0.shadowColor=pc(0);
    x0.beginPath();x0.moveTo(bossX,bossY2-bH2);x0.bezierCurveTo(bossX+bW2,bossY2-bH2*0.5,bossX+bW2,bossY2+bH2*0.5,bossX,bossY2+bH2*0.3);x0.bezierCurveTo(bossX-bW2,bossY2+bH2*0.5,bossX-bW2,bossY2-bH2*0.5,bossX,bossY2-bH2);x0.fill();
    x0.fillStyle=rgba(pc(1),0.6);x0.beginPath();x0.moveTo(bossX-bW2*0.6,bossY2);x0.lineTo(bossX-bW2*1.2,bossY2+bH2*0.6);x0.lineTo(bossX-bW2*0.4,bossY2+bH2*0.3);x0.closePath();x0.fill();
    x0.beginPath();x0.moveTo(bossX+bW2*0.6,bossY2);x0.lineTo(bossX+bW2*1.2,bossY2+bH2*0.6);x0.lineTo(bossX+bW2*0.4,bossY2+bH2*0.3);x0.closePath();x0.fill();
    x0.fillStyle='rgba(255,255,0,0.9)';x0.shadowBlur=12;x0.shadowColor='rgba(255,255,0,0.8)';
    x0.beginPath();x0.arc(bossX-bW2*0.25,bossY2-bH2*0.2,bW2*0.08,0,Math.PI*2);x0.fill();x0.beginPath();x0.arc(bossX+bW2*0.25,bossY2-bH2*0.2,bW2*0.08,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
    // Damage flash
    if(A.boss.variant===2&&A.bossHP<50){x0.fillStyle=rgba(pc(0),0.3*Math.sin(t*0.05));x0.fill();}
    x0.restore();
    // Boss shoots
    if(beat>0.3&&Math.random()<0.3&&A.boss.timer>2000){A.bossLasers.push({x:bossX+(Math.random()-0.5)*bW2,y:bossY2+bH2*0.4,vx:(Math.random()-0.5)*3,vy:5+Math.random()*4,life:1,ci:Math.floor(Math.random()*4)});}
    for(let i=A.bossLasers.length-1;i>=0;i--){const ls=A.bossLasers[i];ls.x+=ls.vx;ls.y+=ls.vy;ls.life-=0.02;if(ls.life<=0||ls.y>h){A.bossLasers.splice(i,1);continue;}
      x0.fillStyle=rgba(pc(ls.ci),ls.life*0.9);x0.shadowBlur=12;x0.shadowColor=pc(ls.ci);x0.beginPath();x0.arc(ls.x,ls.y,6+beat*3,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
    // Ship during boss
    if(THEME.centerpiece){A.shipX+=A.shipDir*(2+energy+beat);if(A.shipX>scrX+scrW-30)A.shipDir=-1;if(A.shipX<scrX+30)A.shipDir=1;
      const sS=Math.min(w,h)*0.065;x0.globalAlpha=0.85;x0.shadowBlur=12;x0.shadowColor=pc(0);drawCPMini(x0,THEME.centerpiece,A.shipX,shipY,sS,0);x0.globalAlpha=1;x0.shadowBlur=0;
      A.shipFireTimer+=16;if(A.shipFireTimer>200){A.shipFireTimer=0;A.shipBullets.push({x:A.shipX,y:shipY-sS*0.5,ci:Math.floor(Math.random()*4)});}}}
  // SUPER PAC SURPRISE ‚Äî giant, fast chase
  if(A.superPac&&A.superPacAlpha>0){if(A.superPac.timer>0)A.superPacAlpha=Math.min(1,A.superPacAlpha+0.015);
    const sp=A.superPac;sp.mouthA+=0.06*(1+beat*0.5);if(sp.mouthA>0.5)sp.mouthA=0;
    // Chase the ship ‚Äî fast, close calls
    if(THEME.centerpiece){const dx=A.shipX-sp.x,dy=shipY-sp.y,dist=Math.hypot(dx,dy)||1;
      const chaseSpeed=3.5+energy*2+beat*1.5;sp.x+=dx/dist*chaseSpeed;sp.y+=dy/dist*chaseSpeed*0.6;
      sp.dir=dx>0?1:-1;
      // Ship evades frantically
      A.shipX+=A.shipDir*(3+energy*1.5+beat*2);if(A.shipX>scrX+scrW-30)A.shipDir=-1;if(A.shipX<scrX+30)A.shipDir=1;
      if(Math.random()<0.08+beat*0.05)A.shipDir*=-1; // Random dodges
      const sS2=Math.min(w,h)*0.065;x0.globalAlpha=A.superPacAlpha*0.85;x0.shadowBlur=15;x0.shadowColor=pc(0);drawCPMini(x0,THEME.centerpiece,A.shipX,shipY,sS2,0);x0.globalAlpha=1;x0.shadowBlur=0;}
    // Giant Pac-Man
    x0.save();x0.globalAlpha=A.superPacAlpha;const pr=Math.min(w,h)*0.18,mouth2=sp.mouthA*0.6;
    x0.fillStyle=rgba(pc(3),0.95);x0.shadowBlur=25+beat*15;x0.shadowColor=pc(3);
    x0.beginPath();x0.moveTo(sp.x,sp.y);x0.arc(sp.x,sp.y,pr*(1+beat*0.05),mouth2*(sp.dir>0?1:-1),(Math.PI*2-mouth2)*(sp.dir>0?1:-1));x0.closePath();x0.fill();
    x0.fillStyle='rgba(0,0,0,0.9)';x0.shadowBlur=0;x0.beginPath();x0.arc(sp.x+sp.dir*pr*0.3,sp.y-pr*0.35,pr*0.1,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;x0.restore();
    if(Math.random()<0.4)A.powerUpParticles.push({x:sp.x,y:sp.y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:0.7,ci:3});}
  // Particle trail
  for(let i=A.powerUpParticles.length-1;i>=0;i--){const pp=A.powerUpParticles[i];pp.x+=pp.vx;pp.y+=pp.vy;pp.life-=0.04;if(pp.life<=0){A.powerUpParticles.splice(i,1);continue;}
    x0.fillStyle=rgba(pc(pp.ci),pp.life*0.8);x0.shadowBlur=8;x0.shadowColor=pc(pp.ci);x0.beginPath();x0.arc(pp.x,pp.y,4*pp.life,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  // GAME OVER / WINNER
  if(A.gameOverTimer>0){const gP=1-A.gameOverTimer/10000,gS=0.5+Math.sin(t*0.05+beat*12)*0.5;
    x0.save();x0.globalAlpha=Math.min(1,gP*3)*gS;x0.fillStyle='rgba(0,0,0,0.7)';x0.fillRect(0,0,w,h);
    x0.font='bold '+Math.min(w,h)*0.13+'px monospace';x0.textAlign='center';x0.shadowBlur=30+beat*20;x0.shadowColor=pc(0);x0.fillStyle=rgba(pc(0),1);x0.fillText('GAME OVER',cx,cy);
    x0.font='bold '+Math.min(w,h)*0.05+'px monospace';x0.fillStyle=rgba(pc(2),0.9);x0.fillText('INSERT COIN TO CONTINUE',cx,cy+h*0.1);x0.shadowBlur=0;x0.restore();}
  if(A.winnerTimer>0){const wP=1-A.winnerTimer/10000,wS=0.4+Math.sin(t*0.06+beat*15)*0.6;
    x0.save();x0.globalAlpha=Math.min(1,wP*3)*wS;x0.fillStyle='rgba(0,0,0,0.5)';x0.fillRect(0,0,w,h);
    x0.font='bold '+Math.min(w,h)*0.15+'px monospace';x0.textAlign='center';
    for(let ci=0;ci<4;ci++){x0.shadowBlur=20;x0.shadowColor=pc(ci);x0.fillStyle=rgba(pc(ci),0.4);x0.fillText('WINNER!',cx+ci*2-3,cy+ci*2-3);}
    x0.fillStyle='rgba(255,255,255,0.95)';x0.shadowBlur=30+beat*25;x0.shadowColor='white';x0.fillText('WINNER!',cx,cy);
    x0.font='bold '+Math.min(w,h)*0.05+'px monospace';x0.fillStyle=rgba(pc(3),0.9);x0.fillText('YOU SAVED THE GALAXY',cx,cy+h*0.1);x0.shadowBlur=0;x0.restore();}
}


// ‚ïê‚ïê‚ïê SCENE: electricForest ‚ïê‚ïê‚ïê

function drawElectricForest(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.ef)return;
  const EF=SD.ef;

  // Timer updates
  if(EF.laserOverloadTimer>0){EF.laserOverloadTimer-=16;if(EF.laserOverloadTimer<=0)EF.laserOverload=false;}
  if(EF.monkeySwarmTimer>0){EF.monkeySwarmTimer-=16;if(EF.monkeySwarmTimer<=0){EF.monkeySwarm=false;EF.monkeys=[];}}
  if(EF.windstormTimer>0){EF.windstormTimer-=16;if(EF.windstormTimer<=0)EF.windstorm=false;}
  const wind=EF.windstorm;
  const laserOL=EF.laserOverload;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BACKGROUND ‚Äî dark forest night sky
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const bgG=x0.createLinearGradient(0,0,0,h);
  bgG.addColorStop(0,'rgba(1,2,6,1)');bgG.addColorStop(0.4,'rgba(2,5,10,1)');bgG.addColorStop(1,'rgba(0,1,3,1)');
  x0.fillStyle=bgG;x0.fillRect(0,0,w,h);

  // Ground ‚Äî forest floor path with perspective
  const vanishY=h*0.38; // vanishing point (where stage is)
  const gG=x0.createLinearGradient(0,vanishY,0,h);
  gG.addColorStop(0,rgba(pc(2),0.06));gG.addColorStop(0.3,rgba(pc(2),0.1));gG.addColorStop(1,'rgba(2,4,2,0.95)');
  x0.fillStyle=gG;x0.fillRect(0,vanishY,w,h-vanishY);

  // Path edges ‚Äî perspective lines converging to stage
  x0.strokeStyle=rgba(pc(2),0.07+beat*0.03);x0.lineWidth=1;
  x0.beginPath();x0.moveTo(cx-w*0.06,vanishY);x0.lineTo(0,h);x0.stroke();
  x0.beginPath();x0.moveTo(cx+w*0.06,vanishY);x0.lineTo(w,h);x0.stroke();
  // Inner path lines
  x0.strokeStyle=rgba(pc(2),0.04);
  x0.beginPath();x0.moveTo(cx-w*0.03,vanishY);x0.lineTo(cx-w*0.35,h);x0.stroke();
  x0.beginPath();x0.moveTo(cx+w*0.03,vanishY);x0.lineTo(cx+w*0.35,h);x0.stroke();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TREES ‚Äî immersive depth perspective, flanking sides
  // Foreground trees (near edges) are LARGE and partially off-screen
  // Background trees (near center) are smaller and higher up
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Sort trees by depth (background first so foreground draws on top)
  const sortedTrees=[...EF.trees].sort((a,b)=>{
    const aD=Math.abs(a.x-cx);const bD=Math.abs(b.x-cx);return aD-bD;
  });

  for(const tr of sortedTrees){
    tr.ph+=0.005;const glm=tr.glowMult||1;
    // Wind sway
    const windSway=wind?(Math.sin(t*0.003+tr.x*0.01)*35+Math.sin(t*0.007)*20):0;
    tr.swayOffset+=(windSway-tr.swayOffset)*0.05;

    // Depth factor: how far from center (0=center/deep, 1=edge/close)
    const edgeDist=Math.abs(tr.x-cx)/(w*0.5);
    const depth=Math.min(1,edgeDist*1.3); // 0=far, 1=near

    // Scale by depth ‚Äî foreground trees are MUCH bigger
    const scaleF=0.4+depth*0.9; // 0.4x at back to 1.3x at front
    const trunkW=tr.trunkW*scaleF;
    const trunkH=tr.trunkH*scaleF;

    // Y position: foreground trees start at bottom, background trees start higher
    const baseY=h+depth*h*0.05; // foreground slightly below edge
    const topY=baseY-trunkH;

    // X position: foreground trees pushed further to edges (partially off-screen)
    const pushFactor=depth*0.12;
    const baseX=tr.side<0?(tr.x-w*pushFactor):(tr.x+w*pushFactor);
    const topX=baseX+tr.swayOffset;

    // Alpha: background trees slightly more transparent
    const depthAlpha=0.5+depth*0.5;

    x0.save();
    x0.globalAlpha=depthAlpha;

    // ‚îÄ‚îÄ Trunk ‚Äî thick solid dark with neon glow edges ‚îÄ‚îÄ
    const twBase=trunkW*(1.2+depth*0.4); // wider at base for foreground
    const twTop=trunkW*(0.5+depth*0.2);
    x0.fillStyle=`rgba(4,10,4,${0.9+depth*0.08})`;
    x0.beginPath();
    x0.moveTo(baseX-twBase,baseY);
    x0.lineTo(topX-twTop,topY+trunkH*0.25);
    x0.lineTo(topX-twTop*0.7,topY);
    x0.lineTo(topX+twTop*0.7,topY);
    x0.lineTo(topX+twTop,topY+trunkH*0.25);
    x0.lineTo(baseX+twBase,baseY);
    x0.closePath();x0.fill();

    // Neon glow outline on trunk
    x0.strokeStyle=rgba(pc(tr.ci),(0.3+beat*0.15)*glm*depthAlpha);
    x0.lineWidth=(1.5+depth*1.5)*glm;
    x0.shadowBlur=(8+beat*6+depth*8)*glm;x0.shadowColor=pc(tr.ci);
    x0.stroke();

    // ‚îÄ‚îÄ Branches ‚Äî spreading outward, more on foreground trees ‚îÄ‚îÄ
    const numBranches=Math.floor(2+depth*3);
    x0.strokeStyle=rgba(pc(tr.ci),(0.25+beat*0.1)*glm);
    x0.lineWidth=(1+depth)*glm;
    for(let b=0;b<numBranches;b++){
      const by=topY+trunkH*(0.15+b*0.18);
      const bSide=(b%2===0)?-1:1;
      const bLen=trunkW*(1.5+depth*1.2+Math.sin(tr.ph+b)*0.3);
      const bx=lerp(topX,baseX,b*0.18/(numBranches*0.18));
      x0.beginPath();
      x0.moveTo(bx,by);
      x0.bezierCurveTo(
        bx+bSide*bLen*0.4,by-trunkH*0.06,
        bx+bSide*bLen*0.7,by-trunkH*0.02+tr.swayOffset*0.3,
        bx+bSide*bLen+tr.swayOffset*0.5,by+trunkH*0.02
      );
      x0.stroke();
      // Small leaf clusters at branch ends
      x0.fillStyle=rgba(pc(tr.ci),(0.15+beat*0.06)*glm);
      x0.shadowBlur=(10+beat*5)*glm;
      x0.beginPath();
      x0.ellipse(bx+bSide*bLen+tr.swayOffset*0.5,by,bLen*0.25,bLen*0.12,bSide*0.2,0,Math.PI*2);
      x0.fill();
    }

    // ‚îÄ‚îÄ Canopy glow at top ‚Äî subtle, not blocking sky ‚îÄ‚îÄ
    x0.fillStyle=rgba(pc(tr.ci),(0.12+beat*0.05)*glm);
    x0.shadowBlur=(15+beat*8)*glm;x0.shadowColor=pc(tr.ci);
    x0.beginPath();x0.ellipse(topX,topY+trunkH*0.05,trunkW*1.8,trunkH*0.12,0,0,Math.PI*2);x0.fill();

    // ‚îÄ‚îÄ Neon bark highlights ‚îÄ‚îÄ
    x0.strokeStyle=rgba(pc(tr.ci),(0.1+beat*0.06)*glm);x0.lineWidth=1;x0.shadowBlur=4*glm;
    for(let bk=0;bk<(2+Math.floor(depth*2));bk++){
      const bky=baseY-(bk+1)*trunkH*0.2;
      const bkx=lerp(topX,baseX,(bk+1)*0.2);
      const bkw=lerp(twTop,twBase,(bk+1)*0.2)*0.7;
      x0.beginPath();x0.moveTo(bkx-bkw,bky);x0.lineTo(bkx+bkw,bky);x0.stroke();
    }

    x0.shadowBlur=0;x0.globalAlpha=1;x0.restore();
    if(tr.glowMult>1)tr.glowMult*=0.995;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // STAGE ‚Äî centerpiece as the festival stage
  // Positioned at the vanishing point, framed by a stage structure
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const stageX=cx, stageY=vanishY+h*0.08;
  const stageSz=Math.min(w,h)*0.12;

  // Stage platform ‚Äî trapezoidal, perspective
  const stgW1=w*0.08, stgW2=w*0.18, stgH=h*0.04;
  x0.fillStyle=rgba(pc(3),0.12);
  x0.beginPath();
  x0.moveTo(stageX-stgW1,stageY);x0.lineTo(stageX-stgW2,stageY+stgH);
  x0.lineTo(stageX+stgW2,stageY+stgH);x0.lineTo(stageX+stgW1,stageY);
  x0.closePath();x0.fill();
  x0.strokeStyle=rgba(pc(3),0.3+beat*0.15);x0.lineWidth=1.5;
  x0.shadowBlur=8+beat*5;x0.shadowColor=pc(3);x0.stroke();x0.shadowBlur=0;

  // Stage truss/rigging outline above centerpiece
  const trussW=w*0.14, trussTop=stageY-h*0.18;
  x0.strokeStyle=rgba(pc(0),0.2+beat*0.1);x0.lineWidth=1.5;
  x0.shadowBlur=6+beat*4;x0.shadowColor=pc(0);
  // Vertical truss legs
  x0.beginPath();x0.moveTo(stageX-trussW,stageY);x0.lineTo(stageX-trussW*0.8,trussTop);x0.stroke();
  x0.beginPath();x0.moveTo(stageX+trussW,stageY);x0.lineTo(stageX+trussW*0.8,trussTop);x0.stroke();
  // Top bar
  x0.beginPath();x0.moveTo(stageX-trussW*0.8,trussTop);x0.lineTo(stageX+trussW*0.8,trussTop);x0.stroke();
  // Cross braces
  x0.strokeStyle=rgba(pc(0),0.1);x0.lineWidth=1;
  x0.beginPath();x0.moveTo(stageX-trussW*0.85,stageY-h*0.05);x0.lineTo(stageX+trussW*0.85,stageY-h*0.12);x0.stroke();
  x0.beginPath();x0.moveTo(stageX+trussW*0.85,stageY-h*0.05);x0.lineTo(stageX-trussW*0.85,stageY-h*0.12);x0.stroke();
  x0.shadowBlur=0;

  // Centerpiece ‚Äî the festival stage focal point
  if(THEME.centerpiece){
    const windPulse=wind?1.3:1;
    cpRot+=0.012*(1+energy*0.2+beat*0.3)*windPulse;cpPh+=0.013;
    const cpSz=stageSz*(0.7+beat*0.15+songProg*0.15)*windPulse;
    const cpBob=Math.sin(t*0.001)*h*0.01;
    x0.shadowBlur=(18+beat*12)*windPulse;x0.shadowColor=pc(0);
    x0.globalAlpha=0.9+beat*0.1;
    drawCPMini(x0,THEME.centerpiece,stageX,stageY-h*0.06+cpBob,cpSz,cpRot);
    x0.globalAlpha=1;x0.shadowBlur=0;
    // Stage glow halo
    const cpGlow=x0.createRadialGradient(stageX,stageY-h*0.04,0,stageX,stageY-h*0.04,cpSz*3);
    cpGlow.addColorStop(0,rgba(pc(0),0.12*(1+beat*0.4)));cpGlow.addColorStop(1,'transparent');
    x0.fillStyle=cpGlow;x0.fillRect(0,0,w,h);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // LASERS ‚Äî from stage truss, aimed at viewer (fan outward toward edges)
  // Creates the "lasers pointed at you" festival perspective
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const laserOriginX=stageX, laserOriginY=trussTop;
  const laserBright=laserOL?2:1;

  for(let li=0;li<EF.lasers.length;li++){
    const lz=EF.lasers[li];
    const speedMult=laserOL?(2.5+Math.random()*1.5):1;
    lz.angle+=lz.speed*speedMult*(1+beat*0.6);

    // Fan outward from stage toward viewer ‚Äî beams spread wide toward screen edges and bottom
    const spreadAngle=lz.angle;
    // Horizontal spread: beams fan left and right
    const hSpread=Math.sin(spreadAngle)*w*0.7;
    // Vertical: beams come toward the viewer (bottom of screen)
    const vTarget=h*0.6+Math.cos(spreadAngle*0.7)*h*0.35;
    const endX=laserOriginX+hSpread;
    const endY=vTarget;

    x0.strokeStyle=rgba(pc(lz.ci),(0.2+beat*0.15)*laserBright);
    x0.lineWidth=lz.width*(laserOL?1.8:1);
    x0.shadowBlur=(6+beat*5)*laserBright;x0.shadowColor=pc(lz.ci);
    x0.beginPath();x0.moveTo(laserOriginX,laserOriginY);x0.lineTo(endX,endY);x0.stroke();

    // Laser overload: extra beams, erratic angles
    if(laserOL){
      const a2=spreadAngle+Math.PI*0.15+Math.sin(t*0.012+li)*0.6;
      const ex2=laserOriginX+Math.sin(a2)*w*0.8;
      const ey2=h*0.5+Math.cos(a2*0.5)*h*0.4;
      x0.strokeStyle=rgba(pc((lz.ci+1)%4),(0.15+beat*0.12)*laserBright);
      x0.lineWidth=lz.width*1.2;
      x0.beginPath();x0.moveTo(laserOriginX,laserOriginY);x0.lineTo(ex2,ey2);x0.stroke();
      // Third beam for intensity
      if(li%2===0){
        const a3=spreadAngle-Math.PI*0.2+Math.cos(t*0.008+li)*0.4;
        const ex3=laserOriginX+Math.sin(a3)*w*0.6;
        const ey3=h*0.7+Math.cos(a3)*h*0.25;
        x0.strokeStyle=rgba(pc((lz.ci+2)%4),(0.1+beat*0.1)*laserBright);
        x0.beginPath();x0.moveTo(laserOriginX,laserOriginY);x0.lineTo(ex3,ey3);x0.stroke();
      }
    }
  }
  x0.shadowBlur=0;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FIREFLIES ‚Äî floating particles through the forest
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  for(const f of EF.fairies){
    f.x+=f.vx+Math.sin(t*0.001+f.ph)*0.4+(wind?Math.sin(t*0.005)*3:0);
    f.y+=f.vy+Math.cos(t*0.0008+f.ph)*0.4;f.ph+=0.05;
    if(f.x<0||f.x>w)f.vx*=-1;if(f.y<0||f.y>h)f.vy*=-1;
    const br=Math.sin(f.ph)*0.4+0.6;
    x0.beginPath();x0.arc(f.x,f.y,f.r*(0.5+br*0.5),0,Math.PI*2);
    x0.fillStyle=rgba(pc(f.ci),br*0.5);x0.shadowBlur=8;x0.shadowColor=pc(f.ci);x0.fill();x0.shadowBlur=0;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // WIND PARTICLES (windstorm surprise)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(wind){
    for(let wp=0;wp<60;wp++){
      const wx=((t*0.8+wp*w/60)%w),wy=Math.random()*h;
      x0.fillStyle=rgba(pc(wp%4),0.25+beat*0.2);
      x0.beginPath();x0.ellipse(wx,wy,5+Math.random()*4,1,0.3,0,Math.PI*2);x0.fill();
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // NEON MONKEYS (monkey swarm surprise)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(EF.monkeySwarm){
    // Spawn monkeys if needed
    while(EF.monkeys.length<12){
      const treeIdx=Math.floor(Math.random()*EF.trees.length);
      const tr=EF.trees[treeIdx];
      EF.monkeys.push({x:tr.x,y:h-tr.trunkH*(0.3+Math.random()*0.4),vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*3,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4),sz:20+Math.random()*14,swinging:Math.random()>0.4,swingTree:treeIdx,swingAngle:Math.random()*Math.PI});
    }
    for(const mk of EF.monkeys){
      mk.ph+=0.06*(1+beat*0.4);
      const strobeOn=Math.sin(t*0.015+mk.ph*3)>-0.2;
      if(mk.swinging){
        mk.swingAngle+=0.04*(1+beat*0.3);
        const tr=EF.trees[mk.swingTree%EF.trees.length];
        mk.x=tr.x+Math.sin(mk.swingAngle)*55;
        mk.y=(h-tr.trunkH*0.5)+Math.cos(mk.swingAngle)*35;
        if(Math.random()<0.008){mk.swinging=false;mk.vx=(Math.random()-0.5)*6;mk.vy=-2.5-Math.random()*3;}
      } else {
        mk.x+=mk.vx;mk.y+=mk.vy;mk.vy+=0.08;
        if(mk.y>h*0.8){mk.swinging=true;mk.swingTree=Math.floor(Math.random()*EF.trees.length);}
      }
      if(!strobeOn)continue;
      // Draw neon-tube outline monkey
      const mci=mk.ci;
      x0.strokeStyle=rgba(pc(mci),0.8+beat*0.2);x0.lineWidth=2;
      x0.shadowBlur=10+beat*6;x0.shadowColor=pc(mci);
      // Body oval
      x0.beginPath();x0.ellipse(mk.x,mk.y,mk.sz*0.35,mk.sz*0.45,0,0,Math.PI*2);x0.stroke();
      // Head
      x0.beginPath();x0.arc(mk.x,mk.y-mk.sz*0.55,mk.sz*0.25,0,Math.PI*2);x0.stroke();
      // Eyes
      x0.fillStyle=rgba(pc((mci+2)%4),0.9);
      x0.beginPath();x0.arc(mk.x-mk.sz*0.1,mk.y-mk.sz*0.58,mk.sz*0.06,0,Math.PI*2);x0.fill();
      x0.beginPath();x0.arc(mk.x+mk.sz*0.1,mk.y-mk.sz*0.58,mk.sz*0.06,0,Math.PI*2);x0.fill();
      // Tail ‚Äî long curly
      x0.beginPath();x0.moveTo(mk.x-mk.sz*0.2,mk.y+mk.sz*0.3);
      x0.bezierCurveTo(mk.x-mk.sz*0.65,mk.y+mk.sz*0.6,mk.x-mk.sz*0.9,mk.y,mk.x-mk.sz*0.55,mk.y-mk.sz*0.3);
      x0.stroke();
      // Arms (swinging)
      const armSwing=Math.sin(mk.ph)*mk.sz*0.2;
      x0.beginPath();x0.moveTo(mk.x-mk.sz*0.3,mk.y-mk.sz*0.15);
      x0.lineTo(mk.x-mk.sz*0.6,mk.y-mk.sz*0.4+armSwing);x0.stroke();
      x0.beginPath();x0.moveTo(mk.x+mk.sz*0.3,mk.y-mk.sz*0.15);
      x0.lineTo(mk.x+mk.sz*0.6,mk.y-mk.sz*0.4-armSwing);x0.stroke();
      // Legs (bent)
      x0.beginPath();x0.moveTo(mk.x-mk.sz*0.15,mk.y+mk.sz*0.35);
      x0.lineTo(mk.x-mk.sz*0.25,mk.y+mk.sz*0.6);x0.stroke();
      x0.beginPath();x0.moveTo(mk.x+mk.sz*0.15,mk.y+mk.sz*0.35);
      x0.lineTo(mk.x+mk.sz*0.25,mk.y+mk.sz*0.6);x0.stroke();
      x0.shadowBlur=0;
    }
  }
}


// ‚ïê‚ïê‚ïê SCENE: omniaNightclub ‚ïê‚ïê‚ïê

function drawOmniaNightclub(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!SD.omnia){
    // 6 chandelier rings ‚Äî each independent
    SD.omnia={
      rings:[
        {r:0.08, rot:0,    rotSpeed:0.012,  dir:1,  tilt:0,    ci:0, nodes:16, haywire:false},
        {r:0.15, rot:0.5,  rotSpeed:0.009,  dir:-1, tilt:0.04, ci:1, nodes:24, haywire:false},
        {r:0.22, rot:1.0,  rotSpeed:0.007,  dir:1,  tilt:0.07, ci:2, nodes:32, haywire:false},
        {r:0.29, rot:1.5,  rotSpeed:0.005,  dir:-1, tilt:0.05, ci:3, nodes:40, haywire:false},
        {r:0.37, rot:2.0,  rotSpeed:0.004,  dir:1,  tilt:0.08, ci:0, nodes:50, haywire:false},
        {r:0.46, rot:2.5,  rotSpeed:0.003,  dir:-1, tilt:0.06, ci:1, nodes:60, haywire:false},
      ],
      chanY: h*0.06,
      dropTarget: h*0.06,
      dropPhase: 'resting', // resting | dropping | holding | rising
      dropTimer: 8000 + Math.random()*6000,
      dropCount: 0,
      // Drop triggers: song has 3 planned drops
      dropSchedule: [0.22, 0.48, 0.74],
      lastDropProg: -1,
      laserActive: false,
      co2Active: false,
      co2Alpha: 0,
      haywireActive: false,
      beamRot: 0,
    };
    // Club crowd silhouettes
    SD.crowd = Array.from({length:28},(_,i)=>({
      x: i/27*w*1.1 - w*0.05,
      y: h*0.78 + Math.random()*h*0.06,
      sz: 28+Math.random()*20,
      ph: Math.random()*Math.PI*2,
      phSpeed: 0.03+Math.random()*0.04,
      ci: i%4,
      armL: Math.random()*Math.PI*0.5,
      armR: Math.random()*Math.PI*0.5,
    }));
    // Booth bottle lights
    SD.bottles = Array.from({length:12},(_,i)=>({
      x: (i%6)/5*w*0.85+w*0.075,
      side: i<6 ? 0 : 1,
      ph: Math.random()*Math.PI*2,
      ci: i%4,
    }));
  }
  const O = SD.omnia;

  // ‚îÄ‚îÄ Background ‚Äî dark club void ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  x0.fillStyle='rgba(2,0,6,1)';x0.fillRect(0,0,w,h);

  // ‚îÄ‚îÄ Club perimeter ‚Äî ceiling grid, walls, LED panels ‚îÄ‚îÄ
  // Ceiling receding grid from edges toward center vanishing point
  const vanY = h*0.18;
  x0.lineWidth=1;
  for(let g=0;g<8;g++){
    const gx = g/7*w;
    x0.strokeStyle = rgba(pc(g%4), 0.06*(1+beat*0.2));
    x0.shadowBlur = 3; x0.shadowColor = pc(g%4);
    x0.beginPath();x0.moveTo(gx,0);x0.lineTo(cx,vanY);x0.stroke();
  }
  for(let gy=0;gy<5;gy++){
    const yFrac = gy/4;
    const ly = yFrac*vanY;
    const lx1 = cx - cx*yFrac;
    const lx2 = cx + cx*yFrac;
    x0.strokeStyle = rgba(pc(gy%4), 0.05*(1+beat*0.15));
    x0.beginPath();x0.moveTo(lx1,ly);x0.lineTo(lx2,ly);x0.stroke();
  }
  x0.shadowBlur=0;

  // LED wall panels ‚Äî left and right walls in perspective
  const wallColors = [pc(0),pc(1),pc(2),pc(3)];
  for(let side=0;side<2;side++){
    for(let panel=0;panel<5;panel++){
      const depth = panel/4;
      const panelW = w*0.08*(1-depth*0.6);
      const panelH = h*0.28*(1-depth*0.4);
      const px = side===0 ? w*0.02+panel*(w*0.06) : w*0.98-panel*(w*0.06)-panelW;
      const py = h*0.28-depth*h*0.1;
      const ci = (panel+side*2+Math.floor(t*0.0005))%4;
      const panAlpha = (0.08+depth*0.06)*(1+beat*0.3);
      // LED panel fill
      x0.fillStyle = rgba(pc(ci), panAlpha);
      x0.fillRect(px,py,panelW,panelH);
      // Panel border glow
      x0.strokeStyle = rgba(pc(ci), panAlpha*2.5);
      x0.lineWidth = 1.5; x0.shadowBlur=8; x0.shadowColor=pc(ci);
      x0.strokeRect(px,py,panelW,panelH);
      // Horizontal scan line moving through panel
      const scanY = py+(((t*0.05+panel*30)%panelH));
      x0.strokeStyle = rgba(pc(ci),0.25*(1+beat*0.3));
      x0.lineWidth=2; x0.beginPath();
      x0.moveTo(px,scanY);x0.lineTo(px+panelW,scanY);x0.stroke();
      x0.shadowBlur=0;
    }
  }

  // Upper balcony rail ‚Äî stretches across top sides
  for(let side=0;side<2;side++){
    const rx = side===0 ? 0 : cx+w*0.08;
    const rw = cx-w*0.08;
    x0.strokeStyle = rgba(pc(side),0.3*(1+beat*0.1));
    x0.lineWidth=2; x0.shadowBlur=6; x0.shadowColor=pc(side);
    x0.beginPath();x0.moveTo(rx,h*0.32);x0.lineTo(rx+rw,h*0.32);x0.stroke();
    // Rail posts
    for(let rp=0;rp<6;rp++){
      const rpx=rx+rp*(rw/5);
      x0.beginPath();x0.moveTo(rpx,h*0.32);x0.lineTo(rpx,h*0.45);x0.stroke();
    }
    x0.shadowBlur=0;
  }

  // ‚îÄ‚îÄ VIP booths ‚Äî tiered seating perimeter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Back booth (elevated)
  const boothY = h*0.45;
  x0.fillStyle='rgba(10,5,20,0.9)';
  x0.fillRect(0, boothY, w*0.14, h*0.3);
  x0.fillRect(w*0.86, boothY, w*0.14, h*0.3);
  // Booth top rail with glow
  for(const[bx,bw2,bci] of [[0,w*0.14,2],[w*0.86,w*0.14,3]]){
    x0.strokeStyle=rgba(pc(bci),0.5*(1+beat*0.2));
    x0.lineWidth=3; x0.shadowBlur=12; x0.shadowColor=pc(bci);
    x0.beginPath();x0.moveTo(bx,boothY);x0.lineTo(bx+bw2,boothY);x0.stroke();
    x0.shadowBlur=0;
    // Booth interior ‚Äî deep couch curve
    x0.strokeStyle=rgba(pc(bci),0.15);x0.lineWidth=2;
    x0.beginPath();x0.moveTo(bx+5,boothY+15);x0.bezierCurveTo(bx+bw2*0.3,boothY+30,bx+bw2*0.7,boothY+30,bx+bw2-5,boothY+15);x0.stroke();
  }

  // Bottle service tables ‚Äî center stage area top
  for(const bt of SD.bottles){
    bt.ph += 0.04*(1+beat*0.3);
    const btX = bt.x;
    const btY = bt.side===0 ? boothY+h*0.04 : boothY+h*0.04;
    // Bottle glow
    const btAlpha = 0.4+Math.sin(bt.ph)*0.2+beat*0.3;
    x0.shadowBlur=10; x0.shadowColor=pc(bt.ci);
    x0.fillStyle=rgba(pc(bt.ci),btAlpha*0.6);
    x0.fillRect(btX-3,btY-18,6,18);
    // Ice bucket glow
    x0.fillStyle=rgba(pc(bt.ci),btAlpha*0.3);
    x0.beginPath();x0.ellipse(btX,btY,8,4,0,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;
  }

  // ‚îÄ‚îÄ Dance floor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const floorY = h*0.74;
  // Floor base fill
  const floorG=x0.createLinearGradient(0,floorY,0,h);
  floorG.addColorStop(0,'rgba(10,5,22,0.98)');floorG.addColorStop(1,'rgba(2,1,6,1)');
  x0.fillStyle=floorG;x0.fillRect(0,floorY,w,h-floorY);

  // Perspective tile grid ‚Äî converges toward vanishing point (center top of floor)
  const vanPX=cx,vanPY=floorY;
  x0.shadowBlur=0;
  // Diagonal tile lines converging
  for(let col=0;col<=18;col++){
    const px=col/18*w;
    x0.strokeStyle=rgba(pc(col%4),0.11*(1+beat*0.35));
    x0.lineWidth=col%3===0?1.5:0.8;
    x0.shadowBlur=col%3===0?4:1;x0.shadowColor=pc(col%4);
    x0.beginPath();x0.moveTo(px,h);x0.lineTo(vanPX+(px-vanPX)*0.04,vanPY+2);x0.stroke();
  }
  // Horizontal depth lines
  for(let row=0;row<8;row++){
    const rowFrac=row/7;
    const rowY=floorY+(h-floorY)*rowFrac;
    const spread=0.04+(1-rowFrac)*0.96;
    x0.strokeStyle=rgba(pc(row%4),0.1*(1+beat*0.25));
    x0.lineWidth=row===0?2:1;x0.shadowBlur=row===0?6:2;x0.shadowColor=pc(row%4);
    x0.beginPath();x0.moveTo(cx-(cx*spread),rowY);x0.lineTo(cx+(cx*spread),rowY);x0.stroke();
  }
  x0.shadowBlur=0;

  // Tile fill ‚Äî checkerboard pattern on floor
  for(let row=0;row<7;row++){
    const y1=floorY+(h-floorY)*row/7;
    const y2=floorY+(h-floorY)*(row+1)/7;
    for(let col=0;col<16;col++){
      if((row+col)%2!==0)continue;
      const x1=col/16*w,x2=(col+1)/16*w;
      x0.fillStyle=rgba(pc((row+col)%4),(0.04+beat*0.04)*(1-row*0.08));
      x0.fillRect(x1,y1,x2-x1,y2-y1);
    }
  }

  // Beat-reactive radial pulse from center
  if(beat>0.3){
    const pg=x0.createRadialGradient(cx,floorY+4,0,cx,floorY+4,w*(0.12+beat*0.4));
    pg.addColorStop(0,rgba(pc(0),(beat-0.3)*0.55));
    pg.addColorStop(0.4,rgba(pc(1),(beat-0.3)*0.2));
    pg.addColorStop(1,'transparent');
    x0.fillStyle=pg;x0.fillRect(0,floorY,w,h-floorY);
  }

  // Chandelier light pool on floor ‚Äî moves with chandelier height
  const poolSize=w*(0.3+O.chanY/h*0.2);
  const poolG=x0.createRadialGradient(cx,floorY+10,0,cx,floorY+10,poolSize);
  poolG.addColorStop(0,rgba(pc(0),0.22*(1+beat*0.4)));
  poolG.addColorStop(0.3,rgba(pc(1),0.1));
  poolG.addColorStop(1,'transparent');
  x0.fillStyle=poolG;x0.fillRect(0,floorY,w,h-floorY);

  // Chandelier reflection rings on floor
  x0.shadowBlur=6;
  for(const ring of O.rings){
    const rSz=ring.r*w*0.55*(1+beat*0.04);
    x0.strokeStyle=rgba(pc(ring.ci),0.22*(1+beat*0.4)*(1-ring.r*0.55));
    x0.lineWidth=1.5; x0.shadowColor=pc(ring.ci);
    x0.beginPath();x0.ellipse(cx,floorY+12,rSz,rSz*0.11,0,0,Math.PI*2);x0.stroke();
  }
  x0.shadowBlur=0;

    // ‚îÄ‚îÄ Chandelier drop logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Check scheduled drops based on song progress
  for(const dp of O.dropSchedule){
    if(songProg>dp && O.lastDropProg<dp){
      O.lastDropProg=dp;
      if(O.dropPhase==='resting'){
        O.dropPhase='dropping';
        O.dropTarget=h*(0.48+Math.random()*0.12); // how far it drops
      }
    }
  }

  // Phase transitions
  if(O.dropPhase==='dropping'){
    O.chanY+=(O.dropTarget-O.chanY)*0.008;
    if(Math.abs(O.chanY-O.dropTarget)<3){
      O.dropPhase='holding';
      O.holdTimer=12000; // hold for 12s (surprise fires here from fireSurprise)
    }
  } else if(O.dropPhase==='holding'){
    O.holdTimer-=16;
    if(O.holdTimer<=0){O.dropPhase='rising';}
  } else if(O.dropPhase==='rising'){
    O.chanY+=(h*0.06-O.chanY)*0.006;
    if(Math.abs(O.chanY-h*0.06)<3){O.dropPhase='resting';}
  } else {
    // Gentle breathing drift
    O.chanY = h*0.06+Math.sin(t*0.0003)*h*0.01;
  }

  // ‚îÄ‚îÄ CO2 effect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(O.co2Active){
    O.co2Alpha=Math.min(1,O.co2Alpha+0.025);
    // Billows down from chandelier position
    const co2G=x0.createRadialGradient(cx,O.chanY,0,cx,O.chanY,w*0.7);
    co2G.addColorStop(0,`rgba(240,245,255,${O.co2Alpha*0.92})`);
    co2G.addColorStop(0.4,`rgba(220,235,255,${O.co2Alpha*0.7})`);
    co2G.addColorStop(0.75,`rgba(200,220,255,${O.co2Alpha*0.35})`);
    co2G.addColorStop(1,'transparent');
    x0.fillStyle=co2G;x0.fillRect(0,0,w,h);
    // Billowing turbulence details
    for(let bl=0;bl<8;bl++){
      const bph=t*0.001+bl*0.7;
      const bx=cx+(Math.cos(bph)*w*0.35);
      const by=O.chanY+Math.sin(bph*0.6)*h*0.2+bl*h*0.04;
      const br=80+Math.sin(bph*1.3)*40;
      const bg=x0.createRadialGradient(bx,by,0,bx,by,br);
      bg.addColorStop(0,`rgba(255,255,255,${O.co2Alpha*0.15})`);
      bg.addColorStop(1,'transparent');
      x0.fillStyle=bg;x0.fillRect(0,0,w,h);
    }
  } else {
    O.co2Alpha=Math.max(0,O.co2Alpha-0.015);
    if(O.co2Alpha>0){
      const co2G=x0.createRadialGradient(cx,O.chanY,0,cx,O.chanY,w*0.7);
      co2G.addColorStop(0,`rgba(240,245,255,${O.co2Alpha*0.92})`);
      co2G.addColorStop(1,'transparent');
      x0.fillStyle=co2G;x0.fillRect(0,0,w,h);
    }
  }

  // ‚îÄ‚îÄ Chain from ceiling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  x0.strokeStyle='rgba(180,160,120,0.6)';x0.lineWidth=4;
  x0.shadowBlur=6;x0.shadowColor='rgba(255,220,150,0.4)';
  x0.beginPath();x0.moveTo(cx,0);x0.lineTo(cx,O.chanY);x0.stroke();
  // Chain links
  for(let cl=0;cl<Math.floor(O.chanY/18);cl++){
    const cly=cl*18+9;
    x0.strokeStyle=`rgba(180,160,120,${0.3+cl/20*0.3})`;x0.lineWidth=3;
    x0.beginPath();x0.ellipse(cx,cly,5,3,cl%2===0?0:Math.PI/2,0,Math.PI*2);x0.stroke();
  }
  x0.shadowBlur=0;

  // ‚îÄ‚îÄ CHANDELIER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  x0.save();x0.translate(cx,O.chanY);

  // Center sphere ‚Äî faceted crystal ball
  const coreR=Math.min(w,h)*0.04*(1+beat*0.08);
  for(let lat=0;lat<8;lat++){
    for(let lon=0;lon<12;lon++){
      const la=(lat/8-0.5)*Math.PI;
      const lo=lon/12*Math.PI*2;
      const fx=Math.cos(la)*Math.cos(lo)*coreR;
      const fy=Math.sin(la)*coreR;
      const fz=Math.cos(la)*Math.sin(lo);
      if(fz<0.05)continue;
      const fsz=(4+fz*6)*(1+beat*0.2);
      x0.fillStyle=rgba(pc((lat+lon)%4),(0.5+fz*0.5)*0.9);
      x0.shadowBlur=8+beat*4;x0.shadowColor=pc((lat+lon)%4);
      x0.fillRect(fx-fsz/2,fy-fsz/2,fsz,fsz);
    }
  }
  x0.shadowBlur=0;

  // The 6 concentric rings
  for(let ri=0;ri<O.rings.length;ri++){
    const ring=O.rings[ri];
    // Normal rotation ‚Äî haywire overrides
    if(ring.haywire){
      ring.rot+=ring.haywireSpeed*(1+beat*0.5);
    } else {
      ring.rot+=ring.rotSpeed*ring.dir*(1+beat*0.3);
    }

    const rSz=ring.r*Math.min(w,h)*(1.1+beat*0.04);
    // Ring structure ‚Äî ellipse (perspective tilt)
    x0.strokeStyle=rgba(pc(ring.ci),0.35*(1+beat*0.2));
    x0.lineWidth=1.5;x0.shadowBlur=10+beat*5;x0.shadowColor=pc(ring.ci);
    x0.beginPath();x0.ellipse(0,0,rSz,rSz*0.22,ring.tilt,0,Math.PI*2);x0.stroke();
    // Inner ring wire
    x0.strokeStyle=rgba(pc(ring.ci),0.15);x0.lineWidth=1;
    x0.beginPath();x0.ellipse(0,0,rSz*0.85,rSz*0.18,ring.tilt,0,Math.PI*2);x0.stroke();
    x0.shadowBlur=0;

    // Crystal nodes on ring
    const nodeCount=ring.nodes;
    for(let n=0;n<nodeCount;n++){
      const na=n/nodeCount*Math.PI*2+ring.rot;
      const nx=Math.cos(na)*rSz;
      const ny=Math.sin(na)*rSz*0.22;
      // Only draw front-facing nodes (simulate 3D)
      if(Math.sin(na+ring.tilt)<-0.1)continue;
      const nVis=0.5+Math.sin(na+ring.tilt)*0.5;
      const nSz=(3+nVis*4)*(1+beat*0.25);
      x0.fillStyle=rgba(pc((ring.ci+n)%4),(0.5+nVis*0.5)*0.85);
      x0.shadowBlur=12*nVis+beat*8;x0.shadowColor=pc((ring.ci+n)%4);
      x0.fillRect(nx-nSz/2,ny-nSz/2,nSz,nSz);

      // Hanging crystal drops ‚Äî every 4th node has a pendant
      if(n%4===0){
        const pendLen=rSz*0.12+Math.sin(na*3+t*0.002)*rSz*0.04;
        x0.strokeStyle=rgba(pc(ring.ci),0.3*nVis);x0.lineWidth=1;
        x0.beginPath();x0.moveTo(nx,ny);x0.lineTo(nx,ny+pendLen);x0.stroke();
        x0.fillStyle=rgba(pc((ring.ci+2)%4),(0.6+nVis*0.4)*0.8);
        x0.shadowBlur=8;x0.shadowColor=pc((ring.ci+2)%4);
        x0.beginPath();x0.arc(nx,ny+pendLen,2.5*(1+beat*0.3),0,Math.PI*2);x0.fill();
        x0.shadowBlur=0;
      }
    }

    // Light beams from ring outward ‚Äî wide colored cones
    if(ri%2===0){
      for(let b=0;b<4;b++){
        const ba=b/4*Math.PI*2+ring.rot*0.5;
        const bLen=Math.min(w,h)*(0.35+ri*0.08)*(1+beat*0.2);
        const bx=Math.cos(ba)*rSz*0.8;
        const by2=Math.sin(ba)*rSz*0.2;
        // World coords for beam endpoint
        const worldX=cx+bx+Math.cos(ba)*bLen;
        const worldY=O.chanY+by2+Math.sin(ba+0.3)*bLen*0.4;
        x0.save();
        x0.globalAlpha=0.04*(1+beat*0.4)*(1+ri*0.15);
        const bg=x0.createLinearGradient(cx+bx,O.chanY+by2,worldX,worldY);
        const bc=h2r(pc(ring.ci));
        bg.addColorStop(0,`rgba(${bc.r},${bc.g},${bc.b},1)`);bg.addColorStop(1,'transparent');
        x0.strokeStyle=bg;x0.lineWidth=6+ri*2;
        x0.beginPath();x0.moveTo(bx,by2);x0.lineTo(bx+Math.cos(ba)*bLen,by2+Math.sin(ba+0.3)*bLen*0.4);x0.stroke();
        x0.restore();
      }
    }
  }
  x0.restore(); // end chandelier translate

  // ‚îÄ‚îÄ LASER SHOW ‚Äî from chandelier position ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(O.laserActive){
    O.beamRot+=0.025*(1+beat*0.5);
    const laserOriginX=cx, laserOriginY=O.chanY;
    // Fan patterns ‚Äî 3 rotating fans of different colors
    for(let fan=0;fan<3;fan++){
      const fanOffset=fan/3*Math.PI*2;
      for(let beam=0;beam<7;beam++){
        const ba=beam/6*Math.PI*1.2-Math.PI*0.6+fanOffset+O.beamRot*(fan%2===0?1:-1);
        const bLen=Math.max(w,h)*1.4;
        const bc=h2r(pc(fan%4));
        x0.save();
        x0.strokeStyle=`rgba(${bc.r},${bc.g},${bc.b},${0.7+beat*0.25})`;
        x0.lineWidth=1.5;
        x0.shadowBlur=8+beat*4;x0.shadowColor=pc(fan%4);
        x0.beginPath();x0.moveTo(laserOriginX,laserOriginY);
        x0.lineTo(laserOriginX+Math.cos(ba)*bLen,laserOriginY+Math.sin(ba)*bLen);
        x0.stroke();x0.shadowBlur=0;x0.restore();
      }
    }
    // X-pattern fixed
    for(const xa of [Math.PI*0.25,Math.PI*0.75,-Math.PI*0.25,-Math.PI*0.75]){
      const bc=h2r(pc(2));
      x0.strokeStyle=`rgba(${bc.r},${bc.g},${bc.b},${0.5+beat*0.3})`;
      x0.lineWidth=1.5;x0.shadowBlur=6;x0.shadowColor=pc(2);
      x0.beginPath();x0.moveTo(laserOriginX,laserOriginY);
      x0.lineTo(laserOriginX+Math.cos(xa+O.beamRot*0.3)*w,laserOriginY+Math.sin(xa+O.beamRot*0.3)*h);
      x0.stroke();x0.shadowBlur=0;
    }
    // Grid pattern ‚Äî horizontal/vertical sweeping beams
    for(let grd=0;grd<3;grd++){
      const gba=O.beamRot*1.5+grd*Math.PI/3;
      x0.strokeStyle=rgba(pc(3),0.3+beat*0.2);x0.lineWidth=1;x0.shadowBlur=4;x0.shadowColor=pc(3);
      x0.beginPath();x0.moveTo(0,laserOriginY+Math.sin(gba)*h*0.3);
      x0.lineTo(w,laserOriginY+Math.sin(gba+0.5)*h*0.3);x0.stroke();
      x0.shadowBlur=0;
    }
  }

  // ‚îÄ‚îÄ CROWD silhouettes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const p of SD.crowd){
    p.ph+=p.phSpeed*(1+beat*0.5);
    const bounce=Math.abs(Math.sin(p.ph))*p.sz*0.12*(1+beat*0.5);
    const sway=Math.sin(p.ph*0.5)*p.sz*0.06;
    // Body
    x0.fillStyle=`rgba(0,0,0,0.92)`;
    x0.fillRect(p.x-p.sz*0.12+sway,p.y-p.sz*0.65+bounce,p.sz*0.24,p.sz*0.65);
    // Head
    x0.beginPath();x0.arc(p.x+sway,p.y-p.sz*0.72+bounce,p.sz*0.14,0,Math.PI*2);x0.fill();
    // Arms raised (vary per person)
    const armSwing=Math.sin(p.ph+0.5)*0.4;
    x0.lineWidth=p.sz*0.07;x0.strokeStyle=`rgba(0,0,0,0.92)`;x0.lineCap='round';
    x0.beginPath();x0.moveTo(p.x-p.sz*0.12+sway,p.y-p.sz*0.45+bounce);
    x0.lineTo(p.x-p.sz*(0.25+p.armL*0.3)+sway,p.y-p.sz*(0.6+p.armL*0.2)+bounce+armSwing*p.sz*0.1);x0.stroke();
    x0.beginPath();x0.moveTo(p.x+p.sz*0.12+sway,p.y-p.sz*0.45+bounce);
    x0.lineTo(p.x+p.sz*(0.25+p.armR*0.3)+sway,p.y-p.sz*(0.6+p.armR*0.2)+bounce-armSwing*p.sz*0.1);x0.stroke();
    x0.lineCap='butt';
    // Edge color glow from chandelier light hitting them
    x0.fillStyle=rgba(pc(p.ci),0.08*(1+beat*0.3));
    x0.fillRect(p.x-p.sz*0.12+sway,p.y-p.sz*0.65+bounce,2,p.sz*0.65);
  }

  // ‚îÄ‚îÄ Floor glow from chandelier light ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const fglow=x0.createRadialGradient(cx,floorY,0,cx,floorY,w*0.45);
  fglow.addColorStop(0,rgba(pc(0),0.08*(1+beat*0.4)));
  fglow.addColorStop(0.5,rgba(pc(1),0.04));
  fglow.addColorStop(1,'transparent');
  x0.fillStyle=fglow;x0.fillRect(0,0,w,h);
}


// ‚ïê‚ïê‚ïê SCENE: pirateShip ‚ïê‚ïê‚ïê

function drawPirateShip(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(SD.stars)for(const s of SD.stars){x0.fillStyle=`rgba(255,255,255,${s.br*0.8})`;x0.fillRect(s.x,s.y,1.5,1.5);}
  const hor=h*0.6;
  if(SD.waves)for(let wv=0;wv<5;wv++){const wave=SD.waves[wv];wave.ph+=wave.speed*(1+SM.energy*0.3);x0.beginPath();for(let px=0;px<=w;px+=4){const py=hor+wv*25+Math.sin(px*0.01+wave.ph)*wave.amp*(1+SM.beatPulse*0.2);px===0?x0.moveTo(px,py):x0.lineTo(px,py);}x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();const wg=x0.createLinearGradient(0,hor,0,h);const wc=h2r(pc(wv%4));wg.addColorStop(0,`rgba(${wc.r},${wc.g},${wc.b},${0.3*(1+SM.beatPulse*0.2)})`);wg.addColorStop(1,'rgba(0,20,60,0.9)');x0.fillStyle=wg;x0.fill();}
  x0.fillStyle='rgba(20,10,5,0.95)';x0.beginPath();x0.moveTo(w*0.1,hor*0.98);x0.lineTo(w*0.9,hor*0.98);x0.lineTo(w*0.85,h*0.55);x0.lineTo(w*0.15,h*0.55);x0.closePath();x0.fill();
  x0.strokeStyle='rgba(40,20,5,0.9)';x0.lineWidth=8;x0.beginPath();x0.moveTo(w*0.35,h*0.55);x0.lineTo(w*0.35,h*0.05);x0.stroke();x0.beginPath();x0.moveTo(w*0.65,h*0.55);x0.lineTo(w*0.65,h*0.12);x0.stroke();
  x0.fillStyle=rgba(pc(1),0.3+SM.beatPulse*0.1);x0.beginPath();x0.moveTo(w*0.35,h*0.08);x0.lineTo(w*0.52,h*0.18+Math.sin(t*0.001)*10);x0.lineTo(w*0.35,h*0.38);x0.closePath();x0.fill();x0.beginPath();x0.moveTo(w*0.65,h*0.15);x0.lineTo(w*0.82,h*0.25+Math.sin(t*0.001)*10);x0.lineTo(w*0.65,h*0.45);x0.closePath();x0.fill();
  // Centerpiece emblem on main sail
  if(THEME.centerpiece){
    // INTEGRATED: centerpiece emblem on main sail
    const sailCX=w*0.43,sailCY=h*0.23+Math.sin(t*0.001)*5;
    const emblemSz=Math.min(w,h)*(0.07+SM.beatPulse*0.012);
    cpRot+=0.004;cpPh+=0.013;
    x0.globalAlpha=0.65+SM.beatPulse*0.2;
    drawCPMini(x0,THEME.centerpiece,sailCX,sailCY,emblemSz,cpRot);
    x0.globalAlpha=1;
  }
  if(SD.seagulls)for(const sg of SD.seagulls){sg.x+=sg.vx;sg.ph+=0.08;if(sg.x>w+20)sg.x=-20;x0.beginPath();x0.moveTo(sg.x-10,sg.y+Math.sin(sg.ph)*3);x0.quadraticCurveTo(sg.x,sg.y-5,sg.x+10,sg.y+Math.sin(sg.ph)*3);x0.strokeStyle='rgba(255,255,255,0.5)';x0.lineWidth=1.5;x0.stroke();}
  if(SD.cannonballs)for(let i=SD.cannonballs.length-1;i>=0;i--){const cb=SD.cannonballs[i];cb.x+=cb.vx;cb.y+=cb.vy;cb.vy+=0.3;cb.life-=0.02;if(cb.life<=0||cb.y>h){SD.cannonballs.splice(i,1);continue;}x0.beginPath();x0.arc(cb.x,cb.y,cb.r,0,Math.PI*2);x0.fillStyle=rgba(pc(0),cb.life*0.9);x0.shadowBlur=15;x0.shadowColor=pc(0);x0.fill();x0.shadowBlur=0;}
}


// ‚ïê‚ïê‚ïê SCENE: junkyard ‚ïê‚ïê‚ïê

function drawJunkyard(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.junkyard){
    const groundY=h*0.72;
    const mkV=()=>{const types=['sedan','truck','van','suv','compact'];const type=types[Math.floor(Math.random()*types.length)];return{type,wM:type==='truck'?1.3:type==='van'?1.15:type==='compact'?0.8:type==='suv'?1.1:1,hM:type==='truck'?0.75:type==='van'?1.3:type==='compact'?0.85:type==='suv'?1.15:1,ci:Math.floor(Math.random()*4),tilt:(Math.random()-0.5)*0.08};};
    SD.junkyard={groundY,
      carStacks:Array.from({length:10},(_,i)=>{const isCS=Math.random()>0.25;const nc=isCS?(2+Math.floor(Math.random()*4)):0;
        return{x:(i+0.5)/10,cars:nc,origCars:nc,isCarStack:isCS,ci:i%4,h:isCS?0:(0.15+Math.random()*0.18),junkType:Math.floor(Math.random()*3),vehicles:Array.from({length:nc},mkV),crushed:false,crushFlash:0,respawnTimer:0,crushSparks:false};}),
      sparks:[],crushX:w*0.15,crushTargetX:null,crushTargetStack:null,crushPhase:'patrol',crushPressY:0,crushCooldown:0,crushDir:1,
      trackY:h*0.08,superCrusher:false,superCrusherTimer:0,superSparks:false,superSparksTimer:0,strobePhase:0,
      bgGlow:Array.from({length:8},(_,i)=>({x:Math.random()*w,y:h*0.1+Math.random()*h*0.5,r:50+Math.random()*100,ci:i%4,ph:Math.random()*Math.PI*2})),
    };
  }
  const J=SD.junkyard,groundY=J.groundY;
  if(J.superCrusherTimer>0){J.superCrusherTimer-=16;if(J.superCrusherTimer<=0)J.superCrusher=false;}
  if(J.superSparksTimer>0){J.superSparksTimer-=16;if(J.superSparksTimer<=0)J.superSparks=false;}
  const superC=J.superCrusher,superS=J.superSparks;
  // Respawn crushed towers 60-90s
  const mkV2=()=>{const types=['sedan','truck','van','suv','compact'];const type=types[Math.floor(Math.random()*types.length)];return{type,wM:type==='truck'?1.3:type==='van'?1.15:type==='compact'?0.8:type==='suv'?1.1:1,hM:type==='truck'?0.75:type==='van'?1.3:type==='compact'?0.85:type==='suv'?1.15:1,ci:Math.floor(Math.random()*4),tilt:(Math.random()-0.5)*0.08};};
  for(const s of J.carStacks){if(s.crushed&&s.isCarStack){s.respawnTimer+=16;if(s.respawnTimer>(60000+Math.random()*30000)){s.crushed=false;s.respawnTimer=0;s.crushSparks=false;s.cars=2+Math.floor(Math.random()*4);s.vehicles=Array.from({length:s.cars},mkV2);s.crushFlash=0;}}}
  const uncrushable=J.carStacks.filter(s=>s.isCarStack&&!s.crushed);
  J.crushCooldown=Math.max(0,J.crushCooldown-16);
  // BG
  const bgG=x0.createLinearGradient(0,0,0,h);bgG.addColorStop(0,'rgba(8,4,2,1)');bgG.addColorStop(0.5,'rgba(18,10,5,1)');bgG.addColorStop(1,'rgba(5,3,1,1)');x0.fillStyle=bgG;x0.fillRect(0,0,w,h);
  for(const g of J.bgGlow){g.ph+=0.02;const gg=x0.createRadialGradient(g.x,g.y,0,g.x,g.y,g.r*(1+beat*0.3));gg.addColorStop(0,rgba(pc(g.ci),(0.06+beat*0.05+(superC?0.06:0))));gg.addColorStop(1,'transparent');x0.fillStyle=gg;x0.fillRect(0,0,w,h);}
  x0.fillStyle='rgba(15,10,5,1)';x0.fillRect(0,groundY,w,h-groundY);
  x0.strokeStyle=rgba(pc(1),0.4);x0.lineWidth=2;x0.shadowBlur=6;x0.shadowColor=pc(1);x0.beginPath();x0.moveTo(0,groundY);x0.lineTo(w,groundY);x0.stroke();x0.shadowBlur=0;
  // Track
  const trackY=J.trackY,trackH=22;
  x0.fillStyle='rgba(60,50,40,0.9)';x0.fillRect(0,trackY-trackH/2,w,trackH);
  x0.strokeStyle=rgba(pc(2),superC?0.8:0.5);x0.lineWidth=superC?3:2;x0.shadowBlur=superC?14:8;x0.shadowColor=pc(2);
  x0.beginPath();x0.moveTo(0,trackY-trackH/2);x0.lineTo(w,trackY-trackH/2);x0.stroke();
  x0.beginPath();x0.moveTo(0,trackY+trackH/2);x0.lineTo(w,trackY+trackH/2);x0.stroke();
  for(let tt=0;tt<24;tt++){const tx=tt/24*w;x0.fillStyle=rgba(pc(2),0.35);x0.fillRect(tx,trackY-trackH/2-7,10,7);x0.fillRect(tx,trackY+trackH/2,10,7);}
  x0.shadowBlur=0;
  // Crusher state machine ‚Äî slow patrol
  const patrolSpeed=(superC?0.8:0.35)*(1+energy*0.15);
  if(J.crushPhase==='patrol'){
    J.crushX+=J.crushDir*patrolSpeed;if(J.crushX>w*0.92)J.crushDir=-1;if(J.crushX<w*0.08)J.crushDir=1;
    J.crushPressY=Math.max(0,J.crushPressY-0.02);
    if(J.crushCooldown<=0&&uncrushable.length>0&&beat>0.3){
      let best=null,bd=Infinity;for(const s of uncrushable){const sx=s.x*w,d=Math.abs(J.crushX-sx);if(d<bd){bd=d;best=s;}}
      if(best){J.crushTargetStack=best;J.crushTargetX=best.x*w;J.crushPhase='aligning';J.crushCooldown=18000+Math.random()*6000;}
    }
  } else if(J.crushPhase==='aligning'){
    const dx=J.crushTargetX-J.crushX;if(Math.abs(dx)<3){J.crushX=J.crushTargetX;J.crushPhase='pressing';}else{J.crushX+=Math.sign(dx)*patrolSpeed*1.2;}
    J.crushPressY=Math.max(0,J.crushPressY-0.01);
  } else if(J.crushPhase==='pressing'){
    J.crushPressY=Math.min(1,J.crushPressY+0.012);
    if(J.crushPressY>=1){const st=J.crushTargetStack;if(st&&!st.crushed){st.crushed=true;st.crushFlash=1;st.crushSparks=true;st.cars=Math.max(1,Math.floor(st.cars*0.5));
      for(let sp=0;sp<(superC?35:18);sp++)J.sparks.push({x:st.x*w+((Math.random()-0.5)*w*0.1),y:groundY-(st.cars*h*0.08),vx:(Math.random()-0.5)*18,vy:-(Math.random()*12+4),life:1+Math.random()*0.5,ci:Math.floor(Math.random()*4),sz:3+Math.random()*3});
      flash(rgba(pc(st.ci),0.4),150);}J.crushPhase='retracting';}
  } else if(J.crushPhase==='retracting'){J.crushPressY=Math.max(0,J.crushPressY-0.015);if(J.crushPressY<=0){J.crushPhase='patrol';J.crushTargetStack=null;J.crushTargetX=null;}}
  // Draw crusher ‚Äî centerpiece IS the head, 3x size
  const maxPress=groundY-trackY-trackH/2-h*0.02;const crushY=trackY+trackH/2+J.crushPressY*maxPress*0.6;const cpSzBase=Math.min(w,h)*0.165;
  x0.strokeStyle='rgba(100,80,60,0.85)';x0.lineWidth=superC?14:10;x0.beginPath();x0.moveTo(J.crushX,trackY+trackH/2);x0.lineTo(J.crushX,crushY);x0.stroke();
  x0.strokeStyle='rgba(140,110,70,0.4)';x0.lineWidth=2;x0.beginPath();x0.moveTo(J.crushX-4,trackY+trackH/2);x0.lineTo(J.crushX-4,crushY);x0.stroke();x0.beginPath();x0.moveTo(J.crushX+4,trackY+trackH/2);x0.lineTo(J.crushX+4,crushY);x0.stroke();
  if(THEME.centerpiece){
    J.strobePhase+=0.04+beat*0.06+(J.crushPhase==='pressing'?0.15:0);
    const crushing=J.crushPhase==='pressing';const si=crushing?(0.6+Math.sin(J.strobePhase*8)*0.4):(0.85+Math.sin(J.strobePhase*2)*0.1);
    const cpSz=cpSzBase*(1+beat*0.08+(crushing?0.12:0));cpRot+=superC?0.06:0.02;cpPh+=0.013;
    const hR=cpSz*(1.2+beat*0.3+(crushing?0.5:0));const hG=x0.createRadialGradient(J.crushX,crushY,cpSz*0.2,J.crushX,crushY,hR);
    const hci=crushing?Math.floor(t*0.01)%4:0;hG.addColorStop(0,rgba(pc(hci),(0.3+beat*0.2)*(crushing?1.5:1)));hG.addColorStop(1,'transparent');
    x0.fillStyle=hG;x0.fillRect(J.crushX-hR,crushY-hR,hR*2,hR*2);
    x0.globalAlpha=si;x0.shadowBlur=crushing?(40+beat*30):(20+beat*12);x0.shadowColor=crushing?pc(Math.floor(t*0.012)%4):pc(0);
    drawCPMini(x0,THEME.centerpiece,J.crushX,crushY,cpSz,cpRot);x0.globalAlpha=1;x0.shadowBlur=0;
  }
  // Car stacks ‚Äî mixed fleet
  for(const stack of J.carStacks){const sx=stack.x*w;if(stack.crushFlash>0)stack.crushFlash=Math.max(0,stack.crushFlash-0.03);
    if(stack.isCarStack&&stack.cars>0){
      let cumH=0;for(let c=0;c<stack.cars;c++){
        const v=stack.vehicles[c]||{type:'sedan',wM:1,hM:1,ci:stack.ci,tilt:0};const baseW=w*0.075*v.wM;const baseH=h*0.065*v.hM;
        const isCT=stack.crushed&&c===stack.cars-1;const carW=isCT?baseW*1.15:baseW;const carH=isCT?baseH*0.45:baseH;
        cumH+=carH;const carY=groundY-cumH;
        x0.save();x0.translate(sx,carY+carH/2);x0.rotate(v.tilt*(isCT?3:1));x0.translate(-sx,-carY-carH/2);
        const cA=0.4+c*0.06+beat*0.15;x0.fillStyle=rgba(pc(v.ci),cA);x0.strokeStyle=rgba(pc(v.ci),0.7+beat*0.25);x0.lineWidth=2;x0.shadowBlur=8+beat*6;x0.shadowColor=pc(v.ci);
        if(v.type==='van'){x0.fillRect(sx-carW/2,carY,carW,carH);x0.strokeRect(sx-carW/2,carY,carW,carH);}
        else if(v.type==='suv'){x0.beginPath();x0.moveTo(sx-carW/2,carY+carH);x0.lineTo(sx-carW/2,carY+carH*0.3);x0.bezierCurveTo(sx-carW/2,carY,sx+carW/2,carY,sx+carW/2,carY+carH*0.3);x0.lineTo(sx+carW/2,carY+carH);x0.closePath();x0.fill();x0.stroke();}
        else{x0.fillRect(sx-carW/2,carY,carW,carH);x0.strokeRect(sx-carW/2,carY,carW,carH);if(v.type==='sedan'&&!isCT){x0.fillStyle=rgba(pc(v.ci),cA*0.7);x0.fillRect(sx-carW*0.3,carY-carH*0.2,carW*0.6,carH*0.25);}}
        if(!isCT){x0.fillStyle=rgba(pc((v.ci+1)%4),0.2+beat*0.1);x0.fillRect(sx-carW*0.3,carY+carH*0.1,carW*0.25,carH*0.35);x0.fillRect(sx+carW*0.05,carY+carH*0.1,carW*0.25,carH*0.35);
          x0.fillStyle='rgba(20,15,10,0.85)';x0.shadowBlur=0;x0.beginPath();x0.arc(sx-carW*0.32,carY+carH,carH*0.25,0,Math.PI*2);x0.fill();x0.beginPath();x0.arc(sx+carW*0.32,carY+carH,carH*0.25,0,Math.PI*2);x0.fill();
        } else {x0.strokeStyle=rgba(pc(0),0.5);x0.lineWidth=1;for(let cr=0;cr<3;cr++){x0.beginPath();x0.moveTo(sx-carW*0.4+cr*carW*0.3,carY);x0.lineTo(sx-carW*0.3+cr*carW*0.3+(Math.random()-0.5)*10,carY+carH);x0.stroke();}}
        x0.shadowBlur=0;x0.restore();
      }
      if(stack.crushFlash>0){const fG=x0.createRadialGradient(sx,groundY-h*0.1,0,sx,groundY-h*0.1,w*0.12);fG.addColorStop(0,rgba(pc(0),stack.crushFlash*0.8));fG.addColorStop(1,'transparent');x0.fillStyle=fG;x0.fillRect(sx-w*0.12,groundY-h*0.4,w*0.24,h*0.4);}
      if(stack.crushSparks&&Math.random()<0.15)J.sparks.push({x:sx+(Math.random()-0.5)*w*0.06,y:groundY-h*0.04*stack.cars,vx:(Math.random()-0.5)*6,vy:-(Math.random()*5+2),life:0.6+Math.random()*0.3,ci:Math.floor(Math.random()*4),sz:2+Math.random()*2});
    } else if(!stack.isCarStack){const ch2=stack.h*(h-groundY);x0.fillStyle=rgba(pc(stack.ci),0.18+beat*0.06);x0.strokeStyle=rgba(pc(stack.ci),0.5+beat*0.25);x0.lineWidth=2;x0.shadowBlur=4+beat*3;x0.shadowColor=pc(stack.ci);x0.fillRect(sx-w*0.03,groundY-ch2,w*0.06,ch2);x0.strokeRect(sx-w*0.03,groundY-ch2,w*0.06,ch2);x0.shadowBlur=0;}
  }
  // Sparks ‚Äî larger, brighter, more
  const sparkRate=superS?0.5:0.18;if(Math.random()<sparkRate||beat>0.35){const n=superS?6:2;for(let i=0;i<n;i++){const src=J.carStacks[Math.floor(Math.random()*J.carStacks.length)].x*w;J.sparks.push({x:src+((Math.random()-0.5)*w*0.12),y:groundY-Math.random()*h*0.35,vx:(Math.random()-0.5)*(superS?16:10),vy:-(Math.random()*(superS?12:7)+3),life:0.8+Math.random()*0.5,ci:Math.floor(Math.random()*4),sz:superS?4.5:3});}}
  for(let i=J.sparks.length-1;i>=0;i--){const sp=J.sparks[i];sp.x+=sp.vx;sp.y+=sp.vy;sp.vy+=0.25;sp.life-=0.015;if(sp.life<=0){J.sparks.splice(i,1);continue;}
    x0.beginPath();x0.arc(sp.x,sp.y,sp.sz*sp.life*(1+beat*0.3),0,Math.PI*2);x0.fillStyle=rgba(pc(sp.ci),sp.life*0.95);x0.shadowBlur=superS?(14+beat*8):(8+beat*5);x0.shadowColor=pc(sp.ci);x0.fill();x0.shadowBlur=0;
    x0.strokeStyle=rgba(pc(sp.ci),sp.life*0.55);x0.lineWidth=1.5+sp.sz*0.3;x0.beginPath();x0.moveTo(sp.x,sp.y);x0.lineTo(sp.x-sp.vx*3.5,sp.y-sp.vy*3.5);x0.stroke();}
}


// ‚ïê‚ïê‚ïê SCENE: superhero ‚ïê‚ïê‚ïê

function drawSuperhero(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;

  if(!SD.gotham){
    SD.gotham={
      buildings:Array.from({length:22},(_,i)=>{
        const bw=28+Math.random()*65;
        const numWin=Math.floor(Math.random()*25+12);
        return{
          x:i*(w/22),w:bw,h:h*(0.32+Math.random()*0.48),ci:i%4,
          windows:Array.from({length:numWin},()=>({
            x:Math.random()*bw*0.75+bw*0.08,y:Math.random()*h*0.42+15,
            on:Math.random()>0.45,onTimer:Math.random()*8000,offTimer:Math.random()*12000,
            ci:Math.floor(Math.random()*4),
          })),
          fires:[],
          firePh:Math.random()*4000+2000,
          fireTimer:Math.random()*10000,
          hasNeon:Math.random()>0.45,
          neonText:Math.random()>0.5?'HOTEL':'BANK',
        };
      }),
      rainDrops:Array.from({length:180},()=>({x:Math.random()*w,y:Math.random()*h,vy:9+Math.random()*7,len:8+Math.random()*16,alpha:0.1+Math.random()*0.22})),
      spotlight:{angle:Math.PI*0.55,rotDir:1,speed:0.003,x:w*0.18,y:h*0.95},
      riddler:null,
      riddlerAlpha:0,
      fireBlazeMode:false,
      fireBlazeTimer:0,
      spotlightMode:false,
      spotlightModeTimer:0,
      questionMarks:[],
      windowTimerAcc:0,
      fireTimerAcc:0,
    };
    // Seed 2-3 initial fires across random buildings
    let initFires=0;
    for(const b of SD.gotham.buildings){
      if(initFires<3&&Math.random()>0.88){b.fires.push({ph:Math.random()*Math.PI*2,active:true,x:Math.random()*b.w,ci:Math.floor(Math.random()*4),buildingY:Math.random()*b.h*0.6});initFires++;}
    }
  }
  const G=SD.gotham;

  // Update timers
  G.windowTimerAcc+=16;
  G.fireTimerAcc+=16;
  if(G.fireBlazeTimer>0){G.fireBlazeTimer-=16;if(G.fireBlazeTimer<=0)G.fireBlazeMode=false;}
  if(G.spotlightModeTimer>0){G.spotlightModeTimer-=16;if(G.spotlightModeTimer<=0)G.spotlightMode=false;}

  // Window on/off timers
  if(G.windowTimerAcc>200){
    G.windowTimerAcc=0;
    for(const b of G.buildings){
      for(const wn of b.windows){
        wn.onTimer-=200;wn.offTimer-=200;
        if(wn.on&&wn.onTimer<=0){wn.on=false;wn.offTimer=3000+Math.random()*15000;}
        if(!wn.on&&wn.offTimer<=0){wn.on=true;wn.onTimer=4000+Math.random()*12000;}
      }
    }
  }

  // Fire appear/disappear ‚Äî GLOBAL cap of 3-5 total fires across all buildings
  if(G.fireTimerAcc>500){
    G.fireTimerAcc=0;
    // Count total fires
    let totalFires=0;for(const b of G.buildings)totalFires+=b.fires.length;
    const maxTotal=G.fireBlazeMode?12:Math.min(5,3+Math.floor(songProg*3));
    if(totalFires<maxTotal&&Math.random()>0.4){
      // Add fire to a random building
      const rb=G.buildings[Math.floor(Math.random()*G.buildings.length)];
      if(rb.fires.length<2){ // max 2 per building
        rb.fires.push({ph:Math.random()*Math.PI*2,active:true,x:Math.random()*rb.w,ci:Math.floor(Math.random()*4),buildingY:Math.random()*rb.h*0.6});
      }
    } else if(totalFires>maxTotal&&!G.fireBlazeMode){
      // Remove a random fire
      const withFires=G.buildings.filter(b=>b.fires.length>0);
      if(withFires.length>0){withFires[Math.floor(Math.random()*withFires.length)].fires.pop();}
    }
  }

  // BG ‚Äî stormy night
  x0.fillStyle='rgba(2,3,15,1)';x0.fillRect(0,0,w,h);
  // Cloud layer
  const cloudG=x0.createRadialGradient(cx,h*0.1,0,cx,h*0.25,w*0.7);
  cloudG.addColorStop(0,'rgba(15,12,30,0.8)');cloudG.addColorStop(1,'transparent');
  x0.fillStyle=cloudG;x0.fillRect(0,0,w,h*0.5);

  // ‚îÄ‚îÄ RAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  x0.strokeStyle='rgba(100,130,200,0.18)';x0.lineWidth=0.8;
  for(const rd of G.rainDrops){
    rd.y+=rd.vy*(1+energy*0.3);if(rd.y>h){rd.y=-20;rd.x=Math.random()*w;}
    x0.globalAlpha=rd.alpha;
    x0.beginPath();x0.moveTo(rd.x,rd.y);x0.lineTo(rd.x-rd.vy*0.18,rd.y+rd.len);x0.stroke();
  }
  x0.globalAlpha=1;

  // ‚îÄ‚îÄ BUILDINGS ‚Äî Gotham skyline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const fireBlazeMode=G.fireBlazeMode;
  for(const b of G.buildings){
    const bh=h-b.h;

    // Building base
    x0.fillStyle='rgba(4,6,20,0.98)';x0.fillRect(b.x,bh,b.w,b.h);

    // Neon building sign
    if(b.hasNeon){
      x0.strokeStyle=rgba(pc(b.ci),0.55+beat*0.2);x0.lineWidth=2;
      x0.shadowBlur=8+beat*4;x0.shadowColor=pc(b.ci);
      x0.strokeRect(b.x+2,bh+5,b.w-4,14);x0.shadowBlur=0;
      x0.fillStyle=rgba(pc(b.ci),0.4);x0.font='9px monospace';
      x0.fillText(b.neonText,b.x+4,bh+16);
    }

    // Windows ‚Äî appear/disappear randomly
    for(const wn of b.windows){
      if(!wn.on)continue;
      const wAlpha=0.4+beat*0.15;
      x0.fillStyle=rgba(pc(wn.ci),wAlpha);
      x0.shadowBlur=4+beat*3;x0.shadowColor=pc(wn.ci);
      x0.fillRect(b.x+wn.x,bh+wn.y,6,9);x0.shadowBlur=0;
    }

    // Building outline
    x0.strokeStyle=rgba(pc(b.ci),0.12);x0.lineWidth=1;x0.strokeRect(b.x,bh,b.w,b.h);

    // Progressive damage ‚Äî cracks and broken windows increase with songProg
    const dmg=typeof songProg==='number'?songProg:0;
    if(dmg>0.15){
      // Cracks ‚Äî more appear as song progresses
      const numCracks=Math.floor(dmg*5);
      x0.strokeStyle=rgba(pc(b.ci),0.15+dmg*0.2);x0.lineWidth=1;
      for(let cr=0;cr<numCracks;cr++){
        const crSeed=(b.x*13+cr*77)%1000/1000; // deterministic per building
        const crx=b.x+crSeed*b.w;
        const cry=bh+crSeed*b.h*0.6;
        x0.beginPath();x0.moveTo(crx,cry);
        x0.lineTo(crx+(crSeed-0.5)*18,cry+12+dmg*15);
        x0.lineTo(crx+(crSeed-0.3)*12,cry+25+dmg*20);
        x0.stroke();
      }
    }
    if(dmg>0.4){
      // Broken windows ‚Äî dark holes with jagged edges
      const numBroken=Math.floor((dmg-0.4)*8);
      for(let bw=0;bw<Math.min(numBroken,4);bw++){
        const bwSeed=(b.x*7+bw*41)%1000/1000;
        const bwx=b.x+bwSeed*b.w*0.7+b.w*0.1;
        const bwy=bh+bwSeed*b.h*0.5+20;
        x0.fillStyle='rgba(0,0,0,0.9)';x0.fillRect(bwx-5,bwy-4,10,12);
        x0.strokeStyle=rgba(pc(b.ci),0.3);x0.lineWidth=1;
        // jagged edge
        x0.beginPath();x0.moveTo(bwx-5,bwy-4);x0.lineTo(bwx-3,bwy-1);x0.lineTo(bwx-5,bwy+2);x0.stroke();
        x0.beginPath();x0.moveTo(bwx+5,bwy-2);x0.lineTo(bwx+3,bwy+3);x0.lineTo(bwx+5,bwy+8);x0.stroke();
      }
    }
    if(dmg>0.7){
      // Structural damage ‚Äî chunks missing from roofline
      x0.fillStyle='rgba(4,6,20,0.98)';
      const chunkW=b.w*0.15+dmg*b.w*0.1;
      const chunkSeed=(b.x*3+17)%1000/1000;
      x0.fillRect(b.x+chunkSeed*b.w*0.5,bh-2,chunkW,8+dmg*6);
      // Rubble at base
      for(let rb=0;rb<3;rb++){
        x0.fillStyle=rgba(pc(b.ci),0.15);
        x0.fillRect(b.x+rb*b.w*0.25+b.w*0.1,h*0.87-4-rb*3,6+rb*3,4+rb*2);
      }
    }

    // Fires on building ‚Äî fewer but MUCH larger, appear anywhere
    for(const fire of b.fires){
      fire.ph+=0.08*(1+beat*0.3);
      const fx=b.x+fire.x,fy=bh+8+(fire.buildingY||0);
      const fSize=(55+Math.sin(fire.ph)*20)*(fireBlazeMode?3:1.8);
      const fci=fireBlazeMode?Math.floor((t*0.005+fire.ph)%4):fire.ci||0;
      x0.shadowBlur=fSize*(fireBlazeMode?1.5:1.2);x0.shadowColor=fireBlazeMode?pc(fci):'rgba(255,140,0,0.8)';
      const fG=x0.createRadialGradient(fx+Math.sin(fire.ph)*8,fy,0,fx,fy,fSize);
      if(fireBlazeMode){fG.addColorStop(0,rgba(pc(fci),0.95));fG.addColorStop(0.5,rgba(pc((fci+1)%4),0.7));fG.addColorStop(1,'transparent');}
      else{fG.addColorStop(0,'rgba(255,230,100,0.9)');fG.addColorStop(0.4,'rgba(255,100,20,0.7)');fG.addColorStop(1,'transparent');}
      x0.fillStyle=fG;x0.beginPath();x0.arc(fx+Math.sin(fire.ph)*8,fy,fSize,0,Math.PI*2);x0.fill();
      // Flame licks ‚Äî upward tendrils
      x0.strokeStyle=fireBlazeMode?rgba(pc(fci),0.6):'rgba(255,180,50,0.5)';x0.lineWidth=2;
      for(let fl=0;fl<3;fl++){
        const flx=fx+Math.sin(fire.ph+fl*2)*fSize*0.3;
        x0.beginPath();x0.moveTo(flx,fy);
        x0.bezierCurveTo(flx+Math.sin(fire.ph+fl)*8,fy-fSize*0.4,flx-Math.sin(fire.ph*1.3+fl)*6,fy-fSize*0.7,flx+Math.sin(fire.ph*0.7+fl)*10,fy-fSize*(0.8+Math.sin(fire.ph+fl)*0.2));
        x0.stroke();
      }
      x0.shadowBlur=0;
    }

    // Street reflection
    x0.fillStyle='rgba(0,0,0,0.5)';x0.fillRect(b.x,h*0.87,b.w,h*0.13);
    for(const wn of b.windows){
      if(!wn.on)continue;
      const c=h2r(pc(wn.ci));
      x0.fillStyle=`rgba(${c.r},${c.g},${c.b},0.08)`;x0.fillRect(b.x+wn.x,h*0.87,6,h*0.13);
    }
  }

  // ‚îÄ‚îÄ SPOTLIGHT ‚Äî bigger, brighter, lingers at screen edges ‚îÄ‚îÄ
  const sp=G.spotlight;
  const spMode=G.spotlightMode;
  const spSpeed=spMode?0.015:sp.speed;
  // Edge linger ‚Äî when near limits, slow way down instead of instant reverse
  if(!sp.edgePause)sp.edgePause=0;
  if(sp.edgePause>0){
    sp.edgePause-=16;
  } else {
    sp.angle+=sp.rotDir*spSpeed*(1+beat*0.4);
    // Narrower sweep so spotlight stays more on-screen
    if(sp.angle>Math.PI*0.78){sp.rotDir=-1;sp.edgePause=1500+Math.random()*1000;}
    if(sp.angle<Math.PI*0.22){sp.rotDir=1;sp.edgePause=1500+Math.random()*1000;}
  }

  // Beam stays more visible ‚Äî shorter throw so it doesn't clip off-screen
  const spBeamX=spMode?cx:(sp.x+Math.cos(sp.angle)*w*0.85);
  const spBeamY=sp.y+Math.sin(sp.angle-Math.PI)*h*0.9;
  const spAlpha=spMode?(0.18+beat*0.1):(0.12+beat*0.06);

  x0.save();x0.globalAlpha=spAlpha;
  const spG=x0.createLinearGradient(sp.x,sp.y,spBeamX,spBeamY);
  spG.addColorStop(0,'rgba(230,230,255,0.95)');spG.addColorStop(1,'transparent');
  x0.fillStyle=spG;
  const beamW=spMode?80:45;
  x0.beginPath();x0.moveTo(sp.x-beamW/4,sp.y);x0.lineTo(sp.x+beamW/4,sp.y);
  x0.lineTo(spBeamX+beamW*(spMode?2.5:1.5),spBeamY);x0.lineTo(spBeamX-beamW*(spMode?2.5:1.5),spBeamY);
  x0.closePath();x0.fill();x0.restore();

  // Spotlight circle in sky ‚Äî LARGER and BRIGHTER
  const cloudX=spBeamX,cloudY=Math.max(h*0.03,Math.min(h*0.55,spBeamY));
  x0.fillStyle=`rgba(200,210,240,${spMode?0.3:0.2})`;
  x0.shadowBlur=spMode?(80+beat*40):55;x0.shadowColor='rgba(210,220,255,0.7)';
  x0.beginPath();x0.arc(cloudX,cloudY,spMode?(h*0.16+beat*h*0.06):(h*0.13+beat*h*0.02),0,Math.PI*2);x0.fill();
  x0.shadowBlur=0;

  // Centerpiece IN the spotlight
  if(THEME.centerpiece){
    cpRot+=(spMode?0.04:0.01)*(1+beat*0.5);cpPh+=0.013;
    const csSz=Math.min(w,h)*(spMode?(0.14+beat*0.06):(0.06+beat*0.02));
    x0.globalAlpha=spMode?(0.9+beat*0.1):(0.3+beat*0.1);
    if(spMode){x0.shadowBlur=25+beat*20;x0.shadowColor=pc(Math.floor(t*0.01)%4);}
    drawCPMini(x0,THEME.centerpiece,cloudX,cloudY,csSz,cpRot);
    x0.globalAlpha=1;x0.shadowBlur=0;
  }

  // ‚îÄ‚îÄ QUESTION MARKS raining ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(G.riddler){
    G.riddlerAlpha=Math.min(1,G.riddlerAlpha+0.015);
    if(G.riddler.timer>0)G.riddler.timer-=16;
    else{G.riddlerAlpha=Math.max(0,G.riddlerAlpha-0.015);if(G.riddlerAlpha<=0)G.riddler=null;}
  }

  // Spawn question marks
  if(G.riddler){
    if(Math.random()<0.15){
      G.questionMarks.push({x:Math.random()*w,y:-30,vy:3+Math.random()*4,rot:Math.random()*0.4-0.2,sz:20+Math.random()*40,ci:Math.floor(Math.random()*4)});
    }
  }
  for(let i=G.questionMarks.length-1;i>=0;i--){
    const qm=G.questionMarks[i];qm.y+=qm.vy*(1+beat*0.3);qm.rot+=0.01;
    if(qm.y>h+50){G.questionMarks.splice(i,1);continue;}
    x0.save();x0.translate(qm.x,qm.y);x0.rotate(qm.rot);
    x0.fillStyle=rgba(pc(qm.ci),0.85+beat*0.15);
    x0.shadowBlur=10+beat*6;x0.shadowColor=pc(qm.ci);
    x0.font=`bold ${qm.sz}px serif`;x0.textAlign='center';
    x0.fillText('?',0,0);x0.shadowBlur=0;
    x0.restore();
  }

  // ‚îÄ‚îÄ RIDDLER FACE ‚Äî neon outline, green bowler, question mark ‚îÄ‚îÄ
  if(G.riddler&&G.riddlerAlpha>0){
    const rd=G.riddler;
    const alpha=G.riddlerAlpha;
    const strobe=0.5+Math.abs(Math.sin(t*0.04+beat*10))*0.5;
    const rfcx=cx,rfcy=h*0.4;
    const rfr=Math.min(w,h)*0.28;
    const strobeCi=Math.floor(t*0.012+beat*6)%4;

    x0.save();x0.globalAlpha=alpha*strobe;

    // Dark overlay
    x0.fillStyle=`rgba(0,12,0,${0.7*alpha})`;x0.fillRect(0,0,w,h);

    const nClr=pc(2); // green primary
    const nClr2=pc(strobeCi);
    x0.strokeStyle=rgba(nClr,0.95);x0.lineWidth=3;
    x0.shadowBlur=20+beat*15;x0.shadowColor=nClr;

    // Angular face outline
    x0.beginPath();
    x0.moveTo(rfcx,rfcy-rfr*0.9);
    x0.lineTo(rfcx+rfr*0.6,rfcy-rfr*0.5);
    x0.lineTo(rfcx+rfr*0.7,rfcy+rfr*0.2);
    x0.lineTo(rfcx+rfr*0.4,rfcy+rfr*0.8);
    x0.lineTo(rfcx,rfcy+rfr*1.0);
    x0.lineTo(rfcx-rfr*0.4,rfcy+rfr*0.8);
    x0.lineTo(rfcx-rfr*0.7,rfcy+rfr*0.2);
    x0.lineTo(rfcx-rfr*0.6,rfcy-rfr*0.5);
    x0.closePath();x0.stroke();

    // Green bowler hat with question mark
    x0.strokeStyle=rgba(nClr,0.9);x0.lineWidth=3;
    const hatY=rfcy-rfr*0.9;
    x0.beginPath();x0.ellipse(rfcx,hatY,rfr*0.7,rfr*0.12,0,0,Math.PI*2);x0.stroke();
    x0.beginPath();x0.ellipse(rfcx,hatY-rfr*0.22,rfr*0.35,rfr*0.22,0,Math.PI,0);x0.stroke();
    // Question mark on hat
    x0.fillStyle=rgba(nClr2,0.9);x0.shadowColor=nClr2;x0.shadowBlur=15+beat*10;
    x0.font=`bold ${rfr*0.35}px serif`;x0.textAlign='center';
    x0.fillText('?',rfcx,hatY-rfr*0.08);

    // Blue/purple mask over eyes
    x0.strokeStyle=rgba(pc(1),0.85);x0.lineWidth=3;x0.shadowColor=pc(1);x0.shadowBlur=15;
    x0.beginPath();
    x0.moveTo(rfcx-rfr*0.6,rfcy-rfr*0.25);
    x0.bezierCurveTo(rfcx-rfr*0.5,rfcy-rfr*0.5,rfcx+rfr*0.5,rfcy-rfr*0.5,rfcx+rfr*0.6,rfcy-rfr*0.25);
    x0.bezierCurveTo(rfcx+rfr*0.5,rfcy-rfr*0.05,rfcx-rfr*0.5,rfcy-rfr*0.05,rfcx-rfr*0.6,rfcy-rfr*0.25);
    x0.closePath();x0.stroke();

    // Eyes ‚Äî glowing through mask
    for(const ex of [rfcx-rfr*0.28,rfcx+rfr*0.28]){
      x0.fillStyle=rgba(pc(3),0.9+beat*0.1);x0.shadowBlur=12+beat*8;x0.shadowColor=pc(3);
      x0.beginPath();x0.ellipse(ex,rfcy-rfr*0.18,rfr*0.08,rfr*0.06,0,0,Math.PI*2);x0.fill();
    }

    // Big menacing grin
    x0.strokeStyle=rgba(nClr,0.9);x0.lineWidth=3;x0.shadowColor=nClr;x0.shadowBlur=15;
    x0.beginPath();
    x0.moveTo(rfcx-rfr*0.45,rfcy+rfr*0.35);
    x0.bezierCurveTo(rfcx-rfr*0.2,rfcy+rfr*0.65,rfcx+rfr*0.2,rfcy+rfr*0.65,rfcx+rfr*0.45,rfcy+rfr*0.35);
    x0.stroke();
    // Teeth lines
    x0.lineWidth=1.5;
    for(let tk=0;tk<6;tk++){
      const tx2=rfcx-rfr*0.35+tk*rfr*0.14;
      const ty2=rfcy+rfr*0.38+Math.sin(tk*0.7)*rfr*0.04;
      x0.beginPath();x0.moveTo(tx2,ty2);x0.lineTo(tx2,ty2+rfr*0.15);x0.stroke();
    }

    x0.shadowBlur=0;x0.restore();
  }
}


// ‚ïê‚ïê‚ïê SCENE: dayOfDead ‚ïê‚ïê‚ïê

function drawSugarMask(ctx,x,y,sz,ci,t,beat,isMain){
  // Face oval
  ctx.fillStyle=rgba(pc(ci),isMain?0.12:0.06);
  ctx.beginPath();ctx.ellipse(x,y,sz*0.52,sz*0.62,0,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle=rgba(pc(ci),isMain?0.9:0.5);
  ctx.lineWidth=isMain?3:1.5;
  ctx.shadowBlur=isMain?20+beat*15:8;ctx.shadowColor=pc(ci);
  ctx.beginPath();ctx.ellipse(x,y,sz*0.52,sz*0.62,0,0,Math.PI*2);ctx.stroke();
  ctx.shadowBlur=0;

  // Forehead arch decoration
  ctx.strokeStyle=rgba(pc((ci+1)%4),isMain?0.7:0.35);
  ctx.lineWidth=isMain?2:1;ctx.shadowBlur=isMain?12:4;ctx.shadowColor=pc((ci+1)%4);
  ctx.beginPath();ctx.arc(x,y-sz*0.28,sz*0.28,Math.PI*1.15,Math.PI*1.85);ctx.stroke();
  // Diamond on forehead
  ctx.fillStyle=rgba(pc((ci+2)%4),isMain?0.8:0.4);
  ctx.shadowBlur=isMain?10:4;ctx.shadowColor=pc((ci+2)%4);
  ctx.beginPath();ctx.moveTo(x,y-sz*0.52);ctx.lineTo(x+sz*0.06,y-sz*0.44);
  ctx.lineTo(x,y-sz*0.36);ctx.lineTo(x-sz*0.06,y-sz*0.44);ctx.closePath();ctx.fill();
  ctx.shadowBlur=0;

  // Eye sockets ‚Äî large teardrop shaped
  const eyeX=sz*0.28,eyeY=y-sz*0.1;
  for(const ex of [x-eyeX,x+eyeX]){
    // Socket dark fill
    ctx.fillStyle=`rgba(0,0,0,${isMain?0.7:0.5})`;
    ctx.beginPath();ctx.ellipse(ex,eyeY,sz*0.16,sz*0.19,0,0,Math.PI*2);ctx.fill();
    // Socket decorative ring
    ctx.strokeStyle=rgba(pc((ci+2)%4),isMain?0.8:0.4);
    ctx.lineWidth=isMain?2.5:1;ctx.shadowBlur=isMain?14:5;ctx.shadowColor=pc((ci+2)%4);
    ctx.beginPath();ctx.ellipse(ex,eyeY,sz*0.16,sz*0.19,0,0,Math.PI*2);ctx.stroke();
    // Flower petals around eye
    for(let p=0;p<8;p++){
      const pa=p/8*Math.PI*2+(isMain?t*0.0004:0);
      const pr=sz*0.22;
      ctx.strokeStyle=rgba(pc((ci+p)%4),isMain?0.5:0.2);
      ctx.lineWidth=isMain?1.5:0.8;ctx.shadowBlur=isMain?6:2;
      ctx.beginPath();
      ctx.arc(ex+Math.cos(pa)*pr,eyeY+Math.sin(pa)*pr,sz*0.045,0,Math.PI*2);
      ctx.stroke();
    }
    ctx.shadowBlur=0;
  }

  // Nose ‚Äî small decorative diamond
  ctx.fillStyle=rgba(pc((ci+1)%4),isMain?0.6:0.3);
  ctx.shadowBlur=isMain?8:3;ctx.shadowColor=pc((ci+1)%4);
  ctx.beginPath();ctx.moveTo(x,y+sz*0.1);ctx.lineTo(x+sz*0.06,y+sz*0.17);
  ctx.lineTo(x,y+sz*0.24);ctx.lineTo(x-sz*0.06,y+sz*0.17);ctx.closePath();ctx.fill();
  ctx.shadowBlur=0;

  // Mouth ‚Äî teeth grin with decorative lines above/below
  ctx.strokeStyle=rgba(pc(ci),isMain?0.7:0.35);
  ctx.lineWidth=isMain?2:1;ctx.shadowBlur=isMain?10:3;ctx.shadowColor=pc(ci);
  // Lips outline
  ctx.beginPath();ctx.ellipse(x,y+sz*0.35,sz*0.2,sz*0.1,0,0,Math.PI*2);ctx.stroke();
  // Teeth
  ctx.fillStyle=`rgba(240,240,220,${isMain?0.85:0.45})`;
  for(let tooth=0;tooth<5;tooth++){
    const tx2=x-sz*0.16+tooth*sz*0.08;
    ctx.fillRect(tx2,y+sz*0.28,sz*0.065,sz*0.1);
  }
  ctx.shadowBlur=0;

  // Cheek swirl decorations
  for(const sx of [x-sz*0.32,x+sz*0.32]){
    const sDir=sx<x?1:-1;
    ctx.strokeStyle=rgba(pc((ci+3)%4),isMain?0.6:0.25);
    ctx.lineWidth=isMain?2:0.8;ctx.shadowBlur=isMain?8:3;ctx.shadowColor=pc((ci+3)%4);
    ctx.beginPath();
    ctx.moveTo(sx,y+sz*0.05);
    ctx.bezierCurveTo(sx+sDir*sz*0.1,y-sz*0.08,sx+sDir*sz*0.18,y+sz*0.05,sx+sDir*sz*0.08,y+sz*0.15);
    ctx.stroke();
    // Dots along cheek
    for(let d=0;d<3;d++){
      ctx.fillStyle=rgba(pc((ci+d)%4),isMain?0.5:0.2);
      ctx.beginPath();ctx.arc(sx+sDir*d*sz*0.05,y+sz*(0.08+d*0.06),isMain?3:1.5,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;
  }

  // Crown of flowers at top
  if(isMain){
    for(let fl=0;fl<7;fl++){
      const fa=fl/7*Math.PI+Math.PI*0.05;
      const fr=sz*0.52;
      const fx=x+Math.cos(fa-Math.PI*0.5)*sz*0.52;
      const fy=y+Math.sin(fa-Math.PI*0.5)*sz*0.62;
      ctx.fillStyle=rgba(pc(fl%4),0.7+beat*0.2);
      ctx.shadowBlur=8+beat*6;ctx.shadowColor=pc(fl%4);
      ctx.beginPath();ctx.arc(fx,fy,sz*0.048*(1+beat*0.2),0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=rgba(pc((fl+2)%4),0.5);ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(fx,fy,sz*0.075,0,Math.PI*2);ctx.stroke();
      ctx.shadowBlur=0;
    }
  }
}

function drawMiniSkull(ctx,x,y,sz,ci,t){
  ctx.fillStyle=rgba(pc(ci),0.5);
  ctx.shadowBlur=5;ctx.shadowColor=pc(ci);
  ctx.beginPath();ctx.ellipse(x,y-sz*0.2,sz*0.45,sz*0.4,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(0,0,0,0.8)';
  ctx.beginPath();ctx.ellipse(x-sz*0.14,y-sz*0.22,sz*0.12,sz*0.14,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(x+sz*0.14,y-sz*0.22,sz*0.12,sz*0.14,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=rgba(pc(ci),0.6);
  ctx.beginPath();ctx.rect(x-sz*0.28,y+sz*0.05,sz*0.56,sz*0.3);ctx.fill();
  ctx.fillStyle='rgba(0,0,0,0.7)';
  for(let t2=0;t2<4;t2++)ctx.fillRect(x-sz*0.22+t2*sz*0.15,y+sz*0.06,sz*0.08,sz*0.25);
  ctx.shadowBlur=0;
}

function drawSombrero(ctx,x,y,sz,t,beat){
  const brimW=sz*0.85;
  const crownH=sz*0.28;
  const crownW=sz*0.32;
  // Brim ‚Äî wide ellipse
  ctx.fillStyle=rgba(pc(0),0.85);
  ctx.shadowBlur=20+beat*10;ctx.shadowColor=pc(1);
  ctx.beginPath();ctx.ellipse(x,y,brimW,brimW*0.22,0,0,Math.PI*2);ctx.fill();
  // Brim underside shade
  ctx.fillStyle=rgba(pc(2),0.4);
  ctx.beginPath();ctx.ellipse(x,y+4,brimW*0.9,brimW*0.18,0,0,Math.PI*2);ctx.fill();
  // Crown
  ctx.fillStyle=rgba(pc(0),0.9);
  ctx.beginPath();ctx.ellipse(x,y,crownW,crownW*0.22,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.moveTo(x-crownW,y);ctx.lineTo(x-crownW*0.85,-crownH);
  ctx.bezierCurveTo(x-crownW*0.5,-crownH*1.15,x+crownW*0.5,-crownH*1.15,x+crownW*0.85,-crownH);
  ctx.lineTo(x+crownW,y);ctx.fill();
  // Decorative band
  ctx.strokeStyle=rgba(pc(1),0.9);ctx.lineWidth=3;ctx.shadowBlur=12;ctx.shadowColor=pc(1);
  ctx.beginPath();ctx.ellipse(x,y-crownH*0.12,crownW*0.95,crownW*0.21,0,-Math.PI,0,true);ctx.stroke();
  // Pompom / tassel at top
  ctx.fillStyle=rgba(pc(3),0.95);ctx.shadowBlur=15;ctx.shadowColor=pc(3);
  ctx.beginPath();ctx.arc(x,-crownH*1.1,sz*0.04*(1+beat*0.3),0,Math.PI*2);ctx.fill();
  // Brim decorative dots
  ctx.shadowBlur=6;
  for(let d=0;d<14;d++){
    const da=d/14*Math.PI*2;
    const dr=brimW*0.75;
    ctx.fillStyle=rgba(pc(d%4),0.7+beat*0.2);
    ctx.beginPath();ctx.arc(x+Math.cos(da)*dr,y+Math.sin(da)*dr*0.22,sz*0.018,0,Math.PI*2);ctx.fill();
  }
  ctx.shadowBlur=0;
}

function drawZombie(ctx,x,y,sz,ci,ph,beat){
  const bounce=Math.abs(Math.sin(ph))*sz*0.08;
  const sway=Math.sin(ph*0.5)*sz*0.06;
  // Legs shuffle
  const lLeg=Math.sin(ph)*sz*0.15;
  const rLeg=-Math.sin(ph)*sz*0.15;
  ctx.strokeStyle=rgba(pc(ci),0.8);ctx.lineWidth=sz*0.09;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x-sz*0.12+sway,y+sz*0.4+lLeg);ctx.stroke();
  ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+sz*0.12+sway,y+sz*0.4+rLeg);ctx.stroke();
  // Body
  ctx.fillStyle=rgba(pc(ci),0.55);
  ctx.fillRect(x-sz*0.16+sway,y-sz*0.5+bounce,sz*0.32,sz*0.5);
  // Arms outstretched (zombie style)
  const lArmA=Math.sin(ph*0.7)*0.3-0.2;
  const rArmA=-Math.sin(ph*0.7)*0.3+0.2;
  ctx.lineWidth=sz*0.07;
  ctx.beginPath();ctx.moveTo(x-sz*0.16+sway,y-sz*0.3+bounce);
  ctx.lineTo(x-sz*0.45+sway,y-sz*(0.3-lArmA*0.3)+bounce);ctx.stroke();
  ctx.beginPath();ctx.moveTo(x+sz*0.16+sway,y-sz*0.3+bounce);
  ctx.lineTo(x+sz*0.45+sway,y-sz*(0.3-rArmA*0.3)+bounce);ctx.stroke();
  ctx.lineCap='butt';
  // Head with mini sugar mask look
  ctx.fillStyle=rgba(pc(ci),0.7);ctx.shadowBlur=8;ctx.shadowColor=pc(ci);
  ctx.beginPath();ctx.ellipse(x+sway,y-sz*0.65+bounce,sz*0.16,sz*0.18,0,0,Math.PI*2);ctx.fill();
  // X eyes
  ctx.strokeStyle='rgba(0,0,0,0.9)';ctx.lineWidth=1.5;ctx.shadowBlur=0;
  for(const ex of [x-sz*0.06+sway,x+sz*0.06+sway]){
    const ey=y-sz*0.67+bounce;
    ctx.beginPath();ctx.moveTo(ex-3,ey-3);ctx.lineTo(ex+3,ey+3);ctx.stroke();
    ctx.beginPath();ctx.moveTo(ex+3,ey-3);ctx.lineTo(ex-3,ey+3);ctx.stroke();
  }
  // Dots / decoration on face
  ctx.fillStyle=rgba(pc((ci+2)%4),0.7);ctx.shadowBlur=3;ctx.shadowColor=pc((ci+2)%4);
  ctx.beginPath();ctx.arc(x+sway,y-sz*0.55+bounce,sz*0.04,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;
}

function drawDayOfDead(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!SD.dotd){
    SD.dotd={
      // Floating background candles
      bgCandles:Array.from({length:22},(_,i)=>({
        x:Math.random()*w, y:Math.random()*h,
        vx:(Math.random()-0.5)*0.3, vy:-(0.1+Math.random()*0.2),
        sz:12+Math.random()*22, ph:Math.random()*Math.PI*2,
        ci:i%4, flicker:Math.random()*Math.PI*2,
      })),
      // Floating sugar masks in background
      bgMasks:Array.from({length:8},(_,i)=>({
        x:Math.random()*w, y:Math.random()*h,
        vx:(Math.random()-0.5)*0.25, vy:(Math.random()-0.5)*0.15,
        sz:28+Math.random()*42, rot:Math.random()*Math.PI*2,
        rotSpeed:(Math.random()-0.5)*0.006, ph:Math.random()*Math.PI*2,
        ci:i%4, alpha:0.45+Math.random()*0.3,
      })),
      // Main mask spin state
      maskRot:0,        // Y-axis rotation (0=front, PI=back)
      maskRotSpeed:0.008,
      maskPulse:0,
      // Zombies
      zombies:[],
      zombieActive:false,
      // Sombrero
      sombrero:null,
      sombreroWorn:false,
      // Marigold petals
      petals:Array.from({length:50},()=>({
        x:Math.random()*w, y:Math.random()*h*0.5+h*0.5,
        vx:(Math.random()-0.5)*0.6, vy:-(0.2+Math.random()*0.4),
        sz:4+Math.random()*6, rot:Math.random()*Math.PI*2,
        rotSpeed:(Math.random()-0.5)*0.04, ci:1, alpha:0.5+Math.random()*0.4,
      })),
    };
  }
  const D=SD.dotd;

  // ‚îÄ‚îÄ Sky background ‚Äî deep indigo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sky=x0.createLinearGradient(0,0,0,h);
  const sc0=h2r(pc(0)),sc2=h2r(pc(2));
  sky.addColorStop(0,`rgba(${Math.round(sc0.r*0.06)},${Math.round(sc0.g*0.04)},${Math.round(sc0.b*0.12)},1)`);
  sky.addColorStop(0.5,`rgba(${Math.round(sc2.r*0.04)},${Math.round(sc2.g*0.03)},${Math.round(sc2.b*0.1)},1)`);
  sky.addColorStop(1,'rgba(4,1,8,1)');
  x0.fillStyle=sky;x0.fillRect(0,0,w,h);

  // ‚îÄ‚îÄ Floating background candles ‚Äî bright and vibrant ‚îÄ‚îÄ
  for(const c of D.bgCandles){
    c.x+=c.vx;c.y+=c.vy;c.ph+=0.04;c.flicker+=0.12+Math.random()*0.05;
    if(c.y<-30)c.y=h+30;if(c.x<-30)c.x=w+30;if(c.x>w+30)c.x=-30;
    const flk=0.7+Math.sin(c.flicker)*0.3+Math.random()*0.1;
    const alpha=(0.6+Math.sin(c.ph)*0.15)*flk;
    // Candle body ‚Äî brighter
    x0.fillStyle=rgba(pc(c.ci),alpha*0.85);
    x0.fillRect(c.x-c.sz*0.15,c.y,c.sz*0.3,c.sz*0.7);
    // Flame ‚Äî larger
    const fH=c.sz*0.6*flk;
    x0.shadowBlur=fH*1.5;x0.shadowColor=rgba(pc(c.ci),0.7);
    const fg=x0.createRadialGradient(c.x,c.y-fH*0.3,0,c.x,c.y,fH);
    fg.addColorStop(0,'rgba(255,255,200,0.95)');
    fg.addColorStop(0.35,rgba(pc(c.ci),0.75*alpha));
    fg.addColorStop(1,'transparent');
    x0.fillStyle=fg;x0.beginPath();
    x0.moveTo(c.x,c.y-fH);
    x0.bezierCurveTo(c.x+c.sz*0.18,c.y-fH*0.5,c.x+c.sz*0.12,c.y,c.x,c.y);
    x0.bezierCurveTo(c.x-c.sz*0.12,c.y,c.x-c.sz*0.18,c.y-fH*0.5,c.x,c.y-fH);
    x0.fill();x0.shadowBlur=0;
    // Glow halo ‚Äî stronger
    const hg=x0.createRadialGradient(c.x,c.y-fH*0.4,0,c.x,c.y-fH*0.4,c.sz*1.5*flk);
    hg.addColorStop(0,rgba(pc(c.ci),0.16*flk));hg.addColorStop(1,'transparent');
    x0.fillStyle=hg;x0.fillRect(0,0,w,h);
  }

  // ‚îÄ‚îÄ Floating background sugar masks ‚Äî brighter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const m of D.bgMasks){
    m.x+=m.vx;m.y+=m.vy;m.rot+=m.rotSpeed;m.ph+=0.015;
    if(m.x<-80)m.x=w+80;if(m.x>w+80)m.x=-80;
    if(m.y<-80)m.y=h+80;if(m.y>h+80)m.y=-80;
    const alpha=m.alpha*(1.0+Math.sin(m.ph)*0.3);
    x0.save();x0.translate(m.x,m.y);x0.rotate(m.rot);x0.globalAlpha=Math.min(1,alpha*1.8);
    x0.shadowBlur=12;x0.shadowColor=pc(m.ci);
    drawSugarMask(x0,0,0,m.sz,m.ci,t,0,false);
    x0.shadowBlur=0;
    x0.restore();
  }

  // ‚îÄ‚îÄ Marigold petals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const p of D.petals){
    p.x+=p.vx;p.y+=p.vy;p.rot+=p.rotSpeed;
    if(p.y<-20)p.y=h+20;
    x0.save();x0.translate(p.x,p.y);x0.rotate(p.rot);
    x0.fillStyle=rgba(pc(1),p.alpha*(0.75+beat*0.25));
    x0.beginPath();x0.ellipse(0,0,p.sz*0.4,p.sz,0,0,Math.PI*2);x0.fill();
    x0.restore();
  }

  // ‚îÄ‚îÄ MAIN GIANT SUGAR MASK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  D.maskRot+=D.maskRotSpeed*(1+beat*0.4);
  D.maskPulse+=(beat*0.08-D.maskPulse)*0.15;
  const maskSz=Math.min(w,h)*(0.42+D.maskPulse*0.25+songProg*0.04);
  const maskX=cx;
  const maskY=h*0.38;
  // Y-axis spin ‚Äî use cos for width scale (coin-flip rotation)
  const spinScale=Math.cos(D.maskRot);
  const absScale=Math.abs(spinScale);
  const facingFront=spinScale>=0;

  // Outer glow
  const maskGlow=x0.createRadialGradient(maskX,maskY,0,maskX,maskY,maskSz*1.1);
  maskGlow.addColorStop(0,rgba(pc(0),0.06*(1+beat*0.4)));
  maskGlow.addColorStop(0.5,rgba(pc(2),0.04));
  maskGlow.addColorStop(1,'transparent');
  x0.fillStyle=maskGlow;x0.fillRect(0,0,w,h);

  x0.save();
  x0.translate(maskX,maskY);
  x0.scale(spinScale,1); // Y-axis rotation via horizontal scale
  drawSugarMask(x0,0,0,maskSz,facingFront?0:2,t,beat,true);
  // Centerpieces in eyes
  if(THEME.centerpiece){
    cpRot+=0.02;cpPh+=0.013;
    const eyeOffX=maskSz*0.28;
    const eyeOffY=maskSz*(-0.12);
    const cpSz=maskSz*(0.13+beat*0.025);
    for(const ex of [-eyeOffX,eyeOffX]){
      x0.save();
      x0.shadowBlur=cpSz*0.8;x0.shadowColor=rgba(pc(facingFront?1:3),0.9);
      drawCPMini(x0,THEME.centerpiece,ex,eyeOffY,cpSz,cpRot*(facingFront?1:-1));
      x0.shadowBlur=0;
      x0.restore();
    }
  }
  x0.restore();

  // ‚îÄ‚îÄ Sombrero ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(D.sombrero){
    const som=D.sombrero;
    if(!som.worn){
      // Spinning down from above
      som.y+=som.vy;som.vy*=0.94;
      som.rot+=som.rotSpeed;
      som.rotSpeed*=0.97;
      if(som.y>=maskY-maskSz*0.55){
        som.y=maskY-maskSz*0.55;
        som.vy=0;som.worn=true;
        D.sombreroWorn=true;
      }
    } else {
      // Worn ‚Äî bounces with beat, wobbles proudly
      som.y=maskY-maskSz*0.55+Math.sin(t*0.002)*8*(1+beat*0.5);
      som.wobble=Math.sin(t*0.003)*0.08*(1+beat*0.4);
      som.rot+=0.005*(1+beat*0.3);
    }
    x0.save();
    x0.translate(som.x,som.y);
    x0.rotate(som.worn?som.wobble:som.rot);
    x0.scale(spinScale,1); // match mask's Y-axis spin
    drawSombrero(x0,0,0,maskSz*0.85,t,beat);
    x0.restore();
  }

  // ‚îÄ‚îÄ ZOMBIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(let i=D.zombies.length-1;i>=0;i--){
    const z=D.zombies[i];
    z.ph+=z.phSpeed*(1+beat*0.6);
    z.x+=z.vx*(1+energy*0.2);
    z.alpha=Math.min(0.9,z.alpha+0.008);
    if(z.x<-100||z.x>w+100){D.zombies.splice(i,1);continue;}
    // Dance ‚Äî bounce and sway
    const bounce=Math.abs(Math.sin(z.ph))*z.sz*0.15*(1+beat*0.5);
    const sway=Math.sin(z.ph*0.5)*z.sz*0.08;
    x0.save();x0.translate(z.x+sway,z.y-bounce);x0.globalAlpha=z.alpha;
    drawZombie(x0,0,0,z.sz,z.ci,z.ph,beat);
    x0.restore();
  }

  // ‚îÄ‚îÄ ALTAR at bottom ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const altW=w*0.42;
  const altX=cx-altW/2;
  const altY=h*0.72;
  const altH=h*0.28;

  // Altar backdrop glow
  const altGlow=x0.createRadialGradient(cx,altY,0,cx,altY,altW*0.7);
  altGlow.addColorStop(0,rgba(pc(0),0.22*(1+beat*0.4)));
  altGlow.addColorStop(1,'transparent');
  x0.fillStyle=altGlow;x0.fillRect(0,0,w,h);

  // Altar body ‚Äî 3 tiers, skulls embedded
  for(let tier=0;tier<3;tier++){
    const tFrac=tier/2;
    const tw=altW*(1-tFrac*0.2);
    const th=altH*0.3;
    const tx=cx-tw/2;
    const ty=altY+tier*th;
    // Stone fill
    x0.fillStyle=`rgba(${22+tier*6},${10+tier*4},${18+tier*6},0.95)`;
    x0.fillRect(tx,ty,tw,th);
    // Stone border
    x0.strokeStyle=rgba(pc(tier%4),0.55*(1+beat*0.2));
    x0.lineWidth=2;x0.shadowBlur=8;x0.shadowColor=pc(tier%4);
    x0.strokeRect(tx,ty,tw,th);x0.shadowBlur=0;
    // Decorative neon line detail on altar face
    x0.strokeStyle=rgba(pc((tier+2)%4),0.2);x0.lineWidth=1;
    for(let ld=1;ld<4;ld++){
      x0.beginPath();x0.moveTo(tx+tw*0.05,ty+th*ld*0.25);x0.lineTo(tx+tw*0.95,ty+th*ld*0.25);x0.stroke();
    }
    // Embedded skulls across each tier
    const skullCount=Math.floor(tw/(h*0.055));
    for(let sk=0;sk<skullCount;sk++){
      const skX=tx+tw*(sk+0.5)/skullCount;
      const skY=ty+th*0.5;
      const skSz=h*0.022;
      x0.save();x0.globalAlpha=0.75+beat*0.25;
      drawMiniSkull(x0,skX,skY,skSz,sk%4,t);
      x0.restore();
    }
  }

  // Altar top ‚Äî marigold arrangement
  x0.fillStyle=rgba(pc(1),0.6*(1+beat*0.2));
  for(let fl=0;fl<9;fl++){
    const flX=altX+altW*(fl+0.5)/9;
    const flY=altY-8;
    x0.beginPath();x0.arc(flX,flY,6+beat*3,0,Math.PI*2);x0.fill();
    x0.beginPath();x0.arc(flX,flY-10,4+beat*2,0,Math.PI*2);x0.fill();
  }

  // Altar candles ‚Äî tall, on top
  for(let ac=0;ac<5;ac++){
    const acX=altX+altW*(ac+0.5)/5;
    const acY=altY;
    const acH=h*0.07*(0.7+Math.random()*0.3);
    const flk=0.7+Math.sin(t*0.01+ac*1.3)*0.3+Math.random()*0.1;
    // Candle
    x0.fillStyle=`rgba(240,230,200,0.85)`;
    x0.fillRect(acX-4,acY-acH,8,acH);
    // Flame
    x0.fillStyle=`rgba(255,200,50,${0.8*flk})`;
    x0.shadowBlur=12*flk;x0.shadowColor='rgba(255,150,0,0.8)';
    x0.beginPath();x0.moveTo(acX,acY-acH-12*flk);
    x0.bezierCurveTo(acX+6,acY-acH-4,acX+4,acY-acH,acX,acY-acH);
    x0.bezierCurveTo(acX-4,acY-acH,acX-6,acY-acH-4,acX,acY-acH-12*flk);
    x0.fill();x0.shadowBlur=0;
  }

  // Ground / floor line
  x0.fillStyle='rgba(8,3,14,0.9)';x0.fillRect(0,altY+altH,w,h);
  x0.strokeStyle=rgba(pc(2),0.25);x0.lineWidth=2;
  x0.beginPath();x0.moveTo(0,altY+altH);x0.lineTo(w,altY+altH);x0.stroke();
}


// ‚ïê‚ïê‚ïê SCENE: chineseDragon ‚ïê‚ïê‚ïê

function drawChineseDragon(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Fog banks
  if(!SD.fog){SD.fog=Array.from({length:8},(_,i)=>({x:Math.random()*w,y:h*(0.3+Math.random()*0.5),r:150+Math.random()*200,ph:Math.random()*Math.PI*2,speed:0.003+Math.random()*0.003}));}
  for(const fg of SD.fog){fg.ph+=fg.speed;const fx=fg.x+Math.sin(fg.ph)*60,fy=fg.y+Math.cos(fg.ph*0.7)*30;const gr=x0.createRadialGradient(fx,fy,0,fx,fy,fg.r);const gc=h2r(pc(1));gr.addColorStop(0,`rgba(${gc.r},${gc.g},${gc.b},0.07)`);gr.addColorStop(1,'transparent');x0.fillStyle=gr;x0.fillRect(0,0,w,h);}
  // Pearl ‚Äî the centerpiece glowing orb the dragon chases
  if(!SD.pearl){SD.pearl={x:w*0.3,y:h*0.4,vx:1.5,vy:0.5,ph:0};}
  const pearl=SD.pearl;
  // Pearl moves in figure-8 pattern
  pearl.ph+=0.012*(1+SM.energy*0.2);
  pearl.x=cx+Math.sin(pearl.ph)*w*0.3;
  pearl.y=cy+Math.sin(pearl.ph*2)*h*0.2;
  // Draw pearl as centerpiece
  const pearlSz=Math.min(w,h)*(0.09+SM.beatPulse*0.04);
  const pg=x0.createRadialGradient(pearl.x,pearl.y,0,pearl.x,pearl.y,pearlSz*1.5);
  pg.addColorStop(0,rgba(pc(0),0.3*(1+SM.beatPulse*0.3)));pg.addColorStop(1,'transparent');
  x0.fillStyle=pg;x0.fillRect(0,0,w,h);
  cpPh+=0.013;cpRot+=0.04*(1+SM.energy*0.2);
  x0.shadowBlur=pearlSz*0.9;x0.shadowColor=rgba(pc(0),0.9);
  drawCPMini(x0,THEME.centerpiece,pearl.x,pearl.y,pearlSz,cpRot);
  x0.shadowBlur=0;
  // Dragon body ‚Äî sinuous segments chasing the pearl
  SD.dragonEmerge=Math.min(1,(SD.dragonEmerge||0)+0.004*(1+SM.energy*0.2));
  const emerge=SD.dragonEmerge;
  if(!SD.dragonPath){SD.dragonPath=Array.from({length:30},()=>({x:cx,y:cy}));}
  // Head moves toward pearl
  const head=SD.dragonPath[0];
  const dx=pearl.x-head.x,dy=pearl.y-head.y;
  const dist=Math.hypot(dx,dy)||1;
  head.x+=dx/dist*2.5*(1+SM.energy*0.4);
  head.y+=dy/dist*2.5*(1+SM.energy*0.4);
  // Body follows head
  for(let s=1;s<SD.dragonPath.length;s++){
    const prev=SD.dragonPath[s-1],curr=SD.dragonPath[s];
    const ddx=curr.x-prev.x,ddy=curr.y-prev.y;
    const dd=Math.hypot(ddx,ddy)||1;
    if(dd>22){curr.x=prev.x+ddx/dd*22;curr.y=prev.y+ddy/dd*22;}
  }
  // Draw body
  x0.save();x0.globalAlpha=emerge;
  for(let s=SD.dragonPath.length-1;s>=0;s--){
    const seg=SD.dragonPath[s];
    const segR=(28-s*0.7)*(1-s/(SD.dragonPath.length*1.5))*emerge;
    if(segR<1)continue;
    x0.beginPath();x0.arc(seg.x,seg.y,segR,0,Math.PI*2);
    x0.fillStyle=rgba(pc(s%4),(0.65-s*0.015)*Math.min(1,emerge*2));
    x0.shadowBlur=8;x0.shadowColor=pc(s%4);
    x0.fill();x0.shadowBlur=0;
    // Scales glint
    if(s%3===0){x0.fillStyle=rgba(pc((s+2)%4),0.25);x0.beginPath();x0.arc(seg.x,seg.y,segR*0.6,0,Math.PI*2);x0.fill();}
  }
  // Dragon head
  const dh=SD.dragonPath[0];
  const headDir=Math.atan2(SD.dragonPath[0].y-SD.dragonPath[1].y,SD.dragonPath[0].x-SD.dragonPath[1].x);
  x0.save();x0.translate(dh.x,dh.y);x0.rotate(headDir);
  x0.fillStyle=rgba(pc(0),0.92);x0.shadowBlur=30;x0.shadowColor=pc(0);
  x0.beginPath();x0.ellipse(0,0,38,26,0,0,Math.PI*2);x0.fill();
  // Jaw/snout
  x0.beginPath();x0.moveTo(20,8*(1+SM.beatPulse*0.3));x0.lineTo(55,5*(1+SM.beatPulse*0.3));x0.lineTo(55,14*(1+SM.beatPulse*0.3));x0.lineTo(20,16*(1+SM.beatPulse*0.3));x0.fill();
  // Eye
  x0.fillStyle=rgba(pc(1),0.95);x0.shadowBlur=15;x0.shadowColor=pc(1);
  x0.beginPath();x0.arc(20,-10,8,0,Math.PI*2);x0.fill();x0.fillStyle='rgba(0,0,0,0.9)';x0.beginPath();x0.arc(22,-10,4,0,Math.PI*2);x0.fill();
  // Horn
  x0.fillStyle=rgba(pc(2),0.85);x0.beginPath();x0.moveTo(5,-26);x0.lineTo(18,-50);x0.lineTo(22,-26);x0.closePath();x0.fill();
  x0.restore();x0.restore();
}


// ‚ïê‚ïê‚ïê SCENE: mountOlympus ‚ïê‚ïê‚ïê

function drawMountOlympus(t){
  const w=W(),h=H(),cx=w/2;const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.olympus){
    SD.olympus={faceR:h*0.27,faceCY:h*0.21,tiltAngle:0,tiltDir:1,tiltSpeed:0.008,
      eyeFlash:0,shootState:'idle',shootTimer:0,chargeStart:0,
      cpTargets:Array.from({length:8},(_,i)=>({x:w*(0.1+i*0.115),y:h*(0.72+Math.random()*0.12),alive:true,debris:[],scorchMark:false,embers:[]})),
      targetIdx:0,shootCooldown:0,
      bolts:[],ambientBolts:[],cloudPh:0,
      superStorm:false,superStormTimer:0,superWrath:false,superWrathTimer:0};
  }
  const O=SD.olympus;
  if(O.superStormTimer>0){O.superStormTimer-=16;if(O.superStormTimer<=0)O.superStorm=false;}
  if(O.superWrathTimer>0){O.superWrathTimer-=16;if(O.superWrathTimer<=0)O.superWrath=false;}
  const superSt=O.superStorm,superW=O.superWrath;
  O.cloudPh+=0.006+energy*0.003;
  // Dark sky
  const skyG=x0.createLinearGradient(0,0,0,h);skyG.addColorStop(0,'rgba(5,2,15,1)');skyG.addColorStop(0.4,'rgba(10,5,25,1)');skyG.addColorStop(0.7,'rgba(8,4,18,1)');skyG.addColorStop(1,'rgba(4,2,8,1)');x0.fillStyle=skyG;x0.fillRect(0,0,w,h);
  // Storm clouds ‚Äî vibrant, aurora-like
  for(let c=0;c<12;c++){const cc=c/12;const cloudX=w*(cc+Math.sin(O.cloudPh+c*0.7)*0.08);const cloudY=h*(0.05+Math.sin(O.cloudPh*0.7+c*1.2)*0.12);const cloudR=w*0.15+Math.sin(O.cloudPh+c)*w*0.05;
    const cg=x0.createRadialGradient(cloudX,cloudY,0,cloudX,cloudY,cloudR);const cci=c%4;
    cg.addColorStop(0,rgba(pc(cci),(0.08+beat*0.06+(superSt?0.08:0))));cg.addColorStop(0.5,rgba(pc((cci+1)%4),(0.04+beat*0.03)));cg.addColorStop(1,'transparent');x0.fillStyle=cg;x0.fillRect(0,0,w,h);}
  // Aurora streaks in clouds
  for(let a=0;a<5;a++){const ay=h*(0.05+a*0.06);const ax=w*0.5+Math.sin(O.cloudPh+a*1.5)*w*0.3;x0.strokeStyle=rgba(pc(a%4),0.06+beat*0.04);x0.lineWidth=h*0.02;x0.shadowBlur=20;x0.shadowColor=pc(a%4);x0.beginPath();x0.moveTo(ax-w*0.2,ay);x0.bezierCurveTo(ax-w*0.05,ay-h*0.03,ax+w*0.05,ay+h*0.03,ax+w*0.2,ay);x0.stroke();x0.shadowBlur=0;}
  // Mountains ‚Äî layered, glowing edges
  for(let ml=0;ml<3;ml++){const mBase=h*(0.55+ml*0.08);const mAlpha=0.15-ml*0.03;x0.fillStyle=`rgba(${8+ml*5},${4+ml*3},${15+ml*5},0.9)`;
    x0.beginPath();x0.moveTo(0,mBase+h*0.15);
    for(let mx=0;mx<=20;mx++){const mfrac=mx/20;const mh2=mBase-Math.sin(mfrac*Math.PI*2+ml*1.5)*h*(0.08-ml*0.02)-Math.sin(mfrac*Math.PI*5)*h*0.03;x0.lineTo(mfrac*w,mh2);}
    x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();x0.fill();
    // Glowing ridgeline
    x0.strokeStyle=rgba(pc(ml%4),mAlpha+beat*0.05);x0.lineWidth=2;x0.shadowBlur=8+beat*4;x0.shadowColor=pc(ml%4);
    x0.beginPath();for(let mx=0;mx<=20;mx++){const mfrac=mx/20;const mh2=mBase-Math.sin(mfrac*Math.PI*2+ml*1.5)*h*(0.08-ml*0.02)-Math.sin(mfrac*Math.PI*5)*h*0.03;if(mx===0)x0.moveTo(0,mh2);else x0.lineTo(mfrac*w,mh2);}x0.stroke();x0.shadowBlur=0;}
  // Ambient lightning ‚Äî sharper, thicker, brighter
  if(Math.random()<(superSt?0.15:0.04)+beat*0.05){const lx=Math.random()*w,ly=Math.random()*h*0.4;O.ambientBolts.push({x:lx,y:ly,segments:[],life:1,ci:Math.floor(Math.random()*4)});
    let bx=lx,by=ly;const segs=[];for(let s=0;s<8+Math.floor(Math.random()*6);s++){const nx=bx+(Math.random()-0.5)*60,ny=by+20+Math.random()*40;segs.push({x1:bx,y1:by,x2:nx,y2:ny});bx=nx;by=ny;if(Math.random()<0.3){const bx2=bx+(Math.random()-0.5)*40,by2=by+15+Math.random()*25;segs.push({x1:bx,y1:by,x2:bx2,y2:by2});}}
    O.ambientBolts[O.ambientBolts.length-1].segments=segs;}
  for(let i=O.ambientBolts.length-1;i>=0;i--){const b=O.ambientBolts[i];b.life-=0.06;if(b.life<=0){O.ambientBolts.splice(i,1);continue;}
    x0.strokeStyle=rgba(pc(b.ci),b.life*0.85);x0.lineWidth=3+b.life*2;x0.shadowBlur=15+beat*10;x0.shadowColor=pc(b.ci);
    for(const s of b.segments){x0.beginPath();x0.moveTo(s.x1,s.y1);x0.lineTo(s.x2,s.y2);x0.stroke();}x0.shadowBlur=0;}
  // ‚îÄ‚îÄ ZEUS FACE ‚Äî intimidating, heavy brow, flowing beard ‚îÄ‚îÄ
  const fR=O.faceR,fcx=cx,fcy=O.faceCY;O.tiltAngle+=O.tiltDir*O.tiltSpeed*(1+beat*0.3);if(Math.abs(O.tiltAngle)>0.18)O.tiltDir*=-1;
  x0.save();x0.translate(fcx,fcy);x0.rotate(O.tiltAngle);
  // Hair and beard ‚Äî massive flowing
  x0.fillStyle=rgba(pc(2),0.15+beat*0.05);x0.shadowBlur=12;x0.shadowColor=pc(2);
  // Hair mass
  x0.beginPath();x0.ellipse(0,-fR*0.15,fR*0.75,fR*0.65,0,Math.PI,0);
  x0.bezierCurveTo(fR*0.8,-fR*0.1,fR*0.9,fR*0.3,fR*0.7,fR*0.6);
  x0.bezierCurveTo(fR*0.6,fR*0.8,fR*0.3,fR*0.9,-0.1*fR,fR*0.95);
  x0.bezierCurveTo(-fR*0.3,fR*0.9,-fR*0.6,fR*0.8,-fR*0.7,fR*0.6);
  x0.bezierCurveTo(-fR*0.9,fR*0.3,-fR*0.8,-fR*0.1,-fR*0.75,-fR*0.15);x0.closePath();x0.fill();
  // Beard ‚Äî massive flowing with curls
  x0.fillStyle=rgba(pc(2),0.12+beat*0.04);
  x0.beginPath();x0.moveTo(-fR*0.4,fR*0.35);
  x0.bezierCurveTo(-fR*0.5,fR*0.7,-fR*0.6,fR*1.1,-fR*0.35,fR*1.4);
  x0.bezierCurveTo(-fR*0.2,fR*1.5,0,fR*1.55,fR*0.1,fR*1.5);
  x0.bezierCurveTo(fR*0.25,fR*1.45,fR*0.4,fR*1.3,fR*0.35,fR*1.1);
  x0.bezierCurveTo(fR*0.5,fR*0.7,fR*0.4,fR*0.35,fR*0.4,fR*0.35);x0.closePath();x0.fill();
  // Beard curl details
  x0.strokeStyle=rgba(pc(2),0.2);x0.lineWidth=2;
  for(let bc=0;bc<6;bc++){const bcx=(bc/5-0.5)*fR*0.6,bcy=fR*0.8+bc*fR*0.08;x0.beginPath();x0.arc(bcx,bcy,fR*0.06,0,Math.PI*1.5);x0.stroke();}
  x0.shadowBlur=0;
  // Face ‚Äî stone/dark
  x0.fillStyle='rgba(25,20,30,0.85)';x0.beginPath();x0.ellipse(0,0,fR*0.55,fR*0.6,0,0,Math.PI*2);x0.fill();
  x0.strokeStyle=rgba(pc(0),0.3+beat*0.15);x0.lineWidth=2;x0.stroke();
  // HEAVY SCOWLING BROW
  x0.strokeStyle=rgba(pc(0),0.55+beat*0.2);x0.lineWidth=5;x0.shadowBlur=6;x0.shadowColor=pc(0);
  // Left brow ‚Äî angled down toward center
  x0.beginPath();x0.moveTo(-fR*0.45,-fR*0.22);x0.bezierCurveTo(-fR*0.35,-fR*0.32,-fR*0.15,-fR*0.35,-fR*0.05,-fR*0.28);x0.stroke();
  // Right brow
  x0.beginPath();x0.moveTo(fR*0.45,-fR*0.22);x0.bezierCurveTo(fR*0.35,-fR*0.32,fR*0.15,-fR*0.35,fR*0.05,-fR*0.28);x0.stroke();
  x0.shadowBlur=0;
  // Deep-set eyes
  const eyeXL=-fR*0.25,eyeXR=fR*0.25,eyeY=-fR*0.15;
  // Eye sockets ‚Äî dark recesses
  x0.fillStyle='rgba(5,2,10,0.9)';x0.beginPath();x0.ellipse(eyeXL,eyeY,fR*0.12,fR*0.08,0,0,Math.PI*2);x0.fill();
  x0.beginPath();x0.ellipse(eyeXR,eyeY,fR*0.12,fR*0.08,0,0,Math.PI*2);x0.fill();
  // Eye glow ‚Äî charge-up system (2s, blazing transformation)
  let eyeGlow=0.3+beat*0.2;let eyeColor=rgba(pc(1),eyeGlow);
  if(O.shootState==='charging'){const chargeProg=Math.min(1,(t-O.chargeStart)/2000);eyeGlow=0.3+chargeProg*0.7;
    const r=Math.floor(lerp(180,255,chargeProg)),g=Math.floor(lerp(180,255,chargeProg)),b2=Math.floor(lerp(50,200,chargeProg));
    eyeColor=`rgba(${r},${g},${b2},${eyeGlow})`;
    // Dramatic charge pulse
    x0.shadowBlur=20+chargeProg*40+beat*15;x0.shadowColor=`rgba(${r},${g},${b2},${chargeProg})`;
  } else if(O.shootState==='firing'){eyeGlow=1;eyeColor='rgba(255,255,255,1)';x0.shadowBlur=50+beat*20;x0.shadowColor='rgba(255,255,200,1)';
  } else {x0.shadowBlur=8+beat*6;x0.shadowColor=pc(1);}
  x0.fillStyle=eyeColor;x0.beginPath();x0.ellipse(eyeXL,eyeY,fR*0.07,fR*0.05,0,0,Math.PI*2);x0.fill();
  x0.beginPath();x0.ellipse(eyeXR,eyeY,fR*0.07,fR*0.05,0,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
  // Strong angular nose
  x0.strokeStyle=rgba(pc(0),0.4);x0.lineWidth=3;x0.beginPath();x0.moveTo(0,-fR*0.15);x0.lineTo(-fR*0.04,fR*0.08);x0.lineTo(fR*0.06,fR*0.08);x0.stroke();
  // Mouth ‚Äî stern/menacing
  x0.strokeStyle=rgba(pc(0),0.35+beat*0.1);x0.lineWidth=3;x0.beginPath();x0.moveTo(-fR*0.18,fR*0.22);x0.bezierCurveTo(-fR*0.08,fR*0.26,fR*0.08,fR*0.26,fR*0.18,fR*0.22);x0.stroke();
  x0.restore();
  // ‚îÄ‚îÄ SHOOT STATE MACHINE ‚Äî 8 targets, spread across song ‚îÄ‚îÄ
  O.shootCooldown=Math.max(0,O.shootCooldown-16);
  const aliveTargets=O.cpTargets.filter(t2=>t2.alive);
  if(O.shootState==='idle'&&aliveTargets.length>0&&O.shootCooldown<=0&&beat>0.25){
    O.shootState='charging';O.chargeStart=t;O.shootCooldown=12000+Math.random()*8000;
  } else if(O.shootState==='charging'&&(t-O.chargeStart)>2000){
    O.shootState='firing';O.shootTimer=600;
    // Fire bolts at next target
    const tgt=O.cpTargets[O.targetIdx];if(tgt&&tgt.alive){
      const tgtX=tgt.x-fcx,tgtY=tgt.y-fcy;
      for(const ex of[eyeXL,eyeXR]){let bx2=fcx+ex*Math.cos(O.tiltAngle),by2=fcy+eyeY;const segs2=[];let px2=bx2,py2=by2;
        for(let s=0;s<6;s++){const frac=(s+1)/6;const nx2=lerp(bx2,tgt.x,frac)+(Math.random()-0.5)*30,ny2=lerp(by2,tgt.y,frac)+(Math.random()-0.5)*20;segs2.push({x1:px2,y1:py2,x2:nx2,y2:ny2});px2=nx2;py2=ny2;}
        O.bolts.push({segments:segs2,life:1,ci:Math.floor(Math.random()*4),targetIdx:O.targetIdx});}
    }
  } else if(O.shootState==='firing'){O.shootTimer-=16;if(O.shootTimer<=0){
    const tgt=O.cpTargets[O.targetIdx];if(tgt&&tgt.alive){tgt.alive=false;tgt.scorchMark=true;
      // Big explosion
      for(let d=0;d<40;d++){tgt.debris.push({x:tgt.x,y:tgt.y,vx:(Math.random()-0.5)*16,vy:-(Math.random()*12+3),life:1,ci:Math.floor(Math.random()*4),r:2+Math.random()*5});}
      // Embers that persist
      for(let e=0;e<12;e++){tgt.embers.push({x:tgt.x+(Math.random()-0.5)*30,y:tgt.y+(Math.random()-0.5)*15,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)});}
      flash('rgba(255,255,150,0.7)',200);}
    O.targetIdx=(O.targetIdx+1)%8;O.shootState='idle';}}
  // Draw bolts
  for(let i=O.bolts.length-1;i>=0;i--){const b=O.bolts[i];b.life-=0.04;if(b.life<=0){O.bolts.splice(i,1);continue;}
    x0.strokeStyle=rgba(pc(b.ci),b.life*0.9);x0.lineWidth=4+b.life*3;x0.shadowBlur=20+beat*15;x0.shadowColor=pc(b.ci);
    for(const s of b.segments){x0.beginPath();x0.moveTo(s.x1,s.y1);x0.lineTo(s.x2,s.y2);x0.stroke();}x0.shadowBlur=0;}
  // ‚îÄ‚îÄ 8 TARGETS ‚Äî scattered in lower scene ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const tgt of O.cpTargets){
    if(tgt.alive&&THEME.centerpiece){const tSz=Math.min(w,h)*0.04+beat*4;x0.globalAlpha=0.8+beat*0.15;x0.shadowBlur=10+beat*6;x0.shadowColor=pc(0);drawCPMini(x0,THEME.centerpiece,tgt.x,tgt.y,tSz,cpRot);x0.globalAlpha=1;x0.shadowBlur=0;}
    // Debris
    for(let d=tgt.debris.length-1;d>=0;d--){const p=tgt.debris[d];p.x+=p.vx;p.y+=p.vy;p.vy+=0.3;p.life-=0.012;if(p.life<=0){tgt.debris.splice(d,1);continue;}
      x0.fillStyle=rgba(pc(p.ci),p.life*0.9);x0.shadowBlur=10;x0.shadowColor=pc(p.ci);x0.beginPath();x0.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
    // Scorch mark
    if(tgt.scorchMark){const sg=x0.createRadialGradient(tgt.x,tgt.y,0,tgt.x,tgt.y,25);sg.addColorStop(0,'rgba(40,20,5,0.6)');sg.addColorStop(0.5,'rgba(20,10,2,0.3)');sg.addColorStop(1,'transparent');x0.fillStyle=sg;x0.fillRect(tgt.x-25,tgt.y-25,50,50);}
    // Lingering embers
    for(const e of tgt.embers){e.ph+=0.03;x0.fillStyle=rgba(pc(e.ci),0.3+Math.sin(e.ph)*0.2+beat*0.15);x0.shadowBlur=6;x0.shadowColor=pc(e.ci);x0.beginPath();x0.arc(e.x+Math.sin(e.ph*2)*3,e.y-Math.abs(Math.sin(e.ph))*8,2,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  }
  // Centerpiece
  if(THEME.centerpiece){cpRot+=0.01*(1+energy*0.15);cpPh+=0.013;const gs=Math.min(w,h)*(0.12+beat*0.04);x0.globalAlpha=0.85+beat*0.15;x0.shadowBlur=15+beat*12;x0.shadowColor=pc(0);drawCPMini(x0,THEME.centerpiece,cx,h*0.5,gs,cpRot);x0.globalAlpha=1;x0.shadowBlur=0;}
}


// ‚ïê‚ïê‚ïê SCENE: superMario ‚ïê‚ïê‚ïê

function drawSuperMario(t){
  const w=W(),h=H();
  // Sky
  x0.fillStyle='#1a1a2e';x0.fillRect(0,0,w,h);
  // Stars
  if(!SD.marioStars){SD.marioStars=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h*0.5,b:Math.random()}));}
  for(const s of SD.marioStars){x0.fillStyle=`rgba(255,255,255,${0.3+Math.abs(Math.sin(t*0.001+s.b*10))*0.5})`;x0.fillRect(s.x,s.y,s.b>0.8?2:1,s.b>0.8?2:1);}
  // Scrolling background
  SD.scrollX=(SD.scrollX||0)+THEME.sceneSpeed*(1+SM.energy*0.3)*(1+beatFX.speedBoost*0.5);
  // Neon ground
  x0.fillStyle=rgba(pc(2),0.85);x0.fillRect(0,h*0.78,w,h*0.06);
  x0.fillStyle=rgba(pc(0),0.6);x0.fillRect(0,h*0.84,w,h*0.16);
  // Ground pattern
  x0.strokeStyle=rgba(pc(2),0.15);x0.lineWidth=1;
  for(let gx=0;gx<w;gx+=40){x0.beginPath();x0.moveTo((gx-SD.scrollX*0.3)%w,h*0.78);x0.lineTo((gx-SD.scrollX*0.3)%w,h);x0.stroke();}
  // Clouds
  for(let c=0;c<4;c++){const cx2=((c*w/3+t*0.018)%w+w)%w,cy2=h*0.12+c*h*0.05;x0.fillStyle='rgba(30,25,60,0.9)';x0.shadowBlur=8;x0.shadowColor=rgba(pc(2),0.3);x0.beginPath();x0.arc(cx2,cy2,35,0,Math.PI*2);x0.arc(cx2+28,cy2-8,25,0,Math.PI*2);x0.arc(cx2+55,cy2,35,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  // Pipes
  if(!SD.pipes){SD.pipes=Array.from({length:4},(_,i)=>({x:i*(w/3)+w*0.2,h:h*0.12+Math.random()*h*0.1}));}
  for(const pipe of SD.pipes){const px=((pipe.x-SD.scrollX%w+w*2)%w);x0.fillStyle=rgba(pc(2),0.8);x0.fillRect(px-18,h*0.78-pipe.h,36,pipe.h);x0.fillRect(px-23,h*0.78-pipe.h,46,18);x0.strokeStyle=rgba(pc(2),0.4);x0.lineWidth=1;x0.strokeRect(px-23,h*0.78-pipe.h,46,18);}
  // Platforms
  if(!SD.platforms){SD.platforms=Array.from({length:5},(_,i)=>({x:i*(w/4)+Math.random()*w*0.1,y:h*(0.42+Math.random()*0.2),w:60+Math.random()*80}));}
  for(const p of SD.platforms){const px=((p.x-SD.scrollX*0.5+w*2)%w);x0.fillStyle=rgba(pc(0),0.85);x0.shadowBlur=8;x0.shadowColor=pc(0);x0.fillRect(px,p.y,p.w,14);x0.shadowBlur=0;}
  // Question blocks ‚Äî centerpiece IS the spinning collectible block
  const cpBlockX=((w*0.5-SD.scrollX*0.7+w*2)%w);
  const cpBlockY=h*0.45+Math.sin(t*0.002)*8;
  const blkSz=36*(1+SM.beatPulse*0.12);
  if(THEME.centerpiece){
    cpPh+=0.013;cpRot+=0.025;
    // Block frame
    x0.fillStyle=rgba(pc(1),0.9);x0.shadowBlur=20;x0.shadowColor=pc(1);
    x0.fillRect(cpBlockX-blkSz/2,cpBlockY-blkSz/2,blkSz,blkSz);
    x0.strokeStyle='rgba(0,0,0,0.5)';x0.lineWidth=2;x0.strokeRect(cpBlockX-blkSz/2,cpBlockY-blkSz/2,blkSz,blkSz);
    x0.shadowBlur=0;
    // Centerpiece inside the block (spinning)
    x0.save();x0.beginPath();x0.rect(cpBlockX-blkSz/2,cpBlockY-blkSz/2,blkSz,blkSz);x0.clip();
    drawCPMini(x0,THEME.centerpiece,cpBlockX,cpBlockY,blkSz*0.45,cpRot);
    x0.restore();
    // "?" label when not hit
    x0.fillStyle='rgba(0,0,0,0.6)';x0.font=`bold ${blkSz*0.5}px monospace`;x0.textAlign='center';
    x0.fillText('?',cpBlockX,cpBlockY+blkSz*0.18);x0.textAlign='left';
  }
  // Goombas
  if(!SD.goombas){SD.goombas=Array.from({length:4},(_,i)=>({x:w*0.2+i*w*0.22,y:h*0.745,vx:0.6+Math.random()*0.4,ph:Math.random()*Math.PI*2}));}
  for(const g of SD.goombas){g.x+=g.vx*(1+SM.energy*0.2);if(g.x<-30||g.x>w+30)g.vx*=-1;g.ph+=0.05;const walkanim=Math.sin(g.ph)*g.vx*0.3;x0.fillStyle=rgba(pc(2),0.9);x0.shadowBlur=6;x0.shadowColor=pc(2);x0.beginPath();x0.arc(g.x,g.y,16,Math.PI,0);x0.fill();x0.beginPath();x0.ellipse(g.x,g.y+4,18,10,0,0,Math.PI*2);x0.fill();x0.fillStyle='rgba(0,0,0,0.8)';x0.beginPath();x0.arc(g.x-6,g.y-2,4,0,Math.PI*2);x0.arc(g.x+6,g.y-2,4,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  // Mario character
  const my=h*0.705;const mx=w*0.25;
  x0.fillStyle=rgba(pc(0),0.95);x0.shadowBlur=10;x0.shadowColor=pc(0);
  x0.fillRect(mx-10,my-38,22,38);x0.beginPath();x0.arc(mx,my-40,13,0,Math.PI*2);x0.fill();
  x0.fillRect(mx-14,my-54,30,12);x0.fillRect(mx-8,my-68,18,15);
  x0.fillStyle='rgba(200,160,120,0.9)';x0.beginPath();x0.arc(mx,my-40,9,0,Math.PI*2);x0.fill();
  x0.shadowBlur=0;
}


// ‚ïê‚ïê‚ïê SCENE: atlantis ‚ïê‚ïê‚ïê

function drawAtlantis(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;
  const floorY=h*0.88;

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!SD.atl){
    SD.atl={
      // Sea creatures ‚Äî slightly larger
      anglerfish:Array.from({length:3},(_,i)=>({
        x:Math.random()*w, y:h*(0.2+Math.random()*0.4),
        vx:(Math.random()<0.5?1:-1)*(0.3+Math.random()*0.35),
        sz:28+Math.random()*22, ph:Math.random()*Math.PI*2,
        ci:i%4, mouthPh:Math.random()*Math.PI*2,
        lurePh:Math.random()*Math.PI*2,
      })),
      mantas:Array.from({length:4},(_,i)=>({
        x:Math.random()*w, y:h*(0.06+Math.random()*0.25),
        vx:(Math.random()<0.5?1:-1)*(0.4+Math.random()*0.35),
        sz:42+Math.random()*35, ph:Math.random()*Math.PI*2,
        ci:i%4, waveAmp:0,
      })),
      eels:Array.from({length:5},(_,i)=>({
        x:Math.random()*w, y:h*(0.5+Math.random()*0.25),
        vx:(Math.random()<0.5?1:-1)*(0.2+Math.random()*0.25),
        sz:55+Math.random()*45, ph:Math.random()*Math.PI*2,
        phSpeed:0.018+Math.random()*0.01, ci:i%4,
        segments:14,
      })),
      bubbles:Array.from({length:35},()=>({
        x:Math.random()*w, y:Math.random()*h,
        vy:-(0.3+Math.random()*0.6), r:2+Math.random()*5,
        ph:Math.random()*Math.PI*2, ci:Math.floor(Math.random()*4),
        vx:(Math.random()-0.5)*0.2,
      })),
      caustics:Array.from({length:8},(_,i)=>({
        x:Math.random()*w, y:Math.random()*h*0.5,
        r:60+Math.random()*80, ph:Math.random()*Math.PI*2,
        speed:0.008+Math.random()*0.006, ci:i%4,
      })),
      shafts:Array.from({length:5},(_,i)=>({
        x:w*0.1+i*(w*0.2), ph:i*0.4, speed:0.004+Math.random()*0.003,
      })),
      // Poseidon ‚Äî very large
      poseidon:{jawAngle:0,jawDir:1,eyeGlow:0},
      // Kraken / whirlpool / bubbleStorm ‚Äî surprise state
      kraken:null, whirlpool:null, bubbleStorm:false, debris:[],
    };
  }
  const A=SD.atl;

  // ‚îÄ‚îÄ Deep ocean background ‚Äî richer palette tint ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const deep=x0.createLinearGradient(0,0,0,h);
  const sc0=h2r(pc(0)),sc2=h2r(pc(2));
  deep.addColorStop(0,`rgba(${Math.round(sc0.r*0.06)},${Math.round(sc0.g*0.1)},${Math.round(sc0.b*0.16)},1)`);
  deep.addColorStop(0.5,`rgba(${Math.round(sc2.r*0.04)},${Math.round(sc2.g*0.06)},${Math.round(sc2.b*0.14)},1)`);
  deep.addColorStop(1,'rgba(1,2,8,1)');
  x0.fillStyle=deep;x0.fillRect(0,0,w,h);

  // ‚îÄ‚îÄ Caustic light ripples ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const c of A.caustics){
    c.ph+=c.speed;
    const alpha=0.05+Math.sin(c.ph)*0.03;
    const cg=x0.createRadialGradient(c.x+Math.sin(c.ph)*20,c.y,0,c.x,c.y,c.r*(1+beat*0.1));
    cg.addColorStop(0,rgba(pc(c.ci),alpha*(1+beat*0.3)));cg.addColorStop(1,'transparent');
    x0.fillStyle=cg;x0.fillRect(0,0,w,h);
  }

  // ‚îÄ‚îÄ Light shafts from above ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const sh of A.shafts){
    sh.ph+=sh.speed;
    const sx=sh.x+Math.sin(sh.ph)*25;
    const sg=x0.createLinearGradient(sx,0,sx+w*0.06,h*0.7);
    sg.addColorStop(0,rgba(pc(0),0.05*(1+beat*0.2)));sg.addColorStop(1,'transparent');
    x0.fillStyle=sg;
    x0.beginPath();x0.moveTo(sx-20,0);x0.lineTo(sx+30,0);x0.lineTo(sx+80,h*0.7);x0.lineTo(sx-40,h*0.7);x0.closePath();x0.fill();
  }

  // ‚îÄ‚îÄ Seafloor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const floorG=x0.createLinearGradient(0,floorY,0,h);
  floorG.addColorStop(0,`rgba(${Math.round(sc2.r*0.14)},${Math.round(sc2.g*0.12)},${Math.round(sc2.b*0.2)},0.9)`);
  floorG.addColorStop(1,'rgba(2,1,4,1)');
  x0.fillStyle=floorG;x0.fillRect(0,floorY,w,h-floorY);
  // Algae glow line
  x0.shadowBlur=20;x0.shadowColor=rgba(pc(2),0.6);
  x0.strokeStyle=rgba(pc(2),0.3*(1+beat*0.2));x0.lineWidth=2;
  x0.beginPath();x0.moveTo(0,floorY);x0.lineTo(w,floorY);x0.stroke();x0.shadowBlur=0;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PILLARS ‚Äî depth perspective layout per spec:
  //   Left side: one tall intact pillar (foreground)
  //   Right side: one broken pillar (foreground)
  //   Several smaller pillars further back for depth
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const pillars=[
    // Background pillars ‚Äî smaller, closer to center, more transparent
    {x:cx-w*0.18, depth:0.3, tall:h*0.28, broken:true,  ci:3},
    {x:cx+w*0.14, depth:0.3, tall:h*0.32, broken:false, ci:0},
    {x:cx-w*0.08, depth:0.2, tall:h*0.22, broken:true,  ci:1},
    {x:cx+w*0.06, depth:0.2, tall:h*0.18, broken:true,  ci:2},
    // Foreground pillars ‚Äî large, at edges
    {x:cx-w*0.42, depth:1.0, tall:h*0.72, broken:false, ci:2}, // LEFT: tall intact
    {x:cx+w*0.42, depth:1.0, tall:h*0.45, broken:true,  ci:0}, // RIGHT: broken
  ];

  // Sort by depth ‚Äî background first
  const sortedPillars=[...pillars].sort((a,b)=>a.depth-b.depth);

  for(const col of sortedPillars){
    const scale=0.4+col.depth*0.6;
    const colW=w*0.04*scale;
    const colH=col.tall*scale;
    const alpha=0.3+col.depth*0.7;
    const baseY=floorY;
    const topY=baseY-colH;

    x0.save();x0.globalAlpha=alpha;
    // Column shaft ‚Äî tapered
    x0.fillStyle=rgba(pc(col.ci),0.2*(1+beat*0.1));
    x0.beginPath();
    x0.moveTo(col.x-colW*0.6,baseY);
    x0.lineTo(col.x-colW*0.45,topY);
    x0.lineTo(col.x+colW*0.45,topY);
    x0.lineTo(col.x+colW*0.6,baseY);
    x0.closePath();x0.fill();

    // Glowing outline
    x0.strokeStyle=rgba(pc(col.ci),(0.45+beat*0.25)*(1+col.depth*0.3));
    x0.lineWidth=1.5+col.depth;
    x0.shadowBlur=(12+beat*8)*col.depth;x0.shadowColor=pc(col.ci);
    x0.stroke();

    // Fluting ‚Äî vertical grooves
    const numFlutes=Math.floor(3+col.depth*3);
    x0.strokeStyle=rgba(pc(col.ci),0.15*(1+beat*0.1));x0.lineWidth=1;
    for(let f=0;f<numFlutes;f++){
      const fx=col.x-colW*0.4+f*(colW*0.8/numFlutes);
      x0.beginPath();x0.moveTo(fx,baseY-5);x0.lineTo(fx,topY+colH*0.05);x0.stroke();
    }

    // Drum rings
    x0.strokeStyle=rgba(pc(col.ci),0.25);x0.lineWidth=1;
    const numDrums=Math.floor(3+col.depth*4);
    for(let dr=1;dr<numDrums;dr++){
      const dy=baseY-colH*dr/numDrums;
      const lerpW=lerp(colW*0.45,colW*0.6,1-dr/numDrums);
      x0.beginPath();x0.moveTo(col.x-lerpW,dy);x0.lineTo(col.x+lerpW,dy);x0.stroke();
    }

    // Capital (top) or jagged break
    if(!col.broken){
      // Ionic capital
      x0.fillStyle=rgba(pc(col.ci),0.25);
      const capW=colW*1.5,capH=colH*0.04;
      x0.fillRect(col.x-capW/2,topY-capH,capW,capH);
      x0.strokeStyle=rgba(pc(col.ci),0.5);x0.lineWidth=1.5;
      x0.strokeRect(col.x-capW/2,topY-capH,capW,capH);
      // Scroll volutes
      x0.beginPath();x0.arc(col.x-capW/2,topY-capH/2,capH*0.8,0,Math.PI*2);x0.stroke();
      x0.beginPath();x0.arc(col.x+capW/2,topY-capH/2,capH*0.8,0,Math.PI*2);x0.stroke();
    } else {
      // Jagged broken top with rubble
      x0.strokeStyle=rgba(pc(col.ci),0.45);x0.lineWidth=2;
      x0.beginPath();x0.moveTo(col.x-colW*0.45,topY);
      for(let jag=0;jag<6;jag++){
        x0.lineTo(col.x-colW*0.35+jag*(colW*0.15),topY+(jag%2===0?-colH*0.03:colH*0.015)*(1+Math.sin(jag)*0.5));
      }
      x0.lineTo(col.x+colW*0.45,topY);x0.stroke();
    }

    // Algae/moss patches
    x0.shadowBlur=8;x0.shadowColor=rgba(pc(2),0.4);
    for(let mg=0;mg<Math.floor(1+col.depth*3);mg++){
      const mgy=baseY-colH*(0.15+mg*0.25);
      x0.fillStyle=rgba(pc(2),0.1*(1+beat*0.1));
      x0.beginPath();x0.ellipse(col.x+(mg%2===0?1:-1)*colW*0.3,mgy,colW*0.5,colH*0.015,0,0,Math.PI*2);x0.fill();
    }

    // Cracks with neon glow seeping through
    if(col.broken||col.depth>0.5){
      x0.strokeStyle=rgba(pc((col.ci+1)%4),(0.3+beat*0.2)*col.depth);
      x0.lineWidth=1;x0.shadowBlur=10+beat*6;x0.shadowColor=pc((col.ci+1)%4);
      for(let cr=0;cr<Math.floor(1+col.depth*2);cr++){
        const cry=baseY-colH*(0.2+cr*0.3);
        x0.beginPath();
        x0.moveTo(col.x-colW*0.3,cry);
        x0.lineTo(col.x-colW*0.05,cry-colH*0.04);
        x0.lineTo(col.x+colW*0.15,cry+colH*0.01);
        x0.lineTo(col.x+colW*0.3,cry-colH*0.02);
        x0.stroke();
      }
    }

    x0.shadowBlur=0;x0.globalAlpha=1;x0.restore();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // POSEIDON HEAD ‚Äî very large, centered, intimidating
  // Detailed stone outline with neon glow through cracks
  // Roughly half the screen, resting on sea floor
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const P=A.poseidon;
  P.jawAngle+=(beat>0.5?P.jawDir*0.02:0);P.jawAngle*=0.95;
  P.eyeGlow=lerp(P.eyeGlow,beat,0.12);
  const pSz=Math.min(w*0.42,h*0.42);
  const px=cx,py=floorY+pSz*0.05; // base resting on floor

  x0.save();x0.translate(px,py);

  // === Cracks with neon glow bleeding through (behind head outline) ===
  const crackGlow=(0.4+beat*0.3);
  x0.strokeStyle=rgba(pc(1),crackGlow);x0.lineWidth=1.5;
  x0.shadowBlur=14+beat*10;x0.shadowColor=pc(1);
  // Major crack lines across face
  const cracks=[
    [{x:-pSz*0.12,y:-pSz*0.9},{x:-pSz*0.2,y:-pSz*0.7},{x:-pSz*0.15,y:-pSz*0.5},{x:-pSz*0.25,y:-pSz*0.3}],
    [{x:pSz*0.2,y:-pSz*0.85},{x:pSz*0.28,y:-pSz*0.65},{x:pSz*0.22,y:-pSz*0.45},{x:pSz*0.35,y:-pSz*0.2}],
    [{x:-pSz*0.3,y:-pSz*0.55},{x:-pSz*0.15,y:-pSz*0.48},{x:0,y:-pSz*0.42},{x:pSz*0.1,y:-pSz*0.5}],
    [{x:pSz*0.05,y:-pSz*0.3},{x:pSz*0.15,y:-pSz*0.15},{x:pSz*0.08,y:0}],
    [{x:-pSz*0.35,y:-pSz*0.35},{x:-pSz*0.42,y:-pSz*0.18},{x:-pSz*0.38,y:0}],
  ];
  for(const crack of cracks){
    x0.beginPath();x0.moveTo(crack[0].x,crack[0].y);
    for(let i=1;i<crack.length;i++)x0.lineTo(crack[i].x,crack[i].y);
    x0.stroke();
    // Smaller branch cracks
    for(let i=0;i<crack.length-1;i++){
      if(Math.random()<0.6){
        x0.beginPath();x0.moveTo(crack[i].x,crack[i].y);
        x0.lineTo(crack[i].x+(Math.random()-0.5)*pSz*0.12,crack[i].y+(Math.random()-0.5)*pSz*0.08);
        x0.stroke();
      }
    }
  }

  // === Head outline ‚Äî massive stone face ===
  x0.strokeStyle=rgba(pc(2),(0.7+beat*0.2));x0.lineWidth=3.5;
  x0.shadowBlur=25+beat*15;x0.shadowColor=rgba(pc(2),0.8);

  // Cranium/skull shape ‚Äî wide, powerful
  x0.beginPath();
  x0.moveTo(-pSz*0.42,0); // chin left
  x0.lineTo(-pSz*0.44,-pSz*0.08); // jawline left
  x0.bezierCurveTo(-pSz*0.48,-pSz*0.2,-pSz*0.5,-pSz*0.35,-pSz*0.48,-pSz*0.5); // left cheek
  x0.bezierCurveTo(-pSz*0.46,-pSz*0.62,-pSz*0.44,-pSz*0.72,-pSz*0.38,-pSz*0.8); // left temple
  x0.bezierCurveTo(-pSz*0.3,-pSz*0.92,-pSz*0.15,-pSz*1.0,0,-pSz*1.02); // top of head
  x0.bezierCurveTo(pSz*0.15,-pSz*1.0,pSz*0.3,-pSz*0.92,pSz*0.38,-pSz*0.8); // right temple
  x0.bezierCurveTo(pSz*0.44,-pSz*0.72,pSz*0.46,-pSz*0.62,pSz*0.48,-pSz*0.5); // right cheek
  x0.bezierCurveTo(pSz*0.5,-pSz*0.35,pSz*0.48,-pSz*0.2,pSz*0.44,-pSz*0.08); // right jaw
  x0.lineTo(pSz*0.42,0); // chin right
  x0.stroke();

  // Chin/jaw strong squared shape
  x0.beginPath();
  x0.moveTo(-pSz*0.42,0);
  x0.bezierCurveTo(-pSz*0.3,pSz*0.06,-pSz*0.1,pSz*0.08,0,pSz*0.08);
  x0.bezierCurveTo(pSz*0.1,pSz*0.08,pSz*0.3,pSz*0.06,pSz*0.42,0);
  x0.stroke();

  // Brow ridge ‚Äî heavy, stern
  x0.lineWidth=4;
  x0.beginPath();
  x0.moveTo(-pSz*0.42,-pSz*0.52);
  x0.bezierCurveTo(-pSz*0.3,-pSz*0.58,-pSz*0.15,-pSz*0.6,-pSz*0.05,-pSz*0.55);
  x0.stroke();
  x0.beginPath();
  x0.moveTo(pSz*0.42,-pSz*0.52);
  x0.bezierCurveTo(pSz*0.3,-pSz*0.58,pSz*0.15,-pSz*0.6,pSz*0.05,-pSz*0.55);
  x0.stroke();

  // Furrowed brow lines between eyes
  x0.lineWidth=2;x0.strokeStyle=rgba(pc(2),(0.5+beat*0.15));
  x0.beginPath();x0.moveTo(-pSz*0.05,-pSz*0.62);x0.lineTo(-pSz*0.02,-pSz*0.55);x0.stroke();
  x0.beginPath();x0.moveTo(pSz*0.05,-pSz*0.62);x0.lineTo(pSz*0.02,-pSz*0.55);x0.stroke();

  // === Eye sockets ‚Äî deep, angular, intimidating ===
  x0.lineWidth=3;x0.strokeStyle=rgba(pc(0),(0.7+beat*0.2));
  x0.shadowBlur=20+beat*12;x0.shadowColor=rgba(pc(0),0.7);
  // Left eye socket
  x0.beginPath();
  x0.moveTo(-pSz*0.32,-pSz*0.55);
  x0.lineTo(-pSz*0.28,-pSz*0.62);
  x0.lineTo(-pSz*0.12,-pSz*0.62);
  x0.lineTo(-pSz*0.08,-pSz*0.55);
  x0.lineTo(-pSz*0.12,-pSz*0.48);
  x0.lineTo(-pSz*0.28,-pSz*0.48);
  x0.closePath();x0.stroke();
  // Dark socket interior
  x0.fillStyle='rgba(0,0,0,0.6)';x0.fill();
  // Right eye socket
  x0.beginPath();
  x0.moveTo(pSz*0.32,-pSz*0.55);
  x0.lineTo(pSz*0.28,-pSz*0.62);
  x0.lineTo(pSz*0.12,-pSz*0.62);
  x0.lineTo(pSz*0.08,-pSz*0.55);
  x0.lineTo(pSz*0.12,-pSz*0.48);
  x0.lineTo(pSz*0.28,-pSz*0.48);
  x0.closePath();x0.stroke();
  x0.fillStyle='rgba(0,0,0,0.6)';x0.fill();

  // === CENTERPIECE IN EYE SOCKETS ===
  if(THEME.centerpiece){
    cpRot+=0.014*(1+beat*0.3);cpPh+=0.013;
    const eyeSz=pSz*0.08*(1+P.eyeGlow*0.5);
    x0.shadowBlur=20+P.eyeGlow*25;x0.shadowColor=rgba(pc(0),0.95);
    drawCPMini(x0,THEME.centerpiece,-pSz*0.2,-pSz*0.55,eyeSz,cpRot);
    drawCPMini(x0,THEME.centerpiece,pSz*0.2,-pSz*0.55,eyeSz,-cpRot);
    // Eye glow halo
    const eyeHalo=x0.createRadialGradient(-pSz*0.2,-pSz*0.55,0,-pSz*0.2,-pSz*0.55,eyeSz*3);
    eyeHalo.addColorStop(0,rgba(pc(0),(0.2+P.eyeGlow*0.3)));eyeHalo.addColorStop(1,'transparent');
    x0.fillStyle=eyeHalo;x0.fillRect(-pSz*0.5,-pSz*0.8,pSz,pSz*0.5);
    const eyeHalo2=x0.createRadialGradient(pSz*0.2,-pSz*0.55,0,pSz*0.2,-pSz*0.55,eyeSz*3);
    eyeHalo2.addColorStop(0,rgba(pc(0),(0.2+P.eyeGlow*0.3)));eyeHalo2.addColorStop(1,'transparent');
    x0.fillStyle=eyeHalo2;x0.fillRect(-pSz*0.5,-pSz*0.8,pSz,pSz*0.5);
  }
  x0.shadowBlur=0;

  // === Nose ‚Äî strong, angular, broken stone ===
  x0.strokeStyle=rgba(pc(2),(0.6+beat*0.15));x0.lineWidth=2.5;
  x0.shadowBlur=12;x0.shadowColor=pc(2);
  x0.beginPath();
  x0.moveTo(0,-pSz*0.5);
  x0.lineTo(-pSz*0.04,-pSz*0.42);
  x0.lineTo(-pSz*0.06,-pSz*0.32);
  x0.lineTo(-pSz*0.08,-pSz*0.25);
  x0.stroke();
  x0.beginPath();
  x0.moveTo(0,-pSz*0.5);
  x0.lineTo(pSz*0.04,-pSz*0.42);
  x0.lineTo(pSz*0.02,-pSz*0.32);
  x0.lineTo(pSz*0.04,-pSz*0.25);
  x0.stroke();
  // Nostrils
  x0.beginPath();x0.arc(-pSz*0.05,-pSz*0.24,pSz*0.025,0,Math.PI*2);x0.stroke();
  x0.beginPath();x0.arc(pSz*0.02,-pSz*0.24,pSz*0.025,0,Math.PI*2);x0.stroke();

  // === Cheekbone definition ===
  x0.strokeStyle=rgba(pc(2),(0.35+beat*0.1));x0.lineWidth=2;
  x0.beginPath();x0.moveTo(-pSz*0.38,-pSz*0.42);x0.bezierCurveTo(-pSz*0.32,-pSz*0.35,-pSz*0.2,-pSz*0.3,-pSz*0.12,-pSz*0.28);x0.stroke();
  x0.beginPath();x0.moveTo(pSz*0.38,-pSz*0.42);x0.bezierCurveTo(pSz*0.32,-pSz*0.35,pSz*0.2,-pSz*0.3,pSz*0.12,-pSz*0.28);x0.stroke();

  // === Mouth ‚Äî stern, slightly open on beat ===
  x0.strokeStyle=rgba(pc(0),(0.6+beat*0.2));x0.lineWidth=3;
  x0.shadowBlur=12+beat*8;x0.shadowColor=pc(0);
  const jawOpen=P.jawAngle*pSz*0.3;
  // Upper lip
  x0.beginPath();
  x0.moveTo(-pSz*0.22,-pSz*0.12);
  x0.bezierCurveTo(-pSz*0.1,-pSz*0.08,pSz*0.1,-pSz*0.08,pSz*0.22,-pSz*0.12);
  x0.stroke();
  // Lower lip
  x0.beginPath();
  x0.moveTo(-pSz*0.2,-pSz*0.08+jawOpen);
  x0.bezierCurveTo(-pSz*0.08,-pSz*0.04+jawOpen,pSz*0.08,-pSz*0.04+jawOpen,pSz*0.2,-pSz*0.08+jawOpen);
  x0.stroke();
  // Teeth hints when open
  if(jawOpen>2){
    x0.strokeStyle=rgba(pc(2),(0.3+beat*0.15));x0.lineWidth=1.5;
    for(let tk=-3;tk<=3;tk++){
      const tx=tk*pSz*0.04;
      x0.beginPath();x0.moveTo(tx,-pSz*0.1);x0.lineTo(tx,-pSz*0.08+jawOpen*0.4);x0.stroke();
    }
  }

  // === Beard ‚Äî long flowing strands like stone turned seaweed ===
  x0.strokeStyle=rgba(pc(3),(0.45+beat*0.15));x0.lineWidth=2.5;
  x0.shadowBlur=10;x0.shadowColor=rgba(pc(3),0.4);
  for(let b=0;b<9;b++){
    const bx=-pSz*0.28+b*(pSz*0.07);
    const sway=Math.sin(t*0.0015+b*0.7)*pSz*0.05;
    const bLen=pSz*(0.35+b*0.02+Math.sin(b*1.2)*0.05);
    x0.beginPath();x0.moveTo(bx,pSz*0.04);
    x0.bezierCurveTo(bx+sway,pSz*0.04+bLen*0.3,bx-sway*1.2,pSz*0.04+bLen*0.6,bx+sway*1.5,pSz*0.04+bLen);
    x0.stroke();
  }

  // === Crown/trident ornament on head ===
  x0.strokeStyle=rgba(pc(1),(0.6+beat*0.3));x0.lineWidth=3;
  x0.shadowBlur=18+beat*12;x0.shadowColor=rgba(pc(1),0.8);
  // Central trident
  for(let p=0;p<5;p++){
    const pxOff=-pSz*0.16+p*pSz*0.08;
    const pHeight=pSz*(p===2?0.22:(p===1||p===3)?0.16:0.1);
    x0.beginPath();x0.moveTo(pxOff,-pSz*0.95);
    x0.lineTo(pxOff+Math.sin(t*0.002+p)*2,-pSz*0.95-pHeight);x0.stroke();
    // Prong tips glow
    x0.fillStyle=rgba(pc(1),(0.8+beat*0.2));
    x0.beginPath();x0.arc(pxOff,-pSz*0.95-pHeight,3+beat*2,0,Math.PI*2);x0.fill();
  }
  // Crown band
  x0.strokeStyle=rgba(pc(1),(0.5+beat*0.2));x0.lineWidth=2;
  x0.beginPath();
  x0.moveTo(-pSz*0.32,-pSz*0.88);
  x0.bezierCurveTo(-pSz*0.15,-pSz*0.93,pSz*0.15,-pSz*0.93,pSz*0.32,-pSz*0.88);
  x0.stroke();

  // === Missing chunk ‚Äî broken piece missing from upper right ===
  x0.strokeStyle=rgba(pc(2),(0.5+beat*0.15));x0.lineWidth=2.5;
  x0.beginPath();
  x0.moveTo(pSz*0.25,-pSz*0.88);
  x0.lineTo(pSz*0.32,-pSz*0.82);
  x0.lineTo(pSz*0.28,-pSz*0.76);
  x0.lineTo(pSz*0.35,-pSz*0.7);
  x0.stroke();

  // === Wrinkle/detail lines for age ===
  x0.strokeStyle=rgba(pc(2),(0.2+beat*0.08));x0.lineWidth=1;
  // Forehead wrinkles
  for(let wr=0;wr<3;wr++){
    const wry=-pSz*(0.72+wr*0.06);
    x0.beginPath();x0.moveTo(-pSz*0.2,wry);x0.bezierCurveTo(-pSz*0.05,wry-pSz*0.015,pSz*0.05,wry-pSz*0.015,pSz*0.2,wry);x0.stroke();
  }
  // Nasolabial folds
  x0.strokeStyle=rgba(pc(2),(0.25+beat*0.1));x0.lineWidth=1.5;
  x0.beginPath();x0.moveTo(-pSz*0.15,-pSz*0.3);x0.bezierCurveTo(-pSz*0.18,-pSz*0.2,-pSz*0.2,-pSz*0.12,-pSz*0.18,-pSz*0.05);x0.stroke();
  x0.beginPath();x0.moveTo(pSz*0.11,-pSz*0.3);x0.bezierCurveTo(pSz*0.14,-pSz*0.2,pSz*0.16,-pSz*0.12,pSz*0.14,-pSz*0.05);x0.stroke();

  x0.shadowBlur=0;x0.restore();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DESTRUCTION DEBRIS (from kraken surprise)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  for(let i=A.debris.length-1;i>=0;i--){
    const d=A.debris[i];
    d.x+=d.vx;d.y+=d.vy;d.vy+=0.04;d.vx*=0.99;
    d.life-=0.004;d.rot+=d.rotS;
    if(d.life<=0){A.debris.splice(i,1);continue;}
    x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);x0.globalAlpha=Math.min(1,d.life*2);
    x0.fillStyle=rgba(pc(d.ci),0.7);x0.shadowBlur=4;x0.shadowColor=pc(d.ci);
    x0.fillRect(-d.sz/2,-d.sz/2,d.sz,d.sz);x0.shadowBlur=0;x0.restore();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // KRAKEN SURPRISE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(A.kraken){
    const K=A.kraken;
    K.age+=16;K.alpha=Math.min(0.9,K.alpha+0.012);
    if(K.retreating)K.alpha=Math.max(0,K.alpha-0.008);
    if(K.alpha<=0&&K.retreating){A.kraken=null;}

    // Eye ‚Äî massive, above ruins
    if(!K.retreating){
      x0.save();x0.globalAlpha=K.alpha*0.8;
      x0.shadowBlur=40;x0.shadowColor=rgba(pc(0),0.9);
      x0.fillStyle=rgba(pc(0),0.6);
      x0.beginPath();x0.ellipse(K.eyeX,K.eyeY,K.eyeR*1.4,K.eyeR,0,0,Math.PI*2);x0.fill();
      x0.fillStyle='rgba(0,0,0,0.9)';
      x0.beginPath();x0.ellipse(K.eyeX,K.eyeY,K.eyeR*0.6,K.eyeR*0.5,0,0,Math.PI*2);x0.fill();
      x0.fillStyle='rgba(255,255,255,0.7)';
      x0.beginPath();x0.arc(K.eyeX-K.eyeR*0.3,K.eyeY-K.eyeR*0.2,K.eyeR*0.18,0,Math.PI*2);x0.fill();
      x0.shadowBlur=0;x0.restore();
    }

    // Tentacles
    for(const ten of K.tentacles){
      ten.ph+=0.018*(1+beat*0.4);
      const grabProgress=Math.min(1,K.age/2000);
      x0.save();x0.globalAlpha=K.alpha*0.85;
      x0.strokeStyle=rgba(pc(ten.ci),0.75);
      x0.shadowBlur=18;x0.shadowColor=rgba(pc(ten.ci),0.6);
      x0.lineWidth=ten.thickness*(1+beat*0.1);x0.lineCap='round';
      const startX=ten.originX,startY=ten.originY;
      const midX=ten.midX+Math.sin(ten.ph)*20;
      const midY=ten.midY+Math.cos(ten.ph*0.7)*15;
      const endX=ten.targetX+Math.sin(ten.ph*1.3)*8*(1-grabProgress);
      const endY=ten.targetY+Math.cos(ten.ph*0.9)*6*(1-grabProgress);
      x0.beginPath();x0.moveTo(startX,startY);
      x0.bezierCurveTo(midX,midY,midX+20,endY-30,endX,endY);x0.stroke();
      // Sucker dots
      x0.lineWidth=1;x0.shadowBlur=4;
      for(let sk=0;sk<5;sk++){
        const frac=(sk+1)/6;
        const skX=startX+(midX-startX)*frac+(endX-midX)*frac;
        const skY=startY+(midY-startY)*frac+(endY-midY)*frac;
        x0.strokeStyle=rgba(pc((ten.ci+1)%4),0.5);
        x0.beginPath();x0.arc(skX+Math.sin(ten.ph+sk)*5,skY,4,0,Math.PI*2);x0.stroke();
      }
      x0.lineCap='butt';x0.shadowBlur=0;x0.restore();
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // WHIRLPOOL SURPRISE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(A.whirlpool){
    const WP=A.whirlpool;
    WP.rot+=WP.speed*(1+beat*0.4);
    WP.alpha=Math.min(0.85,WP.alpha+0.015);
    WP.radius=Math.min(WP.maxR,WP.radius+WP.growSpeed);
    if(WP.fading)WP.alpha=Math.max(0,WP.alpha-0.01);
    if(WP.alpha<=0&&WP.fading){A.whirlpool=null;}

    for(let ring=0;ring<8;ring++){
      const rFrac=ring/7;
      const rR=WP.radius*(1-rFrac*0.85);
      const rAlpha=WP.alpha*(1-rFrac*0.6);
      x0.strokeStyle=rgba(pc(ring%4),rAlpha);
      x0.lineWidth=2-rFrac*1.5;
      x0.shadowBlur=10*(1-rFrac)+beat*5;x0.shadowColor=pc(ring%4);
      x0.beginPath();
      const startA=WP.rot+ring*0.7;
      x0.arc(WP.x,WP.y,Math.max(2,rR),startA,startA+Math.PI*1.6);
      x0.stroke();
    }
    const vg=x0.createRadialGradient(WP.x,WP.y,0,WP.x,WP.y,WP.radius*0.3);
    vg.addColorStop(0,'rgba(0,0,0,'+WP.alpha*0.9+')');vg.addColorStop(1,'transparent');
    x0.fillStyle=vg;x0.fillRect(0,0,w,h);
    // Suck fish toward whirlpool
    for(const f of [...A.anglerfish,...A.mantas,...A.eels]){
      if(WP.alpha>0.4){
        const dx=WP.x-f.x,dy=WP.y-f.y,dist=Math.hypot(dx,dy)||1;
        if(dist<WP.radius*1.5){f.x+=dx/dist*1.5*WP.alpha;f.y+=dy/dist*1.5*WP.alpha;}
      }
    }
    x0.shadowBlur=0;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SEA CREATURES ‚Äî gliding, majestic, slightly larger
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Eels ‚Äî weave through ruins with segmented body
  for(const eel of A.eels){
    eel.ph+=eel.phSpeed*(1+beat*0.2);
    eel.x+=eel.vx*(1+energy*0.15);
    if(eel.x<-eel.sz)eel.x=w+eel.sz;
    if(eel.x>w+eel.sz)eel.x=-eel.sz;
    x0.save();x0.shadowBlur=14;x0.shadowColor=rgba(pc(eel.ci),0.7);
    x0.strokeStyle=rgba(pc(eel.ci),0.65);x0.lineWidth=6+beat*2;x0.lineCap='round';
    x0.beginPath();
    for(let seg=0;seg<eel.segments;seg++){
      const sx=eel.x-eel.vx*seg*(eel.sz/eel.segments);
      const sy=eel.y+Math.sin(eel.ph+seg*0.45)*20*(1+beat*0.2);
      seg===0?x0.moveTo(sx,sy):x0.lineTo(sx,sy);
    }
    x0.stroke();
    // Head with eye
    x0.fillStyle=rgba(pc(eel.ci),0.8);x0.beginPath();x0.ellipse(eel.x,eel.y,12+beat*2,8,eel.vx>0?0:Math.PI,0,Math.PI*2);x0.fill();
    x0.fillStyle='rgba(255,255,100,0.9)';x0.shadowBlur=10;x0.shadowColor='rgba(255,255,0,1)';
    x0.beginPath();x0.arc(eel.x+(eel.vx>0?6:-6),eel.y-1,3.5*(1+beat*0.3),0,Math.PI*2);x0.fill();
    x0.lineCap='butt';x0.shadowBlur=0;x0.restore();
  }

  // Anglerfish ‚Äî lurk mid-water
  for(const af of A.anglerfish){
    af.ph+=0.015*(1+beat*0.2);af.mouthPh+=0.03;af.lurePh+=0.04+Math.random()*0.01;
    af.x+=af.vx*(1+energy*0.1);
    if(af.x<-100)af.x=w+100;if(af.x>w+100)af.x=-100;
    const dir=af.vx>0?1:-1;
    x0.save();x0.translate(af.x,af.y+Math.sin(af.ph)*6);
    x0.scale(dir,1);x0.shadowBlur=18;x0.shadowColor=rgba(pc(af.ci),0.7);
    // Body
    x0.fillStyle=rgba(pc(af.ci),0.5);
    x0.beginPath();x0.ellipse(0,0,af.sz,af.sz*0.65,0,0,Math.PI*2);x0.fill();
    // Mouth
    const mA=0.2+Math.sin(af.mouthPh)*0.1;
    x0.fillStyle=rgba(pc(af.ci),0.7);
    x0.beginPath();x0.moveTo(af.sz*0.85,0);
    x0.lineTo(af.sz*0.4,-mA*af.sz*0.6);x0.lineTo(af.sz*0.4,mA*af.sz*0.6);x0.closePath();x0.fill();
    // Teeth
    x0.strokeStyle='rgba(220,220,180,0.8)';x0.lineWidth=1.5;
    for(let tk=0;tk<5;tk++){
      const tx=af.sz*(0.48+tk*0.08),ty=mA*af.sz*(0.12+tk*0.1);
      x0.beginPath();x0.moveTo(tx,-ty);x0.lineTo(tx+4,-ty-9*(1-tk*0.1));x0.moveTo(tx,ty);x0.lineTo(tx+4,ty+7*(1-tk*0.1));x0.stroke();
    }
    // Eye
    x0.fillStyle='rgba(255,200,50,0.9)';x0.shadowBlur=14;x0.shadowColor='rgba(255,200,0,1)';
    x0.beginPath();x0.arc(af.sz*0.25,-af.sz*0.2,af.sz*0.16*(1+beat*0.15),0,Math.PI*2);x0.fill();
    x0.fillStyle='rgba(0,0,0,0.8)';x0.shadowBlur=0;
    x0.beginPath();x0.arc(af.sz*0.27,-af.sz*0.2,af.sz*0.08,0,Math.PI*2);x0.fill();
    // Lure
    const lureRodX=-af.sz*0.2,lureRodY=-af.sz*0.75;
    const lureX=lureRodX+Math.sin(af.lurePh)*12,lureY=lureRodY+Math.cos(af.lurePh*0.7)*8;
    x0.strokeStyle=rgba(pc((af.ci+1)%4),0.5);x0.lineWidth=1.5;
    x0.beginPath();x0.moveTo(-af.sz*0.1,-af.sz*0.5);x0.lineTo(lureX,lureY);x0.stroke();
    x0.fillStyle=rgba(pc((af.ci+1)%4),0.95);x0.shadowBlur=22+Math.sin(af.lurePh)*8;x0.shadowColor=pc((af.ci+1)%4);
    x0.beginPath();x0.arc(lureX,lureY,5+beat*3,0,Math.PI*2);x0.fill();
    x0.shadowBlur=0;x0.restore();
  }

  // Manta rays ‚Äî glide overhead
  for(const mr of A.mantas){
    mr.ph+=0.006*(1+beat*0.15);mr.waveAmp+=(beat*0.12-mr.waveAmp)*0.08;
    mr.x+=mr.vx*(1+energy*0.15);
    if(mr.x<-mr.sz*2)mr.x=w+mr.sz*2;if(mr.x>w+mr.sz*2)mr.x=-mr.sz*2;
    const dir=mr.vx>0?1:-1;
    const wingFlap=Math.sin(mr.ph)*mr.sz*(0.12+mr.waveAmp*0.25);
    x0.save();x0.translate(mr.x,mr.y+Math.sin(mr.ph*0.4)*10);x0.scale(dir,1);
    x0.shadowBlur=22;x0.shadowColor=rgba(pc(mr.ci),0.55);
    // Body
    x0.fillStyle=rgba(pc(mr.ci),0.4);
    x0.beginPath();
    x0.moveTo(0,-mr.sz*0.12);
    x0.bezierCurveTo(mr.sz*0.3,-mr.sz*0.08,mr.sz*0.55,wingFlap*0.5,mr.sz*0.65,wingFlap);
    x0.bezierCurveTo(mr.sz*0.3,wingFlap*0.8,0,mr.sz*0.15,0,mr.sz*0.15);
    x0.bezierCurveTo(0,mr.sz*0.15,-mr.sz*0.3,wingFlap*0.8,-mr.sz*0.65,wingFlap);
    x0.bezierCurveTo(-mr.sz*0.55,wingFlap*0.5,-mr.sz*0.3,-mr.sz*0.08,0,-mr.sz*0.12);
    x0.closePath();x0.fill();
    // Outline
    x0.strokeStyle=rgba(pc(mr.ci),0.65);x0.lineWidth=1.5;x0.stroke();
    // Belly dots
    x0.fillStyle=rgba(pc((mr.ci+2)%4),0.3);
    for(let dp=0;dp<5;dp++){x0.beginPath();x0.arc((dp-2)*mr.sz*0.08,mr.sz*0.04,mr.sz*0.035,0,Math.PI*2);x0.fill();}
    // Tail
    x0.strokeStyle=rgba(pc(mr.ci),0.5);x0.lineWidth=3;
    x0.beginPath();x0.moveTo(-mr.sz*0.08,mr.sz*0.12);x0.bezierCurveTo(-mr.sz*0.1,mr.sz*0.3,-mr.sz*0.05,mr.sz*0.5,mr.sz*0.05,mr.sz*0.6);x0.stroke();
    x0.shadowBlur=0;x0.restore();
  }

  // ‚îÄ‚îÄ Bubbles ‚Äî natural fade at top ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(let bi=A.bubbles.length-1;bi>=0;bi--){
    const b=A.bubbles[bi];
    b.y+=b.vy*(A.bubbleStorm?4:1);b.x+=b.vx+Math.sin(b.ph+t*0.001)*0.3;b.ph+=0.03;
    const fadeZone=h*0.08;
    let fadeAlpha=1;
    if(b.y<fadeZone)fadeAlpha=Math.max(0,b.y/fadeZone);
    if(b.y<-10||fadeAlpha<=0){
      if(A.bubbleStorm&&A.bubbles.length>35){A.bubbles.splice(bi,1);continue;}
      b.y=h+10+Math.random()*20;b.x=Math.random()*w;continue;
    }
    if(A.bubbleStorm){
      x0.shadowBlur=15;x0.shadowColor=rgba(pc(b.ci),0.8);
      x0.strokeStyle=rgba(pc(b.ci),0.85*fadeAlpha);x0.lineWidth=2;
      x0.beginPath();x0.arc(b.x,b.y,b.r*2.5*(1+beat*0.2),0,Math.PI*2);x0.stroke();
      x0.fillStyle=rgba(pc(b.ci),0.15*fadeAlpha);x0.fill();x0.shadowBlur=0;
    } else {
      x0.strokeStyle=rgba(pc(b.ci),(0.3+beat*0.1)*fadeAlpha);x0.lineWidth=1;
      x0.beginPath();x0.arc(b.x,b.y,b.r,0,Math.PI*2);x0.stroke();
      x0.fillStyle=rgba(pc(b.ci),0.05*fadeAlpha);x0.fill();
    }
  }
}


// ‚ïê‚ïê‚ïê SCENE: carnival ‚ïê‚ïê‚ïê

function drawCarnival(t){
  const w=W(),h=H(),cx=w/2;
  const beat=SM.beatPulse,energy=SM.energy;

  if(!SD.carnival){
    SD.carnival={
      ferrisRot:0,
      fireworks:Array.from({length:18},(_,i)=>({
        x:Math.random()*w,y:Math.random()*h*0.55,
        vx:(Math.random()-0.5)*1.2,vy:-(Math.random()*2+1),
        ci:i%4,phase:'rising',trailLen:12,
        particles:[],burstR:0,burstLife:0,
      })),
      tents:Array.from({length:14},(_,i)=>{
        const numStripes=5+Math.floor(Math.random()*4);
        const isSquare=Math.random()>0.5; // mix peaked and squared
        return{
          x:i/13*w*1.08-w*0.04,
          w:w*0.08+Math.random()*w*0.05,
          h:h*(0.15+Math.random()*0.12),
          ci:i%4,ci2:(i+2)%4,numStripes,
          flag:Math.random()>0.5,
          flagPh:Math.random()*Math.PI*2,
          isSquare,
        };
      }),
      confetti:Array.from({length:80},()=>({
        x:Math.random()*w,y:Math.random()*h,
        vx:(Math.random()-0.5)*1.5,vy:Math.random()*1.2+0.4,
        rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.1,
        sz:4+Math.random()*8,ci:Math.floor(Math.random()*4),
      })),
      clown:null,
      clownAlpha:0,
      superFW:false,
      superFWTimer:0,
      hyperWheel:false,
      hyperWheelTimer:0,
    };
  }
  const C=SD.carnival;

  // BG ‚Äî dark night sky gradient
  const sky=x0.createLinearGradient(0,0,0,h);
  sky.addColorStop(0,'rgba(2,0,10,1)');
  sky.addColorStop(0.6,'rgba(8,0,22,1)');
  sky.addColorStop(1,'rgba(15,5,35,0.9)');
  x0.fillStyle=sky;x0.fillRect(0,0,w,h);

  // Ground ‚Äî lower strip at actual bottom
  x0.fillStyle='rgba(8,5,15,1)';x0.fillRect(0,h*0.82,w,h*0.18);

  // ‚îÄ‚îÄ FIREWORKS BG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const superFW = C.superFW;
  const fwCount = superFW ? 32 : 18;
  // Ensure enough fireworks
  while(C.fireworks.length<fwCount){
    C.fireworks.push({x:Math.random()*w,y:Math.random()*h*(superFW?0.75:0.55),vx:(Math.random()-0.5)*(superFW?2.5:1.5),vy:-(Math.random()*3+1.5),ci:Math.floor(Math.random()*4),phase:'rising',trailLen:superFW?18:12,particles:[],burstR:0,burstLife:0});
  }
  if(C.superFWTimer>0){C.superFWTimer-=16;if(C.superFWTimer<=0)C.superFW=false;}

  for(const fw of C.fireworks){
    if(fw.phase==='rising'){
      fw.x+=fw.vx;fw.y+=fw.vy;
      // Trail
      x0.strokeStyle=rgba(pc(fw.ci),0.4);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(fw.x,fw.y);x0.lineTo(fw.x-fw.vx*fw.trailLen,fw.y-fw.vy*fw.trailLen);x0.stroke();
      x0.fillStyle=rgba(pc(fw.ci),0.9+beat*0.1);x0.shadowBlur=superFW?12:6;x0.shadowColor=pc(fw.ci);
      x0.beginPath();x0.arc(fw.x,fw.y,superFW?3:2,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
      if(fw.y<h*(superFW?0.08:0.12)+Math.random()*h*0.15||Math.random()<0.008){
        fw.phase='burst';
        const numP=superFW?80:50;
        fw.particles=Array.from({length:numP},(_,i)=>{
          const a=i/numP*Math.PI*2;
          const spd=superFW?(Math.random()*7+3):(Math.random()*5+2);
          return{x:fw.x,y:fw.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:1,ci:fw.ci,ci2:(fw.ci+(Math.floor(Math.random()*3)+1))%4,r:superFW?(3+Math.random()*3):(2.5+Math.random()*2.5)};
        });
        // Add secondary ring for super
        if(superFW){
          const numP2=40;
          for(let i=0;i<numP2;i++){
            const a=i/numP2*Math.PI*2;
            const spd=Math.random()*3+1;
            fw.particles.push({x:fw.x,y:fw.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:1,ci:(fw.ci+2)%4,ci2:(fw.ci+3)%4,r:1.5});
          }
        }
      }
    } else {
      // Burst particles
      let alive=false;
      for(const p of fw.particles){
        p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.vx*=0.98;p.vy*=0.98;p.life-=superFW?0.01:0.014;
        if(p.life<=0)continue;
        alive=true;
        x0.fillStyle=rgba(pc(p.life>0.5?p.ci:p.ci2),p.life*0.95);
        x0.shadowBlur=superFW?(12+beat*10):(8+beat*6);x0.shadowColor=pc(p.ci);
        x0.beginPath();x0.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
      }
      if(!alive){
        fw.phase='rising';fw.y=h+20;fw.x=Math.random()*w;
        fw.vx=(Math.random()-0.5)*(superFW?2.5:1.5);fw.vy=-(Math.random()*(superFW?4:3)+2);
        fw.ci=Math.floor(Math.random()*4);fw.particles=[];
      }
    }
  }

  // ‚îÄ‚îÄ FERRIS WHEEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const hyperWheel = C.hyperWheel;
  if(C.hyperWheelTimer>0){C.hyperWheelTimer-=16;if(C.hyperWheelTimer<=0)C.hyperWheel=false;}
  const wheelSpeed = hyperWheel?(0.04+energy*0.04+beat*0.06):(0.006+energy*0.004+beat*0.015);
  C.ferrisRot+=wheelSpeed;
  const ferrisR=Math.min(w,h)*(0.31+beat*0.008);
  const ferrisCX=cx, ferrisCY=h*0.44;

  x0.save();x0.translate(ferrisCX,ferrisCY);x0.rotate(C.ferrisRot);

  // Outer rim ‚Äî thick, glowing
  x0.strokeStyle=rgba(pc(0),0.8+beat*0.2);x0.lineWidth=6;
  x0.shadowBlur=hyperWheel?20:10;x0.shadowColor=pc(0);
  x0.beginPath();x0.arc(0,0,ferrisR,0,Math.PI*2);x0.stroke();

  // Hub inner ring
  const innerR = ferrisR*0.28;
  x0.beginPath();x0.arc(0,0,innerR,0,Math.PI*2);
  x0.strokeStyle=rgba(pc(1),0.9);x0.lineWidth=4;x0.shadowColor=pc(1);x0.shadowBlur=hyperWheel?24:12;x0.stroke();
  // Inner hub fill ‚Äî elaborate on hyperWheel
  if(hyperWheel){
    x0.fillStyle=rgba(pc(beat>0.5?0:2),0.3+beat*0.4);x0.fill();
    // Inner star burst
    for(let rs=0;rs<12;rs++){
      const ra=rs/12*Math.PI*2;
      x0.strokeStyle=rgba(pc(rs%4),0.6+beat*0.4);x0.lineWidth=2;x0.shadowBlur=15;x0.shadowColor=pc(rs%4);
      x0.beginPath();x0.moveTo(0,0);x0.lineTo(Math.cos(ra)*innerR,Math.sin(ra)*innerR);x0.stroke();
    }
    // Inner concentric rings
    for(let ri=1;ri<4;ri++){
      x0.beginPath();x0.arc(0,0,innerR*ri/4,0,Math.PI*2);
      x0.strokeStyle=rgba(pc(ri%4),(0.5+beat*0.5));x0.lineWidth=2;x0.shadowBlur=10;x0.shadowColor=pc(ri%4);x0.stroke();
    }
  } else {
    // Inner decorative pattern
    for(let ri=1;ri<3;ri++){
      x0.beginPath();x0.arc(0,0,innerR*ri/3,0,Math.PI*2);
      x0.strokeStyle=rgba(pc(ri%4),0.4);x0.lineWidth=2;x0.shadowBlur=6;x0.shadowColor=pc(ri%4);x0.stroke();
    }
  }

  // Spokes ‚Äî 12
  for(let s=0;s<12;s++){
    const a=s/12*Math.PI*2;
    x0.beginPath();x0.moveTo(Math.cos(a)*innerR,Math.sin(a)*innerR);
    x0.lineTo(Math.cos(a)*ferrisR,Math.sin(a)*ferrisR);
    x0.strokeStyle=rgba(pc(s%4),hyperWheel?0.7:0.4);
    x0.lineWidth=hyperWheel?3:2;x0.shadowBlur=hyperWheel?10:4;x0.shadowColor=pc(s%4);x0.stroke();
  }
  x0.shadowBlur=0;x0.restore();

  // Gondolas ‚Äî mini centerpieces as gondola cars
  cpRot+=hyperWheel?0.06:0.015;cpPh+=0.013;
  const gondolaSz=Math.min(w,h)*(hyperWheel?0.04:0.03+beat*0.005);
  for(let s=0;s<12;s++){
    const a=s/12*Math.PI*2+C.ferrisRot;
    const gx=ferrisCX+Math.cos(a)*ferrisR,gy=ferrisCY+Math.sin(a)*ferrisR;
    x0.globalAlpha=hyperWheel?(0.9+beat*0.1):(0.75+beat*0.15);
    x0.shadowBlur=hyperWheel?12:6;x0.shadowColor=pc(s%4);
    drawCPMini(x0,THEME.centerpiece,gx,gy,gondolaSz,-C.ferrisRot+cpRot);
    x0.shadowBlur=0;
  }
  x0.globalAlpha=1;

  // Support legs
  x0.strokeStyle='rgba(100,80,60,0.8)';x0.lineWidth=8;
  x0.beginPath();x0.moveTo(ferrisCX-ferrisR*0.15,ferrisCY+ferrisR);x0.lineTo(ferrisCX-ferrisR*0.5,h*0.82);x0.stroke();
  x0.beginPath();x0.moveTo(ferrisCX+ferrisR*0.15,ferrisCY+ferrisR);x0.lineTo(ferrisCX+ferrisR*0.5,h*0.82);x0.stroke();

  // ‚îÄ‚îÄ CIRCUS TENTS ‚Äî grounded at bottom edge like midway skyline ‚îÄ‚îÄ
  const tentBaseY=h; // tents sit on actual bottom edge of screen
  for(const tent of C.tents){
    const tx=tent.x,tw=tent.w,th2=tent.h;
    const peakX=tx+tw*0.5,peakY=tentBaseY-th2;

    if(tent.isSquare){
      // Rectangular booth/food stand ‚Äî flat top
      x0.fillStyle=rgba(pc(tent.ci),0.85+beat*0.1);
      x0.fillRect(tx,peakY,tw,th2);
      // Alternating color stripe panels
      const panelW=tw/tent.numStripes;
      for(let s=0;s<tent.numStripes;s++){
        x0.fillStyle=rgba(pc(s%2===0?tent.ci:tent.ci2),(0.7+beat*0.1));
        x0.fillRect(tx+s*panelW,peakY,panelW,th2);
      }
      // Awning overhang at top
      x0.fillStyle=rgba(pc(tent.ci2),0.9+beat*0.1);
      x0.fillRect(tx-4,peakY,tw+8,th2*0.12);
      // Booth opening (dark center)
      x0.fillStyle='rgba(0,0,0,0.7)';
      x0.fillRect(tx+tw*0.15,tentBaseY-th2*0.55,tw*0.7,th2*0.55);
      // Outline glow
      x0.strokeStyle=rgba(pc(tent.ci),(0.5+beat*0.2));x0.lineWidth=2;
      x0.shadowBlur=8;x0.shadowColor=pc(tent.ci);
      x0.strokeRect(tx,peakY,tw,th2);x0.shadowBlur=0;
    } else {
      // Peaked tent (triangular)
      const numS=tent.numStripes;
      for(let s=0;s<numS;s++){
        const x1=tx+s/numS*tw,x2=tx+(s+1)/numS*tw;
        x0.beginPath();x0.moveTo(peakX,peakY);
        x0.lineTo(x1,tentBaseY);x0.lineTo(x2,tentBaseY);x0.closePath();
        x0.fillStyle=rgba(pc(s%2===0?tent.ci:tent.ci2),0.85+beat*0.1);
        x0.fill();
      }
      // Tent outline
      x0.strokeStyle=rgba(pc(tent.ci),0.6);x0.lineWidth=2;
      x0.shadowBlur=6;x0.shadowColor=pc(tent.ci);
      x0.beginPath();x0.moveTo(peakX,peakY);x0.lineTo(tx,tentBaseY);x0.lineTo(tx+tw,tentBaseY);x0.closePath();x0.stroke();

      // Scalloped valance edge
      const valY=peakY+th2*0.5;
      const numScallops=6;
      x0.fillStyle=rgba(pc(tent.ci2),0.8+beat*0.15);x0.shadowBlur=4;x0.shadowColor=pc(tent.ci2);
      x0.beginPath();
      for(let sc=0;sc<numScallops;sc++){
        const sx1=tx+(sc/numScallops)*tw,sx2=tx+((sc+0.5)/numScallops)*tw,sx3=tx+((sc+1)/numScallops)*tw;
        const peakXv=peakX;
        const leftValX=sx1+(peakXv-sx1)*0.5;
        const rightValX=sx3+(peakXv-sx3)*0.5;
        if(sc===0)x0.moveTo(leftValX,valY-tw*0.02);
        x0.quadraticCurveTo(sx2+(peakXv-sx2)*0.5,valY+tw*0.04,rightValX,valY-tw*0.02);
      }
      x0.closePath();x0.fill();x0.shadowBlur=0;
    }

    // Flag at peak (peaked tents only)
    if(tent.flag&&!tent.isSquare){
      tent.flagPh+=0.05;
      x0.strokeStyle=rgba(pc(tent.ci2),0.9);x0.lineWidth=1.5;
      x0.beginPath();x0.moveTo(peakX,peakY);x0.lineTo(peakX,peakY-20);x0.stroke();
      x0.fillStyle=rgba(pc(tent.ci),0.9);
      x0.beginPath();x0.moveTo(peakX,peakY-20);
      x0.lineTo(peakX+12+Math.sin(tent.flagPh)*3,peakY-15+Math.sin(tent.flagPh)*2);
      x0.lineTo(peakX,peakY-10);x0.closePath();x0.fill();
    }

    // String lights along base
    for(let lt=0;lt<6;lt++){
      const lx=tx+lt/5*tw,ly=tentBaseY-6;
      x0.fillStyle=rgba(pc((lt+tent.ci)%4),(0.6+Math.sin(t*0.005+lt+tent.ci)*0.4)+beat*0.3);
      x0.shadowBlur=6;x0.shadowColor=pc((lt+tent.ci)%4);
      x0.beginPath();x0.arc(lx,ly,3,0,Math.PI*2);x0.fill();x0.shadowBlur=0;
    }
  }

  // ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const c of C.confetti){
    c.x+=c.vx*(1+energy*0.3);c.y+=c.vy;c.rot+=c.rotS;
    if(c.y>h+10){c.y=-10;c.x=Math.random()*w;}
    if(c.x<-20)c.x=w+20;if(c.x>w+20)c.x=-20;
    x0.save();x0.translate(c.x,c.y);x0.rotate(c.rot);
    x0.fillStyle=rgba(pc(c.ci),0.7+beat*0.15);
    x0.fillRect(-c.sz/2,-c.sz*0.3,c.sz,c.sz*0.6);
    x0.restore();
  }

  // ‚îÄ‚îÄ EVIL CLOWN ‚Äî neon outline tube art, strobes to beat ‚îÄ‚îÄ
  if(C.clown){
    C.clownAlpha=Math.min(1,C.clownAlpha+0.018);
    const cl=C.clown;
    cl.timer-=16;
    if(cl.timer<=0){
      C.clownAlpha=Math.max(0,C.clownAlpha-0.02);
      if(C.clownAlpha<=0)C.clown=null;
    }
    const alpha=C.clownAlpha;
    // Ferocious strobe ‚Äî flickers on/off, cycles palette colors
    const strobeRaw=Math.sin(t*0.06+beat*12);
    const strobeOn=strobeRaw>-0.2;// flicker on/off
    if(!strobeOn&&cl.timer>1000){/* skip drawing = flicker off */}
    else{
    const strobeCi=Math.floor(t*0.015+beat*5)%4;
    x0.save();x0.globalAlpha=alpha*(0.7+beat*0.3);

    // Dark overlay
    x0.fillStyle=`rgba(0,0,0,${0.75*alpha})`;x0.fillRect(0,0,w,h);

    const fcx=cx,fcy=h*0.42;
    const fr=Math.min(w,h)*0.4;

    // All drawn as neon outlines only ‚Äî no fills
    const nClr=pc(strobeCi);
    const nClr2=pc((strobeCi+1)%4);
    const nClr3=pc((strobeCi+2)%4);
    x0.strokeStyle=rgba(nClr,0.95);x0.lineWidth=4;
    x0.shadowBlur=25+beat*20;x0.shadowColor=nClr;

    // Face outline ‚Äî circle
    x0.beginPath();x0.arc(fcx,fcy,fr,0,Math.PI*2);x0.stroke();

    // Eyes ‚Äî large oval outlines
    for(const ex of [fcx-fr*0.35,fcx+fr*0.35]){
      x0.strokeStyle=rgba(nClr2,0.95);x0.shadowColor=nClr2;x0.lineWidth=3;
      x0.beginPath();x0.ellipse(ex,fcy-fr*0.08,fr*0.22,fr*0.16,0,0,Math.PI*2);x0.stroke();
      // Pupil dot
      x0.beginPath();x0.arc(ex,fcy-fr*0.08,fr*0.06,0,Math.PI*2);x0.stroke();
      // Eyebrow
      x0.strokeStyle=rgba(nClr,0.9);x0.lineWidth=4;
      x0.beginPath();x0.moveTo(ex-fr*0.2,fcy-fr*0.28);
      x0.bezierCurveTo(ex,fcy-fr*(ex<fcx?0.42:0.35),ex+fr*0.2,fcy-fr*(ex<fcx?0.3:0.4),ex+fr*0.22,fcy-fr*0.22);x0.stroke();
    }

    // Nose ‚Äî circle outline
    x0.strokeStyle=rgba(nClr3,0.95);x0.shadowColor=nClr3;x0.lineWidth=3;
    x0.beginPath();x0.arc(fcx,fcy+fr*0.1,fr*0.1*(1+beat*0.2),0,Math.PI*2);x0.stroke();

    // Mouth ‚Äî menacing wide grin
    x0.strokeStyle=rgba(nClr,0.95);x0.shadowColor=nClr;x0.lineWidth=4;
    x0.beginPath();
    x0.moveTo(fcx-fr*0.5,fcy+fr*0.32);
    x0.bezierCurveTo(fcx-fr*0.25,fcy+fr*0.6,fcx+fr*0.25,fcy+fr*0.6,fcx+fr*0.5,fcy+fr*0.32);
    x0.stroke();
    // Teeth ‚Äî jagged lines
    x0.lineWidth=2;x0.strokeStyle=rgba(nClr2,0.9);x0.shadowColor=nClr2;
    for(let tk=0;tk<7;tk++){
      const ta=fcx-fr*0.4+tk*fr*0.13;
      const ty=fcy+fr*0.35+Math.sin(tk*0.8)*fr*0.04;
      x0.beginPath();x0.moveTo(ta,ty);x0.lineTo(ta+fr*0.04,ty+fr*0.12);x0.lineTo(ta+fr*0.08,ty);x0.stroke();
    }

    // Clown hair ‚Äî wild spiky neon outlines
    x0.lineWidth=3;
    for(let hr=0;hr<12;hr++){
      const ha=hr/12*Math.PI*2;
      const hLen=fr*(0.25+Math.sin(hr*1.5)*0.12);
      x0.strokeStyle=rgba(pc((hr+strobeCi)%4),0.85+beat*0.15);x0.shadowColor=pc((hr+strobeCi)%4);
      x0.beginPath();x0.moveTo(fcx+Math.cos(ha)*fr*0.9,fcy+Math.sin(ha)*fr*0.9);
      x0.lineTo(fcx+Math.cos(ha)*(fr*0.9+hLen),fcy+Math.sin(ha)*(fr*0.9+hLen));x0.stroke();
    }

    x0.shadowBlur=0;x0.restore();
    }
  }
}


// ‚ïê‚ïê‚ïê SCENE: egyptianTomb ‚ïê‚ïê‚ïê

function drawEgyptianTomb(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;const beat=SM.beatPulse,energy=SM.energy;
  if(!SD.egypt){
    const numSarcophagi=7;
    SD.egypt={
      torches:Array.from({length:4},(_,i)=>({ph:Math.random()*Math.PI*2,flamePh:Math.random()*Math.PI*2})),
      sarcophagi:Array.from({length:numSarcophagi},(_,i)=>({x:w*(0.08+i*(0.84/(numSarcophagi-1))),y:h*0.68,ci:i%4,open:false,openAngle:0,mummy:null,mummyActive:false,beatPulse:0,outlineCi:i%4,outlineTimer:0})),
      mummies:[],pillarHiero:[],
      superHiero:false,superHieroTimer:0,superFlames:false,superFlamesTimer:0,superMummies:false,superMummiesTimer:0};
    // Pillar hieroglyphs ‚Äî stationary
    const hChars=['ìÄÄ','ìÇÄ','ìÉ≠','ìÑø','ìáã','ìàñ','ìäñ','ìåÉ','ìéõ','ìèè','ìêç','ìáº'];
    for(let p=0;p<2;p++){for(let r=0;r<10;r++){SD.egypt.pillarHiero.push({pillar:p,row:r,char:hChars[Math.floor(Math.random()*hChars.length)],ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2});}}
  }
  const EG=SD.egypt;
  if(EG.superHieroTimer>0){EG.superHieroTimer-=16;if(EG.superHieroTimer<=0)EG.superHiero=false;}
  if(EG.superFlamesTimer>0){EG.superFlamesTimer-=16;if(EG.superFlamesTimer<=0)EG.superFlames=false;}
  if(EG.superMummiesTimer>0){EG.superMummiesTimer-=16;if(EG.superMummiesTimer<=0)EG.superMummies=false;}
  const superH=EG.superHiero,superF=EG.superFlames,superM=EG.superMummies;
  // BG ‚Äî dark tomb
  const bgG=x0.createLinearGradient(0,0,0,h);bgG.addColorStop(0,'rgba(15,10,4,1)');bgG.addColorStop(0.5,'rgba(25,18,8,1)');bgG.addColorStop(1,'rgba(8,5,2,1)');x0.fillStyle=bgG;x0.fillRect(0,0,w,h);
  // Stone texture
  x0.strokeStyle='rgba(40,30,15,0.3)';x0.lineWidth=1;for(let sr=0;sr<8;sr++){x0.beginPath();x0.moveTo(0,h*sr/8);x0.lineTo(w,h*sr/8);x0.stroke();}for(let sc=0;sc<12;sc++){x0.beginPath();x0.moveTo(w*sc/12,0);x0.lineTo(w*sc/12,h);x0.stroke();}
  // Floor
  x0.fillStyle='rgba(12,8,3,0.92)';x0.fillRect(0,h*0.82,w,h*0.18);x0.strokeStyle=rgba(pc(1),0.25);x0.lineWidth=1.5;x0.beginPath();x0.moveTo(0,h*0.82);x0.lineTo(w,h*0.82);x0.stroke();
  // ‚îÄ‚îÄ TWO PILLARS ‚Äî background, depth perspective ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pillarX=[w*0.27,w*0.73],pillarW=w*0.065,pillarH=h*0.65,pillarY=h*0.12;
  for(let p=0;p<2;p++){
    const px=pillarX[p];
    // Column body ‚Äî Egyptian papyrus style
    x0.fillStyle='rgba(40,30,15,0.7)';x0.fillRect(px-pillarW/2,pillarY,pillarW,pillarH);
    // Column base ‚Äî wider
    x0.fillStyle='rgba(50,38,18,0.8)';x0.fillRect(px-pillarW*0.7,pillarY+pillarH-pillarH*0.06,pillarW*1.4,pillarH*0.06);
    // Column capital ‚Äî lotus top
    x0.fillStyle='rgba(50,38,18,0.8)';x0.fillRect(px-pillarW*0.65,pillarY,pillarW*1.3,pillarH*0.05);
    x0.beginPath();x0.moveTo(px-pillarW*0.8,pillarY);x0.lineTo(px,pillarY-pillarH*0.06);x0.lineTo(px+pillarW*0.8,pillarY);x0.closePath();x0.fill();
    // Column outline glow
    x0.strokeStyle=rgba(pc(p*2),0.35+beat*0.15);x0.lineWidth=2;x0.shadowBlur=8+beat*4;x0.shadowColor=pc(p*2);
    x0.strokeRect(px-pillarW/2,pillarY,pillarW,pillarH);x0.shadowBlur=0;
    // Vertical grooves
    for(let g=0;g<4;g++){x0.strokeStyle=rgba(pc((p+g)%4),0.15);x0.lineWidth=1;x0.beginPath();x0.moveTo(px-pillarW*0.35+g*pillarW*0.23,pillarY+pillarH*0.06);x0.lineTo(px-pillarW*0.35+g*pillarW*0.23,pillarY+pillarH*0.92);x0.stroke();}
    // Hieroglyphs on pillars ‚Äî stationary, vibrant
    const phieros=EG.pillarHiero.filter(ph=>ph.pillar===p);
    for(const ph of phieros){ph.ph+=0.015;const hy=pillarY+pillarH*0.08+ph.row*(pillarH*0.08);const hx=px;
      const hAlpha=0.5+Math.sin(ph.ph+t*0.002)*0.3+beat*0.2;x0.font=`${pillarW*0.55}px serif`;x0.textAlign='center';
      x0.fillStyle=rgba(pc(ph.ci),hAlpha);x0.shadowBlur=10+beat*6;x0.shadowColor=pc(ph.ci);x0.fillText(ph.char,hx,hy);x0.shadowBlur=0;}
    x0.textAlign='left';
    // Candles at base of each pillar
    const candleY=pillarY+pillarH;for(let c2=0;c2<3;c2++){const ccx=px-pillarW*0.3+c2*pillarW*0.3;
      x0.fillStyle='rgba(160,130,80,0.7)';x0.fillRect(ccx-3,candleY-h*0.04,6,h*0.04);
      // Flame
      const fph=t*0.005+c2+p;const fSz=12+beat*6+(superF?10:0);const fCi=superF?Math.floor(t*0.008+c2)%4:0;
      const fG=x0.createRadialGradient(ccx+Math.sin(fph)*2,candleY-h*0.04-fSz*0.4,0,ccx,candleY-h*0.04,fSz);
      fG.addColorStop(0,superF?rgba(pc(fCi),0.9):'rgba(255,220,80,0.9)');fG.addColorStop(0.5,superF?rgba(pc((fCi+1)%4),0.5):'rgba(255,120,20,0.5)');fG.addColorStop(1,'transparent');
      x0.fillStyle=fG;x0.shadowBlur=superF?20:10;x0.shadowColor=superF?pc(fCi):'rgba(255,150,0,0.7)';
      x0.beginPath();x0.ellipse(ccx,candleY-h*0.04-fSz*0.3,fSz*0.35,fSz*0.7,Math.sin(fph)*0.1,0,Math.PI*2);x0.fill();x0.shadowBlur=0;}
  }
  // ‚îÄ‚îÄ CENTERPIECE ‚Äî centered on screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(THEME.centerpiece){cpRot+=0.008*(1+energy*0.15);cpPh+=0.013;const gs=Math.min(w,h)*(0.14+beat*0.03+songProg*0.04);
    if(superF){const nF=16;for(let fl=0;fl<nF;fl++){const fa=fl/nF*Math.PI*2+t*0.003,fr=gs*(1.3+Math.sin(t*0.005+fl)*0.2);const flG=x0.createRadialGradient(cx+Math.cos(fa)*fr,cy+Math.sin(fa)*fr*0.4,0,cx+Math.cos(fa)*fr,cy+Math.sin(fa)*fr*0.4,gs*0.4);flG.addColorStop(0,rgba(pc(fl%4),(0.6+beat*0.3)));flG.addColorStop(1,'transparent');x0.fillStyle=flG;x0.fillRect(0,0,w,h);}}
    x0.globalAlpha=(0.85+beat*0.12)*(superF?1.2:1);x0.shadowBlur=superF?(30+beat*20):(18+beat*12);x0.shadowColor=superF?pc(Math.floor(t*0.008)%4):pc(0);
    drawCPMini(x0,THEME.centerpiece,cx,cy,gs,cpRot);x0.globalAlpha=1;x0.shadowBlur=0;}
  // ‚îÄ‚îÄ SARCOPHAGI ‚Äî Egyptian shaped, vibrant, with mini centerpieces ‚îÄ‚îÄ
  const sarcW=w*0.065,sarcH=h*0.24;
  for(const s of EG.sarcophagi){
    if(superM&&!s.mummyActive&&Math.random()<0.003){s.mummyActive=true;s.open=true;}
    if(s.open)s.openAngle=Math.min(Math.PI*0.7,s.openAngle+0.02);
    s.beatPulse=beat;s.outlineTimer+=0.03+beat*0.05;
    s.outlineCi=Math.floor(s.outlineTimer+s.ci)%4;
    const sx=s.x,sy=h*0.82-sarcH;const strobeFactor=0.7+Math.sin(s.outlineTimer*4)*0.3+beat*0.3;
    // Egyptian sarcophagus shape ‚Äî tapered bottom, wider shoulders, pharaoh head
    x0.save();
    // Body ‚Äî trapezoid shape
    x0.beginPath();x0.moveTo(sx-sarcW*0.3,sy+sarcH);x0.lineTo(sx-sarcW*0.5,sy+sarcH*0.3);x0.lineTo(sx-sarcW*0.45,sy+sarcH*0.15);
    // Shoulders
    x0.lineTo(sx-sarcW*0.5,sy+sarcH*0.12);
    // Nemes headdress curves
    x0.bezierCurveTo(sx-sarcW*0.55,sy-sarcH*0.02,sx-sarcW*0.3,sy-sarcH*0.08,sx,sy-sarcH*0.1);
    x0.bezierCurveTo(sx+sarcW*0.3,sy-sarcH*0.08,sx+sarcW*0.55,sy-sarcH*0.02,sx+sarcW*0.5,sy+sarcH*0.12);
    x0.lineTo(sx+sarcW*0.45,sy+sarcH*0.15);x0.lineTo(sx+sarcW*0.5,sy+sarcH*0.3);x0.lineTo(sx+sarcW*0.3,sy+sarcH);x0.closePath();
    x0.fillStyle=rgba(pc(s.ci),0.2+beat*0.1);x0.fill();
    x0.strokeStyle=rgba(pc(s.outlineCi),strobeFactor*0.9);x0.lineWidth=3;x0.shadowBlur=12+beat*8;x0.shadowColor=pc(s.outlineCi);x0.stroke();x0.shadowBlur=0;
    // Decorative bands
    for(let bd=1;bd<5;bd++){const bandY=sy+sarcH*(bd*0.18+0.15);x0.strokeStyle=rgba(pc((s.ci+bd)%4),0.4*strobeFactor);x0.lineWidth=1.5;x0.beginPath();x0.moveTo(sx-sarcW*0.45,bandY);x0.lineTo(sx+sarcW*0.45,bandY);x0.stroke();}
    // Face area ‚Äî simplified pharaoh face
    x0.strokeStyle=rgba(pc((s.ci+2)%4),0.4*strobeFactor);x0.lineWidth=1;
    // Eyes
    x0.beginPath();x0.ellipse(sx-sarcW*0.15,sy+sarcH*0.08,sarcW*0.08,sarcH*0.02,0,0,Math.PI*2);x0.stroke();
    x0.beginPath();x0.ellipse(sx+sarcW*0.15,sy+sarcH*0.08,sarcW*0.08,sarcH*0.02,0,0,Math.PI*2);x0.stroke();
    // Mini centerpiece on sarcophagus ‚Äî matches and mimics main
    if(THEME.centerpiece){const miniSz=Math.min(w,h)*0.04*(1+beat*0.15);x0.shadowBlur=8+beat*6;x0.shadowColor=pc(s.outlineCi);x0.globalAlpha=strobeFactor*0.85;
      drawCPMini(x0,THEME.centerpiece,sx,sy+sarcH*0.55,miniSz,cpRot+s.ci*0.5);x0.globalAlpha=1;x0.shadowBlur=0;}
    // Lid
    if(s.open){x0.save();x0.translate(sx-sarcW*0.5,sy);x0.rotate(-s.openAngle);
      x0.fillStyle='rgba(45,32,14,0.95)';x0.strokeStyle=rgba(pc(s.outlineCi),0.8*strobeFactor);x0.lineWidth=2;
      x0.fillRect(0,-4,sarcW,sarcH*0.25);x0.strokeRect(0,-4,sarcW,sarcH*0.25);x0.restore();}
    x0.restore();
  }
  // ‚îÄ‚îÄ MUMMIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const s of EG.sarcophagi){if(s.mummyActive&&!EG.mummies.find(m=>m.srcSarc===s.x))EG.mummies.push({x:s.x,y:h*0.82-sarcH*0.6,vx:(Math.random()-0.5)*0.8,ci:s.ci,ph:0,srcSarc:s.x,step:0,stepTimer:0,armAngle:0,alive:true});}
  for(const m of EG.mummies){if(!m.alive)continue;m.ph+=0.04*(1+beat*0.3);m.stepTimer+=16;if(m.stepTimer>400/(1+energy)){m.step++;m.stepTimer=0;}
    m.x+=m.vx*(0.3+beat*0.2);if(m.x<w*0.05||m.x>w*0.95)m.vx*=-1;m.armAngle=Math.sin(m.step*0.8)*0.4;
    const strobe=superM?(0.5+Math.sin(t*0.05+m.ph)*0.5+beat*0.4):1;const mx=m.x,my=h*0.82-h*0.14,mh2=h*0.14,mw=mh2*0.35;
    x0.save();x0.translate(mx,my);x0.strokeStyle=rgba(pc(m.ci),(0.8+beat*0.2)*strobe);x0.lineWidth=3;x0.shadowBlur=superM?(15+beat*10):6;x0.shadowColor=pc(m.ci);
    x0.fillStyle=rgba(pc(m.ci),0.12*strobe);x0.fillRect(-mw/2,0,mw,mh2*0.6);x0.strokeRect(-mw/2,0,mw,mh2*0.6);
    for(let bw=0;bw<4;bw++){x0.strokeStyle=rgba(pc((m.ci+bw)%4),(0.3+beat*0.1)*strobe);x0.lineWidth=1.5;x0.beginPath();x0.moveTo(-mw/2,mh2*0.12*(bw+1));x0.lineTo(mw/2,mh2*0.12*(bw+1));x0.stroke();}
    x0.strokeStyle=rgba(pc(m.ci),0.8*strobe);x0.lineWidth=3;x0.beginPath();x0.moveTo(-mw/2,mh2*0.15);x0.lineTo(-mw*1.2,mh2*0.15+Math.sin(m.armAngle)*mh2*0.1);x0.stroke();x0.beginPath();x0.moveTo(mw/2,mh2*0.15);x0.lineTo(mw*1.2,mh2*0.15-Math.sin(m.armAngle)*mh2*0.1);x0.stroke();
    x0.beginPath();x0.ellipse(0,-mh2*0.12,mw*0.42,mh2*0.16,0,0,Math.PI*2);x0.stroke();x0.fillStyle=rgba(pc(m.ci),0.1*strobe);x0.fill();
    x0.fillStyle=rgba(pc((m.ci+2)%4),(0.9+beat*0.1)*strobe);x0.shadowBlur=8+beat*5;x0.shadowColor=pc((m.ci+2)%4);x0.beginPath();x0.arc(-mw*0.12,-mh2*0.12,mw*0.08,0,Math.PI*2);x0.fill();x0.beginPath();x0.arc(mw*0.12,-mh2*0.12,mw*0.08,0,Math.PI*2);x0.fill();
    x0.strokeStyle=rgba(pc(m.ci),0.7*strobe);x0.lineWidth=3;x0.shadowBlur=0;const legOff=Math.sin(m.step)*mw*0.15;
    x0.beginPath();x0.moveTo(-mw*0.18,mh2*0.6);x0.lineTo(-mw*0.18+legOff,mh2*0.95);x0.stroke();x0.beginPath();x0.moveTo(mw*0.18,mh2*0.6);x0.lineTo(mw*0.18-legOff,mh2*0.95);x0.stroke();
    x0.shadowBlur=0;x0.restore();}
}


// ‚ïê‚ïê MODULE: centerpiece.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê CENTERPIECE SYSTEM ‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CENTERPIECE SYSTEM v2 ‚Äî COMPLETE REBUILD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Architecture:
//   1. drawCP(ctx, name, sz, t) ‚Äî draws any centerpiece at (0,0), size sz
//   2. Each scene renderer calls drawCPInScene(x0, t) to integrate
//   3. Render loop calls drawCPInScene ‚Äî NO separate x1 layer for integrated scenes
//   4. x1 layer ONLY used for scenes that don't integrate (floating mode)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// CP_INTEGRATED_SCENES defined above in variety system

// ‚îÄ‚îÄ Core draw function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawCP(ctx, name, sz, t) {
  const e = SM.energy, bp = SM.beatPulse, ph = cpPh;
  ctx.save();
  ctx.shadowBlur = 0;

  switch(name) {

    // ‚îÄ‚îÄ SKULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'skull': {
      const jawDrop = bp * sz * 0.18;
      ctx.shadowBlur = sz * 0.4; ctx.shadowColor = pc(0);
      // Cranium
      ctx.fillStyle = rgba(pc(0), 0.92);
      ctx.beginPath();
      ctx.arc(0, -sz*0.1, sz*0.52, Math.PI, 0);
      ctx.bezierCurveTo(sz*0.52, sz*0.25, sz*0.38, sz*0.38, sz*0.28, sz*0.38);
      ctx.lineTo(-sz*0.28, sz*0.38);
      ctx.bezierCurveTo(-sz*0.38, sz*0.38, -sz*0.52, sz*0.25, -sz*0.52, -sz*0.1);
      ctx.fill();
      // Eye sockets
      ctx.fillStyle = 'rgba(0,0,0,0.92)';
      ctx.beginPath(); ctx.ellipse(-sz*0.2, -sz*0.1, sz*0.155, sz*0.17, -0.15, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.2, -sz*0.1, sz*0.155, sz*0.17, 0.15, 0, Math.PI*2); ctx.fill();
      // Eye glow on beat
      if (bp > 0.3) {
        ctx.fillStyle = rgba(pc(1), bp * 0.8);
        ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
        ctx.beginPath(); ctx.ellipse(-sz*0.2, -sz*0.1, sz*0.08, sz*0.09, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(sz*0.2, -sz*0.1, sz*0.08, sz*0.09, 0, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      }
      // Nose cavity
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.beginPath(); ctx.moveTo(0, sz*0.08); ctx.lineTo(-sz*0.08, sz*0.22); ctx.lineTo(sz*0.08, sz*0.22); ctx.closePath(); ctx.fill();
      // Upper jaw
      ctx.fillStyle = rgba(pc(0), 0.85);
      ctx.fillRect(-sz*0.28, sz*0.28, sz*0.56, sz*0.12);
      // Lower jaw ‚Äî drops on beat
      ctx.fillStyle = rgba(pc(0), 0.8);
      ctx.fillRect(-sz*0.24, sz*0.38 + jawDrop, sz*0.48, sz*0.1);
      // Teeth
      ctx.fillStyle = 'rgba(230,230,220,0.9)';
      for (let i=0; i<6; i++) {
        ctx.fillRect(-sz*0.24 + i*sz*0.08, sz*0.28, sz*0.06, sz*0.12);
        ctx.fillRect(-sz*0.21 + i*sz*0.08, sz*0.38 + jawDrop, sz*0.06, sz*0.1);
      }
      break;
    }

    // ‚îÄ‚îÄ FLAMING_SKULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'flaming_skull': {
      // Flames first (behind skull)
      ctx.shadowBlur = sz * 0.5; ctx.shadowColor = pc(0);
      for (let f=0; f<10; f++) {
        const fa = (f/10 - 0.5) * Math.PI * 0.9;
        const fh = sz * (0.6 + Math.sin(ph*4 + f*0.7) * 0.25 + bp*0.3);
        const fx = Math.sin(fa) * sz * 0.35;
        const fy = -sz * 0.38;
        ctx.beginPath();
        ctx.moveTo(fx - sz*0.06, fy);
        ctx.bezierCurveTo(fx - sz*0.04, fy - fh*0.4, fx + sz*0.08, fy - fh*0.6, fx, fy - fh);
        ctx.bezierCurveTo(fx - sz*0.1, fy - fh*0.6, fx + sz*0.04, fy - fh*0.3, fx + sz*0.06, fy);
        ctx.closePath();
        const fg = ctx.createLinearGradient(fx, fy, fx, fy - fh);
        fg.addColorStop(0, 'rgba(255,180,0,0.85)');
        fg.addColorStop(0.4, rgba(pc(0), 0.7));
        fg.addColorStop(1, 'rgba(255,50,0,0)');
        ctx.fillStyle = fg;
        ctx.fill();
      }
      ctx.shadowBlur = 0;
      // Draw skull on top
      drawCP(ctx, 'skull', sz, t);
      break;
    }

    // ‚îÄ‚îÄ FLAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'flame': {
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = rgba(pc(0), 0.8);
      for (let layer=0; layer<5; layer++) {
        const li = 1 - layer/5;
        const lsz = sz * (0.3 + layer * 0.16);
        const flicker = Math.sin(ph*5 + layer*1.3) * lsz * 0.12 + bp*lsz*0.15;
        ctx.beginPath();
        ctx.moveTo(0, sz*0.5);
        ctx.bezierCurveTo(-lsz*0.7, sz*0.1, -lsz*0.5 + flicker, -sz*0.2, 0, -sz*0.5 - flicker*0.5);
        ctx.bezierCurveTo(lsz*0.5 - flicker, -sz*0.2, lsz*0.7, sz*0.1, 0, sz*0.5);
        ctx.closePath();
        const colors = ['rgba(255,240,180,0.95)','rgba(255,180,0,0.85)','rgba(255,80,0,0.75)',rgba(pc(0),0.65),'rgba(180,0,80,0.4)'];
        ctx.fillStyle = colors[layer] || rgba(pc(layer%4), 0.5);
        ctx.fill();
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ DRAGON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'dragon': case 'dragon_head': {
      ctx.shadowBlur = sz*0.35; ctx.shadowColor = pc(0);
      // Body / neck
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath();
      ctx.moveTo(-sz*0.8, sz*0.2);
      ctx.bezierCurveTo(-sz*0.4, sz*0.1, sz*0.1, sz*0.25, sz*0.4, sz*0.05);
      ctx.bezierCurveTo(sz*0.6, -sz*0.05, sz*0.55, -sz*0.2, sz*0.3, -sz*0.15);
      ctx.bezierCurveTo(sz*0.1, sz*0.05, -sz*0.3, sz*0.0, -sz*0.5, sz*0.18);
      ctx.closePath(); ctx.fill();
      // Wing
      ctx.beginPath();
      ctx.moveTo(-sz*0.15, -sz*0.05);
      ctx.bezierCurveTo(-sz*0.35, -sz*0.55, -sz*0.7, -sz*0.8, -sz*0.85, -sz*0.55);
      ctx.bezierCurveTo(-sz*0.95, -sz*0.3, -sz*0.7, -sz*0.1, -sz*0.5, sz*0.0);
      ctx.closePath();
      ctx.fillStyle = rgba(pc(1), 0.65); ctx.fill();
      ctx.strokeStyle = rgba(pc(0), 0.8); ctx.lineWidth = sz*0.02; ctx.stroke();
      // Head
      ctx.fillStyle = rgba(pc(0), 0.92);
      ctx.beginPath();
      ctx.ellipse(sz*0.55, -sz*0.1, sz*0.38, sz*0.22, -0.2, 0, Math.PI*2);
      ctx.fill();
      // Snout/jaw
      ctx.beginPath();
      ctx.moveTo(sz*0.3, sz*0.04);
      ctx.lineTo(sz*0.95, sz*0.0 + bp*sz*0.1);
      ctx.lineTo(sz*0.95, sz*0.12 + bp*sz*0.1);
      ctx.lineTo(sz*0.3, sz*0.12);
      ctx.closePath(); ctx.fill();
      // Horn
      ctx.beginPath();
      ctx.moveTo(sz*0.45, -sz*0.28); ctx.lineTo(sz*0.55, -sz*0.55); ctx.lineTo(sz*0.62, -sz*0.28);
      ctx.closePath(); ctx.fillStyle = rgba(pc(2), 0.85); ctx.fill();
      // Eye
      ctx.fillStyle = rgba(pc(1), 0.95);
      ctx.shadowBlur = 10; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(sz*0.62, -sz*0.12, sz*0.07, sz*0.06, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,0.9)';
      ctx.beginPath(); ctx.arc(sz*0.64, -sz*0.12, sz*0.035, 0, Math.PI*2); ctx.fill();
      // Fire breath on beat
      if (bp > 0.5) {
        for (let f=0; f<5; f++) {
          const fl = sz*(0.4 + f*0.2 + bp*0.3);
          const ffy = (Math.random()-0.5) * sz * 0.12;
          const ffg = ctx.createLinearGradient(sz*0.95, 0, sz*0.95 + fl, 0);
          ffg.addColorStop(0,'rgba(255,240,0,0.9)');
          ffg.addColorStop(0.4,'rgba(255,100,0,0.7)');
          ffg.addColorStop(1,'transparent');
          ctx.fillStyle = ffg; ctx.shadowBlur = 15; ctx.shadowColor = 'rgba(255,150,0,1)';
          ctx.beginPath();
          ctx.ellipse(sz*0.95 + fl*0.5, ffy, fl*0.5, sz*(0.04 + f*0.015), 0, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.shadowBlur = 0;
      }
      break;
    }

    // ‚îÄ‚îÄ WOLF_HEAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'wolf_head': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      const howl = bp * sz * 0.15; // stretches up on beat
      // Ears
      ctx.fillStyle = rgba(pc(0), 0.85);
      ctx.beginPath(); ctx.moveTo(-sz*0.35, -sz*0.3 - howl); ctx.lineTo(-sz*0.55, -sz*0.75 - howl); ctx.lineTo(-sz*0.1, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.35, -sz*0.3 - howl); ctx.lineTo(sz*0.55, -sz*0.75 - howl); ctx.lineTo(sz*0.1, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      // Inner ear
      ctx.fillStyle = rgba(pc(2), 0.5);
      ctx.beginPath(); ctx.moveTo(-sz*0.32, -sz*0.32 - howl); ctx.lineTo(-sz*0.48, -sz*0.65 - howl); ctx.lineTo(-sz*0.16, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.32, -sz*0.32 - howl); ctx.lineTo(sz*0.48, -sz*0.65 - howl); ctx.lineTo(sz*0.16, -sz*0.4 - howl); ctx.closePath(); ctx.fill();
      // Head
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.05 - howl*0.3, sz*0.42, sz*0.45, 0, 0, Math.PI*2); ctx.fill();
      // Snout
      ctx.beginPath(); ctx.ellipse(0, sz*0.22, sz*0.28, sz*0.2, 0, 0, Math.PI*2); ctx.fill();
      // Eyes
      ctx.fillStyle = rgba(pc(1), 0.9); ctx.shadowBlur = 12; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(-sz*0.18, -sz*0.08 - howl*0.2, sz*0.09, sz*0.07, -0.2, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.18, -sz*0.08 - howl*0.2, sz*0.09, sz*0.07, 0.2, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,0.9)'; ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.arc(-sz*0.17, -sz*0.08 - howl*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(sz*0.17, -sz*0.08 - howl*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      // Nose
      ctx.fillStyle = 'rgba(20,20,20,0.9)';
      ctx.beginPath(); ctx.ellipse(0, sz*0.14, sz*0.1, sz*0.07, 0, 0, Math.PI*2); ctx.fill();
      // Teeth
      ctx.fillStyle = 'rgba(240,235,220,0.9)';
      for (let t2=0; t2<4; t2++) {
        ctx.beginPath(); ctx.moveTo(-sz*0.18 + t2*sz*0.12, sz*0.28); ctx.lineTo(-sz*0.14 + t2*sz*0.12, sz*0.42); ctx.lineTo(-sz*0.1 + t2*sz*0.12, sz*0.28); ctx.closePath(); ctx.fill();
      }
      break;
    }

    // ‚îÄ‚îÄ EAGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'eagle': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      const wingFlap = Math.sin(ph*3) * sz * 0.08 * (1 + bp*0.5);
      // Wings
      for (let side=0; side<2; side++) {
        const sx2 = side===0 ? -1 : 1;
        ctx.save(); ctx.scale(sx2, 1);
        ctx.fillStyle = rgba(pc(0), 0.85);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.bezierCurveTo(sz*0.3, -sz*0.1 - wingFlap, sz*0.8, -sz*0.3 - wingFlap, sz*1.1, -sz*0.15 - wingFlap);
        ctx.bezierCurveTo(sz*0.9, sz*0.0, sz*0.5, sz*0.1, sz*0.15, sz*0.1);
        ctx.closePath(); ctx.fill();
        // Wing feather tips
        ctx.strokeStyle = rgba(pc(1), 0.4); ctx.lineWidth = sz*0.015;
        for (let f=0; f<5; f++) {
          const fx = sz*(0.7 + f*0.08);
          const fy = -sz*(0.2 + f*0.02) - wingFlap;
          ctx.beginPath(); ctx.moveTo(fx, fy); ctx.lineTo(fx + sz*0.15, fy - sz*0.1); ctx.stroke();
        }
        ctx.restore();
      }
      // Body
      ctx.fillStyle = rgba(pc(0), 0.9);
      ctx.beginPath(); ctx.ellipse(0, sz*0.05, sz*0.18, sz*0.38, 0, 0, Math.PI*2); ctx.fill();
      // White head
      ctx.fillStyle = 'rgba(240,240,240,0.95)';
      ctx.beginPath(); ctx.arc(0, -sz*0.28, sz*0.2, 0, Math.PI*2); ctx.fill();
      // Beak
      ctx.fillStyle = 'rgba(255,200,0,0.95)';
      ctx.beginPath(); ctx.moveTo(sz*0.08, -sz*0.25); ctx.lineTo(sz*0.35, -sz*0.28); ctx.lineTo(sz*0.08, -sz*0.32); ctx.closePath(); ctx.fill();
      // Eye
      ctx.fillStyle = 'rgba(0,0,0,0.9)';
      ctx.beginPath(); ctx.arc(sz*0.08, -sz*0.3, sz*0.04, 0, Math.PI*2); ctx.fill();
      break;
    }

    // ‚îÄ‚îÄ SMILEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'smiley': {
      // Expression changes with energy: smile ‚Üí grin ‚Üí shock
      const expr = e; // 0=calm smile, 1=manic shock
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      // Face
      ctx.fillStyle = rgba(pc(1), 0.9);
      ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = rgba(pc(0), 0.8); ctx.lineWidth = sz*0.05; ctx.stroke();
      ctx.shadowBlur = 0;
      // Eyes
      const eyeOpenness = 0.5 + expr*0.5 + bp*0.3;
      ctx.fillStyle = 'rgba(0,0,0,0.9)';
      ctx.beginPath(); ctx.ellipse(-sz*0.3, -sz*0.15, sz*0.12, sz*0.12*eyeOpenness, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.3, -sz*0.15, sz*0.12, sz*0.12*eyeOpenness, 0, 0, Math.PI*2); ctx.fill();
      // Shine dots
      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.beginPath(); ctx.arc(-sz*0.24, -sz*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(sz*0.36, -sz*0.2, sz*0.04, 0, Math.PI*2); ctx.fill();
      // Mouth ‚Äî morphs from smile to O-shock
      ctx.strokeStyle = 'rgba(0,0,0,0.9)'; ctx.lineWidth = sz*0.07; ctx.lineCap = 'round';
      if (expr < 0.5) {
        // Smile
        ctx.beginPath(); ctx.arc(0, sz*0.05, sz*0.45, 0.2, Math.PI-0.2); ctx.stroke();
      } else {
        // Shock O
        const mw = sz*(0.2 + expr*0.25);
        const mh = sz*(0.15 + expr*0.3 + bp*0.15);
        ctx.beginPath(); ctx.ellipse(0, sz*0.3, mw, mh, 0, 0, Math.PI*2); ctx.stroke();
      }
      ctx.lineCap = 'butt';
      break;
    }

    // ‚îÄ‚îÄ DEMON_FACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'demon_face': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = pc(0);
      // Face
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath(); ctx.ellipse(0, 0, sz*0.65, sz*0.75, 0, 0, Math.PI*2); ctx.fill();
      // Horns
      ctx.fillStyle = rgba(pc(0), 0.92);
      ctx.beginPath(); ctx.moveTo(-sz*0.3, -sz*0.55); ctx.lineTo(-sz*0.55, -sz*1.05); ctx.lineTo(-sz*0.15, -sz*0.6); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.3, -sz*0.55); ctx.lineTo(sz*0.55, -sz*1.05); ctx.lineTo(sz*0.15, -sz*0.6); ctx.closePath(); ctx.fill();
      // Angry brows
      ctx.strokeStyle = 'rgba(0,0,0,0.9)'; ctx.lineWidth = sz*0.09; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(-sz*0.55, -sz*0.15); ctx.lineTo(-sz*0.1, sz*0.0); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sz*0.55, -sz*0.15); ctx.lineTo(sz*0.1, sz*0.0); ctx.stroke();
      // Eyes ‚Äî glowing
      ctx.fillStyle = rgba(pc(1), 0.95); ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(-sz*0.28, -sz*0.02, sz*0.14, sz*0.12 + bp*sz*0.04, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.28, -sz*0.02, sz*0.14, sz*0.12 + bp*sz*0.04, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,0.9)'; ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.arc(-sz*0.28, -sz*0.02, sz*0.07, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(sz*0.28, -sz*0.02, sz*0.07, 0, Math.PI*2); ctx.fill();
      // Fangs
      ctx.fillStyle = 'rgba(240,235,220,0.95)';
      ctx.beginPath(); ctx.moveTo(-sz*0.2, sz*0.35); ctx.lineTo(-sz*0.25, sz*0.65); ctx.lineTo(-sz*0.1, sz*0.35); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.2, sz*0.35); ctx.lineTo(sz*0.25, sz*0.65); ctx.lineTo(sz*0.1, sz*0.35); ctx.closePath(); ctx.fill();
      // Mouth
      ctx.strokeStyle = 'rgba(0,0,0,0.7)'; ctx.lineWidth = sz*0.06;
      ctx.beginPath(); ctx.arc(0, sz*0.2, sz*0.4, 0.1, Math.PI-0.1); ctx.stroke();
      break;
    }

    // ‚îÄ‚îÄ ALIEN_HEAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'alien_head': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(2);
      // Large cranium
      ctx.fillStyle = rgba(pc(2), 0.82);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.15, sz*0.55, sz*0.65, 0, 0, Math.PI*2); ctx.fill();
      // Narrow chin
      ctx.beginPath(); ctx.ellipse(0, sz*0.45, sz*0.22, sz*0.28, 0, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Huge almond eyes
      ctx.fillStyle = 'rgba(0,0,0,0.95)';
      ctx.beginPath(); ctx.ellipse(-sz*0.22, -sz*0.08, sz*0.24, sz*0.14, -0.4, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.22, -sz*0.08, sz*0.24, sz*0.14, 0.4, 0, Math.PI*2); ctx.fill();
      // Inner eye glow
      ctx.fillStyle = rgba(pc(1), 0.7 + bp*0.3); ctx.shadowBlur = 15; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(-sz*0.22, -sz*0.08, sz*0.1, sz*0.06, -0.4, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.22, -sz*0.08, sz*0.1, sz*0.06, 0.4, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Tiny nostril slits
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.fillRect(-sz*0.06, sz*0.2, sz*0.04, sz*0.08);
      ctx.fillRect(sz*0.02, sz*0.2, sz*0.04, sz*0.08);
      // Thin line mouth
      ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.lineWidth = sz*0.04;
      ctx.beginPath(); ctx.moveTo(-sz*0.15, sz*0.42); ctx.quadraticCurveTo(0, sz*0.38, sz*0.15, sz*0.42); ctx.stroke();
      break;
    }

    // ‚îÄ‚îÄ ROBOT_HEAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'robot_head': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      // Main box head
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.strokeStyle = rgba(pc(1), 0.6); ctx.lineWidth = sz*0.03;
      const rx=-sz*0.55, ry=-sz*0.62, rw=sz*1.1, rh=sz*1.1;
      ctx.beginPath(); ctx.roundRect(rx, ry, rw, rh, sz*0.08); ctx.fill(); ctx.stroke();
      // Antenna
      ctx.strokeStyle = rgba(pc(1), 0.8); ctx.lineWidth = sz*0.04;
      ctx.beginPath(); ctx.moveTo(0, ry); ctx.lineTo(0, ry-sz*0.3); ctx.stroke();
      ctx.fillStyle = rgba(pc(1), 0.9); ctx.shadowBlur = 10; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.arc(0, ry-sz*0.35, sz*0.07, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Visor screen
      const visorColor = `hsl(${(ph*60)%360},90%,${50+bp*30}%)`;
      ctx.fillStyle = visorColor;
      ctx.shadowBlur = 15+bp*20; ctx.shadowColor = visorColor;
      ctx.beginPath(); ctx.roundRect(-sz*0.42, -sz*0.45, sz*0.84, sz*0.38, sz*0.05); ctx.fill();
      ctx.shadowBlur = 0;
      // Scanline on visor
      ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = sz*0.02;
      for (let sl=0; sl<4; sl++) {
        const sy = -sz*0.42 + sl*sz*0.11;
        ctx.beginPath(); ctx.moveTo(-sz*0.42, sy); ctx.lineTo(sz*0.42, sy); ctx.stroke();
      }
      // Ear bolts
      ctx.fillStyle = rgba(pc(0), 0.7); ctx.strokeStyle = rgba(pc(1), 0.5); ctx.lineWidth = sz*0.02;
      ctx.beginPath(); ctx.rect(rx-sz*0.12, -sz*0.2, sz*0.12, sz*0.25); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.rect(sz*0.55, -sz*0.2, sz*0.12, sz*0.25); ctx.fill(); ctx.stroke();
      // Mouth grille
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.beginPath(); ctx.roundRect(-sz*0.35, sz*0.12, sz*0.7, sz*0.22, sz*0.03); ctx.fill();
      ctx.strokeStyle = rgba(pc(1), 0.4); ctx.lineWidth = sz*0.02;
      for (let g=0; g<5; g++) {
        ctx.beginPath(); ctx.moveTo(-sz*0.28+g*sz*0.14, sz*0.14); ctx.lineTo(-sz*0.28+g*sz*0.14, sz*0.32); ctx.stroke();
      }
      break;
    }

    // ‚îÄ‚îÄ PEACE_SIGN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'peace_sign': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.9); ctx.lineWidth = sz*0.1; ctx.lineCap = 'round';
      // Shatter on big beat
      if (bp > 0.7) {
        // Shattered pieces flying
        ctx.globalAlpha = 1 - (bp-0.7)*2;
        for (let seg=0; seg<6; seg++) {
          const angle = seg/6*Math.PI*2;
          const drift = (bp-0.7)*sz*2;
          ctx.save();
          ctx.translate(Math.cos(angle)*drift, Math.sin(angle)*drift);
          ctx.rotate(angle*(bp-0.7)*3);
          ctx.beginPath(); ctx.arc(0, 0, sz*0.5, angle, angle+Math.PI/3); ctx.stroke();
          ctx.restore();
        }
        ctx.globalAlpha = 1;
      } else {
        // Intact peace sign
        ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(0, sz); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-sz*0.87, sz*0.5); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(sz*0.87, sz*0.5); ctx.stroke();
      }
      ctx.lineCap = 'butt';
      break;
    }

    // ‚îÄ‚îÄ LIGHTNING_BOLT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'lightning_bolt': {
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = rgba(pc(1), 0.9);
      // Main bolt shape
      ctx.fillStyle = rgba(pc(1), 0.95);
      ctx.beginPath();
      ctx.moveTo(sz*0.2, -sz);
      ctx.lineTo(-sz*0.12, -sz*0.05);
      ctx.lineTo(sz*0.08, -sz*0.05);
      ctx.lineTo(-sz*0.2, sz);
      ctx.lineTo(sz*0.12, sz*0.05);
      ctx.lineTo(-sz*0.08, sz*0.05);
      ctx.lineTo(sz*0.2, -sz);
      ctx.closePath(); ctx.fill();
      // Branch arcs on beat
      if (bp > 0.3) {
        ctx.strokeStyle = rgba(pc(1), bp*0.7); ctx.lineWidth = sz*0.03;
        for (let b2=0; b2<3; b2++) {
          const bx = (Math.random()-0.5)*sz*0.3;
          const by = -sz*0.5 + b2*sz*0.3;
          ctx.beginPath();
          ctx.moveTo(bx, by);
          ctx.lineTo(bx + (Math.random()-0.5)*sz*0.6, by + sz*0.2);
          ctx.stroke();
        }
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ YIN_YANG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'yin_yang': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      // White half
      ctx.fillStyle = 'rgba(240,240,240,0.95)';
      ctx.beginPath(); ctx.arc(0, 0, sz, -Math.PI/2, Math.PI/2); ctx.fill();
      // Black half
      ctx.fillStyle = 'rgba(10,10,10,0.95)';
      ctx.beginPath(); ctx.arc(0, 0, sz, Math.PI/2, -Math.PI/2); ctx.fill();
      // Small white circle in black half
      ctx.fillStyle = 'rgba(240,240,240,0.95)';
      ctx.beginPath(); ctx.arc(0, sz*0.5, sz*0.25, 0, Math.PI*2); ctx.fill();
      // Small black circle in white half
      ctx.fillStyle = 'rgba(10,10,10,0.95)';
      ctx.beginPath(); ctx.arc(0, -sz*0.5, sz*0.25, 0, Math.PI*2); ctx.fill();
      // Outer ring
      ctx.strokeStyle = 'rgba(100,100,100,0.5)'; ctx.lineWidth = sz*0.04;
      ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.stroke();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ STAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'star': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = pc(1);
      ctx.fillStyle = rgba(pc(1), 0.92);
      const spikes = 5;
      ctx.beginPath();
      for (let i=0; i<spikes*2; i++) {
        const a = i/spikes*Math.PI - Math.PI/2;
        const r = i%2===0 ? sz*(1 + bp*0.25) : sz*0.4;
        i===0 ? ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r) : ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      ctx.closePath(); ctx.fill();
      // Inner glow
      ctx.fillStyle = rgba(pc(0), 0.6);
      ctx.beginPath();
      for (let i=0; i<spikes*2; i++) {
        const a = i/spikes*Math.PI - Math.PI/2;
        const r = i%2===0 ? sz*0.5 : sz*0.2;
        i===0 ? ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r) : ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      ctx.closePath(); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ DIAMOND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'diamond': case 'crystal': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = rgba(pc(2), 0.8);
      // Main gem facets
      const facetColors = [rgba(pc(0),0.9), rgba(pc(1),0.85), rgba(pc(2),0.9), rgba(pc(3),0.8)];
      // Top crown
      ctx.fillStyle = facetColors[0];
      ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(-sz*0.4, -sz*0.2); ctx.lineTo(sz*0.4, -sz*0.2); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[1];
      ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(-sz*0.7, -sz*0.2); ctx.lineTo(-sz*0.4, -sz*0.2); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[2];
      ctx.beginPath(); ctx.moveTo(0, -sz); ctx.lineTo(sz*0.7, -sz*0.2); ctx.lineTo(sz*0.4, -sz*0.2); ctx.closePath(); ctx.fill();
      // Girdle
      ctx.fillStyle = facetColors[3];
      ctx.beginPath(); ctx.moveTo(-sz*0.7, -sz*0.2); ctx.lineTo(-sz*0.4, -sz*0.2); ctx.lineTo(-sz*0.1, sz*0.1); ctx.lineTo(-sz*0.5, sz*0.1); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[0];
      ctx.beginPath(); ctx.moveTo(-sz*0.4, -sz*0.2); ctx.lineTo(sz*0.4, -sz*0.2); ctx.lineTo(sz*0.1, sz*0.1); ctx.lineTo(-sz*0.1, sz*0.1); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[1];
      ctx.beginPath(); ctx.moveTo(sz*0.4, -sz*0.2); ctx.lineTo(sz*0.7, -sz*0.2); ctx.lineTo(sz*0.5, sz*0.1); ctx.lineTo(sz*0.1, sz*0.1); ctx.closePath(); ctx.fill();
      // Pavilion (bottom)
      ctx.fillStyle = facetColors[2];
      ctx.beginPath(); ctx.moveTo(-sz*0.5, sz*0.1); ctx.lineTo(-sz*0.1, sz*0.1); ctx.lineTo(0, sz); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[3];
      ctx.beginPath(); ctx.moveTo(-sz*0.1, sz*0.1); ctx.lineTo(sz*0.1, sz*0.1); ctx.lineTo(0, sz); ctx.closePath(); ctx.fill();
      ctx.fillStyle = facetColors[0];
      ctx.beginPath(); ctx.moveTo(sz*0.1, sz*0.1); ctx.lineTo(sz*0.5, sz*0.1); ctx.lineTo(0, sz); ctx.closePath(); ctx.fill();
      // Shine
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.beginPath(); ctx.moveTo(-sz*0.1, -sz*0.7); ctx.lineTo(-sz*0.3, -sz*0.3); ctx.lineTo(sz*0.0, -sz*0.5); ctx.closePath(); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ COFFIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'coffin': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      const lidOpen = bp * sz * 0.2;
      // Body
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.strokeStyle = rgba(pc(1), 0.5); ctx.lineWidth = sz*0.04;
      ctx.beginPath();
      ctx.moveTo(-sz*0.35, -sz*0.9);
      ctx.lineTo(-sz*0.5, -sz*0.5);
      ctx.lineTo(-sz*0.5, sz*0.5);
      ctx.lineTo(-sz*0.35, sz*0.9);
      ctx.lineTo(sz*0.35, sz*0.9);
      ctx.lineTo(sz*0.5, sz*0.5);
      ctx.lineTo(sz*0.5, -sz*0.5);
      ctx.lineTo(sz*0.35, -sz*0.9);
      ctx.closePath(); ctx.fill(); ctx.stroke();
      // Cross on front
      ctx.fillStyle = rgba(pc(1), 0.7);
      ctx.fillRect(-sz*0.06, -sz*0.5, sz*0.12, sz*0.5);
      ctx.fillRect(-sz*0.22, -sz*0.28, sz*0.44, sz*0.12);
      // Lid crack / open on beat
      if (lidOpen > 0.05) {
        ctx.strokeStyle = rgba(pc(1), 0.8); ctx.lineWidth = sz*0.05;
        ctx.beginPath();
        ctx.moveTo(-sz*0.5, -sz*0.5 - lidOpen);
        ctx.lineTo(-sz*0.35, -sz*0.9 - lidOpen);
        ctx.lineTo(sz*0.35, -sz*0.9 - lidOpen);
        ctx.lineTo(sz*0.5, -sz*0.5 - lidOpen);
        ctx.stroke();
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ ASTRONAUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'astronaut': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      // Suit body
      ctx.fillStyle = 'rgba(220,220,230,0.92)';
      ctx.beginPath(); ctx.ellipse(0, sz*0.2, sz*0.52, sz*0.62, 0, 0, Math.PI*2); ctx.fill();
      // Arms
      ctx.beginPath(); ctx.ellipse(-sz*0.58, sz*0.12, sz*0.18, sz*0.38, -0.3, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(sz*0.58, sz*0.12, sz*0.18, sz*0.38, 0.3, 0, Math.PI*2); ctx.fill();
      // Helmet
      ctx.fillStyle = 'rgba(200,210,230,0.9)';
      ctx.beginPath(); ctx.arc(0, -sz*0.28, sz*0.42, 0, Math.PI*2); ctx.fill();
      // Visor
      ctx.fillStyle = rgba(pc(1), 0.7);
      ctx.shadowBlur = 10; ctx.shadowColor = pc(1);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.28, sz*0.28, sz*0.22, 0, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Visor reflection
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.beginPath(); ctx.ellipse(-sz*0.1, -sz*0.35, sz*0.1, sz*0.06, -0.4, 0, Math.PI*2); ctx.fill();
      // Backpack
      ctx.fillStyle = 'rgba(180,185,200,0.8)';
      ctx.fillRect(-sz*0.25, sz*0.0, sz*0.5, sz*0.28);
      // Flag / patch
      ctx.fillStyle = rgba(pc(0), 0.8);
      ctx.fillRect(-sz*0.42, -sz*0.08, sz*0.16, sz*0.1);
      break;
    }

    // ‚îÄ‚îÄ ROCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'rocket': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      // Body
      ctx.fillStyle = rgba(pc(0), 0.9);
      ctx.beginPath(); ctx.roundRect(-sz*0.22, -sz*0.5, sz*0.44, sz*1.1, sz*0.1); ctx.fill();
      // Nose cone
      ctx.fillStyle = rgba(pc(1), 0.9);
      ctx.beginPath(); ctx.moveTo(-sz*0.22, -sz*0.5); ctx.lineTo(0, -sz*1.0); ctx.lineTo(sz*0.22, -sz*0.5); ctx.closePath(); ctx.fill();
      // Window
      ctx.fillStyle = rgba(pc(2), 0.85); ctx.shadowBlur = 10; ctx.shadowColor = pc(2);
      ctx.beginPath(); ctx.arc(0, -sz*0.15, sz*0.16, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      // Fins
      ctx.fillStyle = rgba(pc(1), 0.8);
      ctx.beginPath(); ctx.moveTo(-sz*0.22, sz*0.4); ctx.lineTo(-sz*0.55, sz*0.75); ctx.lineTo(-sz*0.22, sz*0.6); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(sz*0.22, sz*0.4); ctx.lineTo(sz*0.55, sz*0.75); ctx.lineTo(sz*0.22, sz*0.6); ctx.closePath(); ctx.fill();
      // Exhaust flame
      const flameH = sz*(0.3 + Math.sin(ph*8)*0.1 + bp*0.25);
      for (let fl=0; fl<3; fl++) {
        const ffg = ctx.createLinearGradient(0, sz*0.6, 0, sz*0.6+flameH*(1+fl*0.3));
        ffg.addColorStop(0, fl===0?'rgba(255,200,0,0.9)':fl===1?'rgba(255,100,0,0.7)':'rgba(100,50,255,0.5)');
        ffg.addColorStop(1, 'transparent');
        ctx.fillStyle = ffg;
        ctx.beginPath(); ctx.ellipse(0, sz*0.6+flameH*(0.3+fl*0.1), sz*(0.12-fl*0.03), flameH*(0.4+fl*0.2), 0, 0, Math.PI*2); ctx.fill();
      }
      break;
    }

    // ‚îÄ‚îÄ UFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'ufo': {
      ctx.shadowBlur = sz*0.35; ctx.shadowColor = pc(2);
      // Tractor beam on beat
      if (bp > 0.2) {
        const beamGrad = ctx.createLinearGradient(0, sz*0.1, 0, sz*1.2);
        beamGrad.addColorStop(0, rgba(pc(2), bp*0.4));
        beamGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = beamGrad;
        ctx.beginPath();
        ctx.moveTo(-sz*0.3, sz*0.1);
        ctx.lineTo(-sz*0.7, sz*1.2);
        ctx.lineTo(sz*0.7, sz*1.2);
        ctx.lineTo(sz*0.3, sz*0.1);
        ctx.closePath(); ctx.fill();
      }
      // Saucer body
      ctx.fillStyle = rgba(pc(0), 0.88);
      ctx.beginPath(); ctx.ellipse(0, 0, sz*0.9, sz*0.22, 0, 0, Math.PI*2); ctx.fill();
      // Dome
      ctx.fillStyle = rgba(pc(2), 0.8);
      ctx.shadowBlur = 15; ctx.shadowColor = pc(2);
      ctx.beginPath(); ctx.ellipse(0, -sz*0.1, sz*0.42, sz*0.32, 0, Math.PI, 0); ctx.fill();
      ctx.shadowBlur = 0;
      // Lights around rim
      for (let l=0; l<8; l++) {
        const la = l/8*Math.PI*2 + ph*2;
        const lit = l%2===0;
        ctx.fillStyle = lit ? rgba(pc(l%4), 0.9) : rgba(pc(l%4), 0.3);
        if (lit) { ctx.shadowBlur = 8; ctx.shadowColor = pc(l%4); }
        ctx.beginPath(); ctx.arc(Math.cos(la)*sz*0.75, Math.sin(la)*sz*0.1, sz*0.06, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      }
      break;
    }

    // ‚îÄ‚îÄ BLACK_HOLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'black_hole': {
      // Actual accretion disk + funnel, NOT a circle
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      // Accretion disk rings
      for (let ring=8; ring>0; ring--) {
        const ri = ring/8;
        ctx.save(); ctx.scale(1, 0.3); // flatten to ellipse
        ctx.beginPath(); ctx.arc(0, 0, sz*(0.5+ri*0.7), 0, Math.PI*2);
        const dg = ctx.createRadialGradient(0,0,sz*(0.4+ri*0.6), 0,0,sz*(0.5+ri*0.7));
        dg.addColorStop(0, rgba(pc(ring%4), 0.5*(1-ri)*THEME.sceneIntensity));
        dg.addColorStop(1, 'transparent');
        ctx.fillStyle = dg; ctx.fill();
        ctx.restore();
      }
      // Spiral arms
      for (let arm=0; arm<3; arm++) {
        const aoff = arm/3*Math.PI*2 + cpRot*0.5;
        ctx.beginPath();
        for (let i=0; i<50; i++) {
          const r = sz*(0.3 + i/50 * 1.4);
          const a = aoff + i/50 * Math.PI*3;
          const x2 = Math.cos(a)*r, y2 = Math.sin(a)*r*0.3;
          i===0 ? ctx.moveTo(x2,y2) : ctx.lineTo(x2,y2);
        }
        ctx.strokeStyle = rgba(pc(arm%4), 0.4);
        ctx.lineWidth = sz*0.04; ctx.stroke();
      }
      // Event horizon (actual black)
      ctx.fillStyle = 'rgba(0,0,0,0.98)';
      ctx.beginPath(); ctx.arc(0, 0, sz*0.32, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.8); ctx.lineWidth = sz*0.06;
      ctx.beginPath(); ctx.arc(0, 0, sz*0.32, 0, Math.PI*2); ctx.stroke();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ VINYL_RECORD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'vinyl_record': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = 'rgba(0,0,0,0.5)';
      // Vinyl
      ctx.fillStyle = 'rgba(15,12,20,0.97)';
      ctx.beginPath(); ctx.arc(0, 0, sz, 0, Math.PI*2); ctx.fill();
      // Grooves
      ctx.strokeStyle = 'rgba(40,35,50,0.8)';
      for (let g=3; g<10; g++) {
        ctx.lineWidth = sz*0.025;
        ctx.beginPath(); ctx.arc(0, 0, sz*(g/10), 0, Math.PI*2); ctx.stroke();
      }
      // Label
      const lg = ctx.createRadialGradient(-sz*0.1, -sz*0.1, 0, 0, 0, sz*0.35);
      lg.addColorStop(0, rgba(pc(1), 0.95));
      lg.addColorStop(1, rgba(pc(0), 0.85));
      ctx.fillStyle = lg;
      ctx.beginPath(); ctx.arc(0, 0, sz*0.35, 0, Math.PI*2); ctx.fill();
      // Center hole
      ctx.fillStyle = 'rgba(0,0,0,0.95)';
      ctx.beginPath(); ctx.arc(0, 0, sz*0.06, 0, Math.PI*2); ctx.fill();
      // Scratch effect on beat
      if (bp > 0.5) {
        ctx.strokeStyle = rgba(pc(0), (bp-0.5)*1.5);
        ctx.lineWidth = sz*0.03;
        ctx.beginPath(); ctx.arc(0, 0, sz*0.7, -0.3, 0.3); ctx.stroke();
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ DISCO_BALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'disco_ball': {
      // Draw the ball AND cast beams across the scene
      const rows=14, cols=18;
      ctx.shadowBlur = 5;
      for (let r=0; r<rows; r++) for (let c=0; c<cols; c++) {
        const lat=(r/rows-0.5)*Math.PI, lon=c/cols*Math.PI*2+cpRot*3;
        const tx=Math.cos(lat)*Math.cos(lon)*sz, ty=Math.sin(lat)*sz, tz=Math.cos(lat)*Math.sin(lon);
        if(tz<0.05) continue;
        const tsz=(5+tz*5)*(1+bp*0.2);
        const bright = 0.3+Math.abs(Math.sin(lon+cpRot*2+lat))*0.7;
        ctx.fillStyle = rgba(pc((r+c)%4), bright*(0.5+tz*0.5));
        ctx.shadowColor = pc((r+c)%4);
        ctx.fillRect(tx-tsz/2, ty-tsz/2, tsz, tsz);
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ SUN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'sun': {
      // Actual rays radiating out
      ctx.shadowBlur = sz*0.5; ctx.shadowColor = rgba(pc(1),0.8);
      for (let r=0; r<18; r++) {
        const a = r/18*Math.PI*2;
        const rLen = sz*(1.1+Math.sin(ph*2+r*0.7)*0.18+bp*0.22);
        const rW = sz*(0.04+Math.sin(ph+r)*0.02);
        ctx.save(); ctx.rotate(a);
        const rayG = ctx.createLinearGradient(0, sz*0.8, 0, rLen);
        rayG.addColorStop(0, rgba(pc(1),0.7)); rayG.addColorStop(1,'transparent');
        ctx.fillStyle = rayG;
        ctx.fillRect(-rW, sz*0.8, rW*2, rLen - sz*0.8);
        ctx.restore();
      }
      // Corona glow
      const cg = ctx.createRadialGradient(0,0,sz*0.7,0,0,sz*1.5);
      cg.addColorStop(0, rgba(pc(1),0.15)); cg.addColorStop(1,'transparent');
      ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(0,0,sz*1.5,0,Math.PI*2); ctx.fill();
      // Disc
      const sg = ctx.createRadialGradient(-sz*0.25,-sz*0.25,0,0,0,sz);
      sg.addColorStop(0,'rgba(255,255,220,1)');
      sg.addColorStop(0.4,rgba(pc(1),0.9));
      sg.addColorStop(1,rgba(pc(0),0.6));
      ctx.fillStyle = sg; ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ MOON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'moon': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = rgba(pc(2),0.7);
      // Moon disc
      ctx.fillStyle = 'rgba(220,218,240,0.95)';
      ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      // Craters
      const craters = [{x:-sz*0.3,y:-sz*0.2,r:sz*0.14},{x:sz*0.25,y:sz*0.1,r:sz*0.2},{x:-sz*0.05,y:sz*0.35,r:sz*0.1},{x:sz*0.1,y:-sz*0.42,r:sz*0.09}];
      for (const cr of craters) {
        ctx.fillStyle = 'rgba(170,165,195,0.6)';
        ctx.beginPath(); ctx.arc(cr.x,cr.y,cr.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(195,192,215,0.4)';
        ctx.beginPath(); ctx.arc(cr.x-cr.r*0.2,cr.y-cr.r*0.2,cr.r*0.6,0,Math.PI*2); ctx.fill();
      }
      // Shadow cutout ‚Äî makes it crescent
      ctx.fillStyle = rgba(THEME.bgColor, 0.9);
      ctx.beginPath(); ctx.arc(sz*0.32, 0, sz*0.82, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ COMET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'comet': {
      ctx.shadowBlur = sz*0.4; ctx.shadowColor = rgba(pc(1),0.8);
      // Tail ‚Äî tapers behind
      for (let tail=0; tail<12; tail++) {
        const tFrac = tail/12;
        const tailG = ctx.createLinearGradient(-sz*0.3-tFrac*sz*2.5,0,0,0);
        tailG.addColorStop(0,'transparent');
        tailG.addColorStop(1, rgba(pc(tail%4), 0.35*(1-tFrac)));
        ctx.fillStyle = tailG;
        ctx.beginPath();
        ctx.ellipse(-sz*0.3-tFrac*sz*1.5, (Math.sin(tail*0.8+ph)*sz*0.04), sz*(0.8+tFrac*1.2), sz*(0.06+tFrac*0.22+bp*0.05), 0, 0, Math.PI*2);
        ctx.fill();
      }
      // Debris particles in tail
      for (let d=0; d<8; d++) {
        ctx.fillStyle = rgba(pc(d%4), 0.5);
        ctx.beginPath();
        ctx.arc(-sz*(0.5+d*0.3)+Math.sin(ph+d)*sz*0.08, (Math.sin(d*1.7+ph)*sz*0.12), sz*0.04, 0, Math.PI*2);
        ctx.fill();
      }
      // Head ‚Äî bright nucleus
      const hg = ctx.createRadialGradient(-sz*0.05,-sz*0.05,0,0,0,sz*0.38);
      hg.addColorStop(0,'rgba(255,255,230,1)');
      hg.addColorStop(0.5,rgba(pc(1),0.9));
      hg.addColorStop(1,rgba(pc(0),0.4));
      ctx.fillStyle = hg;
      ctx.beginPath(); ctx.arc(0,0,sz*0.38,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ SKULL_CROSSBONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'skull_crossbones': {
      // Two crossed bones behind skull
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.75); ctx.lineWidth = sz*0.14; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(-sz*0.65, sz*0.8); ctx.lineTo(sz*0.65, sz*0.1); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sz*0.65, sz*0.8); ctx.lineTo(-sz*0.65, sz*0.1); ctx.stroke();
      ctx.lineCap = 'butt';
      // Skull on top
      ctx.save(); ctx.translate(0, -sz*0.1); ctx.scale(0.8,0.8); drawCP(ctx,'skull',sz,t); ctx.restore();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ TRIDENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'trident': {
      ctx.shadowBlur = sz*0.35; ctx.shadowColor = pc(0);
      ctx.fillStyle = rgba(pc(0), 0.9);
      ctx.strokeStyle = rgba(pc(0), 0.9);
      // Shaft
      ctx.lineWidth = sz*0.1; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(0, sz); ctx.lineTo(0, -sz*0.3); ctx.stroke();
      // Center prong
      ctx.beginPath(); ctx.moveTo(0, -sz*0.3); ctx.lineTo(0, -sz); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(-sz*0.08, -sz*0.7); ctx.lineTo(sz*0.08, -sz*0.7); ctx.lineTo(sz*0.08, -sz*0.8); ctx.lineTo(0, -sz); ctx.lineTo(-sz*0.08, -sz*0.8); ctx.lineTo(-sz*0.08, -sz*0.7); ctx.closePath(); ctx.fill();
      // Side prongs
      ctx.lineWidth = sz*0.07;
      for (const sx3 of [-1, 1]) {
        ctx.beginPath(); ctx.moveTo(sz*0.3*sx3, -sz*0.3); ctx.lineTo(sz*0.42*sx3, -sz*0.85); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(sz*(0.36+0.05*sx3), -sz*0.6);
        ctx.lineTo(sz*(0.45+0.05*sx3), -sz*0.85);
        ctx.lineTo(sz*(0.3*sx3), -sz*0.78);
        ctx.closePath(); ctx.fill();
      }
      // Cross guard
      ctx.lineWidth = sz*0.09;
      ctx.beginPath(); ctx.moveTo(-sz*0.45, -sz*0.22); ctx.lineTo(sz*0.45, -sz*0.22); ctx.stroke();
      ctx.lineCap = 'butt'; ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ LOTUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'lotus': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      // Outer petals
      for (let layer=0; layer<3; layer++) {
        const petals = 8 - layer*2;
        const openAngle = (0.3 + songProg*0.4 + bp*0.15) * (1 - layer*0.2);
        for (let p=0; p<petals; p++) {
          const a = p/petals*Math.PI*2;
          ctx.save(); ctx.rotate(a + cpRot*0.1*layer);
          ctx.fillStyle = rgba(pc((layer+p)%4), 0.7 - layer*0.1);
          ctx.beginPath();
          ctx.moveTo(0, 0);
          const pr = sz*(0.5+layer*0.15);
          ctx.bezierCurveTo(-sz*0.12, -pr*0.3, -sz*0.08+Math.sin(ph)*sz*0.02, -pr, 0, -pr*(1+openAngle));
          ctx.bezierCurveTo(sz*0.08+Math.sin(ph)*sz*0.02, -pr, sz*0.12, -pr*0.3, 0, 0);
          ctx.closePath(); ctx.fill();
          ctx.restore();
        }
      }
      // Center
      const cgg = ctx.createRadialGradient(0,0,0,0,0,sz*0.2);
      cgg.addColorStop(0, rgba(pc(1),0.95)); cgg.addColorStop(1, rgba(pc(0),0.7));
      ctx.fillStyle = cgg; ctx.beginPath(); ctx.arc(0,0,sz*0.2,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ EYE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'eye': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      // Whites
      ctx.fillStyle = 'rgba(240,238,235,0.97)';
      ctx.beginPath();
      ctx.moveTo(-sz, 0);
      ctx.bezierCurveTo(-sz*0.5, -sz*0.55, sz*0.5, -sz*0.55, sz, 0);
      ctx.bezierCurveTo(sz*0.5, sz*0.55, -sz*0.5, sz*0.55, -sz, 0);
      ctx.closePath(); ctx.fill();
      // Iris
      const irisR = sz*(0.36 + bp*0.06);
      const irisg = ctx.createRadialGradient(0,0,0,0,0,irisR);
      irisg.addColorStop(0, rgba(pc(1),1)); irisg.addColorStop(0.7, rgba(pc(0),0.9)); irisg.addColorStop(1, rgba(pc(0),0.6));
      ctx.fillStyle = irisg;
      ctx.beginPath(); ctx.arc(0,0,irisR,0,Math.PI*2); ctx.fill();
      // Pupil ‚Äî dilates with energy
      const pupilR = sz*(0.16 + e*0.12);
      ctx.fillStyle = 'rgba(0,0,0,0.97)';
      ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.arc(0,0,pupilR,0,Math.PI*2); ctx.fill();
      // Reflection
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.beginPath(); ctx.arc(-pupilR*0.4,-pupilR*0.5,pupilR*0.35,0,Math.PI*2); ctx.fill();
      // Eyelid outline
      ctx.strokeStyle = 'rgba(80,60,50,0.5)'; ctx.lineWidth = sz*0.04;
      ctx.beginPath();
      ctx.moveTo(-sz, 0);
      ctx.bezierCurveTo(-sz*0.5, -sz*0.55, sz*0.5, -sz*0.55, sz, 0);
      ctx.stroke();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ ANKH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'ankh': {
      ctx.shadowBlur = sz*0.25; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0), 0.92); ctx.lineWidth = sz*0.13; ctx.lineCap = 'round';
      // Vertical
      ctx.beginPath(); ctx.moveTo(0, -sz*0.1); ctx.lineTo(0, sz); ctx.stroke();
      // Horizontal
      ctx.beginPath(); ctx.moveTo(-sz*0.55, sz*0.18); ctx.lineTo(sz*0.55, sz*0.18); ctx.stroke();
      // Loop
      ctx.lineWidth = sz*0.1;
      ctx.beginPath(); ctx.ellipse(0, -sz*0.48, sz*0.38, sz*0.44, 0, 0, Math.PI*2); ctx.stroke();
      ctx.lineCap = 'butt'; ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ MANDALA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'mandala': {
      for (let layer=0; layer<7; layer++) {
        const r = sz*(0.12+layer*0.13);
        const petals = 6+layer*2;
        for (let p=0; p<petals; p++) {
          const a = p/petals*Math.PI*2 + cpRot*(1-layer*0.08);
          ctx.save(); ctx.rotate(a);
          ctx.fillStyle = rgba(pc((layer+p)%4), (0.45-layer*0.04)*THEME.sceneIntensity*(1+bp*0.2));
          ctx.beginPath(); ctx.ellipse(r,0,r*0.38,r*0.11,0,0,Math.PI*2); ctx.fill();
          ctx.restore();
        }
      }
      ctx.fillStyle = rgba(pc(0),0.9); ctx.shadowBlur=15; ctx.shadowColor=pc(0);
      ctx.beginPath(); ctx.arc(0,0,sz*0.1,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
      break;
    }

    // ‚îÄ‚îÄ DNA_HELIX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'dna_helix': {
      const segs=24;
      for (let strand=0; strand<2; strand++) for (let i=0; i<segs-1; i++) {
        const y1=i/segs*sz*2-sz, y2=(i+1)/segs*sz*2-sz;
        const x1=Math.cos(i/segs*Math.PI*4+cpRot+(strand/2)*Math.PI)*sz*0.42;
        const x2=Math.cos((i+1)/segs*Math.PI*4+cpRot+(strand/2)*Math.PI)*sz*0.42;
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
        ctx.strokeStyle=rgba(pc((strand*2+i)%4),0.85);
        ctx.lineWidth=sz*0.05; ctx.shadowBlur=6; ctx.shadowColor=pc(strand%4); ctx.stroke(); ctx.shadowBlur=0;
      }
      for (let i=0; i<segs; i++) {
        const y=i/segs*sz*2-sz;
        const x1=Math.cos(i/segs*Math.PI*4+cpRot)*sz*0.42;
        const x2=Math.cos(i/segs*Math.PI*4+cpRot+Math.PI)*sz*0.42;
        ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y);
        ctx.strokeStyle=rgba(pc(i%4),0.35); ctx.lineWidth=sz*0.025; ctx.stroke();
        // Nucleotide dots
        if (i%3===0) {
          ctx.fillStyle = rgba(pc(i%4),0.7);
          ctx.beginPath(); ctx.arc(x1,y,sz*0.04,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(x2,y,sz*0.04,0,Math.PI*2); ctx.fill();
        }
      }
      break;
    }

    // ‚îÄ‚îÄ TESSERACT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'tesseract': {
      const draw3DBox=(scale,al,ci)=>{
        const pts=[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]].map(([px,py,pz])=>{
          const rx=px*Math.cos(cpRot)-pz*Math.sin(cpRot),rz2=px*Math.sin(cpRot)+pz*Math.cos(cpRot);
          const ry=py*Math.cos(cpRot*0.7)-rz2*Math.sin(cpRot*0.7),rz3=py*Math.sin(cpRot*0.7)+rz2*Math.cos(cpRot*0.7);
          return{x:rx*sz*scale/(rz3+3)*3,y:ry*sz*scale/(rz3+3)*3};
        });
        [[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]].forEach(([a,b])=>{
          ctx.beginPath(); ctx.moveTo(pts[a].x,pts[a].y); ctx.lineTo(pts[b].x,pts[b].y);
          ctx.strokeStyle=rgba(pc(ci),al); ctx.lineWidth=sz*0.03; ctx.stroke();
        });
      };
      ctx.shadowBlur=12; ctx.shadowColor=pc(0);
      draw3DBox(0.4,0.95,0); draw3DBox(0.8,0.55,1); draw3DBox(1.2,0.28,2);
      ctx.shadowBlur=0;
      break;
    }

    // ‚îÄ‚îÄ HOURGLASS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'hourglass': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      ctx.fillStyle = rgba(pc(0), 0.35); ctx.strokeStyle = rgba(pc(0), 0.85); ctx.lineWidth = sz*0.04;
      // Top half
      ctx.beginPath(); ctx.moveTo(-sz*0.5,-sz); ctx.lineTo(sz*0.5,-sz); ctx.lineTo(0,0); ctx.closePath(); ctx.fill(); ctx.stroke();
      // Bottom half
      ctx.beginPath(); ctx.moveTo(-sz*0.5,sz); ctx.lineTo(sz*0.5,sz); ctx.lineTo(0,0); ctx.closePath(); ctx.fill(); ctx.stroke();
      // Sand
      ctx.fillStyle = rgba(pc(1), 0.85);
      ctx.fillRect(-sz*0.38*(1-songProg), -sz*(0.95-songProg*0.05), sz*0.76*(1-songProg), sz*(0.9-songProg*0.85));
      ctx.fillStyle = rgba(pc(2), 0.75);
      ctx.fillRect(-sz*0.38*songProg, sz*0.05, sz*0.76*songProg, sz*0.88*songProg);
      // Falling grain
      if (songProg < 0.98) {
        ctx.fillStyle = rgba(pc(1), 0.7);
        for (let g=0; g<3; g++) ctx.fillRect(Math.sin(ph*7+g)*sz*0.04 - sz*0.01, sz*(0.0+g*0.05), sz*0.025, sz*0.06);
      }
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ CROWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'crown': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(1);
      ctx.fillStyle = rgba(pc(1), 0.9);
      // Base band
      ctx.fillRect(-sz*0.75, sz*0.05, sz*1.5, sz*0.4);
      // 5 points
      const heights = [0.55, 0.38, 0.7, 0.38, 0.55];
      for (let p=0; p<5; p++) {
        const px2 = -sz*0.75 + p*sz*0.375;
        ctx.beginPath();
        ctx.moveTo(px2, sz*0.05);
        ctx.lineTo(px2 + sz*0.1875, -sz*heights[p]*(1+bp*0.08));
        ctx.lineTo(px2 + sz*0.375, sz*0.05);
        ctx.closePath(); ctx.fill();
      }
      ctx.shadowBlur = 0;
      // Jewels
      for (let j=0; j<5; j++) {
        ctx.fillStyle = rgba(pc(j%4), 0.95);
        ctx.shadowBlur = 8; ctx.shadowColor = pc(j%4);
        ctx.beginPath(); ctx.arc(-sz*0.56+j*sz*0.28, sz*0.24, sz*(0.07+bp*0.03), 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      }
      break;
    }

    // ‚îÄ‚îÄ CLOCK_FACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'clock_face': {
      ctx.shadowBlur = sz*0.15; ctx.shadowColor = pc(0);
      ctx.fillStyle = 'rgba(240,235,220,0.93)';
      ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = rgba(pc(0),0.75); ctx.lineWidth = sz*0.045; ctx.stroke();
      ctx.shadowBlur = 0;
      for (let hr=0; hr<12; hr++) {
        const ha = hr/12*Math.PI*2-Math.PI/2;
        ctx.beginPath(); ctx.moveTo(Math.cos(ha)*sz*0.8, Math.sin(ha)*sz*0.8); ctx.lineTo(Math.cos(ha)*sz*0.92, Math.sin(ha)*sz*0.92);
        ctx.strokeStyle = rgba(pc(0),0.8); ctx.lineWidth = hr%3===0?sz*0.06:sz*0.03; ctx.stroke();
      }
      const ha2 = cpPh*0.1-Math.PI/2, ma = cpPh-Math.PI/2, sa = cpPh*10-Math.PI/2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = rgba(pc(0),0.9); ctx.lineWidth=sz*0.07;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ha2)*sz*0.55, Math.sin(ha2)*sz*0.55); ctx.stroke();
      ctx.lineWidth = sz*0.05;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ma)*sz*0.75, Math.sin(ma)*sz*0.75); ctx.stroke();
      ctx.strokeStyle = rgba(pc(2),0.9); ctx.lineWidth = sz*0.025;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(sa)*sz*0.85, Math.sin(sa)*sz*0.85); ctx.stroke();
      ctx.lineCap = 'butt';
      ctx.fillStyle = rgba(pc(0),1); ctx.beginPath(); ctx.arc(0,0,sz*0.05,0,Math.PI*2); ctx.fill();
      break;
    }

    // ‚îÄ‚îÄ TURNTABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'turntable': {
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = 'rgba(0,0,0,0.5)';
      // Deck body
      ctx.fillStyle = 'rgba(25,22,30,0.95)';
      ctx.beginPath(); ctx.roundRect(-sz,-sz*0.65,sz*2,sz*1.3,sz*0.08); ctx.fill();
      ctx.strokeStyle = rgba(pc(0),0.5); ctx.lineWidth = sz*0.03; ctx.stroke();
      // Platter
      ctx.fillStyle = 'rgba(40,35,50,0.95)';
      ctx.beginPath(); ctx.arc(sz*0.05,sz*0.05,sz*0.7,0,Math.PI*2); ctx.fill();
      // Record on platter
      ctx.save(); ctx.translate(sz*0.05,sz*0.05);
      drawCP(ctx, 'vinyl_record', sz*0.65, t);
      ctx.restore();
      // Tonearm
      ctx.save();
      ctx.translate(sz*0.7, -sz*0.45);
      ctx.rotate(cpPh*0.05 - 0.5);
      ctx.strokeStyle = 'rgba(180,170,150,0.9)'; ctx.lineWidth = sz*0.04; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-sz*1.2, sz*0.9); ctx.stroke();
      ctx.fillStyle = 'rgba(200,190,160,0.9)';
      ctx.beginPath(); ctx.arc(0,0,sz*0.08,0,Math.PI*2); ctx.fill();
      ctx.lineCap = 'butt'; ctx.restore();
      ctx.shadowBlur = 0;
      break;
    }

    // ‚îÄ‚îÄ PLANET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'planet': {
      // Planet with rings AND surface features ‚Äî clearly different from sun
      ctx.shadowBlur = sz*0.2; ctx.shadowColor = pc(0);
      const pg = ctx.createRadialGradient(-sz*0.3,-sz*0.3,0,0,0,sz);
      pg.addColorStop(0,rgba(pc(2),1)); pg.addColorStop(0.5,rgba(pc(0),0.85)); pg.addColorStop(1,rgba(pc(1),0.5));
      ctx.fillStyle = pg; ctx.beginPath(); ctx.arc(0,0,sz,0,Math.PI*2); ctx.fill();
      // Surface bands
      for (let band=0; band<5; band++) {
        const by = -sz*0.7 + band*sz*0.35;
        ctx.fillStyle = rgba(pc((band+1)%4), 0.15);
        ctx.beginPath(); ctx.ellipse(0, by, sz*Math.sqrt(1-(by/sz)*(by/sz))*0.98, sz*0.06, 0, 0, Math.PI*2); ctx.fill();
      }
      // Storm spot
      ctx.fillStyle = rgba(pc(3), 0.35);
      ctx.beginPath(); ctx.ellipse(sz*0.25, sz*0.1, sz*0.2, sz*0.14, 0.3, 0, Math.PI*2); ctx.fill();
      // Rings
      ctx.save(); ctx.scale(1,0.25);
      for (let ri=0; ri<4; ri++) {
        ctx.beginPath(); ctx.arc(0,0,sz*(1.3+ri*0.2),0,Math.PI*2);
        ctx.strokeStyle = rgba(pc((ri+2)%4),0.3-ri*0.06); ctx.lineWidth = 8+ri*3; ctx.stroke();
      }
      ctx.restore(); ctx.shadowBlur=0;
      break;
    }

    // ‚îÄ‚îÄ WORMHOLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'wormhole': {
      // Funnel + spiral, NOT just concentric circles
      for (let ring=12; ring>0; ring--) {
        ctx.save(); ctx.scale(1, 0.5+ring*0.04);
        ctx.beginPath(); ctx.arc(0,0,sz*(ring/12)*(1+bp*0.05),0,Math.PI*2);
        ctx.strokeStyle = rgba(pc(ring%4),0.5*(ring/12)+bp*0.1);
        ctx.lineWidth = sz*0.04; ctx.stroke(); ctx.restore();
      }
      // Spiral
      ctx.beginPath();
      for (let i=0; i<100; i++) {
        const r=sz*(1-i/100)*0.9, a=i/100*Math.PI*8+cpRot;
        i===0?ctx.moveTo(Math.cos(a)*r,Math.sin(a)*r*0.5):ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r*0.5);
      }
      ctx.strokeStyle=rgba(pc(0),0.4); ctx.lineWidth=sz*0.025; ctx.stroke();
      // Black void center
      const pvg=ctx.createRadialGradient(0,0,0,0,0,sz*0.35);
      pvg.addColorStop(0,'rgba(0,0,0,1)'); pvg.addColorStop(0.7,rgba(pc(0),0.4)); pvg.addColorStop(1,'transparent');
      ctx.fillStyle=pvg; ctx.beginPath(); ctx.arc(0,0,sz*0.45,0,Math.PI*2); ctx.fill();
      break;
    }

    // ‚îÄ‚îÄ CHANDELIER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 'chandelier': {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.strokeStyle = rgba(pc(0),0.85); ctx.lineWidth = sz*0.04;
      // Central stem
      ctx.beginPath(); ctx.moveTo(0,-sz*0.9); ctx.lineTo(0,sz*0.3); ctx.stroke();
      // Arms radiating out
      for (let arm=0; arm<6; arm++) {
        const a = arm/6*Math.PI*2 + cpRot*0.3;
        const ax = Math.cos(a)*sz*0.7, ay = Math.sin(a)*sz*0.2 - sz*0.1;
        ctx.beginPath(); ctx.moveTo(0,sz*0.05); ctx.quadraticCurveTo(Math.cos(a)*sz*0.35,ay*0.5,ax,ay); ctx.stroke();
        // Hanging crystal drops
        ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(ax,ay+sz*0.2); ctx.strokeStyle = rgba(pc(arm%4),0.5); ctx.lineWidth=sz*0.015; ctx.stroke();
        ctx.fillStyle = rgba(pc(arm%4),0.88); ctx.shadowBlur=10; ctx.shadowColor=pc(arm%4);
        ctx.beginPath(); ctx.moveTo(ax,ay+sz*0.2); ctx.lineTo(ax-sz*0.04,ay+sz*0.25); ctx.lineTo(ax,ay+sz*0.35); ctx.lineTo(ax+sz*0.04,ay+sz*0.25); ctx.closePath(); ctx.fill();
        ctx.shadowBlur=0; ctx.strokeStyle=rgba(pc(0),0.85); ctx.lineWidth=sz*0.04;
      }
      // Central cluster
      ctx.fillStyle=rgba(pc(1),0.85); ctx.shadowBlur=15; ctx.shadowColor=pc(1);
      ctx.beginPath(); ctx.arc(0,sz*0.3,sz*0.12,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
      break;
    }

    // Fallback for unknown names ‚Äî crystal/gem shape
    default: {
      ctx.shadowBlur = sz*0.3; ctx.shadowColor = pc(0);
      ctx.fillStyle = rgba(pc(0), 0.85);
      ctx.beginPath();
      for (let i=0; i<6; i++) {
        const a = i/6*Math.PI*2;
        const r = i%2===0 ? sz : sz*0.55;
        i===0 ? ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r) : ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      ctx.closePath(); ctx.fill(); ctx.shadowBlur=0;
    }
  }
  ctx.restore();
}

// ‚îÄ‚îÄ Position/behavior wrapper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawCPWithBehavior(ctx, t) {
  if (!THEME.centerpiece || THEME.centerpieceScale === 0) return;
  const w=W(), h=H();
  const baseCX = w*(THEME.centerpieceX||0.5);
  const baseCY = h*(THEME.centerpieceY||0.5);
  const sz = Math.min(w,h) * THEME.centerpieceScale * 0.38;
  cpPh += 0.013;

  let posX=baseCX, posY=baseCY, alpha=1;
  switch(THEME.centerpieceBehavior) {
    case 'spin_fast': cpRot+=0.09*(1+SM.energy); break;
    case 'pulse_beat': cpRot+=0.005; break;
    case 'orbit_slow': cpOrbit+=0.007; break;
    case 'strobe':  cpRot+=0.04; if(SM.beatPulse<0.3) return; break;
    case 'bounce':
      cpRot+=0.02;
      cpBounceX+=cpBounceVX*(1+SM.energy*0.3);
      cpBounceY+=cpBounceVY*(1+SM.energy*0.3);
      if(Math.abs(cpBounceX)>w*0.38){cpBounceVX*=-1;}
      if(Math.abs(cpBounceY)>h*0.32){cpBounceVY*=-1;}
      posX=baseCX+cpBounceX; posY=baseCY+cpBounceY; break;
    case 'drift':
      cpRot+=0.007;
      posX=baseCX+Math.sin(t*0.0004)*w*0.18;
      posY=baseCY+Math.cos(t*0.0003)*h*0.13; break;
    case 'watermark':
      cpRot+=0.002;
      alpha=0.06+Math.sin(cpPh*0.25)*0.025; break;
    case 'rise_set':
      cpRot+=0.01;
      posY=baseCY+Math.sin(t*0.00008)*h*0.15; break;
    case 'breathe':
      cpRot+=0.008; break;
    default: cpRot+=0.012*(1+SM.energy*0.15);
  }

  const pulseSz = THEME.centerpieceBehavior==='pulse_beat' ? sz*(1+SM.beatPulse*0.35) :
                  THEME.centerpieceBehavior==='breathe' ? sz*(1+Math.sin(cpPh*0.4)*0.1) : sz;
  const orbX = THEME.centerpieceBehavior==='orbit_slow' ? Math.cos(cpOrbit)*w*0.14 : 0;
  const orbY = THEME.centerpieceBehavior==='orbit_slow' ? Math.sin(cpOrbit)*h*0.08 : 0;

  if (pulseSz < 2) return;
  ctx.save();
  ctx.globalAlpha = alpha;
  if (beatFX.slamS > 1.002) {
    ctx.translate(w/2,h/2); ctx.scale(beatFX.slamS,beatFX.slamS); ctx.translate(-w/2,-h/2);
  }
  ctx.translate(posX+orbX, posY+orbY);
  ctx.rotate(cpRot);
  drawCP(ctx, THEME.centerpiece, pulseSz, t);
  ctx.restore();
}

// ‚îÄ‚îÄ Mini version for scene integrations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawCPMini(ctx, name, x, y, sz, rotation) {
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(rotation || 0);
  drawCP(ctx, name, sz, cpPh*100);
  ctx.restore();
}




// ‚ïê‚ïê MODULE: surprise.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê SURPRISE SYSTEM ‚Äî 12‚Äì15 second multi-wave events ‚ïê‚ïê‚ïê





// flash and sequence are core primitives used by all surprise variants
function flash(color, ms) {
  const o = document.getElementById('surpriseOverlay');
  o.style.background = color; o.style.transition = 'opacity 0.08s'; o.style.opacity = '1';
  setTimeout(() => { o.style.transition = `opacity ${ms}ms ease`; o.style.opacity = '0'; }, 100);
}

function sequence(events) { events.forEach(([delay, fn]) => setTimeout(fn, delay)); }

function fireSurprise(forcedVariant){
  if(forcedVariant==null&&!midShifted&&Math.random()<0.05&&songProg>0.3&&songProg<0.75){
    midShifted=true;
    const f=getForbidCPs(),pool=ALL_SCENES.filter(s=>s!==THEME.scene);
    const newScene=rndEl(pool);
    const savedScene=THEME.scene,savedCP=THEME.centerpiece;
    setTimeout(()=>{THEME.scene=newScene;initScene();
      setTimeout(()=>{THEME.scene=savedScene;initScene();THEME.centerpiece=savedCP;},11000);},400);
    return;
  }
  const sc=THEME.scene;
  const variant=forcedVariant!=null?forcedVariant:Math.floor(Math.random()*3); // up to 3 variants per scene

  if(sc==='WARP_SPEED'){
    if(variant===0){
      // Hyperspeed ‚Äî centerpiece rushes to fill screen
      sequence([[0,()=>{beatFX.speedBoost=6;flash('rgba(255,255,255,0.3)',300);}],[500,()=>{beatFX.speedBoost=10;flash(rgba(pc(0),0.4),200);}],[1500,()=>{flash('rgba(255,255,255,0.8)',150);}],[2000,()=>{beatFX.speedBoost=4;}],[5000,()=>{beatFX.speedBoost=0;}]]);
    } else if(variant===1){
      // Asteroid field
      sequence([[0,()=>{flash(rgba(pc(1),0.5),400);for(let i=0;i<15;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.7;},i*200);}],[3000,()=>{beatFX.speedBoost=3;}],[7000,()=>{beatFX.speedBoost=0;}]]);
    } else {
      sequence([[0,()=>{beatFX.speedBoost=8;flash('rgba(0,0,0,0.95)',50);}],[100,()=>{flash(rgba(pc(0),0.9),100);}],[200,()=>{flash(rgba(pc(1),0.8),200);}],[500,()=>{beatFX.speedBoost=12;}],[2000,()=>{beatFX.speedBoost=3;}],[8000,()=>{beatFX.speedBoost=0;}]]);
    }
  }
  else if(sc==='LAVA_WORLD'){
    if(variant===0){
      // Mega eruption ‚Äî lava balls swarm the sky
      sequence([[0,()=>{flash(rgba(pc(0),0.7),400);fireLavaBalls();fireLavaBalls();}],[600,()=>{fireLavaBalls();flash(rgba(pc(1),0.5),300);}],[1200,()=>{fireLavaBalls();fireLavaBalls();}],[2000,()=>{flash('rgba(255,100,0,0.4)',800);if(SD.embers)SD.embers.forEach(e=>e.vy*=5);}],[3500,()=>{fireLavaBalls();}],[5000,()=>{fireLavaBalls();fireLavaBalls();}],[8000,()=>{if(SD.embers)SD.embers.forEach(e=>e.vy/=5);}]]);
    } else if(variant===1){
      // Lava floor rises ‚Äî screen floods orange then recedes
      sequence([[0,()=>{flash('rgba(255,80,0,0.5)',500);}],[500,()=>{flash('rgba(255,120,0,0.6)',800);}],[1000,()=>{flash('rgba(255,60,0,0.8)',400);fireLavaBalls();fireLavaBalls();fireLavaBalls();}],[2500,()=>{flash('rgba(200,40,0,0.5)',1500);}],[5000,()=>{fireLavaBalls();fireLavaBalls();}],[9000,()=>{}]]);
    } else {
      // Double volcano eruption
      sequence([[0,()=>{fireLavaBalls();flash(rgba(pc(0),0.6),300);}],[300,()=>{fireLavaBalls();}],[700,()=>{fireLavaBalls();fireLavaBalls();}],[1500,()=>{flash('rgba(255,80,0,0.7)',200);}],[2000,()=>{fireLavaBalls();fireLavaBalls();fireLavaBalls();}],[4000,()=>{fireLavaBalls();fireLavaBalls();}],[7000,()=>{fireLavaBalls();}]]);
    }
  }
  else if(sc==='DEEP_SEA'){
    if(variant===0){
      // Bioluminescent Bloom ‚Äî all creatures/plankton glow massively 30s + light pulse waves
      sequence([[0,()=>{if(SD.deepSea){SD.deepSea.superVibrant=true;SD.deepSea.superVibrantTimer=30000;SD.deepSea.creatures.forEach(c=>{c.active=true;c.targetAlpha=1;});SD.deepSea.bloomPulses=[];}flash(rgba(pc(0),0.5),400);}],[500,()=>{flash(rgba(pc(1),0.4),200);}],[2000,()=>{flash(rgba(pc(2),0.5),200);}],[4000,()=>{flash(rgba(pc(0),0.4),300);}],[6000,()=>{flash(rgba(pc(1),0.3),200);}],[10000,()=>{flash(rgba(pc(3),0.3),200);}]]);
    } else if(variant===1){
      // Leviathan ‚Äî massive creature slowly glides across screen 30s
      sequence([[0,()=>{if(SD.deepSea){SD.deepSea.leviathan={x:-W()*0.3,y:H()*0.35,vx:0.6,alpha:0,sz:Math.min(W(),H())*0.5,timer:30000};} flash(rgba(pc(2),0.5),400);}],[500,()=>{flash(rgba(pc(0),0.4),300);}],[3000,()=>{flash(rgba(pc(1),0.3),200);}]]);
    } else {
      // Abyssal Vortex ‚Äî glowing whirlpool center screen, creatures spiral 30s
      sequence([[0,()=>{if(SD.deepSea){SD.deepSea.vortex={x:W()/2,y:H()*0.45,r:0,maxR:Math.min(W(),H())*0.35,rot:0,alpha:0,timer:30000};}flash(rgba(pc(1),0.5),300);}],[500,()=>{flash(rgba(pc(2),0.4),200);}],[2000,()=>{flash(rgba(pc(0),0.4),200);}]]);
    }
  }
  else if(sc==='CYBER_GRID'){
    if(variant===0){
      // Glitch-out ‚Äî 30s
      sequence([[0,()=>{if(SD.cyberGrid){SD.cyberGrid.glitching=true;SD.cyberGrid.glitchTimer=30000;}flash(rgba(pc(0),0.7),150);}],[200,()=>{flash(rgba(pc(1),0.6),150);}],[500,()=>{flash(rgba(pc(2),0.8),200);}],[2000,()=>{flash(rgba(pc(0),0.5),200);}]]);
    } else if(variant===1){
      // Speed up ‚Äî 30s
      sequence([[0,()=>{if(SD.cyberGrid){SD.cyberGrid.speedBoost=5;SD.cyberGrid.speedTimer=30000;}flash(rgba(pc(1),0.6),200);}],[500,()=>{flash('rgba(255,255,255,0.5)',100);}],[2000,()=>{flash(rgba(pc(0),0.4),200);}]]);
    } else {
      // Spiral ‚Äî 30s
      sequence([[0,()=>{if(SD.cyberGrid){SD.cyberGrid.spiral=true;SD.cyberGrid.spiralTimer=30000;SD.cyberGrid.spiralAngle=0;}flash(rgba(pc(2),0.7),300);}],[500,()=>{flash(rgba(pc(0),0.5),200);}],[3000,()=>{flash(rgba(pc(1),0.4),200);}]]);
    }
  }
  else if(sc==='STORM_CHASER'){
    if(variant===0){
      // Transformer Explosion ‚Äî both towers explode, sparks flying 30s
      sequence([[0,()=>{if(SD.storm){SD.storm.transformerExplosion=true;SD.storm.transformerTimer=30000;}flash('rgba(255,200,50,0.7)',400);}],[500,()=>{flash(rgba(pc(0),0.5),200);}],[1500,()=>{flash('rgba(255,255,255,0.6)',200);}],[3000,()=>{flash(rgba(pc(1),0.4),300);}]]);
    } else if(variant===1){
      // Color lightning ‚Äî 30s
      sequence([[0,()=>{if(SD.storm){SD.storm.colorLightning=true;SD.storm.colorLightningTimer=30000;}flash(rgba(pc(0),0.6),200);}],[200,()=>{flash(rgba(pc(1),0.6),200);}],[400,()=>{flash(rgba(pc(2),0.6),200);}],[600,()=>{flash(rgba(pc(3),0.6),200);}]]);
    } else {
      // Heavy rain ‚Äî 30s
      sequence([[0,()=>{if(SD.storm){SD.storm.heavyRain=true;SD.storm.heavyRainTimer=30000;}flash('rgba(100,150,255,0.4)',400);}],[500,()=>{flash(rgba(pc(2),0.4),200);}],[2000,()=>{flash(rgba(pc(0),0.3),200);}]]);
    }
  }
  else if(sc==='JUNGLE_RAVE'){
    if(variant===0){
      // Stampede ‚Äî creatures charge through, canopy explodes
      sequence([[0,()=>{flash(rgba(pc(2),0.5),400);for(let i=0;i<6;i++)setTimeout(()=>SD.creatures&&SD.creatures.push({...mkJungleCreature(W(),H()),sz:180+i*25,vx:-(2+i*0.4),y:H()*(0.25+i*0.08)}),i*200);}],[2000,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=4);if(SD.spores)SD.spores.forEach(s=>s.vy*=8);}],[4000,()=>{flash(rgba(pc(0),0.6),500);}],[5000,()=>{if(SD.spores)SD.spores.forEach(s=>s.vy/=8);}],[8000,()=>{}]]);
    } else if(variant===1){
      // Canopy explosion ‚Äî vines and leaves fill screen
      sequence([[0,()=>{if(SD.trees)SD.trees.forEach(t=>t.glowMult=6);flash(rgba(pc(2),0.7),300);}],[500,()=>{if(SD.vines)SD.vines.forEach(v=>v.swingSpeed*=5);flash(rgba(pc(0),0.5),400);}],[1500,()=>{if(SD.spores)SD.spores.forEach(s=>{s.vy*=6;s.vx=(Math.random()-0.5)*4;});}],[4000,()=>{if(SD.vines)SD.vines.forEach(v=>v.swingSpeed/=5);if(SD.spores)SD.spores.forEach(s=>{s.vy/=6;s.vx=(Math.random()-0.5)*0.3;});}],[8000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(2),0.8),200);}],[300,()=>{for(let i=0;i<4;i++)setTimeout(()=>{SD.creatures&&SD.creatures.push({...mkJungleCreature(W(),H()),sz:220});if(SD.trees)SD.trees[i%SD.trees.length].glowMult=5;},i*400);}],[3000,()=>{flash(rgba(pc(0),0.6),400);if(SD.spores)SD.spores.forEach(s=>s.vy*=10);}],[5000,()=>{if(SD.spores)SD.spores.forEach(s=>s.vy/=10);}],[9000,()=>{}]]);
    }
  }
  else if(sc==='DISCO_DIMENSION'){
    if(variant===0){
      // Floor superstrobe ‚Äî 30s
      sequence([[0,()=>{if(SD.disco){SD.disco.superFloor=true;SD.disco.superFloorTimer=30000;}flash('rgba(255,255,255,0.8)',150);}],[200,()=>{flash(rgba(pc(0),0.6),150);}],[500,()=>{flash(rgba(pc(1),0.7),100);}],[1000,()=>{flash(rgba(pc(2),0.6),150);}]]);
    } else if(variant===1){
      // Laser/ball spin ‚Äî 30s
      sequence([[0,()=>{if(SD.disco){SD.disco.superLaser=true;SD.disco.superLaserTimer=30000;}flash(rgba(pc(0),0.5),300);}],[500,()=>{flash(rgba(pc(1),0.4),200);}],[2000,()=>{flash(rgba(pc(2),0.5),200);}]]);
    } else {
      // Combo ‚Äî 30s
      sequence([[0,()=>{if(SD.disco){SD.disco.superFloor=true;SD.disco.superFloorTimer=30000;SD.disco.superLaser=true;SD.disco.superLaserTimer=30000;}flash('rgba(255,255,255,0.9)',100);}],[200,()=>{flash(rgba(pc(0),0.7),100);}],[400,()=>{flash(rgba(pc(1),0.7),100);}],[600,()=>{flash(rgba(pc(2),0.7),100);}]]);
    }
  }
  else if(sc==='ACID_TRIP'){
    if(variant===0){
      sequence([[0,()=>{beatFX.invertA=0.9;flash(rgba(pc(0),0.8),200);}],[300,()=>{flash(rgba(pc(1),0.7),200);}],[600,()=>{flash(rgba(pc(2),0.8),200);}],[1000,()=>{beatFX.invertA=0.6;flash(rgba(pc(3),0.7),300);}],[2500,()=>{beatFX.invertA=0.8;}],[4000,()=>{beatFX.invertA=0.4;}],[7000,()=>{beatFX.invertA=0;}]]);
    } else if(variant===1){
      sequence([[0,()=>{flash('rgba(0,0,0,0.95)',100);}],[200,()=>{if(SD.warpGrid)SD.warpGrid.forEach(p=>p.ph+=Math.PI*(Math.random()-0.5)*4);flash(rgba(pc(0),0.9),100);}],[600,()=>{beatFX.invertA=0.7;flash(rgba(pc(1),0.8),200);}],[2000,()=>{if(SD.warpGrid)SD.warpGrid.forEach(p=>p.ph=Math.random()*Math.PI*2);}],[3000,()=>{beatFX.invertA=0.4;}],[6000,()=>{beatFX.invertA=0;}]]);
    } else {
      sequence([[0,()=>{for(let i=0;i<6;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.7),100);beatFX.invertA=i%2===0?0.6:0;},i*150);}],[1200,()=>{beatFX.invertA=0.5;if(SD.warpGrid)SD.warpGrid.forEach(p=>p.ph+=Math.PI);}],[4000,()=>{beatFX.invertA=0.3;}],[7000,()=>{beatFX.invertA=0;}]]);
    }
  }
  else if(sc==='SPACE_STATION'){
    if(variant===0){
      // UFO swarm ‚Äî 30s
      sequence([[0,()=>{if(SD.space){SD.space.superUFO=true;SD.space.superUFOTimer=30000;}flash(rgba(pc(0),0.5),300);}],[500,()=>{flash(rgba(pc(1),0.4),200);}],[2000,()=>{flash(rgba(pc(2),0.4),200);}]]);
    } else if(variant===1){
      // Star explosion ‚Äî 35s total: 8s buildup + 2s blast + 15s strobe + fade
      sequence([[0,()=>{if(SD.space){SD.space.starExplosion=true;SD.space.starExpTimer=35000;SD.space.starExpR=0;SD.space.starExpX=W()*0.3;SD.space.starExpY=H()*0.35;SD.space.starExpPhase='building';SD.space.starExpBuildUp=0;SD.space.starExpStrobeTimer=0;SD.space.starExpParticles=[];}flash('rgba(255,255,200,0.3)',300);}]]);
    } else {
      // Asteroid shower ‚Äî 30s
      sequence([[0,()=>{if(SD.space){SD.space.asteroidShower=true;SD.space.asteroidTimer=30000;}flash(rgba(pc(1),0.5),300);}],[500,()=>{flash(rgba(pc(0),0.4),200);}],[2000,()=>{flash(rgba(pc(2),0.4),200);}]]);
    }
  }
else if(sc==='NEON_CATHEDRAL'){
    if(variant===0){
      // A: Gargoyles Come Alive ‚Äî stand up, wings flap, fly around, eyes blazing 30s
      sequence([
        [0,()=>{
          if(SD.cath&&SD.cath.gargoyles){
            SD.cath.gargoyleAlive=true;SD.cath.gargoyleAliveTimer=30000;
            SD.cath.gargoyles.forEach(g=>{g.flyMode=true;g.flyVx=(Math.random()-0.5)*3;g.flyVy=-(1+Math.random()*2);});
          }
          flash(rgba(pc(0),0.6),300);
        }],
        [500,()=>{flash(rgba(pc(1),0.5),200);}],
        [2000,()=>{flash(rgba(pc(2),0.4),300);}],
        [5000,()=>{flash(rgba(pc(0),0.5),200);}],
      ]);
    } else if(variant===1){
      // B: Church Doors Open ‚Äî light floods out, stained glass color explosion 30s
      sequence([
        [0,()=>{
          if(SD.cath){SD.cath.doorsOpen=true;SD.cath.doorsOpenTimer=30000;}
          flash('rgba(255,255,220,0.7)',500);
        }],
        [600,()=>{flash(rgba(pc(0),0.6),300);}],
        [1200,()=>{flash(rgba(pc(1),0.5),200);}],
        [2000,()=>{flash(rgba(pc(2),0.7),200);}],
        [4000,()=>{flash(rgba(pc(3),0.5),300);}],
      ]);
    } else {
      // C: Gargoyle Fire Breath ‚Äî all 4 breathe neon fire beams across scene 30s
      sequence([
        [0,()=>{
          if(SD.cath){SD.cath.gargoyleFireBreath=true;SD.cath.gargoyleFireTimer=30000;}
          flash(rgba(pc(0),0.7),300);
        }],
        [400,()=>{flash(rgba(pc(1),0.6),200);}],
        [1000,()=>{flash(rgba(pc(2),0.5),200);}],
        [3000,()=>{flash(rgba(pc(3),0.4),300);}],
      ]);
    }
  }
  else if(sc==='CLASSIC_ARCADE'){
    if(variant===0){
      // Giant Pac-Man chase ‚Äî fast, close calls, 20s then GAME OVER
      sequence([[0,()=>{if(SD.arcade){SD.arcade.superPac={x:W()*0.05,y:H()*0.4,vx:2.5,vy:0.2,mouthA:0,dir:1,timer:20000};}flash(rgba(pc(3),0.6),300);}],[20000,()=>{if(SD.arcade){SD.arcade.gameOverTimer=10000;if(SD.arcade.superPac)SD.arcade.superPac.timer=0;}flash('rgba(255,0,0,0.6)',400);}]]);
    } else if(variant===1){
      // Boss battle ‚Äî boss wins, centerpiece destroyed, GAME OVER
      sequence([[0,()=>{if(SD.arcade){SD.arcade.boss={timer:20000,ci:0,variant:1};SD.arcade.bossHP=100;SD.arcade.bossLasers=[];}flash(rgba(pc(0),0.7),300);}],[20000,()=>{if(SD.arcade){SD.arcade.gameOverTimer=10000;if(SD.arcade.boss)SD.arcade.boss.timer=0;}flash('rgba(255,0,0,0.6)',400);}]]);
    } else {
      // Boss battle ‚Äî centerpiece wins, boss destroyed, WINNER
      sequence([[0,()=>{if(SD.arcade){SD.arcade.boss={timer:20000,ci:0,variant:2};SD.arcade.bossHP=100;SD.arcade.bossLasers=[];}flash(rgba(pc(0),0.7),300);}],[20000,()=>{if(SD.arcade){SD.arcade.winnerTimer=10000;if(SD.arcade.boss)SD.arcade.boss.timer=0;}flash('rgba(255,255,255,0.8)',400);}]]);
    }
  }
  else if(sc==='ELECTRIC_FOREST'){
    if(variant===0){
      // Laser Overload ‚Äî multiply, brighten, erratic sweeping 30s
      sequence([[0,()=>{if(SD.ef){SD.ef.laserOverload=true;SD.ef.laserOverloadTimer=30000;}flash(rgba(pc(0),0.6),300);}],[500,()=>{flash(rgba(pc(1),0.5),200);}],[2000,()=>{flash(rgba(pc(2),0.5),200);}]]);
    } else if(variant===1){
      // Neon Monkey Swarm ‚Äî ~12 monkeys swinging from trees 30s
      sequence([[0,()=>{if(SD.ef){SD.ef.monkeySwarm=true;SD.ef.monkeySwarmTimer=30000;SD.ef.monkeys=[];}flash(rgba(pc(1),0.5),300);}],[500,()=>{flash(rgba(pc(0),0.4),200);}],[2000,()=>{flash(rgba(pc(3),0.4),200);}]]);
    } else {
      // Windstorm ‚Äî trees sway/bend, particles blow, centerpiece pulses harder 30s
      sequence([[0,()=>{if(SD.ef){SD.ef.windstorm=true;SD.ef.windstormTimer=30000;SD.ef.trees.forEach(t2=>t2.glowMult=3);}flash('rgba(200,220,255,0.5)',400);}],[2000,()=>{flash(rgba(pc(2),0.4),200);}],[5000,()=>{if(SD.ef)SD.ef.trees.forEach(t2=>t2.glowMult=2);}]]);
    }
  }
else if(sc==='OMNIA_NIGHTCLUB'){
    if(variant===0){
      // A: Full laser show erupts from chandelier
      sequence([
        [0,()=>{
          if(SD.omnia){SD.omnia.laserActive=true;SD.omnia.beamRot=0;}
          flash(rgba(pc(0),0.5),200);
        }],
        [300,()=>{flash(rgba(pc(1),0.4),150);}],
        [700,()=>{flash(rgba(pc(2),0.5),150);}],
        [1200,()=>{flash(rgba(pc(3),0.4),200);}],
        [2000,()=>{flash('rgba(255,255,255,0.3)',100);}],
        [3500,()=>{flash(rgba(pc(0),0.4),150);}],
        [5000,()=>{flash(rgba(pc(1),0.3),200);}],
        [7000,()=>{flash(rgba(pc(2),0.4),150);}],
        [10000,()=>{if(SD.omnia)SD.omnia.laserActive=false;}],
      ]);
    } else if(variant===1){
      // B: CO2 billows from chandelier, whites out scene
      sequence([
        [0,()=>{
          if(SD.omnia)SD.omnia.co2Active=true;
          flash('rgba(220,235,255,0.3)',400);
        }],
        [600,()=>{flash('rgba(240,245,255,0.5)',300);}],
        [1200,()=>{flash('rgba(255,255,255,0.7)',200);}],
        [2000,()=>{flash('rgba(240,248,255,0.4)',500);}],
        [4000,()=>{flash('rgba(220,235,255,0.3)',400);}],
        [7000,()=>{if(SD.omnia)SD.omnia.co2Active=false;}],
        [10000,()=>{}],
      ]);
    } else {
      // C: Rings go haywire independently ‚Äî each spins out of control
      sequence([
        [0,()=>{
          flash(rgba(pc(0),0.6),200);
          if(SD.omnia&&SD.omnia.rings){
            // Each ring gets its own haywire speed and direction
            SD.omnia.rings.forEach((ring,i)=>{
              setTimeout(()=>{
                ring.haywire=true;
                ring.haywireSpeed=ring.rotSpeed*(8+Math.random()*12)*(Math.random()<0.5?1:-1);
                flash(rgba(pc(ring.ci),0.5),100);
              },i*180);
            });
          }
        }],
        [1200,()=>{flash('rgba(255,255,255,0.6)',150);}],
        [2000,()=>{
          // Mid-chaos direction flip on some rings
          if(SD.omnia&&SD.omnia.rings){
            SD.omnia.rings.forEach((ring,i)=>{
              if(i%2===0)ring.haywireSpeed*=-1;
            });
          }
          flash(rgba(pc(1),0.5),200);
        }],
        [3500,()=>{flash(rgba(pc(2),0.4),200);}],
        [5000,()=>{
          // Second chaos burst
          if(SD.omnia&&SD.omnia.rings){
            SD.omnia.rings.forEach(ring=>{
              ring.haywireSpeed=ring.rotSpeed*(10+Math.random()*15)*(Math.random()<0.5?1:-1);
              flash(rgba(pc(ring.ci),0.4),80);
            });
          }
        }],
        [7000,()=>{flash('rgba(255,255,255,0.4)',300);}],
        [9000,()=>{
          // Rings slowly calm back to normal
          if(SD.omnia&&SD.omnia.rings){
            SD.omnia.rings.forEach(ring=>{ring.haywire=false;});
          }
        }],
      ]);
    }
  }
  else if(sc==='PIRATE_SHIP'){
    if(variant===0){
      // Kraken attack ‚Äî tentacles from water
      sequence([[0,()=>{flash(rgba(pc(0),0.6),400);if(SD.creatures)for(let i=0;i<4;i++)setTimeout(()=>{SD.creatures&&SD.creatures.push({...mkDeepCreature(W(),H()),sz:150+i*30,vx:1.2+i*0.3,y:H()*(0.55+i*0.08)});},i*300);}],[2000,()=>{flash(rgba(pc(1),0.5),500);}],[4000,()=>{for(let i=0;i<5;i++)setTimeout(()=>SD.cannonballs&&SD.cannonballs.push(mkCannonball()),i*120);}],[7000,()=>{}]]);
    } else if(variant===1){
      // Cannonball broadside
      sequence([[0,()=>{for(let i=0;i<8;i++)setTimeout(()=>{SD.cannonballs&&SD.cannonballs.push(mkCannonball());flash('rgba(255,150,0,0.4)',150);},i*180);}],[2000,()=>{flash(rgba(pc(0),0.6),300);}],[3000,()=>{for(let i=0;i<6;i++)setTimeout(()=>{SD.cannonballs&&SD.cannonballs.push(mkCannonball());},i*200);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);}],[500,()=>{for(let i=0;i<5;i++)setTimeout(()=>SD.cannonballs&&SD.cannonballs.push(mkCannonball()),i*150);}],[2000,()=>{if(SD.creatures)for(let i=0;i<3;i++)SD.creatures.push({...mkDeepCreature(W(),H()),sz:180,vx:1.5,y:H()*(0.6+i*0.08)});}],[4000,()=>{flash(rgba(pc(1),0.5),400);}],[7000,()=>{}]]);
    }
  }
  else if(sc==='JUNKYARD'){
    if(variant===0){
      // Super crusher ‚Äî 30s
      sequence([[0,()=>{if(SD.junkyard){SD.junkyard.superCrusher=true;SD.junkyard.superCrusherTimer=30000;}flash(rgba(pc(0),0.6),300);}],[500,()=>{flash(rgba(pc(1),0.4),200);}],[2000,()=>{flash(rgba(pc(2),0.5),200);}]]);
    } else if(variant===1){
      // Super sparks ‚Äî 30s
      sequence([[0,()=>{if(SD.junkyard){SD.junkyard.superSparks=true;SD.junkyard.superSparksTimer=30000;}flash(rgba(pc(3),0.5),300);}],[500,()=>{flash(rgba(pc(0),0.4),200);}],[2000,()=>{flash(rgba(pc(1),0.4),200);}]]);
    } else {
      // Combo ‚Äî 30s
      sequence([[0,()=>{if(SD.junkyard){SD.junkyard.superCrusher=true;SD.junkyard.superCrusherTimer=30000;SD.junkyard.superSparks=true;SD.junkyard.superSparksTimer=30000;}flash('rgba(255,180,0,0.6)',200);}],[300,()=>{flash(rgba(pc(0),0.5),200);}],[1500,()=>{flash(rgba(pc(1),0.4),200);}]]);
    }
  }
  else if(sc==='GOTHAM'){
    if(variant===0){
      // City burns ‚Äî 30s
      sequence([[0,()=>{if(SD.gotham){SD.gotham.fireBlazeMode=true;SD.gotham.fireBlazeTimer=30000;SD.gotham.buildings.forEach(b=>{b.fireTimer=0;});}flash('rgba(255,80,0,0.5)',400);}],[500,()=>{flash(rgba(pc(0),0.5),200);}],[2000,()=>{flash('rgba(255,50,0,0.4)',300);}]]);
    } else if(variant===1){
      // Spotlight centerpiece ‚Äî 30s
      sequence([[0,()=>{if(SD.gotham){SD.gotham.spotlightMode=true;SD.gotham.spotlightModeTimer=30000;}flash('rgba(220,220,255,0.6)',400);}],[500,()=>{flash(rgba(pc(1),0.4),200);}],[2000,()=>{flash('rgba(255,255,255,0.3)',200);}]]);
    } else {
      // Riddler ‚Äî 30s
      sequence([[0,()=>{if(SD.gotham){SD.gotham.riddler={timer:30000,ci:2};}flash(rgba(pc(2),0.5),400);}],[300,()=>{flash('rgba(0,120,0,0.5)',200);}],[1000,()=>{flash(rgba(pc(2),0.4),200);}]]);
    }
  }
else if(sc==='DAY_OF_DEAD'){
    if(variant===0){
      // A: Mask gets huge and vibrant ‚Äî swells dramatically
      sequence([
        [0,()=>{
          if(SD.dotd){SD.dotd.maskRotSpeed=0.035;SD.dotd.maskPulse=0.6;}
          flash(rgba(pc(0),0.7),300);
        }],
        [400,()=>{flash(rgba(pc(1),0.6),200);}],
        [800,()=>{
          if(SD.dotd){SD.dotd.maskPulse=1.0;}
          flash(rgba(pc(2),0.7),200);
        }],
        [1200,()=>{flash('rgba(255,255,255,0.5)',150);}],
        [2000,()=>{flash(rgba(pc(3),0.5),300);if(SD.dotd)SD.dotd.maskPulse=0.8;}],
        [3000,()=>{flash(rgba(pc(0),0.6),200);if(SD.dotd)SD.dotd.maskPulse=1.2;}],
        [4500,()=>{
          if(SD.dotd){SD.dotd.maskPulse=0.6;}
          flash(rgba(pc(1),0.5),300);
        }],
        [7000,()=>{flash(rgba(pc(2),0.4),400);if(SD.dotd)SD.dotd.maskPulse=0.3;}],
        [9000,()=>{if(SD.dotd){SD.dotd.maskRotSpeed=0.008;SD.dotd.maskPulse=0;}}],
      ]);
    } else if(variant===1){
      // B: Zombies rise from the bottom and dance
      sequence([
        [0,()=>{
          flash(rgba(pc(0),0.5),400);
          if(SD.dotd){
            SD.dotd.zombieActive=true;
            // Spawn 6 zombies ‚Äî from screen edges, walk inward
            const w2=W(),h2=H();
            for(let i=0;i<6;i++){
              setTimeout(()=>{
                const fromLeft=i%2===0;
                SD.dotd.zombies.push({
                  x: fromLeft?-40:w2+40,
                  y: h2*0.72,
                  vx: fromLeft?(0.6+Math.random()*0.8):-(0.6+Math.random()*0.8),
                  sz: 42+Math.random()*22,
                  ph: Math.random()*Math.PI*2,
                  phSpeed: 0.04+Math.random()*0.03,
                  ci: i%4,
                  alpha: 0,
                });
              },i*350);
            }
          }
        }],
        [800,()=>{flash(rgba(pc(1),0.4),300);}],
        [2000,()=>{flash(rgba(pc(2),0.5),200);}],
        [4000,()=>{flash(rgba(pc(3),0.4),300);}],
        [7000,()=>{
          // Zombies start shuffling off
          if(SD.dotd&&SD.dotd.zombies){
            SD.dotd.zombies.forEach(z=>{z.vx=(z.x<W()/2?-1:1)*(1+Math.random());});
          }
        }],
        [10000,()=>{if(SD.dotd)SD.dotd.zombies=[];}],
      ]);
    } else {
      // C: Giant sombrero spins down from above and lands on mask
      sequence([
        [0,()=>{
          flash(rgba(pc(1),0.6),300);
          if(SD.dotd&&!SD.dotd.sombrero){
            const w2=W(),h2=H();
            SD.dotd.sombrero={
              x: w2/2,
              y: -h2*0.3,
              vy: 2.5,
              rot: 0,
              rotSpeed: 0.12,
              wobble: 0,
              worn: false,
            };
          }
        }],
        [500,()=>{flash(rgba(pc(0),0.5),200);}],
        [1200,()=>{flash(rgba(pc(3),0.6),200);}],
        [2000,()=>{
          // Once worn ‚Äî mask shows off: speed up spin, vibrant flash
          if(SD.dotd&&SD.dotd.sombrero&&SD.dotd.sombrero.worn){
            SD.dotd.maskRotSpeed=0.02;
            flash(rgba(pc(1),0.7),300);
          }
        }],
        [3000,()=>{flash('rgba(255,255,255,0.4)',200);}],
        [4000,()=>{flash(rgba(pc(0),0.5),300);}],
        [6000,()=>{flash(rgba(pc(2),0.4),400);}],
        [9000,()=>{
          // Sombrero flies off upward
          if(SD.dotd&&SD.dotd.sombrero){
            SD.dotd.sombrero.vy=-4;
            SD.dotd.sombrero.worn=false;
          }
          if(SD.dotd)SD.dotd.maskRotSpeed=0.008;
          flash(rgba(pc(1),0.5),300);
        }],
        [11000,()=>{if(SD.dotd){SD.dotd.sombrero=null;SD.dotd.sombreroWorn=false;}}],
      ]);
    }
  }
  else if(sc==='CHINESE_DRAGON'){
    if(variant===0){
      // Dragon breathes fire ‚Äî giant flash + centerpiece pearl surges
      sequence([[0,()=>{flash(rgba(pc(0),0.8),300);}],[400,()=>{flash('rgba(255,150,0,0.7)',200);}],[800,()=>{if(SD.dragonPath)SD.dragonPath.forEach(p=>{p.vx=p.vx*3||6;});flash('rgba(255,200,50,0.5)',400);}],[2000,()=>{flash(rgba(pc(0),0.5),500);}],[5000,()=>{}]]);
    } else if(variant===1){
      // Second dragon appears ‚Äî pearl whips wildly
      sequence([[0,()=>{if(SD.pearl){SD.pearl.ph+=Math.PI;};flash(rgba(pc(1),0.6),400);}],[1000,()=>{flash(rgba(pc(0),0.7),300);}],[2000,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed*=5);}],[4000,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed/=5);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{flash(rgba(pc(0),0.9),200);}],[300,()=>{if(SD.pearl)SD.pearl.ph+=Math.PI*0.5;}],[500,()=>{flash('rgba(255,180,0,0.6)',300);}],[1500,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed*=3);flash(rgba(pc(1),0.5),400);}],[4000,()=>{if(SD.fog)SD.fog.forEach(f=>f.speed/=3);}]]);
    }
  }
else if(sc==='MOUNT_OLYMPUS'){
    if(variant===0){
      // A: Thunderstorm ‚Äî sky fills with rapid bolts, Zeus goes berserk
      sequence([
        [0,()=>{
          flash('rgba(255,255,180,0.6)',200);
          if(SD.zeus)SD.zeus.angry=1;
          for(let i=0;i<5;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.7)',60);},i*120);
        }],
        [800,()=>{
          for(let i=0;i<8;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*80);
          flash('rgba(200,220,255,0.5)',300);
        }],
        [1800,()=>{
          for(let i=0;i<10;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.5)',50);},i*90);
          if(SD.zeus)SD.zeus.tiltSpeed=0.02; // head thrashing
        }],
        [3500,()=>{flash('rgba(255,255,150,0.8)',200);}],
        [4500,()=>{
          for(let i=0;i<6;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*120);
        }],
        [7000,()=>{if(SD.zeus){SD.zeus.tiltSpeed=0.004;SD.zeus.angry=0;}}],
      ]);
    } else if(variant===1){
      // B: Zeus rage ‚Äî scene shakes, mountains flash, rapid-fire bolts at centerpiece
      sequence([
        [0,()=>{
          flash('rgba(255,255,100,0.9)',150);
          if(SD.zeus){SD.zeus.angry=1;SD.zeus.tiltSpeed=0.025;}
          beatFX.shockwaveR=0;beatFX.shockwaveA=0.9;
        }],
        [200,()=>{flash('rgba(255,200,50,0.7)',100);}],
        [400,()=>{
          flash('rgba(255,255,200,0.6)',150);
          beatFX.shockwaveR=0;beatFX.shockwaveA=0.7;
          // Rapid fire 3 bolts
          if(SD.cpTarget&&SD.cpTarget.alive&&SD.boltsComing){
            const tgt=SD.cpTarget,w2=W(),h2=H();
            for(let i=0;i<3;i++){
              setTimeout(()=>{
                const ex=w2/2+(i-1)*60,ey=h2*0.2;
                const dx=tgt.x-ex,dy=tgt.y-ey,dist=Math.hypot(dx,dy)||1;
                SD.boltsComing.push({x:ex,y:ey,vx:dx/dist*18,vy:dy/dist*18,size:18,life:1.3,ci:1,target:tgt,eyeOrigin:true});
              },i*250);
            }
          }
        }],
        [1800,()=>{
          for(let i=0;i<4;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,100,0.5)',80);},i*150);
        }],
        [3500,()=>{flash('rgba(255,255,200,0.4)',500);}],
        [5000,()=>{
          if(SD.cpTarget&&SD.cpTarget.alive&&SD.boltsComing){
            const tgt=SD.cpTarget,w2=W(),h2=H();
            const ex=w2/2,ey=h2*0.2;
            const dx=tgt.x-ex,dy=tgt.y-ey,dist=Math.hypot(dx,dy)||1;
            SD.boltsComing.push({x:ex,y:ey,vx:dx/dist*20,vy:dy/dist*20,size:22,life:1.4,ci:1,target:tgt,eyeOrigin:true});
          }
        }],
        [8000,()=>{if(SD.zeus){SD.zeus.angry=0;SD.zeus.tiltSpeed=0.004;}}],
      ]);
    } else {
      // C: Clouds part, Zeus fully revealed, laughs and unleashes everything at once
      sequence([
        [0,()=>{
          // Clouds scatter outward
          if(SD.clouds)SD.clouds.forEach((cl,i)=>{cl.vx=(i%2===0?1:-1)*(2+Math.random()*2);});
          flash(rgba(pc(1),0.4),600);
        }],
        [800,()=>{
          flash('rgba(255,255,255,0.7)',200);
          if(SD.zeus){SD.zeus.angry=1;SD.zeus.tiltSpeed=0;SD.zeus.tilt=0;} // Face front, centered
        }],
        [1200,()=>{
          flash('rgba(255,255,200,0.9)',150);
          // Massive multi-bolt barrage
          if(SD.cpTarget&&SD.boltsComing){
            const tgt=SD.cpTarget,w2=W(),h2=H();
            const origins=[[-80,-28],[80,-28],[-40,-60],[40,-60],[0,-70]];
            origins.forEach(([ox,oy],i)=>{
              setTimeout(()=>{
                const ex=w2/2+ox,ey=h2*0.2+oy;
                const tx=tgt.alive?tgt.x:w2*0.3+Math.random()*w2*0.4;
                const ty=tgt.alive?tgt.y:h2*0.6;
                const dx=tx-ex,dy=ty-ey,dist=Math.hypot(dx,dy)||1;
                SD.boltsComing.push({x:ex,y:ey,vx:dx/dist*17,vy:dy/dist*17,size:16,life:1.2,ci:i%2===0?1:3,target:tgt.alive?tgt:null,eyeOrigin:true});
              },i*100);
            });
          }
        }],
        [2000,()=>{
          for(let i=0;i<8;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.6)',60);},i*100);
        }],
        [3500,()=>{
          flash('rgba(200,220,255,0.5)',400);
          // Clouds drift back
          if(SD.clouds)SD.clouds.forEach(cl=>{cl.vx=(Math.random()-0.5)*0.2;});
          if(SD.zeus)SD.zeus.tiltSpeed=0.004;
        }],
        [6000,()=>{
          for(let i=0;i<5;i++)setTimeout(()=>{SD.lightnings&&SD.lightnings.push(mkLightning());},i*140);
        }],
        [9000,()=>{if(SD.zeus){SD.zeus.angry=0;}}],
      ]);
    }
  }
  else if(sc==='SUPER_MARIO'){
    if(variant===0){
      // Star power ‚Äî rainbow flash, everything glows
      sequence([[0,()=>{for(let i=0;i<6;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.6),100);},i*100);}],[700,()=>{beatFX.speedBoost=2;}],[1000,()=>{if(SD.goombas)SD.goombas.forEach(g=>g.vx*=3);}],[3000,()=>{if(SD.goombas)SD.goombas.forEach(g=>g.vx/=3);beatFX.speedBoost=0;}],[5000,()=>{for(let i=0;i<4;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.5),100);},i*100);}]]);
    } else if(variant===1){
      // Bowser stomps in from right side
      sequence([[0,()=>{flash(rgba(pc(0),0.7),300);}],[400,()=>{for(let i=0;i<4;i++)setTimeout(()=>{beatFX.slamS=1.3;setTimeout(()=>beatFX.slamS=1,200);flash(rgba(pc(2),0.5),100);},i*600);}],[3000,()=>{flash('rgba(255,100,0,0.5)',400);}],[6000,()=>{}]]);
    } else {
      sequence([[0,()=>{for(let i=0;i<5;i++)setTimeout(()=>{flash(rgba(pc(i%4),0.5),80);},i*80);}],[500,()=>{beatFX.speedBoost=3;if(SD.coins)SD.coins.forEach(c=>c.ph+=Math.PI);}],[2000,()=>{beatFX.speedBoost=1;}],[4000,()=>{beatFX.speedBoost=0;flash(rgba(pc(1),0.5),400);}]]);
    }
  }
else if(sc==='ATLANTIS'){
    if(variant===0){
      // A: Giant neon whirlpool forms and sucks in fish
      sequence([
        [0,()=>{
          flash(rgba(pc(2),0.5),400);
          if(SD.atl&&!SD.atl.whirlpool){
            SD.atl.whirlpool={
              x:W()*0.5, y:H()*0.45,
              radius:20, maxR:Math.min(W(),H())*0.38,
              growSpeed:2.2, rot:0, speed:0.045,
              alpha:0, fading:false,
            };
          }
        }],
        [600,()=>{flash(rgba(pc(0),0.4),300);}],
        [1500,()=>{flash(rgba(pc(2),0.5),200);}],
        [3000,()=>{flash(rgba(pc(1),0.4),400);}],
        [5000,()=>{flash(rgba(pc(0),0.5),300);}],
        [7000,()=>{
          // Whirlpool starts fading
          if(SD.atl&&SD.atl.whirlpool)SD.atl.whirlpool.fading=true;
        }],
        [10000,()=>{if(SD.atl)SD.atl.whirlpool=null;}],
      ]);
    } else if(variant===1){
      // B: Giant kraken grabs the city with tentacles
      sequence([
        [0,()=>{
          flash(rgba(pc(0),0.7),300);
          if(SD.atl&&!SD.atl.kraken){
            const w2=W(),h2=H(),fl=h2*0.88;
            // Place eye above ruins on the right side
            SD.atl.kraken={
              eyeX:w2*0.78, eyeY:h2*0.18,
              eyeR:h2*0.06,
              age:0, alpha:0, retreating:false,
              tentacles:[
                // Each tentacle: originates near eye, targets a ruin element
                {originX:w2*0.7,  originY:h2*0.22, midX:w2*0.6,  midY:h2*0.45, targetX:w2*0.55, targetY:fl, thickness:14, ph:0, ci:0},
                {originX:w2*0.78, originY:h2*0.28, midX:w2*0.5,  midY:h2*0.5,  targetX:w2*0.38, targetY:fl, thickness:12, ph:1, ci:1},
                {originX:w2*0.85, originY:h2*0.25, midX:w2*0.72, midY:h2*0.55, targetX:w2*0.72, targetY:fl, thickness:10, ph:2, ci:2},
                {originX:w2*0.75, originY:h2*0.32, midX:w2*0.3,  midY:h2*0.4,  targetX:w2*0.25, targetY:fl, thickness:8,  ph:0.5,ci:3},
                {originX:w2*0.82, originY:h2*0.3,  midX:w2*0.62, midY:h2*0.6,  targetX:w2*0.15, targetY:fl, thickness:7,  ph:1.5,ci:0},
              ],
            };
          }
        }],
        [800,()=>{flash(rgba(pc(1),0.5),300);}],
        [1500,()=>{
          // Spawn column debris ‚Äî kraken pulling things apart
          if(SD.atl){
            const w2=W(),h2=H(),fl=h2*0.88;
            for(let d=0;d<18;d++){
              SD.atl.debris.push({
                x:w2*(0.2+Math.random()*0.6), y:fl-Math.random()*h2*0.25,
                vx:(Math.random()-0.5)*5, vy:-(Math.random()*4+1),
                life:1, rot:Math.random()*Math.PI*2, rotS:(Math.random()-0.5)*0.08,
                sz:8+Math.random()*20, ci:Math.floor(Math.random()*4),
              });
            }
            flash(rgba(pc(0),0.6),200);
          }
        }],
        [3000,()=>{
          // More debris chunks
          if(SD.atl){
            const w2=W(),h2=H(),fl=h2*0.88;
            for(let d=0;d<12;d++){
              SD.atl.debris.push({
                x:w2*(0.3+Math.random()*0.5), y:fl-Math.random()*h2*0.3,
                vx:(Math.random()-0.5)*6, vy:-(Math.random()*5+2),
                life:1, rot:Math.random()*Math.PI*2, rotS:(Math.random()-0.5)*0.1,
                sz:6+Math.random()*16, ci:Math.floor(Math.random()*4),
              });
            }
          }
          flash(rgba(pc(2),0.5),300);
        }],
        [6000,()=>{
          flash(rgba(pc(1),0.4),400);
          if(SD.atl&&SD.atl.kraken)SD.atl.kraken.retreating=true;
        }],
        [9000,()=>{if(SD.atl)SD.atl.kraken=null;}],
      ]);
    } else {
      // C: Neon bubbles rise from bottom and take over screen
      sequence([
        [0,()=>{
          if(SD.atl)SD.atl.bubbleStorm=true;
          flash(rgba(pc(2),0.5),300);
          // Spawn many extra large bubbles from floor
          if(SD.atl){
            const w2=W(),h2=H();
            for(let b=0;b<40;b++){
              SD.atl.bubbles.push({
                x:Math.random()*w2, y:h2+20,
                vy:-(1.5+Math.random()*2.5), r:5+Math.random()*12,
                ph:Math.random()*Math.PI*2, ci:Math.floor(Math.random()*4),
                vx:(Math.random()-0.5)*0.8,
              });
            }
          }
        }],
        [400,()=>{flash(rgba(pc(0),0.4),200);}],
        [900,()=>{flash(rgba(pc(1),0.5),200);}],
        [1500,()=>{flash(rgba(pc(3),0.4),300);}],
        [2500,()=>{flash(rgba(pc(2),0.5),200);}],
        [4000,()=>{flash('rgba(255,255,255,0.3)',200);}],
        [6000,()=>{flash(rgba(pc(0),0.4),400);}],
        [8000,()=>{
          if(SD.atl)SD.atl.bubbleStorm=false;
          // Trim extra bubbles back to normal count
          if(SD.atl&&SD.atl.bubbles.length>35)SD.atl.bubbles.length=35;
        }],
      ]);
    }
  }
  else if(sc==='CARNIVAL'){
    if(variant===0){
      // Super fireworks ‚Äî 30s
      sequence([[0,()=>{if(SD.carnival){SD.carnival.superFW=true;SD.carnival.superFWTimer=30000;}flash(rgba(pc(0),0.5),300);}],[2000,()=>{flash(rgba(pc(1),0.4),200);}],[5000,()=>{flash(rgba(pc(2),0.5),200);}]]);
    } else if(variant===1){
      // Hyper ferris wheel ‚Äî 30s
      sequence([[0,()=>{if(SD.carnival){SD.carnival.hyperWheel=true;SD.carnival.hyperWheelTimer=30000;}flash(rgba(pc(0),0.5),300);}],[500,()=>{flash('rgba(255,255,255,0.4)',150);}],[2000,()=>{flash(rgba(pc(1),0.4),200);}]]);
    } else {
      // Giant evil clown ‚Äî 30s
      sequence([[0,()=>{if(SD.carnival){SD.carnival.clown={timer:30000,ci:0};}flash('rgba(0,80,0,0.4)',400);}],[500,()=>{flash(rgba(pc(2),0.5),200);}],[3000,()=>{flash('rgba(0,0,0,0.6)',200);}]]);
    }
  }
  else if(sc==='EGYPTIAN_TOMB'){
    if(variant===0){
      // Mummies ‚Äî 30s
      sequence([[0,()=>{if(SD.egypt){SD.egypt.superMummies=true;SD.egypt.superMummiesTimer=30000;SD.egypt.sarcophagi.forEach(s=>{s.open=true;s.mummyActive=true;});}flash(rgba(pc(0),0.5),400);}],[500,()=>{flash(rgba(pc(1),0.4),200);}],[2000,()=>{flash(rgba(pc(2),0.4),200);}]]);
    } else if(variant===1){
      // Super flames + CP ‚Äî 30s
      sequence([[0,()=>{if(SD.egypt){SD.egypt.superFlames=true;SD.egypt.superFlamesTimer=30000;SD.egypt.torches.forEach(tr=>{tr.big=true;tr.bigTimer=30000;});}flash('rgba(255,100,0,0.6)',400);}],[500,()=>{flash(rgba(pc(0),0.5),200);}],[2000,()=>{flash('rgba(255,140,0,0.4)',200);}]]);
    } else {
      // Super hieroglyphs ‚Äî 30s
      sequence([[0,()=>{if(SD.egypt){SD.egypt.superHiero=true;SD.egypt.superHieroTimer=30000;}flash(rgba(pc(2),0.6),300);}],[500,()=>{flash(rgba(pc(0),0.5),200);}],[2000,()=>{flash(rgba(pc(1),0.4),200);}]]);
    }
  }
  else{flash(rgba(pc(0),0.7),600);}
}

function showGameOver() { const g = document.getElementById("gameOverScreen"); g.style.display = "flex"; setTimeout(() => g.style.display = "none", 2500); }

function doComicBurst(){const panel=document.getElementById('comicPanel');panel.style.display='block';const words=['POW!','ZAP!','BOOM!','WHAM!','KA-BAM!','CRASH!','SLAM!'];const cols=['#ff0','#f0f','#0ff','#f60','#0f0'];panel.innerHTML='';for(let i=0;i<3;i++){const d=document.createElement('div');d.style.cssText=`position:absolute;font-size:${Math.random()*5+4}rem;color:${cols[i%5]};text-shadow:3px 3px 0 #000;left:${Math.random()*70+5}%;top:${Math.random()*70+5}%;transform:rotate(${(Math.random()-0.5)*30}deg);font-family:monospace;font-weight:bold;`;d.textContent=words[Math.floor(Math.random()*words.length)];panel.appendChild(d);}setTimeout(()=>panel.style.display='none',2800);}





// ‚ïê‚ïê MODULE: energy.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê ENERGY & BEAT DETECTION ‚ïê‚ïê‚ïê




function pushEnergy(e) {
  energyHist.push(e);
  if (energyHist.length > 120) energyHist.shift();
  if (e > energyPeak) energyPeak = e;
}

function spikeDetected() {
  if (songProg < 0.55 || energyHist.length < 20) return false;
  const recent = energyHist.slice(-4).reduce((a, b) => a + b, 0) / 4;
  const base = energyHist.slice(-25, -8).reduce((a, b) => a + b, 0) / 17;
  const nearPeak = energyPeak > 0 && recent > energyPeak * 0.82;
  const bigSpike = recent > base + 0.18 && recent > 0.55;
  const prev = energyHist.slice(-8, -4).reduce((a, b) => a + b, 0) / 4;
  const atPeak = recent >= prev * 0.92;
  return (nearPeak || bigSpike) && atPeak;
}

function spawnCracks() {
  const cx = W() / 2, cy = H() / 2;
  beatFX.crackLines = Array.from({ length: 8 }, () => {
    const a = Math.random() * Math.PI * 2, len = Math.random() * Math.max(W(), H()) * 0.7 + 100;
    const segs = []; let x2 = cx, y2 = cy;
    for (let i = 0; i < 6; i++) {
      x2 += Math.cos(a + (Math.random() - 0.5) * 0.8) * len / 6;
      y2 += Math.sin(a + (Math.random() - 0.5) * 0.8) * len / 6;
      segs.push({ x: x2, y: y2 });
    }
    return { segs, life: 1, ci: Math.floor(Math.random() * 4) };
  });
}

function triggerBeat() {
  SM.beatPulse = 1; beatCount++;
  const reactions = THEME.beatReactions || ['shockwave'];
  const reaction = reactions[beatReactionIdx % reactions.length];
  beatReactionIdx++;
  const intensity = 0.5 + progMult * 0.7;

  switch (reaction) {
    case 'speed_burst': beatFX.speedBoost = 1.5 * intensity; break;
    case 'shockwave': beatFX.shockwaveR = 0; beatFX.shockwaveA = 0.8 * intensity; break;
    case 'color_invert': beatFX.invertA = 0.45 * intensity; break;
    case 'world_crack': spawnCracks(); break;
    case 'bass_slam': beatFX.slamS = 1 + 0.12 * intensity; break;
    case 'strobe_cut': beatFX.invertA = THEME.energy > 0.6 ? 0.8 * intensity : 0.3; break;
    case 'creature_surge': if (SD.creatures) SD.creatures.push(mkDeepCreature(W(), H())); break;
    case 'cannon_fire': if (SD.cannonballs) SD.cannonballs.push(mkCannonball()); break;
    case 'lightning_strike': if (SD.lightnings != null) SD.lightnings.push(mkLightning()); break;
    case 'gravity_wave': beatFX.gravityWave = 1; break;
    case 'petal_burst': if (SD.petals) SD.petals.forEach(p => { p.vx = (Math.random() - 0.5) * 5; p.vy = -(Math.random() * 4 + 2); }); break;
  }

  // Scene-specific beat actions
  const sc = THEME.scene;
  if (sc === 'LAVA_WORLD' && Math.random() < 0.4 && SD.eruptions) SD.eruptions.push(mkEruption());
  if (sc === 'STORM_CHASER' && SD.lightnings != null) SD.lightnings.push(mkLightning());
  if ((sc === 'MOUNT_OLYMPUS') && SD.boltsComing && Math.random() < 0.5) SD.boltsComing.push(mkBolt());
  if (sc === 'PIRATE_SHIP' && SD.cannonballs && Math.random() < 0.3) SD.cannonballs.push(mkCannonball());
  if (sc === 'JUNKYARD' && SD.sparks) for (let i = 0; i < 8; i++) SD.sparks.push(mkSpark(false));
  if (sc === 'CARNIVAL' && SD.ferrisRot != null) SD.ferrisRot += 0.15;
  if (sc === 'OMNIA_NIGHTCLUB' && SD.chandelierY != null) SD.chandelierY = Math.max(H() * 0.05, SD.chandelierY - 20 * (1 + progMult));

  // Surprise detection
  pushEnergy(SM.energy);
  if (!devSurpriseLock && !surpriseFired && songProg > 0.55) {
    if (spikeDetected()) { setTimeout(fireSurprise, 200); surpriseFired = true; }
  }
  if (!devSurpriseLock && !surpriseFired && songProg > 0.88) { setTimeout(fireSurprise, 0); surpriseFired = true; }
}




// ‚ïê‚ïê MODULE: transition.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê TRANSITION ‚ïê‚ïê‚ïê



async function transition(name,artist,theme){
  if(inTrans)return;inTrans=true;
  devSurpriseLock=false; // release dev lock ‚Äî real playback takes over
  devSurpriseLock=false; // release dev lock ‚Äî real playback takes over
  const wash=document.getElementById('wash'),splash=document.getElementById('splash');
  const c=h2r(theme.palette[0]);
  wash.style.background=`radial-gradient(ellipse at 50% 40%,rgba(${c.r},${c.g},${c.b},0.92) 0%,rgba(0,0,0,0.97) 70%)`;
  wash.style.transition='opacity 1.1s ease';wash.style.opacity='1';
  await delay(1200);
  Object.assign(THEME,theme);
  MS.energy=theme.energy||0.5;songProg=0;progMult=0.55;
  initScene();
  document.getElementById('cur').style.background=theme.palette[0];
  document.getElementById('trackName').style.color=theme.palette[0];document.getElementById('trackName').style.textShadow=`0 0 20px ${theme.palette[0]},0 2px 4px rgba(0,0,0,0.95)`;
  document.getElementById('sceneTag').style.color=theme.palette[2]||theme.palette[0];document.getElementById('sceneTag').style.textShadow=`0 0 12px ${theme.palette[2]||theme.palette[0]},0 1px 3px rgba(0,0,0,0.9)`;
  document.getElementById('pgBar').style.background=`linear-gradient(90deg,${theme.palette[1]||theme.palette[0]},${theme.palette[0]})`;
  document.getElementById('pgBar').style.boxShadow=`0 0 8px ${theme.palette[0]}`;
  document.getElementById('sceneTag').textContent=(theme.scene||'SCENE').replace(/_/g,' ')+' ‚Äî '+(theme.label||'');
  document.getElementById('splashScene').textContent='‚Äî '+(theme.scene||'').replace(/_/g,' ')+' ‚Äî';
  document.getElementById('splashTrack').textContent=name;
  document.getElementById('splashTrack').style.color=theme.palette[0];
  document.getElementById('splashArtist').textContent=artist;
  document.getElementById('splashDesc').textContent=theme.splashDesc||'';
  splash.classList.add('show');
  wash.style.transition='opacity 1.0s ease';wash.style.opacity='0';
  await delay(4000);
  splash.style.transition='opacity 0.8s ease';splash.style.opacity='0';
  await delay(900);
  splash.classList.remove('show');splash.style.opacity='';splash.style.transition='';
  inTrans=false;
}




// ‚ïê‚ïê MODULE: ai.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê AI THEME LOADER ‚ïê‚ïê‚ïê

const ARTIST_CTX={'marshmello':'Marshmello white marshmallow helmet X eyes. EDM festival.','daft punk':'Daft Punk robot helmets. French house. Disco. Tron neon.','deadmau5':'Mouse head helmet. Progressive house. Dark neon.','pink floyd':'Prism rainbow. Flying pigs. Psychedelic prog rock.','the weeknd':'Neon 80s. Red black. Blinding Lights city highways.','david bowie':'Ziggy Stardust lightning bolt. Glam. Cosmic.','queen':'Stadium rock. Operatic grandeur. Freddie Mercury.','nirvana':'Grunge. Dark raw distorted energy.','eminem':'Detroit. 8 Mile. Raw urban intense.','kendrick lamar':'Compton. DNA. DAMN imagery.','taylor swift':'Sparkles. Eras. Stadium spectacle.','billie eilish':'Dark green black. Spider webs. Haunted.','coldplay':'Colorful confetti. Neon wristbands. Cosmos.','radiohead':'Dystopian glitch. OK Computer robot anxiety.','metallica':'Thrash metal. Lightning bolt. Fire skulls.','skrillex':'Heavy dubstep. Glitch alien.','flume':'Organic futurism. Bioluminescent crystals.'};
function getArtistCtx(name){const k=name.toLowerCase();for(const[n,v]of Object.entries(ARTIST_CTX))if(k.includes(n))return v;return null;}
function extractKW(title){const stop=new Set(['a','an','the','in','of','to','and','or','i','my','me','you','is','it','by','on','for','with','as','be','was']);return title.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stop.has(w)).slice(0,6);}

async function loadTheme(tid,name,artist,artistIds,isExplicit,durationMs){
  if(aiCache[tid]){applyTheme(name,artist,aiCache[tid]);return;}
  // Use provider-agnostic genre fetch
  let genres=[];
  try{genres=await getProviderGenres(artistIds);}catch{}
  const streakDesc=sessionStreak<3?'early session':sessionStreak<6?'warmed up ‚Äî go wilder':sessionStreak<10?'deep session ‚Äî darker and more extreme':sessionStreak<15?'long session ‚Äî full maximalist chaos':'marathon ‚Äî most extreme worlds, nothing held back';
  const shortlist=getSceneShortlist();
  try{
    const r=await fetch('/api/theme',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({trackName:name,artistName:artist,genres,titleKeywords:extractKW(name),artistContext:getArtistCtx(artist)||`Genres: ${genres.join(', ')}`,sceneShortlist:shortlist,forbiddenCenterpieces:getForbidCPs(),availableCenterpieces:ALL_CPS.filter(x=>!getForbidCPs().includes(x)).join(', '),sessionStreak,streakDesc,isExplicit:!!isExplicit,songDurationSecs:Math.round((durationMs||180000)/1000)})});
    if(!r.ok)throw new Error('HTTP '+r.status);
    const raw=await r.json();if(raw.error)throw new Error(raw.error);
    const VALID_BEH=['rotate','spin_fast','pulse_beat','breathe','orbit_slow','rise_set','fixed','strobe','bounce','drift','watermark'];
    const VALID_BEATS=['speed_burst','shockwave','color_invert','world_crack','bass_slam','strobe_cut','creature_surge','cannon_fire','lightning_strike','gravity_wave','petal_burst','pixel_explode','skull_surge','coin_shower','tentacle_surge'];
    const scene=enforceScene((raw.scene||shortlist[0]||'WARP_SPEED').toUpperCase().replace(/ /g,'_'),shortlist);
    const cp=enforceCP(raw.centerpiece);
    const reactions=(raw.beatReactions||['shockwave']).filter(r2=>VALID_BEATS.includes(r2)).slice(0,4);
    const cpX=Math.min(0.9,Math.max(0.1,parseFloat(raw.centerpieceX)||0.5));
    const cpY=Math.min(0.9,Math.max(0.1,parseFloat(raw.centerpieceY)||0.5));
    const theme={scene,label:raw.label||'',splashDesc:raw.splashDesc||'',palette:Array.isArray(raw.palette)&&raw.palette.length===4?raw.palette:['#ff006e','#8338ec','#06ffd8','#ffbe0b'],bgColor:raw.bgColor||'#000010',centerpiece:cp,centerpieceScale:Math.min(1.5,Math.max(0,parseFloat(raw.centerpieceScale)||0.5)),centerpieceX:cpX,centerpieceY:cpY,centerpieceBehavior:VALID_BEH.includes(raw.centerpieceBehavior)?raw.centerpieceBehavior:'rotate',beatReactions:reactions.length?reactions:['shockwave'],sceneSpeed:Math.min(3,Math.max(0.3,parseFloat(raw.sceneSpeed)||1)),sceneIntensity:Math.min(1,Math.max(0,parseFloat(raw.sceneIntensity)||0.7)),energy:Math.min(1,Math.max(0,parseFloat(raw.energy)||0.5)),chaos:Math.min(1,Math.max(0,parseFloat(raw.chaos)||0.4))};
    recordScene(scene);recordCP(cp);
    aiCache[tid]=theme;applyTheme(name,artist,theme);
  }catch(e){console.error('[AI]',e);}
}

function applyTheme(name, artist, theme) {
  document.getElementById("sceneTag").textContent = (theme.scene || "‚Äî").replace(/_/g, " ") + " ‚Äî " + (theme.label || "");
  transition(name, artist, theme);
}


// ‚ïê‚ïê MODULE: spotify.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê SPOTIFY API HELPER ‚ïê‚ïê‚ïê
// spGet is used by the Spotify provider for API calls
// poll() has moved to MusicProviders.spotify in musicProvider.js

async function spGet(ep){
  const r=await fetch('https://api.spotify.com/v1/'+ep,{headers:{Authorization:'Bearer '+token}});
  if(r.status===401){const nt=await refreshAT();if(nt)token=nt;else{logout();return null;}}
  if(!r.ok||r.status===204)return null;
  try{return await r.json()}catch{return null}
}


// ‚ïê‚ïê MODULE: musicProvider.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê MUSIC PROVIDER ‚Äî Abstract layer for multiple music sources ‚ïê‚ïê‚ïê
// Providers: Spotify, Apple Music, Local Audio (mic/file/system)
// All providers feed the same interface: MS, track metadata, poll cycle

// ‚îÄ‚îÄ Provider registry ‚îÄ‚îÄ
const MusicProviders = {};
let activeProvider = null;

// ‚îÄ‚îÄ Track info visibility helper ‚îÄ‚îÄ
function setTrackInfo(track, artist, showInfo) {
  const trackEl = document.getElementById('trackName');
  const artistEl = document.getElementById('artistName');
  if (showInfo && track) {
    trackEl.textContent = track;
    trackEl.style.display = '';
  } else {
    trackEl.textContent = '';
    trackEl.style.display = 'none';
  }
  if (showInfo && artist) {
    artistEl.textContent = artist;
    artistEl.style.display = '';
  } else {
    artistEl.textContent = '';
    artistEl.style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SPOTIFY PROVIDER ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MusicProviders.spotify = {
  name: 'Spotify',
  _interval: null,

  async init() {
    // Check for OAuth callback
    const p = new URLSearchParams(location.search), code = p.get('code');
    console.log('[spotify] init ‚Äî code=' + (code ? 'present' : 'none'));
    if (p.get('error')) {
      showErr('Spotify error: ' + p.get('error'));
      return false;
    }
    if (code) {
      history.replaceState({}, document.title, '/');
      token = await exchToken(code);
      if (!token) return false;
    } else {
      token = getAT();
      if (!token) token = await refreshAT();
      console.log('[spotify] stored token: ' + (token ? 'found' : 'none'));
    }
    if (!token) {
      // No token and no code ‚Äî redirect to Spotify login
      doLogin();
      return false; // Page will redirect, init doesn't complete
    }

    // Start polling
    this.poll();
    this._interval = setInterval(() => this.poll(), 5000);
    return true;
  },

  async poll() {
    const d = await spGet('me/player/currently-playing');
    if (!d || !d.item) return;
    const tr = d.item, tid = tr.id;
    MS.progress = d.progress_ms || 0;
    MS.duration = tr.duration_ms || 180000;
    MS.analysisStart = Date.now() - MS.progress;
    MS.beatInterval = 500;
    MS.energy = d.is_playing ? 0.6 : 0.3;
    if (tid !== lastTid) {
      lastTid = tid;
      setTrackInfo(tr.name, tr.artists.map(a => a.name).join(', '), true);
      const art = tr.album && tr.album.images && tr.album.images[0] ? tr.album.images[0].url : null;
      if (art) { document.getElementById('albumArt').src = art; document.getElementById('albumArt').style.display = ''; }
      loadTheme(tid, tr.name, tr.artists.map(a => a.name).join(', '),
        tr.artists.map(a => a.id), tr.explicit, tr.duration_ms);
    }
  },

  async getGenres(artistIds) {
    try {
      const a = await spGet('artists?ids=' + artistIds.slice(0, 3).join(','));
      if (a && a.artists) return a.artists.flatMap(x => x.genres || []).slice(0, 8);
    } catch (e) { console.warn('[spotify] genre fetch failed', e); }
    return [];
  },

  destroy() {
    if (this._interval) { clearInterval(this._interval); this._interval = null; }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ APPLE MUSIC PROVIDER ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MusicProviders.apple = {
  name: 'Apple Music',
  _interval: null,
  _music: null,  // MusicKit instance

  async init() {
    // Wait for MusicKit JS to load (async script)
    if (typeof MusicKit === 'undefined') {
      showErr('Loading Apple Music‚Ä¶');
      const loaded = await new Promise(resolve => {
        let waited = 0;
        const check = setInterval(() => {
          waited += 200;
          if (typeof MusicKit !== 'undefined') { clearInterval(check); resolve(true); }
          else if (waited > 8000) { clearInterval(check); resolve(false); }
        }, 200);
      });
      if (!loaded) {
        showErr('Apple Music failed to load. Check your connection and try again.');
        return false;
      }
    }

    try {
      // Get developer token ‚Äî try meta tag first, then server endpoint
      let devToken = '';
      const metaTag = document.querySelector('meta[name="apple-music-developer-token"]');
      if (metaTag && metaTag.content) {
        devToken = metaTag.content;
      } else {
        // Try fetching from server
        try {
          const r = await fetch('/api/apple-token');
          if (r.ok) {
            const d = await r.json();
            devToken = d.token || '';
          }
        } catch (e) { /* server endpoint not available */ }
      }

      if (!devToken) {
        showErr('Apple Music requires a developer token. Set the apple-music-developer-token meta tag or provide a /api/apple-token endpoint.');
        return false;
      }

      // Configure MusicKit
      try {
        this._music = MusicKit.getInstance();
      } catch (e) {
        // Not yet configured
      }
      if (!this._music) {
        await MusicKit.configure({
          developerToken: devToken,
          app: { name: 'VIZarcade', build: '1.0' }
        });
        this._music = MusicKit.getInstance();
      }

      // Authorize (shows Apple sign-in popup)
      await this._music.authorize();
      token = 'APPLE_MUSIC';
      console.log('[apple] authorized');
    } catch (e) {
      console.error('[apple] auth failed', e);
      showErr('Apple Music sign-in failed: ' + (e.message || e));
      return false;
    }

    // Start polling
    this.poll();
    this._interval = setInterval(() => this.poll(), 3000);
    return true;
  },

  async poll() {
    if (!this._music) return;
    const player = this._music.player;
    if (!player || player.playbackState === MusicKit.PlaybackStates.none) return;

    const item = player.nowPlayingItem;
    if (!item) return;

    const tid = item.id || item.songId || (item.attributes && item.attributes.name) || 'unknown';
    const attrs = item.attributes || {};
    const durMs = (attrs.durationInMillis || player.currentPlaybackDuration * 1000 || 180000);

    MS.progress = (player.currentPlaybackTime || 0) * 1000;
    MS.duration = durMs;
    MS.analysisStart = Date.now() - MS.progress;
    MS.beatInterval = 500;
    MS.energy = (player.playbackState === MusicKit.PlaybackStates.playing) ? 0.6 : 0.3;

    if (tid !== lastTid) {
      lastTid = tid;
      const trackName = attrs.name || 'Unknown Track';
      const artistName = attrs.artistName || 'Unknown Artist';
      setTrackInfo(trackName, artistName, true);
      const art = attrs.artwork ? MusicKit.formatArtworkURL(attrs.artwork, 300, 300) : null;
      if (art) { document.getElementById('albumArt').src = art; document.getElementById('albumArt').style.display = ''; }
      loadTheme(tid, trackName, artistName, [], false, durMs);
    }
  },

  async getGenres() {
    // Apple Music genre info from nowPlayingItem
    if (!this._music || !this._music.player.nowPlayingItem) return [];
    const attrs = this._music.player.nowPlayingItem.attributes || {};
    return attrs.genreNames || [];
  },

  destroy() {
    if (this._interval) { clearInterval(this._interval); this._interval = null; }
    if (this._music) {
      try { this._music.unauthorize(); } catch (e) { /* ok */ }
    }
    this._music = null;
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ LOCAL AUDIO PROVIDER ‚îÄ‚îÄ
// Uses Web Audio API to analyze mic, audio files, or system audio
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MusicProviders.local = {
  name: 'Local Audio',
  _audioCtx: null,
  _analyser: null,
  _source: null,
  _audioEl: null,
  _stream: null,
  _freqData: null,
  _interval: null,
  _trackName: '',
  _fileName: '',
  _startTime: 0,
  _duration: 0,
  _mode: null,  // 'mic', 'file', or 'system'

  async init() {
    token = 'LOCAL_AUDIO';
    // Show the local audio selector
    const mode = await this._showModeSelector();
    if (!mode) { token = null; return false; }
    this._mode = mode;

    try {
      this._audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      this._analyser = this._audioCtx.createAnalyser();
      this._analyser.fftSize = 256;
      this._analyser.smoothingTimeConstant = 0.8;
      this._freqData = new Uint8Array(this._analyser.frequencyBinCount);

      if (mode === 'mic') {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        this._stream = stream;
        this._source = this._audioCtx.createMediaStreamSource(stream);
        this._source.connect(this._analyser);
        this._startTime = Date.now();
        // Hide track/artist for mic ‚Äî no meaningful info to show
        setTrackInfo('', '', false);
        document.getElementById('albumArt').style.display = 'none';
        loadTheme('mic_' + Date.now(), 'Microphone', 'Live Audio', [], false, 300000);
      } else if (mode === 'system') {
        // System audio via getDisplayMedia
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,  // required by the API even if we only want audio
          audio: true
        });
        this._stream = stream;
        // Stop the video track immediately ‚Äî we only need audio
        stream.getVideoTracks().forEach(t => t.stop());
        const audioTracks = stream.getAudioTracks();
        if (!audioTracks.length) {
          showErr('No audio track captured. Make sure to select a tab or screen that is playing audio, and check "Share audio" if prompted.');
          this._cleanup();
          token = null;
          return false;
        }
        this._source = this._audioCtx.createMediaStreamSource(stream);
        this._source.connect(this._analyser);
        this._startTime = Date.now();
        // Hide track/artist for system audio
        setTrackInfo('', '', false);
        document.getElementById('albumArt').style.display = 'none';
        loadTheme('sys_' + Date.now(), 'System Audio', 'System', [], false, 300000);
        // If the user stops sharing, clean up
        audioTracks[0].onended = () => {
          console.log('[local] system audio sharing stopped');
          stopProvider();
        };
      } else {
        // File mode ‚Äî handled via _handleFile triggered by the file picker
      }

      // Start analysis loop
      this._interval = setInterval(() => this.poll(), 100);
      console.log('[local] initialized in ' + mode + ' mode');
      return true;
    } catch (e) {
      console.error('[local] init failed', e);
      // Friendly error messages for common failures
      if (e.name === 'NotAllowedError') {
        showErr('Permission denied. Please allow audio access and try again.');
      } else if (e.name === 'NotFoundError') {
        showErr('No audio source found. Make sure your device has a microphone.');
      } else {
        showErr('Audio access failed: ' + (e.message || e));
      }
      this._cleanup();
      token = null;
      return false;
    }
  },

  _showModeSelector() {
    return new Promise(resolve => {
      const overlay = document.createElement('div');
      overlay.id = 'localAudioSelector';
      overlay.style.cssText = 'position:fixed;inset:0;z-index:250;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);gap:16px;';
      // Check if getDisplayMedia is available for system audio (not available on mobile)
      const hasSystemAudio = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) && !isMobile;
      overlay.innerHTML =
        '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.8rem;letter-spacing:0.3em;color:#06ffd8;text-shadow:0 0 20px #06ffd8">LOCAL AUDIO SOURCE</div>' +
        '<button id="localMicBtn" class="btn" style="min-width:280px">\uD83C\uDFA4 \u00a0MICROPHONE</button>' +
        (hasSystemAudio ? '<button id="localSysBtn" class="btn" style="min-width:280px">\uD83D\uDD0A \u00a0SYSTEM AUDIO</button>' : '') +
        '<button id="localFileBtn" class="btn" style="min-width:280px">\uD83D\uDCC1 \u00a0AUDIO FILE</button>' +
        '<input type="file" id="localFilePicker" accept="audio/*" style="display:none">' +
        '<button id="localCancelBtn" style="background:none;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.4);padding:0.6rem 2rem;cursor:pointer;font-family:\'Share Tech Mono\',monospace;font-size:0.7rem;letter-spacing:0.2em;margin-top:10px">CANCEL</button>';
      document.body.appendChild(overlay);

      document.getElementById('localMicBtn').onclick = () => {
        overlay.remove();
        resolve('mic');
      };
      const sysBtn = document.getElementById('localSysBtn');
      if (sysBtn) {
        sysBtn.onclick = () => {
          overlay.remove();
          resolve('system');
        };
      }
      document.getElementById('localFileBtn').onclick = () => {
        document.getElementById('localFilePicker').click();
      };
      document.getElementById('localFilePicker').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        overlay.remove();
        this._fileName = file.name.replace(/\.[^.]+$/, '');
        // Load the file after init returns
        setTimeout(() => this._handleFile(file), 100);
        resolve('file');
      };
      document.getElementById('localCancelBtn').onclick = () => {
        overlay.remove();
        resolve(null);
      };
    });
  },

  async _handleFile(file) {
    try {
      if (!this._audioCtx) {
        this._audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        this._analyser = this._audioCtx.createAnalyser();
        this._analyser.fftSize = 256;
        this._analyser.smoothingTimeConstant = 0.8;
        this._freqData = new Uint8Array(this._analyser.frequencyBinCount);
      }

      this._audioEl = new Audio();
      this._audioEl.crossOrigin = 'anonymous';
      this._audioEl.src = URL.createObjectURL(file);
      await new Promise((res, rej) => {
        this._audioEl.oncanplaythrough = res;
        this._audioEl.onerror = rej;
      });

      this._source = this._audioCtx.createMediaElementSource(this._audioEl);
      this._source.connect(this._analyser);
      this._analyser.connect(this._audioCtx.destination);

      this._trackName = this._fileName || 'Audio File';
      this._duration = (this._audioEl.duration || 180) * 1000;
      this._startTime = Date.now();

      // Show filename as track, hide artist
      setTrackInfo(this._trackName, '', false);
      document.getElementById('trackName').style.display = '';
      document.getElementById('albumArt').style.display = 'none';

      this._audioEl.play();
      loadTheme('file_' + Date.now(), this._trackName, '', [], false, this._duration);

      // On track end, re-trigger theme for looping
      this._audioEl.onended = () => {
        this._audioEl.currentTime = 0;
        this._audioEl.play();
        lastTid = null;  // Force new theme on loop
      };
    } catch (e) {
      console.error('[local] file load failed', e);
      showErr('Could not load audio file: ' + (e.message || e));
    }
  },

  poll() {
    if (!this._analyser || !this._freqData) return;
    this._analyser.getByteFrequencyData(this._freqData);

    // Compute energy from frequency data
    const bins = this._freqData;
    let sum = 0, bassSum = 0;
    const bassEnd = Math.floor(bins.length * 0.15);
    for (let i = 0; i < bins.length; i++) {
      sum += bins[i];
      if (i < bassEnd) bassSum += bins[i];
    }
    const energy = Math.min(1, (sum / bins.length / 255) * 2.0);
    const bass = bassEnd > 0 ? (bassSum / bassEnd / 255) : 0;

    // Beat detection from bass transients
    if (!this._prevBass) this._prevBass = 0;
    if (!this._beatCooldown) this._beatCooldown = 0;
    this._beatCooldown = Math.max(0, this._beatCooldown - 100);
    if (bass - this._prevBass > 0.15 && this._beatCooldown <= 0 && bass > 0.3) {
      this._beatCooldown = 250;
      if (!this._lastBeatTime) this._lastBeatTime = Date.now();
      const now = Date.now();
      const interval = now - this._lastBeatTime;
      if (interval > 200 && interval < 2000) {
        MS.beatInterval = MS.beatInterval * 0.7 + interval * 0.3;
      }
      this._lastBeatTime = now;
    }
    this._prevBass = bass;

    MS.energy = energy;

    if (this._mode === 'file' && this._audioEl) {
      MS.progress = (this._audioEl.currentTime || 0) * 1000;
      MS.duration = this._duration || 180000;
      MS.analysisStart = Date.now() - MS.progress;
    } else {
      // Mic/system mode ‚Äî synthetic progress (cycles every 5 minutes)
      const elapsed = Date.now() - this._startTime;
      const cycleDur = 300000;
      MS.progress = elapsed % cycleDur;
      MS.duration = cycleDur;
      MS.analysisStart = Date.now() - MS.progress;
    }

    // ‚îÄ‚îÄ Local audio intelligence ‚îÄ‚îÄ
    // Track rolling energy for surprise + transition detection
    if (!this._energyWindow) this._energyWindow = [];
    if (!this._surpriseCooldown) this._surpriseCooldown = 0;
    if (!this._transitionCooldown) this._transitionCooldown = 0;
    if (!this._rollingPeak) this._rollingPeak = 0;
    if (!this._dipDetected) this._dipDetected = false;
    if (!this._dipEnergy) this._dipEnergy = 0;
    if (!this._preDipEnergy) this._preDipEnergy = 0;
    if (!this._hardCutState) this._hardCutState = 0; // 0=watching, 1=silence detected

    this._energyWindow.push(energy);
    if (this._energyWindow.length > 80) this._energyWindow.shift(); // ~8 sec window at 100ms
    this._surpriseCooldown = Math.max(0, this._surpriseCooldown - 100);
    this._transitionCooldown = Math.max(0, this._transitionCooldown - 100);

    // Update rolling peak (decays slowly)
    if (energy > this._rollingPeak) this._rollingPeak = energy;
    else this._rollingPeak *= 0.999;

    if (this._energyWindow.length >= 20) {
      const recent = this._energyWindow.slice(-6);
      const older = this._energyWindow.slice(-30, -10);
      const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
      const olderAvg = older.length > 0 ? older.reduce((a, b) => a + b, 0) / older.length : recentAvg;

      // ‚îÄ‚îÄ SURPRISE: fire during intense peaks ‚îÄ‚îÄ
      if (this._surpriseCooldown <= 0 && !surpriseFired) {
        const isIntense = recentAvg > 0.55 && recentAvg > olderAvg + 0.12;
        const nearPeak = recentAvg > this._rollingPeak * 0.8;
        if (isIntense && nearPeak) {
          setTimeout(fireSurprise, 200);
          surpriseFired = true;
          this._surpriseCooldown = 30000; // 30s cooldown
        }
      }

      // ‚îÄ‚îÄ DJ CROSSFADE TRANSITION: detect energy dip-and-rise pattern ‚îÄ‚îÄ
      if (!this._dipDetected && this._transitionCooldown <= 0) {
        const dropAmount = olderAvg - recentAvg;
        // Require a meaningful drop (0.22+) from an active baseline (0.35+)
        if (dropAmount > 0.22 && olderAvg > 0.35) {
          this._dipDetected = true;
          this._dipEnergy = recentAvg;
          this._preDipEnergy = olderAvg;
          this._dipTime = Date.now();
        }
      }
      if (this._dipDetected) {
        const timeSinceDip = Date.now() - (this._dipTime || 0);
        const riseAmount = recentAvg - this._dipEnergy;
        // Require a clear rise (0.15+) after at least 1.75s
        if (riseAmount > 0.15 && recentAvg > this._dipEnergy + 0.12 && timeSinceDip > 1750) {
          console.log('[local] DJ crossfade detected ‚Äî dip:', this._preDipEnergy.toFixed(2),
            '‚Üí', this._dipEnergy.toFixed(2), '‚Üí rise:', recentAvg.toFixed(2));
          this._dipDetected = false;
          this._transitionCooldown = 120000; // 120s cooldown
          surpriseFired = false;
          this._rollingPeak = recentAvg;
          skipToNextScene();
        }
        if (timeSinceDip > 15000) {
          this._dipDetected = false;
        }
      }

      // ‚îÄ‚îÄ HARD CUT: detect abrupt silence then new audio (skip/next track) ‚îÄ‚îÄ
      if (this._transitionCooldown <= 0) {
        const veryRecent = this._energyWindow.slice(-3);
        const veryRecentAvg = veryRecent.reduce((a, b) => a + b, 0) / veryRecent.length;
        if (this._hardCutState === 0) {
          // Watch for sudden drop to near-silence while previously playing
          if (veryRecentAvg < 0.04 && olderAvg > 0.28) {
            this._hardCutState = 1;
            this._hardCutTime = Date.now();
          }
        } else if (this._hardCutState === 1) {
          const timeSinceCut = Date.now() - (this._hardCutTime || 0);
          // Audio came back ‚Äî new song started
          if (veryRecentAvg > 0.18) {
            console.log('[local] hard cut detected ‚Äî silence then new audio');
            this._hardCutState = 0;
            this._transitionCooldown = 120000; // shared 120s cooldown
            this._dipDetected = false;
            surpriseFired = false;
            this._rollingPeak = veryRecentAvg;
            skipToNextScene();
          }
          // Timeout: if silence lasts more than 8s, reset (just a pause, not a cut)
          if (timeSinceCut > 8000) {
            this._hardCutState = 0;
          }
        }
      }
    }
  },

  async getGenres() {
    return [];
  },

  _cleanup() {
    if (this._stream) {
      this._stream.getTracks().forEach(t => t.stop());
      this._stream = null;
    }
    if (this._audioEl) { this._audioEl.pause(); this._audioEl.src = ''; this._audioEl = null; }
    if (this._source) { try { this._source.disconnect(); } catch (e) { /* ok */ } this._source = null; }
    if (this._audioCtx) { try { this._audioCtx.close(); } catch (e) { /* ok */ } this._audioCtx = null; }
    this._analyser = null;
    this._freqData = null;
  },

  destroy() {
    if (this._interval) { clearInterval(this._interval); this._interval = null; }
    this._cleanup();
    this._mode = null;
    // Restore track info visibility for next provider
    document.getElementById('trackName').style.display = '';
    document.getElementById('artistName').style.display = '';
    document.getElementById('albumArt').style.display = '';
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PROVIDER LIFECYCLE ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startProvider(key) {
  if (activeProvider) {
    activeProvider.destroy();
    activeProvider = null;
  }
  const provider = MusicProviders[key];
  if (!provider) { console.error('[provider] unknown:', key); return false; }

  console.log('[provider] starting:', provider.name);
  const ok = await provider.init();
  if (ok) {
    activeProvider = provider;
    ls('lastProvider', key);
    // Show main UI
    document.getElementById('login').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('fsBtn').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('nextSceneBtn').style.display = 'block';
    initScene();
    return true;
  }
  return false;
}

function stopProvider() {
  if (activeProvider) {
    activeProvider.destroy();
    activeProvider = null;
  }
  token = null;
  lastTid = null;
  document.getElementById('login').style.display = 'flex';
  document.getElementById('ui').style.display = 'none';
  document.getElementById('fsBtn').style.display = 'none';
  document.getElementById('backBtn').style.display = 'none';
  document.getElementById('nextSceneBtn').style.display = 'none';
  // Restore track info visibility
  document.getElementById('trackName').style.display = '';
  document.getElementById('artistName').style.display = '';
  document.getElementById('albumArt').style.display = '';
}

// ‚îÄ‚îÄ Skip to next scene (used by next-scene button and auto-transition) ‚îÄ‚îÄ
function skipToNextScene() {
  if (inTrans) return;
  // Pick a random scene different from current, respecting the variety system
  const shortlist = getSceneShortlist().filter(s => s !== THEME.scene);
  const scene = shortlist[0] || rndEl(ALL_SCENES.filter(s => s !== THEME.scene));
  const cp = enforceCP(rndEl(ALL_CPS.filter(x => !getForbidCPs().includes(x))));
  // Build a quick theme based on current palette but new scene
  const palette = THEME.palette.slice();
  // Rotate palette for visual variety
  palette.push(palette.shift());
  const theme = {
    scene: scene,
    label: '',
    splashDesc: '',
    palette: palette,
    bgColor: THEME.bgColor,
    centerpiece: cp,
    centerpieceScale: 0.3 + Math.random() * 0.7,
    centerpieceX: 0.3 + Math.random() * 0.4,
    centerpieceY: 0.3 + Math.random() * 0.4,
    centerpieceBehavior: rndEl(['rotate', 'pulse_beat', 'breathe', 'orbit_slow', 'bounce', 'drift']),
    beatReactions: THEME.beatReactions || ['shockwave'],
    sceneSpeed: 0.7 + Math.random() * 1.3,
    sceneIntensity: 0.5 + Math.random() * 0.5,
    energy: THEME.energy || 0.5,
    chaos: Math.random() * 0.6
  };
  recordScene(scene);
  recordCP(cp);
  const trackEl = document.getElementById('trackName');
  const artistEl = document.getElementById('artistName');
  applyTheme(trackEl.textContent || '', artistEl.textContent || '', theme);
}

// ‚îÄ‚îÄ Genre helper for AI theme (provider-agnostic) ‚îÄ‚îÄ
async function getProviderGenres(artistIds) {
  if (!activeProvider) return [];
  return activeProvider.getGenres(artistIds);
}


// ‚ïê‚ïê MODULE: render.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê RENDER LOOP & BEAT FX ‚ïê‚ïê‚ïê





function drawBeatFX(){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  if(beatFX.shockwaveA>0.01){beatFX.shockwaveR+=12*(1+SM.energy);beatFX.shockwaveA*=0.88;x2.beginPath();x2.arc(cx,cy,beatFX.shockwaveR,0,Math.PI*2);x2.strokeStyle=rgba(pc(0),beatFX.shockwaveA);x2.lineWidth=3+beatFX.shockwaveA*5;x2.stroke();if(beatFX.shockwaveR>Math.sqrt(cx*cx+cy*cy)+100)beatFX.shockwaveA=0;}
  if(beatFX.crackLines.length>0){for(let i=beatFX.crackLines.length-1;i>=0;i--){const cl=beatFX.crackLines[i];cl.life-=0.05;if(cl.life<=0){beatFX.crackLines.splice(i,1);continue;}x2.shadowBlur=15;x2.shadowColor=pc(cl.ci);let prev={x:cx,y:cy};for(const seg of cl.segs){x2.beginPath();x2.moveTo(prev.x,prev.y);x2.lineTo(seg.x,seg.y);x2.strokeStyle=rgba(pc(cl.ci),cl.life*0.9);x2.lineWidth=cl.life*3;x2.stroke();prev=seg;}x2.shadowBlur=0;}}
  if(beatFX.invertA>0.01){x2.fillStyle=rgba(pc(0),beatFX.invertA*0.4);x2.fillRect(0,0,w,h);beatFX.invertA*=0.82;}
  if(beatFX.slamS>1.001){beatFX.slamS+=(1-beatFX.slamS)*0.15;}
  if(beatFX.gravityWave>0.01){x2.fillStyle=rgba(pc(2),beatFX.gravityWave*0.08);x2.fillRect(0,0,w,h);beatFX.gravityWave*=0.9;}
  beatFX.speedBoost*=0.88;
}

function render(t){
  requestAnimationFrame(render);
  if(!token)return;
  const w=W(),h=H();
  SM.energy+=(MS.energy-SM.energy)*0.05;
  SM.beatPulse*=0.87;
  if(t-MS.lastBeat>MS.beatInterval){MS.lastBeat=t;triggerBeat();}
  if(MS.duration>0){songProg=Math.min(1,(Date.now()-MS.analysisStart)/MS.duration);progMult=0.55+songProg*0.7;}
  document.getElementById('pgBar').style.width=(songProg*100)+'%';
  const tc=h2r(pc(Math.floor(t/3000)%4));document.getElementById('cur').style.background=`rgb(${tc.r},${tc.g},${tc.b})`;
  switch(THEME.scene){
    case 'WARP_SPEED':drawWarpSpeed(t);break;case 'LAVA_WORLD':drawLavaWorld(t);break;
    case 'CYBER_GRID':drawCyberGrid(t);break;case 'DEEP_SEA':drawDeepSea(t);break;
    case 'STORM_CHASER':drawStormChaser(t);break;case 'JUNGLE_RAVE':drawJungleRave(t);break;
    case 'DISCO_DIMENSION':drawDiscoDimension(t);break;case 'ACID_TRIP':drawAcidTrip(t);break;
    case 'SPACE_STATION':drawSpaceStation(t);break;case 'NEON_CATHEDRAL':drawNeonCathedral(t);break;
    case 'CLASSIC_ARCADE':drawClassicArcade(t);break;case 'ELECTRIC_FOREST':drawElectricForest(t);break;
    case 'OMNIA_NIGHTCLUB':drawOmniaNightclub(t);break;case 'PIRATE_SHIP':drawPirateShip(t);break;
    case 'JUNKYARD':drawJunkyard(t);break;case 'GOTHAM':drawSuperhero(t);break;
    case 'DAY_OF_DEAD':drawDayOfDead(t);break;case 'CHINESE_DRAGON':drawChineseDragon(t);break;
    case 'MOUNT_OLYMPUS':drawMountOlympus(t);break;case 'SUPER_MARIO':drawSuperMario(t);break;
    case 'ATLANTIS':drawAtlantis(t);break;case 'CARNIVAL':drawCarnival(t);break;
    case 'EGYPTIAN_TOMB':drawEgyptianTomb(t);break;default:drawWarpSpeed(t);
  }
  x1.clearRect(0,0,w,h);
  if(THEME.centerpiece&&THEME.centerpieceScale>0&&!CP_INTEGRATED_SCENES.has(THEME.scene)){
    drawCPWithBehavior(x1,t);
  }
  x2.clearRect(0,0,w,h);
  drawBeatFX();
  x3.clearRect(0,0,w,h);
  const vg=x3.createRadialGradient(w/2,h/2,h*0.2,w/2,h/2,h*0.85);
  vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,0.55)');
  x3.fillStyle=vg;x3.fillRect(0,0,w,h);
}




// ‚ïê‚ïê MODULE: devPanel.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê DEV PANEL ‚ïê‚ïê‚ïê






function initDevPanel(){
  const panel=document.getElementById('devPanel');
  if(!panel)return;
  let devOpen=false,simMode=false;
  let simEnergy=0.6,simBPM=120,simProg=0;
  let activeSurpriseVariant=null; // track which variant button is active

  // ‚îÄ‚îÄ Toggle logic: triple-D or ?dev=1 ‚îÄ‚îÄ
  let dPresses=[],dTimeout;
  function toggleDev(){
    devOpen=!devOpen;
    panel.classList.toggle('open',devOpen);
    if(devOpen)buildSceneGrid();
  }
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'&&devOpen){toggleDev();return;}
    if(e.key.toLowerCase()!=='d'||e.ctrlKey||e.metaKey||e.altKey)return;
    dPresses.push(Date.now());
    clearTimeout(dTimeout);
    dTimeout=setTimeout(()=>{dPresses=[];},800);
    if(dPresses.length>=3){
      const span=dPresses[dPresses.length-1]-dPresses[dPresses.length-3];
      if(span<800){toggleDev();dPresses=[];}
    }
  });
  if(new URLSearchParams(location.search).get('dev')==='1'){
    setTimeout(toggleDev,500);
  }

  // ‚îÄ‚îÄ Close button ‚îÄ‚îÄ
  document.getElementById('dpClose').addEventListener('click',toggleDev);

  // ‚îÄ‚îÄ Build scene grid ‚îÄ‚îÄ
  function buildSceneGrid(){
    const grid=document.getElementById('dpSceneGrid');
    if(grid.children.length>0)return;
    ALL_SCENES.forEach(s=>{
      const btn=document.createElement('button');
      btn.className='dp-btn';
      btn.textContent=s.replace(/_/g,' ');
      btn.addEventListener('click',()=>jumpToScene(s));
      grid.appendChild(btn);
    });
  }

  // ‚îÄ‚îÄ Build CP grid ‚îÄ‚îÄ
  (function buildCPGrid(){
    const grid=document.getElementById('dpCPGrid');
    ALL_CPS.forEach(cp=>{
      const btn=document.createElement('button');
      btn.className='dp-btn';
      btn.textContent=cp.replace(/_/g,' ');
      btn.addEventListener('click',()=>{
        THEME.centerpiece=cp;
        THEME.centerpieceScale=THEME.centerpieceScale||0.5;
      });
      grid.appendChild(btn);
    });
  })();

  // ‚îÄ‚îÄ Cancel active surprise ‚îÄ‚îÄ
  function cancelSurprise(){
    // Keep the lock ON so initScene's reset of surpriseFired doesn't cause auto-fire
    devSurpriseLock=true;
    // Re-init scene to reset all surprise-related SD state
    initScene();
    // After initScene resets surpriseFired=false, mark it as fired to block auto-triggers
    surpriseFired=true;
    // Reset beat FX
    beatFX.speedBoost=0;beatFX.invertA=0;beatFX.shockwaveA=0;beatFX.slamS=1;beatFX.gravityWave=0;
    // Clear surprise overlay
    const o=document.getElementById('surpriseOverlay');
    o.style.transition='opacity 0.3s';o.style.opacity='0';
    // Clear any game over / comic panels
    document.getElementById('gameOverScreen').style.display='none';
    document.getElementById('comicPanel').style.display='none';
    // Deactivate button
    activeSurpriseVariant=null;
    updateSurpriseButtons();
    console.log('[dev] surprise cancelled');
  }

  // ‚îÄ‚îÄ Update surprise button highlights ‚îÄ‚îÄ
  function updateSurpriseButtons(){
    const btns=document.getElementById('dpSurpriseGrid').querySelectorAll('[data-var]');
    btns.forEach(btn=>{
      const v=parseInt(btn.dataset.var);
      btn.classList.toggle('active',v===activeSurpriseVariant);
    });
    document.getElementById('dpFireRandom').classList.toggle('active',activeSurpriseVariant!=null&&![0,1,2].includes(activeSurpriseVariant));
  }

  // ‚îÄ‚îÄ Jump to scene ‚îÄ‚îÄ
  function jumpToScene(sceneName){
    // Lock surprise system while we're switching
    devSurpriseLock=true;
    // Cancel any active surprise (without re-initing, since we're about to do that)
    activeSurpriseVariant=null;
    updateSurpriseButtons();
    beatFX.speedBoost=0;beatFX.invertA=0;beatFX.shockwaveA=0;beatFX.slamS=1;beatFX.gravityWave=0;
    document.getElementById('surpriseOverlay').style.opacity='0';
    document.getElementById('gameOverScreen').style.display='none';
    document.getElementById('comicPanel').style.display='none';
    // Switch scene
    THEME.scene=sceneName;
    THEME.bgColor=THEME.bgColor||'#000010';
    THEME.sceneSpeed=THEME.sceneSpeed||1;
    THEME.sceneIntensity=THEME.sceneIntensity||0.7;
    initScene();
    // After initScene resets surpriseFired=false, block auto-firing
    surpriseFired=true;
    document.getElementById('sceneTag').textContent=sceneName.replace(/_/g,' ')+' ‚Äî DEV';
    console.log('[dev] jumped to scene:',sceneName);
  }

  // ‚îÄ‚îÄ Surprise buttons ‚îÄ‚îÄ
  document.getElementById('dpSurpriseGrid').addEventListener('click',e=>{
    const btn=e.target.closest('[data-var]');
    if(!btn)return;
    const v=parseInt(btn.dataset.var);
    // Toggle: if same variant is active, cancel it
    if(activeSurpriseVariant===v){
      cancelSurprise();
      return;
    }
    // Cancel previous surprise if one is active
    if(activeSurpriseVariant!==null)cancelSurprise();
    // Fire the new one
    fireDevSurprise(v);
    activeSurpriseVariant=v;
    updateSurpriseButtons();
  });

  document.getElementById('dpFireRandom').addEventListener('click',()=>{
    if(activeSurpriseVariant!==null){cancelSurprise();return;}
    const v=Math.floor(Math.random()*3);
    fireDevSurprise(v);
    activeSurpriseVariant=v;
    updateSurpriseButtons();
  });

  function fireDevSurprise(variant){
    // Lock automatic surprise system
    devSurpriseLock=true;
    // Reset scene state first so surprise starts clean
    initScene();
    // Block auto-triggers after initScene resets surpriseFired
    surpriseFired=true;
    midShifted=true; // prevent mid-shift
    // Call fireSurprise with the forced variant
    fireSurprise(variant);
    console.log('[dev] fired surprise variant',variant,'for scene',THEME.scene);
  }

  // ‚îÄ‚îÄ Sim audio controls ‚îÄ‚îÄ
  const simEnergySlider=document.getElementById('dpSimEnergy');
  const simBPMSlider=document.getElementById('dpSimBPM');
  const simProgSlider=document.getElementById('dpSimProg');

  simEnergySlider.addEventListener('input',e=>{
    simEnergy=parseInt(e.target.value)/100;
    document.getElementById('dpSimEnergyVal').textContent=simEnergy.toFixed(2);
    if(simMode){MS.energy=simEnergy;SM.energy=simEnergy;}
  });
  simBPMSlider.addEventListener('input',e=>{
    simBPM=parseInt(e.target.value);
    document.getElementById('dpSimBPMVal').textContent=simBPM;
    if(simMode)MS.beatInterval=Math.round(60000/simBPM);
  });
  simProgSlider.addEventListener('input',e=>{
    simProg=parseInt(e.target.value)/100;
    document.getElementById('dpSimProgVal').textContent=Math.round(simProg*100)+'%';
    if(simMode){
      songProg=simProg;
      progMult=0.55+songProg*0.7;
      MS.duration=180000;
      MS.analysisStart=Date.now()-simProg*MS.duration;
    }
  });

  document.getElementById('dpSimToggle').addEventListener('click',function(){
    simMode=!simMode;
    this.textContent=simMode?'‚ñ† Disable Sim':'‚ñ∂ Enable Sim';
    this.classList.toggle('active',simMode);
    if(simMode){
      if(!token){token='DEV_MODE';
        document.getElementById('login').style.display='none';
        document.getElementById('ui').style.display='block';
        document.getElementById('fsBtn').style.display='block';
        initScene();
      }
      MS.energy=simEnergy;SM.energy=simEnergy;
      MS.beatInterval=Math.round(60000/simBPM);
      MS.duration=180000;
      MS.analysisStart=Date.now()-simProg*180000;
      console.log('[dev] sim mode ON');
    }else{
      if(token==='DEV_MODE')token=null;
      console.log('[dev] sim mode OFF');
    }
  });

  document.getElementById('dpSimBeat').addEventListener('click',()=>{
    SM.beatPulse=1;beatCount++;triggerBeat();
  });

  // ‚îÄ‚îÄ Quick actions ‚îÄ‚îÄ
  document.getElementById('dpFlash').addEventListener('click',()=>flash(pc(0),400));
  document.getElementById('dpComicBurst').addEventListener('click',doComicBurst);
  document.getElementById('dpShockwave').addEventListener('click',()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=0.9;});
  document.getElementById('dpInvert').addEventListener('click',()=>{beatFX.invertA=0.8;});
  document.getElementById('dpSlam').addEventListener('click',()=>{beatFX.slamS=1.25;});
  document.getElementById('dpGameOver').addEventListener('click',showGameOver);
  document.getElementById('dpResetHist').addEventListener('click',()=>{
    sceneHist=[];cpHist=[];sceneLastSeen={};sceneCycle=[];sceneWeights={};
    ls('sw_sh','[]');ls('sw_ch','[]');ls('sw_ls','{}');ls('sw_cyc','[]');ls('sw_wt','{}');
    songCount=0;ls('sw_n','0');
    console.log('[dev] rotation history reset');
  });
  document.getElementById('dpCycleInfo').addEventListener('click',()=>{
    const remaining=ALL_SCENES.filter(s=>!sceneCycle.includes(s));
    console.log('[dev] Cycle progress:',sceneCycle.length+'/'+ALL_SCENES.length);
    console.log('[dev] Played:',sceneCycle.join(', '));
    console.log('[dev] Remaining:',remaining.join(', ')||'(cycle complete)');
    alert('Cycle: '+sceneCycle.length+'/'+ALL_SCENES.length+'\n\nPlayed:\n'+sceneCycle.map(s=>s.replace(/_/g,' ')).join(', ')+'\n\nRemaining:\n'+(remaining.map(s=>s.replace(/_/g,' ')).join(', ')||'(cycle complete ‚Äî next song starts fresh)'));
  });

  // ‚îÄ‚îÄ Live monitor update ‚îÄ‚îÄ
  function updateMonitor(){
    if(devOpen){
      document.getElementById('dpCurScene').textContent=(THEME.scene||'‚Äî').replace(/_/g,' ');
      document.getElementById('dpCurCP').textContent=(THEME.centerpiece||'none').replace(/_/g,' ');
      document.getElementById('dpEnergy').textContent=SM.energy.toFixed(2);
      document.getElementById('dpBPM').textContent=MS.beatInterval>0?Math.round(60000/MS.beatInterval):'‚Äî';
      document.getElementById('dpBeatCt').textContent=beatCount;
      document.getElementById('dpProg').textContent=Math.round(songProg*100)+'%';
      document.getElementById('dpSurprise').textContent=activeSurpriseVariant!==null?('V'+activeSurpriseVariant+' ACTIVE'):(surpriseFired?'FIRED':'armed');
      // Highlight active scene button
      const btns=document.getElementById('dpSceneGrid').children;
      for(let i=0;i<btns.length;i++){
        btns[i].classList.toggle('active',ALL_SCENES[i]===THEME.scene);
      }
    }
    requestAnimationFrame(updateMonitor);
  }
  requestAnimationFrame(updateMonitor);

  // ‚îÄ‚îÄ Sim mode: keep energy/progress synced each frame ‚îÄ‚îÄ
  function simLoop(){
    if(simMode){
      MS.energy=simEnergy;
      if(simProg<1){
        simProg+=0.00005;
        songProg=simProg;
        progMult=0.55+songProg*0.7;
        simProgSlider.value=Math.round(simProg*100);
        document.getElementById('dpSimProgVal').textContent=Math.round(simProg*100)+'%';
      }
    }
    requestAnimationFrame(simLoop);
  }
  requestAnimationFrame(simLoop);

  console.log('[dev] panel ready ‚Äî press D√ó3 or add ?dev=1 to URL');
}





// ‚ïê‚ïê MODULE: main.js ‚ïê‚ïê
// ‚ïê‚ïê‚ïê VIZARCADE ‚Äî Main Entry Point ‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Mobile / iOS detection ‚îÄ‚îÄ
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isMobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.maxTouchPoints > 1 && window.innerWidth < 1024);
const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;

// Hide custom cursor on touch devices
if (isMobile) {
  document.getElementById('cur').style.display = 'none';
  document.body.style.cursor = 'auto';
}

// ‚îÄ‚îÄ Resize handler ‚îÄ‚îÄ
addEventListener('resize', () => { resize(); if (token) initScene(); });

// ‚îÄ‚îÄ Fullscreen button ‚îÄ‚îÄ
const fsBtn = document.getElementById('fsBtn');
if (isIOS) {
  if (isStandalone) {
    // Already in standalone/fullscreen mode
    fsBtn.style.display = 'none';
  } else {
    // Show "Add to Home Screen" hint instead
    fsBtn.textContent = 'üì± HOME';
    fsBtn.addEventListener('click', () => {
      alert('To go fullscreen on iOS:\n\n1. Tap the Share button (‚Üë)\n2. Tap "Add to Home Screen"\n3. Open VIZarcade from your home screen\n\nThis launches the app without browser chrome.');
    });
  }
} else {
  fsBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(() => {});
      fsBtn.textContent = '‚úï EXIT';
    } else {
      document.exitFullscreen();
      fsBtn.textContent = '‚õ∂ FS';
    }
  });
}

// ‚îÄ‚îÄ Back button ‚Äî full disconnect, return to login ‚îÄ‚îÄ
document.getElementById('backBtn').addEventListener('click', () => {
  stopProvider();
});

// ‚îÄ‚îÄ Next scene button ‚Äî skip to a new random scene ‚îÄ‚îÄ
document.getElementById('nextSceneBtn').addEventListener('click', () => {
  if (inTrans) return;
  skipToNextScene();
});

// ‚îÄ‚îÄ Provider selection buttons ‚îÄ‚îÄ
// Spotify: check for existing token first; if none, call doLogin directly
// (must stay synchronous from the tap event for iOS navigation to work)
document.getElementById('loginBtn').addEventListener('click', () => {
  const existing = getAT();
  if (existing) {
    startProvider('spotify');
  } else {
    doLogin();
  }
});
const appleBtn = document.getElementById('appleMusicBtn');
if (appleBtn) appleBtn.addEventListener('click', () => startProvider('apple'));
const localBtn = document.getElementById('localAudioBtn');
if (localBtn) localBtn.addEventListener('click', () => startProvider('local'));

// ‚îÄ‚îÄ Arcade landing canvas animation ‚îÄ‚îÄ
(function initArcadeCanvas() {
  const lc = document.getElementById('loginCanvas');
  if (!lc) return;
  const ctx = lc.getContext('2d');
  let raf = null;
  const sprites = Array.from({ length: 22 }, (_, i) => {
    const chars = ['‚òÖ', '‚ô¶', '‚ñ≤', '‚óè', '‚ñ†', '‚óÜ', '‚ñº', '‚ú¶', '‚ùã', '‚¨ü', '‚¨°', '‚¨¢'];
    return {
      x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight,
      vx: (Math.random() - 0.5) * 1.5, vy: (Math.random() - 0.5) * 1.5,
      ch: chars[i % chars.length], sz: 10 + Math.random() * 18,
      ci: i % 4, ph: Math.random() * Math.PI * 2
    };
  });
  const colors = ['#00ff41', '#ff006e', '#8338ec', '#ffbe0b'];
  function drawArcade(ts) {
    lc.width = window.innerWidth; lc.height = window.innerHeight;
    ctx.clearRect(0, 0, lc.width, lc.height);
    ctx.strokeStyle = 'rgba(0,255,65,0.07)'; ctx.lineWidth = 1;
    for (let x = 0; x < lc.width; x += 60) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, lc.height); ctx.stroke(); }
    for (let y = 0; y < lc.height; y += 60) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(lc.width, y); ctx.stroke(); }
    for (const sp of sprites) {
      sp.ph += 0.03; sp.x += sp.vx; sp.y += sp.vy;
      if (sp.x < -40) sp.x = lc.width + 40; if (sp.x > lc.width + 40) sp.x = -40;
      if (sp.y < -40) sp.y = lc.height + 40; if (sp.y > lc.height + 40) sp.y = -40;
      const br = Math.abs(Math.sin(sp.ph)) * 0.4 + 0.3;
      ctx.shadowBlur = 12; ctx.shadowColor = colors[sp.ci];
      ctx.font = `${sp.sz}px monospace`; ctx.textAlign = 'center';
      ctx.fillStyle = colors[sp.ci]; ctx.globalAlpha = br;
      ctx.fillText(sp.ch, sp.x, sp.y);
      ctx.globalAlpha = 1; ctx.shadowBlur = 0;
    }
    raf = requestAnimationFrame(drawArcade);
  }
  drawArcade(0);
  const obs = new MutationObserver(() => {
    if (document.getElementById('login').style.display === 'none') { cancelAnimationFrame(raf); }
  });
  obs.observe(document.getElementById('login'), { attributes: true, attributeFilter: ['style'] });
})();

// ‚îÄ‚îÄ Start render loop ‚îÄ‚îÄ
requestAnimationFrame(render);

// ‚îÄ‚îÄ Init dev panel ‚îÄ‚îÄ
initDevPanel();

// ‚îÄ‚îÄ Auth flow ‚îÄ‚îÄ
async function init() {
  const p = new URLSearchParams(location.search);

  // If returning from Spotify OAuth callback, go straight to Spotify provider
  if (p.get('code')) {
    await startProvider('spotify');
    return;
  }
  if (p.get('error')) {
    showErr('Spotify error: ' + p.get('error'));
    return;
  }

  // Check for saved Spotify session
  const savedToken = getAT();
  if (savedToken) {
    token = savedToken;
    document.getElementById('login').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('fsBtn').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('nextSceneBtn').style.display = 'block';
    initScene();
    MusicProviders.spotify._interval = setInterval(() => MusicProviders.spotify.poll(), 5000);
    activeProvider = MusicProviders.spotify;
    MusicProviders.spotify.poll();
    return;
  }

  // No saved session ‚Äî show login screen
}
init();


</script>
</body>
</html>
